<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Gaara - Virus for - by Bania, Piotr (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content=""/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири"/>
<meta name="Description" content="VX Heaven site is dedicted to providing information about computer viruses (virii) and web space for virus authors and groups"/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"0164477b62083757089dd4452f3df5981cee8806-1498755282-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/><script type="text/rocketscript">	var s = 0;
	function soundex() {
		if (document.getElementById) {
			var snd = document.getElementById("snd");
			var frm = document.getElementById("sfrm");
			s = 1 - s;
			snd.src = "/img/sound_" + (s ? "on" : "off") + ".gif";
			frm.soundex.value = s;
		}
	}
	function do_img() {
		if (document.getElementById)
			document.write('<' + 'img id="snd" class="va" src="/img/sound_' + (s ? 'on' : 'off') + '.gif" onclick="soundex();" alt="" /' + '>');
	}</script>
<link rel="stylesheet" type="text/css" href="/style.css"/><style type="text/css">.va{vertical-align:middle;}</style>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/src.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Source code of computer viruses</h1><h2>Gaara - Virus for - by Bania, Piotr</h2><p><em>Virus for -</em></p><p><strong>Bania, Piotr</strong><br/><small><a href="/src.php?author=Bania, Piotr">Show all viruses by this author</a></small></p><p>2007-05-21</p><a href="#disqus_thread">Comments</a><br/><form class="fr" method="post" action="/file.php"><input type="image" src="/img/dl.gif" alt="Download"/><input type="hidden" name="file" value="c3JjL2dhYXJhLnppcA@@"/></form> Download gaara.zip (6168 bytes) or <a href="/src_view.php?file=gaara.zip">browse online</a><p><strong>Author's notes</strong></p>
<p>First of all this little piece of code was done _only_ for fun and as an proof of concept code. When i was writting this thing, i thought it would be the first world's calculator virus, but one guy contacted me and it seems it is the second one. Although it seems it is still the FIRST WORLD'S resident/entry point obscuring calculator virus :) This code was written in couple of days (each hour each day), it took me few hours to learn main things about Motorolla 68K assembly. I wasnt reviewing the code for optimization purposes, so well it should be heavily unoptimized at all. Now lets take a look of Gaara briefing:</p>
<p>Name: ti89/ti89i.Gaara</p>
<p>Tested on: TI89 Titanium HW3 AMS 3.10; (maybe other calcs are also suitable - dunno)</p>
<p>Size: 501 bytes</p>
<p>Features:</p>
<ul>
<li>Memory Resident Virus</li>
<li>Entry Point Obscuring</li>
<li>No multiple infections</li>
<li>Repairs/Moves the host relocation table</li>
<li>Appends itself to end of file</li>
<li>Leaves the marker</li>
<li>Payload</li>
</ul>
<h2>Residency</h2>
<p>When i was coding this little thingie i thought it would be fun if i could make this one resident. There are two main ways of making the code resident here. Lets assume we want to take over some ROMCALL. This could be done in two scenarios:</p>
<ol>
<li>change the ROMCALL jump table offset and then change the offset of specific ROMCALL</li>
<li>modify the offset of specific ROMCALL</li>
</ol>
<p>Of course as for first look, the second one looks more easier and effective. But the problem is the ROMCALL jump table resides in FlashROM which is write-protected (there exist some protection scheme, which disables the writting to this memory region). Although as i showed in the other document "flashrom_protection.asm" this protection can be disabled anyway. Of course the next bad thing about this method is that you can't just simply write to FlashROM etc. etc. But the main reason i have choosen the first method is "stability" itself.</p>
<p>The first method bad point is that it needs to allocate enough memory to handle all the ROMCALL offsets so its about ~6200 bytes of additonal heap memory which we need to reserve.</p>
<p>Our infection procedure, is executed when any program tries to execute SymFindNext function, via using the ROMCALL jump table offsets. The SymFindNext function finds the next symbol entry in the VAT table, if found symbol is infectable the virus proceeds with the infection process.</p>
<h2>Entry Point Obscuring</h2>
<p>Well the idea behind this idea is not to execute the virus directly from the entrypoint of the host. So here's the main idea about this one. It seems that TI-GCC generates a const EPILOG (just like mov esp,ebp/pop ebp/ret by C compilers on the x86 platforms.)</p>
<p>Here's the EPILOG looks as follows:</p>
<pre class="source">
 	unlk    a6		 :  4E 5e
 	rts		         :  4E 75
</pre>
<p>As you can see, we have 4 bytes here, which means it is enough to make some BRA/BSR execution flow - so that's what suits us. I have decided to use BRA here, since it doesn't mess with the stack and we are able to return directly to the host by executing the overwritten instructions.</p>
<p>Well, here the first EPILOG found will be overwritten, and if its not found the virus will not execute at all. Anyway this process can be more extened for example the found EPILOG can be overwritted based on some random numbers. Moreover you can even make your own disassembler and then you are free to change any suitable instruction you want, but even if we consider the size of this thing i have better things to do then writting it :)</p>
<h2>Payload</h2>
<p>If the random number obtained from the programmable timer is equal to 77h, it will clear the calculator screen and display "t89.Gaara" string.</p>
<h2>Last words</h2>
<p>I hope you learnt something by reviewing this code. Of course the dectection of this one should be pretty easy since even though it uses some basic EPO, the body of the virus is constans, and it leaves the standalone marker, so its damn easy recognizable. Who knows maybe i left it specially :)</p>
<p>So it seems that's all, and now for you all i will sing some song from my beloved Naruto series :)</p>
<p> dakara daiji na mono wa itsumo<br/>
katachi no nai mono dake<br/>
te ni iretemo nakushitemo<br/>
kizukanumama</p>
<p> sousa kanashimi wo yasashisa ni<br/>
jibun rashisa wo chikara ni<br/>
kiminara kitto yareru shinjite ite<br/>
mou ikkai mou ikkai<br/>
mou ikkai mou iikai?</p>
<p>ENDOFTRANSSMISION-NO-JUTSU!</p>
<script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/src.php?info=gaara.zip';</script></div><br/><div class="s2">
<div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"></div>
</body>
</html>
