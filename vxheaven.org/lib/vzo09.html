<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title> Z0mbie 'Solving Plain Strings Problem In HLL' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Z0mbie"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Z0mbie,Solving Plain Strings Problem In HLL, stosd, virstr, stosb, text, sample, xored, callpop, build, mask, hidden, hash, inline, include, string, xorstr"/>
<meta name="Description" content="It has been already told to you, that all hll creatures contains substrings such as *.vbs, RCPT TO:&amp;lt;%s&amp;gt;, sometimes even wsock32.dll and many others. Old rotten idea is that all code of that kind can be detected as a virus or trojan, and it will remain detectable until you listen to my truth."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"22bcac6ee34a2ef63e40682941f1c5a20124b70c-1498757154-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vzo09.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Solving Plain Strings Problem In HLL</h1><p><a href="/lib/?lang=en&amp;author=Z0mbie"> Z0mbie</a><br/> <em><a href="/vx.php?fid=1224#f1224">29a [7]</a></em><br/> <em>February 2004</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vzo09.html';</script>[<a style="" href="/lib/?lang=EN&amp;index=VT#vzo09">Back to index</a>] [<a href="/lib/vzo09.html#disqus_thread">Comments</a>]<br/> 
<ul>
<li><a href="#p0">Intro</a></li>
<li><a href="#p1">Example</a></li>
<li><a href="#p2">VIRSTR Library Overview</a></li>
<li><a href="#p3">VIRSTR Inline Macros Detailed:</a></li>
</ul>
<h2><a name="p0">Intro</a></h2>
<p>Yo, All! Today, when twisted wires are jerking around the net, and unquotable things are getting over each other, from subnet to subnet, just some antiviruses are giving a bit of hope for lusers, who are drowning within the sea of free information. So, why not to hammer some wicked nail into the main antiviral wire?</p>
<p>It has been already told to you, that all hll creatures contains substrings such as <b>*.vbs</b>, <b>RCPT TO:&lt;%s&gt;</b>, sometimes even <b>wsock32.dll</b> and many others. Old rotten idea is that all code of that kind can be detected as a virus or trojan, and it will remain detectable until you listen to my truth.</p>
<p>Because truth is here. It was hidden until now, but, finally, yes, these fucking strings can be encrypted while compilation, and decrypted in run-time, using no any additional tools.</p>
<p>The only thing you need is to use the best compiler in the world: BCC32. Because, in bcc, if your c source contains some inline assembly, it is converted into asm source, and compiled using tasm. Except this, bcc inline assemly syntax is very easy and useful.</p>
<p>Probably, you can port all this stuff or write own using another compiler, but other compilers' inline assembly looks terribly.</p>
<h2><a name="p1">Example</a></h2>
<p>Just imagine that you wanna use '<b>*.exe</b>' string in your program. How to hide it? Here is old nice idea (now applied to bcc), also described in "<a href="/lib/vzo18.html">DATA ENCODING IN META VIRUSES</a>" article:</p>
<pre class="source"><b>--- begin example1.cpp ---</b>
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
void main()
{
  char mask[260];
  asm
  {
    lea edi, mask
    irpc c, &lt;*.exe&gt;
      mov al, not '&amp;c'
      not al
      stosb
    endm
    xor eax, eax
    stosb
  }
  printf("mask=%s\n", mask);
}
<b>--- end example1.cpp ---</b>

<b>program output:</b>

mask=*.exe
</pre>
<p>Now, all we need to do is just use some macros, to make something like this:</p>
<pre class="source"><b>--- begin example2.cpp ---</b>
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#define STOSD_STR(outvar, instr)   \
        {                          \
          asm                      \
          {                        \
            lea edi, outvar      ; \
            irpc c, &lt;instr&gt;      ; \
              mov al, '&amp;c'       ; \
              stosb              ; \
            endm                 ; \
            xor eax, eax         ; \
            stosb                ; \
          }                        \
        }
void main()
{
  char mask[260];
  STOSD_STR(mask, "*.exe");
  printf("mask=%s\n", mask);
}
<b>--- end example2.cpp ---</b>

<b>program output:</b>

mask="*.exe"
</pre>
<p>As you can see in output, "" quotes appeared. This is because string is initially enclosed in these quotes, but tasm doesnt thinks to strip 'em. Well, its not a real problem.</p>
<h2><a name="p2">VIRSTR Library Overview</a></h2>
<p>Here is how basically to manage strings:</p>
<pre class="source">
#include &lt;stdio.h&gt;
#include "virstr.hpp"

void main()
{
  // store plain string directly in code, get pointer
  // note: possible read-only string, write-access could cause gpf
  char* s;
  <a href="#virstr_callpop">virstr_callpop</a>(s, "sample text");
  printf("s = %s\n", s);

  char s[260];
  // build string using STOSB, plain chars
  <a href="#virstr_stosb">virstr_stosb</a>(s, "text");

  // build string using STOSB, xor'ed chars.
  <a href="#virstr_stosb_xor">virstr_stosb_xor</a>(s, "text");

  // build string using STOSD, plain dwords
  // note: for STOSD functions, output buffer size is 4-aligned string size
  <a href="#virstr_stosd">virstr_stosd</a>(s, "text");

  // build string using STOSD, xor'ed dwords
  <a href="#virstr_stosd_xor">virstr_stosd_xor</a>(s, "text");

}//main
</pre>
<p>If you want to auto-allocate string variables, you can use same functions as above, but postfixed with "_new":<br/>
<a href="#virstr_callpop_new">virstr_callpop_new</a><br/>
<a href="#virstr_stosb_new">virstr_stosb_new</a><br/>
<a href="#virstr_stosb_xor_new">virstr_stosb_xor_new</a><br/>
<a href="#virstr_stosd_new">virstr_stosd_new</a><br/>
<a href="#virstr_stosd_xor_new">virstr_stosd_xor_new</a></p>
<p>What also can we do with strings except than hide'em within executable?</p>
<p>We can easily calculate and directly store string hash values in the executable, to harden code analysis: reversing such hashes means dictionary attack and then bruteforce. Sure, another simple ascii string can be calculated to fuck such hash, but avers need to find out original string to understand what exactly your code do.</p>
<pre class="source">
#include &lt;stdio.h&gt;
#include "virstr.hpp"

int main(int argc, char* argv[])
{
  char* s = argc == 2 ? argv[1] : "";
  // check if char* s is kernel fname
  <a href="#virstr_hash32_c_new">virstr_hash32_c_new</a>(h0, "KERNEL32.DLL");
  <a href="#virstr_hash32_v_new">virstr_hash32_v_new</a>(h1, s);
  printf("orig hash    = %08X\n", h0);
  printf("current hash = %08X\n", h1);
  printf("current str  = '%s'\n", s);
  printf("result       = %s\n", h0 == h1 ? "OK" : "FAILED");
}//main
</pre>
<p>We can XOR two strings by each other, store xored string withing executable code, and wait until one of these strings appear in some input data: on such event we can decrypt other string.</p>
<pre class="source">
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include "virstr.hpp"

int main(int argc, char* argv[])
{
  char s[1024];
  printf("type your name: "); gets(s);
  <a href="#virstr_stosd_xored_new">virstr_stosd_xored_new</a>(kasperXORformat, "kasper", "format");
  <a href="#xorstr">xorstr</a>(s, kasperXORformat);
  <a href="#virstr_hash32_c_new">virstr_hash32_c_new</a>(h0, "format");
  <a href="#virstr_hash32_v_new">virstr_hash32_v_new</a>(h1, s);
  if (h0 == h1)
    system(s);
  else
    printf("ask your friend to type.\n");
}//main
</pre>
<p>We can do the same as above, but with decryption key of type DWORD, and wait until correct value is found somewhere, to correctly decrypt encrypted string.</p>
<pre class="source">
#include &lt;stdio.h&gt;
#include "virstr.hpp"

int main()
{
  for(unsigned k=0x12345670; k&lt;=0x1234567F; k++)
  {
    // try to build string using some key (it must match predefined value)
#define HIDDEN_STRING "c:\winnt\kernel32.dll"
    static char s[260];
    <a href="#virstr_stosd_xor_key">virstr_stosd_xor_key</a>(s, HIDDEN_STRING, 0x12345678, k);
    // verify string using hashes
    <a href="#virstr_hash32_c_new">virstr_hash32_c_new</a>(h0, HIDDEN_STRING); // h0 == precalculated hash
    <a href="#virstr_hash32_v_new">virstr_hash32_v_new</a>(h1, s);             // h1 == current hash
    printf("key=%08X h0=%08X h1=%08X s='%s' result=%s\n",
      k, h0, h1, s, h0==h1?"OK":"FAILED");
  }
}//main
</pre>
<p>Except all that, generated code is displaceable and permutable, i.e. can be used in poly/meta engines, or be the virus itself.</p>
<h2><a name="p3">VIRSTR Inline Macros Detailed</a></h2>
<table border="1" cellspacing="0" cellpadding="0" summary="">
<tr><th width="50%">c source</th><th width="50%">preprocessed/asm</th></tr>
<tr><th colspan="2"><a name="xorstr">xorstr()</a></th></tr>
<tr><td>xorstr(dst, src);</td><td><pre>
asm
{
  mov     edi, dst
  mov     esi, src
  cld
__cycle:
  lodsb
  or      al, al
  jz      __exit
  mov     ah, [edi]
  or      ah, ah
  jz      __exit
  xor     al, [edi]
  stosb
  jmp     __cycle
__exit:
}
</pre></td></tr>
<tr><th colspan="2"><a name="virstr_hash32_c">virstr_hash32_c()</a></th></tr>
<tr><td>
DWORD h1;<br/>
virstr_hash32_c(h1, "sample text");
</td><td><pre>
asm
{
  mov h1, 0xxxxxxxxH
}
</pre></td></tr>
<tr><th colspan="2"><a name="virstr_hash32_c_new">virstr_hash32_c_new()</a></th></tr>
<tr><td>virstr_hash32_c_new(h1, "sample text");</td><td><pre>
DWORD h1;
asm
{
  mov h1, 0xxxxxxxxH
}
</pre></td></tr>
<tr><th colspan="2"><a name="virstr_hash32_v">virstr_hash32_v()</a></th></tr>
<tr><td>
char* s = "sample text";<br/>
DWORD h1;<br/>
virstr_hash32_v(h1, s);
</td><td><pre>
asm
{
  mov     esi, s
  xor     eax, eax
__calc_hash:
  rol     eax, 7
  xor     al, [esi]
  inc     esi
  cmp     byte ptr [esi], 0
  jne     __calc_hash
  mov     h1, eax
}
</pre></td></tr>
<tr><th colspan="2"><a name="virstr_hash32_v_new">virstr_hash32_v_new()</a></th></tr>
<tr><td>
char* s = "sample text";<br/>
virstr_hash32_v_new(h1, s);
</td><td><pre>
DWORD h1;
asm
{
  mov     esi, s
  xor     eax, eax
__calc_hash:
  rol     eax, 7
  xor     al, [esi]
  inc     esi
  cmp     byte ptr [esi], 0
  jne     __calc_hash
  mov     h1, eax
}
</pre></td></tr>
<tr><th colspan="2"><a name="virstr_callpop">virstr_callpop()</a></th></tr>
<tr><td>
char* s1;<br/>
virstr_callpop(s1, "sample text");
</td><td><pre>
asm
{
  call    $+sizeof("sample_text")
  db      "sample text",0
  pop     s1
}
</pre></td></tr>
<tr><th colspan="2"><a name="virstr_callpop_new">virstr_callpop_new()</a></th></tr>
<tr><td><small>
virstr_callpop_new(s1, "sample text");
</small></td>
<td><pre>
char* s1;
asm
{
  call $+sizeof("sample_text")
  db "sample text",0
  pop s1
}
</pre></td></tr>
<tr><th colspan="2"><a name="virstr_stosb">virstr_stosb()</a></th></tr>
<tr><td><small>
char s1[260];<br/>
virstr_stosb(s1, "sample text");
</small></td>
<td><pre>
asm
{
  lea     edi, s1
  cld
  mov     al, 's'
  stosb
  ...
  mov     al, 't'
  stosb
  xor     al, al
  stosb
}
</pre></td></tr>
<tr><th colspan="2"><a name="virstr_stosb_new">virstr_stosb_new()</a></th></tr>
<tr><td>
virstr_stosb_new(s1, "sample text");
</td>
<td><pre>
char s1[12];
asm
{
  lea     edi, s1
  cld
  mov     al, 's'
  stosb
  ...
  mov     al, 't'
  stosb
  xor     al, al
  stosb
}
</pre></td></tr>
<tr><th colspan="2"><a name="virstr_stosb_xor">virstr_stosb_xor()</a></th></tr>
<tr><td>
char s1[260];<br/>
virstr_stosb_xor(s1, "sample text");
</td>
<td><pre>
asm
{
  lea     edi, s1
  cld
  xor     al, al
  sub     al, ...
  stosb
  xor     al, ...
  stosb
  add     al, ...
  ...
  xor     al, al
  stosb
}
</pre></td></tr>
<tr><th colspan="2"><a name="virstr_stosb_xor_new">virstr_stosb_xor_new()</a></th></tr>
<tr><td>
virstr_stosb_xor_new(s1, "sample text");
</td>
<td><pre>
char s1[12];
asm
{
  lea     edi, s1
  cld
  xor     al, al
  sub     al, ...
  stosb
  xor     al, ...
  stosb
  add     al, ...
  ...
  xor     al, al
  stosb
}
</pre></td></tr>
<tr><th colspan="2"><a name="virstr_stosd">virstr_stosd()</a></th></tr>
<tr><td>
char s1[260];<br/>
virstr_stosd(s1, "sample text");
</td>
<td><pre>
asm
{
  lea     edi, s1
  cld
  mov     eax, 'samp'
  stosd
  mov     eax, '...'
  stosd
  mov     eax, 'ext'
  stosd
}
</pre></td></tr>
<tr><th colspan="2"><a name="virstr_stosd_new">virstr_stosd_new()</a></th></tr>
<tr><td>
virstr_stosd_new(s1, "sample text");
</td>
<td><pre>
char s1[12];
asm
{
  lea    edi, s1
  cld
  mov    eax, 'samp'
  stosd
  mov    eax, '...'
  stosd
  mov    eax, 'ext'
  stosd
}
</pre></td></tr>
<tr><th colspan="2"><a name="virstr_stosd_xor">virstr_stosd_xor()</a></th></tr>
<tr><td>
char s1[260];<br/>
virstr_stosd_xor(s1, "sample text");
</td>
<td><pre>
asm
{
  lea     edi, s1
  cld
  xor     eax, eax
  sub     eax, ...
  stosd
  xor     eax, ...
  stosd
  add     eax, ...
  stosd
}
</pre></td></tr>
<tr><th colspan="2"><a name="virstr_stosd_xor_new">virstr_stosd_xor_new()</a></th></tr>
<tr><td>
virstr_stosd_xor_new(s1, "sample text");
</td>
<td><pre>
char s1[12];
asm
{
  lea    edi, s1
  cld
  xor     eax, eax
  sub     eax, ...
  stosd
  xor     eax, ...
  stosd
  add     eax, ...
  stosd
}
</pre></td></tr>
<tr><th colspan="2"><a name="virstr_stosb_xored">virstr_stosb_xored()</a></th></tr>
<tr><td>
char s[260];<br/>
virstr_stosb_xored(s, "abc", "xxxx");
</td>
<td><pre>
asm
{
  lea edi, s
  cld
  xor al, al
  sub al, -('a' xor 'x')
  stosb
  xor al, ...
  stosb
  ...
}
</pre></td></tr>
<tr><th colspan="2"><a name="virstr_stosb_xored_new">virstr_stosb_xored_new()</a></th></tr>
<tr><td>
virstr_stosb_xored_new(s, "abc", "xxxx");
</td>
<td><pre>
char s[4];
asm
{
  lea edi, s
  cld
  xor al, al
  sub al, -('a' xor 'x')
  stosb
  xor al, ...
  stosb
  ...
}
</pre></td></tr>
<tr><th colspan="2"><a name="virstr_stosd_xored">virstr_stosd_xored()</a></th></tr>
<tr><td>
char s[8];<br/>
virstr_stosd_xored(s, "abcdefg", "xxxxxxxxxx");
</td>
<td><pre>
asm
{
  lea edi, s
  cld
  xor al, al
  sub eax, ...
  stosd
  xor eax, ...
  stosd
}
</pre></td></tr>
<tr><th colspan="2"><a name="virstr_stosd_xored_new">virstr_stosd_xored_new()</a></th></tr>
<tr><td>
char s[260];<br/>
virstr_stosd_xored_new(s, "abcdefg", "xxxxxxxxxx");
</td>
<td><pre>
asm
{
  lea edi, s
  cld
  xor al, al
  sub eax, ...
  stosd
  xor eax, ...
  stosd
}
</pre></td></tr>
<tr><th colspan="2"><a name="virstr_stosd_xor_key">virstr_stosd_xor_key()</a></th></tr>
<tr><td>
char s[260];<br/>
virstr_stosd_xor_key(s, "sample text", 0x12345678, k);
</td>
<td><pre>
asm
{
  lea     edi, s
  mov     eax, k
  cld
  sub     eax, 0x12345678 - 'samp'
  stosd
  xor     eax, ...
  stosd
  add     eax, ...
  stosd
}
</pre></td></tr>
<tr><th colspan="2"><a name="virstr_stosd_xor_key_new">virstr_stosd_xor_key_new()</a></th></tr>
<tr><td>
virstr_stosd_xor_key_new(s, "sample text", 0x12345678, k);
</td>
<td><pre>
char s[12];
asm
{
  lea     edi, s
  mov     eax, k
  cld
  sub     eax, 0x12345678 - 'samp'
  stosd
  xor     eax, ...
  stosd
  add     eax, ...
  stosd
  ...
}
</pre></td></tr></table>
<p>Download <a href="files/vzo/virstr.zip">virstr.zip</a> (8K)</p>
[<a style="" href="/lib/?lang=EN&amp;index=VT#vzo09">Back to index</a>] [<a href="/lib/vzo09.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vzo09">de</a><a href="/lib/index.php?lang=en&amp;id=vzo09">en</a><a href="/lib/index.php?lang=es&amp;id=vzo09">es</a><a href="/lib/index.php?lang=it&amp;id=vzo09">it</a><a href="/lib/index.php?lang=fr&amp;id=vzo09">fr</a><a href="/lib/index.php?lang=pl&amp;id=vzo09">pl</a><a href="/lib/index.php?lang=ru&amp;id=vzo09">ru</a><a href="/lib/index.php?lang=ua&amp;id=vzo09">ua</a></div>
</body>
</html>
