<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Peter Ferrie 'Let them eat brioche' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Peter Ferrie"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Ferrie, Peter,Let them eat brioche, files, method, impanate, code, section, size, streams, file, assembly, order, appends, assemblies, information, viruses, methods"/>
<meta name="Description" content="In 2003 I wrote: `A virus using the manual reconstruction technique seems unlikely, since the underlying structures in .NET are extremely complex and contain many interdependencies' (see VB, April 2003, p.5). However, in 2004 we received one that did it: MSIL/Impanate.Written by the virus writer known as `roy g biv', a specialist in proof-of-concept viruses (most recently, the first 64-bit viruses on the Win64 platform: W64/Rugrat on IA64, [see VB, June 2004, p.4] and W64/Shruggle on AMD64), Impanate is the first known parasitic, entry point obscuring appender for the .NET platform."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"37d73b92c5eec60e54685ff9d34accf44c337f42-1498756675-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/apf22.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Let them eat brioche</h1><p><a href="/lib/?lang=en&amp;author=Ferrie%2C%20Peter">Peter Ferrie</a><br/> <em>Virus Bulletin, November 2004, pp.6-7</em><br/> <em>ISSN 0956-9979</em><br/> <em>November 2004</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/apf22.html';</script><img src="/img/pdf.gif" alt="PDF"/><a href="/lib/pdf/Let%20them%20eat%20brioche.pdf">Download</a> PDF (23Kb) (You need to be registered on <a href="/forum">forum</a>)<br/>[<a style="" href="/lib/?lang=EN&amp;index=AN#apf22">Back to index</a>] [<a href="/lib/apf22.html#disqus_thread">Comments</a>]<br/> <form method="post" action=""><input type="hidden" name="pages" value="1"/><input type="submit" value="Turn on page numbers"/></form>
<address>
Peter Ferrie<br/>
Symantec Security Response, USA
</address>
<p>In 2003 I wrote: `A virus using the manual reconstruction technique seems unlikely, since the underlying structures in <em>.NET</em> are extremely complex and contain many interdependencies' (see <em>VB</em>, April 2003, p.5). However, in 2004 we received one that did it: MSIL/Impanate.</p>
<p>Written by the virus writer known as `roy g biv', a specialist in proof-of-concept viruses (most recently, the first 64-bit viruses on the <em>Win64</em> platform: W64/Rugrat on <em>IA64</em>, [see <em>VB</em>, June 2004, p.4] and W64/Shruggle on <em>AMD64</em>), Impanate is the first known parasitic, entry point obscuring appender for the <em>.NET</em> platform.</p>
<h2>Sign of the times</h2>
<p>Impanate searches in the current directory for files which do not contain a zero in the Second field of the LastWriteTime field. Impanate sets the Second field to zero in every file it examines, which serves both as an infection marker and as a means to avoid re-examining uninfectable files.</p>
<p>The use of the timestamp field is a speed optimization method, since it can be queried without incurring the performance penalty of opening the file. In addition, the LastWriteTime field is the only time field that is never changed when a file is copied to another location.</p>
<h2>Filtration device</h2>
<p>As with all viruses produced by this virus writer, files are infected only if they pass a strict set of filters. The conditions include that the file must be a character-mode or GUI application for the <em>.NET</em> framework, that the file is not a DLL, that the file contains no digital certificates, and that it has no bytes outside the image.</p>
<p>The virus avoids files that contain StrongNameSignatures or VTableFixups. StrongNameSignatures are used for digital signing of <em>.NET</em> files, so it is clear why the virus avoids files which contain them. However, it is not clear why the virus avoids VTableFixups.</p>
<p>The virus avoids files whose last section is writable, because the virus wants to place its code in the last section of the host, but the <em>.NET</em> framework will not allow code to execute from within a writable section.</p>
<p>In addition, the virus supports both 32-bit and 64-bit files, and will infect them both correctly, using a tiny piece of code trickery.</p>
 
<h2>Slipstream</h2>
<p>The virus parses the Metadata root header manually, searching for the streams that it requires. The streams are named `#~', `#Strings' and `#Blob'. The streams may appear in any order - most tools produce a constant order - but the virus will reorder them when it infects a file.</p>
<p>The virus is also aware of several undocumented characteristics of the <em>.NET</em> file format, including the extra data fields that can appear in the header and the flags that control the size of the stream references.</p>
<p>The `#~' stream contains information that is of interest to the virus. Specifically, the virus requires that the host contains 16-bit references to the `#Blob', `#GUID' and `#Strings' streams, which make the `#~' stream easier to parse, and that the host contains the following elements: TypeRefs, MemberRefs, StandAloneSigs, AssemblyRefs, Assemblies and Methods.</p>
<p>The virus parses the stream manually to find the TypeRefs, MemberRefs, StandAloneSigs, AssemblyRefs and Methods. The virus is not interested in the Assemblies as such, but simply requires that some are present.</p>
<h2>Some assembly required</h2>
<p>The TypeRefs contain pointers into the `#Blob' stream of the descriptions (the types of parameters to be passed, if any, and the type of the return value, if any) of the library functions used by the host. The virus appends its own TypeRefs to those of the host and updates the references in the `#Blob' stream.</p>
<p>The MemberRefs contain pointers into the `#Strings' stream of the names of the library functions and properties used by the host. The virus appends its own MemberRefs to those of the host and appends the MemberRef names to the `#Strings' stream.</p>
<p>The StandAloneSigs contain the number and type of variables in each Method. The virus chooses randomly from the StandAloneSigs of the host, duplicates one of them and appends the StandAloneSigs of the virus to it.</p>
<p>The AssemblyRefs contain pointers into the `#Strings' stream of the names of external assemblies that contain the functions used by the host. The virus requires two particular assemblies to be referenced in order to replicate.</p>
<p>The first assembly the virus requires is `mscorlib', which is the assembly that contains many core functions, and which is roughly equivalent to `kernel32' for <em>Windows</em> applications.</p>
<p>The second assembly the virus requires is `System', which the virus uses to access the process memory, in order to copy the virus code to a local buffer, for modification prior to placing it in the host.</p>
<p>The virus does not alter the AssemblyRefs collection, perhaps because it would mean updating each method of the host, resulting in many changes to the file.</p>
<h2>Method actor</h2>
<p>The Methods contain the host code. The virus finds the first method that uses the StandAloneSigs that the virus chose earlier, and which supports the use of local variables. The virus also requires that the method contains no exception handling information. The most likely reason for this is that the process of updating the exception handling information is extremely complicated.</p>
<p>Having found a suitable method, the virus duplicates it, then appends the virus code to it. After the host method has run it would normally return to the caller; now, the virus will begin to execute at that time, before returning to the caller.</p>
<p>After appending the virus code, the virus parses it manually to update the references to the local variables and functions. The virus contains code to calculate the length of each instruction in the MSIL instruction set, and it knows which instructions need to be processed specially.</p>
<p>After updating the code, the virus updates the size of the last section and the host image size, and recalculates the file checksum, if required.</p>
<h2>Expect the unexpected</h2>
<p>And so it comes to pass that, in the hands of a skilled programmer, the unlikely can became the ordinary. At least I didn't say that it could not be done because it was too difficult - anything is possible for those who have enough patience.</p>
<table summary="MSIL/Impanate">
<tr><th colspan="2">MSIL/Impanate</th></tr>
<tr><th>Size:</th><td>7539 bytes.</td></tr>
<tr><th>Type:</th><td>Direct action, parasitic, entry point obscuring appender.</td></tr>
<tr><th>Infects:</th><td>Microsoft .NET files.</td></tr>
<tr><th>Payload:</th><td>None.</td></tr>
<tr><th>Removal:</th><td>Delete infected files and restore them from backup.</td></tr>
</table>
 
<div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=apf22">de</a><a href="/lib/index.php?lang=en&amp;id=apf22">en</a><a href="/lib/index.php?lang=es&amp;id=apf22">es</a><a href="/lib/index.php?lang=it&amp;id=apf22">it</a><a href="/lib/index.php?lang=fr&amp;id=apf22">fr</a><a href="/lib/index.php?lang=pl&amp;id=apf22">pl</a><a href="/lib/index.php?lang=ru&amp;id=apf22">ru</a><a href="/lib/index.php?lang=ua&amp;id=apf22">ua</a></div>
</body>
</html>
