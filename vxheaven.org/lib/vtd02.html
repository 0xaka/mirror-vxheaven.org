<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title> Tiberio Degano 'Anti Virus Detection Strategies and how to overcome them' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Tiberio Degano"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Tiberio Degano,Anti Virus Detection Strategies and how to overcome them, place, dword, host, wildcards, xray, virus, counter, parsing, decryptor, plan, antivirus, swapping, emulation, emulator, memory"/>
<meta name="Description" content="This article will talk about Avers in depth. How they think and what ideas they will use and the most important thing is how to overcome these defenses and put your brain in the straightway."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"3567e549f52ea33c4b47f14df6613c351bda3ab0-1498755511-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vtd02.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Anti Virus Detection Strategies and how to overcome them</h1><p><a href="/lib/?lang=en&amp;author=Tiberio%20Degano"> Tiberio Degano</a><br/> <em><a href="/vx.php?fid=1904#f1904">Decepticons #1</a></em><br/> <em>December 2009</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vtd02.html';</script>[<a style="" href="/lib/?lang=EN&amp;index=AA#vtd02">Back to index</a>] [<a href="/lib/vtd02.html#disqus_thread">Comments</a>]<br/> 
<ul>
<li><a href="#c1">1. Introduction</a></li>
<li><a href="#c2">2. Wildcards</a>
<ul>
<li>Overcome Wildcards</li>
</ul></li>
<li><a href="#c3">3. Emulation</a></li>
<li><a href="#c4">4. Dynamic Analysis VS Static Analysis</a>
<ul>
<li><a href="#c41">4.1 Static Analysis for Executables</a>
<ul>
<li><a href="#c411">4.1.1. Dynamic Register Swapping</a></li>
<li><a href="#c412">4.1.2. Anti-NegativePattern</a></li>
</ul></li>
<li><a href="#c42">4.2. Code Disassembling</a></li>
</ul></li>
<li><a href="#c5">5. XRAY</a>
<ul>
<li><a href="#c51">5.1. Host Key</a></li>
</ul></li>
<li><a href="#c6">6. Decryptor Parsing</a>
<ul>
<li><a href="#c61">6.1. Switching Branches</a></li>
</ul></li>
<li><a href="#c7">7. What we should do?</a></li>
</ul>
<h2><a name="c1"></a>1. Introduction</h2>
<p>Hi everyone I'm Tiberio Degano. This article will talk about Avers Techniques which they use to detect your virus.</p>
<p>Many Viruses have been written with many features polymorphic, epo and maybe metamorphic and become an easy task for Avers to detect it. Some virus writers create new ideas and spend most of their time and brain try to make it real and these ideas never harden their virus against avers. Do you know why? Because they don't understand Antivirus very well and they don't understand <em>Anti Virus Detection Strategies</em> that's what make their virus an easy task for the avers.</p>
<p>This article will talk about Avers in depth. How they think and what ideas they will use and the most important thing is how to overcome these defenses and put your brain in the straightway.</p>
<p>We will begin from zero to make understand my Thinking and my brain. To make you create a plan against Avers techniques and strategies and to bypass their defenses and at least create the most complex virus ever seen.</p>
<p>This Article is from my little knowledge. It could contain some missed parts or some bad analyzing. If you see any problem please mail me fast. I'm waiting for your feedback.</p>
<h2><a name="c2"></a>2. Wildcards</h2>
<p>Let's begin the journey in the avers' brains. We will now begin with wildcards. Wildcards is one of the most famous detection techniques and there's many antivirus companies based only on it and I think one of them is ClamAV. ClamAV is based on pattern to search for it and it include some code for detecting some famous polymorphic engines.</p>
<h3>Overcome Wildcards</h3>
<p>You can easily overcome wildcards and bypass it by any obfuscated polymorphic engine like MtE or Marburg.</p>
<p>We will not talk many about wildcards let's jump to the next.</p>
<h2><a name="c3"></a>3. Emulation</h2>
<p>Emulation is the most powerful technique ever in Antivirus technology. You can say without emula on the An virus will never detect most of <a href="/vx.php?id=g000">29A</a> viruses and will not detect any complex virus ever.</p>
<p>Many anti-emulation tricks appeared and no one of them stop emulation forever. Most of them delay the antivirus for their viruses for a while (only if there is a new trick) and nothing more than that. That's why I don't prefer anti-emulation tricks like SEH or anything like that.</p>
<p>I think the EPO is the only way to stop emulation forever. Emulation needs an entrypoint to begin and EPO is based on hiding this thing from the emulator to make it impossible to emulate.</p>
<p>I describe some ideas in EPO field I hope you read them in "<a href="/lib/vtd00.html">Easy to Infect Hard to Detect</a>" so I'll not go into the details here I will jump into the next topic.</p>
<h2><a name="c4"></a>4. Dynamic Analysis VS Static Analysis</h2>
<p>What's the Analyzer? Many people don't ask this question even it's the most important question you should ask to understand how Antivirus work. I think the bad understanding of the detection techniques comes from here. Many people think that the emulator or any analyzer can do a magic to detect your virus and most of ideas against Analyzers is how to make them away from our virus.</p>
<p>Analyzer is an automated tool try to extract the functionality of the code – or your virus – regardless of the shape of the instructions that the virus written by them. The concept make the analyzer like a ghost and can't be bypassed even it's just a computer not a brain and could be bypassed.</p>
<p><em>Dynamic Analysis</em> is simply run a program in a virtual machine and traces its functionality. Understand the functionality is by monitoring any memory changes and tracing the registers' values to understand the behavior of the code:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edx</span> &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;eax--&gt;'ZM' edx--&gt;'ZM'</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ecx</span> &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ebx--&gt;'EP' ecx--&gt;'EP'</span><br/>
&nbsp;</div>
<p>As you can see the emulator can easily detect that you want to test the beginning of an exe file. Maybe the infected file or maybe searching for the kernel base or something like that:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: black;">&#91;</span><span style="color: #ff0000;">00401560</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">20h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: black;">&#91;</span><span style="color: #ff0000;">00401560</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">11h</span>&nbsp; <span style="color: black; font-style: italic;">;in [00401560]--&gt;31 --&gt;'1'</span><br/>
&nbsp;</div>
<p>Here also the emulator will monitor the Memory changes and detect what you want to write. That's the way that emulator detect your virus. It's not a magic it's a normal technique and could be bypassed by a creative brain.</p>
<p>In my virus <a href="/src.php?info=skipo.zip">Skipo</a> I don't face these problems (and I'll tell you why) so I'm not the creative brain that you search for but I can tell you something:</p>
<p>If you could change the source and the destination of everything the emulator will face a big problem against you like that</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">056h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">056h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edx</span> &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;eax--&gt;'ZM'Xored by 56h edx--&gt;'ZM'Xored by 56h</span><br/>
&nbsp;</div>
<p>At this time when the emulator stop at cmp eax,edx it will not see cmp ZM and will not detect your behavior.</p>
<p>And as I said before the emulator is not a brain. It only scans the code while running searching for patterns of malicious behavior or famous patterns in your virus. If it found them in the same order (that can't be permutated) it will say that a virus and if not it will pass your virus as a normal file.</p>
<p>These patterns could be memory patterns (data in memory) or could be instructions with specific values in the registers used or memory variables in the instruction.</p>
<p>Is there a way to bypass this technique? Surely yes but need a good understanding and a creative brain to bypass it.</p>
<p>Most of virus writers bypass the whole emulation by a trick (like EPO) and avoid this painful challenge against the dynamic analysis and one of them is me in my virus Skipo. So what will they do? They will jump into the Static Analysis.</p>
<p>So what's the Static Analysis? This is the topic that I write the whole article for it. Many virus writers didn't jump into finding tricks to bypass static analysis even it's not widely used. Yeah it's not widely used but in complex virus like zmist this idea could be used and something like SK or enfish this idea also will be used.</p>
<p>Static Analysis contain two types the First is code Disassembling and the second is Static Analysis for Executables (as the article of it was written with the same name). We will explain each one and tricks to overcome them in the next two parts.</p>
<h3><a name="c41"></a>4.1 Static Analysis for Executables</h3>
<p>This type you can simply name it "Tracing the Registers Behavior". This Analysis work by trace the registers and search for a register that should be in the decryptor the counter or the pointer and test if there are all the decryptor's registers' behavior. If there are so this code is decrypting the virus so we should emulate this code and test if the virus appeared in the memory. If not so the file is not infected.</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>0040XXXX&nbsp; &nbsp; <span style="color: black; font-style: italic;">;put a pointer in edi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; xxx &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;code</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; xxx<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;read from edi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; xxx<br/>
&nbsp; &nbsp; &nbsp; &nbsp; xxx<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span> &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;write in edi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; xxx<br/>
&nbsp; &nbsp; &nbsp; &nbsp; xxx<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;add 4 in edi</span><br/>
&nbsp;</div>
<p>As you can see in this code the analyzer trace what happen to edi and try to detect if it work as a register in the decryptor. If it see code on another register do like the counter and so on (surely without any modification in junk code) it will detect that's the counter.</p>
<p>This technique has two problems. The first problem is the performance. It's very slow so I think negative pattern comes in handy for it. The second problem is it is based on the registers behavior so any play with the registers will make this idea useless. So we will build our ideas on these problems to overcome this technique. Let's start the first.</p>
<h4><a name="c411"></a>4.1.1. Dynamic Register Swapping</h4>
<p>As we say in the beginning any play with the registers will make it useless and that's it. I think this is the first new idea (really new) in the article. This technique is simply swapping the registers in the middle of the code like that:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx--&gt;counter</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xchg</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ecx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;eax--&gt;counter</span><br/>
&nbsp;</div>
<p>This code will swap the registers in the middle of the decryptor code. The values will be exchanged and the eax will have the value if ecx and will act as the counter in the next instructions of the decryptor. Don't forget that before the loop jump you should swap the registers again and again until reach the initial registers that you begin the loop with them.</p>
<p>That's also another shape:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx--&gt;counter</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ecx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;eax--&gt;counter or ecx--&gt;counter</span><br/>
&nbsp;</div>
<p>This shape will make the value of eax deleted but you will have two registers have the same value and also can any one of them act like the counter. Who will detect what you choose as a counter? No reply.</p>
<p>There's the fake dynamic register swapping it's simply write mov exx,exx without real swapping and if ecx is the counter it will continue the counter like nothing happen. This trick will force the analyzer to detect if there's a real swapping or fake and if it can't detect it should brute force. This idea will become useless against this small trick.</p>
<p>For better explain read this code <strong>carefully</strong> and try to detect what's happen?</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span>Virus_size&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ECX--&gt;counter</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>Virus_Place &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;edi--&gt;virus pointer</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edi</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;register swapping</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: black;">&#93;</span> &nbsp; &nbsp; <span style="color: black; font-style: italic;">;act like edi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">12345678h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;fake register swapping</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;edi become free to use</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr<span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edi</span>&nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;edx not ebx because it's fake and edi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;not eax because there's register swapping</span><br/>
&nbsp;</div>
<p>I hope you understand my idea. It's really hard to analyze and hard to detect who is the real and who is the fake.</p>
<p>Now let's jump to the negative pattern. Hey let's go…</p>
<h4><a name="c412"></a>4.1.2. Anti-NegativePattern</h4>
<p>This trick try to write some code that the polymorphic engine can't write but it could be found in the real program like many APIs calls and so on. This trick can make negative pattern filtering more hard even they will see in the polymeric decryptor all instructions could be found so they can't filter the host code to search for the virus even the virus contain everything.</p>
<p>The idea is simply copy some instructions from the host to the decryptor and put them between if &amp; endif to make them never executed. To make it you should have a disassembler for your virus and that's the steps to use this idea:</p>
<ol>
<li>search for push ebp/mov ebp,esp</li>
<li>disassemble the code and save the size of every instruction</li>
<li>now begin from a random instruction and take a random number of instructions</li>
<li>write in your decryptor
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">50</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;will not happen</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; Size_of_all_instructions<br/>
&nbsp;</div>
<p>or</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span>Virus_Size<span style="color: #339933;">+</span><span style="color: #ff0000;">1000</span> &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx--&gt;counter</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; XXX &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx will never exceed the virus size</span><br/>
&nbsp;</div></li>
<li>copy the instructions into your decryptor</li>
<li>voilà you now have instructions you can't write and this code will never executed</li>
</ol>
<p>They will need an analyzer before using negative pattern and that's impossible. Imagine we merge this idea with register swapping I think the static analyzing will become impossible or too hard to use.</p>
<p>Let's jump to the next type of static analyzing.</p>
<h3><a name="c42"></a>4.2. Code Disassembling</h3>
<p>Code disassembling is faster and better than the previous type. This idea is based on the shape of the instructions and the imm32 that used in the instructions. This idea is searching for interested instructions that could be an instruction of a metamorphic code and the emulator comes in handy in this type of analysis. The benefit of this idea that it doesn't need the entrypoint only any pointer in the middle so it could be used a key validation for XRay.</p>
<p>This trick can deobfuscate a weak polymorphic or a metamorphic code but I think it's very weak against highly-obfuscated polymorphic code.</p>
<p>So overcoming this trick could be done by a multi-layer poly that you can't XRay the whole layers in the same time (like all layers use xor so the XRay will make all of them as one layer).</p>
<p>This trick is used (as I think) in Zmist as the encryption algorithm of Zmist is just a sliding key and the code is metamorphic under this layer. So the detection will be with XRay with code disassembling as a key validation and we will become away from this polymorphic engine and this code integration technique.</p>
We will now talk about the last detection technique XRAY.
<h2><a name="c5"></a>5. XRAY</h2>
<p>I think XRay is very famous and it doesn't need any describe so I'll jump into its weaknesses directly. The first problem is the performance of XRay. I think it's the last choice for any Aver to use because of performance and you can see the performance of XRay is based on the luck. As they build their detection algorithm on the worst case so XRay in most cases is a painful choice.</p>
<p>You can avoid it by using a multi-layer multi-algorithm polymorphic engine with different keys (sliding key is preferred and don't use xor in the slide key) or also you can use this new idea as a new key for you. I think it's impossible to be Xrayed especially with multi-algorithm decryptor. Its name is Host Key.</p>
<h3><a name="c51"></a>5.1. Host Key</h3>
<p>Host key is a simple key and easy to use away from using a hardcoded algorithm that become so hard to be obfuscated by your polymorphic engine. This idea is simply taking a part from the host equal to the size of your virus as a key to encrypt your virus. Analyze this decryptor <strong>carefully</strong> to understand my idea.</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Virus_Place--&gt;pointer to the place of the virus</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;host_Place---&gt;pointer to a place in the host its size==virus_size</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span>Virus_size&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ECX--&gt;the size of virus</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">+</span>Virus_Place<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">+</span>host_Place<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ebx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;we encrypt the virus by a place in the host</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr<span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">+</span>Virus_Place<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp;</div>
<p>This trick could be used without any limits if you make the virus run at the beginning of the application (before the host) but if you use an EPO you should take a read-only part from the host equal to the size of the virus and all decryptor except the first (if you use a multi-layer poly).</p>
<p>The second restriction you will face is you should take the whole place in the same section in the host. If you see two read-only sections don't use them as the host place because the virtual size of every section is different from the size of raw data. When they mapped in the memory (as a process) you will see there's new bytes added to each section at the end make the decryption key different from the encryption key. The last restriction in this idea is the multi-infection will become impossible if you don't add your virus at the end.</p>
<p>If XRay failed how they will think. I think they will use decryptor parsing and that's the next.</p>
<h2><a name="c6"></a>6. Decryptor Parsing</h2>
<p>Decryptor parsing is a helpful tool for xray. It search for the decryptor and try to get the pointers and the important data from your decryptor. Any much explain I don't have but I think you could name it a simple static analyzer try only to get the pointers and the keys.</p>
<p>Highly obfuscated code could defeat Decryptor parsing. Decryptor parsing can get some pointers or some imm32 but can't analyze the code and that's we will build our next idea.</p>
<h3><a name="c61"></a>6.1. Switching Branches</h3>
<p>This idea is a huge idea. It's very powerful against any type of analysis, decryptor parsing and xray. This idea can only be used with a multi-algorithm poly with huge size for the decryptor.</p>
<p>Imagine if we have 4 algorithms in our decryptor. We will not make them run every me but we will make some switches before each algorithm make it ON/OFF or work/not work. These switches will be cmp/jcc and the switch will be based on (mainly) the counter. When the switch become ON the algorithm will run and when become off the jcc will jump to the next algorithm.</p>
<p>All of these switches will be written in the encryptor so will make all the algorithms the same type (like all of them xor or add) but you can use sliding keys or host keys. This restriction is for not writing the algorithms in the encryptor from the last to the first. If you are using the same algorithm you can order them in the encryptor exactly like the decryptor and that's will be easier to write in the encryptor.</p>
<p>This Idea can bypass the decryptor parsing because the decryptor parsing can get some pointers or imm32 but it can't get the switches because it needs a good analyzer to get them. Also the xray will become impossible because it can brute force the key but can't predict the switches that used. Also it need a great analyzer to understand that that's a loop not some if/endif or switches. But this idea also is hard to write and hard to obfuscate need a great programmer and much time to convert it into real.</p>
<p>Now let's take an example. I will give you an example of a normal decryptor with multi-algorithm and how we will convert it into switching branches:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ecx</span><br/>
_@<span style="color: #ff0000;">1</span><span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;the first algorithm Xor eax,50000</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">+</span>Virus_place<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">50000</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">+</span>Virus_place<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;the second algorithm Xor eax,ebx (host key)</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">+</span>Virus_place<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">+</span>host_place<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ebx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">+</span>Virus_place<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;the third algorithm Xor eax,70000</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">+</span>Virus_place<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">70000</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">+</span>Virus_place<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span>Virus_Size<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jb</span>&nbsp; &nbsp; &nbsp; _@<span style="color: #ff0000;">1</span><br/>
&nbsp;</div>
<p>Let's see the switching branches:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ecx</span><br/>
_@<span style="color: #ff0000;">1</span><span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;the first algorithm Xor eax,50000</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;the first switch ecx/2=1 (last bit=1)</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; _@<span style="color: #ff0000;">2</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;oFF</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">+</span>Virus_place<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">50000</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">+</span>Virus_place<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br/>
_@<span style="color: #ff0000;">2</span><span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;the second algorithm Xor eax,ebx (host key)</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;the secnd switch ecx/8=1 (last 3 bit=100)</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">100</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; _@<span style="color: #ff0000;">3</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;oFF</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">+</span>Virus_place<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">+</span>host_place<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ebx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">+</span>Virus_place<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br/>
_@<span style="color: #ff0000;">3</span><span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;the third algorithm Xor eax,70000</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;the secnd switch ecx != 50</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">50</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; _@<span style="color: #ff0000;">1</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;oFF</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">+</span>Virus_place<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">70000</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">+</span>Virus_place<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span>Virus_Size<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jb</span>&nbsp; &nbsp; &nbsp; _@<span style="color: #ff0000;">1</span><br/>
&nbsp;</div>
<p>I hope this example make you understand my idea. I hope to see a virus writer use this idea.</p>
<h2><a name="c7"></a>7. What we should do?</h2>
<p>At the end I shall say we should make ourselves like an aver and try to predict how the aver will write a detection algorithm and how he will think and finding ways to bypass the detection that we predict.</p>
<p>In my little point of view the Aver will follow these steps in detecting our viruses:</p>
<ol>
<li>Use wildcards</li>
<li>If it's polymorphic so let's emulate and then wildcards</li>
<li>If it epo let's reverse the epo and then emulate</li>
<li>If it SK epo or Mistfall and simple poly they will jump into decryptor parsing</li>
<li>If it sk epo or Mistfall and highly-obfuscated poly and weak algorithm so Xray is good</li>
<li>If these epos and this poly and the same algorithm but metamorphic under the encryption so they will jump into XRAY and code disassembling with emulator in handy (that's zmist)</li>
<li>If a powerful algorithm like fpu or host key so they will think about static analysis</li>
<li>If dynamic register swapping and anti-negative pattern what will they do???… To be continued.</li>
</ol>
<p>That's my opinion and this what I want to reach from the beginning of the article and that's why I begin from the first line in virusing. You should make a plan for yourself and have your own point of view very organized like that before jumping on writing any virus that if you want <strong>really</strong> to bypass the antivirus and write a complex virus.</p>
<p>This point of view that I write is the plan and the first step when writing my second virus <a href="/src.php?info=skipo.zip">win32.skipo</a> I don't know now if it really become complex or not but if it become a very complex virus so my plan is right. But if not (and that's will be sad) try to write your own plan or correct the missed parts in my plan.</p>
<p>I hope you enjoyed. Bye</p>
<p>Tiberio Degano</p>
[<a style="" href="/lib/?lang=EN&amp;index=AA#vtd02">Back to index</a>] [<a href="/lib/vtd02.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vtd02">de</a><a href="/lib/index.php?lang=en&amp;id=vtd02">en</a><a href="/lib/index.php?lang=es&amp;id=vtd02">es</a><a href="/lib/index.php?lang=it&amp;id=vtd02">it</a><a href="/lib/index.php?lang=fr&amp;id=vtd02">fr</a><a href="/lib/index.php?lang=pl&amp;id=vtd02">pl</a><a href="/lib/index.php?lang=ru&amp;id=vtd02">ru</a><a href="/lib/index.php?lang=ua&amp;id=vtd02">ua</a></div>
</body>
</html>
