<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title> Changeling 'Polymorphism: Level 6B (Polymorphism: Chaotic Permutations)' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Changeling"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Changeling,Polymorphism: Level 6B (Polymorphism: Chaotic Permutations), level, method, push, polymorphism, size, sequence, viruses, block, instructions, call, virus, regular, scanning, program, link"/>
<meta name="Description" content="Level 6: permutating viruses. The main code of the virus is subject to change to change, it is divided into blocks which are positioned in random order while infecting. Despite of that the virus continues to be able to work. Such viruses may be unencrypted."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"e06201a067b8a68fa0fdba2b3e8861e3ab1e8b96-1498756991-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vch03.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Polymorphism: Level 6B (Polymorphism: Chaotic Permutations)</h1><p><a href="/lib/?lang=en&amp;author=Changeling"> Changeling</a><br/> <em>September 1999</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vch03.html';</script><div class="ci"><a href="/lib/?ci=vch03">1</a></div>[<a style="" href="/lib/?lang=EN&amp;index=PO#vch03">Back to index</a>] [<a href="/lib/vch03.html#disqus_thread">Comments</a>]<br/> 
<ul>
<li><a href="#p1">1. Introduction</a></li>
<li><a href="#p2">2. Approaching Level 6B</a></li>
<li><a href="#p3">3. Internal Jmps and Calls</a></li>
<li><a href="#p4">4. Problems with Level 6</a></li>
<li><a href="#p5">5. The End and Future</a></li>
</ul>
<p><em>[I'd like to point out that there's a large number of variations to this idea and I'll leave it to your creativity to figure out what hides in the shadows.]</em></p>
<h2><a name="p1">1. Introduction</a></h2>
<p>Definition by Eugene Kaspersky:</p>
<blockquote>
<dl>
<dt>Level 6: permutating viruses.</dt>
<dd>The main code of the virus is subject to change to change, it is divided into blocks which are positioned in random order while infecting. Despite of that the virus continues to be able to work. Such viruses may be unencrypted.</dd>
</dl>
</blockquote>
<p>Consider a code of three instructions A, B and C. If these instructions are written in a row, one after another, there're six (3!=3*2*1) possible arrangements: ABC, ACB, BAC, BCA, CAB, CBA. This method of permutation I call level 6a. So what is level 6b?</p>
<p>The three instructions A, B and C occupy spaces that we label <strong>os</strong>. Now, let's add one more space, but it'll always be unoccupied so we'll label it <strong>us</strong>. How many permutations are now possible?</p>
<p><strong>(os+us)!=(3+1)!=4*3*2*1=24</strong></p>
<p>The powers of this become obvious when <strong>(os+n*us)!</strong>, where <strong>n</strong> is any number. This method I call 6b polymorphism.</p>
<p>The idea behind polymorphism at level 6 is to divide our code into blocks that can be permutated so that scanners can't detect them with search strings with/without wildcards. There're various approaches to level 6 code, f.ex:</p>
<pre class="source">
[loop method]      [sequence method]     [internal method]
@00: cmp bl, 01    @00: ...              @00: ...
     jne @01           jmp @01               jmp @01
     inc ebx       @01: ...                  ...
     ...               jmp @02           @01:jmp @02
@01: cmp bl, 00                          @02:...
     jne @00                                 jmp @03
     inc ebx                                 ...
     ...                                 @03:jmp @04
</pre>
<p>['...' is in each example the same, I've only changed the logical structure.] Whatever logical structure all methods require that you pack your code into blocks that can be permutated. Some viruses that use level 6 techniques are f.ex TMC and Ply viruses.</p>
<h2><a name="p2">2. Approaching Level 6B</a></h2>
<p>One way to pack your code is to use 'minimal blocks'. Minimal blocks just consist of 1 instruction followed by an uncoditional jmp (short/near/far). F.ex:</p>
<pre class="source">
push 0                ; 2b   -->   push 0                     ; 2b  | block 00
push offset filename  ; 5b         jmp @01                    ; 2b  |
call _lcreat          ; 5b         @01: push offset filename  ; 5b  | block 01
                                   jmp @02                    ; 2b  |
                                   @02: call _lcreat          ; 5b  | block 02
                                   jmp @03                    ; 2b  |
</pre>
<p>The point with this is to let us be able to spread our program randomly over/into another program. This example executes its instructions consecutively, for the moment let's forget about loops and calls, so if we've spread our program in a random fashion we only have to link the jmps together so the program will execute in the right order.</p>
<p>The first code had a total size of 12b while the packed code became 18b long. One way to minimize the packed code size is to bundle several instructions together, but then there's the risk of becoming recognizable with search strings.</p>
<p>The blocks have a variable size and to make it easier to deal with them I introdcue the term 'invisible boundary'. The <strong>ib</strong> ('invisible boundary') value is the size of our largest block. In our previous example the largest block was 01/02 and then the value of <strong>ib</strong> becomes 7.</p>
<p>If our code consists of 10 blocks and the <strong>ib</strong> value is 7 then the minimum size of another code (of the program we want to infect) must be at least 70b. So if another code is 77b long then it has for our code 10 <strong>os</strong> and 7-1 <strong>us</strong> which may result in 16! permutations. Wow!</p>
<p>But why 7-1? We 'must' reserve the first block in the other program for our first block, the execution follows a critical sequence.</p>
<p>Remember, when writing to the blocks we don't write as many bytes as ib's value. F.ex, when <strong>ib</strong> equals 7:</p>
<pre class="source">
[our code]        [other code]       [new code]        [overwritten code]
push 0  ; 2b   +  inc eax ; 1b  =    push 0  ; 2b
jmp @01 ; 2b      inc ebx ; 1b       jmp @01 ; 2b
                  inc ecx ; 1b       dec eax ; 1b
                  inc edx ; 1b       dec ebx ; 1b
                  dec eax ; 1b       dec ecx ; 1b
                  dec ebx ; 1b       dec edx ; 1b
                  dec ecx ; 1b                     >   inc eax   | put
                  dec edx ; 1b                         inc ebx   | them
                                                       inc ecx   | somewhere
                                                       inc edx   | else
</pre>
<p>So, what does our program have to do?</p>
<ol>
<li>Permutate the code</li>
<li>Modify the blocks</li>
</ol>
<p>The easiest thing to do when permutating the code is to generate a new sequence, like this:</p>
<pre class="source">
	[old sequence]   -->   [new sequence]
	01020304050607   -->   01070305040602
</pre>
<p>When generating a new sequence you'll quite likely have to use some kind of sorting algorithm that sorts some random numbers that you'll 'generate'. Now we can simply write the blocks to their new locations and all we've to do now is to link the jmps together.</p>
<p>When the <strong>ib</strong> is equal to 7 and we've got 3 blocks and the original sequence looks like '123' and the new sequence looks like '132' then we've to link 1 to 2 to 3. But, since the blocks are of variable size we've to find how many byte precede a jmp instruction. In this case block 1 has a jmp after 1b and block 2 after 2b. So:</p>
<pre class="source">
	Block 1 jmps to Block 3 = (7b - 3b) + 7b = 11b jmp ; here
	3b = 1b + 2b (jmp + coordinates)
	Block 3 jmps to block 2 = -3b - 7b = -10b jmp      ; here 3b = 2b + 1b (jmp only)
</pre>
<p>But let's assume we've managed to perform our permutation and our code is now all over the place. How can we read the blocks in the right sequence? We must trace the code with the help of the jmp coordinates. To place our first block at the Program_Entry_Point of the other program might, for the beginning, be a good idea.</p>
<p>And yes, code like 'mov al, 235' must be avoided when using jmps since, in this case, jmp=235.</p>
<h2><a name="p3">3. Internal Jmps and Calls</a></h2>
<p>Now we've a block that looks like this:</p>
<pre class="source">
loopw <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="107c7f7f60502020">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script>   ; a type of jmp    or   call MessageBox   ; a call
jmp @06         ; the regular
jmp        jmp @06          
; the regular jmp
</pre>
<p>My first advice is that you avoid them as much as possible. If you've got to use calls and especially APIs then I suggest you import them. To get some ideas you should hav a look at the article '<a href="/lib/vlj02.html">Accessing Windows 95 API's by scanning PE-tables</a>' by Lord Julus, which can be found in <a href="/lib/vcc00.html">VDAT 1.9</a>.</p>
<p>The easiest way around the jmp and call problem is to write your entire program to the beginning of the other program and to place its code to the end of itself, then you don't even have to manipulate the PE headers etc. You just have to swap the code around and execute the other program... and instead of hiding in the other program's code we can now generate random code to fill our code or rip it (more believable).</p>
<p>If you don't use the methods mentioned above it'll get more complicated. There're many different types of jmps and scanning for them is just like scanning for the end-of-block jmp, but it's more work. Calls are different, but they've also got some coordinates that need to be updated. F.ex, when calling an API the first instruction 'in' the procedure is usually a 'jmp dword [...]'. These instructions exist at the end of the regular code and when moving a block with a 'call' then we only have to add/substract the number of bytes we've moved up/down, and since we're dealing with blocks this is really easy because of the <strong>ib</strong> method.</p>
<p>You may f.ex hardcode all the coordinates of the blocks or search through the code.</p>
<h2><a name="p4">4. Problems with Level 6</a></h2>
<p>I suggest you use near jmps everywhere and skip all loop types, rewrite them as jmps, and you should also try to write as few loops as possible. Having strings/variables in the data section becomes more complicated. And, don't forget to deal with the 'jmp dword [...]' at the end of the code. There's also a significant increase in program size. With only structural changes the size increase will definetely be greater than 200%. If, f.ex, there comes a scanner that actually traces through the code, much like we do, then the code will be identifiable with a simple search string. I suggest you combine level 6 polymorphism with the usual encryption/decryption routines used in standard polymorphic code (level 1-5). I believe that this method will yield quite good results.</p>
<h2><a name="p5">5. The End and Future</a></h2>
<p>This method is rather difficult to implement and I suggest that all beginners first try other ways of coding polymorphic programs, like oligomorphic programs (level 1).</p>
<p>This method has a lot of potential and I hope that many viruses will make use of it. Best of luck.</p>
<p>[This paper is a work in progress and you may send comments/questions to <a href="/cdn-cgi/l/email-protection#75161d141b1210191c1b12350c1c13141b5b1b1001"><span class="__cf_email__" data-cfemail="cdaea5aca3aaa8a1a4a3aa8db4a4abaca3e3a3a8b9">[email&#160;protected]</span><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script></a>. If I get some positive feedback on this paper I'll consider writing several guides to all levels of polymorphism. I apologize if there're still unclear issues in this paper (this all represents my first tries at asm/virus/polymorphism), but I wrote this paper for me and you just happen to come second, for now. Hope you got some ideas.]</p>
[<a style="" href="/lib/?lang=EN&amp;index=PO#vch03">Back to index</a>] [<a href="/lib/vch03.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vch03">de</a><a href="/lib/index.php?lang=en&amp;id=vch03">en</a><a href="/lib/index.php?lang=es&amp;id=vch03">es</a><a href="/lib/index.php?lang=it&amp;id=vch03">it</a><a href="/lib/index.php?lang=fr&amp;id=vch03">fr</a><a href="/lib/index.php?lang=pl&amp;id=vch03">pl</a><a href="/lib/index.php?lang=ru&amp;id=vch03">ru</a><a href="/lib/index.php?lang=ua&amp;id=vch03">ua</a></div>
<script>/* <![CDATA[ */(function(d,s,a,i,j,r,l,m,t){try{l=d.getElementsByTagName('a');t=d.createElement('textarea');for(i=0;l.length-i;i++){try{a=l[i].href;s=a.indexOf('/cdn-cgi/l/email-protection');m=a.length;if(a&&s>-1&&m>28){j=28+s;s='';if(j<m){r='0x'+a.substr(j,2)|0;for(j+=2;j<m&&a.charAt(j)!='X';j+=2)s+='%'+('0'+('0x'+a.substr(j,2)^r).toString(16)).slice(-2);j++;s=decodeURIComponent(s)+a.substr(j,m-j)}t.innerHTML=s.replace(/</g,'&lt;').replace(/\>/g,'&gt;');l[i].href='mailto:'+t.value}}catch(e){}}}catch(e){}})(document);/* ]]> */</script></body>
</html>
