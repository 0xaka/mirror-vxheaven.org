<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title> The Sorcerer 'X-Rays Can Be Bad For Your Virus's Health' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="The Sorcerer"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, The Sorcerer,X-Rays Can Be Bad For Your Virus's Health, encryption, detection, methods, substitution, software, virus, simple, positions, bytes, permuting, encrypted, viruses, cipher, scheme, hide"/>
<meta name="Description" content="An old anti-virus (AV) technique that is over looked by most virus writers is X-Ray Detection. X-Ray detection is a simple method for detecting encrypted viruses and works on more than 50% of existing encrypted viruses today. Have you ever wondered why your new polymorphic, entry point obscuring virus is detected by the AV software? The chances are that they have found a X-Ray for your encryption scheme. These methods are called X-Rays because they enable the AV software to see the insides of your virus encryption protection without having to emulate your virus."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"33bad64dfa018e2be95259b3d4d1ae7e93370300-1498757635-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vts00.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>X-Rays Can Be Bad For Your Virus's Health</h1><p><a href="/lib/?lang=en&amp;author=The%20Sorcerer"> The Sorcerer</a><br/> <em><a href="/vx.php?fid=1512#f1512">Ready Rangers Liberation Front [7]</a></em><br/> <em>July 2006</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vts00.html';</script>[<a style="" href="/lib/?lang=EN&amp;index=CR#vts00">Back to index</a>] [<a href="/lib/vts00.html#disqus_thread">Comments</a>]<br/> 
<ul>
<li><a href="#c1">1) Introduction, What are X-Rays?</a></li>
<li><a href="#c2">2) How does X-Ray detection work?</a>
<ul>
<li><a href="#c21">2.1) Simple XOR</a></li>
<li><a href="#c22">2.2) Permuting Keys XOR</a></li>
<li><a href="#c23">2.3) Simple Substitution</a></li>
</ul></li>
<li><a href="#c3">3) How to hide from X-Ray Detection</a></li>
<li><a href="#c4">4) Conclusion</a></li>
</ul>
<h2><a name="c1"></a>1) Introduction, What are X-Rays?</h2>
<p>An old anti-virus (AV) technique that is over looked by most virus writers is X-Ray Detection. X-Ray detection is a simple method for detecting encrypted viruses and works on more than 50% of existing encrypted viruses today. Have you ever wondered why your new polymorphic, entry point obscuring virus is detected by the AV software? The chances are that they have found a X-Ray for your encryption scheme. These methods are called X-Rays because they enable the AV software to see the insides of your virus encryption protection without having to emulate your virus.</p>
<h2><a name="c2"></a>2) How does X-Ray detection work?</h2>
<p>There are many different X-Ray methods but the following three examples should give you a good understanding of how X-Rays exploit the weaknesses in viruses encryption schemes.</p>
<h2><a name="c21"></a>2.1) Simple XOR</h2>
<p>The simple XOR encryption scheme is a very common one used by viruses to hide their contents. The simplest version takes every byte to be encrypt / decrypted and XORs it with a key byte. E.g.</p>
<pre class="source">
Plain Text	: 0A B3 CD 54 
XOR		: AB AB AB AB
Cipher Text	: A1 18 66 FF
</pre>
<p>Now you look at the resulting enciphered code and think ``that is nothing like the original and if I change the key byte each infection then that will be secure.'', but it is not. The X-Ray commonly used for this method is simple but a good example of how X-Rays exploit the poorly thought out virus. To decode this without emulating the virus the AV software takes the first byte of the suspect cipher text and XORs this with expected Plain Text (e.g. 0A ^ A1) which gives the AV software the key used. Then it uses this key to decrypt the rest of the suspected cipher text. The AV software has then deciphered the virus with out using emulation and with out knowing the key at the start.</p>
<h2><a name="c22"></a>2.2) Permuting Keys XOR</h2>
<p>A permuting key XOR is similar to a simple XOR cipher except the key byte is permuted after it has been used to encipher a byte. E.g. if we increment the key after it is used, the amount we increase the key by after each use could change after each infection.</p>
<pre class="source">
Plain Text	: 0A B3 CD 54 
XOR		: AB AC AD AE
Cipher Text	: A1 1F 60 FA
</pre>
<p>Now as the key is not consistent the method used to X-Ray the simple XOR cipher does not work, but it can be modified to work. To X-Ray this example all the AV software has to do is to XOR the first suspected Cipher Text byte with the first plain text byte, which gives it the initial key setting. Then the AV software XORs the second suspect cipher text byte with the second plain text value, subtracting from this value the initial key setting previously discovered gives the AV software the degree of increment after each byte has been enciphered.</p>
<h2><a name="c23"></a>2.3) Simple Substitution</h2>
<p>Substitution cipher is used less often in viruses but here is how an X-Ray can detect a virus hidden by a simple substitution cipher. Substitution ciphers work by replacing bytes with other bytes. E.g.</p>
<pre class="source">
Key:	A->Z
	B->X
	C->Y

Plain Text	: ABCBA
Cipher Text	: ZXYXZ
</pre>
<p>Now the AV could analyze the suspected cipher text to generate the key, this is a little more complex than with the simple XOR. An easier method is to exploit a side effect in the substitution cipher. Each value is consistently changed to the value it is mapped to in the key, the positions of each value does not change. This enables signatures of patterns to be created e.g.</p>
<pre class="source">
Plain Text	: ABCBA
Cipher Text	: ZXYXZ

Position Signature : [[1,5],[2,4],![1,2,3]]
</pre>
<p>The above position signature would detect the plain text from the cipher text. The position signature shown states that positions 1 and 5 should match (Plain Text A's), positions 2 and 4 should match (Plain Text B's) and positions 1, 2 and 3 should not match (Plain Text A, B and C).</p>
<h2><a name="c3"></a>3) How to hide from X-Ray Detection</h2>
<p>So having seen how powerful the X-Ray detection methods can be how can viruses hide from them? The interesting thing to note is that all the X-Ray methods exploit some holes in the viruses encryption methods. In Cryptanalysis terms the viruses encryption methods susceptible to X-Ray attacks are all broken when used with known plain text attack. So Metamorphism of the code inside the encrypted section of a viruses would help defend it against X-Ray detections as the X-Ray no longer knows what the plain text is.</p>
<p>Substitution Ciphers if used should be polyalphabetic, that is to say they should not use one key but cycle through a set of keys. Also the order the sets of keys are used in should change between infections. Transpositional ciphers should be considered as well to increase the strength of the substitution cipher. A transpositional cipher is one where the positions of values are swapped, e.g.</p>
<pre class="source">
Plain Text:	ABCDEF 
Key:		1&lt;->2
		4&lt;->3
		5&lt;->6
Cipher Text:	BADCFE
</pre>
<p>Better pseudo random number generators (PRNG) will also help improve the strength of the encryption methods in use. Instead of increasing the value of the key by a constant amount using a good PRNG will stop the key increment being predicted.</p>
<p>Combination of ciphers can also improve the security of the cipher. It is always worth considering what can be done in one pass and what will need multiple passes. A substitution cipher and an XOR cipher can be combined in a single pass while a transpositional cipher and an XOR cipher will need a second pass.</p>
<p>Multiple rounds of encryption can also improve the strength of the encryption. Instead of using a polyalphabetical substitution cipher with a transpositional cipher once, use then many times. Generally the more rounds used the stronger the encryption.</p>
<p>Finally the key stored in the virus should not be too distinct, otherwise the AV software may be able to find the key rather than have to guess. E.G. for the simple substitution cipher the stored key will consist of block of 256 bytes and each value between 0 and 255 will only appear once in the block. This is very distinct and as such will is not hard to find.</p>
<h2><a name="c4"></a>4) Conclusion</h2>
<p>Improving the encryption routine makes it harder for AV software to detect a virus. Weak encryption schemes should not be used. Time spent on improving a viruses encryption scheme will help the virus survive longer. Don't forget though that emulation is the AV software's next step, but an encryption routine that has many rounds can help against that as well (How long will it emulate a program to find a virus).</p>
<div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vts00">de</a><a href="/lib/index.php?lang=en&amp;id=vts00">en</a><a href="/lib/index.php?lang=es&amp;id=vts00">es</a><a href="/lib/index.php?lang=it&amp;id=vts00">it</a><a href="/lib/index.php?lang=fr&amp;id=vts00">fr</a><a href="/lib/index.php?lang=pl&amp;id=vts00">pl</a><a href="/lib/index.php?lang=ru&amp;id=vts00">ru</a><a href="/lib/index.php?lang=ua&amp;id=vts00">ua</a></div>
</body>
</html>
