<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Peter Ferrie 'Un combate con el Ker&ntilde;ado' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Peter Ferrie"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Ferrie, Peter,Un combate con el Ker&amp;ntilde;ado, payload, point, processes, file, variants, files, unused, space, virus, infect, search, process, entry, examined, windows"/>
<meta name="Description" content="W32/Elkern could be considered the `little brother' of W32/Klez. Even though Klez carries the Elkern virus and runs it on the machines that Klez infects, it is Klez that has received all the attention. Little mention is ever made of Elkern, and some of the details of its behaviour have remained unexplained. They are described here.There are three variants of Elkern. The first, which is 3326 bytes long, is carried by Klez variants A to D, F and G; the second Elkern variant, which is 3587 bytes long, is carried by Klez.E, and the third, which is 4926 bytes long, is carried by Klez variants H to L."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"4fb34fba53de350360455065aa125139419c187b-1498757345-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/apf16.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Un combate con el Ker&ntilde;ado</h1><p><a href="/lib/?lang=en&amp;author=Ferrie%2C%20Peter">Peter Ferrie</a><br/> <em>Virus Bulletin, August 2002, pp.8-9</em><br/> <em>ISSN 0956-9979</em><br/> <em>August 2002</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/apf16.html';</script><div class="ci"><a href="/lib/?ci=apf16">1</a></div><img src="/img/pdf.gif" alt="PDF"/><a href="/lib/pdf/Un%20combate%20con%20el%20Ker%C3%B1ado.pdf">Download</a> PDF (40.69Kb) (You need to be registered on <a href="/forum">forum</a>)<br/>[<a style="" href="/lib/?lang=EN&amp;index=AN#apf16">Back to index</a>] [<a href="/lib/apf16.html#disqus_thread">Comments</a>]<br/> <form method="post" action=""><input type="hidden" name="pages" value="1"/><input type="submit" value="Turn on page numbers"/></form>
<address>
Peter Ferrie<br/>
Symantec Security Response, Australia
</address>
<p>W32/Elkern could be considered the `little brother' of W32/Klez. Even though Klez carries the Elkern virus and runs it on the machines that Klez infects, it is Klez that has received all the attention. Little mention is ever made of Elkern, and some of the details of its behaviour have remained unexplained. They are described here.</p>
<p>There are three variants of Elkern. The first, which is 3326 bytes long, is carried by Klez variants A to D, F and G; the second Elkern variant, which is 3587 bytes long, is carried by Klez.E, and the third, which is 4926 bytes long, is carried by Klez variants H to L.</p>
<h2>Elkern.3326 and Elkern.3587</h2>
<p>Both Elkern.3326 and Elkern.3587 can exist in two formats: as a DLL or as an executable file. When the viral code gains control for the first time, if it is loaded as an executable file, it will always run, but if it is loaded as a DLL the viral code will run only during the DLL_PROCESS_ATTACH event.</p>
<h2>Windows N(o)T</h2>
<p>If the code is run, Elkern will search memory for kernel32.dll and get the addresses of the APIs that it requires. The first major bug in the virus occurs here: the API names are converted to a 32-bit CRC value, but Elkern compares only the lower 16 bits of this value. This results in the retrieval of the wrong API addresses under <em>Windows</em> NT, where several of the calculated values differ only in the upper 16 bits.</p>
<p>This mistake has been made repeatedly by virus authors, including the author of W32/Kriz, and is likely to continue as the majority of computer users (including virus authors) skip <em>Windows NT</em> in favour of <em>Windows 2000</em> and <em>XP</em>.</p>
<p>If a debugger seems to be running, Elkern will stop running at this time.</p>
<h2>Must Run, Back Soon</h2>
<p>If Elkern was not loaded as a DLL, it will copy itself to %system% and alter the Registry. Under <em>Windows 9x/ME</em>, the filename will be `wqk.exe' and the Registry entry `HKLM\Software\Microsoft\Windows\CurrentVersion\Run' will contain a value called `WQK', which points to %system%\wqk.exe.</p>
<p>Elkern will also call the RegisterServiceProcess() API, if it exists, in order to remove the Elkern process from the task list. Under <em>Windows 2000/XP</em>, the filename will be `wqk.dll' and the Registry entry `HKLM\Software\Microsoft\WindowsNT\CurrentVersion\Windows' will contain the value `AppInit_DLLs', pointing to `wqk.dll'. Any previous data for this value are lost.</p>
<p>The AppInit_DLLs is an interesting value. It exists in <em>Windows NT/2000/XP</em>, and the files in the value data are loaded into the process memory of all processes that run after the Registry change has been made.</p>
<p>Furthermore, if the computer is rebooted, these files will load into critical system processes, such as Winlogon. This poses a problem for anti-virus software that terminates processes containing viral code: terminating the Winlogon process will cause <em>Windows</em> to display the dreaded blue screen of death.</p>
<p>Elkern calls the routine repeatedly to copy the file and alter the Registry, at random intervals from one to seven seconds, requiring much speed (or luck) in order to disable it successfully.</p>
<h2>What are my Chances?</h2>
<p>At this point, Elkern enters the loop that searches repeatedly for files to infect. Before each location is searched, Elkern will check whether the payload should activate. The payload will always activate on 13 March and 13 September, but there is a small chance that the payload will be activated regardless of the date.</p>
<p>Though small in isolation, the chance of payload activation is increased greatly by the repeated checking process.</p>
<p>Elkern begins searching for files to infect in %system% and in the current directory. Next it will search on drive letters, beginning with a random letter and continuing until it reaches Z, before resuming from A. Under <em>Windows 2000/XP</em>, or if the WQK file was the one that launched this code, Elkern will also enumerate open shares on the local network to find files to infect.</p>
<h2>Fuel Injection</h2>
<p>During the file search, Elkern will open every file, regardless of extension. If the payload has been activated, Elkern will overwrite the entire file with zeros. If the payload has not been activated, Elkern will examine the file for its potential to be infected. Files will be infected if they are at least 8 KB PE files and are neither WinZip self-extractors nor DLLs.</p>
<p>Elkern.3587 also avoids RAR self-extractors, and files protected by the System File Protection. The infection method is very similar to that used by W95/CIH. The viral
 
code is split into a linked list of blocks that are placed in the unused space at the end of sections in the file.</p>
<p>Since Elkern is so large, it will increase the size of the last section if there is insufficient unused space available elsewhere in the file. The entry point is altered to point directly to the Elkern code. Elkern.3587 will recalculate the checksum if one existed before.</p>
<h2>Elkern.4926</h2>
<p>If the previous Elkerns were a brick wall, then Elkern.4926 would be a rock wall constructed without mortar. It looks like a hurried work, unfinished and fatally buggy. It exists only as an executable file infector. It contains some of the same bugs that exist in the previous Elkerns (for example, the 16-bit comparison of the CRC32 value).</p>
<p>Whenever Elkern.4926 is run, it alters its appearance slightly. Elkern has many subroutines that are encrypted individually, and whose keys are altered each time the subroutines are used.</p>
<p>Additionally, Elkern has several routines for altering the code of several other routines, however these alterations are limited to register replacement and alternative encodings of some instructions.</p>
<h2>Dude, where's my Code?</h2>
<p>Elkern.4926 will inject its code into the memory of certain processes. If the process enumeration functions are found, Elkern will open all processes under <em>Windows 2000/XP</em>, and any process whose name contains `\explorer' under <em>Windows 9x/ME</em>.</p>
<p>If the enumeration functions are not found, Elkern will attempt to open any accessible process, by cycling through 20,000 different process IDs. Once Elkern has opened a process, it will read from a fixed image base value of 0x400000. This is unusual behaviour because the true image base of a process can be retrieved using the enumeration functions.</p>
<p>Elkern will then search the import table of the process for a reference to `user'. If this is found, Elkern will search a random number (0-63) of imports for either the DispatchMessageA function or the DispatchMessageW function.</p>
<p>Regardless of the success of the search, Elkern will hook an import. If the search was successful, Elkern will hook the last import that was examined; otherwise, it will hook the second last import that was examined. This routine is executed repeatedly, with a small delay between each run.</p>
<p>Elkern begins searching for files to infect in the current directory. Then it searches on drive letters, beginning with a random letter and continuing until Z is reached, before resuming from A. It will also enumerate open shares on the local network to find files to infect.</p>
<p>The file search will skip directories that contain `rary Inter' or `tem32\dllcac'. A misfeature of the name comparison algorithm is that files and directories are also skipped if they begin with certain characters, such as the letter `n'.</p>
<p>Additionally, files are skipped if they begin with any of the following: _avp, aler, amon, anti, nod3, npss, nres, nsch, n32s, avwi, scan, f-st, f-pr, avp, nav.</p>
<p>Considering the number of names in this list that begin with `n', it appears that the virus author is unaware of the comparison bug. Files will be examined if their suffix is .exe or .scr, but there is a small chance that files with other extensions will be examined too.</p>
<p>Elkern considers a file to be infectable if it is a PE GUI or console application that is not a DLL, does not contain the text `irus', is not protected by the System File Checker that is present in <em>Windows 98/ME/2000/XP</em>, and is neither a WinZip nor RAR self-extractor.</p>
<p>There is also a process to check whether the file is already infected but, due to a bug in the virus, this check always fails. The result is that files are reinfected repeatedly, eventually becoming too large to execute.</p>
<p>The file infection procedure for Elkern.4926 is identical to that of the previous variants: the viral code is split into a linked list of blocks that are placed in the unused space at the end of sections in the file, and the size of the last section will be increased if there is insufficient unused space available elsewhere in the file.</p>
<p>If the file contains relocations near the entry point, the entry point will be altered to point directly to the Elkern code. Otherwise, Elkern will place a jump at the original entry point that will point to the Elkern code. If the host contained a checksum, Elkern will recalculate it now.</p>
<h2>Conclusion</h2>
<p>W32/Elkern shows how even a buggy virus can become widespread, by being associated with a virus that is even more prolific.</p>
<p>Fortunately, Elkern does not stand well on its own. For the moment, at least, this battle is half over.</p>
<table summary="W32/Elkern">
<tr><th colspan="2">W32/Elkern</th></tr>
<tr><th>Type:</th><td>Memory-resident parasitic appender/inserter.</td></tr>
<tr><th>Infects:</th><td>Windows Portable Executable files.</td></tr>
<tr><th>Payload:</th><td>Elkern.3326, and .3587 overwrite all files on 13 March and 13 September. Elkern.4926 has no payload.</td></tr>
<tr><th>Removal:</th><td>Delete infected files and restore them from backup.</td></tr>
</table>
 
[<a style="" href="/lib/?lang=EN&amp;index=AN#apf16">Back to index</a>] [<a href="/lib/apf16.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=apf16">de</a><a href="/lib/index.php?lang=en&amp;id=apf16">en</a><a href="/lib/index.php?lang=es&amp;id=apf16">es</a><a href="/lib/index.php?lang=it&amp;id=apf16">it</a><a href="/lib/index.php?lang=fr&amp;id=apf16">fr</a><a href="/lib/index.php?lang=pl&amp;id=apf16">pl</a><a href="/lib/index.php?lang=ru&amp;id=apf16">ru</a><a href="/lib/index.php?lang=ua&amp;id=apf16">ua</a></div>
</body>
</html>
