<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Igor Dikshev 'Некоторые мысли о недетектируемости и неизлечимости' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Igor Dikshev"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Dikshev, Igor,Некоторые мысли о недетектируемости и неизлечимости, жертвы, способ, файла, word, секцию, команд, вирусов, данных, таблицы, значения, сигнатуры, файл, ожидания, условие, невозможность"/>
<meta name="Description" content="Статья не претендует на полноту исследований. Здесь проведён лишь анализ явных ограничений систем антивирусной безопасности и даны общие рекомендации по их использованию для сокрытия вирусной активности."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"11047e2b85d0b90fd4807f03f83ae8f6a46ade24-1498757990-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vid00.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Некоторые мысли о недетектируемости и неизлечимости</h1><p><a href="/lib/?lang=ru&amp;author=Dikshev%2C%20Igor">Igor Dikshev</a><br/> <em>Март 2003</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vid00.html';</script>[<a style="" href="/lib/?lang=RU&amp;index=VT#vid00">Вернуться к списку</a>] [<a href="/lib/vid00.html#disqus_thread">Комментарии</a>]<br/> 
<ol>
<li><a href="#p1">Проверка целостности файла по контрольным суммам</a></li>
<li><a href="#p2">Сигнатурный поиск</a></li>
<li><a href="#p3">Логический поиск</a></li>
<li><a href="#p4">Слежение за поведением процесса</a></li>
<li><a href="#p5">Вывод</a></li>
</ol>
<p>Статья не претендует на полноту исследований. Здесь проведён лишь анализ явных ограничений систем антивирусной безопасности и даны общие рекомендации по их использованию для сокрытия вирусной активности. Особое внимание рекомендуется обратить на новую трактовку технологии симбиоза вируса и жертвы. Следует также учитывать, что комплексный подход гарантирует как увеличение антивирусной безопасности, так и увеличение сложности детектирования вирусов.</p>
<p>В общем и целом антивирусные алгоритмы, используемые для детектирования компьютерных вирусов, можно разделить на четыре категории:</p>
<ol>
<li>Проверка целостности файла по контрольным суммам </li>
<li>Сигнатурный поиск </li>
<li>Логический поиск </li>
<li>Слежение за поведением процесса </li>
</ol>
<a name="p1"></a><h2>1. Проверка целостности файла по контрольным суммам</h2>
<p>Реализацию этого алгоритма можно найти как в очень старых антивирусах, так и в антивирусах современности. Метод давно известный и очень надёжный с точки зрения обнаружения вирусной активности. Однако он имеет как свои плюсы так и свои минусы как с точки зрения вирусологов так и с точки зрения вирмейкеров. Рассмотрим их подробнее.</p>
<p>Очень простая реализация антивирусного алгоритма: обход дерева каталогов, получение контрольной суммы файлов, сравнение контрольных сумм с эталонами в специальных таблицах, создание эталонов для новых файлов, анализ произведённых на диске изменений.</p>
<p>Высокая степень детектирования вирусной активности. Даже в тех случаях, когда вирусы не изменяют размеров жертвы, они "засвечиваются" на изменениях контрольных сумм. В случаях, когда вирусы производят схожие изменения (одинаковое приращение длины, одинаковые байты в определённых местах файлов, ...) можно с высокой степенью вероятности констатировать факт вирусной атаки.</p>
<p>Слабыми местами являются сразу несколько пунктов:</p>
<ul>
<li>уязвимость таблиц перед несанкционированными изменением / удалением</li>
<li>стелсирование вируса на более высоком порядке, чем работа антивируса</li>
<li>невозможность различить количество активных вирусов</li>
<li>невозможность дать определение активному вирусу</li>
<li>очень низкая вероятность автоматического излечение с помощью Cure Module</li>
<li>длительное время сканирования (неудобства для пользователя)</li>
<li>ограничение типа охраняемых объектов</li>
<li>беззащитность данных между проверками</li>
<li>увеличение "параноидальности" антивируса ведёт к увеличению ложных реакций</li>
</ul>
<p>Известны случаи, когда вирусы модифицировали таблицы с контрольными суммами таких антивирусов с тем, чтобы скрыть свою деятельность на диске. Самым простым решением являлось удаление таблиц с диска. Правда, против этого вирусологи разработали более защищённые таблицы и возможность хранить эти таблицы на сменных носителях информации. В принципе, при определённых обстоятельствах, этот способ обмана антивируса можно использовать и сейчас.</p>
<p>Известны случаи, когда антивирус контролировал файлы средствами MS DOS, а вирус "подавал" ему нужную информацию, захватив Int 13h. Кроме того, вирусы могут оставлять специальные "ловушки" в памяти таким образом, что когда антивирус пытается найти оригинальные процедуры обработки прерываний, его действия приводят к краху системы. Этот способ действителен и сейчас.</p>
<p>Алгоритм позволяет лишь констатировать факт изменений на диске, но не даёт ответа на вопрос: кто или что привело к этим изменениям: вирус, вирусы или сбой на диске. И если вирус, то какого типа. Это слабое место можно использовать очень даже эффективно. В жизни такой способ используется выбросом ложных целей авиацией для защиты от ракет следующих на тепло. Так вот, если вирус производит на диске огромное количество "ложных" изменений, например дописывает к огромному количеству неинфицированных файлов на диске одинаковое количество одинаковых байт, то антивирус захлебнётся в потоке сообщений пользователю и настоящая атака имеет большой шанс остаться незамеченной.</p>
<p>Излечение файлов в автоматическом режиме возможно лишь при несущественных изменениях в файле. В принципе, в некоторых антивирусах существует возможность произвольно увеличивать хранимую информацию о файле с тем, чтобы повысить вероятность восстановления. Но это обычно приводит к неоправданному увеличению времени сканирования и дополнительному увеличению таблиц с эталонами. Гораздо проще становится делать архивные копии файлов, например на лазерных дисках. Однако такой способ не даёт гарантии того, что в архивной копии вирус отсутствует. Поэтому достаточно легко можно защититься от лечащих модулей простым криптованием основного тела файла.</p>
<p>В настоящее время накопители на жестких дисках имеют весьма внушительные объёмы. Даже одноразовое сканирование всего объёма информации может занять очень продолжительное время. Конечно, современные операционные системы являются многозадачными, но при однопроцессорной системе каждый процесс начинает занимать время, тем самым ощутимо замедляя работу остальных процессов. Поэтому даже работа таких антивирусов в фоне может раздражать пользователя. Можно отслеживать запуски таких антивирусов и "помогать" им замедлять систему. Таким образом можно бороться с ненавистными антивирусами руками самого пользователя.</p>
<p>Защита по контрольным суммам не применима к документам, которые могут изменяться пользователем многократно в течении дня, как например, документы MS Word. Также эти алгоритмы вряд ли защитят пользователей от интернет-червей или действий "троянских коней". Гарантией неудаляемости с диска будет либо многоплатформенность, либо простой "закос" под многоплатформенность. Например, кроме обычного заражения системы, вирус может создать свою зашифрованную копию в виде файла FILENAME.ZIP или FILENAME.DOC (о том, как можно подделать заголовок у исполняемого файла читайте в журнале MooN BuG) и поставить вызов такого файла через системный реестр в автозагрузку.</p>
<p>Ну и как всегда остаётся банальная возможность "хака" антивируса. То есть, изменить его алгоритм таким образом, что он перестанет информировать пользователя об изменениях и молча будет обновлять свои таблицы. Нет больших проблем и в том, чтобы обойти механизм самоконтроля антивируса. Вирусологи говорят, что это сомнительный способ, ибо на службе у пользователей находится огромное количество различных версий одного и того же антивируса и все они отличаются как смещением так и набором "горячих" байт. На самом деле это пустяки. Автор (авторы) вируса могут хранить данные для идентификации версии и для хака каждой версии где-нибудь на просторах Internet. Вирусу достаточно будет лишь обратиться на сайт или на FTP для получения всех инструкций по модификации антивируса. И до сих пор нельзя исключать возможность получения нужной вирусу информации через FTN-сети, типа FIDO.</p>
<p>Отсюда вывод: данные типы антивирусов морально устарели, так как в наше время очень редко люди обмениваются исполняемыми программами, но зато активно обмениваются электронной почтой и документами различного рода, содержащих макрокоманды.</p>
<p>Конечно, совсем списывать со счетов ревизоры и инспекторы нельзя. Они помогают локализовать опасность от вновь инсталлируемых программ и действий троянских компонент. Кроме того, доступ к изменению / удалению таблиц может контролироваться с помощью резидентных антивирусов-сторожей или самой операционной системы. И хотя таблицы современных антивирусов занимают весьма значительные размеры, что затрудняет их хранение на съёмных носителях информации, при комплексном подходе к антивирусной безопасности они являются довольно защищёнными.</p>
<p>Однако разработчики вирусов могут пойти другим путём. От банального удаления самого антивируса с диска, до использования возможностей операционной системы для внесения помех в работу антивируса вплоть до закрытия антивирусного процесса в памяти. И скорее всего это будет отнесено пользователем не на действие вируса (разве что самыми параноидальными пользователями), а на ошибки в антивирусе или несовместимости установленного программного обеспечения или железа с антивирусом (что чаще всего и бывает на самом деле).</p>
<a name="p2"></a><h2>2. Сигнатурный поиск</h2>
<p>Сигнатурный поиск присущ как антивирусам-полифагам, так и антивирусам-сканерам. Разница между ними состоит в том, что первые ищут и лечат известные им вирусы, а вторые пытаются найти любые конструкции, присущие файловым вирусам. И те и другие используют в своей работе сигнатуры - цепочки команд, присущих вирусам или троянским компонентам. Обычно в полифаги встраивают и сканеры в виде так называемых эвристических анализаторов.</p>
<p>В простейшем виде реализация такого алгоритма не представляет больших трудностей: поиск файла, поиск первого байта сигнатуры в файле, сравнение найденного по первому байту блока файла с сигнатурой, констатация факта присутствия сигнатуры, продолжение поиска. В итоге полифаг может найти известный ему вирус и по возможности излечить файл. Сканер, в свою очередь, может найти набор сигнатур и по ним определить тип и характер вируса.</p>
<p>К "эвристическим" сигнатурам можно отнести:</p>
<ul>
<li>поиск файлов по маске "*.COM", "*.EXE", ...</li>
<li>получение атрибутов файла</li>
<li>получение времени последней модификации файла</li>
<li>открытие файла на чтение/запись</li>
<li>чтение из файла</li>
<li>запись в файл</li>
<li>закрытие файла</li>
<li>восстановление времени последней модификации файла</li>
<li>восстановление атрибутов файла</li>
<li>запрос на оставление части программы резидентно в памяти</li>
<li>запись в системные области операционной системы</li>
</ul>
<p>По количеству и весовым категориям встретившихся в файле сигнатур можно судить о вероятности обнаружения вируса. Полифаги для дополнительной уверенности обычно ещё используют подсчёт контрольной суммы характерного для вируса участка постоянных байт. В случае простейших зашифрованных вирусов сначала используются процедуры их дешифрации в памяти. В более сложных случаях, когда шифровка тела вируса достигается разбавлением команд вируса "мусором", используются процедуры поиска по "плавающей" маске. Также для сканеров характерен поиск не конкретной сигнатуры, а наиболее похожей на заданную. Приведу несколько алгоритмов, использованных в одной из версий антивируса DOG, для поиска сигнатур в файлах.</p>
<p><a href="files/vid/tsearch.pas">Download tsearch.pas (14k)</a></p>
<p><a href="files/vid/tsearch.doc">Download tsearch.doc (1k)</a></p>
<p>Степень детектирования как конкретного вируса так и его штаммов очень высока. Также высока вероятность нахождения в файле ранее неизвестных вирусов. Данный алгоритм имеет приемлемую скорость работы, а при хорошем логическом подходе скорость работы может быть существенно оптимизирована. Кроме того, данный подход позволяет пользователю настраивать уровень "параноидальности" антивируса: при высшем уровнем ищутся и все сигнатуры известных вирусов и все эвристические сигнатуры с минимально допустимым уровнем совпадений (наименьшая скорость - наилучший результат), при низшем уровне ищутся только сигнатуры наиболее распространённых вирусов и не делается эвристического анализа (наивысшая скорость - наихудший результат). Обычные настройки антивируса располагаются между этими двумя уровнями в зависимости от пожеланий пользователя. Такой подход позволяет сделать контроль файлов на диске не привязанным к времени и тестировать дополнительно вновь прибывшие на диск файлы. В совокупности с проверкой целостности файлов по контрольным суммам можно сделать лишь выборочное сканирование и тем самым устранить некоторые недостатки антивирусов класса ревизора диска.</p>
<p>Также сигнатурный подход имеет одно весьма значительное качество с точки зрения оперативности антивирусной защиты: новые сигнатуры и данные о лечении вновь найденных вирусов могут быть подключены к антивирусу "на лету". Из-за малого объема такой информации, она может быть оперативно передана пользователю различными способами от Internet до телефонного разговора. Однако этот плюс является и одной из уязвимостей антивируса. Известны случаи, когда по информационным каналам распространялись ложные дополнения, содержащие троянские алгоритмы. Кроме того, вирус может "подсунуть" антивирусу такое ложное дополнение, что антивирус начнёт видеть вирусы там, где их нет. А лечение по информации из ложного дополнения может и вовсе привести к плачевным последствиям.</p>
<p>Слабыми местами такого подхода являются:</p>
<ul>
<li>значительное усложнение алгоритма поиска сигнатур при незначительных попытках усложнить алгоритм шифрации вируса</li>
<li>огромные сложности применения сигнатурного поиска для полиморфных вирусов</li>
<li>деактивация резидентных вирусов перед сканированием</li>
<li>ограничение типа излечиваемых объектов</li>
<li>беззащитность данных между проверками</li>
<li>увеличение "параноидальности" антивируса ведёт к увеличению ложных реакций</li>
</ul>
<p>Такие простые приёмы в вирусах, как перемешивание (обмен местами) команд или блоков команд, приводит к значительному усложнению алгоритмов сигнатурного поиска. Если вирус шифрует основное тело статическим алгоритмом и выбирает (или генерирует) незашифрованную часть (расшифровщик), то для его детектирования и лечения необходимо пошаговое выполнение команд. Последнее достигается либо трассировкой кода, либо эмулированием. Трассировка является весьма ненадёжным способом, а разработка эмулятора процессора, памяти, файловой системы и железа - весьма нетривиальное занятие. В случае вирусов, которые не шифруют, а полностью генерируют своё тело (ACG, VCG), необходимо разрабатывать специальные алгоритмы, которые могут решать "обратные" задачи: переставлять команды вируса или заменять его блоки команд на некие стандартные команды, то есть приводить тело вируса к некоему "стандартному" вирусу в рабочем состоянии. //К стати очень интересная вещь: антивирус начинает генерировать в своём виртуальном пространстве рабочие штаммы полиморфных вирусов//. Таким образом, если вирус применяет элементарные системы собственной безопасности (не говоря уже о нетривиальных алгоритмах), то круг антивирусов, способных его детектировать, значительно сужается.</p>
<p>Активные резидентные вирусы могут инфицировать проверяемые файлы, могут "скрывать" своё присутствие в проверяемых файлах или каким-либо другим образом мешать нормальной работе антивируса. Поэтому антивирус обязан производить проверку памяти и делать всё возможное для нейтрализации резидентных программ на время своей работы. Это успешно достигается в случае, если вирус висит на одном прерывании и контролирует две-три функции этого прерывания. Но если вирус контролирует большую часть функций BIOS и DOS, то его детектирование в памяти и нейтрализация становится также весьма нетривиальной задачей. Ну а если вирус работает в защищённом режиме, то эта процедура становится почти безнадёжной.</p>
<p>И если худо-бедно сигнатурный поиск возможно применить ко всем потенциально опасным объектам на диске, то для лечения необходимо не только знать вирус, но и хорошо разбираться в формате объекта, который необходимо излечить. Это становится почти непреодолимым препятствием на пути универсальности антивируса-полифага. Поэтому антивирусные компании выпускают дополнительные модули защиты для тех или иных сред: MS Word, MS Outlook, ...</p>
<p>С форматами файлов есть также ещё одна тонкость. Для ускорения работы антивируса приходится "отключать" ненужные сигнатуры. Например, нет большого смысла искать макровирусы в COM-файлах, а загрузочные вирусы в XLS-файлах. Поэтому антивирусы проверяют формат файла, а уж потом собирают в поток только характерные для данного типа файлов сигнатуры. Этим можно легко воспользоваться, если эмитировать в исполняемом файле формат неисполняемого в данной среде файла. Примеры тому приведены в журнале MooN BuG.</p>
<p>Как и в предыдущем случае, поиск вирусов нерезидентным антивирусом не обеспечивает защиты данных между проверками. За это время вирус может успеть не только разгуляться на атакованном компьютере, но и уйти далеко за его пределы.</p>
<p>Бороться с антивирусами такого типа можно также руками самого пользователя. Для этого достаточно дописывать к файлам "горячие" сигнатуры или просто разбрасывать по диску небольшие файлы-сигнатуры. В эти файлы-сигнатуры можно вставлять сигнатуры известных антивирусу вирусов. Так, например, в случае использования пользователем антивируса ANTI-KOT достаточно было дописывать в конец каждого исполняемого файла известные пять байт. После этого антивирус не давал покоя пользователю сообщениями о нахождении вируса.</p>
<p>Ну и как всегда остаётся банальная возможность "хака" антивируса. То есть, изменить его алгоритм таким образом, что он перестанет сам видеть вирусы и информировать пользователя о найденных вирусах. Нет больших проблем и в том, чтобы обойти механизм самоконтроля антивируса. О моих мыслях по поводу огромного количества различных версий популярных антивирусов я уже говорил ранее.</p>
<p>Отсюда вывод: развитие вирусных технологий очень сильно усложняет применение сигнатурного поиска. Новые же вирусные технологии могут на некоторое время сделать совсем неприменимыми существующие антивирусные технологии и потребовать значительных затрат на их доработку.</p>
<p>Основным критерием для борьбы с такими антивирусами должно быть стремление разработчика вируса к отсутствию сигнатуры и максимальному усложнению возможности перетасовки вирусных команд таким образом, чтобы получилась некоторая "стандартная" версия вируса.</p>
<a name="p3"></a><h2>3. Логический поиск</h2>
<p>Этот алгоритм используется в современных антивирусах-полифагах. Суть его заключается в том, что производится символическое исполнение исследуемого файла с помощью эмулятора команд и отслеживаются не сигнатуры, а состояния виртуальной машины. Например, обнуление регистра AX вирусом может быть выполнен целым рядом команд и комбинаций:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">Mov</span> <span style="color: #46aa03; font-weight: bold;">AX</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">Sub</span> A<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">AX</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">Xor</span> <span style="color: #46aa03; font-weight: bold;">AX</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">AX</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">Mov</span> <span style="color: #46aa03; font-weight: bold;">BX</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span> <span style="color: #339933;">/</span> <span style="color: #00007f; font-weight: bold;">XCHG</span> <span style="color: #46aa03; font-weight: bold;">BX</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">AX</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">Xor</span> <span style="color: #46aa03; font-weight: bold;">BX</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">BX</span> <span style="color: #339933;">/</span> <span style="color: #00007f; font-weight: bold;">PUSH</span> <span style="color: #46aa03; font-weight: bold;">BX</span> <span style="color: #339933;">/</span> <span style="color: #00007f; font-weight: bold;">POP</span> <span style="color: #46aa03; font-weight: bold;">AX</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">Mov</span> <span style="color: #46aa03; font-weight: bold;">BX</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">AX</span> <span style="color: #339933;">/</span> <span style="color: #00007f; font-weight: bold;">XOR</span> <span style="color: #46aa03; font-weight: bold;">AX</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">BX</span><br/>
&nbsp;</div>
<p>Антивирусу нет большого смысла анализировать все возможные комбинации команд, его больше интересует результат - обнуление значения в определённом регистре. Поэтому антивирус лишь следит за происходящими изменениями в виртуальной машине при эмулировании кода. И по этим изменениям он делает соответствующие выводы. Так можно отследить как характерные действия известных вирусов, так и действия супер-полиморфных неизвестных ранее вирусов.</p>
<p>Реализация такого алгоритма может быть как очень простой (минимальная информативность результата) так и очень сложной, в виде нейросети (наибольшая информативность результата). Подход имеет высокую степень детектирования вирусов и троянских компонент. Этот подход может быть применён и к червям в реальном режиме времени.</p>
<p>Слабыми местами являются следующие пункты:</p>
<ul>
<li>невозможность анализа не вызванного кода</li>
<li>невозможность отделить действия программы от действий вируса</li>
</ul>
<p>Известны вирусы, которые вызывают ту или иную свою часть в зависимости от некоторых условий. Например, по средам производится только поиск и инфицирование EXE-файлов, а по пятницам - только COM-файлов. В остальные дни недели вирус не размножается и не вызывает никаких своих процедур. Кроме того, тело вируса может быть зашифровано и расшифровываются только те процедуры, которые нужны для исполнения заданного в среду или в пятницу алгоритма. Не плохо, когда в среду вирус интерпретирует используемый по пятницам код как данные и наоборот. Также вирус может оставаться в статическом виде довольно длительное время, а при определённых условиях полностью перегенерировать свой код используя для этого краткосрочное дешифрование своего полиморфного алгоритма (кодогенератора).</p>
<p>Таким образом, перед антивирусом ставится задача испробовать все возможные условия для того, чтобы управление получили процедуры вируса и уже тогда приступить к исследованиям. Это в принципе не возможно, так как в качестве таких условий может быть присутствие файла определённой длины с определённым началом в определённом месте диска, определённая контрольная сумма некоторых участков памяти, определённый тип процессора, ... И если вирус использует несколько условий, да ещё весьма экзотических, то антивирусу остаётся только привязаться хотя бы к тому куску вируса, который проверяет эти условия.</p>
<p>Допустим, вирус проверяет для своей активации несколько экзотических условий: a, b, c, d, e, f. Проверяет он их следующим образом:</p>
<ul>
<li>1-я генерация вируса: проверяет наступление условия A. Если условие не наступило, то управление возвращается инфицированной программе. Если условие наступило, то расшифровываются процедуры, входящие в состав ветки A алгоритма вируса и производят инфицирование только COM-программ. Перед инфицированием происходит полная генерация всех процедур ветки A и блока ожидания наступления условия A. Но в инфицируемые файлы записывается блок ожидания условия B, а ветка A алгоритма вируса записывается в зашифрованном виде.</li>
<li>2-я генерация вируса: проверяет наступление условия B. Если условие не наступило, то управление возвращается инфицированной программе. Если условие наступило, то расшифровываются процедуры, входящие в состав ветки B алгоритма вируса и производят инфицирование только BAT-программ. Перед инфицированием происходит полная генерация всех процедур ветки B и блока ожидания наступления условия B. Но в инфицируемые файлы записывается блок ожидания условия C, а ветка B алгоритма вируса записывается в зашифрованном виде. </li>
<li>...</li>
</ul>
<p>Подумайте, на сколько нужно усложнить алгоритм антивируса, чтобы он мог исследуя лишь коротенькую процедуру ожидания какого-либо события определить сам вирус? При этом процедура ожидания события должна генерироваться каждый раз таким образом, как генерируется расшифровщик в полиморфных алгоритмах.</p>
<p>Конечно, вирусолог может последовательно исследовать все события и расшифровать все ветки алгоритмов. Это ему даст возможность включить в вирусную базу столько записей, сколько событий используется в вирусе. Причём, всё равно определение вируса по конкретному событию будет весьма нетривиальной задачей.</p>
<p>Ну а если вирус выбирает новые события при инфицировании не последовательно, а случайным образом? Да ещё так, чтобы выбор разных событий имел разную вероятность? Вирусологу могут понадобиться годы, чтобы расшифровать один вирус. Здесь главное чтобы алгоритм шифровки тела вируса был как можно более случайным и не имел каких-либо постоянных ключей.</p>
<p>Пример события: если на диске обнаружена версия архиватора RAR, то задействуется ветка алгоритма C. Процедуры этой ветки алгоритма были ранее зашифрованы с помощью архиватора RAR с неизвестным ключом неизвестной длины до пяти символов. Чтобы расшифровать ветку A нужно расшифровать процедуру A1, зашифрованную по некоторому известному алгоритму, выполняющую следующие действия:</p>
<ul>
<li>запуск указанной программы с указанными статическими параметрами и одним динамическим параметром</li>
<li>формирование случайным образом в определённом диапазоне динамического параметра перед каждым запуском указанной программы</li>
<li>цикл до получение нулевого кода завершения работы указанной программы</li>
</ul>
<p>Кроме того, алгоритмы логического поиска не допускают перенесения части алгоритма работы вируса на отдельную программу. В худшем случае необходимо перегрузить виртуальную машину и исследовать указанную программу (в нашем случае - архиватор RAR). Такой процесс исследования может длиться вечность, так как время работы внешней программы, до возвращение в изначально исследуемую, может быть достаточно длительным, а количество вызовов внешних программ, да ещё и с полной передачей им управления, может быть неограниченным.</p>
<p>Допустим, что ветка алгоритма C представляет вирус в нескольких самостоятельных частях:</p>
<ul>
<li>резидент</li>
<li>процедура подбора пароля</li>
<li>основное тело вируса и жертвы</li>
</ul>
<p>Тогда процедура ожидания события C расщепит вирус на различные составляющие, запустит резидента и передаст управление процедуре подбора пароля с завершением родительского процесса. Процедура подбора пароля "выцепит" из основного тела нужные ей блоки и начнёт их расшифровывать в фоне с помощью архиватора RAR. Задачей резидента будет дождаться наступления события X - завершение процесса процедуры подбора пароля и передача управления на расшифрованную ветку алгоритма C.</p>
<p>И как вы представляете себе всё это эмулировать? А если учесть, что это событие не было изучено вирусологом по той причине, что не наступило событие, которое должно было его активизировать?</p>
<p>Теперь немного о "вкусненьком". Так или иначе, но часть вируса всегда будет получать управление хотя бы для того, чтобы определить наступление заданного события. Как скрыть этот код от посторонних глаз? Я предлагаю использовать технологию симбиоза вируса и жертвы, построенному по следующему принципу:</p>
<ol>
<li>Создаём в программе дополнительную секцию, которую будем использовать в качестве постоянного буфера для данных. Теперь будем различать секцию кода (секцию, в которую мы внедряемся) и секцию данных (созданный нами буфер). Условие: никакой код не должен быть выполнен в секции данных.</li>
<li>Выбираем команду или блок команд необходимой длины из кода жертвы и записываем его в буфер.</li>
<li>В освободившееся место записываем свою команду или блок команд и смещение в буфере оригинальных байт.</li>
<li>Записываем в буфер собственную команду или собственный блок команд.</li>
<li>Определяем в буфере случайным образом места для сохранения значений регистров</li>
<li>Перед каждым нашим блоком в секции кода восстанавливаем значения нужных регистров, а текущие значения сохраняем в секции данных</li>
<li>После каждого блока команд сохраняем значения использованных нами регистров, а текущими делаем ранее сохранённые.</li>
</ol>
<p>Таким образом перемешиваем код нашей процедуры с кодом жертвы. При этом стараемся сделать так, чтобы не было возможности определить к чему (вирусу или жертве) принадлежит данная команда / блок команд. Нам не нужно будет восстанавливать жертву или извлекать эту процедуру, так как она и так имеется в зашифрованном коде вируса. Не плохо, если при перемешивании будут учитываться состояния регистров после блоков жертвы. Это поможет меньше делать чтения/записи их состояний из секции данных и больше сблизить код вируса и жертвы. Допустим, что после выполнения блока жертвы регистры AX и BX будут иметь следующие значения: AX = 3456h, BX = 1234h. При этом нам нужно иметь в регистре AX значение 1234h, а регистр BX данный блок вируса не использует. Тогда делаем просто PUSH AX / MOV AX,BX / ... / POP AX. И не лезем в секцию данных.</p>
<p>Код из секции данных лучше всего подгружать в секцию кода, но не выполнять его в секции данных. Это будет выглядеть для антивируса более реалистичным. Не стоит делать "внедрение" своего кода байт за байтом. Лучше, если между блоками вируса будут выполняться значительные блоки жертвы. Получится, что мы "вмазываем" вирусную процедуру как полиморфные пятна, но выполняться они будут не друг за другом, а вместе с кодом жертвы. Из-за этого приёма антивирус "потеряет бдительность". Это связано с тем, что в зависимости от настроек, антивирус изменяет глубину эмулирования, но он не может полностью эмулировать всю программу даже в наиболее параноидальном режиме.</p>
<p>Сигнатурный поиск для полиморфной процедуры (случайного ряда полиморфных процедур) размазанной по значительному объёму файла и без явных переходов от одного пятна к другому - ничего не даст. Других технологий для обнаружения вирусов подобного класса вирусологи пока ещё не придумали.</p>
<a name="p4"></a><h2>4. Слежение за поведением процесса</h2>
<p>Существуют антивирусы, которые являются поведенческими блокираторами. Назойливые, типа "Программа NC.EXE пытается открыть файл NC.EXT. Разрешить?", уже давно не в моде. Зато в диалоговом режиме пользователь может задать список файлов, при доступе к которым блокиратор вызовет диалоговый режим. К таким файлам могут относиться исполняемые файлы антивирусов, таблицы контрольных сумм, word.exe, excel.exe, delphi.exe, ... Кроме того, в самых запущенных случаях, предложенных Юрием Фоминым для технологии ПРИСТАВ, антивирусы могут "засорять" диск файлами-ловушками и контролировать доступ к этим файлам.</p>
<p>Явный плюс здесь кроется в том, что не нужно следить за всеми процессами в памяти, что делает антивирус более незаметным для пользователя. При грамотной настройке такой способ может оказаться весьма надёжным. Антивирусу не обязательно уметь работать с файлами всех возможных форматов, достаточно лишь определить в каталоге подавляющее большинство файлов с одинаковым форматом и разместить там ловушку (положить свой файл или "захватить" под контроль уже имеющийся с разрешения пользователя).</p>
<p>Кроме того, этот способ позволяет контролировать ситуацию на протяжении всего сеанса работы системы.</p>
<p>Слабыми местами являются:</p>
<ul>
<li>большая засорённость диска ловушками</li>
<li>метод не даёт 100% контроля над файлами</li>
<li>не позволяет идентифицировать причину</li>
</ul>
<p>Здесь можно рекомендовать несколько вариантов. Если антивирус сделает так, чтобы при любом поиске его ловушка была обнаружена первой в каталоге, то можно начинать анализ потенциальной жертвы не с первого найденного файла, а с некоторого, например, с третьего.</p>
<p>Более радикальный метод - "подставить" другую программу. Например, если вы хотите внедрить свой код в документ Word, то следует сначала найти на диске сам word.exe. Запускаем word.exe и передаём ему в командной строке параметр - имя облюбованного нами файла. Если процесс word.exe не стартовал в определённый промежуток времени - то лучше отказаться от инфицирования облюбованного вирусом файла. Если же стартовал, то можно быстренько прибить процесс word.exe. Так как в файл никаких изменений внесено не было, то Word закроется даже не пикнув. В противном случае (в том числе и при реакции антивируса) все претензии будут отнесены на счёт программы word.exe и в случае сильной бдительности пользователя в саппорт антивирусной компании будет направлен девственно чистый код майкрософтовского монстра.</p>
<a name="p5"></a><h2>Вывод</h2>
<p>Только комплексное решение всех возможных "засветок" поможет выжить вашему вирусу в нелёгких условиях тотальной слежки со стороны антивирусных программ. И для этого совсем не обязательно придумывать новые вирусные технологии, достаточно проявить немного смекалки и простое решение непростой задачи гарантировано.</p>
[<a style="" href="/lib/?lang=RU&amp;index=VT#vid00">Вернуться к списку</a>] [<a href="/lib/vid00.html#disqus_thread">Комментарии</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vid00">de</a><a href="/lib/index.php?lang=en&amp;id=vid00">en</a><a href="/lib/index.php?lang=es&amp;id=vid00">es</a><a href="/lib/index.php?lang=it&amp;id=vid00">it</a><a href="/lib/index.php?lang=fr&amp;id=vid00">fr</a><a href="/lib/index.php?lang=pl&amp;id=vid00">pl</a><a href="/lib/index.php?lang=ru&amp;id=vid00">ru</a><a href="/lib/index.php?lang=ua&amp;id=vid00">ua</a></div>
</body>
</html>
