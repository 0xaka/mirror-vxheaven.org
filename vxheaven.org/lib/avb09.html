<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Vesselin Bontchev 'Veni, Vidi, Vicis?' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Vesselin Bontchev"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Bontchev, Vesselin,Veni, Vidi, Vicis?, macro, constant, replaced, anti, global, viruses, lines, wordbasic, bontchev, subroutine, vicis, line, slow, language, number"/>
<meta name="Description" content="Vicis is a polymorphic macro virus... that is the very least that can be said about it-and it is a major understatement. Polymorphism in DOS viruses is usually achieved by encrypting most of the virus body and prepending a randomly generated decryptor to it. The same idea has been tried in the macro virus world as well (e.g., in the Slow virus [Qin97]). However, WordBasic is a slow language, not very suitable for character manipulation, so the encryption/decryption process is always slow-which makes such a virus very noticeable. WordBasic is much more suitable for string manipulation, however. Furthermore, WordBasic is a syntactically simple language. All these properties make it easy to implement a different kind of polymorphism-polymorphism not based on encryption. The basic idea was described by Dr. Fred Cohen several years ago, but this is the first time we see it properly implemented in a computer virus."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"0fc43995db58a6d22d82e1127c29253fec37dff6-1498757400-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/avb09.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Veni, Vidi, Vicis?</h1><p><a href="/lib/?lang=en&amp;author=Bontchev%2C%20Vesselin">Vesselin Bontchev</a><br/> <em>Virus Bulletin, Oct 1997, pp. 10-11</em><br/> <em>ISSN 0956-9979</em><br/> <em>October 1997</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/avb09.html';</script>[<a style="" href="/lib/?lang=EN&amp;index=AN#avb09">Back to index</a>] [<a href="/lib/avb09.html#disqus_thread">Comments</a>]<br/> 
<address>
Dr. Vesselin Bontchev, anti-virus researcher<br/>
FRISK Software International<br/>
Postholf 7180, 127 Reykjavik, ICELAND<br/>
E-mail: <a href="/cdn-cgi/l/email-protection#9ffdf0f1ebfcf7fae9dffcf0f2eff3fae7b1f6ec"><span class="__cf_email__" data-cfemail="83e1ecedf7e0ebe6f5c3e0eceef3efe6fbadeaf0">[email&#160;protected]</span><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script></a>
</address>
<p>As most other anti-virus researchers, we regularly receive virus collections which come not from real infections but either directly from the virus writers or from some of the many virus exchange (VX) sites. In the first case, the author of the virus probably thinks that we, as an anti-virus researcher, are the best person to "appreciate" his new creation. In the second case, it is usually some "helpful soul" who gets the viruses from the VX sites and sends them to us (and probably to a dozen other anti-virus researchers), probably with the feeling that by doing this he is helping us. In both cases, the collections are usually uploaded to our ftp site or sent to us by e-mail. In both cases, the collections contain mostly junk.</p>
<p>This junk consists of corrupted virus samples, programs written with the obvious intention to write a virus but too buggy to work, virus creation tools, text files, programs falsely flagged as infected by some anti-virus product, totally unrelated files and so on ([Bontchev93]). Even when they contain viruses, these viruses are usually known to us. And even when they are not, they are the usual crop of boring, stupid, buggy viruses, often created by modifying slightly some well-known virus. Processing such collections is mostly a waste of time, yet it has to be done; it is (an unpleasant) part of the job of the anti-virus researcher.</p>
<p>Yet occasionally these collections contain something interesting. This was the case with the latest package of macro viruses taken from the virus writing electronic magazine <em>SLAM</em>. This magazine was started by the amazingly inept German virus writer who calls himself <em>The Nightmare Joker</em> and has authored probably more than a dozen rather trivial macro viruses and macro virus construction kits. This time, however, the magazine contained a macro virus obviously written by someone else - somebody with a much more talent in the area of virus writing.</p>
<p>The author obviously calls his virus "<em>Vicissitator</em>"-whatever that is supposed to mean. Such a name looked too long to us; besides we enjoy spoiling part of the fun to the virus writers by naming their viruses with names different from those their authors have selected. Therefore, we decided to name the virus <tt>WordMacro/Vicis.A</tt>, or <tt>WM/Vicis.A</tt> for short.</p>
<p><tt>Vicis</tt> is a polymorphic macro virus... that is the very least that can be said about it-and it is a major understatement. Polymorphism in DOS viruses is usually achieved by encrypting most of the virus body and prepending a randomly generated decryptor to it. The same idea has been tried in the macro virus world as well (e.g., in the <tt>Slow</tt> virus [Qin97]). However, WordBasic is a slow language, not very suitable for character manipulation, so the encryption/decryption process is always slow-which makes such a virus very noticeable. WordBasic is much more suitable for string manipulation, however. Furthermore, WordBasic is a syntactically simple language. All these properties make it easy to implement a different kind of polymorphism-polymorphism not based on encryption. The basic idea was described by Dr. Fred Cohen several years ago, but this is the first time we see it properly implemented in a computer virus.</p>
<p>The <tt>Vicis</tt> virus replicates using the system macros attack ([Bontchev96]). In the infected documents, it consists of a single macro named <tt>FileSave</tt>. When an infected document is opened, edited, and saved via the File/Save command, the virus receives control and copies itself to the global template (<tt>NORMAL.DOT</tt>). It also uses the <tt>ToolsMacro .Edit</tt> command to create a new macro, named <tt>ToolsMacro</tt>, which resides only in the global template (not in the infected documents). The contents of this macro is simply</p>
<div class="vb" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #E56717; font-weight: bold;">Sub</span> MAIN<br/>
<span style="color: black; font-style: italic;">'You have been Infected by the Vicissitator Macro Virus.<br/>
</span><span style="color: black; font-style: italic;">'(C)1997 CyberYoda A Member of the SLAM Virus Team<br/>
</span><span style="color: #8D38C9; font-weight: bold;">End</span> <span style="color: #E56717; font-weight: bold;">Sub</span><br/>
&nbsp;</div>
<p>The purpose of the macro is obviously to disable the Tools/Macro command of Word and to prevent user from inspecting the macros in the documents and, therefore, from discovering the virus. Needless to say, such a form of "stealth" is rather primitive and likely to be noticed quickly. Much more advanced forms of stealth have been developed by the authors of macro viruses ([Bontchev96]). However, the strong point of the <tt>Vicis</tt> virus is not stealth but polymorphism.</p>
<p>Once the virus has infected the global template, each time the user edits and saves a clean document with the File/Save command, the virus will infect it. The virus invokes its polymorphic routine only when replicating from the global template to a document-not when replicating in the opposite direction. If the global template or the document already contains a macro named <tt>FileSave</tt>, the virus considers it to be already infected and does not attempt to infect it.</p>
<p>The main mutation routine of the virus works the following way. The virus marks a random number (between 1 and 10 inclusive) of consecutive lines. Then it checks whether the contents of the marked lines satisfies the following conditions:</p>
<ol>
<li>That no line begins with "<tt>Sub</tt>", "<tt>Dim</tt>", "<tt>End Sub</tt>" or "<tt>On</tt>" and no line ends with a colon ("<tt>:</tt>").</li>
<li>That every "<tt>For</tt>" in the marked area has a matching "<tt>Next</tt>" and that every "<tt>While</tt>" has a matching "<tt>Wend</tt>".</li>
<li>That every "<tt>If</tt>" has a corresponding "<tt>End If</tt>" with optionally an "<tt>Else</tt>" before it.</li>
<li>That there are no orphan "<tt>Else</tt>" operators (from "<tt>If</tt>" operators outside the marked area).</li>
</ol>
<p>If all of the above conditions are satisfied, the marked lines are cut and replaced with a "<tt>Call</tt>" operator to a randomly generated subroutine name. Then the virus pastes the cut lines at the end of its body between a <tt>Sub</tt>/<tt>End Sub</tt> pair which it creates and which uses the same randomly generated operator as the <tt>Call</tt> line that has replaced the cut lines.</p>
<p>After the virus has invoked its main mutation routine, it does the following (the different operations are explained below):</p>
<ol>
<li>With a probability of 25%, the virus "unmutates". That is, the virus looks for a line in its body beginning with a "<tt>Call</tt>", finds the body of the called subroutine (by the identifier after the "<tt>Call</tt>"), copies its body (the lines between the <tt>Sub</tt>/<tt>End Sub</tt> pair), deletes the subroutine (together with the <tt>Sub</tt>/<tt>End Sub</tt> lines), goes to the place where the subroutine is called and replaces the "<tt>Call</tt>" operator with the lines of the subroutine. The general idea behind this is obviously to reverse the main mutation-so that the virus not only fragments its body into subroutines but also occasionally combines the fragments back-thus allowing the larger parts to be split again later into other fragments and therefore keeping its contents more "dynamic". However, this process can easily "unmutate" some of the main subroutines, calls to which are used in the "<tt>Then</tt>" part of "<tt>If</tt>" statements. When this happens, the bodies of these subroutines will replace the "<tt>If</tt>" statements, thus changing the behavior of the virus significantly and possibly preventing it from working correctly. We believe that this is a bug.</li>
<li>With a probability of 25%, the virus picks some random variable from its body and changes all occurrences of that variable to some other, randomly constructed identifier, 2 to 11 characters long and consisting of characters only. The variable is selected as a first word to the left of a "=" sign. This is a rather unreliable way to select it. For instance, it can select the argument of a system command-e.g., the "<tt>.Find</tt>" in "<tt>EditFind .Find = Name2$</tt>". Of course, when this happens, the resulting replicant no longer works, thus again confirming our firm opinion that most virus writers are bad and sloppy programmers who are unable to produce a bug-free virus.</li>
<li>With a probability of 25%, the virus mutates a numeric constant. Only integer constants are mutated and the mutation itself is performed in the following way:
<ol type="a">
<li>With a probability of 25% and if the constant happens to be divisible by a randomly selected number between 1 and 10 inclusive, the constant is replaced with a multiplication which results in the same constant. For instance, the constant "<tt>10</tt>" can be replaced with the expression "<tt>5 * 2</tt>".</li>
<li>With a probability of 25%, the constant is replaced by an expression of division which evaluates to the constant. For instance, the constant "<tt>10</tt>" can be replaced with the expression "<tt>30 / 3</tt>".</li>
<li>With a probability of 25%, the constant is replaced with a subtraction. For instance, the constant "<tt>10</tt>" can be replaced by the expression "<tt>(17 - 7)</tt>".</li>
<li>With a probability of 25%, the constant is replaced with an addition. For instance, the constant "<tt>10</tt>" can be replaced by the expression "<tt>(4 + 6)</tt>".</li>
</ol></li>
</ol>
<p>Only one of the above four replacements can happen during a single replication of the virus. The second operand of the replacement expression is always a randomly generated number between 1 and 10 inclusive.</p>
<ol start="4">
<li>With a probability of 10%, the virus adds a new line to itself. This new, do-nothing line has the form</li>
</ol>
<p><tt>If &lt;identifier1> = &lt;identifier2> Then &lt;identifier3> = &lt;number></tt></p>
<p>where the three identifiers and the number are generated randomly. The line is inserted at the beginning of a randomly selected subroutine of the virus body.</p>
<ol start="5">
<li>With a probability of 0.39%, the virus corrupts itself. This is performed by removing a random number of lines from a random subroutine of the virus. We have no idea why this is done, since it clearly is extremely likely to produce non-working replicants. Nevertheless, it is obviously performed intentionally (i.e., it does not seem to be a programming error-maybe it is a design error), although with a very low probability.</li>
</ol>
<p>Regardless of the convoluted polymorphic mechanism described above, the <tt>Vicis</tt> virus can be detected reliably with a simple scan string-even no wildcards are necessary. This is due to the fact that all replicants of the virus contain reasonably large chunks of constant code-although the location of these chunks is not constant. Furthermore, like all other WordBasic viruses which attempt to be polymorphic, the macros of the <tt>Vicis</tt> virus are not Execute-Only-that is, they are not encrypted even with the trivial encryption algorithm used by Word for this purpose. Therefore, they can be listed and edited freely.</p>
<p>For instance, the following command is always present in all working replicants of the virus:</p>
<pre class="source">MacroCopy "Global:FileSave", "Global:Vicissitator"</pre>
<p>Its binary representation is</p>
<pre class="source">
64 67 C2 80 6A 0F 47 6C 6F 62 61 6C 3A 46 69 6C
65 53 61 76 65 12 6A 13 47 6C 6F 62 61 6C 3A 56
69 63 69 73 73 69 74 61 74 6F 72
</pre>
<p>Like most other polymorphic macro viruses written in WordBasic, the <tt>Vicis.A</tt> virus is too buggy, slow, and obvious when replicating. It, therefore, has no chance of surviving in the wild and becoming widespread. Even should an outbreak of it happen, it is very easy to detect the virus with a simple scan string. The only problems its sophisticated polymorphic mechanism poses are to the anti-virus products which attempt to identify exactly the viruses they detect. Nevertheless, it is worrisome to think what CyberYoda might be able to achieve with Visual Basic for Applications-the macro programming language of Microsoft Word 97. A language which is much faster, more powerful, and more suitable for implementation of polymorphic engines than WordBasic. And, as usual when analyzing a clever virus, we feel pity for the obviously ingenious mind behind it that has been wasted on creating something utterly useless and damaging.</p>
<h2>References</h2>
<ul>
<li>[Bontchev93] Bontchev, V., <em><a href="/lib/avb01.html">Analysis and Maintenance of a Clean Virus Library</a></em>, Proc. 3rd Int. Virus Bull. Conf., 1993, pp. 77-89.</li>
<li>[Bontchev96] Bontchev, V., <em>Possible Macro Virus Attacks and How to Prevent Them</em>, Proc. 6th Int. Virus Bull. Conf., 1996, pp. 97-127.</li>
<li>[Qin97] Dr Cai-Gong Qin, <em>SlovakDictator</em>, Virus Bull., August, 1997, pp. 15-16.</li>
</ul>
[<a style="" href="/lib/?lang=EN&amp;index=AN#avb09">Back to index</a>] [<a href="/lib/avb09.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=avb09">de</a><a href="/lib/index.php?lang=en&amp;id=avb09">en</a><a href="/lib/index.php?lang=es&amp;id=avb09">es</a><a href="/lib/index.php?lang=it&amp;id=avb09">it</a><a href="/lib/index.php?lang=fr&amp;id=avb09">fr</a><a href="/lib/index.php?lang=pl&amp;id=avb09">pl</a><a href="/lib/index.php?lang=ru&amp;id=avb09">ru</a><a href="/lib/index.php?lang=ua&amp;id=avb09">ua</a></div>
<script>/* <![CDATA[ */(function(d,s,a,i,j,r,l,m,t){try{l=d.getElementsByTagName('a');t=d.createElement('textarea');for(i=0;l.length-i;i++){try{a=l[i].href;s=a.indexOf('/cdn-cgi/l/email-protection');m=a.length;if(a&&s>-1&&m>28){j=28+s;s='';if(j<m){r='0x'+a.substr(j,2)|0;for(j+=2;j<m&&a.charAt(j)!='X';j+=2)s+='%'+('0'+('0x'+a.substr(j,2)^r).toString(16)).slice(-2);j++;s=decodeURIComponent(s)+a.substr(j,m-j)}t.innerHTML=s.replace(/</g,'&lt;').replace(/\>/g,'&gt;');l[i].href='mailto:'+t.value}}catch(e){}}}catch(e){}})(document);/* ]]> */</script></body>
</html>
