<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta name="robots" content="noindex"/>
<title> roy g biv 'The Hiew Plugin framework' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="roy g biv"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, roy g biv,Hiew Plugin framework, structure, plugin, extension, plugins, gate, functions, examined, supports, getdata, filename, function, file, called, export, files"/>
<meta name="Description" content="Many people know about Hiew. It is great tool for viewing and editing files. It supports arithmetic operations and has an assembler, so it can be used for all kinds of reverse-engineering, unpacking, decrypting, etc. In case that was not enough functionality, it also supports plugins."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"98e2a73469da89124c4869aa0fdbdbff2ca17d45-1498758152-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/rnd00.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Biblioth&egrave;que</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div><div style="float:right;"><a href="/lib/index.php?tbs=0"><img src="/img/min.gif" alt="Minimize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option selected="selected" value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: left;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="32" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><br clear="both"/></div>
<div class="s2">You've picked <a href="/lib/rnd00.html" style="background-color: #ffffcc; color: black;">random article</a>, here is <a style="background-color: #ccffcc; color: black;" href="/lib/vrg04.html">the actual link</a> to the<br/><h1>The Hiew Plugin framework</h1><p><a href="/lib/?lang=en&amp;author=roy%20g%20biv"> roy g biv</a><br/> <em>September 2009</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vrg04.html';</script>[<a style="" href="/lib/?lang=EN&amp;index=VT#vrg04">Back to index</a>] [<a href="/lib/vrg04.html#disqus_thread">Comments</a>]<br/> 
<h2>What is it?</h2>
<p>Many people know about Hiew. It is great tool for viewing and editing files. It supports arithmetic operations and has an assembler, so it can be used for all kinds of reverse-engineering, unpacking, decrypting, etc. In case that was not enough functionality, it also supports plugins.</p>
<h2>Plugins</h2>
<p>It is amazing, but I never used Hiew before until recently. Immediately, I wondered if a Hiew virus could be possible. There is an API to open the file for writing, so it is possible to infect the file that is being examined.</p>
<p>Hiew Plugins are DLL files with a special extension. The extension to use is "hem". The plugin must contain one export. This export must be called "Hem_Load". The export points to a function. The function receives a pointer to a hiewinfo_tag structure. We use only two fields in the structure. They are the gate and handle fields. The gate field contains the pointer to Hiew functions. The handle field contains the value that identifies the file uniquely. All functions that we call must pass the handle, else the function will fail.</p>
<p>The structure also contains a field that receives a pointer to a heminfo_tag structure. We must set in there the pointer to our heminfo_tag structure. The heminfo_tag structure contains everything about our plugin. It tells the name to display in the plugin list, the mode when the plugin can be called, and the entrypoint for the plugin.</p>
<h2>API</h2>
<p>The Hiew API is easy to use. We create a structure which contains the ID of the function to call, then pass the structure to the gate function. Hiew will change the structure if the function will do that (such as GETDATA), or read or write bytes in the file, etc.</p>
<p>When the plugin entrypoint is called, the file being examined can be accessed. Before then, no API can be called. We can find out about the file being examined by calling the GETDATA function. The GETDATA function fills in a structure that contains the filename and filesize, with some other things. I was interested only in the file size, since I use it for an infection marker, and the filename since I want to check for files protected by SFC.</p>
<p>Since Hiew supports read and write of the file, we have almost everything that we need to infect the file, in very oldskool way. :) There is no file mapping here, no SEH. The only thing that was missing for me was the check for SFC. For that, I needed three functions from kernel32.dll. They are GetProcAddress, LoadLibraryA, and MultiByteToWideChar. Yes, Hiew is complete ASCII internally. It cannot support Unicode, so we must convert the filename ourselves. I used the GETDATA function to get the filename, then convert to Unicode with MultiByteToWideChar, LoadLibraryA(sfc.dll), and GetProcAddress of SfcIsFileProtected. Everything else can be done with Hiew API. The read and write functions accept a structure that contains the file offset, so there is no seek function necessary. Hiew takes care to remove the read-only attribute when the file is opened for write.</p>
<h2>What about stealth?</h2>
<p>An obvious extension to the infection via plugin is to stealth the result. As it is right now, the changes don't show until the file is opened again, but by the time the plugin is loaded, Hiew has loaded the whole file, and I couldn't find a way to load automatically to hide the code. That's for someone else to discover. ;)</p>
<p><a href="http://vx.org.ua/src.php?info=hiewg.zip">W32.Hiewg virus source code</a></p>
<p>Greets to friendly people (A-Z):</p>
<p>Active - Benny - izee - jqwerty - Malum - Obleak - Prototype - Ratter - Ronin - RT Fishel - sars - SPTH - The Gingerbread Man - Ultras - uNdErX - Vallez - Vecna - Whitehead</p>
<div align="right"><em>
rgb/defjam sep 2009<br/>
<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="6e070f03311c090c2e06011a030f0702400d0103">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script>
</em></div>
<div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=rnd00">de</a><a href="/lib/index.php?lang=en&amp;id=rnd00">en</a><a href="/lib/index.php?lang=es&amp;id=rnd00">es</a><a href="/lib/index.php?lang=it&amp;id=rnd00">it</a><a href="/lib/index.php?lang=fr&amp;id=rnd00">fr</a><a href="/lib/index.php?lang=pl&amp;id=rnd00">pl</a><a href="/lib/index.php?lang=ru&amp;id=rnd00">ru</a><a href="/lib/index.php?lang=ua&amp;id=rnd00">ua</a></div>
</body>
</html>
