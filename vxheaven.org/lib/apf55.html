<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Peter Ferrie '$$$_+$$+$$__+_$+$$_$+$$$_+$$_$' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Peter Ferrie"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Ferrie, Peter,$$$_+$$+$$__+_$+$$_$+$$$_+$$_$, encoded, html, host, array, returned, expression, object, character, true, constructor, code, converted, strings, required, function"/>
<meta name="Description" content="Imagine a JavaScript encoding method that produces ﬁles that contain no alphanumeric characters, only symbols such as ‘$’, ‘_’, and ‘+’. It would be difﬁcult to imagine how it could possibly work, but unfortunately one such encoder exists. It is called ‘JJEncode’. A demonstration version is freely available from the author’s website, and has already been used in malware. This article provides a detailed description of how it works."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"07237845090c5255d827526e842696f405d9ceaf-1498755395-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/apf55.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>$$$_+$$+$$__+_$+$$_$+$$$_+$$_$</h1><p><a href="/lib/?lang=en&amp;author=Ferrie%2C%20Peter">Peter Ferrie</a><br/> <em>Virus Bulletin, February 2011, pp. 4-7</em><br/> <em>ISSN 0956-9979</em><br/> <em>February 2011</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/apf55.html';</script><img src="/img/pdf.gif" alt="PDF"/><a href="/lib/pdf/%24%24%24_%2B%24%24%2B%24%24__%2B_%24%2B%24%24_%24%2B%24%24%24_%2B%24%24_%24.pdf">Download</a> PDF (58.88Kb) (You need to be registered on <a href="/forum">forum</a>)<br/>[<a style="" href="/lib/?lang=EN&amp;index=AN#apf55">Back to index</a>] [<a href="/lib/apf55.html#disqus_thread">Comments</a>]<br/> <form method="post" action=""><input type="hidden" name="pages" value="1"/><input type="submit" value="Turn on page numbers"/></form>
<address>
Peter Ferrie<br/>
Microsoft, USA
</address>
<ul>
<li><a href="#c0">_$+#\\#+__$+$_$+$_$+#\\#+__$+$__+$$$</a></li>
<li><a href="#c1">$_</a></li>
<li><a href="#c3">$$+#\##+$_+#\##</a></li>
<li><a href="#c4">$$+#\##+$$+#\##</a></li>
<li><a href="#c5">$$$_+#\\#+__$+$$_+$$_+$_$_+(![]+##)[_$_]</a></li>
<li><a href="#c6">$$$_+$$+$$__+_$+$$_$+$$$_</a></li>
<li><a href="#c7">Conclusion</a></li>
</ul>
<p>Imagine a JavaScript encoding method that produces ﬁles that contain no alphanumeric characters, only symbols such as ‘$’, ‘_’, and ‘+’. It would be difﬁcult to imagine how it could possibly work, but unfortunately one such encoder exists. It is called ‘JJEncode’. A demonstration version is freely available from the author’s website, and has already been used in malware. This article provides a detailed description of how it works.</p>
<h2><a name="c0"></a>_$+”\\”+__$+$_$+$_$+”\\”+__$+$__+$$$</h2>
<p>We start with this:</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">$=~[];$={___:++$,$$$$:(![]+””)[$],__$:++$,$_<br/>
$_:(![]+””)[$],_$_:++$,$_$$:({}+””)[$],$$_<br/>
$:($[$]+””)[$],_$$:++$,$$$_:(!””+””)[$],$__:++$,$_<br/>
$:++$,$$__:({}+””)[$],$$_:++$,$$$:++$,$___:++$,$_<br/>
_$:++$};$.$_=($.$_=$+””)[$.$_$]+($._$=$.$_[$.__<br/>
$])+($.$$=($.$+””)[$.__$])+((!$)+””)[$._$$]+($.__<br/>
=$.$_[$.$$_])+($.$=(!””+””)[$.__$])+($._=(!””+””)[$._<br/>
$_])+$.$_[$.$_$]+$.__+$._$+$.$;$.$$=$.$+(!””+””)<br/>
[$._$$]+$.__+$._+$.$+$.$$;$.$=($.___)[$.$_][$.$_<br/>
];$.$($.$($.$$+”\””+ENCODED+”\””)())();<br/>
&nbsp;</div>
<p>Note that the ‘ENCODED’ above does not appear in encoded ﬁles, rather it is the location where the encoded host code would appear. Also note that this algorithm does not work in direct mode (that is, putting it in a .js won’t work) because it requires a feature that was introduced in HTML 4.0. As a result, it must appear in an HTML page, and that HTML page must declare its need for HTML 4.0 or later using a declaration like this:</p>
<div class="html" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&lt;!DOCTYPE html PUBLIC “-//W3C//DTD HTML 4.0//EN”&gt;</div>
<p>The ‘HTML 4.0’ string can be replaced by later versions, such as ‘HTML 4.1’ or ‘XHTML 1.0’, etc.</p>
<p>On to the code...</p>
<h2><a name="c1"></a>$_</h2>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">$=~[]</div>
<p>The expression ‘[]’ returns a reference to an empty array. The operator ‘~’ accesses the value at that reference (‘0’ in this case), and then inverts that value, resulting in the value ‘-1’. This value is assigned to the variable ‘$’.</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">$={___:++$,$$$$:(![]+””)[$],__$:++$,$_$_<br/>
:(![]+””)[$],_$_:++$,$_$$:({}+””)[$],$$_<br/>
$:($[$]+””)[$],_$$:++$,$$$_:(!””+””)[$],$__:++$,$_<br/>
$:++$,$$__:({}+””)[$],$$_:++$,$$$:++$,$___:++$,$__<br/>
$:++$}<br/>
&nbsp;</div>
<p>This line can also be written as follows:</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">$=<br/>
{<br/>
&nbsp; &nbsp; &nbsp; &nbsp; ___:++$,<br/>
&nbsp; &nbsp; &nbsp; &nbsp; $$$$:(![]+””)[$],<br/>
&nbsp; &nbsp; &nbsp; &nbsp; __$:++$,<br/>
&nbsp; &nbsp; &nbsp; &nbsp; $_$_:(![]+””)[$],<br/>
&nbsp; &nbsp; &nbsp; &nbsp; _$_:++$,<br/>
&nbsp; &nbsp; &nbsp; &nbsp; $_$$:({}+””)[$],<br/>
&nbsp; &nbsp; &nbsp; &nbsp; $$_$:($[$]+””)[$],<br/>
&nbsp; &nbsp; &nbsp; &nbsp; _$$:++$,<br/>
&nbsp; &nbsp; &nbsp; &nbsp; $$$_:(!””+””)[$],<br/>
&nbsp; &nbsp; &nbsp; &nbsp; $__:++$,<br/>
&nbsp; &nbsp; &nbsp; &nbsp; $_$:++$,<br/>
&nbsp; &nbsp; &nbsp; &nbsp; $$__:({}+””)[$],<br/>
&nbsp; &nbsp; &nbsp; &nbsp; $$_:++$,<br/>
&nbsp; &nbsp; &nbsp; &nbsp; $$$:++$,<br/>
&nbsp; &nbsp; &nbsp; &nbsp; $___:++$,<br/>
&nbsp; &nbsp; &nbsp; &nbsp; $__$:++$<br/>
}<br/>
&nbsp;</div>
<p>The ‘{’ and ‘}’ signify the creation of an object, and each line between the braces creates a property and assigns it a value during the object construction. We’ll examine the lines one at a time.</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">___:++$</div>
<p>The expression ‘++$’ sets the value in the variable ‘$’ to ‘0’ (speciﬁcally, it is incremented by 1, from ‘-1’ to ‘0’). The ‘:’ assigns a value to a property, and the property name is ‘___’, so the property ‘___’ is set to ‘0’.</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">$$$$:(![]+””)[$],</div>
<p>The expression ‘[]’ returns a reference to an empty array, as above. The operator ‘!’ tests if the reference is zero, which it is not, resulting in the Boolean value ‘false’. The expression ‘+""’ causes the Boolean value to be converted to a string, after which the empty string is appended to it. The result is the string ‘false’. The expression ‘[$]’ causes the string to be converted to an array<sup><a href="#f1" name="b1">1</a></sup>, and a single character to be returned. The variable ‘$’ has the value ‘0’ from above, so the ﬁrst character of the string ‘false’ (‘f’) is returned. That value is assigned to the property ‘$$$$’.</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">__$:++$,</div>
<p>The expression ‘++$’ sets to ‘1’ the value of the variable ‘$’, and assigns that value to the property ‘__$’.</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">$_$_:(![]+””)[$],</div>
<p>The second character of the string ‘false’ (‘a’) is assigned to the property ‘$_$_’. The use of the expression ‘![]’
 
appears to be an oversight on the part of the author, since the expression ‘!$’ could have been used instead, now that the value of the variable ‘$’ is no longer zero. This change would have saved one byte.</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">_$_:++$,</div>
<p>The expression ‘++$’ sets to ‘2’ the value of the variable ‘$’, and assigns that value to the property ‘_$_’.</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">$_$$:({}+””)[$],</div>
<p>The expression ‘{}’ returns a reference to an empty object. As above, this reference is converted to a string. The result is the string ‘[object Object]’. The third character of the string ‘[object Object]’ (‘b’) is assigned to the property ‘$_$$’.</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">$$_$:($[$]+””)[$],</div>
<p>The expression ‘$[$]’ would access the third entry in the array speciﬁed by the variable ‘$’ if that array existed. However, since the variable ‘$’ is not an array, the value ‘undeﬁned’ is returned. As above, this value is converted to the string ‘undeﬁned’. The third character of the string ‘undeﬁned’ (‘d’) is assigned to the property ‘$$_$’.</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">_$$:++$,</div>
<p>The expression ‘++$’ sets to ‘3’ the value of the variable ‘$’, and assigns that value to the property ‘_$$’.</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">$$$_:(!””+””)[$],</div>
<p>The expression ‘""’ returns an empty string. The operator ‘!’ tests if the string is zero, which it is, resulting in the Boolean value ‘true’. As above, this value is converted to the string ‘true’. The fourth character of the string ‘true’ (‘e’) is assigned to the property ‘$$$_’. The use of the expression ‘!""+""’ appears to be an oversight, since the string ‘object’ contains the letter ‘e’ immediately before the letter ‘c’. Thus, this line could have been moved below the following line, and the expression ‘!""+""’ could have been replaced with the expression ‘{}+""’, to save one byte.</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">$__:++$,</div>
<p>The expression ‘++$’ sets to ‘4’ the value of the variable ‘$’, and assigns that value to the property ‘$__’.</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">$_$:++$,</div>
<p>The expression ‘++$’ sets to ‘5’ the value of the variable ‘$’, and assigns that value to the property ‘$_$’.</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">$$__:({}+””)[$],</div>
<p>The sixth character of the string ‘[object Object]’ (‘c’) is assigned to the property ‘$$__’. The expression ‘({}+"")’ is duplicated because it is not possible to reference a newly created property during the construction of an object. To reduce the size of the code, it would be necessary to use a second variable, where the ‘object’ string could be stored prior to the construction of the ‘$’ object. Then the property assignment line would become ‘$$__:var2[$]’, where ‘var2’ is the example name of the second variable.</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">$$_:++$,</div>
<p>The expression ‘++$’ sets to ‘6’ the value of the variable ‘$’, and assigns that value to the property ‘$$_’.</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">$$$:++$,</div>
<p>The expression ‘++$’ sets to ‘7’ the value of the variable ‘$’, and assigns that value to the property ‘$$$’.</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">$___:++$,</div>
<p>The expression ‘++$’ sets to ‘8’ the value of the variable ‘$’, and assigns that value to the property ‘$___’.</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">$__$:++$</div>
<p>The expression ‘++$’ sets to ‘9’ the value of the variable ‘$’, and assigns that value to the property ‘$__$’.</p>
<p>At this point, we have the properties ‘___’, ‘$$$$’, ‘__$’, ‘$_$_’, ‘_$_’, ‘$_$$’, ‘$$_$’, ‘_$$’, ‘$$$_’, ‘$__’, ‘$_$’, ‘$$__’, ‘$$_’, ‘$$$’, ‘$___’, and ‘$__$’. They contain the values ‘0’, ‘f’, ‘1’, ‘a’, ‘2’, ‘b’, ‘d’, ‘3’, ‘e’, ‘4’, ‘5’, ‘c’, ‘6’, ‘7’, ‘8’, and ‘9’.</p>
<h2><a name="c3"></a>$$+”\””+$_+”\””</h2>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">$.$_=($.$_=$+””)[$.$_$]+($._$=$.$_[$.__<br/>
$])+($.$$=($.$+””)[$.__$])+((!$)+””)[$._$$]+($.__<br/>
=$.$_[$.$$_])+($.$=(!””+””)[$.__$])+($._=(!””+””)[$._<br/>
$_])+$.$_[$.$_$]+$.__+$._$+$.$<br/>
&nbsp;</div>
<p>This line contains multiple assignments to properties, and character concatenation. It can also be written as follows:</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">$.$_=<br/>
&nbsp; &nbsp; &nbsp; &nbsp; ($.$_=$+””)[$.$_$]<br/>
&nbsp; &nbsp; &nbsp; &nbsp; +($._$=$.$_[$.__$])<br/>
&nbsp; &nbsp; &nbsp; &nbsp; +($.$$=($.$+””)[$.__$])<br/>
&nbsp; &nbsp; &nbsp; &nbsp; +((!$)+””)[$._$$]<br/>
&nbsp; &nbsp; &nbsp; &nbsp; +($.__=$.$_[$.$$_])<br/>
&nbsp; &nbsp; &nbsp; &nbsp; +($.$=(!””+””)[$.__$])<br/>
&nbsp; &nbsp; &nbsp; &nbsp; +($._=(!””+””)[$._$_])<br/>
&nbsp; &nbsp; &nbsp; &nbsp; +$.$_[$.$_$]<br/>
&nbsp; &nbsp; &nbsp; &nbsp; +$.__<br/>
&nbsp; &nbsp; &nbsp; &nbsp; +$._$<br/>
&nbsp; &nbsp; &nbsp; &nbsp; +$.$<br/>
&nbsp;</div>
<p>The references to ‘$’ refer to the object now, not the value ‘9’. The ‘$.’ in front of each property is required to access an existing property.</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">($.$_=$+””)[$.$_$]</div>
<p>The string ‘[object Object]’ is assigned to the property ‘$_’. The sixth character (‘$_$’ is ‘5’) of the string
 
‘[object Object]’ (‘c’) is returned. There is a missed opportunity by the author here, since the ‘$$__’ property also contains the character ‘c’. Five bytes could have been saved by using that property instead, and moving the assignment of the ‘$_’ property to the following line.</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">+($._$=$.$_[$.__$])</div>
<p>The second character (‘__$’ is ‘1’) of the string ‘[object Object]’ (‘o’) is assigned to the property ‘_$’ and also returned.</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">+($.$$=($.$+””)[$.__$])</div>
<p>The non-existent property ‘$’ is accessed, so the value ‘undeﬁned’ is returned. This value is converted to a string, as above. The second character (‘__$’ is ‘1’) of the string ‘undeﬁned’ (‘n’) is assigned to the property ‘$$’ and also returned.</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">+((!$)+””)[$._$$]</div>
<p>The expression ‘!$’ tests if the reference to the object ‘$’ is zero, which it is not, resulting in the Boolean value ‘false’. The value is converted to a string, as above, and the fourth character (‘_$$’ is ‘3’) of the string ‘false’ (‘s’) is returned. The parentheses surrounding the expression ‘!$’ are unnecessary and could have been removed to save two bytes.</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">+($.__=$.$_[$.$$_])</div>
<p>The seventh character (‘$$_’ is ‘6’) of the string ‘[object Object]’ (‘t’) is assigned to the property ‘__’ and also returned. This line could have been written as ‘$.__’ if the line ‘__:(!$+"")[$]’ were placed in the object construction before the second ‘++$’. However, this alternative saves no bytes.</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">+($.$=(!””+””)[$.__$])</div>
<p>The string ‘true’ is constructed, as above. The second character (‘__$’ is ‘1’) of the string ‘true’ (‘r’) is assigned to the property ‘$’ and also returned.</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">+($._=(!””+””)[$._$_])</div>
<p>The string ‘true’ is constructed, as above. The third character (‘_$_’ is ‘2’) of the string ‘true’ (‘u’) is assigned to the property ‘_’ and also returned. In this case, the entire line is poorly thought out, since the ‘_’ property could be assigned in the object constructor in a shorter way. Three bytes could have been saved by placing the line ‘_:($[$]+"")[$]’ before the second ‘++$’, which would access the ﬁrst character of the string ‘undeﬁned’.</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">+$.$_[$.$_$]</div>
<p>The sixth character (‘$_$’ is ‘5’) of the string ‘[object Object]’ (‘c’) is returned. This appears to be another oversight since, as above, ﬁve bytes could have been saved by using the ‘$$__’ property instead. If the ‘c’ and ‘o’ characters were constructed using the alternative method, then the ﬁrst assignment to the ‘$_’ property would be completely unnecessary, resulting in the saving of another ﬁve bytes.</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">+$.__</div>
<p>The value of the property ‘__’ (‘t’) is returned.</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">+$._$</div>
<p>The value of the property ‘_$’ (‘o’) is returned.</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">+$.$</div>
<p>The value of the property ‘$’ (‘r’) is returned. The result is that the string ‘constructor’ is assigned to the property ‘$_’.</p>
<h2><a name="c4"></a>$$+”\””+$$+”\””</h2>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">$.$$=$.$+(!””+””)[$._$$]+$.__+$._+$.$+$.$$</div>
<p>This line contains more character concatenation. It can also be written as follows:</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">$.$$=<br/>
&nbsp; &nbsp; &nbsp; &nbsp; $.$<br/>
&nbsp; &nbsp; &nbsp; &nbsp; +(!””+””)[$._$$]<br/>
&nbsp; &nbsp; &nbsp; &nbsp; +$.__<br/>
&nbsp; &nbsp; &nbsp; &nbsp; +$._<br/>
&nbsp; &nbsp; &nbsp; &nbsp; +$.$<br/>
&nbsp; &nbsp; &nbsp; &nbsp; +$.$$<br/>
&nbsp;</div>
<p>Once again, we will look at each line in turn:</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">$.$</div>
<p>The value of the property ‘$’ (‘r’) is returned.</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">+(!””+””)[$._$$]</div>
<p>The string ‘true’ is constructed, as above. The fourth character (‘_$$’ is ‘3’) of the string ‘true’ (‘e’) is returned. Again, the entire line appears to have been poorly thought out by the author, since nine(!) bytes could have been saved by using the ‘$$$_’ property instead.</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">+$.__</div>
<p>The value of the property ‘__’ (‘t’) is returned.</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">+$._</div>
<p>The value of the property ‘_’ (‘u’) is returned.</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">+$.$</div>
<p>The value of the property ‘$’ (‘r’) is returned.</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">+$.$$</div>
<p>The value of the property ‘$$’ (‘n’) is returned. The result is that the string ‘return’ is assigned to the property ‘$$’. This assignment is completely unnecessary (see below).</p>
 
<h2><a name="c5"></a>$$$_+”\\”+__$+$$_+$$_+$_$_+(![]+””)[_$_]</h2>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">$.$=($.___)[$.$_][$.$_]</div>
<p>This translates to the expression ‘(0)[“constructor”] [“constructor”]’, and is assigned to the property ‘$’. The use of the expression ‘($.___)’ appears to be an oversight by the author, since the expression ‘[]’ could have been used instead. This change would have saved ﬁve bytes. Further, by assigning to the property ‘$_’ instead of ‘$’ at a cost of two bytes, the ﬁve bytes that are required to assign the property ‘$$’ and the four bytes that are required to reference it can be removed for an overall saving of seven bytes.</p>
<p>The expression ‘(0)[“constructor”][“constructor”]’ is equivalent to the expression ‘0.constructor.constructor’, but the brackets are required to delimit the two strings. Otherwise, the expression would appear to reference a single property several levels deep (‘$.$_.$.$_’). The expression ‘&lt;number>.constructor’ is a reference to the constructor of a numeric object, while the expression ‘&lt;object>.constructor.constructor’ is a reference to the constructor of a generic object.</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">$.$($.$($.$$+”\””+ENCODED+”\””)())()</div>
<p>This line decodes and executes the encoded host code using two constructor calls. The ﬁrst constructor call decodes the encoded host code, and the second constructor call executes it, in this way:</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">$.$$+”\””+ENCODED+”\””</div>
<p>The value of the property ‘$$’ (‘return’, however as noted above, this property reference can be replaced by the ‘return’ concatenation from above) is used in the ﬁrst constructor call to return the decoded host code that is bounded by the ‘"’s and represented here by ‘ENCODED’.</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">$.$(return”ENCODED”)()</div>
<p>This line translates to the expression ‘0.constructor. constructor(return“ENCODED”)()’, an anonymous function that returns the decoded host code as a string object. This is equivalent to executing the ‘eval()’ function.</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">$.$(DECODED)()</div>
<p>This line translates to the expression ‘0.constructor.constructor(DECODED)()’, an anonymous function that executes the decoded host code.</p>
<h2><a name="c6"></a>$$$_+$$+$$__+_$+$$_$+$$$_</h2>
<p>Each character of the host code is encoded separately in one of several ways:</p>
<p>If the character is ‘"’ or ‘\’, then the character is prepended with the ‘\’ character (so ‘"’ becomes ‘"’, and ‘\’ becomes ‘\\’).</p>
<p>If the character is a symbol already – that is, any of the following:</p>
<div class="js" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">!&quot;#$%&amp;’()*+,-./:;&amp;lt;&gt;=?@[]^_`{|}~</div>
<p>then the character is used exactly as it appears.</p>
<p>If the character is numeric, or one of the letters ‘a’ to ‘f’, ‘o’, ‘t’, or ‘u’ (and the check is case-sensitive), then the appropriate property is used.</p>
<p>If the character is the letter ‘l’, then the expression ‘(![]+"")[_$_]’ (that is, the third character of the string ‘false’) is used.</p>
<p>If the value of the character is less than 128, then the expression ‘\&lt;val>’ is used, where ‘&lt;val>’ is the decimal value of the character.</p>
<p>Otherwise, the expression ‘\u&lt;val>’ is used, where ‘&lt;val>’ is the hexadecimal value of the character.</p>
<p>It is interesting that some seemingly obvious encoding opportunities were missed. For example, since the numbers ‘0’–’9’ are all available, it would be possible to use one of them to index the entire string for the special texts ‘false’, ‘true’, ‘[object Object]’ and ‘undeﬁned’ (the string ‘constructor’ exists, but all of the characters in that string are present in the other four strings; the string ‘return’ also exists, but all of the characters in that string are present in the strings ‘true’ and ‘undeﬁned’). Those four strings offer six more lower case alphabetic characters (‘ijlnrs’, leaving only ‘ghkmpqvwxyz’), and only the numbers ‘0’–‘5’ are needed to access the entire set. If the host does not require all of the numbers, then several lines could be removed from the object construction code. That would allow the code to be shortened further, since some variables could then use shorter names.</p>
<h2><a name="c7"></a>Conclusion</h2>
<p>As it stands, JJEncode carries a relatively large constant body (even after applying the suggested size optimizations), which makes it easy to recognize. It would remain easy to recognize even if some ‘polymorphism’ were applied by using alternative indexes for the shared characters in the special texts (for example, the letter ‘c’ is at position ‘0’ in the word ‘constructor’, and at position ‘6’ in the string ‘[object’). It would also remain easy to recognize even if the variables were renamed as a result of discarding the unused numeric assignments. The only difﬁculty is in knowing at a glance what the encoded host does. However, the ﬁrst constructor call (‘$.$(...)’) can be replaced with a function to display the result, or even to write it to disk, instead of executing it. Fortunately, the only way that someone could defend against that would be to change the code to the point where it is no longer JJEncode.</p>
<hr size="1"/>
<p><a name="f1" href="#b1">1</a> This is HTML-speciﬁc behaviour. Normally, a string cannot be converted to an array.</p>
[<a style="" href="/lib/?lang=EN&amp;index=AN#apf55">Back to index</a>] [<a href="/lib/apf55.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=apf55">de</a><a href="/lib/index.php?lang=en&amp;id=apf55">en</a><a href="/lib/index.php?lang=es&amp;id=apf55">es</a><a href="/lib/index.php?lang=it&amp;id=apf55">it</a><a href="/lib/index.php?lang=fr&amp;id=apf55">fr</a><a href="/lib/index.php?lang=pl&amp;id=apf55">pl</a><a href="/lib/index.php?lang=ru&amp;id=apf55">ru</a><a href="/lib/index.php?lang=ua&amp;id=apf55">ua</a></div>
</body>
</html>
