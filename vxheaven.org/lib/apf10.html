<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Peter Ferrie, Frédéric Perriot 'Paradise lost' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Peter Ferrie, Frédéric Perriot"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Ferrie, Peter; Perriot, Frédéric,Paradise lost, numbers, process, security, file, bluetooth, replication, cabir, payload, nokia, devices, messages, list, type, start, message"/>
<meta name="Description" content="Eight months ago, Peter Ferrie and Péter Ször asked at the end of their article on SymbOS/Cabir: `What will be next? A mass mailer using MMS?' (see VB, August 2004, p.4). The answer was yes, that is what came next.SymbOS/Commwarrior.A is the first worm to use MMS (Multimedia Messaging Service) technology to spread on cellular phones. Following in the footsteps of Cabir, it also replicates using Bluetooth, though with some improvements in its implementation. This double-pronged approach to replication makes Commwarrior a more likely candidate to be seen in the wild - although, at the time of writing, no such reports have been received.As with Cabir, Commwarrior replicates only on Nokia Series 60-compatible devices."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"98b749a79c8d0007381ebd17eb917667ae2b5dc1-1498756927-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/apf10.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Paradise lost</h1><p><a href="/lib/?lang=en&amp;author=Ferrie%2C%20Peter">Peter Ferrie</a>, <a href="/lib/?lang=en&amp;author=Perriot%2C%20Fr%C3%A9d%C3%A9ric">Frédéric Perriot</a><br/> <em>Virus Bulletin, April 2005, pp.4-6</em><br/> <em>ISSN 0956-9979</em><br/> <em>April 2005</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/apf10.html';</script><img src="/img/pdf.gif" alt="PDF"/><a href="/lib/pdf/Paradise%20lost.pdf">Download</a> PDF (55.88Kb) (You need to be registered on <a href="/forum">forum</a>)<br/>[<a style="" href="/lib/?lang=EN&amp;index=AN#apf10">Back to index</a>] [<a href="/lib/apf10.html#disqus_thread">Comments</a>]<br/> <form method="post" action=""><input type="hidden" name="pages" value="1"/><input type="submit" value="Turn on page numbers"/></form>
<address>
Peter Ferrie and Fr&eacute;d&eacute;ric Perriot<br/>
Symantec Security Response, USA
</address>
<ul>
<li><a href="#c1">Consulting on the sum of things</a></li>
<li><a href="#c2">To none accountable</a></li>
<li><a href="#c3">As soft as now severe, our temper changed</a></li>
<li><a href="#c4">Both when we wake, and when we sleep</a></li>
<li><a href="#c5">Why has thou added the sense of endless woes</a></li>
<li><a href="#c6">Dim eclipse, sisastrous twilight</a></li>
<li><a href="#c7">Receive thy new possesor</a></li>
<li><a href="#c8">In this perfidious fraud, contagion spread</a></li>
<li><a href="#c9">Journeyed on, pensive and slow</a></li>
<li><a href="#ca">Conclusion</a></li>
</ul>
<p>Eight months ago, Peter Ferrie and Péter Ször asked at the end of their article on SymbOS/Cabir: `What will be next? A mass mailer using MMS?' (see <em>VB</em>, August 2004, p.4). The answer was yes, that is what came next.</p>
<p>SymbOS/Commwarrior.A is the first worm to use MMS (Multimedia Messaging Service) technology to spread on cellular phones. Following in the footsteps of Cabir, it also replicates using Bluetooth, though with some improvements in its implementation. This double-pronged approach to replication makes Commwarrior a more likely candidate to be seen in the wild - although, at the time of writing, no such reports have been received.</p>
<p>As with Cabir, Commwarrior replicates only on <em>Nokia Series 60</em>-compatible devices.</p>
<h2><a name="c1"></a>Consulting on the sum of things</h2>
<p>The worm begins by counting the number of copies of its process that are running. Generally, it will exit if another copy is running already (unless many copies start at the same time).</p>
<p>Next, the worm retrieves the machine identification number, and calculates an additive sum of the characters, to produce a unique value. This value might have been used by the worm's author during testing to avoid the infection of his own device, but now the result is simply discarded.</p>
<h2><a name="c2"></a>To none accountable</h2>
<p>The worm walks the list of running processes, and renames itself to the name of the first process in the list (which is usually `EKern', the system kernel), followed by some random numbers.</p>
<p>In addition, the worm changes its owner and type to those of the first process's owner and type. Finally, the worm protects its process to prevent any other process from changing the priority of, or terminating, its process. Any attempt to terminate the process, by using a tool such as `Switcher', is simply ignored. The screenshots in Figure 1 show the process list, with the legitimate EKern at the top of the list, and the worm process at the bottom of the list. Notice the size difference in memory.</p>
<p>If the worm has not been run from the `c:\system\updates\commwarrior.exe' path, it creates the directories `c:\system\updates' and `c:\system\recogs', then copies the `commrec.mdl' file to the `updates' and `recogs' directories, and the `commwarrior.exe' file to the `updates' directory.</p>
<div align="center">
<img src="img/apf10_fig1_1.gif" alt="Figure 1. The legitimate EKern process at the top, and the worm process at the bottom of the list."/><br/>
<img src="img/apf10_fig1_2.gif" alt="Figure 1. The legitimate EKern process at the top, and the worm process at the bottom of the list."/>
<p><em>Figure 1. The legitimate EKern process at the top, and the worm process at the bottom of the list.</em></p>
</div>
<p>The `commrec.mdl' file is a MIME recogniser file. It is intended to run the `commwarrior.exe' file from the `updates' directory whenever the phone starts, however on recent models of phones, such as the <em>Nokia 7610</em>, this does not work.</p>
<p>The worm creates a SIS file named `c:\system\updates\commw.sis', by appending the `commwarrior.exe' and `commrec.mdl' files to the SIS header that is carried in its code. The SIS file uses the store method only - no compression is used - and the `commwarrior.exe' file is marked to auto-execute on completion of the installation.</p>
<h2><a name="c3"></a>As soft as now severe, our temper changed</h2>
<p>The worm contains various texts, but the most amusing is the one that reads `OTMOPO3KAM HET' (which translates
 
roughly as `No to softheads!'). According to our colleague Sergei Shevchenko, this is Russian slang, and the word for `softheads' identifies someone whose brain has frozen so that the person has lost his ability to think and control himself.</p>
<h2><a name="c4"></a>Both when we wake, and when we sleep</h2>
<p>The replication strategy of the worm is interesting because it adapts its infection vector according to the time of the day.</p>
<p>The worm uses Bluetooth during the normal waking hours of the phone's owner, when it is most likely to have other Bluetooth devices in range. It uses MMS during `sleeping hours', and cleans up the sent-message logs carefully afterwards. In addition, the worm intentionally sets a lower priority to the replication threads, to make their activity less noticeable.</p>
<p>The overall scheduling of the worm's replication is accomplished by a single timer, which is set to trigger every ten seconds. Within the main timer callback, the worm checks for the payload condition, the time of day and the Bluetooth state, in order to pick a replication method.</p>
<p>The worm favours finishing any on-going Bluetooth replication cycle over sending MMS messages. Its schedule looks like this:</p>
<ul>
<li>08:00am - 11:59pm Bluetooth replication</li>
<li>12:00am - 06:59am MMS replication</li>
<li>07:00am - 07:59am MMS queue cleanup</li>
</ul>
<h2><a name="c5"></a>Why has thou added the sense of endless woes</h2>
<p>On the 14th day of any month, in the hour between midnight and 12:59am, Commwarrior's payload triggers. The worm's payload is to warm-boot the phone unconditionally.</p>
<p>Since the reboot does not cause the phone to switch itself off, and because the worm is part of the boot cycle, the phone could continue to reboot until the payload time ends.</p>
<h2><a name="c6"></a>Dim eclipse, sisastrous twilight</h2>
<p>The Bluetooth replication code differs from that seen in Cabir, in that it enumerates all the devices in range, whereas Cabir attempted to infect only the first device in range.</p>
<p>When the Bluetooth replication cycle starts, the worm enumerates all devices in range and builds a list of present devices. It queries each device for the availability of the `Obex Push' service which is necessary to upload files. Devices meeting this condition are sent a copy of the SIS file of the worm, renamed to a random string which is eight characters in length, and consists of lower case letters and digits.</p>
<p>Once the worm has attempted replication to all devices that were found, it tears up all the connections and a new Bluetooth cycle can start. The first Bluetooth cycle does not start until 50 seconds after the worm process starts, in order to let the phone boot completely. A new Bluetooth cycle can, in theory, be triggered every 50 seconds, but if there are many devices within range, it may be slower than that.</p>
<h2><a name="c7"></a>Receive thy new possesor</h2>
<p>The worm's MMS functionality can be considered the equivalent of mass-mailing used by viruses on the <em>Windows</em> platform. This makes us very afraid that it will become the replication method of choice among any future self-replicating malware for cellular phones.</p>
<p>Commwarrior sends one MMS message at a time (i.e. one new MMS message at most every 10 seconds, since a message might take more than one cycle to complete). The recipients are picked randomly from the phone book.</p>
<p>On each cycle, one contact is picked at random, then Commwarrior enumerates the information fields of this contact, and selects from there the fields that correspond to mobile numbers only. This means that home numbers and work numbers (i.e. land line numbers) are ignored, in an attempt to maximise the chance of hitting other compatible cellular phones.</p>
<p>If a contact entry in the phone book contains several mobile numbers, then the MMS message is sent to all of those numbers.</p>
<p>From the debugging messages and code snippets in the Commwarrior code itself, it is possible to determine the origin of much of the MMS code used in the worm. Most of it was copied from a developer's page on a website, and altered slightly to add support for binary attachments (in fact, most of the rest of the code was copied too, from the <em>Symbian</em> SDK samples).</p>
<h2><a name="c8"></a>In this perfidious fraud, contagion spread</h2>
<p>For each of the MMS messages that Commwarrior sends, the subject and message body are chosen randomly from the following list:</p>
 
<ul>
<li>Norton AntiVirus</li>
<li>Released now for mobile, install it!</li>
<li>Dr.Web</li>
<li>New Dr.Web antivirus for Symbian OS. Try it!</li>
<li>MatrixRemover</li>
<li>Matrix has you. Remove matrix!</li>
<li>3DGame</li>
<li>3DGame from me. It is FREE !</li>
<li>MS-DOS</li>
<li>MS-DOS emulator for SymbvianOS. Nokia series 60 only.</li>
<li>Try it!</li>
<li>PocketPCemu</li>
<li>PocketPC *REAL* emulator for Symbvian OS! Nokia only.</li>
<li>Nokia ringtoner</li>
<li>Nokia RingtoneManager for all models.</li>
<li>Security update #12</li>
<li>Significant security update. See www.symbian.com</li>
<li>Display driver</li>
<li>Real True Color mobile display driver!</li>
<li>Audio driver</li>
<li>Live3D driver with polyphonic virtual speakers!</li>
<li>Symbian security update</li>
<li>See security news at www.symbian.com</li>
<li>SymbianOS update</li>
<li>OS service pack #1 from Symbian inc.</li>
<li>Happy Birthday!</li>
<li>Happy Birthday! It is present for you!</li>
<li>Free SEX!</li>
<li>Free *SEX* software for you!</li>
<li>Virtual SEX</li>
<li>Virtual SEX mobile engine from Russian hackers!</li>
<li>Porno images</li>
<li>Porno images collection with nice viewer!</li>
<li>Internet Accelerator</li>
<li>Internet accelerator, SSL security update #7.</li>
<li>WWW Cracker</li>
<li>Helps to *CRACK* WWW sites like hotmail.com</li>
<li>Internet Cracker</li>
<li>It is *EASY* to *CRACK* provider accounts!</li>
<li>PowerSave Inspector</li>
<li>Save you battery and *MONEY*!</li>
<li>3DNow!</li>
<li>3DNow!(tm) mobile emulator for *GAMES*.</li>
<li>Desktop manager</li>
<li>Official Symbian desctop manager.</li>
<li>CheckDisk</li>
<li>*FREE* CheckDisk for SymbianOS released!MobiComm</li>
</ul>
<p>(Due to what appears to be a missing terminating character, the last message body appears to contain the subject [`MobiComm'] for the next message body [`MobiComm, Mobile communications inspector. Try it!'] which is never referenced.)</p>
<p>This worm's use of social engineering is very similar to that seen in many email worms, and has proven very successful in the past. The MMS messages contain an attachment whose name is always `commw.sis'. The attachment is the worm installer, and its MIME type is set explicitly to `application/vnd.symbian.install'.</p>
<p>The worm maintains a list in memory of all of the recipients of its MMS messages, and uses the list to avoid sending multiple messages to any recipient. In the event that the phone is switched off (or the payload executes), the list will be lost, and recipients will receive additional messages if the worm process is executed again.</p>
<p>In the early hours of the morning, the worm cleans up the MMS queue. This means that the user will not be alarmed by any worm messages in the `Sent' box.</p>
<h2><a name="c9"></a>Journeyed on, pensive and slow</h2>
<p>One mitigating factor to the success of the MMS replication method is that the phone operator interoperability seems to be very limited. Indeed, during our attempts to send our own test messages, we experienced many failures to send messages at all between different providers, and long delivery times.</p>
<p>It should be noted that, upon receipt of the SIS file, whether by Bluetooth or MMS, the user must agree explicitly to its installation via several dialog boxes. If, at any point, the user cancels the installation, the worm does not execute.</p>
<h2><a name="ca"></a>Conclusion</h2>
<p>Due to its openness and the ready availability of development tools, the <em>Symbian</em> platform appears to be a fertile ground for new malware, and will become a required area of expertise for current and future anti-virus researchers. The fact that the <em>Symbian OS</em> is designed to run on embedded platforms, whose resources are limited, and that its core APIs are based on C++, can throw off reverse engineers who are used to the PC platform.</p>
 
[<a style="" href="/lib/?lang=EN&amp;index=AN#apf10">Back to index</a>] [<a href="/lib/apf10.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=apf10">de</a><a href="/lib/index.php?lang=en&amp;id=apf10">en</a><a href="/lib/index.php?lang=es&amp;id=apf10">es</a><a href="/lib/index.php?lang=it&amp;id=apf10">it</a><a href="/lib/index.php?lang=fr&amp;id=apf10">fr</a><a href="/lib/index.php?lang=pl&amp;id=apf10">pl</a><a href="/lib/index.php?lang=ru&amp;id=apf10">ru</a><a href="/lib/index.php?lang=ua&amp;id=apf10">ua</a></div>
</body>
</html>
