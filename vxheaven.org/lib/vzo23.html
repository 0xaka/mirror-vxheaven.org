<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title> Z0mbie '"DELAYED CODE" technology (version 1.1)' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Z0mbie"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Z0mbie,&quot;DELAYED CODE&quot; technology (version 1.1), code, virus, delayed, iterations, modexp, number, calculations, operation, text, subroutine, algorithm, calls, encrypt, encr, decryption"/>
<meta name="Description" content="Let we wrote a virus. Avers will create antiviral code to detect it, and after some time period all infected computers will be cured. This article describes another technology of prolonging this time period."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"dba18b67845eb1f22acf1ce1b661000669d04bdc-1498755368-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vzo23.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>"DELAYED CODE" technology (version 1.1)</h1><p><a href="/lib/?lang=en&amp;author=Z0mbie"> Z0mbie</a><br/> <em><a href="/vx.php?fid=459#f459">Top Device Online [10]</a></em><br/> <em>October 2000</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vzo23.html';</script><div class="ci"><a href="/lib/?ci=vzo23">2</a></div>[<a style="" href="/lib/?lang=EN&amp;index=VT#vzo23">Back to index</a>] [<a href="/lib/vzo23.html#disqus_thread">Comments</a>]<br/> 
<ul>
<li><a href="#p1"> Introduction</a></li>
<li><a href="#p2"> Idea</a></li>
<li><a href="#p3"> Theory (sux)</a></li>
<li><a href="#p4"> Theory (rulez)</a></li>
<li><a href="#p5"> Encryption/decryption time interdependence</a></li>
<li><a href="#p6"> Example</a></li>
<li><a href="#p7"> Increasing speed of calculations</a></li>
<li><a href="#p8"> Slowing down speed of calculations</a></li>
<li><a href="#p9"> Other bad stuff</a></li>
<li><a href="#p10">"Delayed code" usage (which code to encrypt?)</a></li>
</ul>
<h2><a name="p1">Introduction</a></h2>
<p>Let we wrote a virus. Avers will create antiviral code to detect it, and after some time period all infected computers will be cured. This article describes another technology of prolonging this time period.</p>
<h2><a name="p2">Idea</a></h2>
<p>We may write code which will change initial virus bytes (or any other virus characteristics) after two months, for example. If the virus will initially contain such modificating-code, antivirus will just contain not one, but two or more checksums, or checksum calculated at other, constant code range.</p>
<p>There are only one way to prohibit analysis of the modificating-code: to hide it from avers. And there are the following ways to implement this action:</p>
<ol>
<li>At required time, download code from the Internet, or encrypt code and wait for decryption-key.</li>
<li>Encrypt code with such method, that decryption will take exactly required time. ("delayed code")</li>
</ol>
<p>As you can see, last variant allows us to write completely automated virus with hidden "delayed" features.</p>
<h2><a name="p3">Theory (sux)</a></h2>
<p>Lets encrypt some random buffer A[] with some hashing algorithm so many times N, so it will take us time period T. After these calculations done, we have another random buffer B[] which is used to encrypt/decrypt our "delayed" code.</p>
<p>There is no way to perform required N iterations using more than one computer ('coz each time current buffer is encrypted), so minimal decryption time is limited with maximal CPU speed.</p>
<p>If you will use computer which is fast enough, and use some time to encrypt fucking random buffer, then you may be sure that the same operation may not be done in a less time period.</p>
<p>So, each time the virus is active, it iterates N encryption cycles until buffer A[] will be converted into B[]. After time T will be spent to decryption, virus will got buffer B[] and use it to decrypt "delayed code".</p>
<h2><a name="p4">Theory (rulez)</a></h2>
<p>Main trouble is that we dont want to wait for some months to encrypt fucking data, 'coz in example showed above, encryption and decryption both takes the same time period T.</p>
<p>This means that we will use RSA algorithm. In the RSA algorithm, encryption and decryption keys are different.</p>
<p>So, to encrypt "delayed code" we will take random buffer A[], encrypt it N times and got buffer B[].</p>
<p>But, in contrast to previously described hashing algorithm, our virus will iterate not the same operation. Our virus will decrypt buffer B[] back into A[].</p>
<p>In the encryption operation will be used small (low-bit) exponent, and in the decryption operation we will use big exponent.</p>
<p>This means that encryption will take much less time than decryption. We will encrypt our "delayed code" for some minutes/hours, but active virus copies (as well as avers ;-) will decrypt it for some months.</p>
<h2><a name="p5">Encryption/decryption time interdependence</a></h2>
<p>Now our task is to answere, how many times should we encrypt our "delayed code" so it will be decrypted for some months.</p>
<p>As you know, RSA encryption means the following:</p>
<pre class="source">
    <strong>encryption:</strong> encr = (text ^ e) % m
    <strong>decryption:</strong> text = (encr ^ d) % m
</pre>
<p>where {e,m} and {d,m} pairs are public and secret keys. ('^' sign means raising to a power, '%' means modulus, remainder after division)</p>
<p>As a rule, e is a small number (with a low # of bits), such as 3, 17, 50003 and so on. And d is a big number, consisting of 1023 bits for example.</p>
<p>In our scheme there is no public/secret meaning at all. Here is our scheme:</p>
<table border="1" cellspacing="0" cellpadding="0" summary="">
<tr><th>Encryption (encrypting "delayed code", at home ;-)</th><th>Decryption (decrypting "delayed code", on infected or on avers' PC)</th></tr>
<tr><td><ul>
<li>A[] &lt;-- random buffer/any data</li>
<li>encrypt "delayed code" with A[]</li>
<li> x = A[]<br/>
N times: x = (x ^ e) % m<br/>
B[] = x</li>
<li>store B[] in virus</li>
</ul></td>
<td><ul>
<li> x = B[]<br/>
N times: x = (x ^ d) % m<br/>
A[] = x</li>
<li>decrypt "delayed code" with A[]</li>
</ul></td></tr></table>
<p>Now lets consider our main 'modexp' subroutine.</p>
<pre class="source">
    // modexp:  subroutine, raising to a power and returning modulus
    // returns: x = (a ^ e) % m

    void modexp(bignumber&amp; x,   // output
                bignumber a,    // input
                bignumber e,    // exponent
                bignumber m,    // modulus
    {
        x = 1;
        bignumber t = a;
        for (int i = 0; i &lt;= MaxBit(e); i++)
        {
            if (e.GetBit[i] == 1)
              x = (x * t) % m;        // modmult()
            t = (t * t) % m;          // modmult()
        }
    }
</pre>
<p>As you can see, modexp() subroutine calls modmult() subroutine (e.#bit + e.#bit1 - 1) times. (-1 here means that last t*t multiplication is skipped; i just simplified the code showed above) This number of modmult() calls is a main difference between encryption and decryption.</p>
<pre class="source">
  Decr.time = Encr.time * (D.#bit+D.#bit1 - 1) / (E.#bit1+E.#bit1 - 1) * K
</pre>
<p>where:</p>
<pre class="source">
    #bit  == total number of bits
    #bit1 == number of 1s
    #bit + #bit1 - 1 == number of modmult() calls

    K = 0.9+-10% -- Appeared because of variable modmult() time usage.
                    As it seems, when N-->oo, K-->1
</pre>
<h2><a name="p6">Example</a></h2>
<p>Lets calculate, how many times (N) should we encrypt the message, so it will be decrypted for 10 minutes. Note, that all these tests were performed on a slow pc, so not the numbers, but their proportionality has a meaning.</p>
<p>At first, we must create RSA key. Let it be 1024-bit key with low exponent e = 3. Executing: 'KEYGEN.EXE KEY\DPGN 1024 3 3' Key parameters are: 1024-bit N, E==3, D=1023-bit/519*'1'</p>
<p>Theoretical time ratio: (1023+519-1)/(2+2-1)*0.9 = 462+-10%</p>
<p>But we want higher ratio precision, so lets find real time ratio, kinda "calibrate" a key.</p>
<pre class="source">
    Executing: 'DGPGN.EXE e 100'
    result: 100 iterations done, encryption time = 815 ms
    Executing: 'DGPGN.EXE d 100'
    result: 100 iterations done, decryption time = 360228 ms

    'Real' ratio: 360228/815 = 441
</pre>
<p>Now we may calculate N for 10-min decryption.</p>
<p>If 100 decryption iterations used 360228 ms, and N iterations will use 10*60*1000 ms (10 minutes), then N = 60*10*1000 * 100 / 360228 = 167</p>
<p>If 167 decryption iterations will use 60*10*1000 ms, then encryption time is 60*10*1000 / 441 = 1360 ms.</p>
<p>So, about one second of encryption will result in 10 mins of decryption.</p>
<pre class="source">
    Executing: 'DPGN.EXE e 167'
    encryption time: 1268 ms

    Executing: 'DPGN.EXE d 167'
    decryption time: 600477 ms = 10 minutes + 0.5 seconds
</pre>
<p>Lets show here some other calculation results:</p>
<table border="1" summary="">
<tr><th rowspan="2">Decryption</th><th rowspan="2">Encryption</th><th colspan="2">N (1024-bit key)</th></tr>
<tr><th>K5-100</th><th>Celeron-500</th></tr>
<tr><td> 10 min </td><td> 1.3 sec </td><td> 167</td><td> 950 </td></tr>
<tr><td> 1 hour </td><td> 7.8 sec </td><td> 1000</td><td> 5700 </td></tr>
<tr><td> 1 day </td><td> 3 min </td><td> 24000</td><td> 136800 </td></tr>
<tr><td> 1 week </td><td> 21 min </td><td> 168000</td><td> 957600 </td></tr>
<tr><td> 1 month </td><td> 1.5 hour </td><td> 672000</td><td> 3830400 </td></tr>
<tr><td> 1 year </td><td> 18 hours</td><td> 8064000</td><td> 45964800 </td></tr>
<tr><td> 16 months</td><td> 1 day </td><td> &nbsp; </td><td> &nbsp; </td></tr>
<tr><td> 10 years </td><td> 1 week </td><td> &nbsp; </td><td> &nbsp; </td></tr>
<tr><td> 40 years </td><td> 1 month</td><td> &nbsp; </td><td> &nbsp; </td></tr>
</table>
<p> 8-( )</p>
<a name="p7"></a><h2>Increasing speed of calculations</h2>
<p> Decryption algorithm 'text = (encr ^ d) % m' may be also represented
as follows:</p>
<pre class="source">
      a = ((encr % p) ^ dp) % p            // dp = d % (p-1)
      b = ((encr % q) ^ dq) % q            // dq = d % (q-1)
      if (b &lt; a) b += q
      text = a + p * (((b - a) * u) % q)       // u: (u * p) % q = 1
</pre>
<p> In such algorithm, decryption time should be faster by some times.
But, i dont know if it is possible to find p and q knowing d,e and m.</p>
<a name="p8"></a><h2>Slowing down speed of calculations</h2>
<p>Because of d is not unique key, and d variants may be calculated
using formula:</p>
<pre class="source">
   d' = d + (p-1)*(q-1) * t, t=0,1,2,...,
</pre>
<p>then d length may be increased as we want,
that will slow down calculations by many times.</p>
<p>But, if p and q will be found (knowing d'), then original d can
also be found, and then somebody will be able to perform
DPGN calculations many times faster, that is bad.</p>
<a name="p9"></a><h2>Other bad stuff</h2>
<ol>
<li>In a real life, there is no need to publish N number
(# of iterations), just any good CRC will be enough.
So, nobody will know what is IT and when IT will be decrypted and
executed. |->
Also, it is good to add some random part to N number and do not
make resulting time T day- or hour- aligned.</li>
<li>I'm not sure, but - maybe - {N times: x = (x ^ d) % m} operation
may be changed to something more fast (using some perverted math).
To avoid such shit, you may do some additional encryption between
'modexp' calls, for example as following:
<pre class="source">
N times:
{
  x = (x ^ d) % m;
  x = x xor &lt;some-big-number>;
}
</pre>
DPGN.EXE just xors some dwords within the x number on each iteration.</li>
</ol>
<a name="p10"></a><h2>"Delayed code" usage (which code to encrypt?)</h2>
<ul>
<li> As was said above, entrypoint-modificating code, i.e. virus checksum
changer. Imagine: your virus has been spreaded, av has been written,
and now 99% of infected PCs are cured. But, that 1% that remains
infected, after some time, changes own checksum and new virus begins
to spread starting not from one-two PCs (as it was with "host"
modification), but from thousands of infected computers.</li>
<li> We all are thinking about downloading viral plugins from the Internet.
"Delayed code" technology allows your virus to contain any fixed urls,
those will be hidden from avers, until right time.</li>
<li> Instead of deleting user's data you can quickly encrypt it, leaving
a chance to decryption... in some years ;-)</li>
<li> Recursive encryption. I mean that decrypted "delayed code" can
contain another "surprise package".</li>
</ul>
[<a style="" href="/lib/?lang=EN&amp;index=VT#vzo23">Back to index</a>] [<a href="/lib/vzo23.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vzo23">de</a><a href="/lib/index.php?lang=en&amp;id=vzo23">en</a><a href="/lib/index.php?lang=es&amp;id=vzo23">es</a><a href="/lib/index.php?lang=it&amp;id=vzo23">it</a><a href="/lib/index.php?lang=fr&amp;id=vzo23">fr</a><a href="/lib/index.php?lang=pl&amp;id=vzo23">pl</a><a href="/lib/index.php?lang=ru&amp;id=vzo23">ru</a><a href="/lib/index.php?lang=ua&amp;id=vzo23">ua</a></div>
</body>
</html>
