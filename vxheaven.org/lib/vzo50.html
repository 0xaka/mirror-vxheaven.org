<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title> Z0mbie 'О недетектируемых вирусах' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Z0mbie"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Z0mbie,О недетектируемых вирусах, вируса, emul, случае, время, block, пусть, местам, программы, сложность, блоков, число, вирус, файле, расшифровщик, тела"/>
<meta name="Description" content="VX Heaven site is dedicted to providing information about computer viruses (virii) and web space for virus authors and groups"/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"9009cdb40cae1a4480ccfc5584f1cf23b81c4807-1498757875-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vzo50.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>О недетектируемых вирусах</h1><p><a href="/lib/?lang=ru&amp;author=Z0mbie"> Z0mbie</a><br/></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vzo50.html';</script>[<a style="" href="/lib/?lang=RU&amp;index=VT#vzo50">Вернуться к списку</a>] [<a href="/lib/vzo50.html#disqus_thread">Комментарии</a>]<br/> <form method="post" action="">
<img src="/img/cache/0b9fd596a90421f9f1f68a9760275737.gif" alt="\text{T_EX size}" valign="middle"/>
<select name="TeX_size"><option value="-2">-2</option><option value="-1">-1</option><option value="0" selected="selected">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option> </select>
<input type="submit" value="Scale"/>
</form>
<p>От чего зависит время детектирования вируса в файле?</p>
<p>Во-первых, от числа возможных вариантов тела вируса. Чем таких вариантов больше, тем дольше при проверке их все перебирать.</p>
<p>Этот путь самый простой, и именно по нему пошли вирусы, превратившись в крипты, полиморфные, пермутирующие и метаморфные.</p>
<p>Ясно, что все возможные варианты тела вируса при проверке перебирают редко (т.е. когда их мало), а обычно производится специальная обработка кода и затем сравнение по маске, либо более сложное алгоритмическое детектирование тела вируса - в этом случае вместо числа вариантов вируса рассматривается сложность такой комплексной проверки.</p>
<p>В случае полиморфно зашифрованного вируса, к этому добавляется сложность эмуляции полиморфного расшифровщика. Если же расшифровщик убогий, то детектируют его, а не сам вирус.</p>
<p>Во-вторых, общее время детектирования вируса зависит от числа возможных местоположений вируса в файле.</p>
<p>Например, если вирус перехватывает точку входа в файл, достаточно проверить наличие вируса только по этому адресу.</p>
<p>Если же вирус вставляет свое тело в случайное место файла, то время детектирования умножается на размер этого файла. Примечание: это справедливо только в случае полиморфных расшифровщиков, у которых работа следующей команды зависит от результата работы предыдущей.</p>
<p>Примером этого пути развития является технология UEP (EPO).</p>
<p>Пусть</p>
<dl>
<dt>C</dt><dd>сложность проверки всего файла.</dd>
<dt>Ci</dt><dd>сложность проверки вируса по некоторому данному адресу, включая сюда эмуляцию и проверку всех вариантов тела вируса.</dd>
<dt>I</dt><dd>число возможных адресов в файле, по которым может находиться тело вируса или его часть.</dd>
</dl>
<p>Тогда C = Ci * I</p>
<p>Эта формула отражает алгоритм проверки файла: для каждого возможного адреса I, по которому может находиться вирус, выполнить проверку на наличие вируса (Ci).</p>
<p>Алгоритм проверки файла на вирус в этом случае такой:</p>
<div class="adhoc" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp;for(i = 0; i &lt; I; i++)<br/>
&nbsp; &nbsp; &nbsp;{<br/>
&nbsp; &nbsp; &nbsp; &nbsp;init_emul(); &nbsp; &nbsp; &nbsp; \<br/>
&nbsp; &nbsp; &nbsp; &nbsp;emul(block[i]); &nbsp; &nbsp; &nbsp;Ci<br/>
&nbsp; &nbsp; &nbsp; &nbsp;check_virus(); &nbsp; &nbsp; /<br/>
&nbsp; &nbsp; &nbsp;}<br/>
&nbsp;</div>
<p>Отсюда можно сделать вывод, что большие файлы инфицировать лучше, что вирус должен быть меньше и сложнее, что полиморфные расшифровщики должны работать очень долго, и что число возможных местоположений вируса в файле должно быть максимальным.</p>
<p>Теперь рассмотрим вариант, когда полиморфный расшифровщик состоит из N частей, разбросанных по N местам файла, и корректно работает только в случае последовательного выполнения всех этих частей.</p>
<p>В этом случае, если антивирус не собирается эмулировать всю программу, а только различные комбинации ее блоков, возможно содержащих вирусный расшифровщик, общая сложность проверки будет равна</p>
<p><img src="/img/cache/78e9dac6144f22ed4b6e90e5fab262df.gif" alt="C=C_i\cdot\frac{I!}{(I-N)!}" valign="middle"/></p>
<p>Здесь <img src="/img/cache/2dfa95718f7b3a423c42410da315dd6d.gif" alt="\frac{I!}{(I-N)!}" valign="middle"/> это так называемое число размещений из I по N.</p>
<p>Так, например, если число подозреваемых на вирусные блоков равно 4, а всего должно быть 2 последовательно выполненных блока, то будут проверены 12 вариантов:</p>
<pre>
	{0,1} {0,2} {0,3}
	{1,0} {1,2} {1,3}
	{2,0} {2,1} {2,3}
	{3,0} {3,1} {3,2}
</pre>
<p>В результате, проверка файла на вирус будет выглядеть так:</p>
<div class="adhoc" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp;for(i1 = 0; i1 &lt; I; i1++) &nbsp; \<br/>
&nbsp; &nbsp; &nbsp;for(i2 = 0; i2 &lt; I; i2++) &nbsp; &nbsp;\<br/>
&nbsp; &nbsp; &nbsp;if (i2 != i1) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/>
&nbsp; &nbsp; &nbsp;for(i3 = 0; i3 &lt; I; i3++) &nbsp; &nbsp; &nbsp;\<br/>
&nbsp; &nbsp; &nbsp;if (i3 != i1) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \ &nbsp; &nbsp;I!<br/>
&nbsp; &nbsp; &nbsp;if (i3 != i2) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;------<br/>
&nbsp; &nbsp; &nbsp;... &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(I-N)!<br/>
&nbsp; &nbsp; &nbsp;for(iN = 0; iN &lt; I; iN++) &nbsp; &nbsp; &nbsp; /<br/>
&nbsp; &nbsp; &nbsp;if (iN != i1) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/<br/>
&nbsp; &nbsp; &nbsp;if (iN != i2) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /<br/>
&nbsp; &nbsp; &nbsp;if (iN != i3) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/<br/>
&nbsp; &nbsp; &nbsp;... &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /<br/>
&nbsp; &nbsp; &nbsp;{<br/>
&nbsp; &nbsp; &nbsp; &nbsp;init_emul(); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;\<br/>
&nbsp; &nbsp; &nbsp; &nbsp;emul(block[i1]); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \<br/>
&nbsp; &nbsp; &nbsp; &nbsp;... &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Ci<br/>
&nbsp; &nbsp; &nbsp; &nbsp;emul(block[iN]); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /<br/>
&nbsp; &nbsp; &nbsp; &nbsp;check_virus(); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/<br/>
&nbsp; &nbsp; &nbsp;}<br/>
&nbsp;</div>
<p>Теперь возникает вопрос о том, как выяснить последовательность выполнения инструкций программы, для того, чтобы вставленные между ними вирусные блоки были выполнены в определенной последовательности.</p>
<p>Это достигается трассировкой программы. Трассировка же легко производится с использованием debug api.</p>
<p>Трассировать нужно выбранную программу в течение небольшого времени, скажем, нескольких секунд. Важно, чтобы это время выбиралось случайным образом.</p>
<p>Во время такой трассировки составляется список выполненных инструкций, свой для каждой нити процесса.</p>
<p>Интересным моментом является то, что трассируем мы не программу, а процесс, то есть EXE-шник и все его DLL-ки. Таким образом появляется возможность раскидать вирусные блоки не только по разным местам одного файла, но и по разным местам нескольких разных файлов, так, что выполнены эти блоки будут последовательно.</p>
<p>Конечно, на небольшом локальном участке кода можно обойтись и без трассировки, одним лишь статическим анализом. Но когда речь заходит о большой мультитреадной программе, состоящей из нескольких файлов - EXE'шника и всех его DLL'ек, а также о достаточно больших расстояниях между вирусными блоками, то дизассемблирования недостаточно, и трассировка становится необходимой.</p>
<p>Таким образом мы:</p>
<ol>
<li>Выбираем программу.</li>
<li>Производим статический анализ. (парсинг на инструкции, см. движок Mistfall и вирус ZMist)</li>
<li>Производим динамический анализ (трассировку, см. Tracer32), с учетом данных парсинга. В частности, перед трассировкой в начало всех подпрограмм вставляются точки останова (brrakpoint, INT3), для того, чтобы не потерять управление на callback'ах, вызываемых из не трассируемых библиотек.</li>
<li>Снова производим статический анализ, уже более качественный, с учетом данных трассировки.</li>
<li>Для улучшения качества анализа возможно повторение начиная с шага 3.</li>
<li>Комбинируем полученные данные.</li>
<li>Выбираем последовательно выполняемые места программы, в которые следует поместить вирусные блоки.</li>
<li>Вносим в программу изменения.</li>
<li>Заново собираем исполняемые файлы.</li>
</ol>
<p>В результате, за счет синтеза двух известных технологий, появляется возможность во много раз затруднить детектирование вируса в файле, и тем самым вбить еще один гвоздь в жопу касперскому.</p>
<p>Рассмотрим теперь дальнейшие перспективы интеграции вируса с кодом программы. Пусть вирусные блоки будут минимальной длины (всего несколько инструкций), но зато их будет много. Пусть эти N расшифровывающих блоков вируса, интегрированные в код программы, для успешной расшифровки должны будут выполниться не один за другим, а в некоторой определенной последовательности, много раз. Достигнуть этого можно, в процессе трассировки выявив циклы программы, с достаточно большим числом итераций, и затем интегрировав расшифровывающие вирусные блоки в такие циклы. В этом случае ситуация непредсказуемо усложняется, и детектировать вирус в файле становится возможным лишь по косвенным признакам, от которых несложно избавиться.</p>
<p>С другой стороны, такой вирус все еще можно будет детектировать посредством полной трассировки (или хорошей эмуляции) всей программы в течение достаточно большого времени.</p>
[<a style="" href="/lib/?lang=RU&amp;index=VT#vzo50">Вернуться к списку</a>] [<a href="/lib/vzo50.html#disqus_thread">Комментарии</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vzo50">de</a><a href="/lib/index.php?lang=en&amp;id=vzo50">en</a><a href="/lib/index.php?lang=es&amp;id=vzo50">es</a><a href="/lib/index.php?lang=it&amp;id=vzo50">it</a><a href="/lib/index.php?lang=fr&amp;id=vzo50">fr</a><a href="/lib/index.php?lang=pl&amp;id=vzo50">pl</a><a href="/lib/index.php?lang=ru&amp;id=vzo50">ru</a><a href="/lib/index.php?lang=ua&amp;id=vzo50">ua</a></div>
</body>
</html>
