<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Peter Ferrie 'You've got more M(1**)A(D)I(L+K)L' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Peter Ferrie"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Ferrie, Peter,You've got more M(1**)A(D)I(L+K)L, file, windows, files, viruses, characters, email, version, launched, exists, html, task, security, directory, mime, running"/>
<meta name="Description" content="Another day, another exploit is disclosed. A little over two months later, a virus using the exploit is discovered. It seems that some virus writers do read NTBugtraq. There is a new member of the W32/Chiton family. The author of the virus calls this one `W32/JunkHTMaiL', a variation of the name of the virus upon which it is based - W32/Junkmail (see VB, November 2002, p.10) - perhaps to draw attention to the self-executing HTML exploit which this virus uses to launch itself from email.When JunkHTMaiL is started for the first time, it decompresses and drops a standalone executable file that contains only the virus code, using a `fixed' (taking into account the variable name of the Windows directory) filename and directory.As with the other viruses in the family, this virus is aware of the techniques that are used against viruses that drop files, and will work around all of the countermeasures: if a file exists already, then its read-only attribute (if any) will be removed, and the file will be deleted. If a directory exists instead, then it will be renamed to a random name. The structure of the dropped file is the same as that used by W32/Junkmail. If the standalone copy is not running already, then the virus will run it now. The name of the dropped file is `ExpIorer.exe'. Depending on the font, the uppercase `i' may resemble a lowercase `L', making the viral process difficult to identify in the task list."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"0cf792405dcdf6fcb4ba4431ad1970bb65734ac6-1498757842-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/apf23.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>You've got more M(1**)A(D)I(L+K)L</h1><p><a href="/lib/?lang=en&amp;author=Ferrie%2C%20Peter">Peter Ferrie</a><br/> <em>Virus Bulletin, June 2003, pp.6-7</em><br/> <em>ISSN 0956-9979</em><br/> <em>June 2003</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/apf23.html';</script><img src="/img/pdf.gif" alt="PDF"/><a href="/lib/pdf/You%27ve%20got%20more%20M%281%2A%2A%29A%28D%29I%28L%2BK%29L.pdf">Download</a> PDF (26.86Kb) (You need to be registered on <a href="/forum">forum</a>)<br/>[<a style="" href="/lib/?lang=EN&amp;index=AN#apf23">Back to index</a>] [<a href="/lib/apf23.html#disqus_thread">Comments</a>]<br/> <form method="post" action=""><input type="hidden" name="pages" value="1"/><input type="submit" value="Turn on page numbers"/></form><address>
Peter Ferrie<br/>
Symantec Security Response, USA
</address>
<p>Another day, another exploit is disclosed. A little over two months later, a virus using the exploit is discovered. It seems that some virus writers do read <em>NTBugtraq</em>. There is a new member of the W32/Chiton family. The author of the virus calls this one `W32/JunkHTMaiL', a variation of the name of the virus upon which it is based - W32/Junkmail (see <em>VB</em>, November 2002, p.10) - perhaps to draw attention to the self-executing HTML exploit which this virus uses to launch itself from email.</p>
<p>When JunkHTMaiL is started for the first time, it decompresses and drops a standalone executable file that contains only the virus code, using a `fixed' (taking into account the variable name of the <em>Windows</em> directory) filename and directory.</p>
<p>As with the other viruses in the family, this virus is aware of the techniques that are used against viruses that drop files, and will work around all of the countermeasures: if a file exists already, then its read-only attribute (if any) will be removed, and the file will be deleted. If a directory exists instead, then it will be renamed to a random name. The structure of the dropped file is the same as that used by W32/Junkmail. If the standalone copy is not running already, then the virus will run it now. The name of the dropped file is `ExpIorer.exe'. Depending on the font, the uppercase `i' may resemble a lowercase `L', making the viral process difficult to identify in the task list.</p>
<h2>Hook, line, sinker</h2>
<p>After dropping the standalone copy, the virus alters the Registry in such a way that the virus will be run whenever an application is launched.</p>
<p>The virus alters the `Shell\Open\Command' keys for the `com', `exe', and `pif' extensions in both the `LocalMachine' and `CurrentUser' hives. Both hives are altered because, in <em>Windows 2000</em> and <em>XP</em>, the Current User values override the Local Machine values. The three extensions are altered because they are all associated with applications. In addition, the change makes removal of the virus more difficult - if the virus is removed before the Registry is restored, then applications will not be able to be launched easily. Fortunately, some improvisation allows for ways around this problem.</p>
<p>If the computer is running <em>Windows NT/2000/XP</em>, then the virus will add itself as a service. The virus does not start the service, perhaps because the standalone copy is running already, and <em>Windows</em> will perform that action anyway, when the computer is rebooted. If the computer is running <em>Windows 9x/Me</em>, the virus will place an undocumented value in an undocumented structure, with the result that the task is not displayed in the task list. This mimics the actions of the recently documented and already very well-known RegisterServiceProcess() API.</p>
<h2>It takes two to argue</h2>
<p>Whenever the standalone copy is executed, the virus will parse the command line to determine why it is running. The parsing is done in the platform-independent way that is favoured by the virus author - if the computer is running <em>Windows 9x/Me</em>, then the virus will use the ANSI APIs to examine characters; if the computer is running <em>Windows NT/2000/XP</em>, then the virus will use the Unicode APIs to examine characters. If there are arguments on the command line, then the virus assumes that it was launched via the Registry alteration, and will attempt to execute the application that is named in the first argument.</p>
<p>If there are no arguments on the command-line, then the virus assumes that it has been launched as the standalone copy, and will execute its main code. The main code begins by retrieving the addresses of the APIs that it requires and creating the threads that will allow the virus to perform several actions simultaneously.</p>
<p>The first thread runs once every hour. It will enumerate all drive letters from A: to Z:, looking for fixed and remote drives. If such a drive is found, then the virus will search in all subdirectories for files to infect. Files will be infected if they are <em>Windows</em> Portable Executable files for <em>Intel 386+</em> CPUs, and are not DLLs.</p>
<p>The method of infection is the same as for some of the other variants in the family - the virus will either append its data to the last section, or insert its data before the relocation table, and alter the entry point to point directly to the virus code. If files do not possess the infection criteria, the suffix of their name is checked against a list of files that might contain email addresses. The virus is interested in files whose suffix is `asp', `cfm', `css', or `jsp', or contains `php' or `htm'. If such a suffix is found, then the file is searched for a `mailto:' string, and the email address that follows is saved for later.</p>
<p>The second thread runs once every two hours. It will enumerate the network shares and attempt to connect to them. If the connection succeeds, then the virus will search all subdirectories for files to infect.</p>
<p>The third thread also runs once every two hours. It will attempt to connect to random IP addresses. There are two
 
routines for this action, one for ANSI platforms, and one for Unicode platforms. If the connection succeeds, then the virus will search in all subdirectories for files to infect.</p>
<p>The fourth thread is the one from which the virus gains its name. It runs once every four hours, and will send a single email to the last address that the virus found while searching for files to infect. The virus sends itself using the MIME message format, as described in RFC 1521, and carries an attachment using the MHTML document format, as described in RFC 2557.</p>
<p>While this should present no problems, it appears that a number of developers have overlooked one significant aspect of the formal BNF of, for example, the content of the MIME-Version field. This is that the colon and digits, etc., are separate tokens, and that no white space is required. The formal BNF for the content of the MIME-Version field looks like this:</p>
<pre>version := "MIME-Version" ":" 1*DIGIT "." 1*DIGIT</pre>
<p>and a typical MIME-Version declaration looks like this:</p>
<pre>MIME-Version: 1.0</pre>
<p>However, when considering the tokens individually, the result is that these are equivalent:</p>
<pre>
MIME-Version         :         1 .           0
MIME-Version:1.0
</pre>
<p>with the obvious problems for those parsers that don't expect white space to appear, or that require at least one space after the colon. The virus attacks the second assumption, by removing the space in all cases.</p>
<h2>Layer upon layer</h2>
<p><em>Microsoft</em> introduced the `Web Archive' format after the release of <em>Office 2000</em>. It is based on the MHTML standard, and resembles a MIME email file, complete with MIME-Version, a Content encoding field, and `attachments'.An unfortunate consequence of this choice is that such files, when sent as email attachments, can be encoded recursively. Thus, the beginning of such a file might look like this:</p>
<pre>
MIME-Version:1.0
CONTENT-LOCATION:FILE:///.EXE
CONTENT-TRANSFER-ENCODING:BASE64
</pre>
<p>However, after recursive encoding of the type implemented by the virus, it might look like this:</p>
<pre>
=4DI=6DE=2D=76=65=52s=49=6F=6E:1=28=43H=29.=30
=63ONT=45=4E=54=2D=4CO=63=61=54=69=4F=4E=3AFIL=65:/
/=2F=2E=45xe
=63=6Fn=74=45=6E=74-t=72=61=6E=53=46=45=72-
=65NcOd=49=6E=67=3A=62(=4B=7B=
)a=28=7B+=29s=28=45=29e6(=77Y)4
</pre>
<p>The top level is octet-encoding. It exists to support the sending of characters that are not within the acceptable ASCII range (i.e. foreign and reserved characters), however any character can be encoded with this method. If the octet-encoding is decoded, as will occur when an email program detaches the attachment, it might look like this:</p>
<pre>
MImE-veRsIon:1(CH).0
cONTENT-LOcaTiON:FILe:///.Exe
contEnt-tranSFEr-eNcOdIng:b(K{)a({+)s(E)e6(wY)4
</pre>
<p>Now we see the case inversion and comment insertion that was first demonstrated by W32/Junkmail.</p>
<h2>Not a bug, but a feature</h2>
<p>An email sent by the virus will have an attachment called Email.htm. This is a Web Archive file that has a script appended to it. When a file is passed to <em>Internet Explorer (IE)</em>, <em>IE</em> will search a large amount of that file for HTML code. This is, according to <em>Microsoft</em>, by design.</p>
<p>Thus, a MHTML file with a script appended to it can have that script executed, even though the file does not begin with the `&lt;HTML>' tag. The virus uses a script that requests IE to run the file that is located inside the same MHTML file. If the <em>IE</em> security settings allow the scripting of ActiveX controls that are not marked as safe, then the file will be launched without prompts, regardless of the zone in which it is executing. <em>Microsoft</em> has released a patch (MS03-014) which disables MHTML as a codebase source. The patch is described as applying to <em>Outlook Express</em>, however the file that does the work (inetcomm.dll) actually belongs to <em>Internet Explorer</em>.</p>
<h2>Conclusion</h2>
<p>The world of security and the world of viruses have become intertwined over the years, and so far we have been fairly lucky that, despite the full disclosure of many exploits, very few have been used in viruses. The successful virus requires knowledge and luck, and while we can't defend against luck, we can see that too much knowledge can be a bad thing.</p>
<table summary="W32/Chiton variant">
<tr><th colspan="2">W32/Chiton variant</th></tr>
<tr><th>Type:</th><td>Memory-resident parasitic appender/inserter, slow mailer.</td></tr>
<tr><th>Infects:</th><td><em>Windows</em> Portable Executable files.</td></tr>
<tr><th>Payload:</th><td>None.</td></tr>
<tr><th>Removal:</th><td>Delete infected files and restore them from backup.</td></tr>
</table>
 
[<a style="" href="/lib/?lang=EN&amp;index=AN#apf23">Back to index</a>] [<a href="/lib/apf23.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=apf23">de</a><a href="/lib/index.php?lang=en&amp;id=apf23">en</a><a href="/lib/index.php?lang=es&amp;id=apf23">es</a><a href="/lib/index.php?lang=it&amp;id=apf23">it</a><a href="/lib/index.php?lang=fr&amp;id=apf23">fr</a><a href="/lib/index.php?lang=pl&amp;id=apf23">pl</a><a href="/lib/index.php?lang=ru&amp;id=apf23">ru</a><a href="/lib/index.php?lang=ua&amp;id=apf23">ua</a></div>
</body>
</html>
