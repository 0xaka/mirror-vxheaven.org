<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Peter Ferrie, Péter Ször '64-bit rugrats' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Peter Ferrie, Péter Ször"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Ferrie, Peter; Ször, Péter,64-bit rugrats, exception, larry, instructions, filters, directory, round, relocation, handling, access, file, infection, global, method, instruction, entry"/>
<meta name="Description" content="On 26 May 2004, we received the first known virus for the 64-bit Windows operating system on the Intel Itanium platform. We decided to call it W64/Rugrat.3344.A.Just like some of its predecessors (specifically W32/Chiton - see VB, June 2002, p.4), Rugrat is aware of Thread Local Storage, helping it to make the first successful tip toe towards painless infection of Windows DLLs - at least in the .B variant of the virus."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"a8da8ee5a90d661ec5890a7cd2d2b954aad3de43-1498755417-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/apf43.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>64-bit rugrats</h1><p><a href="/lib/?lang=en&amp;author=Ferrie%2C%20Peter">Peter Ferrie</a>, <a href="/lib/?lang=en&amp;author=Sz%C3%B6r%2C%20P%C3%A9ter">Péter Ször</a><br/> <em>Virus Bulletin, Jul 2004, pp. 4-6</em><br/> <em>ISSN 0956-9979</em><br/> <em>July 2004</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/apf43.html';</script><img src="/img/pdf.gif" alt="PDF"/><a href="/lib/pdf/64-bit%20rugrats.pdf">Download</a> PDF (30.23Kb) (You need to be registered on <a href="/forum">forum</a>)<br/>[<a style="" href="/lib/?lang=EN&amp;index=AN#apf43">Back to index</a>] [<a href="/lib/apf43.html#disqus_thread">Comments</a>]<br/> <form method="post" action=""><input type="hidden" name="pages" value="1"/><input type="submit" value="Turn on page numbers"/></form>
<address>
Peter Ferrie and P&egrave;ter Sz&ouml;r
Symantec Security Response, USA
</address>
<ul>
<li><a href="#c1">Blast from the past</a></li>
<li><a href="#c2">Round and round</a></li>
<li><a href="#c3">Filters</a></li>
<li><a href="#c4">Touch and go</a></li>
<li><a href="#c5">Exception to the rule</a></li>
<li><a href="#c6">Globalisation</a></li>
<li><a href="#c7">Conclusion</a></li>
</ul>
<p>On 26 May 2004, we received the first known virus for the 64-bit <em>Windows</em> operating system on the <em>Intel Itanium</em> platform. We decided to call it W64/Rugrat.3344.A.</p>
<p>Just like some of its predecessors (specifically W32/Chiton - see <em>VB</em>, June 2002, p.4), Rugrat is aware of Thread Local Storage, helping it to make the first successful tip toe towards painless infection of <em>Windows</em> DLLs - at least in the .B variant of the virus.</p>
<h2><a name="c1"></a>Blast from the past</h2>
<p>As might be expected, the text in the virus body suggests that Rugrat and Chiton share the same author: `Shrug - roy g biv', who is now a member of the notorious 29A virus-writing group.</p>
<p>W64/Rugrat uses a fairly simple idea: take the 32-bit code and port it to 64 bits - but the devil is in the detail.</p>
<p>Writing assembly for the <em>Itanium</em> is not simply a case of an everyday port of a 32-bit C application to 64-bit, which even your grandmother could do with a little advice. This is in contrast to the impression we were given when <em>Microsoft</em> introduced the platform with a demonstration: "Here is Larry who ported a million lines of C code in two weeks!".</p>
<p>Obviously Larry was not the kind who used to cast his pointers with DWORDs in front. Larry probably did not need to port a GUI either, and he obviously was not interested in writing a memory scanner to scan the 64-bit address space for virus code. Larry needed just one thing: earplugs to reduce the ventilation noise coming out of the strange box that he first mistook for an atomic reactor. But the earplugs were disposed of a long time ago, along with the beta boards, and nowadays it is the beautiful <em>Itanium2</em> that resides under Larry's desk.</p>
<p>While Larry did not care to open the guide for the <em>Itanium</em> instruction set, `roy g biv' did. One question comes to mind: might `roy g biv' have owned an <em>IA64</em> box? He probably did, but he could equally have used an emulator on a bulked up PC.</p>
<p><em>Intel</em>'s IA64 assembly code is designed for explicit parallelism, so coding well in <em>IA64</em> assembly code requires the ability to `think in parallel'. Unfortunately, when this is done well, the resulting code can be very difficult to read, especially when the virus code is further obfuscated. So, in turn, we started to think in parallel to share the fun of the analysis of this new kid on the block.</p>
<h2><a name="c2"></a>Round and round</h2>
<p>The first time Rugrat is executed, it checks the event that caused its execution. The virus replicates only during the DLL_PROCESS_DETACH event, which occurs when an application is exiting. The reason that Rugrat does this could be because an application taking an extended period of time to terminate is far less noticeable than an application taking an extended period of time to start.</p>
<p>During Thread Local Storage events, it is NTDLL.DLL (the NATIVE API) that calls the Thread Local Storage entry point. That call leaves in the B0 register of <em>Itanium</em> processors a pointer into the NTDLL.DLL address space. The virus uses this fact to gain access to NTDLL.DLL, in order to retrieve the addresses of the API functions that it requires.</p>
<p>The virus uses a CRC method to match the API names. The use of the CRC method means that the API names are not visible in the virus code, while also reducing the size of the virus code.</p>
<p>The virus uses a few Win64 APIs from three different libraries: NTDLL.DLL, SFC_OS.DLL and KERNEL32.DLL. From NTDLL.DLL it picks LdrGetDllHandle(), RtlAddVectoredExceptionHandler() and RtlRemoveVectoredExceptionHandler(). The virus supports vectored exception handling to avoid crashing during infections. The use of LdrGetDllHandle() makes it simpler to gain access to other modules. From SFC_OS.DLL, Rugrat uses the SfcIsFileProtected() function to avoid infecting executables that are protected by the System File Checker (SFC).</p>
<p>The following 16 functions are used from KERNEL32.DLL to implement a standard direct action file infection of an <em>IA64</em> Portable Executable image using file mapping:</p>
<ul style="list-style: none;">
<li>CreateFileMappingA()</li>
<li>GlobalAlloc()</li>
<li>CreateFileW()</li>
<li>GlobalFree()</li>
<li>CloseHandle()</li>
<li>LoadLibraryA()</li>
<li>FindFirstFileW()</li>
<li>MapViewOfFile()</li>
<li>FindNextFileW</li>
<li>SetCurrentDirectoryW()</li>
<li>FindClose()</li>
<li>SetFileAttributesW()</li>
<li>GetFullPathNameW()</li>
<li>SetFileTime()</li>
<li>GetTickCount()</li>
<li>UnmapViewOfFile()</li>
</ul>
<p>As expected the virus will set the host's time/date stamp back after each infection, as well as its attributes, which it clears before infection.</p>
<p>Rugrat shows one major functional difference from Chiton - Rugrat uses only Unicode functions, and does not support ANSI functions, perhaps because 64-bit <em>Windows</em> is based on <em>Windows NT</em>, which is entirely Unicode under the hood.
 
The virus searches for files in the current directory and all subdirectories, using a linked list instead of a recursive function. This is important from the point of view of the virus author, because the .B variant of Rugrat infects DLLs, whose stack size can be very small.</p>
<h2><a name="c3"></a>Filters</h2>
<p>Files are examined for their potential to be infected, regardless of their suffix, and will be infected if they pass a very strict set of filters. The first of these filters is the support for the System File Checker that exists in <em>Windows XP/2003</em> (<em>Note the SFC_OS module name</em>). The remaining filters include the condition that the file being examined must be a character mode or GUI application for the <em>Intel IA64</em> CPU, that the file must have no digital certificates, and that it must have no bytes outside of the image.</p>
<p>The <em>IA64</em> CPU introduces the concept of `predication' to the execution flow, which allows a programmer to remove certain branches from the code, and to replace a block with a predicate check instead. A sample check for the file type might look like this:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; ld2 &nbsp; &nbsp; r30 = <span style="color: black;">&#91;</span>r32<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; r31 = <span style="color: #ff0000;">0x5A4D</span><span style="color: black; font-style: italic;">;;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span><span style="color: #339933;">.</span>eq&nbsp; p1 = r30<span style="color: #339933;">,</span> r31<br/>
<span style="color: black;">&#40;</span>p1<span style="color: black;">&#41;</span>&nbsp; &nbsp; ld4 &nbsp; &nbsp; r30 = <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">r8</span><span style="color: black;">&#93;</span><br/>
<span style="color: black;">&#40;</span>p1<span style="color: black;">&#41;</span>&nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; r31 = <span style="color: #ff0000;">0x4550</span><span style="color: black; font-style: italic;">;;</span><br/>
<span style="color: black;">&#40;</span>p1<span style="color: black;">&#41;</span>&nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span><span style="color: #339933;">.</span>eq&nbsp; p1 = r30<span style="color: #339933;">,</span> r31<br/>
&nbsp;</div>
<p>The first `cmp' instruction sets the P1 register only if the condition is met. If it is not met, any instruction that is predicated by the P1 register will be ignored by the processor. The filtering code could be considered `predication abuse', since it contains more than 30 predicated instructions in a row, including predicated compares, which reuse active predicate registers. The infection code contains several such blocks.</p>
<h2><a name="c4"></a>Touch and go</h2>
<p>When a file that meets the infection criteria is found, it will be infected. If relocation data exist at the end of the file, the virus will move the data to a larger offset in the file, and place its code in the gap that has been created. If there are no relocation data at the end of the file, the virus code will be placed here. For the .A variant of Rugrat, which does not infect DLLs, the relocation data check is almost never used, since the majority of executable files do not contain relocation data (a `global pointer' is used instead, see below). The .B variant of Rugrat infects DLLs in the same way as for applications, meaning that even `resource-only' DLLs that have no main entry point can still be a source of infection, since the Thread Local Storage entry point will still be called.</p>
<p>The virus carries its own Thread Local Storage directory, which will be used if the target file contains no directory at all. The virus carries its own callback array for those hosts whose Thread Local Storage directory contains no callbacks.</p>
<p>When it encounters a host that already has a Thread Local Storage directory containing callbacks, the virus will save the address of the first callback and replace it with the address of the virus code.</p>
<p>Once the infection is complete, the virus will calculate a new file checksum, if one existed previously, before continuing to search for more files.</p>
<p>When the file searching has finished, the virus will allow the application to exit by forcing an exception to occur. This technique appears twice in the virus code, and is an elegant way to reduce the code size, in addition to functioning as an effective anti-debugging method.</p>
<p>Since the virus has protected itself against errors by installing a Vectored Exception Handler, the simulation of an error condition results in the execution of a common block of code to exit a routine. This avoids the need for separate handlers for successful and unsuccessful code completion. The Vectored Exception Handling is a heap-based dynamic exception-handling mechanism of newer <em>Windows</em> releases, which provides an alternative to the Structured Exception Handling, a stack-based mechanism. SEH is more vulnerable to exploitation (see VB, September 2001, p.4) than VEH, and VEH has some other benefits such as up-front exception control. Nonetheless, the exploitation of VEH by attackers is also becoming common in the field.</p>
<h2><a name="c5"></a>Exception to the rule</h2>
<p>The cause of the exception is more subtle in Rugrat than in Chiton. On the x86 CPU, exception-causing instructions such as INT 3 can appear anywhere in the code, without restriction. On the <em>IA64</em> CPU, though, instructions are placed in `slots', and collected in `bundles' that execute in parallel, so an exception-causing instruction in a bundle that contains other instructions could cause those instructions to be interrupted. Additionally, when resuming from an exception handler, execution continues from the slot in which the exception occurs, which results in the instructions in the earlier slots of the same bundle not being executed.</p>
<p>These two restrictions are the likely reason why the virus author chose an instruction that is always placed in the first slot of a bundle. The instruction itself, LD1 R8 = [R0], also looks legitimate, until it is understood that the R0 register
 
always contains the value 0, and attempting to access the 0th byte of memory always causes an exception.</p>
<h2><a name="c6"></a>Globalisation</h2>
<p>The <em>IA64</em> uses a global pointer to access variables. This avoids the costly application of relocation items when a file is loaded to an address other than its default virtual address. This also makes the <em>IA64</em> code a little more compact, although it still appears large to eight-bit eyes.</p>
<p>The global pointer value can be retrieved from the Portable Executable GlobalPtr header field. Every structure - exported function addresses, Vectored Exception Handlers, even the Thread Local Storage Callback itself - is required to be in the form of a virtual address followed by a global pointer value, and the virus supplies these structures correctly. This structure is called a PLABEL_DESCRIPTOR, and the compiler and the debugger do a perfect job of hiding it, so guys like Larry need not worry about it.</p>
<h2><a name="c7"></a>Conclusion</h2>
<p>The adoption of <em>IA64</em> machines appears to be slow. The lack of <em>IA64</em> machines restricts the scope of any potential outbreak, and this virus was simply a proof that it was possible. What can we expect next? A 32-bit and 64-bit cross-infector seems obvious.</p>
<p>Additionally, the news of <em>AMD64</em> is spreading, and systems are sold for as little as $700, "introducing the only Windows-compatible 64-bit processor and the smooth transition to 64 bits". <em>Microsoft</em> will be ready with the <em>AMD64</em> release by the end of this year. How much smoother could the transition be for the virus writers?</p>
<blockquote>
<p><em>Chuckie: "So, we got a baby now."</em></p>
<p><em>Lillian DeVille: "I wished we'd a talked about it first. I don't know if I'm ready."</em></p>
<p><em>Rugrats</em>, Klasky Csupo Inc.</p>
</blockquote>
<p>Let's hope that this baby doesn't grow up.</p>
<table summary="W64/Rugrat.3344!IA64">
<tr><th colspan="2">W64/Rugrat.3344!IA64</th></tr>
<tr><th>Type:</th><td>Direct-action parasitic appender/inserter.</td></tr>
<tr><th>Infects:</th><td>Windows IA64 PE files.</td></tr>
<tr><th>Payload:</th><td>None.</td></tr>
<tr><th>Removal:</th><td>Delete infected files and restore them from backup.</td></tr>
</table>
 
[<a style="" href="/lib/?lang=EN&amp;index=AN#apf43">Back to index</a>] [<a href="/lib/apf43.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=apf43">de</a><a href="/lib/index.php?lang=en&amp;id=apf43">en</a><a href="/lib/index.php?lang=es&amp;id=apf43">es</a><a href="/lib/index.php?lang=it&amp;id=apf43">it</a><a href="/lib/index.php?lang=fr&amp;id=apf43">fr</a><a href="/lib/index.php?lang=pl&amp;id=apf43">pl</a><a href="/lib/index.php?lang=ru&amp;id=apf43">ru</a><a href="/lib/index.php?lang=ua&amp;id=apf43">ua</a></div>
</body>
</html>
