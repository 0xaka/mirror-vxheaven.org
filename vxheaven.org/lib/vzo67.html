<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title> Z0mbie 'Автоматизация обратного проектирования (технология недетектируемого вируса)' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Z0mbie"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Z0mbie,Автоматизация обратного проектирования (технология недетектируемого вируса), инструкции, push, пересчитываем, метки, список, программы, разбираем, данных, перехода, dword, изменение, дворд, показывает, заголовок, анализа"/>
<meta name="Description" content="Наши усилия направлены на то, чтобы научиться модифицировать исполняемые программы (в формате PE) так, чтобы поиск внесенных изменений занимал максимум времени.Под модификацией понимаем дополнение программы определенным кодом, скажем, вирусом. Очевидно, что само тело вируса должно быть зашифровано. Полиморфный же расшифровщик будет интегрирован с кодом программы.Исходя из этого, задача разбивается на 3 части, или же три глобальных вопроса: что?, куда? и как?."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"471d2d3850da54f05c33d41cdd6e7e20df248e60-1498757775-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vzo67.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Автоматизация обратного проектирования (технология недетектируемого вируса)</h1><p><a href="/lib/?lang=ru&amp;author=Z0mbie"> Z0mbie</a><br/> <em><a href="/vx.php?fid=464#f464">Total Zombification [1]</a></em><br/> <em>Январь 2001</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vzo67.html';</script>[<a style="" href="/lib/?lang=RU&amp;index=VT#vzo67">Вернуться к списку</a>] [<a href="/lib/vzo67.html#disqus_thread">Комментарии</a>]<br/> 
<ul>
<li><a href="#c1">Теория</a></li>
<li><a href="#c2">Проблемы дизассемблирования</a></li>
<li><a href="#c3">Практика</a></li>
</ul>
<p>Наши усилия направлены на то, чтобы научиться модифицировать исполняемые программы (в формате PE) так, чтобы поиск внесенных изменений занимал максимум времени.</p>
<p>Под модификацией понимаем дополнение программы определенным кодом, скажем, вирусом. Очевидно, что само тело вируса должно быть зашифровано. Полиморфный же расшифровщик будет интегрирован с кодом программы.</p>
<p>Исходя из этого, задача разбивается на 3 части, или же три глобальных вопроса: <strong>что?, куда?</strong> и <strong>как?</strong>.</p>
<p><strong>Что</strong> - это вирусные инструкции, которыми будет дополнен инфицируемый PE файл. О том, какими могут быть эти инструкции, рассказано в статье про метаморфизм и показано в кодогенераторе.</p>
<p><strong>Куда</strong> - это вопрос о том, в какие места программы вставлять инструкции расшифровщика, и как определять эти места. В принципе, это относительно просто; более того, как раз эта часть возлагается на пользователя движка.</p>
<p>В этой же статье будет показано, <strong>как</strong> между двумя произвольными инструкциями программы вставить инструкции расшифровщика, то есть, другими словами, как разобрать, изменить и заново собрать всю программу.</p>
<h2><a name="c1"></a>Теория</h2>
<p>Нашей задачей является вставить между инструкциями PE файла свои собственные. Но из-за того, что код и данные в файле могут быть по-всякому связаны друг с другом, изменение кода повлечет за собой изменение всех связей. Однако, изменение одних связей влечет за собой изменение других, и так далее, пока значимая часть файла не будет изменена.</p>
<p>Пример: вставив в середину файла инструкцию, мы изменим смещения всех меток, идущих после этой инструкции. А изменив смещение некоторой метки в коде, необходимо поправить все команды перехода на эту метку. В процессе такой правки, возможно, увеличатся длины некоторых команд условного перехода, что повлечет за собой изменение смещений меток, идущих после этих команд, и так далее.</p>
<p>Связи между элементами файла бывают не только абсолютные (смещения), но и относительные (команды перехода), и нам необходимо все их выявить. Выявить абсолютные связи можно посредством анализа структуры PE файла, включая сюда анализ таблицы фиксапов (релокаций). Для нахождения относительных смещений требуется разобрать весь код, встречающийся в программе, на отдельные инструкции.</p>
<p>Исходя из сказанного, необходимо разобрать весь файл в некоторую легко изменяемую сущность, изменить ее, и собрать файл заново.</p>
<p>Кроме всего прочего, наш алгоритм должен быть оформлен в виде универсального движка.</p>
<p>То есть, в идеале, я предлагаю вам средство, позволяющее легко модифицировать структуру PE файла, и чем больше разных методов модификации этой структуры будет придумано, тем лучше. Кто-то раскидает декриптор по всему файлу, кто-то интегрирует инструкции декриптора с инструкциями файла, и т.п.</p>
<p>Итак, нашу задачу можно разбить на 5 этапов:</p>
<ol>
<li>Загружаем PE файл в память по виртуальным адресам; создаем таблицу флагов и выставляем в ней биты, указывающие, являются ли соответствующие дворды указателями/длинами, и какими. То есть проводим начальный анализ структуры файла.</li>
<li>Дизассемблируем файл (находим и разбиваем код на инструкции), попутно заполняя таблицу флагов новой информацией об указателях. Здесь есть такой ньюанс, что при дизассемблировании можно ошибиться, перепутав код и данные. Такая ошибка фатальна, поэтому двойственные ситуации необходимо исключить. Если же выяснить отношение некоторого участка файла к коду или к данным невозможно, файл обрабатывать не следует.</li>
<li>Представляем файл в виде списка из: инструкций, кусков данных, меток и указателей. То есть от бинарного кода переходим чуть ближе к исходнику. Такой список создается исключительно из-за легкости манипулирования его элементами.</li>
<li>Вызываем юзерский мутатор (внешний по отношению к движку), который извращает список, например всовывая куски сгенеренного декриптора между инструкциями файла.</li>
<li>Собираем файл из списка; заново генерим таблицу фиксапов; при увеличении длин условных переходов пересчитываем все смещения в файле; пересчитываем контрольную сумму файла.</li>
</ol>
<h2><a name="c2"></a>Проблемы дизассемблирования</h2>
<p>На самом деле, конечно, все обстоит много хуже чем кажется: кроме описанных выше шагов есть еще куча мелочей, каждая из которых влияет на работоспособность программы. Но основная трудность, естественно, заключается в дизассемблировании. Ведь мы не обладаем возможностями, например, иды -- ибо наш вирус ограничен десятками килобайт.</p>
<p>А проблема дизассемблирования вот в чем: у нас есть дворды, про которые известно, что они фиксапы. Пусть такой дворд показывает в программу, на какую-то метку. А больше на эту метку не показывает никто. Вопрос: как узнать, находится ли по этой метке код (какая-то процедура), либо это данные?</p>
<p>Ошибка влечет за собой следующее: код, принятый за данные, не будет пофиксен, так что когда он получит управление, сразу произойдет глюк. Ибо фиксить в этом коде надо jxx, call и т.п. Если же, наоборот, данные будут приняты за код, и в них подобная инструкция будет пофиксена, то это тоже чревато глюком.</p>
<p>Поэтому необходимо научиться безошибочно отличать данные от кода. Некоторые библиотечные процедуры можно было бы найти по сигнатурам, но у нас нет таких ресурсов. Можно было бы рассматривать jmptable'ы, но это помогает лишь частично.</p>
<p>Можно было бы работать только с файлами определенного вида, а именно, такими, в которых в кодовой секции находится только код и ничего больше. Но это как раз то, чего не хотелось бы делать. Ведь нам надо, чтобы антивирусы проверяли <strong>каждый</strong> файл по пол-часа. Да и мало таких файлов.</p>
<p>Короче говоря, все ошибки в рекомпиляции файла возникают из-за неправильного дизассемблирования, а именно -- из-за описанной выше проблемы. Выхода два: ограничить множество обрабатываемых файлов, либо насколько это возможно улучшить дизассемблер и надеяться на удачу.</p>
<h2><a name="c3"></a>Практика</h2>
<p>Далее привожу краткое описание всех шагов, необходимых для рекомпиляции файла.</p>
<ul>
<li>проверяем PE файл на валидность (наличие таблицы фиксапов и т.п.)</li>
<li>выделяем память под виртуальный образ файла в памяти и под флаги на каждый байт образа файла</li>
<li>загружаем по виртуальным адресам:
<ol>
<li>досовскую часть и PE заголовок файла</li>
<li>секции файла</li>
</ol></li>
<li>разбираем PE заголовок, анализируем все его указатели и длины, помечаем начала и концы секций как метки и т.п.</li>
<li>разбираем импорты</li>
<li>разбираем экспорты</li>
<li>разбираем фиксапы</li>
<li>разбираем ресурсы</li>
<li>ищем в файле начала процедур по сигнатурам (типа push ebp/mov ebp,esp) и помечаем их для-последующего-анализа</li>
<li>помечаем точку входа</li>
<li>дизассемблируем файл, алгоритм описан в статье "о пермутации"; однако, есть пара отличий: когда кончаются все помеченные-для-последующего-анализа метки, мы ищем метки-на-которые-ссылаются-указатели, и проверяем, не являются ли они кодом. (см. ниже)</li>
<li>создаем список из опкодов, меток, указателей и т.п. заметим, что в этом списке уже будут объекты нулевой длины (метки), то есть происходит переход к более высокому уровню абстракции; по сути этот список -- своеобразное представление исходника. после перехода от линейных массивов к списку, массивы больше не нужны.</li>
<li>изменяем список; во время отладки я вставлял NOP'ы между всеми инструкциями файла</li>
<li>вычисляем новые виртуальные адреса для всех записей списка</li>
<li>пересчитываем таблицу фиксапов</li>
<li>пересчитываем значения указателей (т.е. rva, фиксапов и относительных смещений условных переходов); если некоторые условные переходы пришлось увеличить, то повторяем все с пересчета виртуальных адресов</li>
<li>ассемблируем список (собираем все данные в один массив)</li>
<li>записываем файл на диск</li>
<li>дописываем к концу файла оверлей, если он был</li>
<li>пересчитываем контрольную сумму, если она была ненулевая</li>
</ul>
<p>Что означают фразы типа "разбираем PE заголовок" / "разбираем импорты"? Это значит, что мы выделяем среди них метки, указатели и другие специальные объекты и выставляем для них во флагах соответствующие биты. Например, байт по адресу pe_header+28h (28h=EntryPointRva) поимеет флаги типа FLAG_DWORD и FLAG_RVA, а тот адрес, на который он показывает, будет обозначен как FLAG_LABEL и FLAG_CREF.</p>
<p>Какие специальные объекты будут присутствовать в списке?</p>
<ol>
<li>Метки, то есть то, на что ссылаются RVA и FIXUP'ы.</li>
<li>RVA, то есть дворд, который указывает на метку.</li>
<li>FIXUP, то есть дворд, такой же как RVA, но + IMAGEBASE, притом адрес должен быть занесен в таблицу фиксапов.</li>
<li>так называемая DELTA, то есть разница между адресами двух меток.</li>
<li>инструкция</li>
<li>блок данных</li>
</ol>
<p>Теперь о том, как мы отличаем код от данных. Напомню, что мы рассматриваем адрес на который есть ссылки только через указатели (rva и fixup'ы), но нет ссылок через call/jmp. Итак, берем предполагаемую процедуру и разбираем ее по одной инструкции. Для каждой инструкции проверяем, не является ли она глючной, типа 00 00, FF FF, F4 (hlt), CD (int), и т.п., то есть таким опкодом, который в процедурах PE файлов не встречается. Если какой-либо из байтов предполагаемой инструкции содержит флаги типа "метка" или "данные", то это не процедура. Если инструкция имеет относительный адрес (jmp,call,jxx,jecxz,...), то он должен показывать на что-нибудь приличное, то есть не в блок данных и не в середину другой инструкции. Повторяются же такие проверки до тех пор, пока не будет найден RET или JMP.</p>
<p>Однако, есть и такие ситуации, когда отличить код от данных достаточно сложно. Например, такой объект, как метка (label), вроде бы не может присутствовать в середине инструкции, сгенеренной hll компилятором. Но вот - нихрена подобного. Очень даже может. Рассмотрим типичный случай.</p>
<pre class="source">
	avpbase.dll:
	100050D3	83E904		sub	ecx, 4
	100050D6	720C		jb	100050E4
	100050D8	83E003		and	eax, 3
	100050DB	03C8		add	ecx,eax
	100050DD	FF2485F0500010	jmp	dword ptr [100050F0+eax*4] (1)
	100050E4	FF248DE8510010	jmp	dword ptr [100051E8+ecx*4]
	100050EB	90		nop
	100050EC	FF248D6C510010	jmp	dword ptr [1000516C+ecx*4] (2)
	100050F3	90		nop
	100050F4	00510010	dd	10005100
	100050F8	2C510010	dd	1000512C
</pre>
<p>Как видно, адрес 100050F0 находится в середине инструкции (2), и в то же время используется в инструкции (1). Почему так происходит, догадаться несложно. В результате, о инструкции (2) нельзя с полной уверенностью сказать, является ли она кодом или данными. То есть, автоматически нельзя определить, было ли в исходнике написано 100050F4 - 4 или 100050EC + 4. Короче говоря, нет возможности пофиксить такой поинтер, и файл придется оставить в покое.</p>
<p>Или вот, замечательный пример от дяди Рошаля.</p>
<pre class="source">
	FAR.EXE:
	004474D8	B8E1C24200	mov	eax,0042C2E1	; ==42C350-6Fh ; (1)
	004474DD	6A00		push	00
	004474DF	6800000100	push	00010000
	004474E4	83C06F		add	eax, 6F		; ==111
	004474E7	50		push	eax
	004474E8	E8AF180100	call	00458D9C
	...
	0042C2DB	E8B0450200	call	00450890
	0042C2E0	83C408		add	esp, 08		; (2)
	0042C2E3	8D9500FFFFFF	lea	edx,[ebp][0FFFFFF00]
	...
	0042C350	55		push	ebp
	0042C351	8BEC		mov	ebp, esp
	0042C353	833D5054460003	cmp	d,[000465450], 03
</pre>
<p>И, в дополнение ко всему прочему, бывает еще одна хуевая фишка. Это куски 16-битного кода в 32-битных приложениях, типа антивирусов и форматеров. Со всеми проистекающими отсюда глюками.</p>
[<a style="" href="/lib/?lang=RU&amp;index=VT#vzo67">Вернуться к списку</a>] [<a href="/lib/vzo67.html#disqus_thread">Комментарии</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vzo67">de</a><a href="/lib/index.php?lang=en&amp;id=vzo67">en</a><a href="/lib/index.php?lang=es&amp;id=vzo67">es</a><a href="/lib/index.php?lang=it&amp;id=vzo67">it</a><a href="/lib/index.php?lang=fr&amp;id=vzo67">fr</a><a href="/lib/index.php?lang=pl&amp;id=vzo67">pl</a><a href="/lib/index.php?lang=ru&amp;id=vzo67">ru</a><a href="/lib/index.php?lang=ua&amp;id=vzo67">ua</a></div>
</body>
</html>
