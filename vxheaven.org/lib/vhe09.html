<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title> herm1t 'Inversing a random numbers' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="herm1t"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, herm1t,Inversing a random numbers, uint, cdot, memory, check, pseudo, common, random, generators, modulus, text, inverse, multiplicative, sequence, seed, xgcd"/>
<meta name="Description" content="It is desireable feature for a polymorphic virus to avoid linear memory access during decryption. In 2000 The Mental Driller proposed an algorithm, known as PRIDE [1] which could easily produce a large number of permutations. In this paper I would present another technique to randomize the memory access within decryption loop, based on the linear and inversive congruential random numbers generators which properties are well characterized."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"d31b08cb6f88f977018c1576e8bf5e20de8e27f5-1498755116-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vhe09.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Inversing a random numbers</h1><p><a href="/lib/?lang=en&amp;author=herm1t"> herm1t</a><br/> <em><a href="/vx.php?fid=1940#f1940">Virus Writing Bulletin [1]</a></em><br/> <em>January 2011</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vhe09.html';</script>[<a style="" href="/lib/?lang=EN&amp;index=VT#vhe09">Back to index</a>] [<a href="/lib/vhe09.html#disqus_thread">Comments</a>]<br/> <form method="post" action="">
<img src="/img/cache/0b9fd596a90421f9f1f68a9760275737.gif" alt="\text{T_EX size}" valign="middle"/>
<select name="TeX_size"><option value="-2">-2</option><option value="-1">-1</option><option value="0" selected="selected">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option> </select>
<input type="submit" value="Scale"/>
</form>
<address>
<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="127a77607f236652646a3c7c77667e676a3c7d6075">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script><br/>
<a href="http://vx.netlux.org/herm1t/">http://vx.netlux.org/herm1t/</a>
</address>
<ul>
<li><a href="#c0">Abstract</a></li>
<li><a href="#c1">Introduction</a></li>
<li><a href="#c2">Getting to the point</a></li>
<li><a href="#c3">Getting the inverse</a></li>
<li><a href="#c4">References</a></li>
</ul>
<h2><a name="c0"></a>Abstract</h2>
<p>It is desireable feature for a polymorphic virus to avoid linear memory access during decryption. In 2000 The Mental Driller proposed an algorithm, known as PRIDE [1] which could easily produce a large number of permutations. In this paper I would present another technique to randomize the memory access within decryption loop, based on the linear and inversive congruential random numbers generators which properties are well characterized.</p>
<h2><a name="c1"></a>Introduction</h2>
<p>Several years ago <em>whale</em> asked me is it possible to construct a pair of pseudo-random numbers generators which could produce the same sequence in a direct and reverse order [2]. At that time I was unable to answer the question, and suggested to generate a pseudo-random sequence in <em>encryption</em> part of the engine, store it to memory and use the resulting array from top to down; but when I recently flipped through the archives looking for some e-mail address I saw this conversation and decided to check the topic. I quickly found the effective and extremely simple solution to generate a pretty large number of RNGs with desired properties.</p>
<h2><a name="c2"></a>Getting to the point</h2>
<p>The oldest and most widely used type of RNG algorithms is <em>linear congruential generator</em>:</p>
<p><img src="/img/cache/b00e3586bda7a3a71f291398c376329e.gif" alt="x_{i+1} = a \cdot x_i + c\ \text{mod}\ m" valign="middle"/></p>
<p>where <em>m</em> is the "modulus", <em>a</em> - "multiplier", <em>c</em> - "increment" and <img src="/img/cache/3e0d691f3a530e6c7e079636f20c111b.gif" alt="x_0" valign="middle"/> is the "seed" are values that specify the generator. For example, many of the Z0MBiE's viruses including Mistfall [3] are using LCG with a = 214013, c = 2531011, <img src="/img/cache/8e681a99dcfa49e408b6a969dc08b1d0.gif" alt="m = 2^{32}-1" valign="middle"/> (modulus with the size of machine word will simplify the arithmetics), while the initial seed for a generator being choosed randomly (virus writes prefer to seed the generators with the values returned by <tt>GetTickCount()</tt> function and/or <tt>RDTSC</tt> instruction.</p>
<p>There are inverse of LCG which is called <em>inversive congruential generator</em>:</p>
<p><img src="/img/cache/d527578bb0cb8193fb291ab253b89850.gif" alt="x_{i+1} = a^{-1}\cdot x_i + c\ \text{mod} m" valign="middle"/></p>
<p>where <img src="/img/cache/3b337a2c86bbc018e9a1090ea01f130c.gif" alt="a^{-1}" valign="middle"/> is a <em>modular multiplicative inverse</em> of <em>a</em> modulo <em>m</em>:</p>
<p><img src="/img/cache/825cf90f71dc3c30637fc774daf62ec0.gif" alt="a \cdot a^{-1}\text{ (mod m)} = 1" valign="middle"/></p>
<p>and that is exactly what we need to reverse the sequence of "random" numbers.</p>
<p>Suppose that we have <img src="/img/cache/d80373170af8488ecb0389716ff06062.gif" alt="x_{n+1} = x_n \cdot a\text{ mod }m" valign="middle"/> and multiply it by <img src="/img/cache/3b337a2c86bbc018e9a1090ea01f130c.gif" alt="a^{-1}" valign="middle"/>, <img src="/img/cache/068cf6707e7d7f635453c457f171d90d.gif" alt="x_n \cdot a \cdot a^{-1}" valign="middle"/>, since <img src="/img/cache/b68c33b27afa5422ccfed172860022a4.gif" alt="a \cdot a^{-1} = 1" valign="middle"/> this expression is equal to <img src="/img/cache/5bef92b1854f9c388d11bfbb1720c05d.gif" alt="x_n" valign="middle"/>. All neccessary details once could find in Wiki [4].</p>
<h2><a name="c3"></a>Getting the inverse</h2>
<p>The multiplicative inverse for the given <em>a</em> and <em>m</em> exists <strong>if, and only if</strong>, <em>a</em> and <em>m</em> are coprime (which is to say they have no common factors or that their greatest common divisor is equal to 1). Sadly, the number <img src="/img/cache/23960e7bd640dd34bec78ed78df96b74.gif" alt="2^{32}-1" valign="middle"/> is composite (product of 3, 5, 17, 257, 65537), so if we choose it as a modulus, we'll need to test all possible values of <em>a</em> whether it is divisible by the factors listed above. To avoid the tests we could select the prime <em>m</em> which mean that we could use any value of <em>a</em> and it will have no common divisors with <em>m</em> by definition.</p>
<p>Surely it will reduce the overall number of possible generators, but the remaining generators are still numerous. We could even estimate our losses. The prime counting function <img src="/img/cache/e5cb16c20d9f01bbbfe8f299e28d1f4b.gif" alt="\pi(x)" valign="middle"/> proposed by Gauss and Legendre approximates the number of primes below any given <em>x</em> as <img src="/img/cache/f52ecec5fab75d3ce28b72d4a21da414.gif" alt="\frac{x}{\ln x}" valign="middle"/>. So if we choose our <em>m</em> from 1024...2048 we'll get about 120 possible values for <em>m</em>. Since those numbers are small, this value could be counted exactly, but that's not the issue. The point here is that we'll get enough candidates anyway.</p>
<p>Finally, we could find the inverse by using <em>extended Euclidian algorithm</em>:</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #993333;">uint32_t</span> xgcd<span style="color: black;">&#40;</span><span style="color: #993333;">uint32_t</span> a<span style="color: #339933;">,</span> <span style="color: #993333;">uint32_t</span> b<span style="color: black;">&#41;</span><br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #993333;">uint32_t</span> x<span style="color: #339933;">,</span> y<span style="color: #339933;">,</span> u<span style="color: #339933;">,</span> v<span style="color: #339933;">,</span> m<span style="color: #339933;">,</span> n<span style="color: #339933;">,</span> q<span style="color: #339933;">,</span> r<span style="color: #339933;">,</span> b0<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; x <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span> y <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span> u <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span> v <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span> b0 <span style="color: #339933;">=</span> b<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">while</span> <span style="color: black;">&#40;</span>a <span style="color: #339933;">!=</span> <span style="color: #0000dd;">0</span><span style="color: black;">&#41;</span> <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; q <span style="color: #339933;">=</span> b <span style="color: #339933;">/</span> a<span style="color: #339933;">;</span>&nbsp; &nbsp; &nbsp; r <span style="color: #339933;">=</span> b <span style="color: #339933;">%</span> a<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; m <span style="color: #339933;">=</span> x <span style="color: #339933;">-</span> u <span style="color: #339933;">*</span> q<span style="color: #339933;">;</span>&nbsp; n <span style="color: #339933;">=</span> y <span style="color: #339933;">-</span> v <span style="color: #339933;">*</span> q<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">while</span> <span style="color: black;">&#40;</span>m <span style="color: #339933;">&gt;</span> b0<span style="color: black;">&#41;</span>&nbsp; m <span style="color: #339933;">+=</span> b0<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">while</span> <span style="color: black;">&#40;</span>n <span style="color: #339933;">&gt;</span> b0<span style="color: black;">&#41;</span>&nbsp; n <span style="color: #339933;">+=</span> b0<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; b <span style="color: #339933;">=</span> a<span style="color: #339933;">;</span>&nbsp; a <span style="color: #339933;">=</span> r<span style="color: #339933;">;</span>&nbsp; x <span style="color: #339933;">=</span> u<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; y <span style="color: #339933;">=</span> v<span style="color: #339933;">;</span>&nbsp; u <span style="color: #339933;">=</span> m<span style="color: #339933;">;</span>&nbsp; v <span style="color: #339933;">=</span> n<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#125;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">return</span> x <span style="color: #339933;">%</span> b0<span style="color: #339933;">;</span><br/>
<span style="color: black;">&#125;</span><br/>
<span style="color: black; font-style: italic;">//...</span><br/>
r <span style="color: #339933;">=</span> xgcd<span style="color: black;">&#40;</span>a<span style="color: #339933;">,</span> m<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp;</div>
<p>We could check the obtained value by testing whether <code>(a * r) % m == 1</code>, or by modifying the xgcd() function: <code>return b == 1 ? x % b0 : 0;</code>. But this check is redundant, since we knew that for any <em>a &lt; m</em> and prime <em>m</em>, there would be always an inverse <em>r</em> and that it is always unique in the multiplicative group <img src="/img/cache/7307a9ed415c26ed0601f6e595bf4797.gif" alt="\mathbb{Z}_m" valign="middle"/>.</p>
<p>Now we could traverse the sequence of pseudo-random numbers back and forth with:</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #993333;">uint32_t</span> lcg<span style="color: black;">&#40;</span><span style="color: #993333;">uint32_t</span> x<span style="color: black;">&#41;</span><br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">return</span> <span style="color: black;">&#40;</span>x <span style="color: #339933;">*</span> a <span style="color: #339933;">+</span> c<span style="color: black;">&#41;</span> <span style="color: #339933;">%</span> m<span style="color: #339933;">;</span><br/>
<span style="color: black;">&#125;</span><br/>
<br/>
<span style="color: #993333;">uint32_t</span> icg<span style="color: black;">&#40;</span><span style="color: #993333;">int32_t</span> x<span style="color: black;">&#41;</span><br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; x <span style="color: #339933;">-=</span> c<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">while</span> <span style="color: black;">&#40;</span>x <span style="color: #339933;">&lt;</span> <span style="color: #0000dd;">0</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; x <span style="color: #339933;">+=</span> m<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">return</span> <span style="color: black;">&#40;</span>r <span style="color: #339933;">*</span> x<span style="color: black;">&#41;</span> <span style="color: #339933;">%</span> m<span style="color: #339933;">;</span><br/>
<span style="color: black;">&#125;</span><br/>
&nbsp;</div>
<p>So, for the prime <em>m</em> (1024..2048) and <em>a</em> (1..m) (<em>a</em> could not be greater than <em>m</em>) we got 208 850 possible RNGs (this number must be multiplied by <em>c</em> to take into account all possible increments. Not so bad and still simple. One could use the <em>sieve of Eratosthenes</em> to find the prime numbers (with a bit of optimization the memory requirements for the numbers below <img src="/img/cache/4899fb44f14867ddc63aa25d835c547f.gif" alt="10^6" valign="middle"/> could be reduced down to 60Kb):</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #808080; font-style: italic;">/* http://www.fpx.de/fp/Software/Sieve.html */</span><br/>
<span style="color: #339933;">#define TEST(f,x) &nbsp; &nbsp; &nbsp; (*(f+(x)/16)&amp;(1&lt;&lt;(((x)%16L)/2)))</span><br/>
<span style="color: #339933;">#define SET(f,x) &nbsp; &nbsp; &nbsp; &nbsp;*(f+(x)/16)|=1&lt;&lt;(((x)%16L)/2)</span><br/>
<br/>
<span style="color: #993333;">uint8_t</span> <span style="color: #339933;">*</span>make_primes<span style="color: black;">&#40;</span><span style="color: #993333;">int</span> max<span style="color: black;">&#41;</span><br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #993333;">uint8_t</span> <span style="color: #339933;">*</span>feld<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #993333;">int</span> size <span style="color: #339933;">=</span> <span style="color: black;">&#40;</span>max <span style="color: #339933;">&gt;&gt;</span> <span style="color: #0000dd;">4</span><span style="color: black;">&#41;</span> <span style="color: #339933;">+</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">,</span> teste <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">,</span> mom<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>feld <span style="color: #339933;">=</span> <span style="color: black;">&#40;</span><span style="color: #993333;">uint8_t</span><span style="color: #339933;">*</span><span style="color: black;">&#41;</span><a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/malloc.html"><span style="color: #000066;">malloc</span></a><span style="color: black;">&#40;</span>size<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: #339933;">==</span> NULL<span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">return</span> NULL<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; bzero<span style="color: black;">&#40;</span>feld<span style="color: #339933;">,</span> size<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">while</span> <span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>teste <span style="color: #339933;">+=</span> <span style="color: #0000dd;">2</span><span style="color: black;">&#41;</span> <span style="color: #339933;">&lt;</span> max<span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span><span style="color: #339933;">!</span> TEST<span style="color: black;">&#40;</span>feld<span style="color: #339933;">,</span> teste<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">for</span> <span style="color: black;">&#40;</span>mom <span style="color: #339933;">=</span> <span style="color: #0000dd;">3L</span> <span style="color: #339933;">*</span> teste<span style="color: #339933;">;</span> mom <span style="color: #339933;">&lt;</span> max<span style="color: #339933;">;</span> mom <span style="color: #339933;">+=</span> teste <span style="color: #339933;">&lt;&lt;</span> <span style="color: #0000dd;">1</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SET <span style="color: black;">&#40;</span>feld<span style="color: #339933;">,</span> mom<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">return</span> feld<span style="color: #339933;">;</span><br/>
<span style="color: black;">&#125;</span><br/>
<br/>
<span style="color: #993333;">int</span> is_prime<span style="color: black;">&#40;</span><span style="color: #993333;">int</span> n<span style="color: #339933;">,</span> <span style="color: #993333;">uint8_t</span> <span style="color: #339933;">*</span>feld<span style="color: black;">&#41;</span><br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span>n <span style="color: #339933;">%</span> <span style="color: #0000dd;">2</span> <span style="color: #339933;">==</span> <span style="color: #0000dd;">0</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span><span style="color: #339933;">!</span>TEST<span style="color: black;">&#40;</span>feld<span style="color: #339933;">,</span> n<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">return</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span><br/>
<span style="color: black;">&#125;</span><br/>
<br/>
<span style="color: #993333;">int</span> find_nearest_prime<span style="color: black;">&#40;</span><span style="color: #993333;">int</span> n<span style="color: #339933;">,</span> <span style="color: #993333;">uint8_t</span> <span style="color: #339933;">*</span>feld<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> max<span style="color: black;">&#41;</span><br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #993333;">int</span> m <span style="color: #339933;">=</span> n <span style="color: #339933;">-</span> <span style="color: #0000dd;">2</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span>n <span style="color: #339933;">%</span> <span style="color: #0000dd;">2</span> <span style="color: #339933;">==</span> <span style="color: #0000dd;">0</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; m<span style="color: #339933;">++;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">while</span> <span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>m <span style="color: #339933;">+=</span> <span style="color: #0000dd;">2</span><span style="color: black;">&#41;</span> <span style="color: #339933;">&lt;</span> max<span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span><span style="color: #339933;">!</span> TEST<span style="color: black;">&#40;</span>feld<span style="color: #339933;">,</span> m<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">return</span> m<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">return</span> n<span style="color: #339933;">;</span><br/>
<span style="color: black;">&#125;</span><br/>
&nbsp;</div>
<p>As I already told in the description of Lacrimae virus, a max distance between any given <em>x</em> and nearest prime number in the range from one to <img src="/img/cache/4899fb44f14867ddc63aa25d835c547f.gif" alt="10^6" valign="middle"/> would not exceed 113 [5].</p>
<h2><a name="c4"></a>References</h2>
<ol>
<li>The Mental Driller <a href="/lib/vmd03.html">"Advanced polymorphic engine construction"</a>, 29A#5, December 2000</li>
<li>thread in <a href="http://virusnews.org.ua/fido/pvt.virii/05294.html">pvt.virii newsgroup</a>, 2003</li>
<li>Z0mbie, <a href="/src.php?info=z0mbie10d.zip">Mistfall virus</a></li>
<li>Wikipedia "Modular multiplicative inverse"</li>
<li>herm1t <a href="http://eof-project.net/linuxunix.html#linuxlacrimae">"Code integration on Linux: Cooking the PIE"</a>, EOF-DR-RRLF, 2008</li>
</ol>
<div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vhe09">de</a><a href="/lib/index.php?lang=en&amp;id=vhe09">en</a><a href="/lib/index.php?lang=es&amp;id=vhe09">es</a><a href="/lib/index.php?lang=it&amp;id=vhe09">it</a><a href="/lib/index.php?lang=fr&amp;id=vhe09">fr</a><a href="/lib/index.php?lang=pl&amp;id=vhe09">pl</a><a href="/lib/index.php?lang=ru&amp;id=vhe09">ru</a><a href="/lib/index.php?lang=ua&amp;id=vhe09">ua</a></div>
</body>
</html>
