<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title> JPanic 'Multi-Platform Viruses Made Easy - A Case Study' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="JPanic"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, JPanic,Multi-Platform Viruses Made Easy - A Case Study, specific, note, procedures, viruses, future, multi, init, binary, metaphor, implemented, dark, cross, infection, windows, chdir"/>
<meta name="Description" content="This article is written to give the reader an insight to different methods and examples of cross-platform viruses, and hopefully an insight on how easy it can be using the 'CAPZLOQ TEKNIQ/Clapzok model' used by the author of this model. I am not saying that the other cross-platform viruses aren't great work, I simply believe this model is the simplest and easiest, thus far.Although there are many cross-platform viruses out there, such as binary/executable infecters, script viruses and macro viruses - this article will focus soley on binary/executable infectors."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"7278ed0d2a850e4f8a98d126f879fa591f4a6193-1498756815-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vjp00.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Multi-Platform Viruses Made Easy - A Case Study</h1><p><a href="/lib/?lang=en&amp;author=JPanic"> JPanic</a><br/> <em><a href="/vx.php?fid=2016#f2016">Valhalla #4</a></em><br/> <em>November 2013</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vjp00.html';</script>[<a style="" href="/lib/?lang=EN&amp;index=VT#vjp00">Back to index</a>] [<a href="/lib/vjp00.html#disqus_thread">Comments</a>]<br/> 
<ul>
<li><a href="#c1">Synopsis</a></li>
<li><a href="#c2">Clapzok: A Case Study</a></li>
<li><a href="#c3">Comparisons to other Cross-Platfrom Viruses</a></li>
<li><a href="#c4">Future Trends</a></li>
</ul>
<h2><a name="c1"></a>Synopsis</h2>
<p>This article is written to give the reader an insight to different methods and examples of cross-platform viruses, and hopefully an insight on how easy it can be using the 'CAPZLOQ TEKNIQ/Clapzok model' used by the author of this model. I am not saying that the other cross-platform viruses aren't great work, I simply believe this model is the simplest and easiest, thus far.</p>
<p>Although there are many cross-platform viruses out there, such as binary/executable infecters, script viruses and macro viruses - this article will focus soley on binary/executable infectors.</p>
<h2><a name="c2"></a>Clapzok: A Case Study</h2>
<p>'CAPZLOQ TEKNIQ 2.0', better known as Multi.Clapzok is an x86-32bit infector of Win32 PE (Windows Portable Executable)/Linux i386 ELF (Executable/Linkable Format), i386 Macho (OS X Executable/Linkable) and FAT (OS X Universal Binary) files. The virus runs under x86-32bit (i386) Windows, Linux and Mac OS X.</p>
<p>Some key things to notice, before describing the implementation of this virus in more detail, include:</p>
<ul>
<li>The virus has very much identically under all affected operating systems.</li>
<li>All target file formats are equally infectable by the virus running under all affected operating systems.</li>
<li>The virus is around 2800 bytes, which I consider a good size for a triple-platform infecter that is not heavily optimizied.</li>
</ul>
<p>I say these things not to boast, but to demonstrate why I am promoting the model to be described. The secret to it all is standard interfaces, something like an API for the virus. A basic summary of the Clapzok virus algorithms is something like this (notes will be explained below):</p>
<ul>
<li>Entrypoint (note 1):
<ul>
<li>Save flags, registers.</li>
<li>Setup stack variables.</li>
<li>Initialize RNG.</li>
<li>Initialize Virus OS Call Table (note 2).</li>
<li>Do vmain()</li>
</ul></li>
<li>Exit point (note 1):
<ul>
<li>Clear stack.</li>
<li>Get original entrypoint (host EIP).</li>
<li>Restore flags, registers.</li>
<li>Return to host.</li>
</ul></li>
<li>Virus main() (note 3):
<ul>
<li>Initialize Virus Run-time (OS Specific).</li>
<li>Get Current Working Dir and target directories (OS Specific)</li>
<li>InfectDir(.)</li>
<li>InfectDir(system dir a).</li>
<li>InfectDir(system dir b).</li>
<li>Exit Virus (OS Specific).</li>
</ul></li>
<li>InfectDir() (note 3):
<ul>
<li>FindFirst() (OS Specific).</li>
<li>while (file found)
<ul>
<li>Check filesize.</li>
<li>Open and Map File (OS Specific).</li>
<li>If PE InfectPE (note 3).</li>
<li>If ELF InfectELF (note 3).</li>
<li>If MACHO InfectMACHO (note 3).</li>
<li>If FAT InfectFAT (note 3).</li>
<li>Unmap and Close File (OS Specific).</li>
<li>FindNext() OS Specific.</li>
</ul></li>
<li>loop.</li>
</ul></li>
</ul>
<p>This is the basic virus algorithm. Things to note:</p>
<p>Note 1: All infected files of any file format and operating system share the same entry and exit code.</p>
<p>Note 2: This is the real cross-platform feature of the virus. Many steps/procedures are marked 'OS Specific'. Each of these procedures is implemented for each operating. For example: Win32_Init, OSX_Init, Linux_Init. At infection time, a 1 byte switch is set in the victim specifying which operating system the victim will be running under.</p>
<p>Using this switch, before any OS Specific procedures are called, an array of function addresses to each OS Specific procedures is created. From here on, the virus may make calls using the operating system through this call table, without having to worry about the specifics of the operating system it is running under.</p>
<p>Any of these calls have the same interface under all targeted operating systems. For example: Win32_Chdir, OSX_Chdir, Linux_Chdir all take input/output from the same registers/eflags.</p>
<p>Operating system specific calls used by Clapzok include: Init, Exit, FindFirst, FindNext, SetUpDirs, Chdir, OpenMap, CloseUnmap.</p>
<p>Note 3: In the Clapzok model, all infection routines have a standard interface just like all operating specific calls. For example, infection procedures for all target formats take a register pointing to the memory mapped file and a varaible in memory allowing the procedure to get and set the victim filesize.</p>
<p>The significant code reuse accross operating systems and target filesystems has some advantages:</p>
<ul>
<li>Minimal Code Size.</li>
<li>Minimal work for the coder (no-recoding thigs for different OS's).</li>
<li>Minimal debugging/auditing of code.</li>
</ul>
<h2><a name="c3"></a>Comparisons to other Cross-Platfrom Viruses</h2>
<p>Now I will compare Clapzok with some other cross-platform viruses, including:</p>
<ul>
<li>Esperanto.4733 by Mr Sandman.</li>
<li>16-Bit attempts by Qark, Dark Slayer and Dark Angel.</li>
<li>Winux by Benny.</li>
<li>Shrug family by Roy G Biv.</li>
<li>Metaphor.1d by The Mentral Driller.</li>
</ul>
<p><strong>Esperanto.4733</strong>: This cross-platform virus was coded in 1997 by Mr Sandman in 1997. It is a great example of a cross-platform virus, especially for its time. Esperanto is an infector of MS-DOS MZ/.COM files, Win16 NewEXE (NE) and Win32 PE. The virus infects all formats under all targeted operating systems, but behaves differently on different OS'.s Under MS-DOS it is memory resident, while under Win16/Win32 it is direct action. The virus also has the ability to drop a Mac virus when infected windows files are executed on Mac machines under a windows emulator, however the virus cannot replicate between Mac and PC without user interaction.</p>
<p><strong>16-Bit attempts</strong>: Some 16-Bit cross-platform viruses come to mind. 'Ph33r' was a MS-DOS/Win16 cross infector. Dark Slayers DS family were MS-DOS/Win16/Boot. Dark Angels 'Blah' was a batch file and MBR infector. Due to these operating systems now being obsolete, we will not go further into these viruses.</p>
<p><strong>Winux by Benny</strong>: This seems to be the first Win32/Linux cross-platform infecter. The virus was a direct-action infect of PE and ELF files under both operating systems. Behaviour under each operating system was slightly different. Winux searched only '.' under Linux, while searching both '.' and '..' under Windows. Winux while coded first, was similar in functionality to CAPZLOQ TEKNIQ 1.0 (Multi.Bi.a) a precursor to Clapzok. It is worth noting the size of these viruses. Multi.Winux was around 2.1k while Multi.Bi was around 1.2k. I note this difference, not to put Benny down in anyway, but to show the space that can be saved by the code reuse of the Clapzok Model.</p>
<p><strong>Shrug by Roy G Biv</strong>: There are several viruses in this family, but I will concentrate on the Shrug!IA32/AMD64 virus of 2004. This is one of the few *Cross-Architecture* viruses as indicated by its name. The virus is very much the same virus written for IA32 and AMD64 bundled together. Since the virus only targeted one operating system for each architecture (Win32 or Win64) the virus is not really a candidate for the Clapzok model. However, future virus may target more operating systems, such as an x86/x64 Windows/Linux/OSX virus. Such a virus would then benefit from the Clapzok model. See the "Future Trends" section of this article.</p>
<p><strong>Metaphor.1d</strong> by The Mental Driller: While this virus is well known for its fantastic metamorphic abilities, do not forget it is cross-platform too. Metaphor.1d behaves equally well under both Win32 and Linux, infecting PE and ELF's. Metaphor has a high-rate of code reuse, as in the Clapzok model, with a single switch to determine which operating system it is running under. This swith is incorporated into the metamorphic engine of the virus. Metaphor.1d also parses both PE and ELF file imports equally well to implement EPO.</p>
<h2><a name="c4"></a>Future Trends</h2>
<p>With this brief discussion of cross-platform viruses, let us discuss some future possibilites. Most basic probabiltiy is more and more sophsiticated cross-platform malware. The methods used in Clapzok could easily be used in a more complex, robust and virulent virus.</p>
<p>Next let us consider cross-architecture viruses like Roy G Biv's shrug. Clapzok was cross-platform but single-architecture, infecting x86 binaries and operating systems only. But what if the Virus main procedure, operating system specific procedures and infection procedures were implemented in more than one architecture. This could add x64 and other architecure platforms into the mix while still making use of the Clapzok model.</p>
<p>High Level Languages: Use of high level languages in cross-platform viruses could lead to rapid development. Operating specific procedures could be implemented in c for example, with only a small amount of OS specific inline assembler and compiled for all target operating systems. Infection routines could be written in type and endian neutral code, and compiled for each architecture targeted.</p>
<p>What about cross-platform toolkits? Tiny, VX orientated, stdlib/clib style libraries could be produced implemented in multiple operating systems for other virus authors to quickly and easily develop cross-platform infecters.</p>
<p>Lastly, let use quickly discuss polymorphy and EPO in cross-platform viruses. Polymorphy is easy to implement in a cross-platform virus for a single architecture if the decryptor code does not use any operating system specific code or constructs. If the decryptor is OS specific, some routines may be implemented with a common interface for each OS, Clapzok style.</p>
<p>EPO is equally possible. Imports for various binary formats maybe parsed for EPO hooks. Text/Code sections may be parsed easily for several formats looking for common code like function prologues/epilogues.</p>
<p>I hope this has been useful to you</p>
<div align="right">JPanic, 2013.</div>
[<a style="" href="/lib/?lang=EN&amp;index=VT#vjp00">Back to index</a>] [<a href="/lib/vjp00.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vjp00">de</a><a href="/lib/index.php?lang=en&amp;id=vjp00">en</a><a href="/lib/index.php?lang=es&amp;id=vjp00">es</a><a href="/lib/index.php?lang=it&amp;id=vjp00">it</a><a href="/lib/index.php?lang=fr&amp;id=vjp00">fr</a><a href="/lib/index.php?lang=pl&amp;id=vjp00">pl</a><a href="/lib/index.php?lang=ru&amp;id=vjp00">ru</a><a href="/lib/index.php?lang=ua&amp;id=vjp00">ua</a></div>
</body>
</html>
