<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Peter Ferrie, Frédéric Perriot, Péter Ször 'Striking Similarities' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Peter Ferrie, Frédéric Perriot, Péter Ször"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Ferrie, Peter; Perriot, Frédéric; Ször, Péter,Striking Similarities, file, variant, section, step, instructions, variants, data, decryptor, body, payload, virus, challenging, simile, mechanism, polymorphic"/>
<meta name="Description" content="W32/Simile is the latest ‘product’ of the developments in metamorphic virus code. The virus was released in the most recent 29A #6 issue in early March 2002.The virus was written by the virus writer who calls himself ‘The Mental Driller’. Some of his previous viruses, such as W95/Drill (which used the Tuareg polymorphic engine), have proved very challenging to detect.W32/Simile moves yet another step up the scale of complexity. The source code of the virus is approximately 14,000 lines of assembly code. About 90% of the virus code is taken up by the metamorphic engine itself, which is extremely powerful.The virus was named ‘MetaPHOR’ by its author, which stands for ‘Metamorphic Permutating High-Obfuscating Reassembler’.The first generation virus code is about 32 KB and there are three known variants of the virus in circulation. Samples of the original variant which was released in the 29A issue have been received by certain anti-virus companies from some major corporations in Spain, indicating a minor outbreak.W32/Simile is highly obfuscated and challenging to understand. The virus attacks disassembling, debugging and emulation techniques, as well as standard evaluation-based techniques for virus analysis. In common with many other complex viruses, Simile uses EPO techniques."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"72a477755663681e8f8e6d9f88ab4bf03c1246cf-1498757203-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/apf44.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Striking Similarities</h1><p><a href="/lib/?lang=en&amp;author=Ferrie%2C%20Peter">Peter Ferrie</a>, <a href="/lib/?lang=en&amp;author=Perriot%2C%20Fr%C3%A9d%C3%A9ric">Frédéric Perriot</a>, <a href="/lib/?lang=en&amp;author=Sz%C3%B6r%2C%20P%C3%A9ter">Péter Ször</a><br/> <em>Virus Bulletin, May 2002, pp. 4-6</em><br/> <em>ISSN 0956-9979</em><br/> <em>May 2002</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/apf44.html';</script><div class="ci"><a href="/lib/?ci=apf44">4</a></div><img src="/img/pdf.gif" alt="PDF"/><a href="/lib/pdf/Striking%20Similarities.pdf">Download</a> PDF (47.23Kb) (You need to be registered on <a href="/forum">forum</a>)<br/>[<a style="" href="/lib/?lang=EN&amp;index=AN#apf44">Back to index</a>] [<a href="/lib/apf44.html#disqus_thread">Comments</a>]<br/> <form method="post" action=""><input type="hidden" name="pages" value="1"/><input type="submit" value="Turn on page numbers"/></form>
<address>
Frédéric Perriot, Peter Ferrie and Péter Ször<br/>
Symantec Security Response, USA
</address>
<ul>
<li><a href="#c1">Replication Routine</a></li>
<li><a href="#c2">EPO Mechanism</a></li>
<li><a href="#c3">Polymorphic Decryptor</a></li>
<li><a href="#c4">Metamorphism</a></li>
<li><a href="#c5">Replication</a></li>
<li><a href="#c6">Payload</a></li>
<li><a href="#c7">Conclusion</a></li>
</ul>
<p>W32/Simile is the latest ‘product’ of the developments in metamorphic virus code. The virus was released in the most recent 29A #6 issue in early March 2002.</p>
<p>The virus was written by the virus writer who calls himself ‘The Mental Driller’. Some of his previous viruses, such as W95/Drill (which used the Tuareg polymorphic engine), have proved very challenging to detect.</p>
<p>W32/Simile moves yet another step up the scale of complexity. The source code of the virus is approximately 14,000 lines of assembly code. About 90% of the virus code is taken up by the metamorphic engine itself, which is extremely powerful.</p>
<p>The virus was named ‘MetaPHOR’ by its author, which stands for ‘Metamorphic Permutating High-Obfuscating Reassembler’.</p>
<p>The first generation virus code is about 32 KB and there are three known variants of the virus in circulation. Samples of the original variant which was released in the 29A issue have been received by certain anti-virus companies from some major corporations in Spain, indicating a minor outbreak.</p>
<p>W32/Simile is highly obfuscated and challenging to understand. The virus attacks disassembling, debugging and emulation techniques, as well as standard evaluation-based techniques for virus analysis. In common with many other complex viruses, Simile uses EPO techniques.</p>
<h2><a name="c1"></a>Replication Routine</h2>
<p>Simile contains a fairly basic direct action replication mechanism that attacks PE files on the local machine and the network. The emphasis is clearly on the metamorphic engine, which is unusually complex.</p>
<h2><a name="c2"></a>EPO Mechanism</h2>
<p>The virus searches and replaces all of the possible patterns of certain call instructions (those that reference ExitProcess() API calls) to point to the beginning of the virus code. Thus the main entry point of the file is not altered.</p>
<p>Sometimes the metamorphic virus body is placed together with a polymorphic decryptor at the same location within the file. In other cases the polymorphic decryptor is placed at the end of the code section, while the virus body is placed in another section. This is to conceal further the location of the virus body.</p>
<h2><a name="c3"></a>Polymorphic Decryptor</h2>
<p>During the execution of an infected program, when the instruction flow reaches one of the hooks that the virus has placed in the code section, control is transferred to a polymorphic decryptor which is responsible for decoding the virus body (or simply copying it directly since, intentionally, the virus body is not always encrypted.)</p>
<p>This decryptor, whose location in the file is variable, allocates a large chunk of memory (about 3.5 megabytes) then proceeds to decipher the encrypted body into it. It does this in a most unusual manner: rather than going through the encrypted data linearly, it processes it in a seemingly random order, thus managing to avoid triggering some decryption-loop recognition heuristics.</p>
<p>This ‘Pseudo-Random Index Decryption’, as the virus writer calls it, relies on the use of a family of functions that have interesting arithmetic properties, modulo 2^n.</p>
<p>While the virus writer discovered this by a process of trial and error, it is possible to produce a mathematical proof that his algorithm works in all cases (provided the implementation is correct, of course). Such a proof is beyond the scope of this article but the proof, by Frédéric Perriot, is available at http://www.peterszor.com/.</p>
<p>The size and appearance of the decryptor varies greatly from one virus sample to the next. To achieve this high level of variability, the virus writer simply generates a code template and then puts his metamorphic engine to work to transform the template into a working decryptor!</p>
<p>In some cases, the decryptor may start with a header whose intent is not immediately obvious upon reading it. Further study reveals that its purpose is to generate anti-emulation code on the fly: the virus constructs a small oligomorphic code snippet containing the instruction RDTSC (‘ReaD Time Stamp Counter’). This retrieves the current value of an internal processor ticks counter. Then, based on one random bit of this value, the decryptor either decodes and executes the virus body or bypasses the decryption logic altogether and simply exits.</p>
<p>Besides confusing emulators that do not support the somewhat peculiar RDTSC instruction (one of The Mental Driller’s favourites, which he used previously in W95/Drill), this is also a very strong attack against all algorithms that rely on emulation either to decrypt the virus body or to determine viral behaviour heuristically. Effectively, it causes some virus samples to cease infecting completely upon a random time condition.</p>
 
<p>On initial execution, the virus body will retrieve the addresses of 20 APIs that it requires for replication and for displaying the payload.</p>
<p>Next the virus will check the system date in order to determine whether either of its payloads should activate. Both payloads require that the host imports functions from User32.dll. In this case, the virus checks whether it should call the payload routine or not (which is explained below).</p>
<h2><a name="c4"></a>Metamorphism</h2>
<p>After the payload check has completed, a new virus body is generated. This code generation is carried out in a number of steps:</p>
<p>The first step is to disassemble the viral code into an intermediate form, which is independent of the CPU upon which the native code will execute. This allows for future extensions, such as producing code for different operating systems or even different CPUs.</p>
<p>The second step is to shrink the intermediate form, by removing the redundant and unused instructions. These instructions were added by earlier replications to interfere with disassembly by virus researchers.</p>
<p>The third step is to permutate the intermediate form, for example reordering subroutines, or separating blocks of code and linking them with jump instructions.</p>
<p>The fourth step is to expand the code, by adding redundant and unused instructions.</p>
<p>The fifth step is to reassemble the intermediate form into a final native form that will be added to infected files.</p>
<p>Thus Simile can not only expand, as most first generation metamorphic viruses do, but it can also shrink (and shrink to different forms!).</p>
<h2><a name="c5"></a>Replication</h2>
<p>Next the replication phase begins. It starts by searching for *.exe in the current directory, then on all fixed and mapped network drives.</p>
<p>The infection will scan recursively into directories, but only to a depth of three subdirectories, and avoiding completely any directory that begins with the letter ‘W’.</p>
<p>For each file that is found, there is a 50% chance that it will be skipped explicitly. Additionally, files will be skipped if they begin with ‘F-’, ‘PA’, ‘SC’, ‘DR’, ‘NO’, or contain the letter ‘V’ anywhere in the name.</p>
<p>Due to the nature of the comparison, other character combinations are skipped unintentionally, for example any directory that begins with the number 7, any file that begins with ‘FM’, or any file that contains the number 6 anywhere in its name.</p>
<p>The file infection routine contains many checks to filter files that cannot be infected safely. For example, the file must contain a checksum, it must be an executable for the Intel 386+ platform, and there must exist sections whose names are ‘.text’ or ‘CODE’, and ‘.data’ or ‘DATA’. The virus also checks that the host imports some kernel functions, such as ‘ExitProcess’.</p>
<p>For any file that is considered infectable, random factors and the file structure will determine where the virus places its decryptor and virus body.</p>
<p>If the file contains no relocations, or with only a small chance, the virus body will be appended to the last section in the file. In this case, the decryptor will be placed either immediately before the virus body, or at the end of the code section.</p>
<p>Otherwise, if the name of the last section is ‘.reloc’, the virus will insert itself at the beginning of the data section and move all of the following data and update all of the offsets in the file.</p>
<h2><a name="c6"></a>Payload</h2>
<p>The first payload activates only during the months of March, June, September, and December. Variants A and B of W32/Simile display their message on the 17th day of these months. Variant C will display its message on the 18th day of these months.</p>
<p>Variant A will display the message ‘Metaphor v1 by The Mental Driller/29A’:</p>
<div align="center">
<img src="img/apf44/fig1.gif" alt="Metaphor V1 payload"/>
</div>
<p>and variant B will display ‘Metaphor 1b by The Mental Driller/29A’:</p>
<div align="center">
<img src="img/apf44/fig2.gif" alt="Metaphor 1b payload"/>
</div>
<p>Variant C attempts to display ‘Deutsche Telekom by Energy 2002 **g**’:</p>
<div align="center">
<img src="img/apf44/fig3.gif" alt="Hacked Metaphor payload"/>
</div>
 
<p>However the author of variant C had little understanding of the code, and the message rarely appears correctly. In all variants, the message appears in randomly mixed letter cases.</p>
<p>The second payload activates on 14 May in variants A and B, and on 14 July in variant C.</p>
<p>In the second payload, variants A and B will display the message ‘Free Palestine!’ on computers that use the Hebrew locale. Variant C attempts to display the text ‘Heavy Good Code!’ but, due to a bug in the virus code, this message is displayed only on systems on which the locale cannot be determined.</p>
<h2><a name="c7"></a>Conclusion</h2>
<p>During the extensive and detailed tests carried out with W32/Simile replication on test systems we have noticed that the virus code generates garbage unintentionally or trashes some files accidentally as the direct result of its extreme complexity.</p>
<p>It seems that obfuscated code is not only challenging for virus researchers to analyse, but it is very challenging for the author of the code to debug.</p>
<p>As the saying goes: ‘there are three kinds of lies: lies, damn lies, and statistics’. The complex infection mechanism coupled with the powerful metamorphic engine make it very difficult to reach 100% accuracy using only empirical evaluation methods, and indepth analysis of the virus code is essential.</p>
<p>Exact identification becomes a problem even for humans. How long does it take to be sure if something is really variant A or C or a new one? Is it modified or is it the same? It is becoming more difficult to know. The need to understand metamorphic code in a quicker fashion must be the subject of further research.</p>
<p>As this issue of <em>VB</em> goes to print, W32/Simile (aka W32/Etap) appears on the preliminary April 2002 supplemental WildList.</p>
<table summary="W32/Simile">
<tr><th colspan="2">W32/Simile</th></tr>
<tr><th>Alias:</th><td>W32.Etap, Metaphor.</td></tr>
<tr><th>Type:</th><td>Direct action Win32, portable executable infector, complete metamorphic virus.</td></tr>
<tr><th>Removal:</th><td>Detect and delete infected files and replace them from clean backups.</td></tr>
<tr><th>Payload:</th><td>Displays messages on certain dates. Unintended payload: Trashes some portable executable files.</td></tr>
</table>
 
[<a style="" href="/lib/?lang=EN&amp;index=AN#apf44">Back to index</a>] [<a href="/lib/apf44.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=apf44">de</a><a href="/lib/index.php?lang=en&amp;id=apf44">en</a><a href="/lib/index.php?lang=es&amp;id=apf44">es</a><a href="/lib/index.php?lang=it&amp;id=apf44">it</a><a href="/lib/index.php?lang=fr&amp;id=apf44">fr</a><a href="/lib/index.php?lang=pl&amp;id=apf44">pl</a><a href="/lib/index.php?lang=ru&amp;id=apf44">ru</a><a href="/lib/index.php?lang=ua&amp;id=apf44">ua</a></div>
</body>
</html>
