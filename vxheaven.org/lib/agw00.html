<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Gary Watson 'A Discussion of Polymorphism' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Gary Watson"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Watson, Gary,Discussion of Polymorphism, polymorphic, random, file, start, algorithm, number, count, code, make, virus, words, decryptor, pointer, byte, bytes"/>
<meta name="Description" content="A polymorphic virus is a type of encrypted virus. Let's talk about those first. Many anti-virus programs rely on what we call a &quot;scanner&quot; which looks for an unusual sequence of machine language instructions or other unique data that indicates that a given virus is present. To defeat this, virus writers started encrypting their viruses by applying (for example) a random number exclusive-or'ed with the body of the virus. This obsfucates the unique string of bytes. So, programs like McAfee's scan had to do one of two things: look for the decryption routine (which cannot itself be encrypted since the 808x microprocessor would fail to execute it); or attempt to decrypt the body of the virus and look for the unique string of bytes in the body of the virus."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"f7e700423ea7bcf08a6ee813a3b10b9058411542-1498756105-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/agw00.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>A Discussion of Polymorphism</h1><p><a href="/lib/?lang=en&amp;author=Watson%2C%20Gary">Gary Watson</a><br/> <em>Data Plus</em><br/> <em>May 1992</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/agw00.html';</script><div class="ci"><a href="/lib/?ci=agw00">1</a></div>[<a style="" href="/lib/?lang=EN&amp;index=PO#agw00">Back to index</a>] [<a href="/lib/agw00.html#disqus_thread">Comments</a>]<br/> 
<p>A polymorphic virus is a type of encrypted virus. Let's talk about those first. Many anti-virus programs rely on what we call a "scanner" which looks for an unusual sequence of machine language instructions or other unique data that indicates that a given virus is present. To defeat this, virus writers started encrypting their viruses by applying (for example) a random number exclusive-or'ed with the body of the virus. This obsfucates the unique string of bytes. So, programs like McAfee's scan had to do one of two things: look for the decryption routine (which cannot itself be encrypted since the 808x microprocessor would fail to execute it); or attempt to decrypt the body of the virus and look for the unique string of bytes in the body of the virus.</p>
<p>Well, to defeat even this, the virus writers created polymorphism. This basically involves a routine in the body of the virus that, on the fly, and during each new infection process, actually generates a new and unique decryption module and algorithm to be used in the new infection. The idea being twofold: make sure the decryption routine does not have a predictable sequence of bytes in it; and second, make sure that the body of the virus is encrypted with a sufficiently complex and unpredictable algorithm that cannot be decrypted by the anti-virus scanner.</p>
<p>So, what McAfee, Frisk and others did was to analyse the methods used by each polymorphic generator and then create an algorithm that detects the types of mutations created by each polymorphic virus out there. According to preliminary results from Vessilin Bontchev, McAfee's Scan 89B misses 0.04% of the mutations of "Fear", a typical virus that uses the Mutation Engine polymorphic object module; F-Prot misses 0.14%; and Dr. Solomon's FindVirus misses 7.86% of them. Bontchev considers anything less than 100% detection to be almost a complete failure, since any one of the missed samples could re-infect the system at a later date. The current release of Scan is 93 (as of this date), and it is unknown what its detection percentage is.</p>
<p>So, how do polymorphic viruses work? Well, let's constuct a pseudo code version of one way that it could be done. This will be similar to the way that the Mutation Engine works.</p>
<ol>
<li>We wake up as as virus loaded into memory. No part of us is encrypted at this time. We consist of interrupt handlers for such things as the INT 21H ms-dos service request, etc.; a mutation routine; and a payload of whatever type.</li>
<li>We intercept a ms-dos INT 21h Open File request. We decide that this is a fine time to infect that file.</li>
<li>We call the mutation routine, which creates a unique encyptor and decryptor pair. The mutation routine then calls the newly created encryptor, which takes the memory image of the virus (remember, the virus is NOT encrypted while in memory), writes the decryptor out to the front of a data buffer in memory, followed by the encrypted copy of the virus. Keep in mind that the virus itself contains not only the traditional virus code, but also the routine that generates encryptor/decryptor pairs.</li>
<li>We infect the victim file using the memory buffer that contains the decryptor/encrypted virus combination.</li>
<li>We go ahead and perform the ms-dos function call that the user had requested.</li>
</ol>
<p>Now, whenever the victim file is executed, ms-dos will jump to the beginning of the decryptor, which then decrypts the memory image of the encrypted virus and transfers control to the now decrypted virus, which executes normally.</p>
<p>Most people do not understand how the mutation routine iteslf generates the necessary unique encryptor/decryptor pair. The method used by the Mutation Engine is extremely complex, but a simpler one can be devised for demonstration purposes, and the difference will be only in complexity, not content.</p>
<p>Consider the sample encryptor/decryptor pair shown below, side by side for ease of comparison. For ease of human understanding, it is presented as if the mutation routine was creating assembly code. In reality, it merely emits binary machine code which is stored directly in memory.</p>
<p><strong>Note:</strong> it is my considered opinion that the following would be a fairly weak polymorph if it were implemented, that is, McAfee et. al. would have little difficulty detecting this. Therefore, I feel that presenting this example in a public forum poses no significant danger and has potential to clear up much of the misunderstanding surrounding this issue.</p>
<p>Pseudo-code starts:</p>
<pre class="source">
;first set up registers in a confusing way. aa thru jj are random 16 bit
;numbers chosen when these routines are generated by the mutation
;subroutine. Before EcStart is called, a copy of the memory image of
;the virus is moved to a data buffer which starts at vir_start. In the
;case of the decryptor, vir_start is immediately after the decryptor
;routine.

EcStart:  mov bx,iter_count            DcStart:   mov cx,iter_count+aa
                                                  sub cx,aa
          mov bp,vir_start                        mov di,vir_start+cc
                                                  sub di,cc

;okay, now bx has the iteration count for the encryptor, cx, for the decryptor;
;and bp and di have the pointer to the virus itself.  In reality we would
;probably preserve various registers on the stack and set up various segment
;registers, but this is omitted here for clarity.  The iteration count is
;calculated at mutation time by dividing the size in words of the virus by
;the number of words mutated in one loop of the encryptor.

;if the above code snippets do not appear particularly random, mentally
;assemble them into hex bytes and you will see the problem a scan string
;based anti virus product would have.  (iter_count+aa), aa, (vir_start+cc),
;and cc are effectively random byte pairs.  Note that there is no need
;to obsfucate the encryptor, since it is used once then discarded.  It need
;not propagate with the virus.

;now, we (de)garble a byte.  In reality, the function done to the byte
;in this case rotate right or left is chosen at random.  It merely needs
;to be reversable.
EcLoop:   mov ax,[bp]                  DcLoop:    mov ax,[di]
          shl ax                                  shr ax
          mov [bp],ax                             mov [di],ax

;oh, let's see, how about we add a random number then subtract it?

          mov ax,[bp+1]                           mov ax,[di+1]
          add ax,ee                               sub ax,ee
          mov [bp+1],ax                           mov [di+1],ax

;heck that was fun, let's do it again for the third byte!

          mov ax,[bp+2]                           mov ax,[di+2]
          add ax,ff                               sub ax,ff
          mov [bp+2],ax                           mov [di+2],ax

;just to confuse the issue, lets add/sub three different values!

          mov ax,[bp+3]                           mov ax,[di+3]
          add ax,gg                               sub ax,gg
          add ax,hh                               sub ax,jj
          add ax,jj                               sub ax,hh
          mov [bp+3],ax                           mov [di+3],ax

;And so on and so on.  We insert as many of these routines as we wish,
;determined by a random number.  At each step of the creation of a
;encryptor/decryptor pair we consult the random number generator to
;decide how many and of which kind of garbling functions to include.
;Obviously in a serious polymorphic routine we would make each register
;interchangable as well.  In the above example, the fact that the
;decryptor uses di as a pointer to the virus data would be chosen at
;random.  Any other valid register could be substituted.

;Now, iterate by adjusting the pointer register by the number of
;words garbled each iteration:
          add bp,4                                add di,4
          dec bx                                  dec cx
          jnz EcLoop                              jnz DcLoop
          ret  ;to mutator routine                jmp vir_start
                                           iter_count:dw  ?
                                           vir_start:

;At this point we just fall into the virus if we are the decryptor
;or return to the mutator routine if we are the encryptor.
</pre>
<p>Note that this very simple polymorphic example has few predictable byte strings in it, since one does not know which pointer register is to be used, the contents of any of the random numbers aa through jj, nor how many bytes the routine will choose to garble in one iteration. Note that by changing these factors, an extremely complex encryption takes place, as both the algorithm and the keying data cange considerably. Even the <em>quantity</em> of keying data changes from one infected file to the next.</p>
<p>The strength of the polymorphic virus is in how thoroughly it mutates, that is, in how unpredictable the sequence of instructions is in the decryptor module. In particular, no more than about 4 bytes can be predictable, else a simple scan string could be constructed and then all the polymorphic code would be a waste of effort on the part of the virus writer.</p>
<p>(By the way, if I have made any typos in the above code examples, <em>GOOD</em>. Pretend I did it on purpose to confuse any beginning virus writer who tried to use the code as is. Of course, I did not really show the code necessary to implement the polymorph, I only showed what it could do.)</p>
[<a style="" href="/lib/?lang=EN&amp;index=PO#agw00">Back to index</a>] [<a href="/lib/agw00.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=agw00">de</a><a href="/lib/index.php?lang=en&amp;id=agw00">en</a><a href="/lib/index.php?lang=es&amp;id=agw00">es</a><a href="/lib/index.php?lang=it&amp;id=agw00">it</a><a href="/lib/index.php?lang=fr&amp;id=agw00">fr</a><a href="/lib/index.php?lang=pl&amp;id=agw00">pl</a><a href="/lib/index.php?lang=ru&amp;id=agw00">ru</a><a href="/lib/index.php?lang=ua&amp;id=agw00">ua</a></div>
</body>
</html>
