<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Peter Ferrie, Frédéric Perriot, Péter Ször 'Blast off!' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Peter Ferrie, Frédéric Perriot, Péter Ször"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Ferrie, Peter; Perriot, Frédéric; Ször, Péter,Blast off!, time, shell, worm, worms, month, port, overflow, service, local, cent, windows, blaster, function, address, buffer"/>
<meta name="Description" content="On 11 August 2003 - the same day it was completed - a 6176-byte-long UPX-compressed bug started to invade the world using a recent vulnerability described in Microsoft's MS03-26 security bulletin. Even Windows Server 2003 was affected by this vulnerability. Patches were made available by Microsoft, but on this occasion there was only a short delay between the announcement of the vulnerability and the appearance of the worm that exploited it.Users of Windows XP had a chance to get the patch applied automatically via Windows Automatic Updates. However, the same cannot be said for the Windows 2000 platforms, where users would need to pay closer attention to the update procedures."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"cd27ba52d3618083b743c92cabe0b65968ae9d83-1498755667-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/apf05.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Blast off!</h1><p><a href="/lib/?lang=en&amp;author=Ferrie%2C%20Peter">Peter Ferrie</a>, <a href="/lib/?lang=en&amp;author=Perriot%2C%20Fr%C3%A9d%C3%A9ric">Frédéric Perriot</a>, <a href="/lib/?lang=en&amp;author=Sz%C3%B6r%2C%20P%C3%A9ter">Péter Ször</a><br/> <em>Virus Bulletin, September 2003, pp.10-11</em><br/> <em>ISSN 0956-9979</em><br/> <em>September 2003</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/apf05.html';</script><div class="ci"><a href="/lib/?ci=apf05">1</a></div><img src="/img/pdf.gif" alt="PDF"/><a href="/lib/pdf/Blast%20off%21.pdf">Download</a> PDF (30.19Kb) (You need to be registered on <a href="/forum">forum</a>)<br/>[<a style="" href="/lib/?lang=EN&amp;index=AN#apf05">Back to index</a>] [<a href="/lib/apf05.html#disqus_thread">Comments</a>]<br/> <form method="post" action=""><input type="hidden" name="pages" value="1"/><input type="submit" value="Turn on page numbers"/></form>
<address>
Peter Ferrie, Fr&eacute;d&eacute;ric Perriot, P&eacute;ter Sz&ouml;r<br/>
Symantec Security Response, USA
</address>
<ul>
<li><a href="#c1">All systems go</a></li>
<li><a href="#c2">SP4, SP3, SP2, SP1, ignition!</a></li>
<li><a href="#c3">Second stage - the shell</a></li>
<li><a href="#c4">Houston, we have a problem</a></li>
<li><a href="#c5">Pan galactic garble blaster</a></li>
<li><a href="#c6">MS-DoS</a></li>
<li><a href="#c7">Conclusion</a></li>
</ul>
<p>On 11 August 2003 - the same day it was completed - a 6176-byte-long UPX-compressed bug started to invade the world using a recent vulnerability described in <em>Microsoft</em>'s <em>MS03-26</em> security bulletin. Even <em>Windows Server 2003</em> was affected by this vulnerability. Patches were made available by <em>Microsoft</em>, but on this occasion there was only a short delay between the announcement of the vulnerability and the appearance of the worm that exploited it.</p>
<p>Users of <em>Windows XP</em> had a chance to get the patch applied automatically via Windows Automatic Updates. However, the same cannot be said for the <em>Windows 2000</em> platforms, where users would need to pay closer attention to the update procedures.</p>
<h2><a name="c1"></a>All systems go</h2>
<p>The first thing Win32/Blaster does when it runs on a system is to create a value `windows auto update' in the `HKLM/.../Run' registry key, pointing to the bare file name `msblast.exe' (for variant .A). This relies on the assumption that the executable has ended up in a directory that <em>Windows</em> searches by default, which is usually the case.</p>
<p>Then the worm attempts to create a mutex named `BILLY', and aborts if the mutex exists already, in order to avoid multiple instances of the worm running at the same time.</p>
<p>Win32/Blaster then waits for an active network connection, and starts searching for machines to infect.</p>
<h2><a name="c2"></a>SP4, SP3, SP2, SP1, ignition!</h2>
<p>The target selection in Blaster is somewhat different from that found in CodeRed and Slammer. Sixty per cent of the time, Blaster will go after entirely random IP addresses, and the other 40 per cent of the time it will attack machines on the same class-B-sized network as the host, hoping to take over pools of vulnerable systems on the local area network.</p>
<p>The scanning for targets is linear (the target address is increased monotonically until it reaches the end of the IP space) and, in the case of a local attack, starts at or slightly below the class-C of the host.</p>
<p>The worm targets machines running <em>Windows 2000</em> and <em>Windows XP</em>, and intentionally favours the exploitation of <em>Windows XP</em> machines (probably because the payload relies on the increased availability of raw sockets there - the requirement to be administrator was removed). Eighty per cent of the time, the exploit is tuned for <em>Windows XP</em> systems, the other 20 per cent for <em>Windows 2000</em> systems. This selection is made only once, whenever the worm initializes.</p>
<p>All unpatched Service Packs of both <em>Windows XP</em> and <em>Windows 2000</em> systems are affected, but because of this random tuning, the worm will sometimes just cause a denial of service (DoS) on the attacked machines, crashing the RPC service.</p>
<h2><a name="c3"></a>Second stage - the shell</h2>
<p>The infection of a new machine is a three-phase process, involving quite a lot of network activity in comparison with the single-connection CodeRed and the lightweight Slammer.</p>
<p>First, the worm sends its attack buffer over port 135/tcp, which exploits the RPC DCOM vulnerability and causes the remote machine to bind a shell in the SYSTEM context (`cmd.exe') to port 4444/tcp.</p>
<p>Second, the worm sends a command to the newly created shell to request a download of the worm file from the attacking host to the victim. The transfer is done over port 69/udp using the tftp protocol (the worm implements its own crude tftp server which formats sent data according to RFC 1350, and uses the tftp client that is present by default on most <em>Windows</em> systems).</p>
<p>Finally, once msblast.exe has been downloaded successfully, or after 21 seconds, the worm requests the remote system to execute the downloaded file.</p>
<h2><a name="c4"></a>Houston, we have a problem</h2>
<p>Once the shell exits, the hijacked RPC service thread running the shell code calls ExitProcess(), causing the service to terminate. The termination of the RPC service, regardless of how it occurs, triggers a reboot in <em>Windows XP</em> systems after one minute. On <em>Windows 2000</em> systems, the termination will result in a variety of unusual side effects, among the most critical of which is the inability to use the Windows Update web service.</p>
<h2><a name="c5"></a>Pan galactic garble blaster</h2>
<p>As is common for fast-spreading worms, Win32/Blaster reuses an exploit code that was posted previously to various security mailing lists. The exploit uses two so-called `universal offsets' as return addresses in a classic stack buffer overflow, each of which is compatible with multiple service packs of one <em>Windows</em> version. The vulnerability is located in the code of the rpcss.dll file, in a function related
 
to the activation of DCOM objects. The buggy function extracts a NetBIOS server name from a UNC path specified by a DCOM client, and attempts to place it into a 32-byte buffer on the stack, without bounds checking.</p>
<p>Once the stack is smashed, the hijacked return address leads to a `call ebx' instruction (in a `well-known' constant data table) which then jumps back to a nop ramp in the shell code. This is possible because the ebx register is pointing to a local variable in an earlier stack frame (i.e. at a higher memory address) created by the fourth-level (!) caller of the buggy function (see Figure 1).</p>
<p>The shell code retrieves some useful API addresses, binds to port 4444/tcp, accepts one incoming connection, spawns the shell and ties its input to the port 4444 socket, waits for the shell process to finish, then exits.</p>
<div align="center">
<img src="img/apf05_fig1.gif" alt="Figure 1: Memory layout and control flow."/>
<p><em>Figure 1: Memory layout and control flow.</em></p>
</div>
<h2><a name="c6"></a>MS-DoS</h2>
<p>Win32/Blaster implements a SYN-flooding Distributed Denial of Service attack against the website `windowsupdate.com', an alias of the main <em>Microsoft</em> Windows Update site.</p>
<p>The attack is carried out if the day of the month is greater than 15, or the month is greater than 8, i.e. every day from 16 August to the end of the year, and then starting again on 16 January until 31 January, 16 February until 28(/29) February, and so on.</p>
<p>To generate the traffic, the worm uses raw sockets. DoS packets have spoofed source IP addresses, the two low octets are randomized for each sent packet; the high octets are either taken from an IP of the source host, or otherwise initialized once to random values.</p>
<p>The traffic features various characteristics that can help in recognizing it: the two low bytes of the TCP sequence number are always zero, the source port is between 1000 and 1999 (inclusive), and the IP identification field always has a value of 256.</p>
<h2><a name="c7"></a>Conclusion</h2>
<p>The first use of a command shell attack by a Win32 worm has finally arrived. The spawning of a shell had previously been used only by Win32 exploits and by Unix worms executing /bin/sh with system calls such as system() or execve().</p>
<p>Windows worm writers are slowly merging existing exploit code with their creations to make them more harmful. The tendency that started with CodeRed, Slammer and other Unix worms, continues. The delay between the appearances of such creations seems to have decreased from a year to six months.</p>
<p>It is evident that among defensive technologies, proactive behaviour blocking techniques will become essential to fight back against such `cloned' worms in the future. Peter Sz&ouml;r's paper, `Attacks of the worm clones - can we prevent them?' (to be presented at this year's RSA Europe conference in November) uncovers the details of how we can get closer to this goal and demonstrates research prototypes that work effectively against this clone.</p>
<p>This time not only corporate servers risked being affected; the threat had the potential to reach the majority of <em>Windows</em> desktops. This is `Buffer Overflow for the Masses'.</p>
<table summary="Win32/Blaster">
<tr><th colspan="2">Win32/Blaster</th></tr>
<tr><th>Size:</th><td>6176 bytes.</td></tr>
<tr><th>Aliases:</th><td>W32.Blaster.Worm, W32/Lovsan.worm, Win32.Poza.A.</td></tr>
<tr><th>Type:</th><td>Worm, exploits buffer overflow vulnerability in DCOM/RPC (described in Microsoft's MS03-026 Security Bulletin).</td></tr>
<tr><th>Trigger:</th><td>DoS attack attempt against windowsupdate.com after 16th of each month or after August each year.</td></tr>
</table>
 
[<a style="" href="/lib/?lang=EN&amp;index=AN#apf05">Back to index</a>] [<a href="/lib/apf05.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=apf05">de</a><a href="/lib/index.php?lang=en&amp;id=apf05">en</a><a href="/lib/index.php?lang=es&amp;id=apf05">es</a><a href="/lib/index.php?lang=it&amp;id=apf05">it</a><a href="/lib/index.php?lang=fr&amp;id=apf05">fr</a><a href="/lib/index.php?lang=pl&amp;id=apf05">pl</a><a href="/lib/index.php?lang=ru&amp;id=apf05">ru</a><a href="/lib/index.php?lang=ua&amp;id=apf05">ua</a></div>
</body>
</html>
