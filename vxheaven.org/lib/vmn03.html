<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title> MidNyte 'The Complete Re-write Engine' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="MidNyte"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, MidNyte,Complete Re-write Engine, type, shrinking, return, jump, handlers, byte, problem, data, string, virus, start, handler, piece, code, step"/>
<meta name="Description" content="A form of metamorphism discussed in theory."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"3fd144a70c6b632650be2deb052a188e504c778a-1498755791-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vmn03.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>The Complete Re-write Engine</h1><p><a href="/lib/?lang=en&amp;author=MidNyte"> MidNyte</a><br/> <em><a href="/vx.php?fid=225#f225">Final Chaos [1]</a></em><br/> <em>May 1999</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vmn03.html';</script><div class="ci"><a href="/lib/?ci=vmn03">1</a></div>[<a style="" href="/lib/?lang=EN&amp;index=ME#vmn03">Back to index</a>] [<a href="/lib/vmn03.html#disqus_thread">Comments</a>]<br/> 
<p><em>(A form of metamorphism discussed in theory.)</em></p>
<ul>
<li><a href="#p1">Introduction</a></li>
<li><a href="#p2">The First Step</a></li>
<li><a href="#p3">Code Shrinking</a></li>
<li><a href="#p4">Conclusion</a></li>
</ul>
<h2><a name="p1">Introduction</a></h2>
<p>First of all, let me explain a Complete Re-write Engine (CRE) as I see it. I have thought of it as something in the 'would be good if it could be done' category, and is a form of metamorphism. A CRE would read in a piece of code, and work out a (random?) functional equivalent, that is, produce a new and different piece of code that would produce the same results. This has been talked of as a replacement for encryption in viruses. To write a CRE you will need at least a basic understanding of polymorphism, emulation and disassembly. You need to understand how the opcodes are formed to be able to manipulate them properly.</p>
<p>Also, let me explain that if you're looking for a step by step guide to writing a CRE, you're not going to find one here, this is only a discussion of the main problems of creating one. I am certainly not of the coding ability to create one yet, if one is even possible in practise. If you think you can do one, go ahead, metamorphism is a unique alternative to polymorphism, but don't think this is going to teach you how to do it. This is just my explanation of how I plan to do it when I do have the ability.</p>
<p>The algorithms, methods and code produced by the end of this article will be messy and awkward, but hopefully functional. The price to pay for code that works is often code that's neat, at least for those who do too much writing and not enough coding like me. Also, please note that the second and subsequent generations will be very difficult to read and/or debug, because (obviously) the re-write engine will re-write itself along with the rest of the virus. Any bugs in a later generation must be traced back to their creation, but this may be through a buggy routine produced by a buggy routine etc.</p>
<p>The practical values of a CRE are that no scan string can be made from the code, as every part of it can be changed from one generation to the next. Most heuristics are often defeated by simply changing from obvious ways of doing things to an alternative, so it should be possible for a CRE virus to evade them. The disadvantages are that some (most?) forms of anti-debugging are code specific, so might be difficult or even impossible to incorporate (the stack checking trick for instance), and that keeping data within the CRE virus can be tricky. Anyway, It's up to you to evaluate the usefulness of CRE. My personal opinion is that it will only ever be a proof of concept thing, and that the limitations to it will always outweigh the advantages. I'm hoping someone can prove me wrong. Anyway.....</p>
<h2><a name="p2">The First Step</a></h2>
<p>The first step in any major programming project is (or at least should be) planning the algorithm. Our CRE would examine each instruction in turn and work out an equivalent instruction or series of instructions. This alternative generating is much like conventional polymorphism.</p>
<p>My approach to writing the algorithm would be too write the basic virus, then write the instruction handlers for every instruction in the virus. Then when that's done, go back and add handlers for every instruction that's in the instruction handlers we've just written. This should require no new instructions to achieve, but if it does, make a note and write handlers for them aswel. This is going to take time.</p>
<p>So our basic model is: (in pseudocode &amp; assuming all instructions are one byte each, this is only a demonstration.)</p>
<pre class="source">
START:
   &lt;get byte>
   &lt;X = 1 to number_of_instructions>
   &lt;is byte a type X insruction?>
      Y - jump to type_X_handler
      N - next X
   &lt;else jump to data_handler>
   &lt;all bytes done?>
      Y - exit
      N - get next byte

TYPE_X_HANDLER:
   &lt;Y = random number (1 to number_of_type_X_alternatives)>
ALTERNATIVE_GENERATOR:
   &lt;generate alternative Y>
   &lt;return to start>

DATA_HANDLER:
   &lt;copy data>
   &lt;return to start>
</pre>
<p>Ok, by now you've noticed a few obstacles to overcome and things that need to be explained more fully before we can move on.</p>
<p>First, data is data and cannot be changed without changing the functionality of the code. This can easily be overcome in some cases however by loading the values into registers (ie, cmp ax,80h could be cmp ax,bx instead if bx was first loaded with 80h). Some cases are more difficult, like having a search string of '*.com' in amongst our code for instance. One possible way to deal with this would be to store the string encrypted in a certain way. This series of instructions (the decryption method) could then be handled by our CRE. This does however lead to the difficulty of keeping track of where the string is within the file, but this can be done by pointing to the address of the string from a set location. As the string will always move, this will not create a stable byte. Or we could just put all the strings/data at the end of the file and read them from there, using the filesize as a base reference to find them all.</p>
<p>Secondly, what if a data byte is the same number as the ordinal value of an instruction we scan for? well, this is an inherent problem to the CRE concept (and emulators and debuggers), but a quick work-around is to check each piece of randomly generated data against a list of 'forbidden values', ie, our instruction set, and choose another if it will cause a conflict. This does unfortunately need more data to be stored/created. Maybe those who have knowledge of emulation systems could provide a better solution (hint hint), but at least in the meantime we have a work-around.</p>
<p>(What if the pointer mentioned in the first point is the same number as an ordinal value of one of our instructions? I guess we'd have to use two pointers added together to create the address of the string to be safe, then at least we could keep altering them until neither contained a hidden value.)</p>
<p>Thirdly, (not really a problem) our instruction handlers need to know what bytes that come after the instruction byte are data. This is simply a matter of knowing the instruction's layout, then loading the stack or registers with the appropriate numbers ready for use by the alternative generator. This is where metamorphism differs from polymorphism quite significantly. In polymorphism the code generator knows what values in has to attach to instructions, in metamorphism it has to work it out for itself from code that it has previously written.</p>
<p>Fourth, with all this generating of numbers instead of storing, aren't we going to get longer each generation? Without a doubt. Every piece of code in the virus will be taken up by an equivalent of at least the same length, probably more. Each piece of this new code will be replaced in the next generation by an equivalent of at least the same length, probably more in the generation after that, and so on. This would mean an exponential increase in the size of the code. This is why the first advancement on the basic system is:</p>
<h2><a name="p3">Code Shrinking</a></h2>
<p>Code shrinking is the replacement of a long set of instructions with a shorter set of an equivalent function. Our instruction handler is going to have to be able to recognise instruction sequences that can be shrunk in the first place, so how about scanning the next 20 or so bytes for particular sequences relevant to the instruction we're on? The CRE would produce most random code if the shrinking does not always shrink as much as possible. Maybe you could give it a percentage chance of shrinking and play with that value until the optimum is reached. If we get this part right, our code should grow from it's first generation (because it's in it's simplest state when it's written) until it reaches an average size that it fluctuates around (when the shrinking it does roughly balances the increases it makes). If it doesn't become stable, then either your alternatives are too lengthy, your shrinker isn't good enough or both. If the fluctuation in size is too drastic or just not to your liking, you could always bias your shrinking dependant on the size of the code, ie, more shrinking when the filesize is high. As long as the biasing is not too strong it should calm down the fluctuation too, brush up on your chaos theory if you want to know why. Chaos theory also tells us that too strong a bias may well lead to a predictable oscillation by the way, and the last thing we want is anything predictable. Anyway, We now have:</p>
<pre class="source">
START:
   &lt;get byte>
   &lt;X = 1 to number_of_instructions>
   &lt;is byte a type X insruction?>
      Y - jump to type_X_shrinker
      N - next X
   &lt;else jump to data_handler>
   &lt;all bytes done?>
      Y - exit
      N - get next byte

TYPE_X_SHRINKER:
   &lt;push si>
   &lt;Y = 1 to 20>
   &lt;read next byte>
   &lt;is byte related to instruction X>
      Y - SHRINKABLE=TRUE ; save shrinkable byte to mem
      N - ignore
   &lt;loop Y>
   &lt;is shrinkable=true>
      Y - jump to shrink_X
      N - continue
   &lt;Y = random number (1 to number_of_type_X_alternatives)>

ALTERNATIVE_GENERATOR:
   &lt;generate alternative Y>
   &lt;return>
SHRINK_X:
   &lt;calculate alternative from saved bytes>
   &lt;return>

DATA_HANDLER:
   &lt;copy data>
   &lt;return>
</pre>
<p>So, now we have a structure to work on. This is the part where each instruction must be dealt with individually. You'll notice I wrote 'is byte related to instruction X' in the above pseudocode. Well, that's up to you to decide how all the instructions are related, or more accurately, up to your alternative generator. For example if your CRE's only alternatives to 'MOV AH,80h' are 'MOV AL,80h / XCHG AL,AH' then for your MOV_SHRINKER you will only have to check for the MOV and XCHG instructions. If you also have the possibility of 'MOV AH,40h / ADD AH,10h / ADD AH,10h / ADD AH,10h / ADD AH,10h' then you'll have to check for ADD's aswell.</p>
<p>One thing to watch though, is that every alternative that you make that increases the amount of instructions should be recognised and handled by your shrinker. If you don't, it can happen that your code makes an alternative that the shrinker doesn't recognise, and then that particular bit of code can never be as small as it used to be. This makes the code less random and larger, not a real problem for just one instance, but obviously the more it happens the more it becomes a problem. This will cause a particular problem if a longer replacement for a common instruction that your generator makes isn't recognised by your shrinker and if the replacement contains similar instructions to the original (ie, making 'ADD AX,40h' into 'ADD AX,20h / ADD AX,20h' in one generation, each 'ADD AX,20h' in the next becoming 'ADD AX,10h / ADD AX,10h'). This would create a sequence that could only ever get bigger as generations went by, each one expanding the sequence but never shrinking.</p>
<p>Other advancements would be to have your alternative generators or shrinkers be aware of consecutive instructions, ie, 'MOV AH,80h / MOV BH 40h' could become 'MOV AH,80h / MOV BH,AH / SHL BH,1', or you could interleave the equivalents of consecutive instructions, ie, 'MOV AH,80h / MOV BH 40h' could be 'XOR AH,AH / XOR BH,BH / ADD AH,80h / ADD BH,40h'. I have already incorporated a mechanism for skipping unrelated instructions (ie, searching ahead for relevant instructions, not just assuming that they're the next ones you come across), but haven't put in any way of ensuring that the same instruction is not taken by the shrinker to be part of two instruction sets, ie, using it twice. I'll leave it to you to sort all that out, and I'll concentrate on learning to code properly while you're doing all that.</p>
<p>Do be aware that any complications to the layout of instructions your alternative generator makes, again your shrinker should be able to handle if you don't want your filesize to (sooner or later) increase out of control.</p>
<h2><a name="p4">Conclusion</a></h2>
<p>There we are then, I've just told you what needs doing, admitted couldn't do it, and now I'm sitting back waiting for a CRE with a big credit to me to appear..... no, seriously, a CRE is possible in theory as long every instruction can be emulated by using other instructions, in practice though there are a lot of problems. Whether or not these can be overcome enough to create a fully functioning CRE-equipped virus or not is another matter, especially if the practical value of this idea isn't much in the eyes of the reader. Personally, I see polymorphism as a middle ground (although more than adequate, providing the encryption is strong) between a simple encrypted virus and metamorphism, so a CRE should at least be created and tested. I will eventually learn enough to do one, and I will do one, but until then I don't want to be keeping these ideas to myself, just in case anyone finds something useful in all that. Good luck!</p>
<pre>
				- MidNyte
</pre>
<p>As always, I welcome ANY feedback, good or bad, as long as it is reasonable.</p>
[<a style="" href="/lib/?lang=EN&amp;index=ME#vmn03">Back to index</a>] [<a href="/lib/vmn03.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vmn03">de</a><a href="/lib/index.php?lang=en&amp;id=vmn03">en</a><a href="/lib/index.php?lang=es&amp;id=vmn03">es</a><a href="/lib/index.php?lang=it&amp;id=vmn03">it</a><a href="/lib/index.php?lang=fr&amp;id=vmn03">fr</a><a href="/lib/index.php?lang=pl&amp;id=vmn03">pl</a><a href="/lib/index.php?lang=ru&amp;id=vmn03">ru</a><a href="/lib/index.php?lang=ua&amp;id=vmn03">ua</a></div>
</body>
</html>
