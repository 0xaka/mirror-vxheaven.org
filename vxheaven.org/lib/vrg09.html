<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title> roy g biv 'Compiled HTML' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="roy g biv"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, roy g biv,Compiled HTML, itss, streams, code, files, read, write, infect, control, methods, interface, load, file, method, reset, create"/>
<meta name="Description" content="Microsoft like to produce new file formats with more and more content. CHM files allow a single file to contain HTML pages, including graphics and scripts, something like an archive. They are very careful, though, to avoid documenting anything, so to create such files generally relies on their tools. CHMs carry all of the content in a single stream, compressed by the LZX algorithm. It is almost a solid archive, but contains a periodic state reset, to make the decompression faster (because it is not necessary to decompress the entire archive to reach the last file, but start from the last reset point and decompress from there)."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"2006b3ea0e734e32c421733aaa359b13fc31f759-1498755789-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vrg09.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Compiled HTML</h1><p><a href="/lib/?lang=en&amp;author=roy%20g%20biv"> roy g biv</a><br/> <em><a href="/vx.php?fid=1512#f1512">Ready Rangers Liberation Front [7]</a></em><br/> <em>April 2005</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vrg09.html';</script>[<a style="" href="/lib/?lang=EN&amp;index=WI#vrg09">Back to index</a>] [<a href="/lib/vrg09.html#disqus_thread">Comments</a>]<br/> 
<ul>
<li><a href="#c0">What are CHM files?</a></li>
<li><a href="#c1">How do we infect them?</a></li>
<li><a href="#c2">So how do we use it?</a></li>
<li><a href="#c3">Let's load ITSS</a></li>
<li><a href="#c4">How to get control?</a></li>
<li><a href="#c5">Greets to friendly people (A-Z)</a></li>
</ul>
<h2><a name="c0"></a>What are CHM files?</h2>
<p>Microsoft like to produce new file formats with more and more content. CHM files allow a single file to contain HTML pages, including graphics and scripts, something like an archive. They are very careful, though, to avoid documenting anything, so to create such files generally relies on their tools. CHMs carry all of the content in a single stream, compressed by the LZX algorithm. It is almost a solid archive, but contains a periodic state reset, to make the decompression faster (because it is not necessary to decompress the entire archive to reach the last file, but start from the last reset point and decompress from there).</p>
<h2><a name="c1"></a>How do we infect them?</h2>
<p>When I first considered to infect CHM files, I did not want to rely on any other DLL to do the work, because I like to code to the lowest level, but that requires working with the compression. To make it easier, I thought to carry a compressed version of myself and create my own reset point, but how to get control? It turns out that the first page to load is not the first file in the table of contents, but is loaded by a reference in one of the internal (compresed) streams. I didn't want to carry the LZX decompressor as well, so I started to look at the Help Helper (HH.EXE). Everyone knows that HH.EXE can decompile CHM files, and it is done by calling into ITSS.DLL. Who knew that ITSS.DLL can compile CHM files, too? Amazingly, it contains the compressor, which means that the only question was how to use it.</p>
<h2><a name="c2"></a>So how do we use it?</h2>
<p>Even more amazing is that the interface is simply the IStorage interface from OLE2, exposed by a different DLL. The IStorage implementation in the ITSS.DLL supports the Read and Write methods, including transparent decompression and compression. Note that I do not say "recompression", because writing to an existing CHM file is not allowed. Instead, it is necessary to create a new file and write to that, then replace the old file with the new file.</p>
<h2><a name="c3"></a>Let's load ITSS</h2>
<p>We load the ITSS DLL by calling CoCreateInstance(), with the ITSS interface parameters. This assumes that you are familiar with COM programming.</p>
<p>The CLSID is {5D02926A-212E-11D0-9DF9-00A0C922E6EC}.</p>
<p>The RIID is {88CC31DE-27AB-11D0-9DF9-00A0C922E6EC}.</p>
<p>The returned interface pointer can be passed to StgOpenStorage() to open any CHM file. The EnumElements and Next methods can be used to see the storages and streams, the OpenStream and OpenStorage methods can be used to open them, and the Read method can be used to read streams. For the destination file, there is the StgCreateDocfile() to create a new file, CreateStream and CreateStorage methods to create them, and the Write method to write streams.</p>
<h2><a name="c4"></a>How to get control?</h2>
<p>The method that I chose to get control was to alter the HTM files to include my code. Initially, I tried to package my entire code within the HTM files, but there were many problems with that idea. One problem was the need to script an ActiveX control to create a file, which triggers a security warning. The next problem was how to deliver a binary from a text-only file format. Many people seem to rely on the chr() function to convert ASCII to binary, but this is unreliable on DBCS systems whenever the 8th bit is set. To solve that problem, I created a new executable-ASCII engine which is much smaller than the one in Junkmail, but functionally equivalent. This created a new problem because it drops an executable-ASCII com file which relies on the 16-bit subsystem to run, so it was very slow and noticeable. I'll find a use for it.</p>
<p>Finally, I decided to be scriptless and use an additional file, this way:</p>
<div class="xml" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;object</span> <span style="color: #000066;">classid</span>=<span style="color: #ff0000;">'clsid:1baddeed'</span><span style="color: #000066;">codebase</span>=.exe<span style="color: #ff0000;">'&gt;&lt;/object&gt;</span></span><br/>
&nbsp;</div>
<p>and .exe is the name of the file that I add after all files are infected.</p>
<p>The problem with that is the table of contents now contains a unique filename that could be used as a heuristic detection, but you can always change it in the code.</p>
<h2><a name="c5"></a>Greets to friendly people (A-Z)</h2>
<p>Active - Benny - Obleak - Prototype - Ratter - Ronin - RT Fishel - sars - The Gingerbread Man - Ultras - uNdErX - Vecna - VirusBuster - Whitehead</p>
<div align="right">
rgb/29A apr 2005<br/>
<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="ec858d81b39e8b8eac848398818d8580c28f8381">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script>
</div>
<div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vrg09">de</a><a href="/lib/index.php?lang=en&amp;id=vrg09">en</a><a href="/lib/index.php?lang=es&amp;id=vrg09">es</a><a href="/lib/index.php?lang=it&amp;id=vrg09">it</a><a href="/lib/index.php?lang=fr&amp;id=vrg09">fr</a><a href="/lib/index.php?lang=pl&amp;id=vrg09">pl</a><a href="/lib/index.php?lang=ru&amp;id=vrg09">ru</a><a href="/lib/index.php?lang=ua&amp;id=vrg09">ua</a></div>
</body>
</html>
