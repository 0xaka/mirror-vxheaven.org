<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Peter Ferrie 'Deelaed learning' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Peter Ferrie"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Ferrie, Peter,Deelaed learning, viruses, deelae, pointer, problem, work, virus, address, infect, import, loaded, deelaes, technique, table, ﬁeld, windows"/>
<meta name="Description" content="Not long ago, a new virus writer appeared, using the name ‘hh86’. Rumour had it that hh86 was female – a rarity in the virus-writing world. There was a ﬂurry of activity from hh86 over a period of about three months, producing a handful of viruses using new techniques, and then... she was gone without a word. The model virus writer perhaps.At ﬁrst glance, I thought that her ﬁrst virus (Deelae.A) was simply a copy of a virus created by the virus writer roy g biv. A slightly closer look revealed some novel size optimizations (as well as some opportunities that were missed, and some ‘optimizations’ that are the same size but slower to execute) as well as some differences in style. It’s clear that hh86 was ‘inspired’ by roy g biv’s work. In Hollywood, they’d call that ‘reimagining’."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"53bd765203bd8d4b6899dcfe1f21d1cba2ca5f76-1498756042-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/apf54.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Deelaed learning</h1><p><a href="/lib/?lang=en&amp;author=Ferrie%2C%20Peter">Peter Ferrie</a><br/> <em>Virus Bulletin, November 2010, pp. 8-10</em><br/> <em>ISSN 0956-9979</em><br/> <em>November 2010</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/apf54.html';</script><div class="ci"><a href="/lib/?ci=apf54">3</a></div><img src="/img/pdf.gif" alt="PDF"/><a href="/lib/pdf/Deelaed%20learning.pdf">Download</a> PDF (46.88Kb) (You need to be registered on <a href="/forum">forum</a>)<br/>[<a style="" href="/lib/?lang=EN&amp;index=AN#apf54">Back to index</a>] [<a href="/lib/apf54.html#disqus_thread">Comments</a>]<br/> <form method="post" action=""><input type="hidden" name="pages" value="1"/><input type="submit" value="Turn on page numbers"/></form>
<address>
Peter Ferrie<br/>
Microsoft, USA
</address>
<ul>
<li><a href="#c1">Technology anthology</a></li>
<li><a href="#c2">Import-Ant details</a></li>
<li><a href="#c3">Difference of opinion</a></li>
<li><a href="#c4">Certificate holder</a></li>
<li><a href="#c5">Expect deelaes</a></li>
<li><a href="#c6">Further Deelaes</a></li>
<li><a href="#c7">Yet more Deelaes</a></li>
<li><a href="#c8">Maximum Deelaes</a></li>
<li><a href="#c9">Conclusion</a></li>
</ul>
<p>Not long ago, a new virus writer appeared, using the name ‘<a href="http://vx.netlux.org/hh86/">hh86</a>’. Rumour had it that hh86 was female – a rarity in the virus-writing world. There was a ﬂurry of activity from hh86 over a period of about three months, producing a handful of viruses using new techniques, and then... she was gone without a word. The model virus writer perhaps.</p>
<p>At ﬁrst glance, I thought that her ﬁrst virus (Deelae.A) was simply a copy of a virus created by the virus writer roy g biv. A slightly closer look revealed some novel size optimizations (as well as some opportunities that were missed, and some ‘optimizations’ that are the same size but slower to execute) as well as some differences in style. It’s clear that hh86 was ‘inspired’ by roy g biv’s work. In Hollywood, they’d call that ‘reimagining’.</p>
<h2><a name="c1"></a>Technology anthology</h2>
<p>Let’s start with the things that are the same. The most obvious is the construction of a Structured Exception Handler (SEH) which is used as a single point of exit when an error occurs. Even the exception condition is the same – an interrupt 3 instruction. One annoying technique the pieces of malware have in common is the loading of the stack with as many parameters as possible, prior to calling APIs in sequence (see <em>VB</em>, October 2004, p.4, for an illustrated example).</p>
<p>Another technique they share is the method used to retrieve a DLLBase value from the PEB_LDR_DATA structure in the Process Environment Block. This technique was actually ﬁrst published by the virus writer Ratter, and he seems to be the more likely source here. The reason for this speculation is that roy g biv has used the technique only once – it wasn’t in a virus at all (it was in the BASLR tool), and it loaded a different DLL from the one that hh86 is trying to load. That difference introduces a problem for hh86.</p>
<p>The PEB_LDR_DATA structure contains three structures (‘InLoadOrderModuleList’, ‘InMemoryOrderModuleList’, and ‘InInitializationOrderModuleList’, but <em>Microsoft</em> documentation lists the ﬁrst structure as ‘reserved’, names the second one, and implies that the third does not exist). Any of the three structures can be parsed to ﬁnd the list of DLLs that are loaded. The difference is in the order of the pointers that are referenced by the structures, and thus the amount of code used to complete the retrieval.</p>
<p>All three virus writers used the InInitializationOrderModuleList structure (although roy g biv called it the ‘InLoadOrderModuleList’). This results in the smallest code, but it does not work on <em>Windows 7</em> when it is used to retrieve the DLLBase of kernel32.dll. The BASLR tool (created by roy g biv) loaded ntdll.dll, which does work on <em>Windows 7</em>, but hh86 (and Ratter) loaded kernel32.dll. Thus, Deelae.A and Deelae.B do not work on <em>Windows 7</em>. This might be considered the ﬁrst bug, and hh86 seems to have thought so too, since it was ﬁxed in Deelae.C.</p>
<h2><a name="c2"></a>Import-Ant details</h2>
<p>The code used to resolve the imports is also similar, up to a point. Deelae uses the CRC32 method, to avoid the need to store the strings. However, the CRCs are not sorted according to the alphabetical order of the strings they represent, so multiple passes over the export table are required to resolve the imports. The code that resets the index contains one potential problem. The code that checks for the end of the list contains several potential problems.</p>
<p>We’ll start with the problems in the list termination code. The ﬁrst problem is that only one byte is checked (this is especially curious, given that four bytes were allocated in Deelae.A and Deelae.B). This prevents the use of any function whose CRC32 value would have the checked value in the lowest byte.</p>
<p>The second problem is that the checked value is not constant in Deelae.A and Deelae.B, thanks to the way in which it is constructed. Instead, it depends on the previous CRC32 value. If the top byte of the previous CRC32 value is less than 0x80, then the checked value will be zero. Otherwise, the checked value will be 0xff. As a result, the list cannot have the form 0x00-7f x1 x2 x3 0x00 y1 y2 y3, or 0x80-ff x1 x2 x3 0xff y1 y2 y3, because in each case, the list will appear to terminate too soon.</p>
<p>The third problem is that if the terminating value is 0xff, it leads to a real bug in Deelae.A and Deelae.B. A few instructions later, some space is allocated on the stack using a modiﬁcation to the register that held the checked value. If the terminating value is 0xff, then the stack pointer is moved in the wrong direction, destroying the SEH registration, and leading quickly to a crash.</p>
<p>This third problem was ﬁxed in Deelae.C in two ways. The ﬁrst was by changing the comparison register to one that always holds a zero – but the byte-check remains, and therefore so does the ﬁrst problem. This is despite the fact that the comparison register is entirely zero, and thus all
 
four bytes could have been checked. However, in Deelae.C, the CRC table was changed to end with a single byte, and this change is also present in Deelae.D and Deelae.E. The second way was to allocate the stack space using an instruction speciﬁcally designed for the purpose, so no arithmetic overﬂow can occur.</p>
<p>The problem with the index reset code is that the index might be set to 0xffffffff instead of zero, because of the second problem above. This index is used to look inside the Name Pointer table. In the (obviously impossible) case that the Name Pointer table had a Relative Virtual Address (RVA) of zero (that is, pointing to the ‘MZ’ part of the ﬁle header), the attempt to retrieve the ﬁrst name RVA would access memory outside of the image, and cause an exception. However, the exception would be intercepted and the virus code would simply exit without issue. There is also the remote possibility that a wanted string appears immediately before the import table, and that would lead to the wrong function pointer being retrieved. That could result in unexpected behaviour, but a crash seems likely. The exception should be intercepted here too, but depending on what is called, a real crash might occur. The ﬁle to infect might also be corrupted.</p>
<h2><a name="c3"></a>Difference of opinion</h2>
<p>One of the major ways in which hh86’s viruses differ from those of roy g biv is in the ﬁle handling. roy g biv’s viruses would not infect ﬁles that are protected by the System File Checker (this feature was added in Deelae. F), they would remove the read-only attribute if required, and they would not infect ﬁles that were for a different CPU, or were DLLs if the virus did not support them.</p>
<p>In constrast, hh86’s viruses do not care about the read-only attribute, they do not check the CPU, and they will infect DLLs (in the unlikely event that they are misnamed). They do, however, clear the ‘NX’ bit if it is set. This allows the viruses to execute on systems with Data Execution Prevention enabled, even if the section is not marked as ‘executable’. roy g biv’s viruses, on the other hand, set the ‘executable’ bit in the section header. Both techniques achieve the same goal. roy g biv’s viruses search recursively through all directories, and infect ﬁles regardless of their ﬁlename; hh86’s viruses search only within the current directory, and only for ‘*.exe’. hh86’s viruses are also aware of SafeSEH (see below), which did not exist when the majority of roy g biv’s viruses were created, but even his most recent viruses do not support it. Interestingly, neither Deelae.A nor Deelae.B is aware of the NO_SEH bit (see below), but Deelae.C, Deelae.D and Deelae.E are.</p>
<p>Now it’s time to describe the speciﬁcs of each of hh86’s viruses.</p>
<h2><a name="c4"></a>Certificate holder</h2>
<p>Deelae.A checks if the Certiﬁcate Table data directory indicates the presence of a digital certiﬁcate of at least 4KB in size after the end of the last section. If one is found, the virus zeroes the Certiﬁcate Table data directory (because it will be overwritten) and the Load Conﬁg Table to disable SafeSEH. Disabling SafeSEH allows the virus to raise exceptions without causing the application to be terminated by the operating system <em>if the NO_SEH bit is also clear</em>. The reason for this is because the NO_SEH bit states that no code within the image uses SEH, and thus no code is allowed to call SEH within the image. This bit was introduced in <em>Windows XP</em> SP2, but was not documented until recently.</p>
<p>The virus increases the virtual and physical sizes of the last section, and the SizeOfImage value, by 4KB. It copies itself over the certiﬁcate data, and then saves and alters the host entrypoint to point to the start of the certiﬁcate data. Finally, the virus copies itself over the certiﬁcate data and then forces an exception to occur, thus ending the infection process for that ﬁle. In the past, few ﬁles carried digital certiﬁcates, which would have limited the number of available candidates for this virus. However, an increasing number of ﬁles are now released with digital certiﬁcates, so overwriting the certiﬁcate has become a viable technique to avoid an increase in ﬁle size.</p>
<h2><a name="c5"></a>Expect deelaes</h2>
<p>Deelae.B is identical to Deelae.A with the exception of the entrypoint hook. This time, the virus is interested in the Delay Import Descriptor table.</p>
<p>The Delay Import Descriptor table is used, as the name implies, to delay the importing of DLLs until they are needed. That can improve the start-up time for some applications, and also reduce the memory requirements. If a particular code-path is the only one that requires a certain DLL, and if that code-path is not taken, then the DLL will not be loaded unnecessarily. The table has been documented for a long time, but incorrectly, despite several revisions to the documentation. Speciﬁcally, the ‘Attributes’ ﬁeld is documented as ‘Must be zero’, and ‘As yet, no attribute ﬂags are deﬁned. The linker sets this ﬁeld to zero in the image.’ However, this is not true. The linker sets this ﬁeld to 1, indicating that the table is valid. If bit zero is not set in the table, then an exception is raised by the application.</p>
 
<p>The virus retrieves the RVA of the Delay Import Descriptor, and checks that it points within the ﬁrst section. The virus then retrieves the RVA of the Delay Import Address Table and checks that it points within the second section. If both checks pass, then the virus hooks the ﬁrst address in the Delay Import Address Table to point to the start of the certiﬁcate data.</p>
<p>This entrypoint-obfuscating technique is new. roy g biv showed that the Bound Import Table can be hooked, though he went to extremes to hide the code (see <em>VB</em>, December 2006, p4). hh86 showed that the Delay Import Table can be hooked, and in multiple ways (see below), but she did not attempt to hide it (however, the popular tool known as the <em>Interactive DisAssembler</em> does it for her – it hides the entrypoint in an attempt to avoid bad links in corrupted ﬁles).</p>
<h2><a name="c6"></a>Further Deelaes</h2>
<p>Deelae.C and .D are based on Deelae.B, but with some minor changes, and one major change. One minor change relates to the ﬁle mapping. Both Deelae.A and Deelae.B overwrote the certiﬁcate data, and thus mapped the ﬁle according to its original size. Deelae.C and Deelae.D increase the ﬁle size by 4,213 bytes, even before checking if the ﬁle is a candidate for infection. Of course, if an error occurs, then the viruses restore the ﬁle to its original size.</p>
<p>The major change is that the viruses will not infect ﬁles that have appended data. This is the infection marker – a technique that roy g biv has used for most of his viruses.</p>
<p>The viruses increase the virtual and physical sizes of the last section, and the SizeOfImage value, by 4KB, and then append themselves to the image (perhaps hh86 feels that there are not enough candidates for infection). The ﬁle size is increased permanently at this point by 4KB+1, which introduces a potential problem later. The viruses retrieve the RVA of the Delay Import Descriptor and check that it points within the ﬁrst section. The viruses retrieve the RVA of the Unload Delay Import Table and check that it also points within the ﬁrst section. If both checks pass, then the viruses hook the ﬁrst address in the Unload Delay Import Table to point to the virus body. The problem here is that if either pointer is not within the expected range, then the ﬁle remains marked as ‘infected’, and contains the virus body, but there is no pointer to the code. This will be quite a common occurrence, since the Unload Delay Import Table is not used particularly often, and so the pointer will be null.</p>
<p>If the ﬁle is infected successfully, then the viruses attempt to zero only the Load Conﬁg Table (the Certiﬁcate Table data directory is no longer zeroed). However, there is a bug in Deelae.C which is that the destination of the write is a critical ﬁeld within the section table instead of inside the data directories. As a result, ﬁles infected successfully by Deelae.C will often be corrupted. This bug was ﬁxed in Deelae.D.</p>
<h2><a name="c7"></a>Yet more Deelaes</h2>
<p>Deelae.E is based on Deelae.D, but with two minor changes. One change is the ﬁeld that is used for hooking. Instead of the Unload Delay Import Table, the virus uses the Bound Delay Import Table if the Time Stamp ﬁeld is non-zero. The virus hooks the ﬁrst address in the Bound Delay Import Table to point to the virus body.</p>
<p>The other change is the introduction of a bug. Previously, the host entrypoint was stored as an RVA, and adjusted dynamically. This allowed the virus to work with ﬁles that had Address Space Layout Randomization (ASLR) enabled. However, since the addresses in the Bound Delay Import Table are Virtual Addresses (VAs), hh86 seems to have assumed that it is acceptable to replace a VA for an external ﬁle with a VA for the infected image. This does not work if ASLR is enabled, unless a corresponding relocation item is included, because the host image can move, even if the referenced DLL does not. Note that roy g biv’s Bounds viruses have the same problem.</p>
<h2><a name="c8"></a>Maximum Deelaes</h2>
<p>Deelae.F is based on Deelae.E, but with the combination of hooking methods from Deelae.E, Deelae.C/.D, and Deelae.B, in that order. That is, if the Time Stamp ﬁeld is non-zero, then the virus uses the Bound Delay Import Table. If the Time Stamp ﬁeld is zero, and if the Unload Delay Import Table is non-zero, then the virus uses that table. Otherwise, the virus uses the Delay Import Address Table. As before, the ﬁrst address in the selected table is hooked, and the original address is stored in the virus body. A jump instruction is modiﬁed in the virus body to convert the address to a VA if that is required.</p>
<p>Deelae.F also makes use of the FPU to copy some pointers. This is intended to reduce the code size, but the implementation is ﬂawed, and so the resulting code is larger than if the FPU had not been used at all.</p>
<h2><a name="c9"></a>Conclusion</h2>
<p>Five new viruses and four kinds of entrypoint in three months. hh86 was the ‘Energizer bunny’ of the virus-writing community. It’s a good thing that her batteries ran out.</p>
 
[<a style="" href="/lib/?lang=EN&amp;index=AN#apf54">Back to index</a>] [<a href="/lib/apf54.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=apf54">de</a><a href="/lib/index.php?lang=en&amp;id=apf54">en</a><a href="/lib/index.php?lang=es&amp;id=apf54">es</a><a href="/lib/index.php?lang=it&amp;id=apf54">it</a><a href="/lib/index.php?lang=fr&amp;id=apf54">fr</a><a href="/lib/index.php?lang=pl&amp;id=apf54">pl</a><a href="/lib/index.php?lang=ru&amp;id=apf54">ru</a><a href="/lib/index.php?lang=ua&amp;id=apf54">ua</a></div>
</body>
</html>
