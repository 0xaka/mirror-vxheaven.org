<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Peter Ferrie 'Ani-hilate this week' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Peter Ferrie"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Ferrie, Peter,Ani-hilate this week, bytes, anih, block, file, files, chunk, code, exploited, data, copy, collection, animated, format, subchunks, windows"/>
<meta name="Description" content="[...] The time between the announcement of a vulnerability and the exploitation of that vulnerability continues to shrink. This is especially true when the vulnerability in question is a stack overflow, since it requires very little skill to exploit. The recent ANI vulnerability is a prime example. Before we get into that, let's find out a little more about ANI files in general. [...]"/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"1d1bf8070133fdd98eba4bf7c1bc2235235a9655-1498755498-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/apf00.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Ani-hilate this week</h1><p><a href="/lib/?lang=en&amp;author=Ferrie%2C%20Peter">Peter Ferrie</a><br/> <em>Virus Bulletin, 4 May 2007, pp.4-5</em><br/> <em>ISSN 0956-9979</em><br/> <em>May 2007</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/apf00.html';</script><img src="/img/pdf.gif" alt="PDF"/><a href="/lib/pdf/Ani-hilate%20this%20week.pdf">Download</a> PDF (63.75Kb) (You need to be registered on <a href="/forum">forum</a>)<br/>[<a style="" href="/lib/?lang=EN&amp;index=AN#apf00">Back to index</a>] [<a href="/lib/apf00.html#disqus_thread">Comments</a>]<br/> <form method="post" action=""><input type="hidden" name="pages" value="1"/><input type="submit" value="Turn on page numbers"/></form>
<address>
Peter Ferrie<br/>
Symantec Security Response, USA
</address>
<p>The time between the announcement of a vulnerability and the exploitation of that vulnerability continues to shrink. This is especially true when the vulnerability in question is a stack overflow, since it requires very little skill to exploit. The recent ANI vulnerability is a prime example. Before we get into that, let's find out a little more about ANI files in general.</p>
<p>An ANI file contains animated cursors and icons - for example, the hourglass which turns upside-down during heavy processing. Internally, ANI files are <em>Microsoft</em>'s Resource Interchange File Format (`RIFF') files. They are, in fact, little-endian versions of <em>Electronic Arts</em>' Interchange File Format (`IFF') files that were introduced to the <em>Amiga</em> in 1985. IFF files themselves were inspired by <em>Apple</em>'s OSType files that were released with the <em>Macintosh</em> computer in 1984.</p>
<h2>It's `terrific'</h2>
<p>RIFF files contain a collection of chunks, each of which begins with a four-byte type-name, followed by the size of the chunk.</p>
<p>The first chunk in a RIFF file is named `RIFF'. This is one of the two types of chunk that contain a subtype and a collection of subchunks (the other one is `LIST').</p>
<p>The subchunks have the same format as chunks. The idea is that the rest of the file is a collection of subchunks within the `RIFF' chunk. The size field is not verified (most likely because it is assumed that nothing follows the `RIFF' chunk). Instead, <em>Microsoft</em>'s parser ensures that accesses remain within the bounds of the file by calling the GetFileSize() API and comparing file offsets against the returned value.</p>
<p>The `RIFF' chunk subtype has the name `ACON' (which may be an abbreviation of `Animated iCON'). Very few subchunk types are supported, and some of them depend on the presence of others earlier in the file. For example, until an `anih' type is seen, only a `LIST' type with the `fram' subtype and `icon' subchunk(s) is accepted. All other types are skipped. Once an `anih' type is seen, the `seq', `rate', and additional `anih', types are also accepted.</p>
<h2>Patchwork quilt</h2>
<p>The vulnerability that is being exploited is an unbounded copy operation to a fixed-size stack buffer. Exactly the same vulnerability in exactly the same function was found in 2004. The `anih' subchunk contains a field that specifies the size of the data. While the data are a fixed size - 36 bytes - the value in that field is used in a copy operation. This allowed an attacker to specify an arbitrary size for the block and overflow the stack buffer. At the time, <em>Microsoft</em> patched the vulnerability by adding a requirement that the first `anih' block is exactly 36 bytes long. It's unclear why they did it that way, because the block is copied again later, using the fixed value of 36.</p>
<p>For subsequent `anih' subchunks, the data are copied to the stack buffer, then 36 bytes are copied to another buffer, and <em>then</em> there is a check that the data are exactly 36 bytes long. It is possible that the reviewer thought that this check would prevent exploitation, but by the time the check is made, the buffer has already been overflowed.</p>
<p>This time the patch added the same kind of check for these subsequent `anih' subchunks before they are copied. Since the memory of subsequent `anih' subchunks is allocated dynamically, an additional piece of code was added to free any existing block prior to allocating a new one. So we go from this:</p>
<div class="adhoc" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">if (fccType == &quot;anih&quot;)<br/>
&nbsp; copy &lt;size&gt; bytes to stack<br/>
&nbsp; block = allocate 36 bytes<br/>
&nbsp; copy 36 bytes to block<br/>
&nbsp;</div>
<p>to this:</p>
<div class="adhoc" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">if ((fccType == &quot;anih&quot;) &amp;&amp; (size == 36))<br/>
&nbsp; copy &lt;size&gt; bytes to stack<br/>
&nbsp; if (block != 0) free(block)<br/>
&nbsp; block = allocate 36 bytes<br/>
&nbsp; copy 36 bytes to block<br/>
&nbsp;</div>
<p>instead of the more sensible:</p>
<div class="adhoc" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">if (fccType == &quot;anih&quot;)<br/>
&nbsp; if (block == 0) block = allocate 36 bytes<br/>
&nbsp; copy 36 bytes to block<br/>
&nbsp;</div>
<p>for only a single bounded copy operation, with no need to free anything.</p>
<h2>Breaking Windows</h2>
<p>Despite <em>Microsoft</em>'s claims of improved security, <em>Vista</em> is just as vulnerable as every other version of <em>Windows</em>. There were supposed to be three mitigating factors, but two of them proved unsuccessful in this case.</p>
<p>The first is the Buffer Security Check (/GS), which also exists in <em>Windows XP</em> SP2. This is a stack protection mechanism that is designed to prevent altered return addresses from being used, by checking a value that exists
 
on the stack below the return address. The idea is that if the return address has been altered, then the magic value must also have been altered. However, because of the performance impact of the /GS protection, it is optional - and even then it is applied only to functions that have certain characteristics. More specifically, /GS protection is applied only to functions that contain arrays of five or more characters (ASCII or Unicode), and is not applied to functions that contain only structures with small individual fields. Since the vulnerable routine contains only structures with small individual fields, the Buffer Security Check was not applied.</p>
<p><em>Vista</em>'s second mitigating factor is Address Space Layout Randomization (ASLR), which allows an ASLR-aware process to have its contents placed at a random address in memory. The idea is to make the return address unlikely to be reached in a single attempt, and thus prevent the exploit from succeeding most of the time. However, there are two methods by which an ANI exploit can defeat ASLR on <em>Vista</em>.</p>
<p>The first method is not specific to ANI exploits, but applies to any stack-based exploit for which /GS does not apply. It relies on the fact that, for architectural reasons, ASLR leaves the lower 16 bits of the address unchanged. It randomizes only eight bits of the 32-bit address on the 32-bit versions of <em>Vista</em>, but even if all 15 of the available upper bits were randomized (there would be a significant performance impact to that), the vulnerability would remain. All that is required is to find an appropriate instruction within the 64kb block that holds the existing return address. Then only the lower 16 bits need to be modified for exploitation to succeed, no matter where the process exists in memory.</p>
<h2>Exceptional behaviour</h2>
<p>The second method is specific to ANI exploits, and comes into play if no appropriate instruction can be found. It relies on the fact that a Structured Exception Handler (SEH) is installed by the caller of the vulnerable function.</p>
<p>If an exception occurs, the SEH gains control, but this particular SEH ignores the error and returns success. The process does not crash, and the user will not notice that anything went wrong. The result is that an attacker can send multiple malicious files to the vulnerable function, each with a different return address. Since there are only 256 possible combinations, it becomes a trivial matter to brute-force the correct address and compromise a vulnerable machine.</p>
<p>The only mitigating factor that stands any chance of success is Data Execution Protection/No eXecute (DEP/NX), which is a method for marking a region of data, such as the stack, as non-executable. The problem is that it works only if it is enabled for the process, and by default, DEP/NX it is not enabled for 32-bit <em>Internet Explorer</em> (which is the most likely attack vector), even if hardware-backed DEP/NX is present. A simple attack will attempt to execute directly from the exploited buffer, which DEP/NX will prevent. However, it is possible (though not easy) to craft the stack to execute the VirtualProtect() API on the exploited buffer first, and then to execute the exploited buffer itself. DEP/NX cannot prevent such an action.</p>
<p><em>Internet Explorer</em> can be exploited easily because it supports animated cursors. According to a <em>Determina</em> advisory, <em>Firefox</em> is vulnerable too, despite the fact that it does not support animated cursors. However, given the fact that icons can be animated, and that there are multiple paths to the same code (LoadCursor(), LoadIcon(), and LoadImage(), and perhaps things like CopyImage(), GetCursorFrameInfo(), and SetSystemCursor()), it seems highly likely that <em>Firefox</em> can be coerced into calling an appropriate API. <em>Windows Explorer</em> is exploited automatically without user interaction when browsing a directory that contains a malicious file, because <em>Explorer</em> parses the file in order to display the icon.</p>
<h2>Oops I did it again</h2>
<p>Continuing the long tradition of attackers who don't seem to understand what they're doing, we saw a collection of odd attempts at exploiting this vulnerability. The funniest one contained the `LIST' chunk name spelled backwards. This may have been the result of bad disassembling, but the other chunk names were correct, which made the misspelling very perplexing.</p>
<p>There were also chunks with odd-sized blocks, but this is legal and perhaps was used as a detection bypass. In any case, the only requirements for exploitation are two `anih' blocks, of which the first must be in the correct format (36 bytes long, frame and step count less than 65,536, flags bit 0 set to specify a <em>Windows</em> cursor or icon, etc.) and the second must contain the exploit.</p>
<h2>Conclusion</h2>
<p>So what have we learned from all this? The first ANI vulnerability was the result of bad code. The second ANI vulnerability was the result of more bad code. The way to patch bad code is to remove the bad code, not to add new bad code that hides the old bad code.</p>
<p>A more pertinent question would be: what has <em>Microsoft</em> learned from all this?</p>
 
[<a style="" href="/lib/?lang=EN&amp;index=AN#apf00">Back to index</a>] [<a href="/lib/apf00.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=apf00">de</a><a href="/lib/index.php?lang=en&amp;id=apf00">en</a><a href="/lib/index.php?lang=es&amp;id=apf00">es</a><a href="/lib/index.php?lang=it&amp;id=apf00">it</a><a href="/lib/index.php?lang=fr&amp;id=apf00">fr</a><a href="/lib/index.php?lang=pl&amp;id=apf00">pl</a><a href="/lib/index.php?lang=ru&amp;id=apf00">ru</a><a href="/lib/index.php?lang=ua&amp;id=apf00">ua</a></div>
</body>
</html>
