<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Peter Ferrie 'Flibi: Reloaded' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Peter Ferrie"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Ferrie, Peter,Flibi: Reloaded, codon, command, stop, sequence, commands, gene, version, start, insertion, removed, transfer, jnzdown, flibi, found, chance"/>
<meta name="Description" content="A new version of the W32/Flibi virus has been released. It now supports assemble-time or compile-time polymorphism during construction of the first generation translator code. Its parallels with molecular biology have increased with major changes to the replication process: horizontal gene transfer1, codon exchange, the introduction of start and stop codons, and optionally the addition of introns."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"9a73505a19518b4da2a17b20e85af286d92856bd-1498757771-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/apf61.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Flibi: Reloaded</h1><p><a href="/lib/?lang=en&amp;author=Ferrie%2C%20Peter">Peter Ferrie</a><br/> <em>Virus Bulletin, November 2011, page 12-14</em><br/> <em>ISSN 0956-9979</em><br/> <em>November 2011</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/apf61.html';</script><img src="/img/pdf.gif" alt="PDF"/><a href="/lib/pdf/Flibi%3A%20Reloaded.pdf">Download</a> PDF (41.32Kb) (You need to be registered on <a href="/forum">forum</a>)<br/>[<a style="" href="/lib/?lang=EN&amp;index=AN#apf61">Back to index</a>] [<a href="/lib/apf61.html#disqus_thread">Comments</a>]<br/> <form method="post" action=""><input type="hidden" name="pages" value="1"/><input type="submit" value="Turn on page numbers"/></form>
<ul>
<li><a href="#c1">Remove before use</a></li>
<li><a href="#c2">Assembler-Time Poly</a></li>
<li><a href="#c3">Compiler-Time Poly</a></li>
<li><a href="#c4">Let me count the ways</a></li>
<li><a href="#c5">Minor update</a></li>
<li><a href="#c6">Hash cookies</a></li>
<li><a href="#c7">NOP insertion</a></li>
<li><a href="#c8">Gene transfer</a></li>
<li><a href="#c9">Codon exchange</a></li>
<li><a href="#ca">Start and Stop</a></li>
<li><a href="#cb">Conclusion</a></li>
<li><a href="#cc">References</a></li>
</ul>
<p>A new version of the W32/Flibi virus [<a href="#f1_1" name="b1_1">1</a>,<a href="#f2_2" name="b2_2">2</a>] has been released. It now supports assemble-time or compile-time polymorphism during construction of the first generation translator code. Its parallels with molecular biology have increased with major changes to the replication process: horizontal gene transfer1<sup><a href="#f1" name="b1">I.</a></sup>, codon<sup><a href="#f2" name="b2">II.</a></sup> exchange, the introduction of start and stop codons<sup><a href="#f3" name="b3">III.</a></sup>, and optionally the addition of introns<sup><a href="#f4" name="b4">IV.</a></sup>.</p>
<h2><a name="c1"></a>Remove before use</h2>
<p>This version of the virus lacks several of the commands that were present in the previous version. There are only 32 commands in this version. The commands that have been removed are as follows:</p>
<ul>
<li>_subsaved</li>
<li>_zer0</li>
<li>_add0004, _add0010, _add0040, _add0100, _add0400, _add1000, _add4000</li>
<li>_JzDown</li>
<li>_CallAPIMessageBox, _CallAPISleep</li>
</ul>
<p>The removed commands have been replaced with equivalent sequences using the remaining instruction set, exactly as described in [<a href="#f2_2">2</a>]. Both ‘_subsaved’ and ‘_zer0’ still appear in the source code, but they have been converted to macros. None of the other commands appear. The ‘_subsaved’ macro uses the ‘_addsaved’ command, after negating the value to add. The negate operation is achieved by performing an ‘_xor’ with negative one, and then adding one. The ‘_zer0’ macro uses a combination of the ‘_save’ and ‘_xor’ commands, which is equivalent to using xor on a register value with itself.</p>
<p>The ‘_addnnnn’ commands have been replaced by a generic ‘add’ command. This command uses an instruction sequence
 
that combines the ‘_shl’ and ‘_add0001’ commands in an appropriate way to construct the required value. The ‘_JzDown’ command has been replaced by a combination of ‘_JnzDown’ commands, where one ‘_JnzDown’ command branches to a ‘_call’ command to reach the destination of the ‘true’ condition, and the other ‘_JnzDown’ command branches over the ‘_call’ command to reach the destination of the ‘false’ condition. The MessageBox API has been removed because the virus no longer has a payload, and the Sleep API has been removed because the virus uses a new hashing that does not produce the same false match.</p>
<h2><a name="c2"></a>Assembler-Time Poly</h2>
<p>Depending on the version that is used, the translator code polymorphism is either assemble-time or compile-time. The assemble-time polymorphism is achieved by using a routine that generates garbage instructions in the translator code. The assemble-time translator code garbage generator (ATCG) is composed of macros that are interpreted while the source code is being assembled into the fi rst generation of the virus code. The randomness is achieved by seeding a random number generator with the current time, which the assembler allows. The ATCG is called eight times initially, and then once after each non-conditional instruction sequence, and after the single API call. In the case of a conditional instruction sequence (that is, a cmp instruction followed by a branch instruction), the sequence will not be separated. In the case of the API call, the parameters are not separated.</p>
<p>The ATCG chooses randomly if it will run, with a 50% chance of doing so. Once it is running, it emits one instruction sequence at a time, chosen randomly from a set of 15 instruction sequences. It then chooses randomly if it will continue to run, with about a 94% chance of doing so. The instruction sequences consist of operations that do not alter any registers, so they are harmless to the code. However, a number of them do alter the flags as a side effect of their operation, which is why they cannot be placed between a cmp and branch instruction sequence. There are some instructions that do not have any side effects, which could be used to break a cmp and branch instruction sequence, but selecting them from the list would increase the complexity of the routine for little gain.</p>
<h2><a name="c3"></a>Compiler-Time Poly</h2>
<p>Compile-time translator code polymorphism is achieved by using a program to generate the assembler code that is then assembled into the fi rst generation of the virus code. It still applies to the translator code, but it replaces the garbage generator in the assemble-time polymorphism described above. The compile-time translator code garbage generator (CTGG) can perform multiple operations on randomly selected registers, and the instruction set is larger. The CTGG knows which registers are currently in use and avoids generating operations on them. The CTGG can also be directed only to use instructions that do not alter the flags, which allows a conditional instruction sequence to be separated. The CTGG contains the set of six instructions that do not alter the flags (although, due to a bug, only fi ve of them can be selected). A second set contains 11 instructions, six of which are the same as the set which does not alter the flags, and the other fi ve instructions will alter the flags as a side effect of their operation.</p>
<p>The CTGG chooses randomly if it will run, with a 50% chance of doing so. Once it is running, it emits one instruction sequence at a time, chosen randomly from the appropriate set. It then chooses randomly if it will continue to run, with about a 94% chance of doing so. The CTGG is called in a loop initially, with only a 10% chance that the loop will exit on any iteration. Thereafter, the CTGG is called after each real instruction.</p>
<p>The reason why both kinds of polymorphism were introduced is because the translator code is the weakest part of the virus in two ways. It is weak because it is native code, allowing a detection to be guided by the presence of that routine. The polymorphism complicates the detection a little. It is also weak <em>because it is native code</em>. Since the routine is small, and the opcodes generally have no alternative values, mutations in this routine are often lethal. The introduction of garbage instructions results in a smaller risk of lethal mutation because the risk is spread over a wider area.</p>
<h2><a name="c4"></a>Let me count the ways</h2>
<p>There are three other polymorphism methods which are applied at assemble time, but which are also contained in the assembler code that is the output of the compiled code. The fi rst part of this assemble-time polymorphism is that the native instructions no longer begin on eight-byte boundaries (with the exception of the ‘_getEIP’, ‘_JnzUp’ and ‘_JnzDown’ commands), followed by no-operation instructions to fi ll the gap. Instead, the block begins on eight-byte boundaries, but the native instructions are placed randomly within the eight-byte block and surrounded by no-operation instructions.</p>
<p>The second part of the assemble-time polymorphism is that since there are only a few commands, many of them are duplicated enough times to fi ll the 256 slots available. Then, whenever a command is requested, its value is chosen randomly from the list that might contain multiple entries for that command. Thus, even the fi rst generation of the virus will likely have multiple codons referring to the same amino acid.</p>
 
<p>The third part of the assemble-time polymorphism is applied optionally, by setting the appropriate value in a particular variable in the assembler source code. The alphabet that is used can either be a pre-generated one or a dynamically generated one. The dynamically generated one will fi ll the slots randomly. There is a minor bug in the routine when assigning the ‘unused’ command to a slot – the wrong command name is displayed as informational text, but it has no effect on the execution of the virus.</p>
<h2><a name="c5"></a>Minor update</h2>
<p>The virus has some minor changes to its code, too. There is a new hashing algorithm, a new fi lename, and a rewritten nop insertion routine.</p>
<h2><a name="c6"></a>Hash cookies</h2>
<p>The new hashing algorithm simply sums 16 bits at a time (though two comments in the source code show two different algorithms, neither of which is the one that is used) at each position of the API name, up to and including the fi nal zero (so ‘AddAtomA\0’ is ‘Ad’ + ‘dd’ + ‘dA’ + ‘At’ + ‘to’ + ‘om’ + ‘mA’ + ‘A\0’). The low 12 bits of the result are retained and compared to an entry in a hash table that the virus carries. The API is considered to be found when the hashes match. This routine is repeated until all of the required APIs are found. The routine loads APIs from ‘kernel32.dll’ fi rst, and then ‘advapi32.dll’ (despite the comments in the source code referring again to ‘kernel32.dll’).</p>
<p>The virus constructs a new fi lename for the next-generation fi le, in the same manner as the previous version, and copies itself as ‘x:\evolusss.exe’, where ‘x’ is the drive letter taken from the command line. It also copies itself to the next-generation fi lename.</p>
<p>The virus constructs a new fi lename for the next-generation fi le, in the same manner as the previous version, and copies itself as ‘x:\evolusss.exe’, where ‘x’ is the drive letter taken from the command line. It also copies itself to the next-generation fi lename.</p>
<p>The virus opens the next-generation fi le and maps it into memory. As with the previous version, it will flip bits or dwords throughout its body. A bug has been fi xed here, which is that the dword exchange will not occur within the last nine bytes of the fi le, to avoid a possible exception from occuring because of an out-of-bounds access.</p>
<h2><a name="c7"></a>NOP insertion</h2>
<p>The nop insertion routine has been corrected to no longer delete the bytes immediately following the insertion point. Instead, all of the bytes following the insertion point are moved towards the end of the fi le according to the size of the gap to be introduced. The virus inserts a gap of up to 32 bytes in size, and fi lls the gap with no-operation commands.</p>
<h2><a name="c8"></a>Gene transfer</h2>
<p>The horizontal gene transfer works by ‘borrowing’ bytes from a single randomly located fi le, and inserting them into the virus body. This can introduce new behaviours if the new bytes happen to make sense in the context of the current code. The routine has a 20% chance of running. If it runs, then it searches within the current directory for any object. It tries to detect directories by checking the exact attribute, instead of masking off all other bits. As a result, it fails to detect a directory if the directory has additional attributes set (such as ‘hidden’). However, this is a minor bug which is harmless because any attempt to open the directory will fail. For any fi le that is found, there is a 20% chance that the routine will attempt to open it. The routine attempts to copy up to ten bytes from a random location in the fi le it has found to a random location in the virus fi le. There is a bug in this routine, which is that there is no check that the fi le it has found is not empty. If the fi le is empty, then any attempt to copy content from it will cause an exception and the virus will crash.</p>
<h2><a name="c9"></a>Codon exchange</h2>
<p>The codon exchange routine searches within the alphabet for amino acids referred to by multiple codons, and randomly exchanges the codons within the virus body.</p>
<h2><a name="ca"></a>Start and Stop</h2>
<p>The start and stop codons allow the explicit delimiting of a block of valid code (an exon). Any values that appear after a stop codon and before a start codon are junk (introns) that will not be executed by the virus. However, in the event of a mutation that corrupts a stop codon, the junk would become part of the exon until the next stop codon is encountered. This allows for a more rapid introduction of new behaviours.</p>
<h2><a name="cb"></a>Conclusion</h2>
<p>W32/Flibi is more like a life-form than ever before. It looks like a heavily armoured threat whose spread might be difficult to stop – perhaps like a cane toad. However, much like the cane toad, it has a soft underbelly which we can learn to attack.</p>
<h2><a name="cc"></a>References</h2>
<p><a name="f1_1" href="#b1_1">1.</a><a href="/lib/apf56.html">Ferrie, P.: "Flibi night", Virus Bulletin, March 2011, p.4.</a></p>
<p><a name="f2_2" href="#b2_2">2.</a><a href="/lib/apf57.html">Ferrie, P.: "Flibi: Evolution", Virus Bulletin, May 2011, p.6.</a></p>
<hr size="1"/>
<p><a name="f1" href="#b1">I.</a> Horizontal gene transfer is a process in which one organism incorporates genetic material from another without being the offspring of that organism. See http://en.wikipedia.org/w/index.php?title=Horizontal_gene_transfer&amp;oldid=452313076.</p>
<p><a name="f2" href="#b2">II.</a> A codon is a trinucleotide sequence of DNA or RNA that corresponds to a specifi c amino acid. See http://www.genome.gov/Glossary/index.cfm?id=36.</p>
<p><a name="f3" href="#b3">III.</a> A stop codon is a nucleotide triplet within mRNA that signals a termination of translation. See http://en.wikipedia.org/w/index.php?title=Genetic_code&amp;oldid=412677908#Start.2Fstop_codons.</p>
<p><a name="f4" href="#b4">IV.</a> An intron is a nucleotide sequence within a gene that is removed by RNA splicing to generate the final mature RNA product of a gene. See http://en.wikipedia.org/w/index.php?title=Intron&amp;oldid=456036842.</p>
 
[<a style="" href="/lib/?lang=EN&amp;index=AN#apf61">Back to index</a>] [<a href="/lib/apf61.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=apf61">de</a><a href="/lib/index.php?lang=en&amp;id=apf61">en</a><a href="/lib/index.php?lang=es&amp;id=apf61">es</a><a href="/lib/index.php?lang=it&amp;id=apf61">it</a><a href="/lib/index.php?lang=fr&amp;id=apf61">fr</a><a href="/lib/index.php?lang=pl&amp;id=apf61">pl</a><a href="/lib/index.php?lang=ru&amp;id=apf61">ru</a><a href="/lib/index.php?lang=ua&amp;id=apf61">ua</a></div>
</body>
</html>
