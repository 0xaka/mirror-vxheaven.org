<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Peter Ferrie 'Hidan and dangerous' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Peter Ferrie"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Ferrie, Peter,Hidan and dangerous, file, version, function, plug, means, hidan, init, files, chiton, entrypoint, versions, windows, data, structure, virus"/>
<meta name="Description" content="One of the things that almost all anti-malware researchers have in common is a copy of Interactive DisAssembler (IDA). It is perhaps the best tool we have for disassembling files, since it is capable of so many important things: it displays the file more or less as it really appears in memory, applying relocations, and resolving imports. IDA can follow all of the code paths and note all of the data references, comment the API parameters, and even determine the stack parameters.Since some people have custom requirements, IDA also supports a plug-in interface. Plug-ins can do many things and control many of IDA's actions - including directing it to infect files.Enter the latest member of the ever-growing W32/Chiton family. The author of the virus calls this one `W32/Hidan'."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"e0c6883ea868e948cd36c634dedd708a082e7f9a-1498756385-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/apf20.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Hidan and dangerous</h1><p><a href="/lib/?lang=en&amp;author=Ferrie%2C%20Peter">Peter Ferrie</a><br/> <em>Virus Bulletin, March 2007, pp.4-5</em><br/> <em>ISSN 0956-9979</em><br/> <em>March 2007</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/apf20.html';</script><img src="/img/pdf.gif" alt="PDF"/><a href="/lib/pdf/Hidan%20and%20dangerous.pdf">Download</a> PDF (46.67Kb) (You need to be registered on <a href="/forum">forum</a>)<br/>[<a style="" href="/lib/?lang=EN&amp;index=AN#apf20">Back to index</a>] [<a href="/lib/apf20.html#disqus_thread">Comments</a>]<br/> <form method="post" action=""><input type="hidden" name="pages" value="1"/><input type="submit" value="Turn on page numbers"/></form>
<address>
Peter Ferrie<br/>
Symantec Security Response, USA
</address>
<p>One of the things that almost all anti-malware researchers have in common is a copy of <em>Interactive DisAssembler (IDA)</em>. It is perhaps the best tool we have for disassembling files, since it is capable of so many important things: it displays the file more or less as it really appears in memory, applying relocations, and resolving imports. <em>IDA</em> can follow all of the code paths and note all of the data references, comment the API parameters, and even determine the stack parameters.</p>
<p>Since some people have custom requirements, <em>IDA</em> also supports a plug-in interface. Plug-ins can do many things and control many of <em>IDA</em>'s actions - including directing it to infect files.</p>
<p>Enter the latest member of the ever-growing W32/Chiton family. The author of the virus calls this one `W32/Hidan'.</p>
<h2>Where are you hiding?</h2>
<p>When Hidan is started for the first time, it queries the default value of the `HKCR\.idb' registry key. The virus author assumes that if this registry key is present, then <em>IDA</em> must also be present on the system. The registry key is created when the <em>Windows</em> GUI version of <em>IDA</em> is started for the first time. However, the command-line version of <em>IDA</em> does not create this key. What's more, there are other tools, such as <em>Microsoft Visual Studio</em>, that use the same registry key, so its presence on the system is no guarantee that <em>IDA</em> is present.</p>
<p>Regardless of which application created the registry key, the registry value will contain the name of the handler. In the case of <em>IDA</em>, the value is `IDApro.Database32'. The virus then queries the default value of its `shell\open\command' subkey. The data usually contain the following string:</p>
<pre>"&lt;path>\idag.exe" "%1"</pre>
<p>The virus searches this string for the second quote, while remembering the location of the last backslash. Once the second quote is found, the virus appends the string `plugins' after the last backslash, so the string becomes `&lt;path>\plugins'. This is the directory in which <em>IDA</em> keeps its plug-ins.</p>
<h2>Bend and stretch</h2>
<p>The virus decompresses and drops a plug-in file in the plugins directory, using the (fixed) filename `hidan.plw'. The file contains only the virus code.</p>
<p>As with the other viruses in the Chiton family, this one is aware of the techniques that are used against viruses that drop files, and will work around all of the commonly used countermeasures: if a file exists already, its read-only attribute (if any) will be removed, and the file will be deleted. If a directory exists instead, then it will be renamed to a random name.</p>
<p>The structure of the dropped file is similar to that of the W32/OU812 member of the W32/Chiton family. However, Hidan differs in one way: the entrypoint of the file is inside the file header itself, which can complicate analysis slightly (particularly when using <em>IDA</em>). The file is also not constant, because the virus knows which bytes in the file header are not used, and replaces them with a value chosen randomly at the time of dropping the file.</p>
<p>After dropping the file, the virus runs the host code.</p>
<h2>Plugging the hole</h2>
<p>Apart from dropping the file, the virus performs no other actions in infected files. It simply waits until <em>IDA</em> loads the viral plug-in.</p>
<p>When <em>IDA</em> starts, it loads all plug-ins that correspond to the platform on which it is running. <em>IDA</em> runs on the 32-bit and 64-bit versions of <em>Windows</em>, and the 32-bit and 64-bit versions of <em>Linux</em>. Additionally, in the Professional version of <em>IDA</em>, there is a 32-bit <em>Windows</em> version that supports 64-bit addressing, so it is capable of loading 64-bit files on a 32-bit machine.</p>
<p>Each of these versions has its own plug-in format and suffix to distinguish them. The suffix `plw' means that the plug-in is for the 32-bit <em>Windows</em> version of <em>IDA</em>; `x86' means that the plug-in is for the 64-bit <em>Windows</em> version; `p64' means that the plug-in is for the 32-bit <em>Windows</em> version of <em>IDA</em> that supports 64-bit addressing. The suffix `plx' means that the plug-in is for the 32-bit <em>Linux</em> version of <em>IDA</em>, and the suffix `plx64' means that the plug-in is for the 64-bit <em>Linux</em> version of <em>IDA</em>.</p>
<h2>IDA symbolism</h2>
<p>Internally, plug-ins are ordinary DLLs on the <em>Windows</em> platform, or shared libraries on the <em>Linux</em> platform. Plug-ins must export one special symbol, called either `PLUGIN' or `_PLUGIN', or it must be ordinal 1 on the <em>Windows</em> platform.</p>
<p>The symbol is a pointer to a plug-in structure. The structure contains a field which holds the version number of the SDK used to produce the plug-in. That version number must match the version that <em>IDA</em> is expecting, otherwise it will
 
refuse to load the plug-in. There are two versions of the virus: one is compatible with <em>IDA 4.8</em>, and one is compatible with <em>IDA</em> version 4.9. While the SDK version did not change between <em>IDA</em> versions 4.9 and 5.0 (the current version at the time of writing), the behaviour of <em>IDA</em> did.</p>
<h2>The terminator</h2>
<p>The plug-in structure contains three pointers to functions, `init', `term', and `run'. The init function is used to initialize the plug-in. The term function is used to terminate the plug-in. The run function is used to run the main part of the plug-in.</p>
<p>In <em>IDA</em> prior to version 5.0, if a plug-in init function returned a value of 0, which means that the plug-in cannot or did not want to load (perhaps because the environment is not compatible, or the file to examine is not of the correct format, etc.), <em>IDA</em> would free the plug-in directly (via the FreeLibrary() API on the <em>Windows</em> platform). Thus, neither the run nor term functions would be called, so the virus author did not include them in the virus.</p>
<p>However, in <em>IDA</em> version 5.0, if the term function pointer is non-zero, then <em>IDA</em> will call the term function before calling FreeLibrary(). Since the virus does not support this function (there are data at that location, but not a function pointer), the virus crashes at that point, taking <em>IDA</em> down with it. This seems a silly bug just to save four bytes of zeroes.</p>
<p>Unfortunately, the virus has already done its work by the time it crashes, since the init function contains the replication code.</p>
<h2>Initiation ceremony</h2>
<p>When the viral plug-in init function is called, it begins by retrieving some file infection-related API addresses from kernel32.dll, the IsFileProtected() API address from sfc.dll (or sfc_os.dll if the platform is <em>Windows XP/2003</em>), and two undocumented symbols from ida.wll (RootNode and netnode_value in the .A version, or netnode_valstr() in the .B version).</p>
<p>When the netnode API is called with the value held by the RootNode symbol, an ANSI-format pathname is returned. That pathname corresponds to the file being examined by <em>IDA</em>. The virus converts that pathname to Unicode format, then passes it to the IsFileProtected() API.</p>
<p>If the file is not protected, then it will be infected only if it passes a very strict set of filters. These filters include the condition that the file being examined must be a character mode or GUI application for the <em>Intel</em> 386+ CPU, that the file must have no digital certificates, and that it must have no bytes outside of the image.</p>
<h2>Touch and go</h2>
<p>If the file meets the infection criteria, it will be infected. If relocation data exist at the end of the file, the virus will move the data to a larger offset in the file, and place its own code in the gap that has been created. If there are no relocation data at the end of the file, the virus code will be placed here. The entrypoint is altered to point to the virus code. The virus will calculate a new file checksum, if one existed previously.</p>
<p>Once the infection is complete, the virus forces an exception to occur in order to terminate the replication code and return to the init function. The init function then returns a value of zero to <em>IDA</em>, to signal that the plug-in should be unloaded.</p>
<p>The interesting thing is that since <em>IDA</em> has already started to load the now-infected file, the change to the entrypoint is not visible - though the virus code can be seen if one knows where to look for it, and if the file is reloaded, the full changes are visible.</p>
<p>Of course, it would be possible for a plug-in to interfere with all of that - the plug-in could remain in memory and intercept disk accesses. It could also restore the host entrypoint label and remove the viral one. However, this seems like an even more pointless exercise than writing the virus in the first place.</p>
<h2>Conclusion</h2>
<p>This member of the Chiton family is just a proof-of-concept virus for a new platform, created by a virus author who specialises in them. Given its simplicity, Hidan might be considered to be hiding in plain sight.</p>
<table summary="W32/Chiton variant">
<tr><th colspan="2">W32/Chiton variant</th></tr>
<tr><th>Type:</th><td>Memory-resident parasitic appender/inserter.</td></tr>
<tr><th>Size:</th><td>1,321 bytes (.A), 1,330 bytes (.B)</td></tr>
<tr><th>Infects:</th><td>Windows Portable Executable files.</td></tr>
<tr><th>Payload:</th><td>None.</td></tr>
<tr><th>Removal:</th><td>Delete infected files and restore them from backup.</td></tr>
</table>
 
[<a style="" href="/lib/?lang=EN&amp;index=AN#apf20">Back to index</a>] [<a href="/lib/apf20.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=apf20">de</a><a href="/lib/index.php?lang=en&amp;id=apf20">en</a><a href="/lib/index.php?lang=es&amp;id=apf20">es</a><a href="/lib/index.php?lang=it&amp;id=apf20">it</a><a href="/lib/index.php?lang=fr&amp;id=apf20">fr</a><a href="/lib/index.php?lang=pl&amp;id=apf20">pl</a><a href="/lib/index.php?lang=ru&amp;id=apf20">ru</a><a href="/lib/index.php?lang=ua&amp;id=apf20">ua</a></div>
</body>
</html>
