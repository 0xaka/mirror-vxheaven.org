<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Igor Daniloff 'Anarchy in the USSR' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Igor Daniloff"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Daniloff, Igor,Anarchy in the USSR, table, newexe, program, document, windows, stealth, documents, system, files, installation, bytes, hide, size, close, russian"/>
<meta name="Description" content="The Anarchy family, first seen in 1994, was named after a string in its code and a reference to an anarchist musical ensemble from Omsk. In the West, aliases include GrOb. Unto, and Vivat."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"48b361320c89f7176d3ef5631db213e387d59524-1498755491-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/aid02.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Anarchy in the USSR</h1><p><a href="/lib/?lang=en&amp;author=Daniloff%2C%20Igor">Igor Daniloff</a><br/> <em>VIRUS BULLETIN</em><br/> <em>October 1997</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/aid02.html';</script><div class="ci"><a href="/lib/?ci=aid02">1</a></div>[<a style="" href="/lib/?lang=EN&amp;index=AN#aid02">Back to index</a>] [<a href="/lib/aid02.html#disqus_thread">Comments</a>]<br/> 
<ul>
<li><a href="#p1">Installation from an Infected DOS File</a></li>
<li><a href="#p2">Int 21h Handler</a></li>
<li><a href="#p3">Document Infection Engine</a></li>
<li><a href="#p4">Installation from the NewExe File</a></li>
<li><a href="#p5">Payload</a></li>
<li><a href="#p6">Summary</a></li>
</ul>
<p>The Anarchy family, first seen in 1994, was named after a string in its code and a reference to an anarchist musical ensemble from Omsk. In the West, aliases include GrOb. Unto, and Vivat. In June 1997, two years after the release of Anarchy.6503, the last specimen of the series, I was surprised to receive a copy of the latest addition to the family, Anarchy.6093 - intelligent enough to infect not only DOS COM and EXE files, but also Word documents.</p>
<h2><a name="p1"></a>Installation from an Infected DOS File</h2>
<p>On starting an infected COM or EXE, the polymorphic decryptor explodes the main virus body and passes control to it, which first computes a 16-bit CRC of its code. This is compared to the CRC saved at file infection. If there is a discrepancy, it hangs the system by looping back to itself.</p>
<p>If all is well, the virus checks whether it is already resident by opening the file 'JANKA DYAGILEVA', reading the first 81 bytes, and comparing them to some strings in its body. If Anarchy.6093 is already in memory, it simulates opening that same file with the file handle BX=FFFPh and reading the necessary bytes for verification. If it is already active, then the newly-run copy simply returns control to the host program. If it is not active, it searches the DOS environment for variable names ending 'IR*' and 'EC=' (normally WINDIR and COMSPEC). On finding them, it infects both the WIN.COM file in the WINDIR directory, and the command processor specified by COMSPEC.</p>
<p>Further to this, the virus writes its code in the segment immediately after the PSP of the loaded program, beginning from offset 0142h, and intercepts Int 2Fh, taking over the Get Job File Table Entry function (AX=1220h). When this function is called, the virus' handler sets the JET ES:DI pointer to the virus data, whose first byte is FFh, as though the requested file had not been opened by the system. Thus, the virus tries to prevent analysis of the System File Table. Since Anarchy is invisible at the Int 21h level, denying any program access to the SET is a reliable tactic for hiding itself in an infected file.</p>
<p>Anarchy also checks whether <i>Windows 95</i> is loaded and sets an internal flag for later reference. It then intercepts Int 21h. adjusting the memory block size necessary for the operation of the resident copy, and sets a DOS memory allocation flag. Then it starts the infected program (Int 21h AX=4BOOh), receives the return code (Int 21h AX=4Dh), and terminates the host program (Int 21h AX=4Ch). In this way. Anarchy stays resident and controls interrupts Int 21h and Int 2Fh.</p>
<h2><a name="p2"></a>Int 21h Handler</h2>
<p>Aside from providing its 'Are you there?' call, the Int 21h handler controls nineteen functions for infection and stealth. These are typical of DOS stealth viruses, such as Find First. Find Next, Create, Open, Close, Read, Write File, etc.</p>
<p>When the Load Program (AX=4BOOh) or Close File (AH=3Eh) function is called. Anarchy again checks whether Windows 95 is running and if its internal flag was set. If Windows 95 was not loaded, and started subsequently in an infected DOS environment, the virus, using the function Int 15h AH=87h (Copy Extended Memory), reads the six bytes located at physical address 11OOOh, and checks whether the first machine word at this address is 60FCh (CLD, PUSHA). If this word is detected, the virus assumes that a procedure of driver VMM32.VXD (Virtual Memory Manager) is loaded at 11OOOOh, and modifies the initial bytes of this procedure so that control is first passed to the part of the virus' 32-bit code that is designed to hide the virus in infected COM and EXE files.</p>
<p>This stealth mechanism intercepts file functions of virtual device drivers and, if necessary, 'corrects' the results of the requested operations to hide the virus' presence. I could only identify the 60FCh in computers running the Pan European edition of Windows 95. This part of Anarchy's functionality is probably specifically linked to that edition of Windows 95, which is widely used in Russia. The virus disables its DOS stealth mechanism if it detects that any of the archiving utilities ARJ.EXE, ZIP.EXE, RAR.EXE, or RAR20.EXE are running.</p>
<p>On intercepting file Create, Open and Close functions, the virus checks the extension of the file being accessed. If it is COM. EXE or DOC, the file is infected. For COM and EXE files, the virus makes an encrypted polymorphic copy of its code, appends it to the file, and modifies the header of EXE files, or the initial bytes of COM files, to transfer control to the decryptor in the virus' body. DOC files are treated in an unusual manner. The infection technique used had not been seen prior to the release of Anarchy.6093, which is the first virus to infect OLE2 documents by independently analysing their structure.</p>
<p>When programs named AI??????.EXE, WE?.EXE, or DR???.EXE (AIDSTEST.EXE, WEB.EXE, DRWEB.EXE are Russian scanners) open a document file, the virus disables its document infection engine.</p>
<h2><a name="p3"></a>Document Infection Engine</h2>
<p>On detecting access to a DOC file. Anarchy reads the first 512 bytes into a buffer and checks the first word for the OLE2 signature. It also checks the machine word at offset 1Eh. This word must be equal to nine, which corresponds to the 512 bytes in the document cluster. If these conditions are satisfied, the virus proceeds to analyse the DOC file. It computes the offset of the stream directory in the document, sets the pointer in the file to the header of the second stream (256 bytes past the Root Entry), and reads 256 bytes into a buffer. Then it attempts to find the 'Word Document' header of the stream in the second or third directory entry. The header of this stream is verified only by the first character, 'W' in the stream name. Having detected this, the virus computes the offset and reads 288 bytes from the File Information Block (FIB).</p>
<p>At this point probably the only serious bug In the virus occurs - it does not verify the FIB signature, but assumes that the FIB offset computed in the previous step is correct. This is true only for documents that are longer than 4096 bytes. The virus' FIB computation algorithm is ill-designed for documents with the so-called mini-FAT. With such documents, instead of reading the FIB, Anarchy mistakenly reads the mini-FAT. and all subsequent operations designed to inject the virus code into the document are implemented incorrectly, so the document will obviously be corrupted. What will happen when such a document is opened is only a matter of conjecture. All these points apply equally to Word 8 documents, as they utilize a format different from that of Word 6/7. Word 8 documents will most likely be corrupted by an attempted Anarchy.6093 infection.</p>
<p>Word generally creates documents longer than 4096 bytes, and for such documents. Anarchy computes the FIB offset properly. Next, the virus checks whether the file is a template and whether it is password-protected. In either case, the virus does not infect the file. Otherwise it sets the template bit in the FIB, then it checks the Macro Table size, which as a rule is equal to two. Finally, it checks that the document size is a multiple of 512 bytes.</p>
<p>Documents deemed 'infectible' have their FATS modified so the virus can append a macro to the file. The virus then writes 512 bytes at the end of the infected document, and adds a reference to the Macro Table, which it creates after the 512-byte block. It also specifics the size of this Macro Table and creates the Macro Table. Anarchy writes a flag for only one macro, a randomly-chosen macro encryptor key and the two macro name tables. In the macro name table used by Word's internal macro handling procedures, the macro is named AUTOOPEN, so it is automatically executed on opening the document. However, in the other name table, which is where the macro names displayed in Organizer, Tools/Macro and the like are stored, the virus leaves the macro nameless. More correctly, there is a name, but it is a line containing no printable characters. 'Normal' macro viruses cannot play such tricks, as they depend on Word itself setting up these tables, and Word always creates a displayable name entry in the second table.</p>
<p>Thus, the virus attaches the Macro Table at the file end and then proceeds to create the macro in a buffer. It copies 104 bytes from its body to the beginning of the macro. These 104 bytes start with the standard macro 'SUB MAIN'. Then follows a simple routine to find a currently unused EXE filename and create a file with that name. This file is then opened for writing with the file handle '#1'. Using string manipulation and print commands, the virus builds a WordBasic routine in the macro to drop a copy of the virus binary code. To achieve this, it scans its resident code, splitting it into sub-strings up to 128 characters long, and writes these into the macro. As a simplified example: &lt;skiped&gt;</p>
<p>Incredible! Anarchy assigns characters to C$ that cannot be created at the keyboard. It transfers the binary virus code, including all the characters from 0 to 255, to the variable C$.</p>
<p>After scanning the resident code and creating commands in WordBasic, Anarchy writes the concluding instructions</p>
<pre>
	Close           close the newly created EXE
	Shell N$        start the newly created EXE
	Kill N$         delete the EXE
	END SUB         the end of the macro
</pre>
<p>The macro in memory is then encoded with the previously generated encryption key and written to the end of the document. This completes the infection mechanism. It is clear that on opening an infected file in Word, a file in NewExe format will be created, run, then deleted. It only remains to discover what this program does.</p>
<h2><a name="p4"></a>Installation from the NewExe File</h2>
<p>The Windows NewExe file dropped by the virus' macro is quite novel. Its NE signature is immediately after the MZ signature of the DOS EXE file and, as a result, there is no DOS stub for the NewExe file.</p>
<p>On execution, this program calls the KERNEL. 192 (Global- PageLock) and KERNEL. 172 (AllocAlias) functions. Then control is transferred to the 16-bit code that is also used in infected DOS files for finding and infecting the command processor defined in the COMSPEC variable, and the WIN.COM file in the WINDIR directory. After these operations, the functions KERNEL. 176 (FreeSelector) and KERNEL. 192 (GlobalPugeUnlock) are called, and the program exits by calling Int 21h AX=4COOh (Terminate).</p>
<h2><a name="p5"></a>Payload</h2>
<p>On 8 and 30 April, and 9 May, the virus writes a Russian quatrain to randomly-selected hard disk sectors. This routine runs only if the disk handler of lnt 13h has 63h (ARPL) as the first byte - this is true under Windows 95.</p>
<h2><a name="p6"></a>Summary</h2>
<p>Anarchy.6093 is the first multi-platform virus to infect COM and DOS EXE files, drop a Windows NewExe virus, and inject a dropper into Word 6/7 documents. It is also the first virus known to hide its presence under Windows 95 by modifying the system driver VMM32.VXD, which operates in protected mode as a supervisor.</p>
<p>Anarchy.6093 is the first multi-platform virus to infect COM and DOS EXE files, drop a Windows NewExe virus, and infect a dropper into Word 6/7 documents. It is also the first virus known to hide its presence under Windows 95 by modifying the system driver VMM32.VXD, which operates in protected mode as a supervisor.</p>
<p>The ability to migrate along with documents explains why Anarchy.6093 hit Russia at such a rate. I received the first specimen from Siberia. A day later I received an avalanche of infected files from Moscow and other central Russian cities miles away. The epidemic spread the length and breadth of Russia in literally two or three days and even visited the LAN at Duma (the Russian State legislative assembly). I cannot recall any other virus that hopped from one computer to another at such lightning speed.</p>
<p>Anarchy.6093</p>
<table border="1" cellspacing="0" cellpadding="0" summary="Anarchy.6093 summary">
<tr><th>Aliases</th><td>None known</td></tr>
<tr><th>Type</th><td>Memory resident parasitic, stealth, polymorphic COM, EXE file and DOC 0LE2 infector.</td></tr>
<tr><th>Infection</th><td>COM, EXE, and DOC flies and drops a Windows NewExe file from Trojanized DOC flies.</td></tr>
<tr><th>Self-recognition in COM and EXE Files</th><td>Bit 15 in year field of file time-stamp. Russian text strings at file end. </td></tr>
<tr><th>Self-recognition in DOC Files</th><td>Will not infect If template bit set. </td></tr>
<tr><th>Self-recognition in Memory</th><td>Open file JANKA DYAGILEVA and read 81 bytes: see descriptions</td></tr>
<tr><th>Self-recognition in Files</th><td>Bit 1 and bit 4 in seconds field of file's time-stamp set</td></tr>
<tr><th>Hex Pattern in Files</th><td>None possible.</td></tr>
<tr><th>Hex Pattern in Memory</th><td>9C3D 0042 751B 83FB FF75 162E 381E 6CI9 750F 23D2 750B 23C9</td></tr>
<tr><th>Intercepts</th><td>lnt 2Fh for stealth routine and lnt 21h for infection and stealth routine in DOS. Patch VMM32.VXD in Windows 95.</td></tr>
<tr><th>Trigger</th><td>On 8, 30 April and 9 May, overwrites random disk sectors.</td></tr>
<tr><th>Removal</th><td>Infected files are identified and restored from a clean system.</td></tr>
</table>
[<a style="" href="/lib/?lang=EN&amp;index=AN#aid02">Back to index</a>] [<a href="/lib/aid02.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=aid02">de</a><a href="/lib/index.php?lang=en&amp;id=aid02">en</a><a href="/lib/index.php?lang=es&amp;id=aid02">es</a><a href="/lib/index.php?lang=it&amp;id=aid02">it</a><a href="/lib/index.php?lang=fr&amp;id=aid02">fr</a><a href="/lib/index.php?lang=pl&amp;id=aid02">pl</a><a href="/lib/index.php?lang=ru&amp;id=aid02">ru</a><a href="/lib/index.php?lang=ua&amp;id=aid02">ua</a></div>
</body>
</html>
