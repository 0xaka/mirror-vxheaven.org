<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Peter Ferrie 'Sobig, sobigger, sobiggest' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Peter Ferrie"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Ferrie, Peter,Sobig, sobigger, sobiggest, details, download, bytes, address, text, event, date, copy, file, version, drive, list, random, data, registry"/>
<meta name="Description" content="W32/Sobig is big, its code is bad, and its style is ugly. In the absence of correct information, there has been speculation and wrong information in abundance. Let us restrict ourselves to the facts."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"07582becd138d03bf50da5b7515af4d359f510f7-1498757149-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/apf52.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Sobig, sobigger, sobiggest</h1><p><a href="/lib/?lang=en&amp;author=Ferrie%2C%20Peter">Peter Ferrie</a><br/> <em>Virus Bulletin, october 2003, pp. 5-10</em><br/> <em>ISSN 0956-9979</em><br/> <em>October 2003</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/apf52.html';</script><div class="ci"><a href="/lib/?ci=apf52">1</a></div><img src="/img/pdf.gif" alt="PDF"/><a href="/lib/pdf/Sobig%2C%20sobigger%2C%20sobiggest.pdf">Download</a> PDF (446.92Kb) (You need to be registered on <a href="/forum">forum</a>)<br/>[<a style="" href="/lib/?lang=EN&amp;index=AN#apf52">Back to index</a>] [<a href="/lib/apf52.html#disqus_thread">Comments</a>]<br/> <form method="post" action=""><input type="hidden" name="pages" value="1"/><input type="submit" value="Turn on page numbers"/></form>
<address>
Peter Ferrie<br/>
Symantec Security Response, USA
</address>
<ul>
<li><a href="#c1">Initialization</a></li>
<li><a href="#c2">Register now!</a></li>
<li><a href="#c3">The big event</a></li>
<li><a href="#c4">Socket 2.ME</a></li>
<li><a href="#c5">Best is used before#</a></li>
<li><a href="#c6">Up, up and update</a></li>
<li><a href="#c7">Ever header of the mailman?</a></li>
<li><a href="#c8">Schmoozing and networking</a></li>
<li><a href="#c9">Conclusion</a></li>
</ul>
<p>W32/Sobig is big, its code is bad, and its style is ugly. In the absence of correct information, there has been speculation and wrong information in abundance. Let us restrict ourselves to the facts.</p>
<h2><a name="c1"></a>Initialization</h2>
<p>All known variants of Sobig begin by initialising their random number generator, using the current time as the seed. The first line of code, and here’s the first bug already: the initialisation is carried out only once, in the main thread, but the random number generator supports multi-threading (using Thread Local Storage – see <em>VB</em>, June 2002, p.4), and the worm uses multiple threads. Thus, the random number generator is not initialised in those threads (the seed always begins at zero), resulting in the same sequence whenever the worm is executed. The same bug exists in some other multi-threaded viruses, such as W32/Welchia (described on p.10), and appears to be a common programming error.</p>
<p>Sobig.A checks the current date at this point. The second line of code, and – yes – here’s the second bug. The worm converts the date to ‘yyyy.mm.d’ format, and compares the date against ‘2003.1.23’ (23 January 2003). The problem is that specifying ‘mm’ requests the month in a two-digit form, which <em>Windows</em> dutifully supplies, using a leading zero for the months prior to October (the 10th month). This results in a date format of, for example, ‘2003.01.23’ so the comparison always fails. The format should have been ‘yyyy.m.d’. Later variants of Sobig check the date in a different way, which works correctly.</p>
<p>Sobig then checks whether it has been run with any command-line parameters. If it has been run without parameters, it assumes that it was launched by the user (either as an email attachment, or as a file that was copied across the network, for the variants that exhibit this behaviour).</p>
<p>When run without command-line parameters, the worm will compare its path name against the common path name that it uses on a compromised machine. If the two differ, the worm will attempt to make a copy of itself using the common path name. What might be considered a bug exists here too – the comparison of the name is case-sensitive, but <em>Windows</em> does not alter the case of a filename when copying over an existing file, so if the case of the worm filename is ever altered, the worm will attempt to copy itself every time it is executed without command-line parameters.</p>
<p>All known variants of Sobig attempt to copy themselves to the <em>Windows</em> directory (as specified by the %windir% environment variable), however the filename has been changed with each version. The list follows:</p>
<table summary="Sobig filenames">
<tr><td>Sobig.A: winmgm32.exe</td><td>Sobig.D: cftrb32.exe</td></tr>
<tr><td>Sobig.B: msccn32.exe</td><td>Sobig.E: winssk32.exe</td></tr>
<tr><td>Sobig.C: mscvb32.exe</td><td>Sobig.F: winppr32.exe</td></tr>
</table>
<p>If the copy fails (for example, if the user created a directory using the worm filename, as an attempt at a counter-measure), the worm will use the name of the currently executing file instead.</p>
<h2><a name="c2"></a>Register now!</h2>
<p>If the path names match, or after the copy is attempted, and, in the case of Sobig.D, no other copies of the variant seem to be running (another bug, see below), the worm will add itself to the registry, by altering the Software\Microsoft\Windows\CurrentVersion\Run key in both the ‘LocalMachine’ and ‘CurrentUser’ hives. This ensures that the worm will be executed whenever <em>Windows</em> is rebooted. The value has been changed with each version. The list follows:</p>
<table summary="Sobig registry keys">
<tr><td>Sobig.A: WindowsMGM</td><td>Sobig.D: SFtrb Service</td></tr>
<tr><td>Sobig.B: System Tray</td><td>Sobig.E: SSK Service</td></tr>
<tr><td>Sobig.C: System MScvb</td><td>Sobig.F: TrayX</td></tr>
</table>
<p>All known variants of Sobig prior to Sobig.F have no command-line parameter in their registry data, so the initialisation code is executed whenever <em>Windows</em> reboots, adding to the overhead of the system. Sobig.F adds a command-line parameter (‘/sinc’) to its registry data.</p>
<p>After the registry has been altered, the worm executes itself again, this time with a command-line parameter, in order to proceed with the main execution. The contents of the parameter are never checked, only its presence or absence. Each version of the worm passes a specific parameter to itself, and the parameter has been changed with each version except Sobig.D and Sobig.E. The list follows:</p>
<table summary="Sobig parameters">
<tr><td>Sobig.A: start</td><td>Sobig.D: dwaqr</td></tr>
<tr><td>Sobig.B: xcvfd</td><td>Sobig.E: dwaqr</td></tr>
<tr><td>Sobig.C: dwaqr</td><td>Sobig.F: /sinc</td></tr>
</table>
<h2><a name="c3"></a>The big event</h2>
<p>All known variants of Sobig use a named event in an attempt to prevent multiple instances of a variant from running at the same time. The name of the event has been changed with each version:</p>
 
<table summary="Sobig events">
<tr><td>Sobig.A: Worm.X</td><td>Sobig.D: Nibs.X</td></tr>
<tr><td>Sobig.B: Mnkx.X</td><td>Sobig.E: Nuiro.X</td></tr>
<tr><td>Sobig.C: Poss.X</td><td>Sobig.F: TrayX</td></tr>
</table>
<p>Unfortunately, the author(s) of the worm seem(s) to be incapable of mastering the required algorithm, despite several variations on the code in different variants. When a named event is created, the name is added to the global namespace of <em>Windows</em>, which means that the CreateEvent() API will not return a failure for an event that exists already (created by another process or even by a thread within the same process) – the same valid handle will be returned each time. The existence of the named event is that which should be checked. Instead, the worm checks if the event has been set (the worm sets the event whenever the initialisation code has completed). This results in a race condition that can, in turn, allow several copies of the worm to run at the same time – launched, for example, by someone clicking several times on the email attachment that ‘doesn’t seem to do anything’.</p>
<h2><a name="c4"></a>Socket 2.ME</h2>
<p>After the worm’s initialisation has completed, the worm will initialise Winsock support, requesting version 2.2, but ignoring the version that is returned, perhaps assuming that any version will be sufficient (which begs the question: why request such an advanced version?). Several threads are created at this point.</p>
<p>The thread details changed in Sobig.B and again in Sobig.F. Sobig.A creates a thread to notify someone (perhaps the author of the worm) by <em>ICQ</em> pager whenever the worm runs. That thread sends a mail from <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="4aa8cad2272b23260a272b232664292527a8cad3">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script> to <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="23c1a3bb13634a40520d53424446510d404c4ec1a3ba">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script>, with a subject of ‘Notify’ and a body text of ‘Hello’. This code is not present in Sobig.B and later variants, although the thread is still created in the variants prior to Sobig.F. Interestingly, the <em>ICQ</em> user name and body text were removed completely in Sobig.B, restored in Sobig.C–E (though the body text was changed to ‘Worm started’, and the ‘0’ was changed to ‘1’ in Sobig.E), and removed again in Sobig.F.</p>
<p>The remaining threads that are created are for the checking of updates, spreading by email, and spreading by network shares. In Sobig.F, the number of email threads was increased from one to seven.</p>
<h2><a name="c5"></a>Best is used before…</h2>
<p>Once the threads are created, Sobig.B and later variants will check the date on the local computer clock to see if their date of ‘expiry’ has been reached. The ‘expiry’ dates are as follows:</p>
<table summary="Sobig expiry dates">
<tr><td>Sobig.B: 31</td><td>May 2003</td><td>Sobig.E: 14 July 2003</td></tr>
<tr><td>Sobig.C: 8</td><td>June 2003</td><td>Sobig.F: 10 September 2003</td></tr>
<tr><td>Sobig.D: 2</td><td>July 2003</td></tr>
</table>
<p>If the expiration date has not been reached, the worm will enumerate the drive letters from A: to Z:, with a three-second delay between each drive, searching for non-removable drives. For each non-removable drive that is found, the worm will search recursively through all subdirectories, looking for files whose suffix matches one of those on the list that the worm carries.</p>
<p>All known variants of Sobig carry a list that contains: txt, eml, html, htm, dbx and wab. Additionally, the list in Sobig.F contains mht and hlp. The contents of files whose suffix matches one of those on the list will then be searched for texts that resemble email addresses. The worm uses OLE Automation to drive the VBScript regular expression engine to find these texts. The expression used by the worm is</p>
<p>[A-Za-z0-9]+[A-Za-z0-9_.-]+@(([A-Za-z0-9\-])+[.])+[A-Za-z]+</p>
<p>which translates to: must contain at least one letter/number, followed by at least one letter/number/underscore/dot/hyphen, immediately preceding a <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="1dff9d855dff9d84">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script>, followed by at least one letter/number/hyphen and a dot (and this combination can appear multiple times), followed by at least one letter.</p>
<p>Since the VBScript regular expression engine returns the number of unique strings found, multiple addresses can be extracted from a single file. The worm checks its list before adding each address, and will not add duplicates. This list is used by the email thread(s). Additionally, Sobig.F keeps a list of the first 1000 filenames whose suffix is one of: jpeg, jpg, gif, htm, txt, doc, xls, mpg, eml, bmp, fax. This list is used by the network enumeration thread in Sobig.F.</p>
<p>Another bug exists here: when the drive searching routine completes, the worm will exit, regardless of what the other threads are doing.</p>
<h2><a name="c6"></a>Up, up and update</h2>
<p>The update thread attempts to download a file from a server on the list that the worm carries. The thread contains no date check, so it continues to function even after the expiration date if, and only if, the drive searching routine is running to keep the worm active (as described above). Otherwise, no part of Sobig will function at all after the expiration date.</p>
<p>Sobig.A and Sobig.B will attempt to contact servers whenever the update thread begins to execute. Sobig.C and later variants synchronise themselves first with network time protocol (NTP) servers, and will attempt to download
 
files only during certain hours of certain days. The list of NTP servers to be contacted is carried by the worm:</p>
<table summary="Sobig servers">
<tr><td>129.132.2.21 (swisstime.ee.ethz.ch)</td></tr>
<tr><td>137.92.140.80 (chronos.ise.canberra.edu.au)</td></tr>
<tr><td>200.19.119.69 (server2.pop-df.rnp.br)</td></tr>
<tr><td>142.3.100.2 (clock.uregina.ca)</td></tr>
<tr><td>128.233.3.101 (non-existent)</td></tr>
<tr><td>193.5.216.14 (metasweb01.admin.ch)</td></tr>
<tr><td>131.188.3.220 (ntp0-rz.rrze.uni-erlangen.de)</td></tr>
<tr><td>131.188.3.222 (ntp2-rz.rrze.uni-erlangen.de)</td></tr>
<tr><td>212.242.86.186 (ogps.freebsd.dk)</td></tr>
<tr><td>chronos.cru.fr</td></tr>
<tr><td>138.96.64.10 (ntp-sop.inria.fr)</td></tr>
<tr><td>193.204.114.232 (unreachable)</td></tr>
<tr><td>133.100.11.8 (clock.tl.fukuoka-u.ac.jp)</td></tr>
<tr><td>193.67.79.202 (ntp0.nl.net)</td></tr>
<tr><td>193.79.237.14 (ntp1.nl.net)</td></tr>
<tr><td>132.181.12.13 (pukeko.cosc.canterbury.ac.nz)</td></tr>
<tr><td>150.254.183.15 (vega.cbk.poznan.pl)</td></tr>
<tr><td>62.119.40.98 (ntp1.sp.se)</td></tr>
<tr><td>200.68.60.246 (non-existent)</td></tr>
</table>
<p>The server to contact is chosen randomly, however Sobig.E contains a bug that restricts the choice to only the first four entries. The list of days and hours is as follows:</p>
<table summary="Sobig times to connect the server(s)">
<tr><td>Sobig.C: Monday, Thursday, and Saturday, from 8pm to 11pm UTC</td></tr>
<tr><td>Sobig.D: Thursday and Saturday, from 7pm to 12am UTC</td></tr>
<tr><td>Sobig.E: Monday and Friday, from 7pm to 12am UTC</td></tr>
<tr><td>Sobig.F: Sunday and Friday, from 7pm to 11pm UTC</td></tr>
</table>
<p>Every two hours Sobig.A attempts to download the file from http://www.geocities.com/reteras/reteral.txt.</p>
<p>Sobig.B traverses its list by one row every two hours, and attempts to download from these sites:</p>
<table summary="Sobig download sites">
<tr><td>http://www.geocities.com/fjgoplsnjs/jane.txt</td></tr>
<tr><td>http://www.geocities.com/lfhcpsnfs/mdero.txt</td></tr>
<tr><td>http://www.geocities.com/dnggobhytc/nbvhf.txt</td></tr>
<tr><td>http://www.geocities.com/bntdfkghvq/nbdcf.txt</td></tr>
</table>
<p>Sobig.C traverses its list by one row every 59 minutes, and attempts to download from these sites:</p>
<table summary="Sobig.C download sites">
<tr><td>http://www.geocities.com/vbifhdgs/aadfa.txt</td></tr>
<tr><td>http://www.geocities.com/vbhhrtok/axcfa.txt</td></tr>
<tr><td>http://www.geocities.com/vbhcbhptok/axccfa.txt</td></tr>
</table>
<p>Sobig.D attempts approximately every 50 minutes to download from these sites:</p>
<table summary="Sobig.D download sites">
<tr><td>63.187.136.207</td><td>65.92.185.105</td></tr>
<tr><td>218.145.251.172</td><td>4.46.216.107</td></tr>
<tr><td>63.139.177.178</td><td>68.158.97.35</td></tr>
<tr><td>68.119.94.107</td><td>65.96.174.173</td></tr>
<tr><td>211.172.37.81</td><td>80.133.8.182</td></tr>
<tr><td>203.218.1.205</td><td>65.96.134.32</td></tr>
<tr><td>80.193.162.47</td><td>68.160.246.76</td></tr>
<tr><td>217.86.31.254</td><td>68.51.149.158</td></tr>
<tr><td>24.159.40.38</td><td>24.101.46.49</td></tr>
<tr><td>24.199.119.153</td><td>67.85.144.168</td></tr>
</table>
<p>Sobig.E attempts every hour to download from only the first five (because of a bug) of these sites:</p>
<table summary="Sobig.E download sites">
<tr><td>67.164.250.26</td><td>80.145.119.84</td></tr>
<tr><td>129.244.36.194</td><td>61.41.223.43</td></tr>
<tr><td>67.73.60.121</td><td>218.158.43.206</td></tr>
<tr><td>218.146.139.246</td><td>67.168.13.135</td></tr>
<tr><td>66.169.84.77</td><td>209.34.8.147</td></tr>
<tr><td>64.229.253.52</td><td>65.69.221.166</td></tr>
<tr><td>65.95.29.173</td><td>67.74.161.243</td></tr>
<tr><td>203.252.75.45</td><td>80.136.150.140</td></tr>
<tr><td>217.230.224.66</td><td>69.22.34.186</td></tr>
<tr><td>65.95.91.31</td><td>62.47.6.238</td></tr>
<tr><td>217.228.235.145</td><td>24.96.26.108</td></tr>
</table>
<p>Sobig.F attempts every hour to download from these sites:</p>
<table summary="Sobig.F download sites">
<tr><td>68.50.208.96</td><td>65.92.80.218</td></tr>
<tr><td>12.232.104.221</td><td>63.250.82.87</td></tr>
<tr><td>218.147.164.29</td><td>65.92.186.145</td></tr>
<tr><td>24.33.66.38</td><td>65.95.193.138</td></tr>
<tr><td>12.158.102.205</td><td>65.93.81.59</td></tr>
<tr><td>24.197.143.132</td><td>65.177.240.194</td></tr>
<tr><td>24.206.75.137</td><td>66.131.207.81</td></tr>
<tr><td>24.202.91.43</td><td>67.9.241.67</td></tr>
<tr><td>24.210.182.156</td><td>68.38.159.161</td></tr>
<tr><td>61.38.187.59</td><td>67.73.21.6</td></tr>
</table>
<p>Sobig.D and Sobig.E also listen on ports 995–999 for incoming data that can be used in addition to (or instead of)
 
the download server list. This is in the same format as the list which is downloaded from the servers.</p>
<p>Sobig.A–C will connect to the servers on port 80, using a standard <em>Windows</em> API to download the data; Sobig.D–F will connect to the servers on port 8998 to download the data. In all cases, the data expected to be received is the URL of a file to download and execute. Sobig.A uses no encryption at all; Sobig.B uses simple bit-twiddling of nybbles. Sobig.C–F use, according to Frédéric Perriot, a variant of DES which has the first and last steps removed. The lack of these steps does not seem to reduce the strength of the encryption. Additionally, the key generation algorithm was changed in Sobig.F, resulting in an incompatibility with previous variants.</p>
<p>Once the data has been downloaded, the worm will create or open a local download log file in the %windir% directory, then search the log file for a match of the data. Sobig.A attempts to match the entire URL, Sobig.B–F attempt to match only the filename part of the URL. If the data is not found in the log, it will be added to the log, after which the requested file will be downloaded and executed. The name of the download log file has been changed with each version. The list follows:</p>
<table summary="Sobig logs">
<tr><td>Sobig.A: dwn.dat</td><td>Sobig.D: dftrn32.dat</td></tr>
<tr><td>Sobig.B: msdbrr.ini</td><td>Sobig.E: msrrd32.dat</td></tr>
<tr><td>Sobig.C: msddr.dll</td><td>Sobig.F: winstf32.dll</td></tr>
</table>
<h2><a name="c7"></a>Ever header of the mailman?</h2>
<p>The email thread begins by creating or opening a local file in the %windir% directory that contains the ‘sent’ list. The name of the sent list file has been changed with each version. The list follows:</p>
<table summary="Sobig sent list">
<tr><td>Sobig.A: smtmls.ini</td><td>Sobig.D: rssp32.dat</td></tr>
<tr><td>Sobig.B: hnks.ini</td><td>Sobig.E: msrrf.dat</td></tr>
<tr><td>Sobig.C: msddr.dat</td><td>Sobig.F: winstt32.dat</td></tr>
</table>
<p>The worm will send one mail to each person who is not on the sent list. In the case of Sobig.F, however, the email threads are not synchronised, so it is highly likely that more than one thread (and potentially all seven of them) will send mail to each person not on the sent list. Additionally, if copies of the worm are running, all of those copies could potentially be sending mail to the same people.</p>
<p>For the sender’s address, the worm will use its default address if only one email address is found or is remaining on the list; otherwise the choice will be made randomly from the list of email addresses, excluding the recipient’s address. No attempt is made to discover the email address of the real sender, so if that address exists on the list, it could be used. The default address has been changed with each version:</p>
<table summary="Sobig mails">
<tr><td>Sobig.A:</td><td><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="9efcf7f9defcf1ededb0fdf1f3">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script></td></tr>
<tr><td>Sobig.B:</td><td><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="bac9cfcacad5c8cefad7d3d9c8d5c9d5dcce94d9d5d7">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script></td></tr>
<tr><td>Sobig.C:</td><td><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="46242f2a2a062b2f253429352920326825292b">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script></td></tr>
<tr><td>Sobig.D:</td><td><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="1071747d797e50636560607f62643e737f7d">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script></td></tr>
<tr><td>Sobig.E:</td><td><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="03707673736c7177437a626b6c6c2d606c6e">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script></td></tr>
<tr><td>Sobig.F:</td><td><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="59383d3430371930372d3c2b373c2d773a3634">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script></td></tr>
</table>
<p>The subject of the mail is chosen at random from a list that the worm carries. In the case of Sobig.E, a bug restricts the choice to only the first two entries. The list has been changed with each version. The list follows:</p>
<table summary="Sobig mail subjects">
<tr><td rowspan="2" valign="top">Sobig.A:</td><td>Re: Here is that sample</td><td>Re: Sample</td></tr>
<tr><td>Re: Document</td><td>Re: Movies</td></tr>
<tr><td rowspan="5" valign="top">Sobig.B:</td><td>Re: My application</td><td>Approved (Ref: 38446-263)</td></tr>
<tr><td>Re: Movie</td><td>Re: My details</td></tr>
<tr><td>Cool screensaver</td><td>Your password</td></tr>
<tr><td>Screensaver</td><td>Your details</td></tr>
<tr><td colspan="2">Re: Approved (Ref: 3394-65467)</td></tr>
<tr><td rowspan="4" valign="top">Sobig.C:</td><td>Re: Application</td><td>Re: Screensaver</td></tr>
<tr><td>Re: Your application</td><td>Re: Movie</td></tr>
<tr><td>Re: 45443-343556</td><td>Approved</td></tr>
<tr><td>Re: Submited (004756-3463)</td><td>Re: Approved</td></tr>
<tr><td rowspan="5" valign="top">Sobig.D:</td><td>Re: Application</td><td>Application Ref: 456003</td></tr>
<tr><td>Your Application</td><td>Re: Movies</td></tr>
<tr><td>Re: Accepted</td><td>Re: App. 00347545-002</td></tr>
<tr><td>Re: Screensaver</td><td>Re: Documents</td></tr>
<tr><td colspan="2">Re: Your Application (Ref: 003844)</td></tr>
<tr><td rowspan="9" valign="top">Sobig.E:</td><td>Re: Application</td><td>Application.pif</td></tr>
<tr><td>Re: Movie</td><td>Applications.pif</td></tr>
<tr><td>Re: Movies</td><td>movie.pif</td></tr>
<tr><td>Re: Submitted</td><td>Screensaver.scr</td></tr>
<tr><td>Re: Screensaver</td><td>submited.pif</td></tr>
<tr><td>Re: Documents</td><td>new document.pif</td></tr>
<tr><td>Re: Re: Application ref 003644</td><td>Re: document.pif</td></tr>
 
<tr><td>Re: Re: Document</td><td>004448554.pif</td></tr>
<tr><td>Your application</td><td>Referer.pif</td></tr>
<tr><td rowspan="5">Sobig.F:</td><td>Re: That movie</td><td>Re: Details</td></tr>
<tr><td>Re: Wicked screensaver</td><td>Your details</td></tr>
<tr><td>Re: Your application</td><td>Thank you!</td></tr>
<tr><td>Re: Approved</td><td>Re: Thank you!</td></tr>
<tr><td colspan="2">Re: Re: My details</td></tr>
</table>
<p>The message body has been changed with each version. The list follows:</p>
<table summary="Sobig message body">
<tr><td>Sobig.A:</td><td>Attached file: [attachment name]</td></tr>
<tr><td>Sobig.B:</td><td>All information is in the attached file.</td></tr>
<tr><td>Sobig.C:</td><td>Please see the attached file.</td></tr>
<tr><td>Sobig.D:</td><td>See the attached file for details</td></tr>
<tr><td>Sobig.E:</td><td>Please see the attached zip file for details.</td></tr>
<tr><td>Sobig.Fchooses randomly from:</td><td>Please see the attached file for details. See the attached file for details</td></tr>
</table>
<p>The attachment name is chosen at random from a list carried by the worm. In the case of Sobig.E, the list is useless, since a bug restricts the choice to the first entry. The list has been changed with each version:</p>
<table summary="Sobig attachment names">
<tr><td rowspan="2" valign="top">Sobig.A:</td><td>Sample.pif</td><td>Document003.pif</td></tr>
<tr><td>Untitled1.pif</td><td>Movie_0074.mpeg.pif</td></tr>
<tr><td rowspan="5" valign="top">Sobig.B:</td><td>application.pif</td><td>password.pif</td></tr>
<tr><td>movie28.pif</td><td>approved.pif</td></tr>
<tr><td>screen_doc.pif</td><td>ref-394755.pif</td></tr>
<tr><td>screen_temp.pif</td><td>your_details.pif</td></tr>
<tr><td colspan="2">doc_details.pif</td></tr>
<tr><td rowspan="4" valign="top">Sobig.C:</td><td>document.pif</td><td>45443.pif</td></tr>
<tr><td>application.pif</td><td>submited.pif [sic]</td></tr>
<tr><td>approved.pif</td><td>movie.pif</td></tr>
<tr><td>documents.pif</td><td>screensaver.scr</td></tr>
<tr><td rowspan="5">Sobig.D:</td><td>Application.pif</td><td>ref_456.pif</td></tr>
<tr><td>Applications.pif</td><td>movies.pif</td></tr>
<tr><td>Accepted.pif</td><td>Document.pif</td></tr>
<tr><td>Screensaver.scr</td><td>app003475.pif</td></tr>
<tr><td colspan="2">Application844.pif</td></tr>
<tr><td rowspan="5" valign="top">Sobig.E:</td><td colspan="2">Your_details.zip (contains Details.pif)</td></tr>
<tr><td colspan="2">Application.zip (contains Application.pif)</td></tr>
<tr><td colspan="2">Document.zip (contains Document.pif)</td></tr>
<tr><td colspan="2">Screensaver.zip (contains Sky.world.scr)</td></tr>
<tr><td colspan="2">Movie.zip (contains Movie.pif)</td></tr>
<tr><td rowspan="5" valign="top">Sobig.F:</td><td>movie0045.pif</td><td>your_details.pif</td></tr>
<tr><td>wicked_scr.scr</td><td>thank_you.pif</td></tr>
<tr><td>application.pif</td><td>document_all.pif</td></tr>
<tr><td>document_9446.pif</td><td>your_document.pif</td></tr>
<tr><td colspan="2">details.pif</td></tr>
</table>
<p>Sobig.E is the only known variant of Sobig that sends its attachments in Zip form. It carries the Zlib Deflate library in order to compress itself (as opposed to only storing, which requires no library code). Zip is a suffix that is not blocked by the <em>Outlook</em> security patch that prevents access to attachments based on their suffix.</p>
<p>The email part-separator is formed by appending a random eight-character hexadecimal value to a hard-coded text. For variants A to E the text is ‘CSmtpMsgPart123X456_000_’. For Sobig.F the text is ‘_NextPart_000_’. The size of the attachment is variable in Sobig.E and Sobig.F. The file possesses a tail that contains the text ‘XC001815d’, prepended by a 32-bit value containing the number of bytes appended to the original file.</p>
<p>Before sending the attachment, the worm will add a random number of up to 3995 bytes to the original file, then include this tail. If the new size is larger than the old size then the tail text can be visible multiple times. Emails that are sent by Sobig.F include several ‘X-’ headers, one of which is ‘X-MailScanner: Found to be clean’. Let us hope that no one is fooled by this.</p>
<p>When opening the file to attach, all known variants of Sobig do so in a mode without sharing enabled. This can result in a failure to open the file. The message is sent anyway, which is a reason why some emails that are sent by Sobig will arrive without the attachment.</p>
<h2><a name="c8"></a>Schmoozing and networking</h2>
<p>The thread for spreading by network shares is fairly standard. The routine is executed every four hours by Sobig.A, and every half hour by Sobig.B and later variants.</p>
 
<p>The worm enumerates the machines on the local network, and attempts to connect to the C$, D$, and E$, shares on each machine. For the variants of Sobig prior to Sobig.F, if the connection succeeds, the worm will copy itself to the root directory of the share, and to the Startup directories specific to US-English <em>Windows 2000/XP/2003</em> (Documents and Settings\All Users\Start Menu\Programs\Startup) and <em>Windows 9x/Me</em> (Windows\All Users\Start Menu\Programs\StartUp). Sobig.F begins by examining its list of the first 1000 filenames gathered by the drive-searching routine. If the list exists, a filename is chosen randomly from there, and ‘.exe’ is appended to form a double extension (e.g. file.jpg.exe). If no filename exists, ‘winppr32.exe’ will be used instead. After the filename is chosen … nothing happens – the code to perform the file copy is not present in Sobig.F.</p>
<h2><a name="c9"></a>Conclusion</h2>
<p>The storm of mail that was produced by Sobig.F might make it seem as though tens of millions of people were infected by the worm. This should give pause for thought, since multiple copies of the worm running at the same time, coupled with the multiple email threads, on a far smaller number of machines, could easily account for much of the contribution. Despite this, some variants of Sobig have spread quite well and very quickly. Sobig relies on minimal social engineering, and no exploits. Sobig.F does not even spread across the network, relying solely on email for its propagation. How has it become so successful? A recent comic explains (from <em>User Friendly</em> by J.D. ‘Illiad’ Frazer, (c) User Friendly Media Inc, userfriendly.org.):</p>
<blockquote>
<p><em>Q. After working for an ISP for over half a decade and being immersed in the web, what is the one lesson you’ve learned?!</em></p>
<p><em>A: Click on everything.</em></p>
</blockquote>
<p>Okay. Stop clicking. NOW.</p>
<table summary="W32/Sobig@mm">
<tr><th colspan="2"><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="603753524f330f020907200d0d">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script></th></tr>
<tr><td>Type:</td><td>Win32 SMTP mass-mailer worm, network share crawler.</td></tr>
<tr><td>Size:</td><td>65,538 bytes (A), 50,425 bytes (B), 57,241 bytes (C), 76,003 bytes (D), 86,528 bytes (E), 72,892 bytes (F).</td></tr>
<tr><td>Payload:</td><td>Can download and execute arbitrary executables without permission.</td></tr>
<tr><td>Removal:</td><td>Fix registry, delete worm copies and its data files.</td></tr>
</table>
 
[<a style="" href="/lib/?lang=EN&amp;index=AN#apf52">Back to index</a>] [<a href="/lib/apf52.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=apf52">de</a><a href="/lib/index.php?lang=en&amp;id=apf52">en</a><a href="/lib/index.php?lang=es&amp;id=apf52">es</a><a href="/lib/index.php?lang=it&amp;id=apf52">it</a><a href="/lib/index.php?lang=fr&amp;id=apf52">fr</a><a href="/lib/index.php?lang=pl&amp;id=apf52">pl</a><a href="/lib/index.php?lang=ru&amp;id=apf52">ru</a><a href="/lib/index.php?lang=ua&amp;id=apf52">ua</a></div>
</body>
</html>
