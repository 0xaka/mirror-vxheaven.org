<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Christophe Devine, Nicolas Richaud 'A study of anti-virus' response to unknown threats' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Christophe Devine, Nicolas Richaud"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Devine, Christophe; Richaud, Nicolas,study of anti-virus' response to unknown threats, alert, exploitation, successful, keys, connected, microphone, shell, testa, vulnerability, http, successfully, security, alerted, captured, malware"/>
<meta name="Description" content="This study presents the evaluation of twelve anti-virus products with regards to programs not known from the signature files that show different kinds of malicious behavior. In practical terms, a set of twenty-one tests implementing various actions were developed; they cover key-logging, injection of code into other processes, network evasion, rootkit-like behaviour and exploitation of software vulnerabilities. The test programs were then run against each anti-virus program, and results were collected and consolidated. It was shown that all products tested here show deficiencies in at least one area, and some in all areas. For example, eleven anti-virus programs out of twelve still do not detect one code injection technique, which has been known for more than five years. Programs that spy on the user, such as recording the microphone, are not detected at all. Finally, this study provides recommendations to anti-virus vendors to enhance the capabilities of their products to detect malware, and improve safeguards against known attack techniques."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"6cb55981379c306b52ca8d939d6137768890fe28-1498757210-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/acd00.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>A study of anti-virus' response to unknown threats</h1><p><a href="/lib/?lang=en&amp;author=Devine%2C%20Christophe">Christophe Devine</a>, <a href="/lib/?lang=en&amp;author=Richaud%2C%20Nicolas">Nicolas Richaud</a><br/> <em>EICAR 18th Annual Conference</em><br/> <em>May 2009</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/acd00.html';</script><img src="/img/pdf.gif" alt="PDF"/><a href="/lib/pdf/A%20study%20of%20anti-virus%27%20response%20to%20unknown%20threats.pdf">Download</a> PDF (142.45Kb) (You need to be registered on <a href="/forum">forum</a>)<br/>[<a style="" href="/lib/?lang=EN&amp;index=AV#acd00">Back to index</a>] [<a href="/lib/acd00.html#disqus_thread">Comments</a>]<br/> 
<ul>
<li><a href="#c0">Abstract</a></li>
<li><a href="#c1">Introduction</a></li>
<li><a href="#c2">Methodology</a>
<ul>
<li><a href="#c21">Selection of anti-virus programs to be tested</a></li>
<li><a href="#c22">Selection of the tests to be performed</a></li>
<li><a href="#c23">Limits of this study</a></li>
</ul></li>
<li><a href="#c3">Test results</a>
<ul>
<li><a href="#c31">Keyloggers</a></li>
<li><a href="#c32">Code injection and network access</a></li>
<li><a href="#c33">User-mode and kernel-mode malicious activities</a></li>
<li><a href="#c34">Exploitation of vulnerabilities</a></li>
</ul></li>
<li><a href="#c4">Conclusion and future work</a></li>
<li><a href="#c5">References</a></li>
</ul>
<address>
Christophe Devine &lt;devine(@t)bob.cat><br/>
Nicolas Richaud &lt;nicolas.richaud(@t)lab.b-care.net>
</address>
<h2><a name="c0"></a>Abstract</h2>
<p>This study presents the evaluation of twelve anti-virus products with regards to programs not known from the signature files that show different kinds of malicious behavior. In practical terms, a set of twenty-one tests implementing various actions were developed; they cover key-logging, injection of code into other processes, network evasion, rootkit-like behaviour and exploitation of software vulnerabilities. The test programs were then run against each anti-virus program, and results were collected and consolidated. It was shown that all products tested here show deficiencies in at least one area, and some in all areas. For example, eleven anti-virus programs out of twelve still do not detect one code injection technique, which has been known for more than five years. Programs that spy on the user, such as recording the microphone, are not detected at all. Finally, this study provides recommendations to anti-virus vendors to enhance the capabilities of their products to detect malware, and improve safeguards against known attack techniques.</p>
<h2><a name="c1"></a>Introduction</h2>
<p>Detection of malicious programs has traditionnaly relied on signature-based analysis. This method has the advantage of providing, in most cases, precise identification of the threat and relieves the user from the burden of making an informed decision. However, signatures may prove inadequate in several situations:</p>
<ul>
<li>When a new malware is being released in the wild, a small window of time exists between the first infections and the release of updated signature files; the number of computers that become infected will then be correlated to propagation speed of the malware [1].</li>
<li>Targeted attacks exploiting "0-day" vulnerabilities that launch custom malicious code will thwart signature-based analysis. Although not widespread, a few targeted attacks have been identified in the past (for example, see [2]).</li>
<li>Detecting a full range of known malware programs is a complex problem, as anti-virus are constrained by CPU resources; a perfect detection rate is not feasible [3]. Furthermore, users expect to be able to perform tasks without being hindered by their anti-virus program.</li>
</ul>
<p>A new trend which has recently emerged is black-box detection of malware activity based on their behaviour, as exemplified by in the works of [4] and [5]. This method has the advantage of being able to detect malware in a more proactive fashion, at the cost of generating an higher number of false positives.</p>
<p>Rather than focusing on theoritical aspects of behavioural detection, this study concentrates on single test cases, each showing one particular method for performing a malicious action. Most surveys of anti-virus products only tested their signature-based detection engines; nevertheless, a few studies similar to this one do exist (such as [6]).</p>
<h2><a name="c2"></a>Methodology</h2>
<h3><a name="c21"></a>Selection of anti-virus programs to be tested</h3>
<p>The choice of products to be tested was based on their popularity, in order to cover the largest installed based as possible. Furthermore, time constraints would not have allowed testing the full range of all available anti-virus programs. Considering no recent and freely available study of anti-virus market share could be found, we relied on three denominators to make our decision:</p>
<ul>
<li>Download statistics for the Anti-virus section of the Softpedia website [7],</li>
<li>Google number of results for the query "download [name of anti-virus X]",</li>
<li>The anti-virus vendor had to provide a free evaluation version of his product.</li>
</ul>
<p>An initial list of thirty-eight products was retrieved from Virustotal [8]. This list was then narrowed down to twelve products chosen for subsequent testing, and are shown as follows:</p>
<table summary="Table 1: List of evaluated anti-virus programs" border="1">
<tr><th>Product name</th><th>Version tested</th></tr>
<tr><td>avast! professional edition</td><td>4.8.1296</td></tr>
<tr><td>AVG Internet Security</td><td>8.0.200</td></tr>
<tr><td>Avira Premium Security Suite</td><td>8.2.0.252</td></tr>
<tr><td>BitDefender Total Security 2009</td><td>12.0.11.2</td></tr>
<tr><td>ESET Smart Security (NOD32)</td><td>3.0.672.0</td></tr>
<tr><td>F-Secure Internet Security 2009</td><td>9.00 build 149</td></tr>
<tr><td>Kaspersky Anti-Virus For Windows Workstations</td><td>6.0.3.837</td></tr>
<tr><td>McAfee Total Protection 2009</td><td>13.0.218</td></tr>
<tr><td>Norton 360 Version 2.0</td><td>2.5.0.5</td></tr>
<tr><td>Panda Internet Security 2009</td><td>14.00.00</td></tr>
<tr><td>Sophos Anti-Virus &amp; Client Firewall</td><td>7.6.2</td></tr>
<tr><td>Trend Micro Internet Security Pro</td><td>17.0.1305</td></tr>
</table>
<p><strong>Table 1: List of evaluated anti-virus programs</strong></p>
<p>A Windows XP operating system (english version) with SP3 integrated was installed inside a VMware virtual machine. Two accounts were created, one with administrative rights (named "localadmin"), and another without ("localuser"). No additional patches or configuration changes were applied. A snapshot of the virtual machine state was then made, which served as the install base as well as the control subject.</p>
<p>Then, each anti-virus was installed as a leaf of the snapshot made previously, and fully updated to the latest version of the signatures. After this step, access to the internet was removed by switching the network adapter from "NAT" to "Host-only" mode, to ensure the tests could be reproduced identically for all anti-virus programs. It is important to note the anti-virus programs were left in their default configuration. In a few cases, the user was asked about the type of network he was connected to; we always chose the most restrictive setting ("public network", "internet", etc.).</p>
<p>The installation phase was conducted between the 10<sup>th</sup> and 12<sup>th</sup> of December 2008.</p>
<div align="center">
<img src="img/acd00/fig1.gif" alt="Figure 1: VMware snapshot tree"/>
<p><strong>Figure 1: VMware snapshot tree</strong></p>
</div>
<h3><a name="c22"></a>Selection of the tests to be performed</h3>
<p>Tests to be run were selected as being able to represent a wide range of malicious behaviors that may be found "in the wild". For this purpose, research articles documenting specific malware were consulted (notably [9] and [10]), as well as "hacking" tutorials available on the Internet.</p>
<p>Identified malicious behaviors were implemented as series of single tests. Each test only contained the strictest number of operations required for the action to be completed successfully (for example, capturing keystrokes). After a test was run, the virtual machine was reset to the current snapshot, to prevent unwanted interaction between tests.</p>
<p>Three checks were added in each test program to prevent accidental execution outside the virtual machine:</p>
<ul>
<li>A warning message box is shown and allows cancelling the operation,</li>
<li>The current computer name is checked against the expected computer name,</li>
<li>The address of the Interrupt Descriptor Table is checked to verify the program is running inside VMware [11].</li>
</ul>
<p>Some tests did require administrative privileges and are shown with [A] in from of them. Tests, which have been run from a non-privileged user account, are shown with [U].</p>
<p>The testing phase was conducted between the 14<sup>th</sup> and 19<sup>th</sup> of December 2008. Final tests were performed between the 7<sup>th</sup> and 9<sup>th</sup> of January 2009.</p>
<h3><a name="c23"></a>Limits of this study</h3>
<ul>
<li>The tests only cover the evaluation versions of aforementioned anti-virus products and may generate different results from the paying versions.</li>
<li>This study focused on HIPS-like (on-the-fly) detection of malicious behavior. Henceforth, it may not be relevant to the scanning capabilities of said products.</li>
<li>This set of tests is limited and does not cover typical methods for malware to become persistent across reboots (such as the adding or modification of registry keys).</li>
<li>Each test program was run for a limited amount of time (typically, one minute).</li>
</ul>
<h2><a name="c3"></a>Test results</h2>
<h3><a name="c31"></a>Keyloggers</h3>
<p>This series of tests includes six keylogging techniques, three of which can be run from user space and do not require administration privileges. Others require the loading of a kernel driver, and were originally developed by Thomas Sabono [12] for the purpose of testing anti-rootkit programs.</p>
<ul>
<li>[U] testA01: The GetRawInputData() API was introduced in Windows XP to access input devices at a low level, mainly for DirectX-enabled games. This function was documented in 2008 on the Firewall Leak Tester [6] web site.</li>
<li>[U] testA02 installs a WH_KEYBOARD_LL windows hook to capture all keyboard events (contrary to the WH_KEYBOARD hook, it does not inject a DLL into other processes).</li>
<li>[U] testA03: The GetAsyncKeyState() API allows querying the state of the keyboard asynchronously.</li>
<li>[A] testA11 hooks the keyboard driver's IRJ_MJ_READ function.</li>
<li>[A] testA12 hooks the keyboard driver's Interrupt Service Request.</li>
<li>[A] testA13 installs a "chained" device driver which places itself between the keyboard driver and upper level input device drivers.</li>
</ul>
<p>The tests were run for one minute, during which keys were entered. The output of each sample was then checked.</p>
<table summary="Table 2: Results of testing keyloggers" border="1">
<tr><th>Product name</th><th>testA01</th><th>testA02</th><th>testA03</th><th>testA11</th><th>testA12</th><th>testA13</th></tr>
<tr><td>avast!</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td></tr>
<tr><td>AVG</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td></tr>
<tr><td>Avira</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td></tr>
<tr><td>BitDefender</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td></tr>
<tr><td>ESET</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td></tr>
<tr><td>F-Secure</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td></tr>
<tr><td>Kaspersky</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td></tr>
<tr><td>McAfee</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td></tr>
<tr><td>Norton</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td></tr>
<tr><td>Panda</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td></tr>
<tr><td>Sophos</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>User alerted; keys logged.</td><td>User alerted; keys logged.</td><td>User alerted; keys logged.</td></tr>
<tr><td>Trend Micro</td><td>No alert; keys logged.</td><td>Program blocked; user alerted and prompted for action.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td><td>No alert; keys logged.</td></tr>
</table>
<p><strong>Table 2: Results of testing keyloggers</strong></p>
<ul>
<li>Sophos warned the user about the loading of a kernel driver (rule "HIPS-/RegMod-013"), but did not prevent it from loading. It copied the driver in quarantine and recommended the user to send the sample to Sophos labs.</li>
<li>Trend Micro detected and blocked the WH_KEYBOARD_LL hook. However the message shown was incorrect: it identified the threat at "Program Library Injection".</li>
<li>Kaspersky did not detect the loading of a malicious kernel driver, but warned the user four times when the program DbgView was run to inspect the driver's output.</li>
<li>The default configuration of Kaspersky anti-virus leaves the rules for detecting windows hooks and keyloggers unchecked. When both rules are enabled, Kaspesky detects and blocks testA02 and testA03.</li>
</ul>
<div align="center">
<img src="img/acd00/fig2.gif" alt="Figure 2: Kaspersky's &quot;Proactive Defense&quot; default configuration screen"/>
<p><strong>Figure 2: Kaspersky's "Proactive Defense" default configuration screen</strong></p>
</div>
<h3><a name="c32"></a>Code injection and network access</h3>
<p>This series of tests stresses the capabilities of anti-virus programs to prevent the unauthorized hijacking of a process by another, as well as attempts to access the network (for example, to upload gathered information or send spam).</p>
<ul>
<li>[A] testA21 installs a service running with SYSTEM privileges. It can operate as a server, listening on incoming connections on port 12345 and offering the client a CMD shell. It may also operate in the opposite direction, by initiating an outgoing connection.</li>
<li>[U] testA22 starts Internet Explorer and attempts to inject its DLL into the target process using the QueueUserAPC() API. Then an outgoing connection on port 8080 is initiated; if successful, a CMD shell is attached.</li>
<li>[A] testA23 is a passive network monitor; it captures HTTP traffic, using a RAW socket (this method does not require the loading of a separate driver).</li>
<li>[U] testA31 tries to inject its DLL into Notepad using the CreateRemoteThread() API.</li>
<li>[U] testA32 tries to inject its DLL into interactive processes with a WH_KEYBOARD windows hook.</li>
</ul>
<p>It should be noted that both testA22 and testA31 do not require the use of WriteProcessMemory(). Instead, the string "l32.dll" is searched inside the target executable, and the directory containing the DLL is added to the user's PATH environment variable.</p>
<table border="1" summary="Table 3: Results of testing code injection and network access">
<tr><th>Product name</th><th>testA21 (bind shell)</th><th>testA21 (reverse connect)</th><th>testA22</th><th>testA23</th><th>testA31</th><th>testA32</th></tr>
<tr><td>avast!</td><td>No alert; but incoming connection blocked.</td><td>No alert; shell connected successfully.</td><td>No alert; shell connected successfully.</td><td>No alert; packets captured.</td><td>No alert; DLL injected.</td><td>No alert; DLL injected.</td></tr>
<tr><td>AVG</td><td>Incoming connection detected and blocked; user alerted and prompted for action.</td><td>Outgoing connection detected and blocked; user alerted and prompted for action.</td><td>No alert; shell connected successfully.</td><td>No alert; packets captured.</td><td>No alert; DLL injected.</td><td>No alert; DLL injected.</td></tr>
<tr><td>Avira</td><td>Listening socket blocked; user alerted and prompted for action.</td><td>Outgoing connection detected and blocked; user alerted and prompted for action.</td><td>No alert; shell connected successfully.</td><td>Access to raw sockets blocked; user alerted and prompted for action.</td><td>Program blocked; user alerted and prompted for action.</td><td>No alert; DLL injected.</td></tr>
<tr><td>BitDefender</td><td>Listening socket blocked; user alerted and prompted for action.</td><td>Outgoing connection detected and blocked; user alerted and prompted for action.</td><td>No alert; shell connected successfully.</td><td>No alert; packets captured.</td><td>No alert; DLL injected.</td><td>No alert; DLL injected.</td></tr>
<tr><td>ESET</td><td>No alert; but incoming connections blocked.</td><td>No alert; shell connected successfully.</td><td>No alert; shell connected successfully.</td><td>No alert; packets captured.</td><td>No alert; DLL injected.</td><td>No alert; DLL injected.</td></tr>
<tr><td>F-Secure</td><td>Listening socket blocked; user alerted and prompted for action.</td><td>No alert; shell connected successfully.</td><td>No alert; shell connected successfully.</td><td>No alert; packets captured.</td><td>No alert; DLL injected.</td><td>No alert; DLL injected.</td></tr>
<tr><td>Kaspersky</td><td>No alert; but incoming connection blocked.</td><td>CMD shell execution blocked; user alerted and prompted for action.</td><td>CMD shell execution blocked; user alerted and prompted for action.</td><td>No alert; packets captured.</td><td>Program blocked; user alerted and prompted for action.</td><td>No alert; DLL injected.</td></tr>
<tr><td>McAfee</td><td>Listening socket blocked; user alerted and prompted for action.</td><td>No alert; shell connected successfully.</td><td>No alert; shell connected successfully.</td><td>No alert; packets captured.</td><td>No alert; DLL injected.</td><td>No alert; DLL injected.</td></tr>
<tr><td>Norton</td><td>No alert; shell connected successfully.</td><td>No alert; shell connected successfully.</td><td>No alert; shell connected successfully.</td><td>No alert; packets captured.</td><td>No alert; DLL injected.</td><td>No alert; DLL injected.</td></tr>
<tr><td>Panda</td><td>Incoming connection detected and blocked; user alerted and prompted for action.</td><td>No alert; shell connected successfully.</td><td>No alert; shell connected successfully.</td><td>No alert; packets captured.</td><td>No alert; DLL injected.</td><td>No alert; DLL injected.</td></tr>
<tr><td>Sophos</td><td>Listening socket blocked; user alerted and prompted for action.</td><td>Outgoing connection detected and blocked; user alerted and prompted for action.</td><td>Access to network blocked; user alerted and prompted for action.</td><td>No alert; packets captured.</td><td>No alert; DLL injected.</td><td>No alert; DLL injected.</td></tr>
<tr><td>Trend Micro</td><td>Listening socket blocked; user alerted and prompted for action.</td><td>Outgoing connection detected and blocked; user alerted and prompted for action.</td><td>Attempt to execute Internet Explorer blocked; user alerted and prompted for action.</td><td>No alert; packets captured.</td><td>Program blocked; user alerted and prompted for action.</td><td>Program blocked; user alerted and prompted for action.</td></tr>
</table>
<p><strong>Table 3: Results of testing code injection and network access</strong></p>
<ul>
<li>Surprisingly, Norton 360 allowed incoming connections on TCP port 12345, even though other ports such as SMB (TCP 139, 445) were blocked.</li>
<li>Most firewalls could be bypassed by injecting a DLL with the QueueUserAPC() API. Nonetheless, Sophos detected a connection attempt was made from a DLL inside IEXPLORE.EXE, and Trend Micro directly blocked the launching of Internet Explorer.</li>
<li>Once again, Kaspersky's default configuration prevented it from detecting the WH_KEYBOARD windows hook. It did detect, however, the redirection of the CMD shell's input/output handles and warned the user of a possible hacking attempt.</li>
<li>Apart from Trend Micro, the WH_KEYBOARD hook was not detected. This allowed injecting a DLL in several programs, including the anti-virus' main GUI component.</li>
</ul>
<h3><a name="c33"></a>User-mode and kernel-mode malicious activities</h3>
<p>This section contains three tests covering various user-monitoring activities, developed at Thales in 2008 by Jean-Jamil Khalif&eacute; during his internship. It also features another set of techniques representative of classic rootkit behavior.</p>
<ul>
<li>[U] testA41 captures the contents of the clipboard repeatedly using the GetClipboardData() API. After one minute, the results of the capture are examined.</li>
<li>[U] testA42 records surrounding sounds from the microphone present in the laptop used for the tests. For this purpose, a set of sound APIs are used (waveInAddBuffer, etc.). After recording for one minute, the resulting audio file is listened to.</li>
<li>[U] testA43 captures the screen every three seconds using the BitBlt() API for one minute. The screenshots are then examined.</li>
<li>[A] testA51 installs a simple backdoor by accessing \Device\PhysicalMemory (as described in [13]), and patches the SeAcessCheck() kernel function following [14]. After this is done, an attempt to terminate the spoolsv.exe service is done under a normal user account. This action is normally denied, but will be allowed if the backdoor functions properly.</li>
<li>[A] testA52 opens \\.\PhysicalDrive0 and injects its code in the Master Boot Record (MBR). The new boot sector is largely based on eEye's BootRoot [15], but patches instead NTLDR's checksum verification code, then SeAccessCheck(). After rebooting, the same check (terminating spoolsv.exe under a non-privileged account) is done.</li>
<li>[A] testA53 installs a kernel driver and hooks ZwQueryDirectoryFile() by modifying the System Service Dispatch Table (SSTD); the code is based on the implementation provided in [16]. It hides any file beginning with the word "AVBTS".</li>
</ul>
<table border="1" summary="Table 4: Results of testing user-mode and kernel-mode malicious activities">
<tr><th>Product name</th><th>testA41</th><th>testA42</th><th>testA43</th><th>testA51</th><th>testA52</th><th>testA53</th></tr>
<tr><td>avast!</td><td>No alert; clipboard contents captured.</td><td>No alert; microphone recorded.</td><td>No alert; screen captured.</td><td>No alert; RAM modified; backdoor functional.</td><td>No alert; MBR modified; backdoor functional.</td><td>No alert; file hidden.</td></tr>
<tr><td>AVG</td><td>No alert; clipboard contents captured.</td><td>No alert; microphone recorded.</td><td>No alert; screen captured.</td><td>No alert; RAM modified; backdoor functional.</td><td>No alert; MBR modified; backdoor functional.</td><td>No alert; file hidden.</td></tr>
<tr><td>Avira</td><td>No alert; clipboard contents captured.</td><td>No alert; microphone recorded.</td><td>No alert; screen captured.</td><td>Detected as TR/Dropper.GEN</td><td>No alert; MBR modified; backdoor functional.</td><td>No alert; file hidden.</td></tr>
<tr><td>BitDefender</td><td>No alert; clipboard contents captured.</td><td>No alert; microphone recorded.</td><td>No alert; screen captured.</td><td>No alert; RAM modified; backdoor functional.</td><td>No alert; MBR modified; backdoor functional.</td><td>No alert; file hidden.</td></tr>
<tr><td>ESET</td><td>No alert; clipboard contents captured.</td><td>No alert; microphone recorded.</td><td>No alert; screen captured.</td><td>No alert; RAM modified; backdoor functional.</td><td>No alert; MBR modified; backdoor functional.</td><td>No alert; file hidden.</td></tr>
<tr><td>F-Secure</td><td>No alert; clipboard contents captured.</td><td>No alert; microphone recorded.</td><td>No alert; screen captured.</td><td>No alert; RAM modified; backdoor functional.</td><td>No alert; MBR modified; backdoor functional.</td><td>No alert; file hidden.</td></tr>
<tr><td>Kaspersky</td><td>No alert; clipboard contents captured.</td><td>No alert; microphone recorded.</td><td>No alert; screen captured.</td><td>Program blocked; user alerted and prompted for action.</td><td>No alert; MBR modified; backdoor functional.</td><td>No alert; file hidden.</td></tr>
<tr><td>McAfee</td><td>No alert; clipboard contents captured.</td><td>No alert; microphone recorded.</td><td>No alert; screen captured.</td><td>No alert; RAM modified; backdoor functional.</td><td>No alert; MBR modified; backdoor functional.</td><td>No alert; file hidden.</td></tr>
<tr><td>Norton</td><td>No alert; clipboard contents captured.</td><td>No alert; microphone recorded.</td><td>No alert; screen captured.</td><td>No alert; RAM modified; backdoor functional.</td><td>No alert; MBR modified; backdoor functional.</td><td>No alert; file hidden.</td></tr>
<tr><td>Panda</td><td>No alert; clipboard contents captured.</td><td>No alert; microphone recorded.</td><td>No alert; screen captured.</td><td>No alert; RAM modified; backdoor functional.</td><td>No alert; MBR modified; backdoor functional.</td><td>No alert; file hidden.</td></tr>
<tr><td>Sophos</td><td>No alert; clipboard contents captured.</td><td>No alert; microphone recorded.</td><td>No alert; screen captured.</td><td>No alert; RAM modified; backdoor functional.</td><td>No alert; MBR modified; backdoor functional.</td><td>User alerted; file hidden.</td></tr>
<tr><td>Trend Micro</td><td>No alert; clipboard contents captured.</td><td>No alert; microphone recorded.</td><td>No alert; screen captured.</td><td>No alert; RAM modified; backdoor functional.</td><td>No alert; MBR modified; backdoor functional.</td><td>No alert; file hidden.</td></tr>
</table>
<p><strong>Table 4: Results of testing user-mode and kernel-mode malicious activities</strong></p>
<ul>
<li>Kaspersky blocked the attempt to access physical memory, whereas Avira detected this sample as "TR/Dropper.GEN" and blocked its execution.</li>
<li>Similarly to kernel-mode keylogger tests, Sophos detected the loading of a kernel driver.</li>
<li>All other tests were not detected.</li>
</ul>
<h3><a name="c34"></a>Exploitation of vulnerabilities</h3>
<p>Finally, this series of tests covers the exploitation of three relatively recent vulnerabilities.</p>
<ul>
<li>testA61 exploits the MS08-067 vulnerability, made public in October 2008 [17]. A buffer overflow in the Computer Browser service allows gaining full control over the target machine. Metasploit 3 [18] was used to perform the attack; for the purpose of this test, the firewall component of the anti-virus was disabled.</li>
<li>[U] testA62 exploits the util.printf() buffer overflow vulnerability in Adobe's Acrobat Reader, made public in November 2008 [19]. In this test, version 8.1.2 of Acrobat was exploited with a modified version of the PDF file posted on the milw0rm.com website.</li>
<li>[U] testA63 exploits a stack overflow in VLC version lesser or equal to 0.9.4, made public in November 2008 [20]. Similarly, the malicious MPEG file was downloaded from milw0rm.</li>
</ul>
<table border="1" summary="Table 5: Results of testing the exploitation of vulnerabilities">
<tr><th>Product name</th><th>testA61</th><th>testA62</th><th>testA63</th></tr>
<tr><td>avast!</td><td>No alert; vulnerability exploitation successful.</td><td>No alert; vulnerability exploitation successful.</td><td>No alert; vulnerability exploitation successful.</td></tr>
<tr><td>AVG</td><td>No alert; vulnerability exploitation successful.</td><td>No alert; vulnerability exploitation successful.</td><td>No alert; vulnerability exploitation successful.</td></tr>
<tr><td>Avira</td><td>No alert; vulnerability exploitation successful.</td><td>Detected as HTML/Shellcode.Gen; user alerted and prompted for action.</td><td>No alert; vulnerability exploitation successful.</td></tr>
<tr><td>BitDefender</td><td>No alert; vulnerability exploitation successful.</td><td>No alert; vulnerability exploitation successful.</td><td>No alert; vulnerability exploitation successful.</td></tr>
<tr><td>ESET</td><td>No alert; vulnerability exploitation successful.</td><td>No alert; vulnerability exploitation successful.</td><td>No alert; vulnerability exploitation successful.</td></tr>
<tr><td>F-Secure</td><td>No alert; vulnerability exploitation successful.</td><td>No alert; vulnerability exploitation successful.</td><td>No alert; vulnerability exploitation successful.</td></tr>
<tr><td>Kaspersky</td><td>CMD shell execution blocked; user alerted and prompted for action.</td><td>No alert; vulnerability exploitation successful.</td><td>No alert; but exploit failed silently.</td></tr>
<tr><td>McAfee</td><td>Program blocked; user alerted and prompted for action.</td><td>No alert; vulnerability exploitation successful.</td><td>No alert; vulnerability exploitation successful.</td></tr>
<tr><td>Norton</td><td>No alert; vulnerability exploitation successful.</td><td>No alert; vulnerability exploitation successful.</td><td>No alert; vulnerability exploitation successful.</td></tr>
<tr><td>Panda</td><td>No alert; vulnerability exploitation successful.</td><td>No alert; vulnerability exploitation successful.</td><td>No alert; vulnerability exploitation successful.</td></tr>
<tr><td>Sophos</td><td>User alerted; but vulnerability exploitation successful.</td><td>Detected as Troj/PDFJs-B and quarantined; user alerted.</td><td>No alert; vulnerability exploitation successful.</td></tr>
<tr><td>Trend Micro</td><td>No alert; vulnerability exploitation successful.</td><td>No alert; vulnerability exploitation successful.</td><td>Program blocked; user alerted and prompted for action.</td></tr>
</table>
<p><strong>Table 5: Results of testing the exploitation of vulnerabilities</strong></p>
<ul>
<li>Kaspersky, McAfee and Sophos were able to detect the execution of Metasploit's windows/shell_bind_tcp shellcode, but reacted differently. Kaspersky and McAfee blocked the shellcode, whereas Sophos let it run.</li>
<li>Avira and Sophos detected the presence of a malicious JavaScript, even though the JavaScript code in the original exploit was rewritten to avoid signature-based detection.</li>
<li>Trend Micro warned the user about "Shell Modification" activity from within vlc.exe. This activity was flagged as having a low risk (this is the same generic warning as for testA31):</li>
</ul>
<div align="center">
<img src="img/acd00/fig3.gif" alt="Figure 3: Trend Micro's warning after exploiting the VLC vulnerability"/>
<p><strong>Figure 3: Trend Micro's warning after exploiting the VLC vulnerability</strong></p>
</div>
<h2><a name="c4"></a>Conclusion and future work</h2>
<p>One main disadvantage of our testing methodology was the requirement to perform all tests by hand. This made running the test suite against the panel of anti-virus programs very time-consuming. A possible evolution will be to run each test automatically using a predefined script; this poses the problem of detecting if the malicious action completed successfully, as well as detecting if the anti-virus picked up the threat.</p>
<p>It may be tempting to add an increasing number of tests in the future. Those may not be pertinent however, as malware authors will generally use the simplest method not detected by anti-virus programs. Why use advanced code injection techniques when a classic windows hook remains undetected? As such, this study hopes to raise the bar for malware authors, by encouraging companies that produce anti-malware products to take into account the different techniques presented in this study.</p>
<p>Adding new behavioural patterns will of course pose the problem of false positives; this may be mitigated using whitelisting, as well as providing users with correct and informative alert messages.</p>
<p>Finally, it is to be hoped the problems and lost revenue caused by malware will loose relevance as more secure computing architecture come forward, such as those base on sandboxed virtual machine (Java, Flash...) and more fine-grained access control. In this regard, the addition of UAC in Windows Vista, however flawed it may be [21], is a step in the right direction.</p>
<h2><a name="c5"></a>References</h2>
<ol>
<li>Zesheng Chen, Chuanyi Ji: An Information-Theoretical View of Network-Aware Malware Attacks. CoRR abs/0805.0802: (2008)</li>
<li>"The Microsoft Security Response Center (MSRC) : Update on Microsoft Excel Vulnerability", as retrieved from http://blogs.technet.com/msrc/archive/2006/06/17/436860.aspx</li>
<li>Shobha Venkataraman, Avrim Blum, Dawn Song: Limits of Learning-based Signature Generation with Adversaries. Proceedings of the 15th Annual Network and Distributed Systems Security Symposium (2008)</li>
<li>Eric Filiol, Gr&egrave;goire Jacob, Micka&euml;l Le Liard: Evaluation methodology and theoretical model for antiviral behavioural detection strategies. Journal in Computer Virology 3(1): 23-37 (2007)</li>
<li>S&egrave;bastien Josse: Rootkit detection from outside the Matrix. Journal in Computer Virology 3(2): 113-123 (2007)</li>
<li>Guillaume Kaddouch: Firewall Leak Tester, http://www.firewallleaktester.com/</li>
<li>http://www.softpedia.com/get/Antivirus/</li>
<li>http://www.virustotal.com/sobre.html</li>
<li>Heng Yin, Zhenkai Liang, Dawn Song: HookFinder: Identifying and Understanding Malware Hooking Behaviors. Proceedings of ISOC NDSS 2008.</li>
<li>Jamie Butler and Kris Kendal: Blackout: What Really Happened. Black Hat USA 2008</li>
<li>Joanna Rutkowska: Red Pill... or how to detect VMM using (almost) one CPU instruction, retrieved from http://www.invisiblethings.org/papers/redpill.html</li>
<li>Thomas Sabono: La fiabilit&egrave; des logiciels anti-rookits Windows 32 bits. SSTIC 2007</li>
<li>"crazyload": Playing with Windows /dev/(k)mem. Phrack 59 (2002)</li>
<li>Greg Hoglund: A real NT Rootkit, patching the NT Kernel. Phrack 55 (1999)</li>
<li>Derek Soeder and Ryan Permeh: eEye BootRoot. Black Hat USA 2005.</li>
<li>Greg Hoglund, James Butler: Rootkits: Subverting the Windows Kernel. Addison Wesley, ISBN 0-321-29431-9 (2006)</li>
<li>Vulnerability in Server Service Could Allow Remote Code Execution, as retrieved from http://www.microsoft.com/technet/security/Bulletin/MS08-067.mspx</li>
<li>http://www.metasploit.com/framework/download/</li>
<li>CVE-2008-1104: http://cve.mitre.org/cgi-bin/cvename.cgi?name=2008-2992</li>
<li>CVE-2008-4654: http://cve.mitre.org/cgi-bin/cvename.cgi?name=2008-4654</li>
<li>Robert Paveza: User-Prompted Elevation of Unintended Code in Windows Vista, as retrieved from http://www.robpaveza.net/VistaUACExploit/UACExploitWhitepaper.pdf</li>
</ol>
[<a style="" href="/lib/?lang=EN&amp;index=AV#acd00">Back to index</a>] [<a href="/lib/acd00.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=acd00">de</a><a href="/lib/index.php?lang=en&amp;id=acd00">en</a><a href="/lib/index.php?lang=es&amp;id=acd00">es</a><a href="/lib/index.php?lang=it&amp;id=acd00">it</a><a href="/lib/index.php?lang=fr&amp;id=acd00">fr</a><a href="/lib/index.php?lang=pl&amp;id=acd00">pl</a><a href="/lib/index.php?lang=ru&amp;id=acd00">ru</a><a href="/lib/index.php?lang=ua&amp;id=acd00">ua</a></div>
</body>
</html>
