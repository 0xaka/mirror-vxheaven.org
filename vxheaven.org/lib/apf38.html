<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Peter Ferrie 'Magisterium Abraxas' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Peter Ferrie"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Ferrie, Peter,Magisterium Abraxas, memory, magistr, files, executable, portable, decryptor, section, address, routine, polymorphic, mapped, body, version, list, injected"/>
<meta name="Description" content="W32/Magistr.24876@mm is a polymorphically encrypted, entry point-obscuring, anti-heuristic, anti-debugging, memory resident, parasitic infector of Portable Executable .EXE and .SCR files. It can replicate across local area networks, and it has mass-mailing capabilities (using its own SMTP engine), some highly destructive payloads, an interesting visual effect and a number of bugs."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"30bef6993c50e865f26bd683b23eefdb88cd3aab-1498756727-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/apf38.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Magisterium Abraxas</h1><p><a href="/lib/?lang=en&amp;author=Ferrie%2C%20Peter">Peter Ferrie</a><br/> <em>Virus Bulletin, May 2001, pp. 6-7</em><br/> <em>ISSN 0956-9979</em><br/> <em>May 2001</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/apf38.html';</script><div class="ci"><a href="/lib/?ci=apf38">2</a></div><img src="/img/pdf.gif" alt="PDF"/><a href="/lib/pdf/Magisterium%20Abraxas.pdf">Download</a> PDF (151.85Kb) (You need to be registered on <a href="/forum">forum</a>)<br/>[<a style="" href="/lib/?lang=EN&amp;index=AN#apf38">Back to index</a>] [<a href="/lib/apf38.html#disqus_thread">Comments</a>]<br/> <form method="post" action=""><input type="hidden" name="pages" value="1"/><input type="submit" value="Turn on page numbers"/></form>
<address>
Peter Ferrie<br/>
SARC, Australia
</address>
<p><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="eeb9dddcc1a38f89879d9a9cc0dcdad6d9d8ae8383">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script> is a polymorphically encrypted, entry point-obscuring, anti-heuristic, anti-debugging, memory resident, parasitic infector of Portable Executable .EXE and .SCR files. It can replicate across local area networks, and it has mass-mailing capabilities (using its own SMTP engine), some highly destructive payloads, an interesting visual effect and a number of bugs.</p>
<h2>Initialisation</h2>
<p>As an anti-heuristic device, files infected with W32/Magistr do not have their entry point altered. Instead, the virus will save the first 512 bytes of code, and replace them with polymorphic garbage which includes subroutines, jumps, and some Structured Exception Handling tricks to interfere with debuggers and code emulators. Eventually, an indirect call, the address of which is stored by the virus in the Import Table of the host application, will transfer control to the section that contains the virus body.</p>
<p>The virus body is decrypted by XORing it with a single shifting 32-bit key, however the decryptor is also polymorphic, of variable size, and contains another Structured Exception Handler trick. Fortunately for the AV people, there is a characteristic of the decryptor which allows the encrypted body to be located quickly and accurately.</p>
<p>Once the virus is decrypted, it will attempt to find the KERNEL32.DLL base address by taking the return address from the stack and searching the previous 1 MB of memory for the MZ header whose export table DLL name ends with the string EL32. If the address cannot be found using that algorithm, then the virus will use one of two default values, based on the value of the high eight bits of the CS selector.</p>
<p>Using the KERNEL32.DLL base address, the virus will retrieve the addresses of 42 APIs it requires for system integration and replication on the local machine, the names of which are stored as checksums instead of strings. The checksum routine is a CRC algorithm using 16-bit registers that has been blindly copied into a number of recent 32-bit <em>Windows</em> viruses. It seems likely that not one virus author understands the algorithm well enough to produce a 32-bit version. A bug exists in the import parsing code which will cause a crash if an import cannot be found.</p>
<p>At this point is included a large chunk of code copied from the W32/Dengue virus. This process was introduced in <em>Windows NT</em>, and is always running. The residency code begins by converting the computer name to an encrypted string and creating a memory-mapped file using this name. The memory-mapped file is part of the mechanism that the virus uses to remain memory resident. Then, one of two routines is executed, based on the <em>Windows</em> platform (<em>9x/ME or NT/2000</em>), to search for the EXPLORER.EXE process in memory. Perhaps the most embarrassing bug in the virus exists here, in such a simple function as string comparison: it will return a match even if the last character differs in the strings. Once <em>Explorer</em> has been found, a 110 bytes routine is injected into a writeable section, and the TranslateMessage() API from USER32.DLL is hooked to point to this routine. After this, the original host bytes are restored and the host is executed.</p>
<h2>You've Got Mail</h2>
<p>The injected routine gains control whenever <em>Explorer</em> calls TranslateMessage(). This function is part of the message loop in all GUI applications, so it is called frequently. When the routine is reached for the first time, a thread is created and the function is unhooked. The thread will wait for three minutes before performing any actions.</p>
<p>After the time has elapsed, the thread will retrieve the location of the <em>Windows</em> directory, the Program Files directory from the Registry, and the Program Files drive. Depending on the first character of the computer name, the virus will choose one of those locations in which to create its data file. This data file will contain the date of initial infection, and the full path and number of interesting files, namely those files which contain email addresses: the <em>Windows</em> Address Books (*.WAB), <em>Outlook Message</em> stores (*.DBX, *.MBX), and the <em>Netscape Messenger</em> mail files.</p>
<p>The thread will also retrieve the user name and email address of the current user. These names are taken from the <em>Outlook Express, Internet Mail and News</em>, and <em>Netscape Messenger</em> Registry hives. The virus keeps within its body the email address of the ten most recently infected users. If the current user's email address is not already in this list, then it will be placed at the top of the list, and the other nine entries will be moved down. Then the search begins for the interesting files in the Program Files directory and the <em>Windows</em> directory.</p>
<p>After a one-minute wait the virus will check if an active Internet connection exists. If it does, the virus will search the Program Files drive for .DOC and .TXT files and choose from one of these files up to four words for the email subject and between 20 and 85 words for the email body. Additional code adds a period to the end of the email body and capitalises the first word, if required. Having formed the mail text, the virus will create the email headers, addressing the mail to up to 100 recipients, but explicitly avoiding the current user, and with 80% chance it will alter the second character of the return email address. This has
 
the effect of preventing people from replying to the email, in order to alert the user to the infection. The X-Mailer string is always Microsoft Outlook Express, but the version is chosen randomly from a table containing five version strings.</p>
<p>The virus will then attempt to locate a file to send. The choice is made by examining the first 20 Portable Executable .EXE or .SCR files that are smaller than 128 KB. If no such file is found, then an empty email will be sent. Otherwise, one of those files will be infected and attached to the mail. The mail Content-Type will be set randomly to 'image/gif' or 'application/octet-stream'. There is a 20% chance that the file from which the subject and body text were taken will also be attached to the email. The virus now sends the email and disconnects.</p>
<h2>See Spot Run</h2>
<p>There is a 25% chance the virus will search the Program Files drive for the first 20 Portable Executable .EXE or .SCR files, choose one, make a copy of that file, decrement the fifth last character of the filename, and infect that copy. If the <em>Windows</em> directory is not found, then up to 20 Portable Executable .EXE or .SCR files will be infected. The other 75% of the time, one Portable Executable .EXE or .SCR will be copied, the fifth last character of the filename will be decremented, the copy will be infected, and the Run key in the Registry will be altered to include a reference to the copy. The name of the Run value will be the filename without the suffix. This forces <em>Windows</em> to run the infected file whenever <em>Windows</em> is started.</p>
<p>After another one-minute wait, the virus will search each local hard drive for the first 20 Portable Executable .EXE and .SCR files and infect all of them. If the <em>Windows</em> directory is located on a drive that is not the current one, then the 'run=' logic will be executed for that drive. This code is also applied to every shared directory that is visible to this machine on the entire local area network.</p>
<h2>Infection</h2>
<p>Magistr infects Portable Executable files that are not DLLs, and are smaller than 1 GB. The infection marker is one of two values (0xCECD, or the first two characters of the computer name ORed with 0x9183), in one of three locations (NumberOfSymbols field in the PE header, or PointerToLineNumbers or NumberOfLineNumbers field in the first section header).</p>
<p>The first 512 bytes at the host entry point will be saved and replaced by polymorphic garbage, however this routine contains bugs that can produce either non-working code, or code longer than 512 bytes. A new polymorphic decryptor will be generated and the virus body will be encrypted. If a file contains a relocation section that is large enough to hold the decryptor and virus body, then the relocation section will be overwritten and the section name will be the first four characters of the computer name, preceded by a period. Otherwise, the virus will append itself to the last section in the file.</p>
<h2>Seek and Destroy</h2>
<p>Having completed the replication phase, the payload triggers are tested. If the machine has been infected for at least one month, if at least 100 people have been sent emails, and at least three .DOC or .TXT files contain at least three phrases from the list of 55 phrases contained in the virus, then the first payload will activate.</p>
<p>This payload appears to have been adapted from W32/Kriz, though it is functionally equivalent to W95/CIH's. It begins by deleting the last file found by any of the virus search routines. Under <em>Windows 9x</em> and <em>Windows ME</em>, it will also erase the contents of the CMOS memory and flash BIOS, and overwrite a single sector on the first hard disk. This sector is always cylinder 0, head 32, sector 1. The location is never updated. Under all platforms, it will delete one in every 25 files on every local hard drive and shared network directory, and overwrite every other file with the text YOUARESHIT as many times as will fit in the file.</p>
<p>After waiting less than a second, the entire first payload is repeated. This loop occurs infinitely. The second payload occurs after the machine has been infected for at least two months. On odd days, the desktop icons will be repositioned whenever the mouse pointer approaches. Given the nature of the rest of the code, it is likely that this routine is copied from another source. The third payload occurs after the machine has been infected for at least three months. Each time the injected routine is executed, this payload will delete the last file found by any of the virus search routines. Then, after every four minutes, the payload triggers are tested again.</p>
<p>W32/Magistr is certainly a complex virus, but presents nothing really new in virus writing. However, the virus is in the wild and could possibly become as widespread as W32/Funlove, and as damaging as W95/CIH.</p>
<table summary="W32/Magistr">
<tr><th colspan="2">W32/Magistr</th></tr>
<tr><th>Aliases:</th><td>I-Worm/Magistr, PE_MAGISTR.A, <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="9ec9adacb1d3fff9f7edeaecdef3f3b0">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script></td></tr>
<tr><th>Type:</th><td>Polymorphic, EPO, memory resident, parasitic mass-mailer.</td></tr>
<tr><th>Infects:</th><td>PE .EXE and .SCR files.</td></tr>
<tr><th>Self-recognition:</th><td>Magic value in PE header of files, memory-mapped file in memory.</td></tr>
<tr><th>Possible Payload:</th><td>File deletion, flash BIOS erased, message box, moving icons.</td></tr>
<tr><th>Removal:</th><td>Delete infected files and restore from backups.</td></tr>
</table>
 
[<a style="" href="/lib/?lang=EN&amp;index=AN#apf38">Back to index</a>] [<a href="/lib/apf38.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=apf38">de</a><a href="/lib/index.php?lang=en&amp;id=apf38">en</a><a href="/lib/index.php?lang=es&amp;id=apf38">es</a><a href="/lib/index.php?lang=it&amp;id=apf38">it</a><a href="/lib/index.php?lang=fr&amp;id=apf38">fr</a><a href="/lib/index.php?lang=pl&amp;id=apf38">pl</a><a href="/lib/index.php?lang=ru&amp;id=apf38">ru</a><a href="/lib/index.php?lang=ua&amp;id=apf38">ua</a></div>
</body>
</html>
