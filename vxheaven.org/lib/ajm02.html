<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Myles Jordan 'Dealing with Metamorphism' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Myles Jordan"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Jordan, Myles,Dealing with Metamorphism, scanners, heuristic, memory, viral, encryption, body, analysis, decryption, insert, metaphor, algorithmic, actions, problem, technology, effects"/>
<meta name="Description" content="When the virus writer known as z0mbie released Win95.Zmist.A in early 2001, much of the attention paid to this virus by the AV community was directed at its remarkable ability to intersperse its own code with that of its infection target. However, this virus also embodied the continuation of z0mbie's work on viral evolution towards metamorphism - a form of camouflage being developed by virus writers that is so potent and radically different from common encryption that AV scanners will soon need powerful new tools to confront this threat. This article will discuss one possible method that AV scanners could use to deal with metamorphism."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"c4d9c546285d871ece575f18f54b63bd200463c9-1498756038-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/ajm02.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Dealing with Metamorphism</h1><p><a href="/lib/?lang=en&amp;author=Jordan%2C%20Myles">Myles Jordan</a><br/> <em>Virus Bulletin, 1 Oct 2002</em><br/> <em>ISSN 0956-9979</em><br/> <em>October 2002</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/ajm02.html';</script><div class="ci"><a href="/lib/?ci=ajm02">2</a></div>[<a style="" href="/lib/?lang=EN&amp;index=ME#ajm02">Back to index</a>] [<a href="/lib/ajm02.html#disqus_thread">Comments</a>]<br/> 
<p>When the virus writer known as z0mbie released Win95.Zmist.A in early 2001, much of the attention paid to this virus by the AV community was directed at its remarkable ability to intersperse its own code with that of its infection target. However, this virus also embodied the continuation of z0mbie's work on viral evolution towards metamorphism - a form of camouflage being developed by virus writers that is so potent and radically different from common encryption that AV scanners will soon need powerful new tools to confront this threat. This article will discuss one possible method that AV scanners could use to deal with metamorphism.</p>
<h2>The Technology Arms Race</h2>
<p>Computer virus technology has been undergoing continuous evolution since the development of the very first viruses. At every stage, AV technology has been forced to undergo correlated evolution in order to continue to detect viruses equipped with the latest stealth and protection mechanisms. These early viruses had no means of camouflage, and were easily recognised by AV scanners using simple template matching. When encryption was developed for viruses in order to camouflage their bodies, AV scanners began to use algorithmic methods instead of template matching to detect these encrypted viruses. When encryption evolved through oligomorphism into polymorphism, AV scanners developed emulation to detect what would be excessively difficult for algorithmic detection methods.</p>
<p>It is evident that the majority of viral technology development has always been aimed at disguising the actual viral code via fixed, oligomorphic or polymorphic encryption. Each of these techniques involves encrypting the virus body, and supplying a layer of code to decrypt when necessary. Of these techniques, polymorphism is by far the most powerful, with, theoretically, a virtually infinite number of different decryption code layers (or "wrappers") that could be created. However, it is the fundamental property of polymorphism as merely a wrapper that limits it as a form of camouflage; no matter how good the polymorphism, after sufficient emulation of the decryption code, the body of the viral code is laid bare and can be easily recognized, even by template matching. As the following figure demonstrates, once the decryption layer is penetrated, the virus body is just as open to examination as if the virus had never been encrypted.</p>
<div align="center">
<img src="img/ajm02/fig1.gif" alt=""/>
</div>
<p>Ultimately, despite its seemingly infinite complexity, polymorphism can only ever be a finite problem.</p>
<h2>The Evolutionary Process</h2>
<p>There has been a concurrent stream of development that does not necessarily involve encryption at all. Rather, this branch of camouflage techniques involves modifying the body of the virus itself instead of modifying some form of decryption wrapper. This is commonly known as metamorphism.</p>
<p>The first attempt at metamorphism in PE viruses was Win32.Apparition. This virus carried around its source code and recompiled itself with some random "junk code" that was inserted whenever it discovered an appropriate compiler. This technique seemed never to be fully realised, presumably due to the small percentage of computers with an appropriate compiler available.</p>
<p>Following this was a more direct, though relatively simple, attempt at metamorphism in Win95.Regswap, which swapped the registers used to perform particular tasks. This form of camouflage was carried a step further by the Win32.Evol virus, which swaps certain instructions for different ones that perform the same function. It is also able to insert junk code between the essential instructions.</p>
<p>In early to mid 2000, two so-called permutating viruses were released: Win95.Ghost and Win95.Smash. These permutating viruses have the ability to split their code into blocks, and then change the order in which these blocks appear in the code. This of course does not change the functionality of the virus; it merely changes the structure, making template matching difficult. This technique is demonstrated in the following figure:</p>
<div align="center">
<img src="img/ajm02/fig2.gif" alt=""/>
</div>
<p>This technique of permutation was also improved upon in Win95.Zperm, which is able to completely reorganize its code and insert jump instructions wherever necessary to maintain the correct flow of control through the virus's code. As mentioned above, Win95.Zmist was yet another step in the development of metamorphic techniques, and contains the ability to reorganize its code, insert junk instructions, and also perform instruction substitutions. This work has since been continued by the author of Win32.Metaphor (a.k.a. Win32.Etap), which contains even more advanced metamorphism.</p>
<h2>An Observation</h2>
<p>Win32.Metaphor's metamorphism works by disassembling its own code into a custom pseudo-code, which is a meta-language for describing the actions of the code of the virus without any reference to the actual code. Using this layer of abstraction, the virus dissociates function from implementation, theoretically allowing the virus to generate new copies of itself completely from scratch. This technique produces instances of the virus that appear very dissimilar, and yet function identically, which is of course the goal of metamorphic camouflage. The assembly code on the left of the figure below was generated by Win32.Metaphor, and is used to find the address of the Kernel32.dll. All of those lines of code are testament to the power of Win32.Metaphor's metamorphic engine, as they could be replaced by the equivalent five lines of code on the right side.</p>
<div align="center">
<img src="img/ajm02/fig3.gif" alt=""/>
</div>
<p>This example illustrates an important point: no matter the form of the metamorphically altered code, there are certain "higher" actions that are always performed. A higher action is a phrase used to describe the purpose of a related group of instructions, and can, for example, be anything from locating the Interrupt Descriptor Table (a single instruction, SIDT), to hooking an API (usually a small series of instructions), or even decryption (variable, but often a large number of instructions). In the above example, two higher actions are performed: the construction of the "Kernel32" string, and the calling of the GetModuleHandle API. Depending on how much detail is required, it could be considered as a single, even higher, action: "locate the Kernel32 dll in memory".</p>
<p>The dissociation of the function of the virus from its actual code is commonly used by AV scanning software for heuristic analysis, but it becomes particularly useful when dealing with metamorphics. In particular, an AV scanner's heuristics must be capable of analysing the effects of multiple individual instructions and coalescing these effects into higher actions, as demonstrated here:</p>
<div align="center">
<img src="img/ajm02/fig4.gif" alt=""/>
</div>
<p>The scanner can then heuristically analyse these actions, completely disregarding their implementation. This effectively makes the literal instructions used irrelevant, and thus bypasses a significant portion of the power of metamorphic viruses: the junk insertion and instruction substitution techniques.</p>
<p>This method of heuristic analysis can be equally well applied to all known types of metamorphic virus, even those that recompile themselves, such as Win32.Apparition. This is because the method of metamorphism also becomes irrelevant once the core functionality of the virus (which never changes between infections) can be examined.</p>
<h2>Another Observation</h2>
<p>The other metamorphic technique used currently is code reorganisation, or permutation. As mentioned previously, the first PE virus to use unrestrained code reorganisation was Win95.Zperm. It has the ability to move variable pieces of its code to anywhere within its body, and then insert jumps, invert conditional branches, or simply change the relative offsets in existing jumps. Combining these features with the ability to insert limited simple junk code, and it is evident that this virus could never be reliably detected by template; nor would an emulator seem to be of much use - there is nothing to decrypt. It appears as though a specialised algorithmic detection is required. Or is it?</p>
<p>As noted in the above example with Win32.Metaphor, it is possible to ignore the instructions themselves, and just analyse the higher actions of the code. The idea that the instructions themselves are irrelevant also extends to the apparent ordering of the code, which does not really matter either; the same higher actions are going to be performed in the same order no matter how much the code jumps around. So by employing an emulator with heuristics capable of discerning higher actions, it is also possible to circumvent the metamorphic technique of code reorganisation also.</p>
<h2>A Powerful Tool</h2>
<p>Originally, emulators were designed to allow AV scanners to generically decrypt simple, complex, or polymorphic encryption. This allowed the scanner access to the decrypted code, thus relieving the burden of running many specialised algorithmic detections. However, it has been demonstrated that all known metamorphic techniques can be thwarted by the use of an emulator coupled with heuristics capable of coalescing the effects of multiple instructions into higher actions.</p>
<p>But what exactly should be done with the higher actions once they have been discerned? A common solution is to simply collect them and analyse them later, looking for particular static sets of actions that would indicate a virus or virus family. This type of analysis has been around for a long time, but is notoriously prone to both inaccurate virus family recognition and outright false alarms. The problem with inaccurate family recognition arises because many viruses share similar functionality (eg. infecting files), and the problem with false alarms arises as many legitimate programs also use similar functionality (eg. searching for files, and also writing to them).</p>
<p>Fortunately, the simplistic technique described above is not the only way to analyse higher actions. In fact, that technique discards important, implicit information regarding the higher actions - namely the chronological order in which they occurred. This "ordering" information can be crucial in discriminating between a sequence of actions which is viral, and a sequence of actions which is harmless. For example, consider the following sequence of higher actions:</p>
<ol>
<li>memory map file</li>
<li>close memory map</li>
<li>modify memory area file was mapped to</li>
</ol>
<p>If a heuristic analysis was done of these higher actions, using a discrete set analysis technique, these actions may fall into an 'infect file' set of actions, as shown below:</p>
<div align="center">
<img src="img/ajm02/fig5.gif" alt=""/>
</div>
<p>However, these actions occurred as a chronological sequence of events, and should be seen as such, as shown here:</p>
<div align="center">
<img src="img/ajm02/fig6.gif" alt=""/>
</div>
<p>If these actions are stored as a sequence instead of as a set, then it would be apparent during the heuristic analysis that these actions are not indicative of viral activities. Thus a potential false alarm situation is avoided, solely due to the inclusion of the chronological ordering information in the heuristic analysis.</p>
<h2>Conclusion</h2>
<p>This heuristic analysis of chronologically ordered higher actions has proven useful in decreasing the susceptibility of heuristic analysis to false alarms, and it continues to demonstrate its effectiveness against all known forms of metamorphism in computer viruses. It is interesting that an answer to the seemingly infinite complexity of metamorphism is to disregard the smoke and mirrors, and simply examine the meaning.</p>
[<a style="" href="/lib/?lang=EN&amp;index=ME#ajm02">Back to index</a>] [<a href="/lib/ajm02.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=ajm02">de</a><a href="/lib/index.php?lang=en&amp;id=ajm02">en</a><a href="/lib/index.php?lang=es&amp;id=ajm02">es</a><a href="/lib/index.php?lang=it&amp;id=ajm02">it</a><a href="/lib/index.php?lang=fr&amp;id=ajm02">fr</a><a href="/lib/index.php?lang=pl&amp;id=ajm02">pl</a><a href="/lib/index.php?lang=ru&amp;id=ajm02">ru</a><a href="/lib/index.php?lang=ua&amp;id=ajm02">ua</a></div>
</body>
</html>
