<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Peter Kálnai 'Linux Trojan “Hand of Thief” ungloved' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Peter Kálnai"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Kálnai, Peter,Linux Trojan “Hand of Thief” ungloved, hand, thief, linux, windows, anti, environment, browsers, desktop, called, platform, check, scsi, program, dropper, initial"/>
<meta name="Description" content="A new threat for the Linux platform was first mentioned on August 7th by RSA researchers, where it was dubbed Hand of Thief. The two main capabilities of this Trojan are form-grabbing of Linux-specific browsers and entering a victim’s computer by a back-door. Moreover, it is empowered with features like anti-virtualization and anti-monitoring."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"26df85f864b2f1d6d05e7c0cb9e0d587570a92f4-1498756689-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/akp00.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Linux Trojan “Hand of Thief” ungloved</h1><p><a href="/lib/?lang=en&amp;author=K%C3%A1lnai%2C%20Peter">Peter Kálnai</a><br/> <em>AVAST blog</em><br/> <em>August 2014</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/akp00.html';</script>[<a style="" href="/lib/?lang=EN&amp;index=AN#akp00">Back to index</a>] [<a href="/lib/akp00.html#disqus_thread">Comments</a>]<br/> 
<ul>
<li><a href="#c1">Dropper and Self-Protection</a></li>
<li><a href="#c2">Core Functionality</a></li>
<li><a href="#c3">Conclusion</a></li>
<li><a href="#c4">Sources</a></li>
<li><a href="#c5">Acknowledgements</a></li>
</ul>
<p>A new threat for the Linux platform was first mentioned on August 7th by <a href="http://blogs.rsa.com/thieves-reaching-for-linux-hand-of-thief-trojan-targets-linux-inth3wild/">RSA researchers</a>, where it was dubbed <em>Hand of Thief</em>. The two main capabilities of this Trojan are form-grabbing of Linux-specific browsers and entering a victim’s computer by a back-door. Moreover, it is empowered with features like anti-virtualization and anti-monitoring. With the level of overall sophistication <em>Hand of Thief</em> displays, it can be compared to infamous non-Windows threats such as the FlashBack Trojan for MacOsX platform discovered last year or Trojan <a href="https://blog.avast.com/2013/06/17/androidobad-malware-gets-smarter-so-does-avast">Obad for Android</a> from recent times.</p>
<p>A detailed analysis uncovers the following structure of the initial file with all parts after the dropper being encrypted (hexadecimal number displays starting offset of a block):</p>
<div align="center">
<img src="img/akp00/handofthief_scheme.png" alt=""/>
</div>
<p>Running the program on a native Linux system with parameter “-v” displays the version info “0.1.0.7″.</p>
<h2><a name="c1"></a>Dropper and Self-Protection</h2>
<p>The dropper is obfuscated with the UPX packer so the executable is not available for a static analysis. We make it so by applying the original <a href="http://upx.sourceforge.net/">UPX program</a> with parameter -d on a sole dropper part of the initial binary. The readability of almost all character strings is hardened by a XOR encryption with a varying 8-bit key. This is a very common property shared both among Windows and non-Windows Trojans.</p>
<p>Immediately after start, the Trojan checks if it does not run in a virtualized environment. Realization of this aim depends on virtualization software: To search for a substring “VBOX” and “VMware” in the listed SCSI devices (to suppress this check it is enough to unset read privileges on the file <em>/proc/scsi/scsi</em> ); to look for a substring “UML”,”PowerVM Lx86″, “QEMU” or “IBM/S390″ in <em>/proc/cpuinfo</em> file; to check an access to <em>/proc/vz</em> or <em>/proc/bc</em> which exist if OpenVZ kernel is running:</p>
<div align="center">
<img src="img/akp00/handofthief_is_under_vm.png" alt=""/>
</div>
<p>The presence of any of these signs leads to an early end of execution. The Trojan also exits if the root directory is <a href="http://en.wikipedia.org/wiki/Chroot">chrooted</a> by comparing particular lines in <em>/proc/1/mountinfo</em> and <em>/proc/\&lt;getpid()&gt;/mountinfo</em>. Chrooting is basically a security feature where a running process does not have access to the root directory but to another branch of a file system tree that acts as one.</p>
<p>Then it decrypts the config file appended at the end of the binary (starting on the offset 0×24244 with the length of 0x1E0) and it initializes its global variables with entries from the config file (values are resolved using regcomp, regexec and regfree command). We analyzed a sample with the following one (a private IP serving for C&amp;C whispers that this bot is in debug process and not in the wild):</p>
<div align="center">
<img src="img/akp00/handofthief_config_txt.png" alt=""/>
</div>
<p>To achieve persistence after reboot, the Trojan is suspected to create a configuration file called <em>system-firewall.desktop</em> within the path <em>~/.config/autostart</em> containing the following setting (%s is appropriately changed):</p>
<pre class="source">
[Desktop Entry]
Encoding=UTF-8
Type=Application
Exec=%s
Terminal=false
Name=System Firewall
StartupNotify=false
</pre>
<p>The step that follows is the installation of modules containing the main functionality into the <em>/tmp/</em> directory and changing access permissions with a command <em>chroot </em> with parameter <em>-x</em>. The procedure consists of mapping the binary into the memory and copying a relevant part to a buffer that is decrypted by <a href="http://en.wikipedia.org/wiki/Advanced_Encryption_Standard">AES</a> with a 256bit key. For the executable of a length 24848 it is performed like this (the marked values denote the target file name, the starting offset in the binary and the access permission):</p>
<div align="center">
<img src="img/akp00/handofthief_drop_block.png" alt=""/>
</div>
<p>The shared object is injected in every process whose name does not contain substring <em>gnome-session</em>, <em>dbus </em> or <em>pulseaudio</em>. The injection is performed with a method similar to the one described on <a href="http://www.blackhat.com/html/bh-europe-01/bh-europe-01-speakers.html#Shaun"> Blackhat 2001 by Shaun Clowes</a>. The reimplementation is <a href="http://github.com/ice799/injectso64">available on github</a>.</p>
<h2><a name="c2"></a>Core Functionality</h2>
<p>The shared object starts two threads. The first one is called <em>aaa, </em> and it listens to a command from C&amp;C to execute an action: <em>bc </em>command triggers BackConnect daemon called <em>p0stfix </em>serves as a reverse shell with a victim connecting to a particular socket; <em>bind </em>command starts BindPort daemon called <em>unix-daemon</em> acting as a bind shell with an attacker receiving the content of an output of a shell (after the correct authentication); <em>socks </em>executes a proxy via custom implementation of SOCKS5 protocol. All these features are realized through embedded perl scripts. Another commands with names <em>d_exec </em>and <em>update,</em> and they would try an execution of newly downloaded files from a C&amp;C server.</p>
<p>The second thread is denoted <em>bbb</em>. It performs the injection of the shared object starting on the offset 0x19CF4 into running browsers mapping space by the same method mentioned above. This serves as an initialization of the form-grabbing feature. Supported browsers are Chromium, Chrome and Firefox. The intervention of data submits of the Firefox browser is realized as the redirection of program flow of original libnspr40.so!PR_Write function to a custom implementation <em>hPR_Write_ptr</em> of Trojan:</p>
<div align="center">
<img src="img/akp00/handofthief_funct_patch.png" alt=""/>
</div>
<p>Intercepted data, statistics of bots execution, and command from C&amp;C are all interpreted via a custom communication protocol based on AES encryption with 256bits keys combined with Base64 encoding:</p>
<div align="center">
<img src="img/akp00/handofthief_HTTP_encrypt.png" alt=""/>
</div>
<p>Moreover, we observed an anti-monitoring check (no communication if wireshark or tcpdump is running):</p>
<div align="center">
<img src="img/akp00/handofthief_antimonitor.png" alt=""/>
</div>
<p>Finally, the exported function <em>drow_image</em>displays an about info in a form of nice ASCII art that confirms the creativity of the author (an owl sitting on a tree can be recognized):</p>
<div align="center">
<img src="img/akp00/handofthief_drow_image.png" alt=""/>
</div>
<h2><a name="c3"></a>Conclusion</h2>
<p>The Linux operating system is designed to have high level of security. However, this year a few attempts to attack Web servers by backdoors redirecting traffic or malicious apache modules have been discovered. The aim of this Trojan is to compromise user desktop systems. With features designed to abuse sensitive browser information, it could advance Linux users a step forward in this specific environment. The same threatening environment in which Windows users have existed for years. The statement that the Linux platform is absolutely secure now seems even more illusive.</p>
<h2><a name="c4"></a>Sources</h2>
<p>SHA256 hashes of some selected samples:</p>
<table border="1" cellpadding="0" cellspacing="0">
<tr><td>Hand of Thief Initial Binary</td><td><a href="http://www.virustotal.com/en/file/bd92ce74844b1ddfdd1b61eac86abe7140d38eedf9c1b06fb7fbf446f6830391/analysis/">BD92CE74844B1DDFDD1B61EAC86ABE7140D38E EDF9C1B06FB7FBF446F6830391</a></td><td>ELF:Hanthie-B [Trj]</td></tr>
<tr><td>Hand of Thief Shared Object</td><td><a href="http://www.virustotal.com/en/file/2acf2bc72a2095a29bb4c02e3cd95d12e3b4f59d2e7391d9bcbba9f3142b40ae/analysis/">2ACF2BC72A2095A29BB4C02E3CD95D12E3B4F5 9D2E7391D9BCBBA9F3142B40AE</a></td><td>ELF:Hanthie-A [Trj]</td></tr>
<tr><td>Hand of Thief Backdoor Executable</td><td><a href="http://www.virustotal.com/en/file/753dc7cd036bdbac772a90fb3478b3ccf22bec70ee4bd2f55dec2041e9482017/analysis/">753DC7CD036BDBAC772A90FB3478B3CCF22BEC 70EE4BD2F55DEC2041E9482017</a></td><td>ELF:Hanthie-C [Trj]</td></tr>
<tr><td>Hand of Thief Formgrabber</td><td><a href="http://www.virustotal.com/en/file/b794ce9e7291fe822b0e1f1804bd5a9a2efc304a1e2870699c60ef5083c7bac2/analysis/">B794CE9E7291FE822B0E1F1804BD5A9A2EFC30 4A1E2870699C60EF5083C7BAC2</a></td><td>ELF:Hanthie-D [Trj]</td></tr>
<tr><td>Hand of Thief BackConnect Script</td><td><a href="http://www.virustotal.com/en/file/4b0cc15b24e38ec14e6d044583992626dd8c72a4255b9614be46b1b4eefa41d7/analysis/">4B0CC15B24E38EC14E6D044583992626DD8C72 A4255B9614BE46B1B4EEFA41D7</a></td><td>Perl:Hanthie-A [Trj]</td></tr>
</table>
<h2><a name="c5"></a>Acknowledgements</h2>
<p>Thanks goes to my colleague, Pavel Šrámek, for discussions about the Linux platform.</p>
<p>Add your comments here, or read what others have to say on the AVAST Facebook page.</p>
[<a style="" href="/lib/?lang=EN&amp;index=AN#akp00">Back to index</a>] [<a href="/lib/akp00.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=akp00">de</a><a href="/lib/index.php?lang=en&amp;id=akp00">en</a><a href="/lib/index.php?lang=es&amp;id=akp00">es</a><a href="/lib/index.php?lang=it&amp;id=akp00">it</a><a href="/lib/index.php?lang=fr&amp;id=akp00">fr</a><a href="/lib/index.php?lang=pl&amp;id=akp00">pl</a><a href="/lib/index.php?lang=ru&amp;id=akp00">ru</a><a href="/lib/index.php?lang=ua&amp;id=akp00">ua</a></div>
</body>
</html>
