<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Peter Ferrie 'Doin' the eagle rock' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Peter Ferrie"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Ferrie, Peter,Doin' the eagle rock, data, items, apis, handler, windows, relocation, kernel, block, hapi, bytes, address, based, section, topmost, body"/>
<meta name="Description" content="If a ﬁle contains no code, can it be executed? Can arithmetic operations be malicious? Here we have a ﬁle that contains no code, and no data in any meaningful sense. All it contains is a block of relocation items, and all relocation items do is cause a value to be added to locations in the image. So, nothing but relocation items – and yet it also contains W32/Lerock."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"97d2b06ab05b3391af82aa27843cd83926c523d7-1498756125-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/apf48.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Doin' the eagle rock</h1><p><a href="/lib/?lang=en&amp;author=Ferrie%2C%20Peter">Peter Ferrie</a><br/> <em>Virus Bulletin, Mar 2010, pp. 4-6</em><br/> <em>ISSN 0956-9979</em><br/> <em>March 2010</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/apf48.html';</script><img src="/img/pdf.gif" alt="PDF"/><a href="/lib/pdf/Doin%27%20the%20eagle%20rock.pdf">Download</a> PDF (45.16Kb) (You need to be registered on <a href="/forum">forum</a>)<br/>[<a style="" href="/lib/?lang=EN&amp;index=AN#apf48">Back to index</a>] [<a href="/lib/apf48.html#disqus_thread">Comments</a>]<br/> <form method="post" action=""><input type="hidden" name="pages" value="1"/><input type="submit" value="Turn on page numbers"/></form>
<address>
Peter Ferrie<br/>
Microsoft, USA
</address>
<ul>
<li><a href="#c1">Exceptional behaviour</a></li>
<li><a href="#c2">Hapi hapi, Joy joy</a></li>
<li><a href="#c3">Let's do the twist</a></li>
<li><a href="#c4">Relocation allowance</a></li>
<li><a href="#c5">Dropping your bundle</a></li>
<li><a href="#c6">Filtration system</a></li>
<li><a href="#c7">Touch and go</a></li>
<li><a href="#c8">Appendicitis</a></li>
<li><a href="#c9">Conclusion</a></li>
</ul>
<p>If a ﬁle contains no code, can it be executed? Can arithmetic operations be malicious? Here we have a ﬁle that contains no code, and no data in any meaningful sense. All it contains is a block of relocation items, and all relocation items do is cause a value to be added to locations in the image. So, nothing but relocation items – and yet it also contains W32/Lerock.</p>
<p>Lerock is written by the same virus author as W32/Fooper (see <em>VB</em>, <a href="/lib/apf46.html">January 2010, p.4</a>), and behaves in the same way at a high level, but at a lower level it differs in an interesting way.</p>
<h2><a name="c1"></a>Exceptional behaviour</h2>
<p>Like Fooper, the virus begins by walking the Structured Exception Handler chain to ﬁnd the topmost handler, and at the same time registers a new exception handler which points to the host entrypoint. Once it has found the topmost handler, the virus uses the resulting pointer as the starting location in memory for a search for the MZ and PE headers of kernel32.dll. Once it has found the headers, the virus parses the export table to ﬁnd the APIs that it needs for infection.</p>
<p>The ﬁrst problem in Lerock’s code is identical to the ﬁrst bug in Fooper’s code: in <em>Windows Vista</em> and later, the topmost handler points into into ntdll.dll rather than kernel32.dll. As a result, the virus crashes on these platforms, because it assumes that the APIs it needs for infection will be found, and falls off the end of a buffer because they do not exist.</p>
<h2><a name="c2"></a>Hapi hapi, Joy joy</h2>
<p>If the virus ﬁnds the PE header for kernel32.dll, then it resolves the required APIs. It uses hashes instead of names, but the hashes are sorted alphabetically according to the strings they represent. This means that the export table only needs to be parsed once for all of the APIs, rather than parsing once for each API (as is common in some other viruses). Each API address is placed on the stack for easy access, but because stacks move downwards in memory, the API addresses end up in reverse order in memory.</p>
<h2><a name="c3"></a>Let's do the twist</h2>
<p>After retrieving the API addresses from kernel32.dll, the virus initializes its Random Number Generator (RNG). Like Fooper, Lerock uses a complex RNG known as the ‘Mersenne Twister’. In fact, the virus author has used this RNG in every virus for which he requires a source of random numbers.</p>
<p>The virus then allocates two blocks of memory: one to hold the intermediate encoding of the virus body, and the other to hold the fully encoded virus body. The virus decompresses a ﬁle header into the second block. The ﬁle header is compressed using a simple Run-Length Encoder algorithm. The header is for a <em>Windows</em> Portable Executable ﬁle, and it seems as though the intention was to produce the smallest possible header that can still be executed on <em>Windows</em>. There are overlapping sections, and ‘unnecessary’ ﬁelds have been removed. The virus then allocates a third block of memory, which will hold a copy of the unencoded virus body.</p>
<p>The virus searches for zeroes within the unencoded memory block and keeps a count of them. The zeroes will be skipped during the encoding process, which is the next step.</p>
<h2><a name="c4"></a>Relocation allowance</h2>
<p>The virus chooses randomly among the bytes in its body until it ﬁnds one whose value is not zero. For each such byte that is found, the virus stores the RVA of the byte within the encoding memory block, along with a relocation item whose type speciﬁes that the top 16 bits of the delta should be applied to the value. The result of this is to add one to the value. The reason why this occurs is as follows:</p>
<p>The virus uses a ﬁle whose ImageBase ﬁeld is zero in the PE header. This is not a valid loading address in <em>Windows</em>, so when <em>Windows</em> encounters such a ﬁle, it will relocate the image (with the exception of <em>Windows NT</em>, which does not support the relocation of .exe ﬁles at all). However, the location to which the relocation occurs is different for the two major <em>Windows</em> code-bases. <em>Windows NT</em>-based versions of <em>Windows</em> (speciﬁcally, <em>Windows 2000</em> and later) relocate images to 0x10000. <em>Windows 95</em>-based versions (<em>Windows 9x/Me</em>) relocate images to 0x400000. It is the <em>Windows NT</em>-based style of behaviour that the virus requires.</p>
<p>When relocation occurs, <em>Windows</em> calculates the delta value to apply. This value is calculated by subtracting the old loading from the new loading address (this can be a negative value if the image loads to a lower address than it requested). In this case, the new loading address is 0x10000, and the old loading address is 0, so the delta is also 0x10000, or to be more explicit, 0x00010000. Thus, the top 16 bits of the delta are 0x0001. It is this trick that allows the virus to adjust the value by one.</p>
<p>The virus decreases the value of the byte within the unencoded memory block. If the value reaches zero, then the virus decreases the number of bytes left to process. The virus also increases the corresponding value in the intermediate encoding memory block.</p>
 
<p>At this point, the virus decides randomly if it should apply special relocation items to the surrounding values, and, if so, what type of items to apply. The virus can produce a relocation item that adds 0x40 to any byte that is in the location one byte after the current position, but it has a side effect (not all of the bits are maintained) on three of the four bytes beginning at the current position, so the virus selects this type only if the next three bytes are still zero. The virus subtracts 0x40 from the value of the byte within the unencoded memory block. If the value reaches zero, then the virus decreases the number of bytes left to process.</p>
<p>The virus can also produce a relocation item that adds 0x20 to any byte that is in the location 13 bytes after the current position, but it has the same side effect as above, on a much larger scale (10 out of 16 bytes are affected), so the virus selects this type only if those 10 bytes are still zero. The virus subtracts 0x20 from the value of the byte within the unencoded memory block. If the value reaches zero, then it decreases the number of bytes left to process.</p>
<p>This is where the intermediate encoding memory block comes into play. It is a representation of the relocation items that have been applied at the current moment in time. The buffer begins by containing all zeroes, and the values are increased as the relocation items are applied. The ultimate aim is to reduce all of the original non-zero bytes to zero, thus avoiding the need to have any code in the ﬁle. All that is left is an empty section.</p>
<p>The encoding process repeats until all of the non-zero bytes have been encoded. The random ordering and type selection of the relocation items produces an essentially polymorphic representation of the virus body. Once the encoding process has completed, the virus creates a ﬁle called ‘rel.exe’, places the size information into the section header, writes the encoded body, then runs the resulting ﬁle. Finally, it transfers control to the host.</p>
<h2><a name="c5"></a>Dropping your bundle</h2>
<p>The dropped ﬁle begins by walking the Structured Exception Handler chain to ﬁnd the topmost handler, and at the same time registers a new exception handler, which points to the host entrypoint. As above, the code locates kernel32.dll in order to resolve the APIs that it needs for replication. Unlike the W32/Fooper, this virus uses only Unicode-based APIs, since the <em>Windows</em> code base that it requires is also Unicode-based.</p>
<p>After retrieving the API addresses from kernel32.dll, the virus attempts to load ‘sfc_os.dll’. If that attempt fails, then it attempts to load ‘sfc.dll’. If either of these attempts succeed, then the virus resolves the SfcIsFileProtected() API. The reason the virus attempts to load both DLLs is that the API resolver in the virus code does not support import forwarding. The problem with import forwarding is that, while the API name exists in the DLL, the corresponding API address does not. If a resolver is not aware of import forwarding, then it will retrieve the address of a string instead of the address of the code. In the case of the SfcIsFileProtected() API, the API is forwarded in <em>Windows XP</em> and later, from sfc.dll to sfc_os.dll. Interestingly, the virus supports the case where neither DLL is present on the system, even though that can occur only on older platforms – which it does not support.</p>
<p>The virus then searches for ﬁles in the current directory and all subdirectories, using a linked list instead of a recursive function. This is simply because the code is based on existing viruses by the same author – this virus does not infect DLLs, so the stack size is not an issue. The virus avoids any directory that begins with a ‘.’. This is intended to skip the ‘.’ and ‘..’ directories, but in <em>Windows NT</em> and later, directories can legitimately begin with this character if other characters follow. As a result, such directories will also be skipped.</p>
<h2><a name="c6"></a>Filtration system</h2>
<p>Files are examined for their potential to be infected, regardless of their sufﬁx, and will be infected if they pass a strict set of ﬁlters. The ﬁrst of these is the support for the System File Checker that exists in <em>Windows 2000</em> and later.</p>
<p>The remaining ﬁlters include the condition that the ﬁle being examined must be a <em>Windows</em> Portable Executable ﬁle, a character mode or GUI application for the <em>Intel</em> 386+ CPU, not a DLL, that the ﬁle must have no digital certiﬁcates, and that it must not have any bytes outside of the image.</p>
<h2><a name="c7"></a>Touch and go</h2>
<p>When a ﬁle is found that meets the infection criteria, it will be infected. The virus resizes the ﬁle by a random amount in the range of 4–6KB in addition to the size of the virus. This data will exist outside of the image, and serves as the infection marker.</p>
<p>If relocation data is present at the end of the ﬁle, the virus will move the data to a larger offset in the ﬁle, and place its code in the gap that has been created. If no relocation data is present at the end of the ﬁle, the virus code will be placed here. The virus checks for the presence of relocation data by checking a ﬂag in the PE header. However, this method is unreliable because <em>Windows</em> ignores this ﬂag, and relies instead on the base relocation table data directory entry.</p>
<p>The virus increases the physical size of the last section by the size of the virus code, then aligns the result. If the virtual size of the last section is less than its new physical size, then the virus sets the virtual size to be equal to the physical size,
 
and increases and aligns the size of the image to compensate for the change. It also changes the attributes of the last section to include the executable and writable bits. The executable bit is set in order to allow the program to run if DEP is enabled, and the writable bit is set because the RNG writes some data into variables within the virus body.</p>
<p>The virus alters the host entrypoint to point to the last section, and changes the original entrypoint to a virtual address prior to storing the value within the virus body. This will prevent the host from executing later, if it is built to take advantage of Address Space Layout Randomization (ASLR). However, it does not prevent the virus from infecting ﬁles ﬁrst. The lack of ASLR support might be considered a bug but for the fact that ASLR was only introduced in <em>Windows</em> Vista, which the virus does not support. What is strange, though, is that changing the entrypoint affects DLLs in the same way. Thus, if an infected DLL is relocated because of an address conﬂict, then it, too, will fail to run.</p>
<h2><a name="c8"></a>Appendicitis</h2>
<p>After setting the entrypoint, the virus appends the dropper code. Once the infection is complete, the virus will calculate a new ﬁle checksum, if one existed previously, before continuing to search for more ﬁles.</p>
<p>Once the ﬁle searching has ﬁnished, the virus will allow the host code to execute by forcing an exception to occur. This technique appears a number of times in the virus code, and is an elegant way to reduce the code size, as well as functioning as an effective anti-debugging method.</p>
<p>Since the virus has protected itself against errors by installing a Structured Exception Handler, the simulation of an error condition results in the execution of a common block of code to exit a routine. This avoids the need for separate handlers for successful and unsuccessful code completion.</p>
<h2><a name="c9"></a>Conclusion</h2>
<p>The virus author called this technique ‘virtual code’, which is quite an accurate description. However, the technique lends itself to simple detection by anti-virus software, given the randomly ordered relocation items that are applied multiple times to bytes in an empty section. Of course, future virus writers might try to bypass detection by ordering the relocation items sequentially (which would make it less suspicious, but reduce the polymorphism at the same time). Alternatively, they might ﬁll the section with legitimate-looking code and transform that instead (which would make it less suspicious, but potentially require even more relocation items). However, what remains is still a set of relocation items that are applied multiple times to bytes in a section, and there’s no getting around that one.</p>
 
[<a style="" href="/lib/?lang=EN&amp;index=AN#apf48">Back to index</a>] [<a href="/lib/apf48.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=apf48">de</a><a href="/lib/index.php?lang=en&amp;id=apf48">en</a><a href="/lib/index.php?lang=es&amp;id=apf48">es</a><a href="/lib/index.php?lang=it&amp;id=apf48">it</a><a href="/lib/index.php?lang=fr&amp;id=apf48">fr</a><a href="/lib/index.php?lang=pl&amp;id=apf48">pl</a><a href="/lib/index.php?lang=ru&amp;id=apf48">ru</a><a href="/lib/index.php?lang=ua&amp;id=apf48">ua</a></div>
</body>
</html>
