<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title> The Mental Driller 'Formulas for Random Number Generators' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="The Mental Driller"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, The Mental Driller,Formulas for Random Number Generators, rndseed, formula, number, operation, random, polymorphic, dword, engine, result, return, push, values, perfect, make, results"/>
<meta name="Description" content="When a polymorphic engine is done, we need a function to generate random numbers, but not always all the number generation routines are well done, because sometimes the results fall in a value loop that always return a value very near to the last one, or a numeric sequence easily predictable, which can make that our polymorphic engine generates not very polymorphic code."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"a36aedf572303b79ef5698d82859fda2102f0b5a-1498756285-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vmd02.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Formulas for Random Number Generators</h1><p><a href="/lib/?lang=en&amp;author=The%20Mental%20Driller"> The Mental Driller</a><br/> <em><a href="/vx.php?fid=292#f292">Matrix Zine [3]</a></em><br/> <em>April 2001</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vmd02.html';</script>[<a style="" href="/lib/?lang=EN&amp;index=VT#vmd02">Back to index</a>] [<a href="/lib/vmd02.html#disqus_thread">Comments</a>]<br/> 
<p>When a polymorphic engine is done, we need a function to generate random numbers, but not always all the number generation routines are well done, because sometimes the results fall in a value loop that always return a value very near to the last one, or a numeric sequence easily predictable, which can make that our polymorphic engine generates not very polymorphic code.</p>
<p>Many VX people have researched this subject because the random number generator (RNG) of the engine is one of the main bricks to make it. In this article, I'll show some nearly-to-perfect RNGs that can be used in a polymorphic/metamorphic engine to generate that precious random number that we always wanted to have :P. In this article, I'll explain some routines without entering very deep in the mathematical aspects of them, since many of you hate maths, I know :).</p>
<p>The first one thing that we must/should do is to initialize the seed of the RNG. We can initialize with the date of the system, for example, to make slow poly/metamorphism, since the RNG will generate the same sequence of random numbers in that day. If we don't care about that, one way of getting a perfect random seed is to use the instruction RDTSC, which will return a 64 bits value in EDX:EAX, being this number the clock count of the processor since the computer was switched on. After getting these values, we put them in the variables that we will use in our RNG.</p>
<p>The routines that I expose in every point are only examples to show the technique. Since making a poly/metamorphic engine (if you use them to make this) is very personal, you maybe want to make even the RNG, but you can freely use this formulas, of course.</p>
<h2>0 - Simple RNGs to call few times</h2>
<p>There are situations where you need to get a sequence of pseudo-random values but you don't need an special or perfect routine, but only one that satisfies you in a single routine (for example, a payload). A simple but effective RNG is the next formula:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">Random<span style="color: #339933;">:</span> &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>RndSeed<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: black;">&#91;</span>epb<span style="color: #339933;">+</span>RndSeed<span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br/>
&nbsp;</div>
<p>Don't use this to make a polymorphism engine! This shitty RNG is very useful for little viruses that only need to make a random number eventually, but it is quite predictable, at least when generating code.</p>
<h2>1 - Linear-congruent RNG</h2>
<p>Some polymorphic viruses use this type of RNG. The basic idea is to multiply the last generated number by a large odd integer and then add an odd number to break a possible linearity. Let's see the RNG in GriYo's Dengue:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">get_rnd32<span style="color: #339933;">:</span> &nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #46aa03; font-weight: bold;">ecx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> <span style="color: #46aa03; font-weight: bold;">edx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>rnd32_seed<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">41C64E6Dh</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mul</span> <span style="color: #46aa03; font-weight: bold;">ecx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">00003039h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span><span style="color: #ff0000;">7FFFFFFFh</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;; (this is optional)</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>rnd32_seed<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: #46aa03; font-weight: bold;">edx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> <span style="color: #46aa03; font-weight: bold;">ecx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br/>
&nbsp;</div>
<p>This gets the last number generated by the routine and multiplies it by 41C64E6Dh, being this number a random fixed one (just be sure it's odd and has randomized actived bits). After the multiplication, an odd number is added to this, to break a possible linearity or loop. This formula is very good to get a global random, but the sequence of the LSB (less significant bit) is easily predictable (1, 0, 1, 0, 1...) since the multiplication of an odd number by an odd number always results in an odd number, and an even number by an odd number results in an even number. Since the fixed addition converts last number from odd to even and viceversa every time this function is called, this is not valid to take the low bit as a random YES or NO. Well, we can use higher bits. The obvious advantadge of this algorith is its size, giving a good ratio of randomness in a few lines of code.</p>
<h2>2 - Pseudo-linear-congruent RNGs based in basic operations</h2>
<p>This RNGs are the most common used, and the most easy to make, but it's difficult to accurate them to give quasi-real random numbers. The next formula is used in my viruses, and it's a derivation of a more basic one, with intermiddle operations to break possible linearities for every operation that is taken. This routine can be taken as an example of a well made RNG without having to learn maths or investigate about close dispersions and all that:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">Random<span style="color: #339933;">:</span> <span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;<span style="color: #46aa03; font-weight: bold;">ecx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>RndSeed_1<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">dec</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>RndSeed_1<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>RndSeed_2<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">rol</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>RndSeed_1<span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">cl</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>RndSeed_1<span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>RndSeed_2<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">ecx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ror</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">cl</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">not</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">3</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>RndSeed_2<span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>RndSeed_3<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">rol</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>RndSeed_3<span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">1</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>RndSeed_3<span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">ecx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sbb</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>RndSeed_3<span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">4</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">inc</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>RndSeed_2<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br/>
&nbsp;</div>
<p>In this routine, we have three seeds to generate the number. RndSeed_1 is a variable that acts as a "main seed", being the most variable one. RndSeed_2 is a counter which increases every time we call to this RNG, which acts as a linearity breaker. RndSeed_3 is modified with the result of XORing RndSeed_1 and RndSeed_2, plus being ROLed once and added a value which can be 4 or 5 depending on the result after subtracting (RndSeed_1 XOR RndSeed_2), which avoids the prediction of the LSB.</p>
<p>Going step by step, we load the RndSeed_1 in EAX and then we decrement it. The decrement will contribute to avoid future loops in the values of the generated numbers. After that, we XOR that value in EAX with RndSeed_2, a so called "basic operation". XOR operation is very used in RNG because it mixes the bits of two values very efficiently. Then, we save that value in ECX for later use (concretely, to modify RndSeed_3) and we use the value in CL to rotate RndSeed_1 CL times (this operation has no mathematical meaning, it's just for garbling things a bit), and we modify again RndSeed_1 adding the result of the XOR operation to have them interconnected and vary them more randomly than if we use a fixed value to modify RndSeed_2 (but be careful: abusing of this feature can make a loop in the returned values since its an "endomogame" (ahem :) variation of the variables).</p>
<p>The next line will add RndSeed_2 to EAX, which was RndSeed_1 XOR RndSeed_2. This operation will only multiply the value in EAX by 2 or will put again the same value in EAX sometimes, depending on the bit disposition of RndSeed_1 at start, but in the majority of cases will clear some bits and set others, since XOR and ADD performs the same result very often (XOR is a bit-by-bit addition without carry), or just XOR and SUB. With ADC instead of ADD (using the Carry Flag set or cleared by the previous ADD), we use a slightly form of this ADD that will break some possible linearities, since it's hard to predict the value of the CF.</p>
<p>After this, we use some operations to garble the obtained value. ADD, XOR, SUB, etc. In this case, an ADD (which makes the functionality explained before, making the same effect as we made to RndSeed_2), and we ROR the value to randomize. Then, we make NOT to break a possible proximity with previous values (if the value was 3000h, now it's -3000h). This proximity break is more strong when the value is average, and more weak when the value is near the edges of a DWORD (0, 80000000h), but we can live with that :). Since NOT is weak sometimes, we break (again) a possible linearity adding an odd fixed number (3) which will derive (after the subsequent operations) in a great modification of the initial number. We again use this value to modify RndSeed_2 (this is optional).</p>
<p>After this garbling experience :), we use finally RndSeed_3, not used before and therefore makes a significative change to the current value. Then, we modify RndSeed_3 using the previous saved value in ECX and some things more (as it was explained before), and that's all. Optionally, I added an increment on RndSeed_2 to be sure that it changes and doesn't fall in an "endomogamic" loop of values.</p>
<p>This is an example of an advanced modification of random seeds to get a random value. This time the routine has been improved from an initial RNG to make that the values were more random-look-like. Some lines can be put or not, it's up to you, and one of this RNG can resemble very little with other, although the functionality of both is very good. Just use these tricks exposed here to get a good RNG if you don't want to use MULs or operations like that.</p>
<h2>3 - PRIDE-based RNG</h2>
<p>This quasi-perfect RNG is based on the idea exposed in "<a href="/lib/vmd03.html">Advanced polymorphic engine construction</a>" in 29A#5, extrapolating the Pseudo-Random Index DEcryption to random number generation.</p>
<p>The fact is that we can use the PRIDE formula (exposed below) to generate random numbers as if we were going to access to a buffer (initially, PRIDE was conceived to do that). With little modifications, the formula will generate all possible numbers between 0 and a given range, without repeating any number.</p>
<p>This time, we are going to modify the formula and generate a sequence that assures that, if you call it 2^64 times, you'll get a sequence of 2^64 values that contains each value 2^32 times (2^32 possible values * 2^32 times = 2^64 values). This means that, with the appropiated values, is a perfect RNG, something that it isn't easy to get.</p>
<p>First, the formula (already adapted to this subject):</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">RndSeed_1 &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dq</span> &nbsp; &nbsp; &nbsp;? &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">; Qword (double dword)</span><br/>
RndSeed_2 &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dq</span> &nbsp; &nbsp; &nbsp;?<br/>
RndSeed_3 &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dq</span> &nbsp; &nbsp; &nbsp;? &nbsp;<span style="color: black; font-style: italic;">; This values are randomized with RDTSC or getting</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">; the system time/date</span><br/>
<br/>
<br/>
Random<span style="color: #339933;">:</span> &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;<span style="color: #46aa03; font-weight: bold;">edx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>RndSeed_1<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>RndSeed_1<span style="color: #339933;">+</span><span style="color: #ff0000;">4</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>RndSeed_2<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">xor</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>RndSeed_2<span style="color: #339933;">+</span><span style="color: #ff0000;">4</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">shrd</span> &nbsp; &nbsp;<span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">11h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">push</span> &nbsp; &nbsp;<span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>RndSeed_3<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span><span style="color: #339933;">,</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>RndSeed_3<span style="color: #339933;">+</span><span style="color: #ff0000;">4</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">and</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0FFFFFFFEh</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>RndSeed_1<span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>RndSeed_1<span style="color: #339933;">+</span><span style="color: #ff0000;">4</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">edx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">inc</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>RndSeed_2<span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">adc</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">+</span>RndSeed_2<span style="color: #339933;">+</span><span style="color: #ff0000;">4</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">pop</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">ret</span><br/>
&nbsp;</div>
<p>This is the formula. Very little, although powerful. The disadvantadge of this routine is the very big random seeds, which makes difficult to get enough true random sources to fill that data (6 dwords), and moreover it's recommended to have an average seed value (not very near to value edges) to avoid getting values in subsets (although this subsets are dispersed among them). The functionality of the formula is based on a linear modification of a modification value (which ends with an exponential modification). This formula wouldn't be valid if we try to get absolute numbers (not limited by the DWORD/QWORD size), but taking the fact that this performs an implicit MOD, the formula works great.</p>
<p>Maybe you wonder why I use the SHRD EAX,EDX,11h: it's because the same reason we have to avoid the less significant bit on linear-congruent RNGs, since this formula fails misses the same point. So, we use the fact that it's a 64 bits value to take a high part of the value to return those 32 bits and obtain a random value. The fact is that, if we use RndSeeds of 32 bits and we eliminate the instructions that use EDX (and the SHRD), we get a formula with the same functionality, better constructed (2^32 calls will generate a fully garbled sequence of the 2^32 possible return values), but the LSB will be 1,0,1,0,1,0..., thing that sometimes we can allow, sometimes not. It's up to you.</p>
<p>The whole explanation of the formula isn't very difficult (as you see before), but it has its little tricks. For example, that AND EAX,-2. If we don't put that, we only generate even or odd numbers, and the result for 2^32 calls will be 2^31 values two times (different sequences in principle but always even or odd numbers). The explanation comes from the XOR between RndSeed_1 and Rnd_Seed2: Since RndSeed_2 is a counter, the LSB will alternate the value (0,1,0,1,...) so the LSB of RndSeed_1 will be 0,1,0,1,... or 1,0,1,0,... (the same or inverted). Since RndSeed_3 is fixed (i.e. it's not modified when this function is called), when making the addition of RndSeed_3 to RndSeed_1 and after increasing RndSeed_2, the operation will render in a no-modification of the LSB in RndSeed_1, thus making always that value. So, we anulate the last bit and at least the bit value alternates. With this method of getting a random (using SHRD to use from bit 17 and up) this adjust isn't needed at all, but well, the basic formula is in that way, and I didn't want to change it very much to leave it being adaptable easily.</p>
<p>OK, this examples and techniques can be used to make a good RNG. Obviously, if you are going to call the RNG only once or twice, it's not worthy to make a RNG, since you can call directly to RDTSC (for example), or get the system time in milliseconds. At least, I hope this things will be useful for you when you make your RNG and your poly/metamorphism engine.</p>
[<a style="" href="/lib/?lang=EN&amp;index=VT#vmd02">Back to index</a>] [<a href="/lib/vmd02.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vmd02">de</a><a href="/lib/index.php?lang=en&amp;id=vmd02">en</a><a href="/lib/index.php?lang=es&amp;id=vmd02">es</a><a href="/lib/index.php?lang=it&amp;id=vmd02">it</a><a href="/lib/index.php?lang=fr&amp;id=vmd02">fr</a><a href="/lib/index.php?lang=pl&amp;id=vmd02">pl</a><a href="/lib/index.php?lang=ru&amp;id=vmd02">ru</a><a href="/lib/index.php?lang=ua&amp;id=vmd02">ua</a></div>
</body>
</html>
