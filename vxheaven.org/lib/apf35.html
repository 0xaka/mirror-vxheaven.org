<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Peter Ferrie 'Got [Mac]root?' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Peter Ferrie"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Ferrie, Peter,Got [Mac]root?, functions, file, list, process, user, weapox, rootkit, write, port, called, unix, directory, community, signal, function"/>
<meta name="Description" content="There is a long history of rootkits on Unix-based platforms, such as Unix itself, Linux, BSD, etc. No doubt to the surprise of some in the Macintosh community, the MacOS X platform now has one too. We call it OSX/Weapox. It is written by someone who calls himself `nemo'."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"daafed78414640cd031bb033df4668ae183863a3-1498756345-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/apf35.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Got [Mac]root?</h1><p><a href="/lib/?lang=en&amp;author=Ferrie%2C%20Peter">Peter Ferrie</a><br/> <em>Virus Bulletin, July 2005, pp. 4-5</em><br/> <em>ISSN 0956-9979</em><br/> <em>July 2005</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/apf35.html';</script><img src="/img/pdf.gif" alt="PDF"/><a href="/lib/pdf/Got%20%5BMac%5Droot%3F.pdf">Download</a> PDF (41.16Kb) (You need to be registered on <a href="/forum">forum</a>)<br/>[<a style="" href="/lib/?lang=EN&amp;index=AN#apf35">Back to index</a>] [<a href="/lib/apf35.html#disqus_thread">Comments</a>]<br/> <form method="post" action=""><input type="hidden" name="pages" value="1"/><input type="submit" value="Turn on page numbers"/></form>
<address>
Peter Ferrie<br/>
Symantec Security Response, USA
</address>
<p>There is a long history of rootkits on Unix-based platforms, such as Unix itself, <em>Linux, BSD</em>, etc. No doubt to the surprise of some in the <em>Macintosh</em> community, the <em>MacOS X</em> platform now has one too. We call it OSX/Weapox. It is written by someone who calls himself `nemo'.</p>
<p>Weapox is based very heavily on the AdoreBSD rootkit. In fact, some of the original Adore code remains in the Weapox binaries, although it is never called. Even the function names have been retained (since the MacOS X kernel-extension file format is an object file, a lot of textual information is visible, including the function names). Since the <em>MacOS X</em> platform essentially has <em>BSD</em> at its heart, it was not a surprise that a BSD rootkit was used as the basis for a <em>MacOS X</em> rootkit. Weapox did not load on a test machine running Jaguar (<em>MacOS 10.2</em>), but it did load on a test machine running <em>Panther</em> (<em>MacOS 10.3</em>).</p>
<p>Whenever the rootkit is executed, it begins by hooking the functions `setuid', `kill', `write' and `chmod'. The rootkit also contains hook functions for `writev', and `getdirentries', but since those functions are never hooked, the hook functions are never called. In any case, those hook functions seem to be incomplete, even though they are fully functional in the AdoreBSD rootkit. Perhaps <em>MacOS X</em> is sufficiently different that the Weapox author couldn't get them to work properly. Other functions that are not called are `activate_cloaking' and `hide_process'. The latter is another remnant from the original AdoreBSD rootkit.</p>
<h2>Eats, roots and leaves</h2>
<p>The hooked `setuid' function checks if the UID is set to a particular value (1337 - `leet'). If it is, then the function sets the UID to 0 (root) instead. Otherwise, the function calls the original handler. (Leetspeak [or 13375p34k] is a cryptic form of transliteration adopted by some hackers and gamers as a way of excluding the non-leet from their conversations on open channels. 1337 is devolved from the word `elite' via `lite' -> `leet' -> `1337'.)</p>
<h2>Kill or be killed</h2>
<p>Despite its name, not only can the `kill' function terminate a process, but it can also signal a process. If the hooked `kill' function is used to signal a process, then the function checks if the signal is one of two particular values. If the value is 1337 (`leet' again), then the function escalates that process's privileges to level 0, effectively giving it full control over
 
the system. If the value is 9047 (which, in a less common use of 1337, means `PORT'), then the passed PID is interpreted as a port number, and the function prepends that port to a list of ports to hide. That list is used by the hooked `write' function (see below). If the signal is neither of these special values, then the hooked `kill' function calls the original handler.</p>
<p>The hooked `chmod' function checks whether the mode to set is a particular value (378, a value that would not normally be allowed). If it is 378, the passed path is interpreted as a logged-on username, and the function prepends that username to a list of usernames to hide. This list is used by the hooked `write' function. Otherwise, the function calls the original handler.</p>
<p>This signalling method is interesting in that the hooked functions are in no way related to the information that they hide - but perhaps that's the idea.</p>
<h2>Write your own ticket</h2>
<p>The hooked `write' function checks the name of the application requesting the write. If the requesting application is `netstat', and if any entry in the hidden port list appears anywhere within the text to be printed, then the entire line is discarded instead of being printed. If the requesting application is `w' or `who', and if any entry in the hidden user list appears anywhere within the text to be printed, the entire line is discarded. This is a very simple method of stealth, which can be defeated, for example, by renaming the application, but it works well enough against the average user. It is also the method that AdoreBSD used.</p>
<p>The hooked `writev' function checks if the text `promiscuous mode' appears anywhere within the text to be printed. If it does, then the entire line is discarded instead of being printed. Otherwise, the function calls the original handler. It is not clear why this text would be ignored, unless perhaps it would otherwise appear in a network security log. In the AdoreBSD rootkit, the function is used as an `I'm here' routine - literally, if the hooked `writev' function is called and if the text `promiscuous mode' appears anywhere within the text to be printed, AdoreBSD prints `I'm here'. Otherwise, the function calls the original handler.</p>
<p>The hooked `getdirentries' function contains several bugs, one of which results in an infinite loop, but that doesn't matter since the function is never called. The function is intended to check for a particular directory name within a directory structure, presumably to avoid it being printed. However, the directory name is never copied to the buffer to compare. Even if the name matched, the function simply prints `MATCH!' and does nothing further with it. Additionally, the original function is not called afterwards. The AdoreBSD code, for comparison, calls the original function to retrieve the real list of directory entries, then removes the directory to hide from that list, before returning the list to the caller.</p>
<p>The `active_cloaking' function is intended to remove the current module from the kernel module list. This list is used by, for example, kextstat. It is not clear, though, if the removal from the list results in the process no longer being executed. Perhaps that is why it is not called. The `hide_process' function doesn't hide anything at all. It simply searches for the requested PID and returns success or failure. The rest of the code that was present in the corresponding AdoreBSD rootkit function has been removed from this function.</p>
<h2>Open sesame</h2>
<p>A `rootkit' called SH/Renepo (`opener' spelled backwards) preceded Weapox by a few months. (In fact it was less of a rootkit and more a collection of hacking tools.) The package contained a script and three binaries. The script displayed some messages, including user information and passwords. It added a new user to the system, turned off the firewall, and attempted to terminate the LittleSnitch process (a program that tells the user when a program is attempting to send information to the Internet). It downloaded and installed the rest of the package, started a backdoor, created a screen dump, and deleted its temporary file.</p>
<p>The first binary was a `backdoor' for the xinetd program. It simply ran xinetd with a custom configuration file that caused xinetd to listen on port 31337 (`eleet', surprise!), and return a command-shell with root privileges on connection. The second binary was the well-known netcat program, a very useful tool for doing all kinds of network-related things. The third binary was a <em>Unix</em> log-file cleaner. There was no active stealth technology at all in the package.</p>
<h2>Conclusion</h2>
<p>There's always one person who spoils it for everyone else. The <em>Macintosh</em> community has been relatively unaffected by recent malware, at least when compared to the <em>Windows</em> community, but perhaps that is set to change after all.</p>
<table summary="OSX/Weapox">
<tr><th colspan="2">OSX/Weapox</th></tr>
<tr><th>Size:</th><td>27,608 bytes</td></tr>
<tr><th>Type:</th><td>Rootkit</td></tr>
<tr><th>Payload:</th><td>None</td></tr>
<tr><th>Removal:</th><td>kextunload, then delete the files.</td></tr>
</table>
 
<div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=apf35">de</a><a href="/lib/index.php?lang=en&amp;id=apf35">en</a><a href="/lib/index.php?lang=es&amp;id=apf35">es</a><a href="/lib/index.php?lang=it&amp;id=apf35">it</a><a href="/lib/index.php?lang=fr&amp;id=apf35">fr</a><a href="/lib/index.php?lang=pl&amp;id=apf35">pl</a><a href="/lib/index.php?lang=ru&amp;id=apf35">ru</a><a href="/lib/index.php?lang=ua&amp;id=apf35">ua</a></div>
</body>
</html>
