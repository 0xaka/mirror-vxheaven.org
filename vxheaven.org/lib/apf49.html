<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Peter Ferrie 'The missing LNK' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Peter Ferrie"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Ferrie, Peter,missing LNK, ﬁeld, control, list, unicode, ansi, format, stuxnet, icon, panel, display, size, path, drive, supposed, windows"/>
<meta name="Description" content="LNK ﬁles are everywhere in Windows, so ubiquitous that they are rarely even recognized for what they are: complex structures containing pointers to Portable Executable ﬁles and, ultimately, executable code.Some of the icons that appear in the Control Panel are visible because of LNK ﬁles. Many of the entries in the Start Menu and on the Desktop are LNK ﬁles. In most cases, the LNK references a ﬁle, and speciﬁes an icon to display. When an application is used to view the LNK ﬁle, such as browsing a folder using Windows Explorer, the Windows shell parses the format and determines what to display. LNKs are not limited to just ﬁles, though. They can be shortcuts to drives such as a shared network location or a ﬂoppy disk (as used by the ‘Send To’ menu, for example). The ‘Recent File List’ in Microsoft Ofﬁce 2007 applications is composed of LNK ﬁles.Overall, LNK ﬁles do not pose a direct threat. Of course, some LNK ﬁles can point to malicious executables that run when the LNK ﬁle is clicked, and some LNK ﬁles can point to harmless ﬁles and yet still perform malicious actions (such as when the command prompt is executed, but given the instructions to delete some ﬁles). Some LNK ﬁles can themselves be malicious by virtue of their contents (such as the self-executing LNK ﬁle virus from several years ago, where the LNK ﬁle carried an actual Portable Executable ﬁle, and executed it in a rather roundabout fashion). Then there are the LNK ﬁles produced by W32/Stuxnet, which allow the execution of arbitrary code without the need for any user interaction (other than browsing to a folder that contains such a ﬁle, with some further clariﬁcation below)."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"e4577a4625197bda02ff54a94da33dac1ea06767-1498756777-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/apf49.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>The missing LNK</h1><p><a href="/lib/?lang=en&amp;author=Ferrie%2C%20Peter">Peter Ferrie</a><br/> <em>Virus Bulletin, Sep 2010, pp. 4-6</em><br/> <em>ISSN 0956-9979</em><br/> <em>September 2010</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/apf49.html';</script><img src="/img/pdf.gif" alt="PDF"/><a href="/lib/pdf/The%20missing%20LNK.pdf">Download</a> PDF (47.46Kb) (You need to be registered on <a href="/forum">forum</a>)<br/>[<a style="" href="/lib/?lang=EN&amp;index=AN#apf49">Back to index</a>] [<a href="/lib/apf49.html#disqus_thread">Comments</a>]<br/> <form method="post" action=""><input type="hidden" name="pages" value="1"/><input type="submit" value="Turn on page numbers"/></form>
<address>
Peter Ferrie<br/>
Microsoft, USA
</address>
<ul>
<li><a href="#c1">LNKs to the past</a></li>
<li><a href="#c2">LNK layer</a></li>
<li><a href="#c3">Cuff LNKs</a></li>
<li><a href="#c4">D-LNKs</a></li>
<li><a href="#c5">Weak LNKs</a></li>
<li><a href="#c6">Strong LNKs</a></li>
<li><a href="#c7">Conclusion</a></li>
</ul>
<p>LNK ﬁles are everywhere in <em>Windows</em>, so ubiquitous that they are rarely even recognized for what they are: complex structures containing pointers to Portable Executable ﬁles and, ultimately, executable code.</p>
<p>Some of the icons that appear in the Control Panel are visible because of LNK ﬁles. Many of the entries in the Start Menu and on the Desktop are LNK ﬁles. In most cases, the LNK references a ﬁle, and speciﬁes an icon to display. When an application is used to view the LNK ﬁle, such as browsing a folder using <em>Windows Explorer</em>, the <em>Windows</em> shell parses the format and determines what to display. LNKs are not limited to just ﬁles, though. They can be shortcuts to drives such as a shared network location or a ﬂoppy disk (as used by the ‘Send To’ menu, for example). The ‘Recent File List’ in <em>Microsoft Ofﬁce 2007</em> applications is composed of LNK ﬁles.</p>
<p>Overall, LNK ﬁles do not pose a direct threat. Of course, some LNK ﬁles can point to malicious executables that run when the LNK ﬁle is clicked, and some LNK ﬁles can point to harmless ﬁles and yet still perform malicious actions (such as when the command prompt is executed, but given the instructions to delete some ﬁles). Some LNK ﬁles can themselves be malicious by virtue of their contents (such as the self-executing LNK ﬁle virus from several years ago, where the LNK ﬁle carried an actual Portable Executable ﬁle, and executed it in a rather roundabout fashion). Then there are the LNK ﬁles produced by W32/Stuxnet, which allow the execution of arbitrary code without the need for any user interaction (other than browsing to a folder that contains such a ﬁle, with some further clariﬁcation below).</p>
<h2><a name="c1"></a>LNKs to the past</h2>
<p>The LNK ﬁle format has existed since the days of <em>Windows 95</em>, but it was not documented publicly by <em>Microsoft</em> until 2009, and even then it was incomplete and interrupted. After the Stuxnet malware caused quite some interest in the LNK ﬁle format, the documentation was temporarily removed from the <em>Microsoft</em> website, and then re-released as ‘new’. However, the only difference between the two versions is some formatting, and the dates of referenced external ﬁles. The two versions are equally useless as far as determining how to parse the LNK ﬁles produced by Stuxnet goes, because the section that is being exploited is not documented in either version.</p>
<p>So, in order to understand what Stuxnet did with LNK ﬁles, we ﬁrst have to understand what is inside a LNK ﬁle.</p>
<h2><a name="c2"></a>LNK layer</h2>
<p>A LNK ﬁle begins with a 0x4c-byte-long header. The ﬁrst ﬁeld of the header is the ‘HeaderSize’, which speciﬁes the size of the header, including itself. It must contain the value 0x4c. The next ﬁeld is the ‘LinkCLSID’ (though it resolves to a registry key called ‘Shortcut’). The CLSID must be ‘{00021401-0000-0000-C000-000000000046}’. That’s the extent of the constant bytes for the header, as far as Stuxnet-style ﬁles go.</p>
<p>There is a ‘LinkFlags’ ﬁeld, which is supposed to specify information about the type of link and the presence of optional structures. Unfortunately, all but two of the ﬂags can be set arbitrarily, despite the corresponding structures being missing from the ﬁle. Only one bit is required to be set, and that is the HasLinkTargetIDList. When the bit is set, it speciﬁes that the ﬁle is saved with an item ID list, and the corresponding ‘LinkTargetIDList’ structure follows the ShellLinkHeader structure immediately.</p>
<p>One important-sounding bit in the LinkFlags ﬁeld is the ‘IsUnicode’ bit. This is supposed to be set if a ﬁle contains Unicode strings, and the documentation states that the bit ‘SHOULD’ (in upper case in the documentation) be set. However, the ‘should’ apparently refers to the fact that LNK ﬁles should be in Unicode format, as opposed to ANSI format. Unfortunately, the bit is entirely useless because a ﬁle can have the bit set and still be in ANSI format. Alternatively, the bit can be clear and yet the ﬁle can still be in Unicode format. The way to determine the format of the strings will be described below.</p>
<p>The two bits that cannot be set arbitrarily are ‘HasExpString’ and ‘HasDarwinID’. If either bit is set, then the corresponding structure must be present in the ﬁle, but the presence of either of them prevents the use of the structure that the Stuxnet LNK ﬁles require.</p>
<h2><a name="c3"></a>Cuff LNKs</h2>
<p>The LinkTargetIDList structure is an ‘IDList’ structure which contains a collection of ‘ItemID’ structures. In the case of a Stuxnet LNK ﬁle, there are three ItemID structures. Each of these contains a size ﬁeld, a type ﬁeld, and a data ﬁeld.</p>
<p>The ﬁrst ItemID structure in a Stuxnet LNK ﬁle contains the type and CLSID for the ‘My Computer’ or ‘Computer’ element (the speciﬁc name depends on the version of <em>Windows</em>, but the name is not relevant). The type ﬁeld is two bytes long, but only one of those bytes is checked by <em>Windows</em>. The type must be 0x1f, and the CLSID must be ‘{20D04FE0-3AEA-1069-A2D8-08002B30309D}’. Although the value in the size ﬁeld is most commonly 0x14, the size of the structure is not a constant. The size of the
 
structure can be increased in a hand-crafted ﬁle (though Stuxnet does not do this), by adding additional data after the CLSID ﬁeld. Then the value in the size ﬁeld can be increased accordingly. This alteration is known to break at least one publicly available scanning tool. I attempted to contact the author of the tool regarding this attack, but received no reply, and the tool remains unchanged.</p>
<p>The second ItemID structure in a Stuxnet LNK ﬁle contains the type and CLSID for the ‘Control Panel’ or ‘All Control Panel Items’ element (again, the speciﬁc name depends on the version of <em>Windows</em>, but is not relevant). As before, the type ﬁeld is two bytes long, but only one of those bytes is checked by <em>Windows</em>. The type must be 0x2e, and the CLSID must be ‘{21EC2020-3AEA-1069-A2DD-08002B30309D}’. Again, the size of the structure is not constant. The presence of the Control Panel CLSID leads us to the ﬂaw that Stuxnet exploits.</p>
<p>The third ItemID structure in a Stuxnet LNK ﬁle contains an undocumented (to the point that I don’t even know the correct name) ‘Control Panel applet’ structure, which contains a size ﬁeld, an icon index, some truly ‘spare’ ﬁelds, and a path to the ﬁle that holds the icon to display. This is where the magic happens. When the Control Panel is displayed, <em>Windows</em> queries the corresponding LNK ﬁles for the icons to display. Based on the behaviour of the patch (see below), this was intended to apply only to registered Control Panel applets (that is, the registry key ‘Software\Microsoft\Windows\CurrentVersion\Control Panel\Cpls’, under either ‘HKCU’ or ‘HKLM’, contains subkeys or values that name them), and ideally they would have been placed in the ‘%windir%\system32’ directory. Unfortunately, neither of these conditions was enforced, allowing LNK ﬁles to access ﬁles in arbitrary locations in any context whereby an icon would be displayed. This is why we can reproduce the problem by simply ‘browsing a folder using <em>Windows</em> Explorer’. The referenced ﬁles are <em>Windows</em> DLLs, usually with a sufﬁx of ‘.CPL’, and <em>Windows</em> will load them in order to retrieve the address of an exported function which is used to display the icon. Of course, in the case of Stuxnet, control is gained when <em>Windows</em> loads the ﬁle, and thus no exported function is necessary. Further, no warning is given when the named ﬁle is loaded.</p>
<p>To complicate matters further, the Control Panel applet structure comes in two forms, as noted above: Unicode and ANSI. The correct format can be determined by examining the values in particular locations within the structure. For the Unicode format, the six bytes beginning at offset 8 must be ‘00 00 00 00 00 6A’. Ten bytes later is the path in Unicode characters. This is the only format that Stuxnet LNK ﬁles use. For the ANSI format, the four bytes beginning at offset 8 can have almost any value (see below), including all zeroes, and which, if the following two bytes are not checked, might lead someone to assume that the Unicode format is in use. For the ANSI format, four bytes later is the path in ANSI characters.</p>
<h2><a name="c4"></a>D-LNKs</h2>
<p>As far as the path goes, the typical case is to have a drive letter, directory and ﬁlename. Of course, this ties the ﬁle to a speciﬁc drive conﬁguration. That would be ﬁne if the drive letter were constant, but in the case of Stuxnet, there is no guarantee of that. Speciﬁcally, Stuxnet places LNK ﬁles on USB removable storage media (among other places). Since the drive letter is assigned dynamically, because the order of device insertion can vary, Stuxnet needed a way to refer to the ﬁle regardless of the drive letter. This was achieved by querying the registry for the hardware ID. The result looks like ‘\\.\STORAGE#RemovableMedia#7&amp;xxxxxxxx&amp;0&amp;RM#{53f5630d-b6bf-11d0-94f2-00a0c91efb8b}\&lt;ﬁle>’, where the ‘x’s are a unique value speciﬁc to the device, and the CLSID is the Device Class GUID for a volume.</p>
<p>Further, the path does not need to look like either of these examples. The path can be in UNC form, allowing a ﬁle to be loaded from a remote location, such as a network share within a corporation. However, since the WebDAV redirector is also running by default, the location can be very remote. That is, anywhere on the Internet. This variation is used by the exploit module in the Metasploit framework.</p>
<h2><a name="c5"></a>Weak LNKs</h2>
<p>One virus writer <a href="http://forum.vxheavens.com/viewtopic.php?id=272">posted a message to a forum</a> claiming that anti-virus researchers ‘read docs instead of code’ and that his post contained the ‘*real* format for LNK ﬁles’. While his description was mostly correct (even including the two bits that cannot be set, though he did not name them, and did not describe why they cannot be used), and he did ﬁnd something that I did not know (the use of a relative path without a drive letter was not supported by my detection at the time), he did manage to get two things wrong. The two things that were wrong result in essentially ‘random’ execution of the LNK ﬁles. Perhaps he didn’t read the code carefully enough. Or perhaps that was the intended result.</p>
<p>The ﬁrst wrong thing relates to the ‘unused’ bytes that live in the ﬁeld before the path to the ﬁle. Two of those bytes are actually a separate ﬁeld that is supposed to contain the size of the path. This is used as a relative pointer to the description text, and it is used by <em>Windows</em>. If the ﬁeld contains a value that is too large (that is, beyond the end of the LNK ﬁle), then an exception might occur while <em>Windows</em> attempts to copy the description string. In that case, the LNK ﬁle will not be parsed any further. That might sound potentially interesting to an attacker, since obviously there is no check that the pointer is valid. However, what
 
lies beyond the end of the ﬁle is essentially random data, and the string copy operation has a limited length, so it cannot be exploited. The value is not supposed to be zero, either, since that would cause the ﬁlename to become the ‘description’, but such a situation causes no ill effects.</p>
<p>The second thing the virus writer got wrong relates to the non-terminated string. If the termination bytes are removed, then when the LNK ﬁle is loaded, whatever happened to be in memory at the corresponding location will be used instead. The bytes there might not be zero, resulting in a string that appears to be longer than it was supposed to be. Again, that might sound potentially interesting to an attacker, but as before, what lies beyond the end of the ﬁle is essentially random data, and the string copy operation has a limited length, so it cannot be exploited. A further result is that the check for the existence of the ﬁle is likely to fail, since those random bytes will become part of the ﬁlename that is examined.</p>
<h2><a name="c6"></a>Strong LNKs</h2>
<p><em>Microsoft</em> patched the behaviour to check for CPL ﬁles in several locations, and a list is made of the ﬁles found for use later. The locations are the ‘MMCPL’ key in ‘control.ini’ (which is redirected to the registry, but the location is not constant), ‘%windir%\system32’ and ‘Software\Microsoft\Windows\CurrentVersion\Control Panel\CPLs’ under both ‘HKLM’ and ‘HKCU’. Any CPL ﬁle that is found is excluded if it is marked as ‘don’t load’ according to its registry key.</p>
<p>Once the list has been made, the ﬁle referenced by the LNK ﬁle is checked against each entry in the list. If the ﬁle is not in the list, then <em>Windows</em> makes a change to the loading method, to force the use of a default system icon instead of the requested icon. This also prevents the referenced ﬁle from being loaded. Internally, the path is converted to the form ‘&lt;path>,&lt;icon>,&lt;description>’, where &lt;icon> is zero in Stuxnet LNK ﬁles. However, if the ﬁle is not found in the list, then the path is converted to ‘&lt;path>,-1,&lt;description>’. Prior to creating the list, the original path is checked for the presence of a comma, in order to prevent a path that has the internal form prior to conversion, since that could have been used to defeat the other checks in the patch.</p>
<h2><a name="c7"></a>Conclusion</h2>
<p>So now we know what the Stuxnet LNK ﬁles do. As for what else Stuxnet does, the details would ﬁll a conference paper (or two!). It’s too late to submit a paper for the Virus Bulletin conference this year, but maybe I’ll be ﬁrst in line when the call for papers opens for VB2011.</p>
 
[<a style="" href="/lib/?lang=EN&amp;index=AN#apf49">Back to index</a>] [<a href="/lib/apf49.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=apf49">de</a><a href="/lib/index.php?lang=en&amp;id=apf49">en</a><a href="/lib/index.php?lang=es&amp;id=apf49">es</a><a href="/lib/index.php?lang=it&amp;id=apf49">it</a><a href="/lib/index.php?lang=fr&amp;id=apf49">fr</a><a href="/lib/index.php?lang=pl&amp;id=apf49">pl</a><a href="/lib/index.php?lang=ru&amp;id=apf49">ru</a><a href="/lib/index.php?lang=ua&amp;id=apf49">ua</a></div>
</body>
</html>
