<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Евгений Каспеpский 'Прежде чем лечить доктора' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Евгений Каспеpский"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Каспеpский, Евгений,Прежде чем лечить доктора, файла, сектора, блока, копии, файлы, nbsp, восстановление, памяти, одного, дамп, boot, векторов, зараженные, стелс, command"/>
<meta name="Description" content="VX Heaven site is dedicted to providing information about computer viruses (virii) and web space for virus authors and groups"/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"1a9a947603ccea8587e31b3051c50471e9db2449-1498757999-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/aek04.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Прежде чем лечить доктора</h1><p><a href="/lib/?lang=ru&amp;author=%D0%9A%D0%B0%D1%81%D0%BF%D0%B5p%D1%81%D0%BA%D0%B8%D0%B9%2C%20%D0%95%D0%B2%D0%B3%D0%B5%D0%BD%D0%B8%D0%B9">Евгений Каспеpский</a><br/> <em>КомпьютерПресс N8/1992 (стр. 57-65)</em><br/> <em>ISSN 0868-6157</em><br/> <em>Август 1992</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/aek04.html';</script>[<a style="" href="/lib/?lang=RU&amp;index=AV#aek04">Вернуться к списку</a>] [<a href="/lib/aek04.html#disqus_thread">Комментарии</a>]<br/> <form method="post" action=""><input type="hidden" name="pages" value="1"/><input type="submit" value="Turn on page numbers"/></form>
 
<img src="img/aek04_ru/1.gif" alt="" align="left"/>
<p><em>Как и следовало ожидать, на территории бывшего СССР разразилась настоящая эпидемия компьютерной заразы, принимающей самые разнообразные и довольно изощренные формы. Телефонные звонки от обеспокоенных владельцев персональных компьютеров раздаются ежедневно из самых разных мест - от Украины до Благовещенска и обсерваторий в Казахстане. В отличие от традиционного гриппа, эти эпидемии все реже заносятся "оттуда" и все чаще имеют ярко выраженные отечественные приметы...</em></p>
<div align="right">
- Доктор, я умру?<br/>
- Обязательно !!!
</div>
<p>Наши создатели вирусов недолго плелись в хвосте мирового компьютерного хулиганства - пропорционально числу ввозимых компьютеров росло и поголовье электронных насекомых, неизвестных знаменитым SCAN'ам и TNTVIRUS'ам. И, как следствие, практически все пользователи компьютеров рано или поздно (а кое-кто и постоянно) встречаются с вирусом. И, как еще одно следствие, далеко не всегда антивирусные программы правильно опознают этот вирус, и, что гораздо важнее, далеко не все антивирусы правильно его удаляют.</p>
<p>Естественно, что если за соседним столом работает системный программист, который за 2-3 часа выловит гостя и стерилизует компьютер (не прибегая при этом к команде "FORMAT C:"), или вы сами являетесь таковым, то можно спать спокойно. Но если это не так, то придется либо самому становиться системным программистом, либо выделить вирус и отослать его разработчику (или разработчикам) антивирусных программ, а затем с нетерпением ждать ответа.</p>
<p>Ниже приведены рекомендации пользователям, оказавшимся в подобной ситуации. Естественно, что эти рекомендации отражают только Мой личный опыт, и специалисты в области вирусов, особенно их авторы, могут со мной поспорить. В первую очередь, описаны правила использования антивирусных программ, затем методы выделения вируса и наиболее общие способы анализа и удаления вируса. Часть материала, приведенного ниже, впервые опубликована в журнале "Интеркомпьютер", #6, 1990 г.</p>
<h2>1. Методика использования антивирусных программ</h2>
<p>Перед использованием антивирусных программ крайне желательно загрузиться с резервной копии DOS, которая расположена на заведомо чистой от вирусов и защищенной от записи дискете. Это необходимо для того, чтобы застраховаться от присутствия резидентного вируса, так как он может блокировать работу антивируса или использовать его работу для инфицирования. проверяемых файлов. Перезагрузка компьютера должна быть холодной, так как некоторые вирусы "выживают" при теплой перезагрузке.</p>
 
<p>Желательно, чтобы антивирусные программы, используемые для проверки, были самых последних версий. Желательно также, чтобы хоть одна из них была отечественного производства, так как процесс эмиграции вируса в другие страны и иммиграции антивирусных программ занимает довольно большое время. Поэтому наиболее оперативно на появление нового вируса реагируют только отечественные антивирусные программы.</p>
<p>Если обнаружены зараженные файлы, то следует:</p>
<ul>
<li>распечатать их список;</li>
<li>если для этих файлов нет backup-копии, то сохранить их на дискеты;</li>
<li>при помощи антивирусной программы восстановить зараженные файлы и затем проверить их работоспособность и соответствие backup-копии (если есть);</li>
<li>если восстановление файлов произошло не вполне корректно, то их следует уничтожить и переписать с backup-копий; если же копий нет, то восстановить зараженные файлы с дискет и попытаться дезактивировать их при помощи другого антивируса.</li>
</ul>
<p>Следует отметить, что качество восстановления файлов многими антивирусными программами оставляет желать лучшего. Многие популярные антивирусы частенько необратимо портят файлы вместо их лечения. Поэтому если потеря файлов нежелательна, то выполнять перечисленные выше пункты следует в полном объеме.</p>
<p>Необходимо обращать особое внимание на чистоту модулей, сжатых утилитами типа LZEXE, PKLITE или DIET, файлов в архивах (ZIP, ARC, ICE, ARJ и т.д.) и данных в самораспаковывающихся файлах, созданных утилитами типа ZIP2EXE. Если случайно упаковать файл, зараженный вирусом, то обнаружение и удаление такою вируса без распаковки файла практически невозможно. В данном случае типичной будет ситуация, при которой все антивирусные программы сообщат о том, что от вирусов очищены все диски, но через некоторое время вирус появится опять.</p>
<p>Штаммы вируса могут проникнуть и в backup-копии программного обеспечения при обновлении этих копий. Причем архивы и backup-копии являются основными поставщиками давно известных вирусов. Вирус может годами "сидеть" в дистрибутивной копии какого-либо программного продукта и неожиданно проявиться при установке программ на новом компьютере.</p>
<p>Никто не может гарантировать полного уничтожения всех копий компьютерного вируса, так как файловый вирус может поразить не только выполняемые файлы, но и оверлейные модули с расширениями имени, отличающимися от СОМ или EXE. Загрузочный вирус может остаться на какой-либо дискете и внезапно проявиться при случайной попытке перезагрузить с нее. Поэтому целесообразно некоторое время после удаления вируса постоянно пользоваться резидентным антивирусным монитором типа утилиты -D.СОМ, входящей в комплекс "'Доктор' Касперский". При помощи резидентного монитора можно перехватить момент появления подавляющего большинства вирусов. Если вирус нерезидентный, то монитор перехватит обращение к файлам типа СОМ или ЕХЕ. Если вирус резидентный, то отслеживаются изменения в блоках памяти и в таблице векторов прерываний. При этом следует выяснить, как резидентный вирус выглядит на карте оперативной памяти, и после дезактивации вируса периодически просматривать карту памяти на предмет обнаружения этого вируса.</p>
<p>И последнее замечание. Не каждый сбой компьютера является проявлением вируса, поэтому почаще вспоминайте поговорку "Не так страшен черт, как его малюют". К тому же, поражение вирусом - не самое плохое, что может случиться с компьютером.</p>
<img src="img/aek04_ru/2.gif" alt="" align="right"/>
<h2>2. Обнаружение неизвестного вируса</h2>
<p>В этом разделе рассматриваются ситуации, с которыми может столкнуться пользователь в том случае, если его компьютер поражен вирусом, но ни одна из известных ему антивирусных программ не дала положительного результата. Где и как искать вирус? Какие при этом необходимы инструментальные средства и какими методами следует пользоваться?</p>
<h3>2.1. Обнаружвиие файлового вируса</h3>
<p>Как известно, вирусы делятся на резидентные и нерезидентные. Встречавшиеся мне до сих пор резидентные вирусы отличались гораздо большим коварством и изощренностью, чем нерезидентные. Поэтому для начала рассмотрим простейший случай - поражение компьютера неизвестным нерезидентным вирусом. Такой вирус активизируется при запуске какой-либо зараженной программы, совершает все, что ему положено, передает управление программе-носителю и в дальнейшем (в отличие от резидентных вирусов) не будет мешать ее работе. Для обнаружения такого
 
вируса необходимо сравнить длины файлов на винчестере и в дистрибутивных копиях (упоминание о важности хранения таких копий уже стало банальностью). Если это не поможет, то побайтно сравнить дистрибутивные копии с используемыми программами. В настоящее время разработано достаточно много утилит такого сравнения файлов, самая простейшая из них (утилита COMP) содержится в DOS.</p>
<p>Существуют специальные утилиты, которые не только сравнивают содержимое файлов и их параметров (длина, атрибуты, время последней модификации), но и сообщают о наличии в разных файлах повторяющихся одинаковых участков кода или проверяют файлы на наличие "подозрительных" команд (например, утилиты Virus Locator А.Шеховцова или Lie Detector Е.Сусликова, алгоритм теста на "подозрительность" включен и в программу-фаг -V.ЕХЕ). Такие утилиты очень удобны, но иногда начинают "ругаться" на широко распространенные упаковщики ЕХЕ- файлов, некоторые файлы DOS, на антивирусные "насадки" к файлам, плохо обнаруживают вирусы, часть кода которых зашифрована. К тому же, в последнее время появляется все большее количество вирусов-"призраков", у которых два штамма одного вируса практически никогда не имеют ни одного совпадающего байта (в большинстве случаев это достигается сложными шифровками тела вируса и многочисленными модификациями кодов в блоке расшифровки).</p>
<p>Можно также просмотреть дамп выполняемых файлов. В некоторых случаях можно сразу обнаружить присутствие вируса по наличию в его коде текстовых строк. Многие вирусы, например, содержат строки: ".COM", "*.COM", "*.*", "MZ" "COMMAND" и т.д. Эти строки часто встречаются в начале или в конце зараженных файлов. Существует и еще один способ визуального определения зараженного вирусом файла. Он основан на том, что выполняемые файлы, исходный текст которых написан на языке высокого уровня, имеют вполне определенную структуру: сегмент кода программы, а сразу за ним - сегмент данных, причем в начале этого сегмента стоит строка-копирайт фирмы-изготовителя компилятора. Если в дампе такого файла за сегментом данных следует еще один участок кода, то вполне вероятно, что файл заражен вирусом.</p>
<p>Рекомендуется запустить одну из резидентных антивирусных программ-мониторов и следить за ее сообщениями о "подозрительных" действиях программ (запись в COM- или EXE-файлы, запись на диск по абсолютному адресу и т.п.). Существуют мониторы, которые не только перехватывают такие действия, но и сообщают адрес, откуда поступил "подозрительный" вызов (к таким мониторам относится -D.СОМ). Обнаружив подобное сообщение, следует выяснить, от какой программы оно пришло, и проанализировать ее коды при помощи резидентного дизассемблера (например, -UTIL.COM). При анализе кодов программ, резидентно находящихся в памяти, большую помощь часто оказывает трассирование прерываний 13h и 21h.</p>
<h3>2.2. Обнаружение загрузочного вируса </h3>
<p>В загрузочных секторах дисков расположены небольшие, как правило, программы, назначение которых состоит в определении размеров и границ логических дисков (для MBR-винчестера) или загрузке операционной системы (для Boot-сектора). Дампы таких программ приведены в Приложении.</p>
<p>Вначале следует прочитать содержимое сектора, "подозрительного" на наличие вируса. Для этой цели лучше использовать программы из комплекта "Нортоновских утилит".</p>
<p>Некоторые загрузочные вирусы практически сразу обнаруживают свое присутствие различными текстовыми строками (например, вирус "Stone" содержит
 
строки: "Your РС is now Stoned!", "LEGALISE MARIJUANA!"). Некоторые вирусы, поражающие Boot-секторы дисков, проявляются отсутствием строк, обязательно присутствующих в Boot-секторе. К таким строкам относятся: строка-заголовок Boot-сектора, содержащая номер версии DOS или название фирмы-производителя программного обеспечения (например, строка "MSDOS3.3"); имена системных файлов (например, строка "IO SYSMSDOS SYS"); строки сообщений об ошибках.</p>
<p>Стандартный загрузчик MS-DOS, расположенный в MBR, занимает меньше половины сектора, и многие вирусы поражающие MBR винчестера, довольно просто заметить по увеличению длины кода, расположенного в секторе MBR.</p>
<p>Однако существуют вирусы, которые внедряются в загрузчик без изменения его текстовых строк и с минимальными изменениями кода загрузчика (например, вирусы, изменяющие при инфицировании MBR всего 3 байта Disk Partition Table, соответствующие адресу активного загрузочного сектора). Для идентификации такого вируса придется провести более детальное исследование кодов загрузочного сектора вплоть до полного анализа алгоритма работы его кода.</p>
<p>Приведенные рассуждения основываются на том, что стандартные загрузчики (программы, записываемые операционной системой в загрузочные секторы) реализуют стандартные алгоритмы загрузки операционной системы и оформляются в соответствии с ее стандартами. Если же диски отформатированы утилитами, не входящими в состав DOS (например, Disk Manager), то для обнаружения в них вируса следует проанализировать алгоритм работы и оформление загрузчиков, создаваемых такой утилитой.</p>
<p>Рассмотренные выше методы обнаружения файловых и загрузочных вирусов подходят для большинства как резидентных, так и нерезидентных вирусов. Однако эти методы не срабатывают, если вирус выполнен по технологии "стелс", что делает бесполезным использование большинства резидентных мониторов, утилит сравнения файлов и чтения секторов.</p>
<h3>2.3. Обнаружение резидентной части вируса</h3>
<p>Если в компьютере обнаружены следы деятельности вируса, но видимых изменений в файлах и системных секторах дисков не наблюдается, то вполне возможно, что компьютер поражен одним из "стелс"-вирусов. В этом случае необходимо загрузить DOS с заведомо чистой от вирусов дискеты, содержащей резервную копию DOS, и действовать как и при поражении нерезидентным вирусом. Однако иногда это нежелательно, а в ряде случаев невозможно (известны, например, случаи покупки новых компьютеров, зараженных вирусом). Тогда придется обнаружить и нейтрализовать резидентную часть вируса, выполненную по технологии "стелс". Возникает вопрос: где в памяти и как искать вирус или его резидентную часть? В настоящее время известно несколько способов инфицирования памяти.</p>
<ol>
<li>Вирус может проникнуть в таблицу векторов прерываний. Лучший способ обнаружить такой вирус состоит в том, чтобы просмотреть карту распределения памяти, которая отображает список резидентных программ (пример такой карты приведен в табл. 1). Подробная карта памяти сообщает информацию о всех блоках, на которые разбита память: адрес блока управления памятью MCB, имя программы - владельца блока, адрес ее префикса программного сегмента (PSP) и список перехватываемых блоком векторов прерываний.
<p>При наличии вируса в таблице векторов прерываний утилиты, отображающие карту распределения памяти (например, -D.СОМ, -UTIL.COM), начинают "шуметь".</p>
<p><strong>Таблица 1. Карта распределения незараженной памяти</strong></p>
<table border="1" cellspacing="0" cellpadding="0" summary="Таблица 1. Карта распределения незараженной памяти">
<tr><th>Адрес блока MCB</th><th>Адрес PSP</th><th>Размер блока MCB (Кб)</th><th>Имя программы владельца блока MCB</th><th>Номера векторов прерываний</th></tr>
<tr><td>0E9A</td><td> 0E9B</td><td> 3,20K</td><td> COMMAND.COM </td><td>22,24,2E</td></tr>
<tr><td>0F6E</td><td> 0F6F</td><td> 0,04K</td><td> блок свободен </td><td>&nbsp;</td></tr>
<tr><td>0F72</td><td> 0E9B</td><td> 0,15K</td><td> COMMAND.COM </td><td>&nbsp;</td></tr>
<tr><td>0F7D</td><td> 0F85</td><td> 23,20K</td><td> -D.COM </td><td>10,1B,1C,23,26,27,28,2F,40,EF,FF</td></tr>
<tr><td>1545</td><td> 1546</td><td> 0,10K</td><td> блок свободен </td><td>&nbsp;</td></tr>
<tr><td>154D</td><td> 154E</td><td> 3,90K</td><td> PLUCK.COM </td><td>09,13,16,21</td></tr>
<tr><td>1648</td><td> 0E9B</td><td> 549,30K</td><td> COMMAND.COM </td><td>30,EE,F2,F3,F4,F5,F6,F7,F8,FE</td></tr>
</table>
<p><strong>Таблица 2. Таблица векторов прерываний поражена вирусом</strong></p>
<table border="1" cellspacing="0" cellpadding="0" summary="Таблица 2. Таблица векторов прерываний поражена вирусом">
<tr><th>Адрес блока MCB</th><th>Адрес PSP</th><th>Размер блока MCB (Кб)</th><th>Имя программы владельца блока MCB</th><th>Номера векторов прерываний</th></tr>
<tr><td>0E9A</td><td> 0E9B</td><td> 3,20K</td><td> COMMAND.COM </td><td>22,24,2E,EB</td></tr>
<tr><td>0F6E</td><td> 0F6F</td><td> 0,04K</td><td> блок свободен </td><td>&nbsp;</td></tr>
<tr><td>0F72</td><td> 0E9B</td><td> 0,15K</td><td> COMMAND.COM </td><td>&nbsp;</td></tr>
<tr><td>0F7D</td><td> 0F85</td><td> 23,20K</td><td> -D.COM </td><td>10,1B,1C,23,26,27,28,2F,40,CA,D3</td></tr>
<tr><td>1546</td><td> 1547</td><td> 0,10K</td><td> блок свободен </td><td>&nbsp;</td></tr>
<tr><td>154E</td><td> 154F</td><td> 3,90K</td><td> PLUCK.COM </td><td>09,13,16,91</td></tr>
<tr><td>164C</td><td> 0E9B</td><td> 549,30K</td><td> COMMAND.COM </td><td><table border="0" summary=""><tr><td>30,85,89,8E,90,93, 95,97,98,9D,9E,9F, A2,A7,A9,AB,AE,AF, B1,B3,BB,BE,BF,C0, C4,C9,CE,CF,D0,D1, D2,D4,D5,D8,D9,DA, DB,DD,DF,E0,E4,E5, E6,E7,E8,E9,EA,ED, EE,F3,F4,F5,F7,F8, F9</td><td style="border-left: solid thin black;">"Шум"</td></tr></table></td></tr>
</table>
<p>Другой, более надежный, но требующий высокой квалификации пользователя способ, - просмотреть таблицу векторов прерываний с помощью дизассемблера. Если при этом будут обнаружены коды какой-то программы, то код вируса (или участок кода) найден.</p>
</li>
<li>Вирус может несколькими способами встроиться в DOS: в произвольный системный драйвер, в системный буфер, в другие рабочие области
 
DOS (например, в область системного стека или в свободные места таблиц DOS и BIOS). Пока известен единственный способ инфицирования вирусом произвольного системного драйвера: прикрепление тела вируса к файлу, содержащему драйвер, и модификация заголовка поражаемого драйвера, Если при этом вирус оформляет себя как отдельный драйвер, то его можно обнаружить при просмотре карты распределения памяти, содержащей список системных драйверов. Если при этом в списке присутствует драйвер, который не описан в файле C0NFIG.SYS, то он и может быть вирусом. Если же вирус "приклеивается" к расположенному перед ним драйверу, не выделяя свои коды как отдельную программу-драйвер, то обнаружить его можно методами, описанными ниже.
<p><img src="img/aek04_ru/3.gif" alt="" align="right"/></p>
<p>Вирус, встраивающийся в системный буфер, должен уменьшать общее число буферов; в противном случае он будет уничтожен последующими операциями считывания с диска. Достаточно несложно написать программу, которая подсчитывает число буферов, реально присутствующих в системе, и сравнивает полученный результат со значением команды BUFFERS, расположенной в файле CONFIG.SYS (если команда BUFFERS отсутствует, то со значением, устанавливаемым DOS по умолчанию). Подобная проверка прекрасно работает (100% попаданий) в антивирусной программе -V.ЕХЕ.</p>
<p>Существует достаточно способов внедрения вируса в системные таблицы или область стека DOS. Однако реализация этих способов потребует от автора вируса досконального знания различных версий DOS. К тому же свободного места в DOS не так уж много, поэтому написание полноценного "стелс"-вируса такого типа маловероятно. Если же все-таки подобный вирус появится, то обнаружить его код можно дизассемблированием "подозрительных" на наличие вируса участков DOS.</p>
</li>
<li>Вирус может проникнуть в область программ в виде:
<ul>
<li>отдельной резидентной программы или отдельного блока памяти (MCB);</li>
<li>внутри или "приклеившись" к какой-либо, резидентной программе.</li>
</ul>
<p>Если вирус внедряется в отведенную для прикладных программ область памяти в виде нового блока, создавая для себя собственный MCB, или как отдельная резидентная программа, то его можно обнаружить при просмотре подробной карты распределения памяти, отображающей адреса всех блоков MCB. Обычно такой вирус выглядит как отдельный блок памяти (табл. 3), не имеющий имени и перехватывающий один или несколько векторов прерываний (например, int 8h, 13h, 1Ch, 21h).</p>
<p><strong>Таблица 3. Вирус в области пользовательских программ</strong></p>
<table border="1" cellspacing="0" cellpadding="0" summary="Таблица 3. Вирус в области пользовательских программ">
<tr><th>Адрес блока MCB</th><th>Адрес PSP</th><th>Размер блока MCB (Кб)</th><th>Имя программы владельца блока MCB</th><th>Номера векторов прерываний</th></tr>
<tr><td>0E9A</td><td> 0E9B</td><td> 3,20K</td><td> COMMAND.COM </td><td>22,24,2E</td></tr>
<tr><td>0F6E</td><td> 0F6F</td><td> 0,04K</td><td> блок свободен </td><td>&nbsp;</td></tr>
<tr><td>0F72</td><td> 0E9B</td><td> 0,15K</td><td> COMMAND.COM </td><td>&nbsp;</td></tr>
<tr><td>10D1</td><td> 10DA</td><td> 23,20K</td><td> -D.COM </td><td>10,1B,23,26,27,28,2F,40</td></tr>
<tr><td>17AF</td><td> 17B0</td><td> 1,70K</td><td> ? </td><td>08 (Обнаружен вирус "Yankee Doodle")</td></tr>
<tr><td>1820</td><td> 0E9B</td><td> 539,30K</td><td> COMMAND.COM </td><td>30,31</td></tr>
<tr><td>9F04</td><td> 0000</td><td> 3,90K</td><td> ? </td><td>1C,21 (Обнаружен вирус "Jerusalem")</td></tr>
</table>
</li>
<li>Вирус может проникнуть за границу памяти, выделенной для DOS. Все загрузочные и некоторые файловые вирусы располагаются за пределами памяти, выделенной для DOS, уменьшая значение слова, расположенного по адресу [0040:0013]. Обнаружить такие вирусы очень просто - достаточно узнать емкость оперативной памяти и сравнить ее с реальной. Если вместо 640 или 512 Кбайт система сообщит меньшее значение, то следует просмотреть дизассемблером "отрезанный" участок памяти. Если на этом участке будут обнаружены коды какой-то программы, то, скорее всего, вирус найден.
<p><strong>Внимание!</strong></p>
<p>Емкость оперативной памяти может уменьшиться на один или несколько килобайт и в результате использования расширенной памяти или некоторых типов контроллеров. При этом типична следующая картина: в "отрезанном" участке содержимое большинства байтов нулевое.</p>
</li>
<li>Вирус может встраиваться в конкретные, заведомо резидентные программы или "приклеиться" к уже имеющимся блокам памяти. Возможно инфицирование вирусом файлов DOS, которые являются резидентными (например, IО.SYS, MSDOS.SYS, COMMAND.COM), загружаемых драйверов (ANSY.SYS, COUNTRY.SYS, RAMDRIVE.SYS) и др. Обнаружить такой вирус гораздо сложнее вследствие малой скорости его распространения, но, однако, вероятность атаки подобного вируса значительно меньше. Все чаще стали встречаться "хитрые" вирусы, которые корректируют заголовки блоков памяти или "обманывают" DOS таким образом, что блок с кодами
 
вируса становится одним целым с предыдущим блоком памяти.
<p>В этом случае обнаружить вирус гораздо сложнее - необходимо знать реальную длину программ, размещенных в памяти, и список прерываний, которые они перехватывают. Но этот способ не очень удобен и иногда не срабатывает. Поэтому рекомендуется использовать другой метод, который может облегчить выявление вируса в подобной ситуации. Он основан на следующем свойстве - подавляющее большинство вирусов для обнаружения незараженных файлов или секторов дисков перехватывают прерывания 13h или 21h, встраиваясь в обработчик прерывания. В таком случае для обнаружения вируса достаточно просмотреть текст (команды ассемблера) обработчиков указанных прерываний (например, при помощи программы -UTIL.СОМ). Правда, для того, чтобы отличить вирус от обычных программ, требуется достаточный опыт работы с вирусами и некоторое представление о структуре обработчика на незараженном компьютере. К тому же следует быть осторожным: существует несколько вирусов, которые "завешивают" систему при попытке трассировки их кодов.</p>
<p>Известны вирусы, которые при заражении файлов или дисков не пользуются прерываниями, а напрямую работают с ресурсами DOS. При поиске подобного вируса необходимо тщательно исследовать изменения во внутренней структуре зараженной DOS: список драйверов, таблицы файлов, стеки DOS и т.д. Это очень кропотливая работа, которая, учитывая многочисленность версий DOS, требует очень высокой квалификации пользователя.</p>
</li>
</ol>
<p>Конечно, возможны и другие, достаточно экзотические способы инфицирования памяти вирусом, например, внедрение вируса в видеопамять (что уже встречалось) или в расширенную память, но подобные вирусы встречаются достаточно редко и всегда проявлялись хотя бы одним из перечисленных выше признаков. Возможно, конечно, создание монстров, использующих виртуальные режимы процессоров 80386 и 80486 (а что будет в 80586?), но, во-первых, это будет слишком заметно, а во-вторых, программист подобной квалификации всегда найдет для себя более осмысленную задачу.</p>
<h2>3. Анализ алгоритма вируса</h2>
<p>На мой взгляд, наиболее удобным для хранения и анализа вируса объектом является файл, содержащий его (вируса) тело. Как показывает практика, для анализа файлового вируса удобнее иметь несколько зараженных файлов различных, но не очень больших, длин. При этом желательно иметь зараженные файлы всех типов (COM, EXE и SYS), которые могут быть поражены вирусом. Если необходимо проанализировать часть оперативной памяти, то при помощи некоторых утилит (например, -UTIL.СОМ) довольно просто выделить участок, где расположен вирус, и скопировать этот участок на диск. Если же требуется анализ сектора MBR или Вооt-сектора, то скопировать их в файлы можно при помощи популярных "Нортоновских утилит". Для хранения загрузочного вируса наиболее удобен файл-образ зараженного диска. Для его получения необходимо отформатировать дискету (лучше 360 Кбайт), заразить ее вирусом, скопировать образ дискеты (все сектора, начиная с 0-го и кончая последним) в файл и, при необходимости, скомпрессировать его (эту процедуру можно проделать при помощи "Нортоновских утилит", программ TELEDISK или DISKDUPE).</p>
<p>Зараженные файлы или файл-образ зараженной дискеты лучше передать разработчикам антивирусных программ по модему или, в крайнем случае, на дискете по почте в обмен на антивирусную программу. Однако, если это займет много времени, которое, как известно, не ждет, то пользователям, достаточно уверенным в себе, можно попробовать и самостоятельно разобраться в вирусе и написать антивирус.</p>
<p>При анализе алгоритма вируса предстоит выяснить:</p>
<ul>
<li>способ(ы) размножения вируса;</li>
<li>характер возможных повреждений, которые вирус нанес информации, хранящейся на дисках;</li>
<li>метод лечения оперативной памяти и зараженных файлов (секторов).</li>
</ul>
<p>При решении этих задач не обойтись без дизассемблера или отладчика (это могут быть отладчики Quaid Analyzer, Advanced Trace86, FULSCREEN DEBUG или дизассемблеры DisDoc, Sourcer или IDA).</p>
<p>И отладчики, и дизассемблеры имеют и положительные, и отрицательные черты - каждый выбирает то, что он считает более удобным. Несложные короткие вирусы быстро "вскрываются" стандартным отладчиком DEBUG; при анализе объемных и высокосложных (типа вируса "V-4096") не обойтись без дизассемблера. Если необходимо быстро обнаружить метод восстановления пораженных файлов, то достаточно пройтись отладчиком по началу вируса до того места, где он восстанавливает загруженную программу перед тем, как передать ей управление (фактически именно этот алгоритм чаще всего используется при лечении вируса). Если же требуется получить детальную картину работы вируса или хорошо документированный листинг, то, кроме дизассемблера Sourcer и его возможности восстанавливать перекрестные ссылки, здесь вряд ли что поможет. К тому же, следует учитывать, что, во-первых, некоторые вирусы достаточно успешно блокируют попытки протрассировать их коды, а во-вторых, при работе с отладчиком существует ненулевая вероятность того, что вирус вырвется из-под контроля.</p>
<p>При анализе файлового вируса необходимо выяснить, какие файлы (COM, EXE, SYS) поражаются вирусом, в какое место (места) в файле записывается код вируса - в начало, конец или середину файла, в каком объеме возможно восстановление файла (полностью или частично), в каком месте вирус хранит восстанавливаемую информацию.</p>
 
<p>При анализе загрузочного вируса основная задача - выяснение адреса (адресов) сектора, в котором вирус сохраняет первоначальный загрузочный сектор (если, конечно, вирус сохраняет его).</p>
<p>Для резидентного вируса также необходимо выделить участок кода, создающий резидентную копию вируса, и вычислить возможные адреса точек входа в перехватываемые вирусом прерывания. Необходимо также выяснить, каким образом и где в оперативной памяти выделяет вирус место для своей резидентной копии: записывается ли вирус по фиксированным адресам в системные области DOS и BIOS, уменьшает размер памяти, выделенной под DOS (слово по адресу [0000:0413]), создает для себя специальный MCB-блок, либо использует какой-либо другой способ.</p>
<p>Существуют особые случаи, когда анализ вируса может оказаться очень сложной для пользователя задачей, например, при анализе вируса-"призрака". В этом случае лучше обратиться к специалисту по анализу кодов программ.</p>
<h2>4. Восстановление пораженных объектов </h2>
<p>При поражении компьютера произвольным вирусом перед пользователем могут возникнуть следующие задачи: дезактивация резидентной памяти, лечение загрузочных секторов (MBR, Boot), обход подкаталогов всех дисков, поиск и восстановление зараженных файлов.</p>
<h3>4.1. Дезактивация оперативной памяти </h3>
<p>При лечении оперативной памяти следует обнаружить коды вируса и изменить их таким образом, чтобы вирус в дальнейшем не мешал работе антивирусной программы.</p>
<p>Оптимальный алгоритм обнаружения кодов вируса зависит от способа инфицирования вирусом оперативной памяти. Если вирус записывает свою резидентную копию по фиксированным адресам, то и искать ее нужно по этим адресам. Если вирус создает для своей TSR-копии новый MCB-блок, то следует пройти все MCB-блоки, начиная с первого и кончая последним, и в каждом блоке по фиксированным адресам искать коды вируса. Если вирус записывается за пределами памяти DOS, предварительно уменьшая размер выделенной под DOS памяти, то следует провести полное сканирование "отрезанного" от DOS участка. Практически для всех способов инфицирования вирусом оперативной памяти подходит метод трассировки прерываний, используемый вирусами семейства "Yankee".</p>
<p>После того как определены адреса TSR-копии вируса, следует исправить его коды таким образом, чтобы полностью нейтрализовать влияние вируса на процесс поиска и лечения зараженных файлов. Итак, если, например, вирус заражает файлы при их открытии, это может выглядеть примерно следующим образом:</p>
<pre><u>Исходный код вируса</u>                     <u>Код дезактивированного вируса</u>
........        ...............         ........	...........
80 FC 3D	CMP AH, 3Dh 	        80 FC 3D	CMP AH, 3Dh
74 хх 		JE  Infect_File 	90		NOP
Е9 хх хх 	JMP Continue		90		NOP
					Е9 хх хх	JMP Continue
........	...............		........	...........
</pre>
<p>При дезактивации TSR-копии вируса следует учитывать, что вирус может предпринимать специальные меры для восстановления своих кодов (например, некоторые вирусы семейства "Yankee"), и в этом случае придется нейтрализовать и механизм самовосстановления вируса.</p>
<h3>4.2. Восстановление загрузочных секторов </h3>
<p>Восстановление секторов в большинстве случаев довольно простая операция, выполняемая при помощи "Нортоновских утилит" или DOS'овской команды SYS. При заражении компьютера вирусом со сложным алгоритмом основной задачей становится определение адреса сектора, в котором находится сохраненный вирусом оригинальный загрузочный сектор. Некоторые вирусы не сохраняют старое содержимое сектора (вирус "Azusa"); в этом случае придется восстанавливать коды загрузочного сектора по какому-либо образцу (например, по образцам, приведенным в Приложении).</p>
<p>При восстановлении системных загрузчиков следует соблюдать особую осторожность, поскольку результатом неправильного исправления сектора MBR или Boot-сектора может быть потеря всей информации на диске (дисках). Поэтому даже довольно простую процедуру считывания и восстановления оригинального загрузочного сектора нужно обязательно проверить на корректность. Простейшая проверка состоит в выяснении наличия в конце загрузочного сектора сигнатуры AA55h.</p>
<h3>4.3. Восстановление файлов </h3>
<p>При лечении файлов следует учесть следующие правила:</p>
<ul>
<li>необходимо протестировать и вылечить все выполняемые файлы (COM, EXE, SYS, оверлеи) во всех каталогах всех дисков вне зависимости от атрибутов файлов (т.е. файлы read-only, системные и скрытые), а также выполняемые файлы, упакованные в архивах;</li>
<li>желательно сохранить неизменными атрибуты и дату последней модификации файла;</li>
<li>следует учесть возможность многократного поражения файла вирусом ("бутерброд" из вирусов).</li>
</ul>
<p>Само лечение файла производится в большинстве случаев довольно просто. Если вирус записывается в
 
конец файла, то необходимо восстановить старое начало файла (у ЕХЕ-файлов особое внимание следует обратить на корректность полей восстанавливаемых заголовков) и затем отрезать вирус от файла (пример программы, восстанавливающей файлы, пораженные вирусом "Vienna-648", приведен в Приложении). Если вирус записался в начало файла, то следует переписать старое содержимое файла в его (файла) начало и укоротить файл.</p>
<p>В более сложных случаях (особенно, если вирус зашифрован или выполнен по технологии "призрак") процедура восстановления файла может существенно усложниться.</p>
<address>
Е.Касперский<br/>
Москва, Тессинский пер. 9/16, АО "Ками"<br/>
Телефоны (095) 499-15-00, 928-21-38<br/>
Е-mail: <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="fa9f8f9d9f949fba919b9793d4948a9397898fd4978991d4898f">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script>
</address>
<h2>Термины</h2>
<dl>
<dt>Дизассемблер</dt>
<dd> - утилита, осуществляющая преобразование, обратное ассемблированию, то есть переводящая машинные коды в язык ассемблера. Такие утилиты крайне необходимы не только при отладке программ (для чего они и создаются), но и при анализе вируса.</dd>
<dt>Дизассемблирование</dt>
<dd> - перевод машинных кодов какой-либо программы в ее представление на языке ассемблера. </dd>
<dt>Монитор (программа-монитор, блокировщик)</dt>
<dd> - резидентно находящаяся в оперативной памяти утилита, которая позволяет выявлять "подозрительные" действия пользовательских программ: изменение и переименование выполняемых программ (COM- и EXE-файлов), запись на диск по абсолютному адресу, форматирование диска и т.д. При обнаружении "подозрительной" функции программа-монитор либо выдает на экран сообщение, либо блокирует выполнение перехваченной функции, либо совершает другие специальные действия.</dd>
<dt>Призрак (вирусы-"призраки")</dt>
<dd> - вирусы, предпринимающие специальные меры для затруднения их поиска и анализа. Не имеют сигнатур, то есть не содержат ни одного постоянного участка кода. В большинстве случаев два образца одного и того же вируса-"призрака" не будут иметь ни одного совпадения. Это достигается шифрованием основною тела вируса и модификациями программы-расшифровщика.</dd>
<dt>Стелс (Stealth) - "стелс"-вирусы (вирусы-невидимки)</dt>
<dd> представляют собой программы, которые перехватывают обращения DOS к пораженным файлам или секторам дисков и "подставляют" вместо себя незараженные участки информации. Кроме этого, такие вирусы при обращении к файлам используют достаточно оригинальные алгоритмы, позволяющие "обманывать" резидентные антивирусные мониторы. К "стелс"-вирусам относятся вирусы "V-4096", "Fish #6", "Brain" и некоторые другие.</dd>
</dl>
<h2>Программа-доктор для файла пораженного вирусом "Vienna-649"</h2>
<pre class="source">
	Offset_3_Bytes=206h

SEGA	SEGMENT BYTE PUBLIC
	ASSUME	CS:SEGA, DS:SEGA

	ORG	100H

CURE	PROC
START:
	PUSH	CS				; Код и данные
	POP	DS				;  в одном сегменте

	MOV	DX, OFFSET File_Name		; Открыть файл
	MOV	AX, 3D02h
	INT	21h
	JC	Error

	MOV	Handle, AX

	MOV	CX, 3				; Прочитать первые
	MOV	DX, OFFSET Buffer		;  3 байта файла
	MOV	BX, Handle
	MOV	AH, 3Fh
	INT	21h
	JC	Error

	XOR	CX, CX				; Вычислить адрес
	MOV	AX, WORD PTR Buffer+1		;  первоначального
	ADD	AX, Offset_3_Bytes		;  начала файла
	ADC	CX, 0				;  (старые 3 байта)

	MOV	DX, AX				; Установить указатель
	MOV	BX, Handle			;  на старые 3 байта
	MOV	AX, 4200h
	INT	21h
	JC	Error

	MOV	CX, 3				; Прочитать старое
	MOV	DX, OFFSET Buffer+3		;  начало файла
	MOV	BX, Handle
	MOV	AH, 3Fh
	INT	21h
	JC	Error

	XOR	CX, CX				; Переместить указатель
	XOR	DX, DX				;  на начало файла
	MOV	BX, Handle
	MOV	AX, 4200h
	INT	21h
	JC	Error

	MOV	CX, 3				; Восстановить начало файла
	MOV	DX, OFFSET Buffer+3
	MOV	BX, Handle
	MOV	AH, 40h
	INT	21h
	JC	Error

	XOR	CX, CX				; Переместить указатель
	MOV	DX, WORD PTR Buffer+1		;  на начало вируса
	ADD	DX, 3
	ADC	CX, 0
	MOV	BX, Handle
	MOV	AX, 4200h
	INT	21h
	JC	Error

	MOV	CX, 0				; Укоротить файл
	MOV	BX, Handle
	MOV	AH, 40h
	INT	21h

Error:
	MOV	BX, Handle			; Закрыть файл
	MOV	AH, 3Eh
	INT	21h

	MOV	AX, 4C00h			; Выход в DOS
	INT	21h

Handle		DW	?
File_Name	DB	"INFECT.COM"
Buffer		DB	6 DUP (?)

CURE	ENDP
SEGA	ENDS
	EBD	START
</pre>
 
<h2>Приложение</h2>
<h3>Дамп сектора, содержащего MBR</h3>
<p>С адреса 0000 по адрес 00E1 - программа загрузки активного Boot-сектора.</p>
<p>С адреса 01C0 по адрес 01FD - таблица разбиения диска (Disk Partition Table).</p>
<img src="img/aek04_ru/app_d0.gif" alt="Dump: программа загрузки активного Boot-сектора"/>
<h3>Дамп сектора, содержащего нормальный Boot-сектор</h3>
<img src="img/aek04_ru/app_d1.gif" alt="Dump1: таблица разбиения диска (Disk Partition Table)"/>
<h3>Дамп сектора, содержащего усеченный Boot-сектор</h3>
<img src="img/aek04_ru/app_d2.gif" alt="Dump2: усеченный Boot-сектор"/>
<h3>Дамп сектора, зараженного вирусом "Stone"</h3>
<img src="img/aek04_ru/app_d3.gif" alt="Dump3: Дамп сектора, зараженного вирусом Stone"/>
[<a style="" href="/lib/?lang=RU&amp;index=AV#aek04">Вернуться к списку</a>] [<a href="/lib/aek04.html#disqus_thread">Комментарии</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=aek04">de</a><a href="/lib/index.php?lang=en&amp;id=aek04">en</a><a href="/lib/index.php?lang=es&amp;id=aek04">es</a><a href="/lib/index.php?lang=it&amp;id=aek04">it</a><a href="/lib/index.php?lang=fr&amp;id=aek04">fr</a><a href="/lib/index.php?lang=pl&amp;id=aek04">pl</a><a href="/lib/index.php?lang=ru&amp;id=aek04">ru</a><a href="/lib/index.php?lang=ua&amp;id=aek04">ua</a></div>
</body>
</html>
