<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title> herm1t 'Recompiling the metamorphism' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="herm1t"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, herm1t,Recompiling the metamorphism, type, binary, code, assembly, anti, polymorphic, level, virus, data, form, program, bullet, high, bulletin, implement"/>
<meta name="Description" content="I am sure that using the advantages of high-level languages and compiler's theory would fulfill the potential hidden in metamorphism."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"d4a35de0686e66a515b6a1ca1fb2e3d4231f4af5-1498755114-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vhe11.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Recompiling the metamorphism</h1><p><a href="/lib/?lang=en&amp;author=herm1t"> herm1t</a><br/> <em><a href="/vx.php?fid=2008#f2008">Valhalla #2</a></em><br/> <em>March 2012</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vhe11.html';</script><div class="ci"><a href="/lib/?ci=vhe11">2</a></div>[<a style="" href="/lib/?lang=EN&amp;index=ME#vhe11">Back to index</a>] [<a href="/lib/vhe11.html#disqus_thread">Comments</a>]<br/> 
<address>
<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="4c24293e217d38623a340c2b212d2520622f2321">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script><br/>
<a href="http://vxheaven.org/herm1t/">http://vxheaven.org/herm1t/</a>
</address>
<ul>
<li><a href="#c1">The Shadow of the Past</a></li>
<li><a href="#c2">Real Programmers Don't Use Asm</a></li>
<li><a href="#c3">The Giant's Shoulders</a></li>
<li><a href="#c4">Two-faced undecidability: Why self-optimization is not (and never be) a problem</a></li>
<li><a href="#c5">The sketch</a></li>
<li><a href="#c6">Intermediate code considered harmful</a></li>
<li><a href="#c7">21 ways to shoot yourself in the foot</a></li>
<li><a href="#c8">The silver bullet</a></li>
<li><a href="#c9">References</a></li>
</ul>
<h2><a name="c1"></a>The Shadow of the Past</h2>
<p>Unlike my previous articles, this one has no single line of code. I would like to briefly discuss why neither metamorphism, nor other code mutation techniques doesn't lead to the essential changes in the "game". Antiviruses has been learnt to detect the RPME, Mistafall, Lexotan and a few others experimental viruses rather quickly. I want to share a few thoughts on how to fix the situation.</p>
<p>I have tried to write this article for the several times and may be this time it would turn out something good. I began to dimly understand how the virus of my dreams will look like many years ago, but I felt the obstacles on the way to this "super-engine" as almost insurmountable. I have discussed the metamorphism with some people since then, and some of them already tried to implement something of the kind, while others had a purely theoretical interest in the topic. By the way, I am glad to catch an opportunity and want to thank wK and SPTH for their thoughts and comments. I am not ready to implement it as well, but it's not ruled out that this notes might be of some use and may be even urge one to an action.</p>
<p>Before going to any details, I wish to say some words on words. The discontentedly misleading ones. As with any new knowledge (the virology is still showing its infancy), our brave pioneers were lavishly poured words and gave names without thinking about how good those words describing the subject. I have nothing against it, but if you would slightly change the verbiage, you could look on the subject from the different angle.</p>
<h2><a name="c2"></a>Real Programmers Don't Use Asm</h2>
<p>In his classical article The Mental Driller said: "If you have realized, the pseudoassembler is quite general, ..." [1], But, no, that wan't do! Excuse me, but why the hell this should be assembler? In the programming the assembly considered the bad taste, because it's hard to support the assembly code and give the questionable advantages. Until one would not exhaust all other possibilities, the assembly is a kind of preliminary opimization in its pure form, not to speak about the complications it could cause to the author and his engine.</p>
<p>Metamorphic virus consists of the several parts: it gains control, then it tries to disassemble its own code, "shrink" (or <em>optimize</em>) it, then the usual doubts about searching for a victim and changing it, "expand" (or <em>obfuscate</em>) the code and finally writing it to a file. Not too bad, but the virus performs both of the most significant phases of re-compilation in such a way, like it was trying to build the ship in the bottle, or in the compiler's language: through a <em>peep hole</em> (modifying a few instructions at a time), leaving out of account both the structure and semantic of the code.</p>
<p>It's the inherent defect of the low-level programming. The "fact" that "real coderz use asm" unintentionally compels a developer's attention on machine instructions, registers, code size, and other irrelevant matters. Fancy that! One could carefully write an assembly code, count bytes, just to see how the metamorphic engine will turn it into the pile of unreadable thrash. Makes a perfect sence.</p>
<p>It would be better to use high level language instead of assembly. By "high level" I mean a possibility to (automatically) extract additional information from the code (<em>not what it do, but what it mean</em>) rather than builtin support for the features like hashes, iterators or objects. The special feature of a smart software is its ability to maintain interconnections and meaning of the code and data rather than shuffling it like a deck.</p>
<h2><a name="c3"></a>The Giant's Shoulders</h2>
<p>Like many other remarkable ideas, the concept of <em>polymorphic compiler</em> emerged long ago. I have found one of the first occurences in the Risks digest:</p>
<blockquote>
<p>I think that the polymorphic compiler approach is still stronger than that of the existing polymorphic engines. It also has the advantage that it will work fine in operating systems and environents that don't like self-modifying code. The compiler could even re-compile itself, so that there wouldn't be one speck of invariant code. Although many of the simple approaches could waste a greal deal of space by adding randomized jumps, etc, an efficient polymorphic compiler could probably work about as well as a poorly-optimized conventional compiler, if not better. Register allocations could be randomized, code could be spaghettied and one could store different implementations for primitive operations. [2]</p>
</blockquote>
<p>Bontchev (who took part in the discussion) didn't recognized the possible consequences of Paul Houle's idea, but such compiler actually appeared at the very end of the MS-DOS era. That compiler is Amazing Code Generator [3] (you could read the decription in the Virus Bulletin [4]). The similar thoughts was expressed by Z0mbie in the early zeroes. Recent addition to this topic is Kaze's KPASM.</p>
<p>If it's so good why it's not widespread? John Aycock proposed the criteria which would help to distinguish the ground-breaking technology [5]. To be a game changer the technology has to change the defensive measures essentially and it must shift the motivation and business model of an adversary. I am sure that poly- and metamorphic compilers will met these conditions. Among other reasons, the black market could provide a stimulus too. Today's malware is heavily dependent on cryptors. To keep the cryptor in actual form is expensive and time consuming process, based on the large amount of the routine work. The compiler which is able to produce large amount of complex and variable code could supplant the cryptors and cause a lot of head ache to anti-virus vendors. That's good, because they should replace their signature-based idiocy with something clever. It's time to scramble out of the cozy hole both for VXers and AVers.</p>
<p>The first encrypted viruses written by Mark Washburn were detected, but the latter polymorphic viruses wreck a havoc amongst AVers, the Morris Worm was a first swallow, but the mass worms appered only in the late nineties. Metamorphism, is the recent example of the same cycle, being implemented on the qualitatively new level it would allow us to move on.</p>
<h2><a name="c4"></a>Two-faced undecidability: Why self-optimization is not (and never be) a problem</h2>
<p>While discussing the virus-compiler issues with my peers, they had often raised the concerns that a decompiler of a virus engine could be used directly by anti-virus to produce the clean virus sample. “Qué carajo”, I said. I could back this with such thing as <em>full employment theorem</em>. It's impossible to write a perfect optimizing compiler. Suppose that such compiler exists. It could "look" at the hanging program and optimize it down to the single dead-loop statement. Or converge two different algorithm's implementations to a single most optimal one (thus <em>prooving</em> their identity). Both tasks boils down to the <em>halting problem</em>, and thus (according to Church-Turing thesis) undecidable. So it is always possible to improve the compiler, or spam filter, or an anti-virus and their developers would not be out of work.</p>
<p>The word "undecidable" in this context doesn't mean that there is no solution (if it being so there were no compilers at all), but that it's not known is there any solution and how much time does it take to get it. This uncertainty has the diametrically opposite consequences for viruses and anti-viruses. In order to detect virus the anti-virus requires single (or a limited number) of forms of the virus. On the contrary the virus would require <em>any</em> possible form with only one requirement - the output's <em>average</em> size should be constant (to prevent the virus from endless growing in size).</p>
<p>One of the recent research [6] called such basic form (or pattern) the "zero form", and the process of obtaining such form is called "zeroing". The attentive reader could notice already that zeroing is undecidable. It could be proved in one step - if zeroing is able to reduce all possible forms of the virus to a single "normalized" (not neccessary optimal) form it could do it to any type of programs as well, thus proving or refuting their identity. That's known to be undecidable. QED. The world is really that bad - the virus which has 10% survival rate is a good one, the anti-virus with 90% detect rate is not. The glass is half empty for an AVers and half-full for us.</p>
<h2><a name="c5"></a>The sketch</h2>
<p>My first intention was to use some ready compiler (as simple as possible) and I found the extreme example. [7] cc500 is not exactly what I want, but it's suitable to illustrate some concepts. It is simple, one-pass compiler which implements the small subset of C language and directly produces the x86 code. It is able to compile itself and the resulting executable is 16K long. I have tried to fix some limitations like hardcoded main() position and this was amazingly simple. When I changed the code generation routines to slightly improve the quality of the code:</p>
<div class="diff" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #991111;">&lt; &nbsp; emit<span style="color: black;">&#40;</span><span style="">6</span>, &quot;\x81\xc4....&quot;<span style="color: black;">&#41;</span>; /* add $<span style="color: black;">&#40;</span>n * 4<span style="color: black;">&#41;</span>,%esp */</span><br/>
<span style="color: #991111;">&lt; &nbsp; save_int<span style="color: black;">&#40;</span>code + codepos - <span style="">4</span>, n &lt;&lt; <span style="">2</span><span style="color: black;">&#41;</span>;</span><br/>
<span style="color: #888822;">---<br/>
<span style="color: #00b000;">&gt; &nbsp; if <span style="color: black;">&#40;</span>n != 0<span style="color: black;">&#41;</span> <span style="color: black;">&#123;</span> /* avoid null stack adjustments */</span></span><br/>
<span style="color: #00b000;">&gt; &nbsp; &nbsp; if <span style="color: black;">&#40;</span>n &lt;= 5<span style="color: black;">&#41;</span></span><br/>
<span style="color: #00b000;">&gt; &nbsp; &nbsp; &nbsp; while <span style="color: black;">&#40;</span>n != 0<span style="color: black;">&#41;</span> <span style="color: black;">&#123;</span></span><br/>
<span style="color: #00b000;">&gt; &nbsp; &nbsp; &nbsp; &nbsp; emit<span style="color: black;">&#40;</span><span style="">1</span>, &quot;\x5a&quot;<span style="color: black;">&#41;</span>; /* pop edx */</span><br/>
<span style="color: #00b000;">&gt; &nbsp; &nbsp; &nbsp; &nbsp; n = n - <span style="">1</span>;</span><br/>
<span style="color: #00b000;">&gt; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#125;</span></span><br/>
<span style="color: #00b000;">&gt; &nbsp; &nbsp; else <span style="color: black;">&#123;</span></span><br/>
<span style="color: #00b000;">&gt; &nbsp; &nbsp; &nbsp; emit<span style="color: black;">&#40;</span><span style="">6</span>, &quot;\x81\xc4....&quot;<span style="color: black;">&#41;</span>; /* add $<span style="color: black;">&#40;</span>n * 4<span style="color: black;">&#41;</span>,%esp */</span><br/>
<span style="color: #00b000;">&gt; &nbsp; &nbsp; &nbsp; save_int<span style="color: black;">&#40;</span>code + codepos - <span style="">4</span>, n &lt;&lt; <span style="">2</span><span style="color: black;">&#41;</span>;</span><br/>
<span style="color: #00b000;">&gt; &nbsp; &nbsp; <span style="color: black;">&#125;</span></span><br/>
<span style="color: #00b000;">&gt; &nbsp; <span style="color: black;">&#125;</span></span><br/>
<span style="color: #00b000;">&gt; <span style="color: black;">&#125;</span></span><br/>
<span style="color: #00b000;">&gt; </span><br/>
<span style="color: #00b000;">&gt; void load_reg<span style="color: black;">&#40;</span>int v<span style="color: black;">&#41;</span></span><br/>
<span style="color: #00b000;">&gt; <span style="color: black;">&#123;</span></span><br/>
<span style="color: #00b000;">&gt; &nbsp; if <span style="color: black;">&#40;</span>v == 0<span style="color: black;">&#41;</span> <span style="color: black;">&#123;</span></span><br/>
<span style="color: #00b000;">&gt; &nbsp; &nbsp; emit<span style="color: black;">&#40;</span><span style="">2</span>, &quot;\x31\xc0&quot;<span style="color: black;">&#41;</span>; /* xor eax, eax */</span><br/>
<span style="color: #00b000;">&gt; &nbsp; <span style="color: black;">&#125;</span> else</span><br/>
<span style="color: #00b000;">&gt; &nbsp; if <span style="color: black;">&#40;</span>v &lt;= 127<span style="color: black;">&#41;</span> <span style="color: black;">&#123;</span></span><br/>
<span style="color: #00b000;">&gt; &nbsp; &nbsp; emit<span style="color: black;">&#40;</span><span style="">3</span>, &quot;\x6a\x00\x58&quot;<span style="color: black;">&#41;</span>; /* push byte v / pop eax */</span><br/>
<span style="color: #00b000;">&gt; &nbsp; &nbsp; code<span style="color: black;">&#91;</span>codepos - <span style="">2</span><span style="color: black;">&#93;</span> = v;</span><br/>
<span style="color: #00b000;">&gt; &nbsp; <span style="color: black;">&#125;</span> else <span style="color: black;">&#123;</span></span><br/>
<span style="color: #00b000;">&gt; &nbsp; &nbsp; emit<span style="color: black;">&#40;</span><span style="">5</span>, &quot;\xb8....&quot;<span style="color: black;">&#41;</span>; /* mov $x,%eax */</span><br/>
<span style="color: #00b000;">&gt; &nbsp; &nbsp; save_int<span style="color: black;">&#40;</span>code + codepos - <span style="">4</span>, v<span style="color: black;">&#41;</span>;</span><br/>
<span style="color: #00b000;">&gt; &nbsp; <span style="color: black;">&#125;</span> &nbsp;</span><br/>
<span style="color: #00b000;">&gt; <span style="color: black;">&#125;</span></span><br/>
<span style="color: #00b000;">&gt; </span><br/>
<span style="color: #00b000;">&gt; void lea_reg<span style="color: black;">&#40;</span>int v<span style="color: black;">&#41;</span></span><br/>
<span style="color: #00b000;">&gt; <span style="color: black;">&#123;</span></span><br/>
<span style="color: #00b000;">&gt; &nbsp; if <span style="color: black;">&#40;</span>v == 0<span style="color: black;">&#41;</span> <span style="color: black;">&#123;</span></span><br/>
<span style="color: #00b000;">&gt; &nbsp; &nbsp; emit<span style="color: black;">&#40;</span><span style="">2</span>, &quot;\x89\xe0&quot;<span style="color: black;">&#41;</span>;</span><br/>
<span style="color: #00b000;">&gt; &nbsp; <span style="color: black;">&#125;</span> else</span><br/>
<span style="color: #00b000;">&gt; &nbsp; if <span style="color: black;">&#40;</span>v &lt;= 127<span style="color: black;">&#41;</span> <span style="color: black;">&#123;</span></span><br/>
<span style="color: #00b000;">&gt; &nbsp; &nbsp; emit<span style="color: black;">&#40;</span><span style="">4</span>, &quot;\x8d\x44\x24\x00&quot;<span style="color: black;">&#41;</span>;</span><br/>
<span style="color: #00b000;">&gt; &nbsp; &nbsp; code<span style="color: black;">&#91;</span>codepos - <span style="">1</span><span style="color: black;">&#93;</span> = v;</span><br/>
<span style="color: #00b000;">&gt; &nbsp; <span style="color: black;">&#125;</span> else <span style="color: black;">&#123;</span></span><br/>
<span style="color: #00b000;">&gt; &nbsp; &nbsp; emit<span style="color: black;">&#40;</span><span style="">7</span>, &quot;\x8d\x84\x24....&quot;<span style="color: black;">&#41;</span>; /* lea <span style="color: black;">&#40;</span>n * 4<span style="color: black;">&#41;</span><span style="color: black;">&#40;</span>%esp<span style="color: black;">&#41;</span>,%eax */</span><br/>
<span style="color: #00b000;">&gt; &nbsp; &nbsp; save_int<span style="color: black;">&#40;</span>code + codepos - <span style="">4</span>, v<span style="color: black;">&#41;</span>;</span><br/>
<span style="color: #00b000;">&gt; &nbsp; <span style="color: black;">&#125;</span></span><br/>
<span style="color: #440088;">267,268c304</span><br/>
<span style="color: #991111;">&lt; &nbsp; &nbsp; emit<span style="color: black;">&#40;</span><span style="">7</span>, &quot;\x8d\x84\x24....&quot;<span style="color: black;">&#41;</span>; /* lea <span style="color: black;">&#40;</span>n * 4<span style="color: black;">&#41;</span><span style="color: black;">&#40;</span>%esp<span style="color: black;">&#41;</span>,%eax */</span><br/>
<span style="color: #991111;">&lt; &nbsp; &nbsp; save_int<span style="color: black;">&#40;</span>code + codepos - <span style="">4</span>, k<span style="color: black;">&#41;</span>;</span><br/>
<span style="color: #888822;">---<br/>
<span style="color: #00b000;">&gt; &nbsp; &nbsp; lea_reg<span style="color: black;">&#40;</span>k<span style="color: black;">&#41;</span>;</span></span><br/>
<span style="color: #440088;">272,273c308</span><br/>
<span style="color: #991111;">&lt; &nbsp; &nbsp; emit<span style="color: black;">&#40;</span><span style="">7</span>, &quot;\x8d\x84\x24....&quot;<span style="color: black;">&#41;</span>; /* lea <span style="color: black;">&#40;</span>n * 4<span style="color: black;">&#41;</span><span style="color: black;">&#40;</span>%esp<span style="color: black;">&#41;</span>,%eax */</span><br/>
<span style="color: #991111;">&lt; &nbsp; &nbsp; save_int<span style="color: black;">&#40;</span>code + codepos - <span style="">4</span>, k<span style="color: black;">&#41;</span>;</span><br/>
<span style="color: #888822;">---<br/>
<span style="color: #00b000;">&gt; &nbsp; &nbsp; lea_reg<span style="color: black;">&#40;</span>k<span style="color: black;">&#41;</span>;</span></span><br/>
<span style="color: #440088;">334a370</span><br/>
<span style="color: #00b000;">&gt; </span><br/>
<span style="color: #440088;">362,363c398</span><br/>
<span style="color: #991111;">&lt; &nbsp; &nbsp; emit<span style="color: black;">&#40;</span><span style="">5</span>, &quot;\xb8....&quot;<span style="color: black;">&#41;</span>; /* mov $x,%eax */</span><br/>
<span style="color: #991111;">&lt; &nbsp; &nbsp; save_int<span style="color: black;">&#40;</span>code + codepos - <span style="">4</span>, n<span style="color: black;">&#41;</span>;</span><br/>
<span style="color: #888822;">---<br/>
<span style="color: #00b000;">&gt; &nbsp; &nbsp; load_reg<span style="color: black;">&#40;</span>n<span style="color: black;">&#41;</span>;</span></span><br/>
<span style="color: #440088;">377,378c412</span><br/>
<span style="color: #991111;">&lt; &nbsp; &nbsp; emit<span style="color: black;">&#40;</span><span style="">5</span>, &quot;\xb8....&quot;<span style="color: black;">&#41;</span>; /* mov $x,%eax */</span><br/>
<span style="color: #991111;">&lt; &nbsp; &nbsp; save_int<span style="color: black;">&#40;</span>code + codepos - <span style="">4</span>, token<span style="color: black;">&#91;</span><span style="">1</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>;</span><br/>
<span style="color: #888822;">---<br/>
<span style="color: #00b000;">&gt; &nbsp; &nbsp; load_reg<span style="color: black;">&#40;</span>token<span style="color: black;">&#91;</span><span style="">1</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span>;</span></span><br/>
&nbsp;</div>
<p>Not too much, right? But even this small modification lead to significant changes - size of code reduced by 2K and a lot of things changed through all the binary. Imagine how it would look like if I add some randomness, like this:</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span>random<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #339933;">||</span> <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/abs.html"><span style="color: #000066;">abs</span></a><span style="color: black;">&#40;</span>v<span style="color: black;">&#41;</span> <span style="color: #339933;">&gt;</span> <span style="color: #0000dd;">127</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; emit<span style="color: black;">&#40;</span><span style="color: #0000dd;">5</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">&quot;<span style="color: #660099; font-weight: bold;">\xb8</span>....&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #808080; font-style: italic;">/* mov $x,%eax */</span><br/>
&nbsp; &nbsp; &nbsp; save_int<span style="color: black;">&#40;</span>code <span style="color: #339933;">+</span> codepos <span style="color: #339933;">-</span> <span style="color: #0000dd;">4</span><span style="color: #339933;">,</span> v<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; <span style="color: black;">&#125;</span> <span style="color: #b1b100;">else</span><br/>
&nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span>random<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <span style="color: #339933;">||</span> v <span style="color: #339933;">!=</span> <span style="color: #0000dd;">0</span><span style="color: black;">&#41;</span> <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; emit<span style="color: black;">&#40;</span><span style="color: #0000dd;">3</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">&quot;<span style="color: #660099; font-weight: bold;">\x6a</span><span style="color: #660099; font-weight: bold;">\x00</span><span style="color: #660099; font-weight: bold;">\x58</span>&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #808080; font-style: italic;">/* push byte v / pop eax */</span><br/>
&nbsp; &nbsp; &nbsp; code<span style="color: black;">&#91;</span>codepos <span style="color: #339933;">-</span> <span style="color: #0000dd;">2</span><span style="color: black;">&#93;</span> <span style="color: #339933;">=</span> v<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; <span style="color: black;">&#125;</span> <span style="color: #b1b100;">else</span><br/>
&nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span>random<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span> <br/>
&nbsp; &nbsp; &nbsp; emit<span style="color: black;">&#40;</span><span style="color: #0000dd;">2</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">&quot;<span style="color: #660099; font-weight: bold;">\x31</span><span style="color: #660099; font-weight: bold;">\xc0</span>&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #808080; font-style: italic;">/* xor eax, eax */</span><br/>
&nbsp; &nbsp; <span style="color: black;">&#125;</span> <span style="color: #b1b100;">else</span><br/>
&nbsp; &nbsp; &nbsp; emit<span style="color: black;">&#40;</span><span style="color: #0000dd;">2</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">&quot;<span style="color: #660099; font-weight: bold;">\x29</span><span style="color: #660099; font-weight: bold;">\xc0</span>&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #808080; font-style: italic;">/* sub eax, eax */</span><br/>
&nbsp;</div>
<p>There are a lot of similar changes could be made. In addition, the registers could be selected randomly like in Vecna's RegSwap. And all this goes at nearly no cost, just as a <em>side effect</em>. By adding several hundreds of C lines one could reproduce the results of the best and most complex viruses out there. One don't need any texts on poly- and metamorphism and virus-related experience to achive this. MetaPHOR is 17K lines of assembly code, while a hypothetical virus based on cc500 would take 1-2K lines of straight and clean C and produce the same thing as a by-product.</p>
<h2><a name="c6"></a>Intermediate code considered harmful</h2>
<p>It could be natural to move the lexing and parsing stuff offline and replace the direct code generation with some intermediate code translated into machine instructions or executed directly by a VM. But by doing this one would shrink the compiler down to a classical poly/metamorphic engine. I think that it would be better if a front-end will produce the abstract syntax tree of the virus, including the compiler itself (optimization, obfuscation and back-end parts). There are a lot of things that could be done besides simple instruction replacements. For example, the storage class of the variables could be changed from generation to generation, including classes that are not present in the language spec., like common blocks or "temporary globals". The temporary variable could be introduced at any time. The order of the execution could be randomized with very simple rule, like:</p>
<pre>
	for each node (v) in tree
		if random() &amp;&amp; is_commutative(v->op)
			swap(v->left, v_right)
</pre>
<p>Since, optimization part needs to know if two operations has dependencies on code or data, the same information could be used for the permutation. Being implemented correctly, all hell will let loose to a reverse engineer who would try to understand what the fucking virus is trying to do. All this will be only possible if an "engine" will "knew" what is the <em>meaning</em> of code. The more information is available, the more effective could be compiler.</p>
<h2><a name="c7"></a>21 ways to shoot yourself in the foot</h2>
<p>It's still quite easy to break the whole thing. Especially when you trying to rely on features that are missing from the cross-compiler. Since cc500 has no separate text and data segments (the data is mixed with code) I tried to add the obvious optimization and replace two strings:</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span>accept<span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;==&quot;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; binary1<span style="color: black;">&#40;</span>type<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; type <span style="color: #339933;">=</span> binary2<span style="color: black;">&#40;</span>relational_expr<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: #339933;">,</span> <span style="color: #0000dd;">9</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">&quot;<span style="color: #660099; font-weight: bold;">\x5b</span><span style="color: #660099; font-weight: bold;">\x39</span><span style="color: #660099; font-weight: bold;">\xc3</span><span style="color: #660099; font-weight: bold;">\x0f</span><span style="color: #660099; font-weight: bold;">\x94</span><span style="color: #660099; font-weight: bold;">\xc0</span><span style="color: #660099; font-weight: bold;">\x0f</span><span style="color: #660099; font-weight: bold;">\xb6</span><span style="color: #660099; font-weight: bold;">\xc0</span>&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; <span style="color: black;">&#125;</span><br/>
&nbsp; &nbsp; <span style="color: #b1b100;">else</span> <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span>accept<span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;!=&quot;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; binary1<span style="color: black;">&#40;</span>type<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; type <span style="color: #339933;">=</span> binary2<span style="color: black;">&#40;</span>relational_expr<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: #339933;">,</span> <span style="color: #0000dd;">9</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">&quot;<span style="color: #660099; font-weight: bold;">\x5b</span><span style="color: #660099; font-weight: bold;">\x39</span><span style="color: #660099; font-weight: bold;">\xc3</span><span style="color: #660099; font-weight: bold;">\x0f</span><span style="color: #660099; font-weight: bold;">\x95</span><span style="color: #660099; font-weight: bold;">\xc0</span><span style="color: #660099; font-weight: bold;">\x0f</span><span style="color: #660099; font-weight: bold;">\xb6</span><span style="color: #660099; font-weight: bold;">\xc0</span>&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp;</div>
<p>with a single one:</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>c <span style="color: #339933;">=</span> <span style="color: #ff0000;">&quot;<span style="color: #660099; font-weight: bold;">\x5b</span><span style="color: #660099; font-weight: bold;">\x39</span><span style="color: #660099; font-weight: bold;">\xc3</span><span style="color: #660099; font-weight: bold;">\x0f</span><span style="color: #660099; font-weight: bold;">\x94</span><span style="color: #660099; font-weight: bold;">\xc0</span><span style="color: #660099; font-weight: bold;">\x0f</span><span style="color: #660099; font-weight: bold;">\xb6</span><span style="color: #660099; font-weight: bold;">\xc0</span>&quot;</span><span style="color: #339933;">;</span><br/>
&nbsp; <span style="color: #b1b100;">while</span> <span style="color: black;">&#40;</span><span style="color: #0000dd;">1</span><span style="color: black;">&#41;</span> <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span>accept<span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;==&quot;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; c<span style="color: black;">&#91;</span><span style="color: #0000dd;">4</span><span style="color: black;">&#93;</span> <span style="color: #339933;">=</span> <span style="color: #0000dd;">148</span><span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* SETE */</span><br/>
&nbsp; &nbsp; <span style="color: black;">&#125;</span> <span style="color: #b1b100;">else</span><br/>
&nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span>accept<span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;!=&quot;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; c<span style="color: black;">&#91;</span><span style="color: #0000dd;">4</span><span style="color: black;">&#93;</span> <span style="color: #339933;">=</span> <span style="color: #0000dd;">149</span><span style="color: #339933;">;</span> <span style="color: #808080; font-style: italic;">/* SETNE */</span><br/>
&nbsp; &nbsp; <span style="color: black;">&#125;</span><br/>
&nbsp; &nbsp; <span style="color: #b1b100;">else</span> <span style="color: #b1b100;">return</span> type<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; binary1<span style="color: black;">&#40;</span>type<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; type <span style="color: #339933;">=</span> binary2<span style="color: black;">&#40;</span>relational_expr<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: #339933;">,</span> <span style="color: #0000dd;">9</span><span style="color: #339933;">,</span> c<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp;</div>
<p>But gcc put the string constant into .rodata and the first generation of the compiler segfaulted. In this very case I get off easily with #ifdef:</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #339933;">#ifdef __GNUC__</span><br/>
&nbsp; <span style="color: #993333;">char</span> c<span style="color: black;">&#91;</span><span style="color: black;">&#93;</span> <span style="color: #339933;">=</span> <br/>
<span style="color: #339933;">#else</span><br/>
&nbsp; <span style="color: #993333;">char</span> <span style="color: #339933;">*</span>c <span style="color: #339933;">=</span><br/>
<span style="color: #339933;">#endif</span><br/>
&nbsp; <span style="color: #ff0000;">&quot;...<br/>
</span></div>
<p>but in more complex cases it could lead to the painful process of bootstrapping the compiler. Suppose that you wrote a nice translator from the IR code (as Mental Driller suggested) into highly polymorphic machine code. All is fine except the compiler itself, you'll need to do the same thing twice and rewrite your translator with byte code. That's why I prefer to use C (rather than some homebrew language) for which the compilers are available and there is no need in bootstrapping. Another trap is bytecode itself - many transformations are just not available at this level and you will remain bound by registers, instructions, memory locations and other low-level mess. While you should think about the program in terms of expressions, symbols and scopes. Think <em>what</em> it do rather than <em>how</em>.</p>
<h2><a name="c8"></a>The silver bullet</h2>
<p>So, how this AV soul's resting bullet will look like? An "offline" front-end should produce the serialized AST of the program (it could be stored as a (list (list (or ('lisp 'scheme)))) or a notation polish reverse - that doesn't really matters). The virus is either keeping its source or <em>decompiling</em> it from the machine code. Personally, I prefer the latter option, but to properly implement the decompiler one most likely would need additional information (at least about non basic types which couldn't be recovered and propagated) attached to the code. After recovering its own source the virus should apply optimization (as much as it could) when random obfuscation. I think that it is essential that a virus could use the same rules and the same intermediate representations (like SSA) for both phases, when compile it into native code. I am sure that using the advantages of high-level languages and compiler's theory would fulfill the potential hidden in metamorphism.</p>
<h2><a name="c9"></a>References</h2>
<ol>
<li>The Mental Driller "<a href="/lib/vmd01.html">Metamorphism in practice or "How I made MetaPHOR and what I've learnt"</a>", 29a #6, February 2002</li>
<li>Paul Houle, topic "How to measure polymorphism", Risks, February 1993</li>
<li>Mad Daemon "<a href="/vx.php?id=ea14">Amazing Code Generator</a>", December 1997</li>
<li>Adrian Marinescu "<a href="/lib/aam00.html">ACG in the Hole</a>", Virus Bulletin, Jul 1999, pp.8-9</li>
<li>John Aycock "<a href="/lib/mja05.html">Stux in a rut: Why Stuxnet is boring</a>", Virus Bulletin, September 2011, page 14-17</li>
<li>Arun Lakhotia, Moinuddin Mohammed "<a href="/lib/aal01.html">Imposing Order on Program Statements to Assist Anti-Virus Scanners</a>", In Proceedings of Eleventh Working Conference on Reverse Engineering, Delft, The Netherlands, November 2004, pp. 161-170.</li>
<li>Edmund Evans "CC500: a tiny self-hosting C compiler", http://homepage.ntlworld.com/edmund.grimley-evans/cc500/, 2008</li>
</ol>
[<a style="" href="/lib/?lang=EN&amp;index=ME#vhe11">Back to index</a>] [<a href="/lib/vhe11.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vhe11">de</a><a href="/lib/index.php?lang=en&amp;id=vhe11">en</a><a href="/lib/index.php?lang=es&amp;id=vhe11">es</a><a href="/lib/index.php?lang=it&amp;id=vhe11">it</a><a href="/lib/index.php?lang=fr&amp;id=vhe11">fr</a><a href="/lib/index.php?lang=pl&amp;id=vhe11">pl</a><a href="/lib/index.php?lang=ru&amp;id=vhe11">ru</a><a href="/lib/index.php?lang=ua&amp;id=vhe11">ua</a></div>
</body>
</html>
