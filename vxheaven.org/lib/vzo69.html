<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title> Z0mbie 'About undetectable viruses' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Z0mbie"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Z0mbie,About undetectable viruses, virus, emul, body, time, detection, complexity, codeblock, perform, code, case, file, previous, small, polymorphic, instructions"/>
<meta name="Description" content="Lets consider time of detecting a virus in some executable file.First, time depends on a set of possible variants of virus body. The more possible variants there are in the virus body, the more time needed to iterate them while checking files.This way is the simplest one, and it was choosen by viruses, when they morphed into crypt-, polymorphic-, permutating- and metamorphic- ones."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"7eae17ac9ceaea0eb9aa4edc0ececd693294a325-1498757772-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vzo69.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>About undetectable viruses</h1><p><a href="/lib/?lang=en&amp;author=Z0mbie"> Z0mbie</a><br/> <em><a href="/vx.php?fid=11#f11">29a [6]</a></em><br/> <em>March 2002</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vzo69.html';</script><div class="ci"><a href="/lib/?ci=vzo69">1</a></div>[<a style="" href="/lib/?lang=EN&amp;index=VT#vzo69">Back to index</a>] [<a href="/lib/vzo69.html#disqus_thread">Comments</a>]<br/> <form method="post" action="">
<img src="/img/cache/0b9fd596a90421f9f1f68a9760275737.gif" alt="\text{T_EX size}" valign="middle"/>
<select name="TeX_size"><option value="-2">-2</option><option value="-1">-1</option><option value="0" selected="selected">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option> </select>
<input type="submit" value="Scale"/>
</form>
<p>Lets consider time of detecting a virus in some executable file.</p>
<p>First, time depends on a set of possible variants of virus body. The more possible variants there are in the virus body, the more time needed to iterate them while checking files.</p>
<p>This way is the simplest one, and it was choosen by viruses, when they morphed into crypt-, polymorphic-, permutating- and metamorphic- ones.</p>
<p>For sure, while checking file, all these variants are iterated very seldom (when their amount is small enough), and in most cases there performed special processing of code and then comparing with some mask, or more complex algorithmic detection -- in this case we consider complexity of such checking, instead number of possible body variants.</p>
<p>In case of poly-encrypted virus, this complexity should be increased by a complexity of polymorphic decryptor emulation. In case of simple poly decryptor, it can be the object of detection, instead of virus itself.</p>
<p>Well, at second, the time of detecting a virus depends on a set of possible virus locations (or entrypoints) in file.</p>
<p>For example, if virus hooks entrypoint, it will be enough to perform a checking for this virus only at that address. But, if virus inserts its body into random location in file, then time of detection for this virus is multiplied by size of this file. (this is true for poly decryptors in which next instructions works depending on result of previous ones)</p>
<p>Example of this way is EPO (UEP) technology.</p>
<p>Let</p>
<p>C - complexity of checking file for some virus</p>
<p>Ci - complexity of checking virus in file at some specified address, including poly-decryptor emulation and checking for all possible variants of virus body.</p>
<p>I - number of possible addresses in file, where execution of virus body (or part of this body) can be started at.</p>
<p>Then C = Ci * I</p>
<p>This trivial formula shows as an algorithm of checking file for being infected by some complex virus: for each possible address I, where virus can be located, perform checking for presence of this virus. (Ci).</p>
<p>Algorithm looks as follows:</p>
<pre class="source">
	for(i = 0; i &lt; I; i++)		I
	{				*
		init_emul();		\
		emul(codeblock[i]);	Ci
		check_virus();		/
	}
</pre>
<p>This tells us that the bigger files are better targets to be infected, that virus should be smaller but more complex, and that polymorphic decryptor should work longer, and that number of possible virus locations in file should be maximal.</p>
<p>Well, lets consider now such case, when polymorphic decryptors cosists of N parts, which are located in N different places of file, and that this decryptor works only when all these N blocks are executed consecutively.</p>
<p>In this case, if antivirus doesnt emulate all the program, but only combinations of its blocks, possibly containing virus decryptor, summary complexity of such checking will be equal to</p>
<p><img src="/img/cache/a45506e5306777a1a9e0818fd00ba07f.gif" alt="C=C_i \times \frac{I!}{(I-N)!}" valign="middle"/></p>
<p>For example, if there are 4 suspicious blocks in program, but there should be only 2 consecutively executed virus blocks, there will be checked 12 variants:</p>
<pre class="source">
	{0,1} {0,2} {0,3}
	{1,0} {1,2} {1,3}
	{2,0} {2,1} {2,3}
	{3,0} {3,1} {3,2}
</pre>
<p>As a result, virus checking will look as following:</p>
<pre class="source">
	for(i1 = 0; i1 &lt; I; i1++)	\
	for(i2 = 0; i2 &lt; I; i2++)	 \
	if (i2 != i1)			  \
	for(i3 = 0; i3 &lt; I; i3++)	   \
	if (i3 != i1)			    \ I!
	if (i3 != i2)			    ------
	...				    (I-N)!
	for(iN = 0; iN &lt; I; iN++)	    /
	if (iN != i1)			   /
	if (iN != i2)			  /
	if (iN != i3)			 /
	...				/
	{				*
		init_emul();		\
		emul(codeblock[i1]);	 \
		...			  Ci
		emul(codeblock[iN]);	 /
		check_virus();		/
	}
</pre>
<p>And now there appears a question: how could we know sequence of program instruction execution to insert virus blocks into such places, that they will be executed in some specified order?</p>
<p>This can be achieved by means of tracing the program. And tracing can be performed using win32 debug api.</p>
<p>Selected program should be traced for some small (but random) period of time (seconds). While tracing process, the list of executed instructions should be builded for each (or only main) thread.</p>
<p>Here is interesting thing: we're tracing not program, but process, i.e. EXE file and some DLL files. As such, there appears possibility to insert these N decryptor blocks into different files, but with known execution order.</p>
<p>Fore sure, on small local parts of code all that stuff can be done without tracing, but by means of statical analysis of code instructions. But, for big multithreaded programs, consisting of lots of differents files, and also in case of big distances between viral blocks, statical analysis (i.e. disassembling) is not enough, and tracing (or emulation) is required.</p>
<p>So, we should</p>
<ol>
<li>Select some program.</li>
<li>Perform static analysis. (parsing on instructions, see Mistfall and ZMist)</li>
<li>Perform dynamic analysis (tracing, see Tracer32), but taking into account results of previous disassembling. For example, breakpoint (INT3) should be inserted into beginning of each subroutine, to avoid losing control on callback functions, called from non-tracing DLLs.</li>
<li>Perform static analysis once again, with more quality, because taking into account instruction list, obtained while previous tracing.</li>
<li>Retry from step 3 if needed.</li>
<li>Combine all obtained data.</li>
<li>Select some random places of the program, which are executed in some known order, to insert decryptor parts into.</li>
<li>Integrate decryptor parts and encrypted body into code section.</li>
<li>Build new program.</li>
</ol>
<p>As a result, by means of synthesing two known technologies, there appears possibility to make virus detection much more harder, and, as such, to hammer another one nail into kaspersky's ass.</p>
<p>Now some details... Viral blocks should be of minimal length (some instructions), but N should be big enough. The sequence of executing these N blocks should be complex, including big amount of iterations. This can be achieved by finding cycles in program while tracing it, and then integrating viral blocks into these cycles.</p>
<p>Well, this all is real, you can believe or not.</p>
<div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vzo69">de</a><a href="/lib/index.php?lang=en&amp;id=vzo69">en</a><a href="/lib/index.php?lang=es&amp;id=vzo69">es</a><a href="/lib/index.php?lang=it&amp;id=vzo69">it</a><a href="/lib/index.php?lang=fr&amp;id=vzo69">fr</a><a href="/lib/index.php?lang=pl&amp;id=vzo69">pl</a><a href="/lib/index.php?lang=ru&amp;id=vzo69">ru</a><a href="/lib/index.php?lang=ua&amp;id=vzo69">ua</a></div>
</body>
</html>
