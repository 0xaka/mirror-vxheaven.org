<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Peter Ferrie, Frédéric Perriot 'Mostly harmless' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Peter Ferrie, Frédéric Perriot"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Ferrie, Peter; Perriot, Frédéric,Mostly harmless, worm, function, time, shell, request, server, exploit, exception, vulnerability, random, form, main, byte, windows, security"/>
<meta name="Description" content="The LSASS vulnerability of Microsoft security bulletin MS04-011 affects Windows 2000 and XP, the two most widespread Microsoft operating systems today. It is a stack overflow, hence easily and reliably exploitable - and eEye was kind enough to provide the world with thorough documentation of the possible exploitation vectors.Following in the path of previous high-profile vulnerabilities, the LSASS bug was quickly targeted by proof-of-concept exploits, themselves reused in worms including W32/Sasser.A. Despite the publicity that surrounded Sasser due to its immediate success following its appearance (30 April 2004), this was not the first worm to make use of the vulnerability: some LSASS-exploiting Gaobot variants had surfaced about a week earlier. However, it was the automated infection of new systems that was the decisive factor in making Sasser more widespread."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"b14ada9f438940eb2f889a31e6d921d88230b161-1498756799-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/apf42.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Mostly harmless</h1><p><a href="/lib/?lang=en&amp;author=Ferrie%2C%20Peter">Peter Ferrie</a>, <a href="/lib/?lang=en&amp;author=Perriot%2C%20Fr%C3%A9d%C3%A9ric">Frédéric Perriot</a><br/> <em>Virus Bulletin, Aug 2004, pp. 5-8</em><br/> <em>ISSN 0956-9979</em><br/> <em>August 2004</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/apf42.html';</script><img src="/img/pdf.gif" alt="PDF"/><a href="/lib/pdf/Mostly%20harmless.pdf">Download</a> PDF (45.6Kb) (You need to be registered on <a href="/forum">forum</a>)<br/>[<a style="" href="/lib/?lang=EN&amp;index=AN#apf42">Back to index</a>] [<a href="/lib/apf42.html#disqus_thread">Comments</a>]<br/> <form method="post" action=""><input type="hidden" name="pages" value="1"/><input type="submit" value="Turn on page numbers"/></form>
<address>
Peter Ferrie and Fr&egrave;d&egrave;ric Perriot<br/>
Symantec Security Response, USA
</address>
<ul>
<li><a href="#c1">Bistromathics</a></li>
<li><a href="#c2">Infinite improbability drive</a></li>
<li><a href="#c3">Vogon poetry</a></li>
<li><a href="#c4">Babel fish</a></li>
<li><a href="#c5">Heart of gold</a></li>
<li><a href="#c6">Zaphod was here</a></li>
<li><a href="#c7">Don't panic!</a></li>
<li><a href="#c8">Disaster area</a></li>
<li><a href="#c9">Resistance is futile</a></li>
</ul>
<p>The LSASS vulnerability of <em>Microsoft</em> security bulletin MS04-011 affects <em>Windows 2000</em> and <em>XP</em>, the two most widespread <em>Microsoft</em> operating systems today. It is a stack overflow, hence easily and reliably exploitable - and <em>eEye</em> was kind enough to provide the world with thorough documentation of the possible exploitation vectors.</p>
<p>Following in the path of previous high-profile vulnerabilities, the LSASS bug was quickly targeted by proof-of-concept exploits, themselves reused in worms including W32/Sasser.A. Despite the publicity that surrounded Sasser due to its immediate success following its appearance (30 April 2004), this was not the first worm to make use of the vulnerability: some LSASS-exploiting Gaobot variants had surfaced about a week earlier. However, it was the automated infection of new systems that was the decisive factor in making Sasser more widespread.</p>
<h2><a name="c1"></a>Bistromathics</h2>
<p>Sasser infects new systems by exploiting one of the many vulnerabilities announced in the MS04-011 bulletin. The vulnerability is related to a stack buffer overflow in the file lsasrv.dll, which is normally loaded as part of the lsass.exe process (Local Security Authority Subsystem Service).</p>
<p>In order to find new victims, Sasser scans random IP addresses for vulnerable machines listening on port 445/tcp. Once such a machine is found, it attempts to exploit the LSASS vulnerability by sending a specially crafted RPC request to the LSASS named pipe on the machine. Upon successful exploitation, shell code is injected into the lsass.exe process, which executes a shell (cmd.exe) and binds it to a TCP port. The attacking instance of the worm then connects to this port and sends commands to the shell. These commands download and run the main worm executable on the newly infected system.</p>
<p>The worm download is carried out through FTP, using the default <em>Windows</em> ftp.exe program on the client side (victim). On the server side (attacker), Sasser implements its own crude FTP server, which listens on a non-standard TCP port. The infection scheme of Sasser is very similar to that of W32/Blaster (see <em>VB</em> September 2003, p.10), with the exception of using FTP instead of TFTP as the main transmission protocol. Worms get more reliable!</p>
<p>Once it is running on a new machine, Sasser installs itself in the Windows directory under the name `avserve.exe' and registers itself in `HKLM\...\Run' as the value `avserve.exe',
 
in order to run on <em>Windows</em> startup. Then Sasser simply tries to infect new systems. There is no intended payload, time-triggered routine, or anything other than replication code in this worm.</p>
<h2><a name="c2"></a>Infinite improbability drive</h2>
<p>Sasser generates target IP addresses using three different methods: completely random IPs are used 52 per cent of the time; random IPs located in the same /16 network as the host are used 27 per cent of the time; and random IPs located in the same /8 network as the host are used 21 per cent of the time. This method of skewing probabilities towards nearby hosts was used in W32/Welchia (see <em>VB</em> October 2003, p.10). The aim is to increase the probability of hitting vulnerable hosts, on the assumption that nearby machines suffer from the same misconfiguration problems.</p>
<p>The network scanning speed per attack thread is a maximum of four attacks per second, and Sasser spawns 128 attack threads running in parallel.</p>
<h2><a name="c3"></a>Vogon poetry</h2>
<p>In addition to the scanning threads, Sasser creates an extra thread devoted to listening for incoming connections on its FTP server port, 5554/tcp. Each incoming FTP connection is then serviced by a newly spawned thread.</p>
<p>Despite its extreme simplicity, the FTP server code in Sasser is buggy. All the code does is reply to five basic FTP commands - `USER', `PASS', `PORT', `RETR' and `QUIT' - with some canonical answers, to please the ftp client of the other side of the connection, and serve the worm executable over an FTP data channel.</p>
<p>In the one command requiring a minimal amount of parsing, `PORT', there lurks a buffer overflow due to the use of a strcpy() call (more on this later).</p>
<p>Sasser creates an embryonic log file in `c:\win.log'. This may, originally, have been intended as a list of compromised systems, but due to what appears to be a bug, it remains always one line long. The file contains the IP address of the last system successfully infected, and a counter indicating how many systems have been infected from the local machine, in total, since the worm started running.</p>
<h2><a name="c4"></a>Babel fish</h2>
<p>Sasser exploits one vulnerability, but it really makes use of two different exploits, depending on the platform that it is attacking. We shall refer to them as the `short-form' and `long-form' exploits. Moreover the `long-form' exploit has two variants, using two different trampoline addresses. In order to determine which <em>Windows</em> platform it is attacking, the worm fingerprints the remote target system by establishing a NULL session with it, and checking the Native OS field of a session setup response packet. Based on the contents of the Native OS field, `5.1', `5.0', or neither of these two strings, Sasser picks the short-form, long-form (first variant) or long-form (second variant) exploit, targeted respectively at <em>Windows XP</em>, <em>Windows 2000</em> and unidentified systems. The NULL session packets produced by Sasser seem to originate from a regular <em>Windows 2000</em> system, because the author of the exploit captured sample traffic and simply replayed it in the exploit code.</p>
<p>The mode of operation of the short-form exploit, used against <em>Windows XP</em>, is to hijack a return address. The trampoline address used in this case points to a `call esp' instruction located in the address space of the lsass.exe module itself. (This is contrary to the comment in the publicly available source code of the exploit, which mentions it as a `jmp esp'.)</p>
<p>The long-form exploit is more complicated: it attempts to hijack both a return address and an exception handler on the stack. The trampoline address used against unidentified systems points to a `call ebx' instruction in netrap.dll. The one used against <em>Windows 2000</em> systems points to a `jmp ebx', according to the author of the exploit - but we have not been able to verify this information on our test platforms. The combined hijacking of a return address and an exception handler is probably designed to improve the reliability of the exploitation. In our tests, however, only the exception handler part was needed, and the sole purpose of hijacking the return address was to trigger an exception. (For more detail on the control flow of the exception handler hijacking trick, see <em>VB</em>, September 2001, p.4).</p>
<p>The layout of the attack buffers and the control flow of the exploits are depicted opposite.</p>
<h2><a name="c5"></a>Heart of gold</h2>
<p>Regardless of the exploit flavor, the attack starts by opening a connection to port 445/tcp of the target system, then going through the same protocol negotiation and session setup as in the fingerprinting. Next, the `\lsarpc' named pipe is opened on the remote system, and an RPC request is made against the LSA_DS (Directory Services) interface.</p>
<p>In the short-form exploit, Sasser sends an approximately 2kb attack buffer to the LSA_DS interface. The RPC request is small enough to fit in one RPC fragment, and the entire request is carried out with a single named pipe transaction. In the long-form exploit, the attack buffer is about 7kb long and the RPC request is split into two fragments.</p>
 
<div align="center">
<img src="img/apf42/fig1_1.gif" alt=""/>
<img src="img/apf42/fig1_2.gif" alt=""/>
</div>
<p>As for the fingerprinting, the network traffic generated by the Sasser exploits is more akin to a replay than truly synthesized. The author of the HouseOfDabus exploit, which is reused in Sasser, is likely to have obtained it by sniffing traffic from a first-generation exploit that relied on a modified version of netapi32.dll, which was tampered with to allow an extra parameter in the signature of the DsRolerUpgradeDownlevelServer() function. This function employs the LSA_DS RPC interface for legitimate purposes, but normally operates against the local system only. The extra parameter in the version that has been tampered with identifies a machine, thus allowing remote exploitation.</p>
<p>The effect of the malformed request to the LSA_DS interface is a stack buffer overflow in the DsRolepDebugDumpRoutine() logging function of lsasrv.dll. The vulnerable function is normally used to write information to a file called `DCPROMO.LOG', located in the `%windows%\debug' directory. It employs a 2kb stack buffer to hold log file lines, and it exercises no bounds-checking prior to using a sprintf(`%ws') function to fill the buffer. By providing an over-long value corresponding to the `%ws' parameter, Sasser controls the return address and the rest of the stack after the buffer, which allows the execution of arbitrary code. Sasser relies on this to execute its shell code.</p>
<p>The exact sprintf() function in the buggy log routine varies among operating systems and service packs. For <em>Windows 2000</em>, the function is imported from msvcrt.dll, and is sprintf() in SP0, and vsprintf() in SP4. For <em>Windows XP</em>, the function is imported from user32.dll, and is wsprintfW() in SP0 and wvsprintfW() in SP1a.</p>
<p>The use of <em>Unicode</em> and ASCII functions (with or without the leading `w' in the function name) explains the need for a long-form exploit and a short-form exploit providing more or fewer bytes in the `%ws' parameter for different platforms.</p>
<h2><a name="c6"></a>Zaphod was here</h2>
<p>Surprisingly, Sasser performs the attack twice for each target machine. The likely explanation for this behaviour is also related to the kind of sprintf() function used in DsRolepDebugDumpRoutine(), more specifically to the use of the user32.dll implementation of sprintf() on <em>Windows XP</em> platforms.</p>
<p>The user32.dll implementation of the sprintf() functions has a limit of 1024 characters (not bytes - <em>Microsoft</em>'s documentation is not quite correct) that it will place in the destination buffer. Once the limit is reached, no further data are placed in the buffer. On the first exploitation attempt of a <em>Windows XP</em> system, when the logging routine is called from DsRolerUpgradeDownlevelServer(), this limitation is encountered because the size of the `%ws' parameter combined with the log line header exceeds 1024 characters.</p>
<p>As a result, the stack buffer is missing a final carriage return and a flag is set, indicating that the next bit of log information should simply be appended to the current line. On the next exploitation attempt, the flag is checked and the long `%ws' parameter is copied to the stack buffer without a
 
header. The `%ws' parameter alone fits in the buffer, no stack overflow occurs, and `eventually' (readers are welcome to contact us if they have questions about this) the aforementioned flag is reset, allowing exploitation again.</p>
<p>The net effect is that exploitation of <em>Windows XP</em> systems works only every other time - at least under normal conditions. This explains the double attempt at exploitation by Sasser. The author might have assumed that the same condition could occur while attacking <em>Windows 2000</em> machines, but we have not observed this in our tests.</p>
<p>Once the lsass.exe process is coerced into running the shell code injected by the worm, the code binds to port 9996/tcp, accepts a connection from the attacker and runs a `cmd.exe' shell as the SYSTEM user. The commands sent to the shell cause the worm executable to be FTP'd to a file whose name starts with four to five random digits followed by `_up.exe'.</p>
<h2><a name="c7"></a>Don't panic!</h2>
<p>Despite the obvious success of its spreading mechanism, Sasser suffers from a major limitation: it uses the wrong exploit parameter when it attempts to infect English versions of <em>Windows 2000</em> systems. Tests in the lab show that the trampoline address used by Sasser against English versions of <em>Windows 2000 Workstation</em>, <em>Server</em> and <em>Advanced Server, SP0</em> and <em>SP4</em>, does not correspond to a branch, but to another instruction (a locked `mov') that causes an exception when reached (including from the exception record hijacked by Sasser, which leads to a crash).</p>
<p>We believe this behaviour is related to the single-byte vs. double-byte character platform issue, and that the Sasser exploit targeted at <em>Windows 2000</em> systems works only against double-byte character platforms. This is corroborated by reports from the field: of all Sasser submissions received by <em>Symantec</em> from the `C:\WINNT' directory (the default installation directory for <em>Windows 2000</em>, whereas <em>Windows XP</em> uses `C:\WINDOWS' by default), the vast majority originated from machines located in Taiwan and China. The source of the other submissions was unclear, but the names of the users suggested they may have been double-byte character platforms as well.</p>
<p>Thus, Sasser's exploit is effective only against <em>Windows XP</em> and some versions of <em>Windows 2000</em>. It fails against <em>Windows 2003 Server</em> (in fact, the buggy function is not even called).</p>
<h2><a name="c8"></a>Disaster area</h2>
<p>As in the case of W32/Blaster and other exploit-based worms, the end result of missed exploitation attempts against vulnerable systems is often a crash of the attacked process. The crash - in lsass.exe in the case of Sasser - manifests itself as an error message box warning the user that the system will be shut down. The author of the worm tried to call AbortSystemShutdown() from the main worm executable to prevent this suspicious behaviour, apparently overlooking the fact that the main worm code does not run at all if the exploit fails! On the other hand, if the worm is running successfully on a system that is then incorrectly compromised, the error message box might not appear.</p>
<p>If the exploit succeeds, the shell code terminates with an ExitThread() call after spawning the shell. This is clean enough by itself to ensure that the lsass.exe process keeps running, and makes the use of AbortSystemShutdown() unnecessary.</p>
<h2><a name="c9"></a>Resistance is futile</h2>
<p>From the point of view of Network Intrusion Detection, Sasser has one interesting feature: it sends the FTP data and the shell commands byte-by-byte, which results in the network traffic it sends being split into TCP segments starting at unpredictable boundaries. This may have been designed as a way to evade IDS products which do not have the capability to reassemble TCP streams. It may also have been accidental, since no such care is taken when the RPC attack buffer is sent. Nevertheless, the potential exists to mislead some IDS systems.</p>
<p>It was not long before a jealous contender attempted to take advantage of the vulnerability in Sasser's FTP server code. W32/Dabber, which appeared on 14 May 2004, does just this.</p>
<p>Soon a whole new branch of the security industry will appear, specializing in detecting exploitation of worm vulnerabilities: <em>"Protect your Sasser-infected machines with JamScan. JamScan not only stops Dabber, it also protects you against future worms exploiting the same flaw!"</em></p>
<table summary="W32/Sasser.A">
<tr><th colspan="2">W32/Sasser.A</th></tr>
<tr><th>Aliases:</th><td>W32.Sasser.Worm, WORM_SASSER, Worm.Win32.Sasser.</td></tr>
<tr><th>Size:</th><td>15,872 bytes.</td></tr>
<tr><th>Type:</th><td>Internet worm.</td></tr>
<tr><th>Exploits:</th><td>LSASS vulnerability, MS04-011, CAN-2003-0533.</td></tr>
</table>
 
[<a style="" href="/lib/?lang=EN&amp;index=AN#apf42">Back to index</a>] [<a href="/lib/apf42.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=apf42">de</a><a href="/lib/index.php?lang=en&amp;id=apf42">en</a><a href="/lib/index.php?lang=es&amp;id=apf42">es</a><a href="/lib/index.php?lang=it&amp;id=apf42">it</a><a href="/lib/index.php?lang=fr&amp;id=apf42">fr</a><a href="/lib/index.php?lang=pl&amp;id=apf42">pl</a><a href="/lib/index.php?lang=ru&amp;id=apf42">ru</a><a href="/lib/index.php?lang=ua&amp;id=apf42">ua</a></div>
</body>
</html>
