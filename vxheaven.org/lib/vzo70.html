<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title> Z0mbie 'Infecting ISO CD images' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Z0mbie"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Z0mbie,Infecting ISO CD images, file, byte, images, type, image, autorun, length, bytes, burning, data, sector, directory, files, infecting, case"/>
<meta name="Description" content="Era of the computer virus began from information exchange via diskettes. After some time the most part of this exchange has moved into networking. A bit later cd-roms became widely spreaded. There even appeared cd-related scenes, and today cd burning technology is available mostly to all. And now its time to our move."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"8b2b61cec8c7f02745ea4bf616f635681c7c65d1-1498756491-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vzo70.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Infecting ISO CD images</h1><p><a href="/lib/?lang=en&amp;author=Z0mbie"> Z0mbie</a><br/> <em><a href="/vx.php?fid=11#f11">29a [6]</a></em><br/> <em>March 2002</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vzo70.html';</script>[<a style="" href="/lib/?lang=EN&amp;index=VT#vzo70">Back to index</a>] [<a href="/lib/vzo70.html#disqus_thread">Comments</a>]<br/> 
<p><a href="files/vzo/infiso.zip">additional stuff: INFISO\*.*</a></p>
<p>Era of the computer virus began from information exchange via diskettes. After some time the most part of this exchange has moved into networking. A bit later cd-roms became widely spreaded. There even appeared cd-related scenes, and today cd burning technology is available mostly to all. And now its time to our move.</p>
<p>So, there is a specificity of burning cd disks - since cds are read-only, the whole cd image should be created before burning. Such images has different formats and contains cd filesystem, all the files in defragmented form, and other info. Sometimes these images are called ISOs, because they're in ISO9660 image format specification.</p>
<p>There are a lot of different image formats. Look into ISOBUSTER program, OpenFileDialog to see some of them. Btw, this program is used to look into different cd images and extract files, and is required when testing image infecting.</p>
<p>But, though formats are different and supporting them is hard, there are the following advantages of cd images infecting:</p>
<ol>
<li>Cd disks can contain AUTORUN.INF file in the root directory, so when cd is inserted, some setup file can be automatically runned. (its default windows settings).</li>
<li>Since cd-r disk is burned, it will never be erased, and in most cases user will keep it for a while, and probably pass to some friends.</li>
<li>In most cases cd-disks contains distributives, i.e. installation programs.</li>
<li>Cds are stamped by warez pirates. (same way as CIH became popular)</li>
<li>Cd disks contains extremly big amount of information - 600-700 mbs, and checking such cd image will require tons of time for avers, moreover, most of files on such disks are archives.</li>
</ol>
<p>Now, about information exchange. Some of images are created temporary, and, in theory, it is possible to infect them on-the-fly - if you know this temporary format. But, other ISOs are to be exchanged via internet, and this is our chance to spread via them.</p>
<p>In other words, modern virus should be able to deal with cd images and to infecte them when required.</p>
<p>So, here is some thoughts (and sources) about cd images infecting.</p>
<p>At first, some comments.</p>
<ol>
<li>All the information here were obtained in experimental way, so it can differ from reality.</li>
<li>There are also multitrack and multisession disks, which makes our task more complex.</li>
<li>There are also audio disks, and mixed disks, where audio tracks follows data track(s).</li>
</ol>
<p>Now, lets talk about the main thing - CD sector.</p>
<p>CD sector has fixed length of 2352 bytes, which in case of audio sector can be any bytes, and in case of data sector has the following format:</p>
<table summary="">
<tr><td colspan="2">16-bytes - header: (probably used by drive to search sector)</td></tr>
<tr><td>[12 bytes] PREFIX:</td><td>00 FF FF FF FF FF FF FF FF FF FF 00</td></tr>
<tr><td>[1 byte] minute</td><td>sector number on the disk (or track?),</td></tr>
<tr><td>[1 byte] second</td><td>represented in [minute : second : second/75] form,</td></tr>
<tr><td>[1 byte] second/75</td><td>all in BCD format, 00:02:00 - based. I.e. sector #0 begins from 2 seconds, and each second contains 75 cd sectors. Since cd sector is of 2352 bytes length, each 75 sectors uses 75*2352 = 176400 bytes, which is the same as 44100*2*2 - one second of audio data in [44kHz 16-bit Stereo] format.</td></tr>
<tr><td>[1 byte] sector type</td><td>0=empty, 1=MODE1, 2=MODE2, never saw other values data:</td></tr>
<tr><td>[8 bytes]</td><td>some shit, or data, depending on sector type</td></tr>
<tr><td>[2040 bytes]</td><td>data</td></tr>
<tr><td>[8 bytes]</td><td>data, or some shit</td></tr>
<tr><td>[276 bytes]</td><td>data, or error correction code (ecc), calculation begins from "minute" byte, and 1st 4 bytes (m/s/s75/type) should be temporary zerofilled when calculating.</td></tr>
<tr><td>[4 bytes]</td><td>total sector checksum, which in some cases, when burning, is re-calculated by the cd drive itself. Some copy-protection schemes are based on it.</td></tr>
</table>
<p>Now, about track types.</p>
<p>There exists two data track types: MODE1 and MODE2. So, sector_type field will contain 1 or 2. Also, information about track type is written somewhere in sub-codes, which are not directly available, since are not contained within iso images.</p>
<p>Also, sector_type field can be of zero value, that means that except 1st 16 bytes, all other sector bytes are zero. This is also used by some copy-protection schemes.</p>
<p>MODE1 is used mostly by all of the iso images, since this is IBM disks. MODE2 is used mostly by Sony.</p>
<p>Now, about cd image format.</p>
<p>It is evident, that best cd image format is just a set of cd sectors. And it is so, but only in case of single track. In case of multiple tracks, somewhere should be stored information about track layout and types. For example, CDR-Win program uses additional .CUE-file:</p>
<pre class="source">
FILE "XZ.BIN" BINARY
	TRACK 01 MODE1/2352
		INDEX 01 00:00:00
	TRACK 02 AUDIO
		PREGAP 00:02:00
		INDEX 01 25:44:70
</pre>
<p>As it seems, all the information from such .CUE file will be written to cd in a form of sub-codes. But its not interesting for us, since in most cases 1st track within image is main data track where main stuff is located.</p>
<p>Btw, two and more data tracks can be on both multitrack and multisession disks, and, if you see multiple data tracks, you can not know if it was multitrack or multisession; and it is used by some copy-protection shemes.</p>
<p>In addition, it should be said that sector size within cd image can be not only of 2352 bytes; it can be also 2336(MODE2,XA) bytes and 2048 bytes(MODE1). But, in any case, each sector contains 2048 bytes of data. Also, the stuff that was shown in the .CUE file, in case of some other cd image format can be located in the header of the whole image, which complicates situation.</p>
<p>Now lets talk about cd file system.</p>
<p>Main 2048 bytes of sector data begins from offset 10h in case of MODE1/2352, and from offset 18h in case of MODE2/2352. In case of 2048-bytes sectors, each sector contains data without any prefixes/eccs. In case of 2336(MODE2,XA)-sectors, only 1st 16-byte sector header is stripped, and sector data can be of 2048 or 2336 size, depending on file type - normal or XA. Btw, XA means eXtended Audio.</p>
<p>Now lets imagine that we can deal with cd image on 2048-byte sector level. For sure, there is no file fragmentation at all, and each file is in continuous form, and to specify file location it is enough to know only 1st file sector.</p>
<p>In most cases, 1st 16 sectors are unused. Sector #16 (0-based) begins from CD001 signature. If it is so, at offsets 0x9C and 0xA6 (here and later, add 10h or 18h to all offsets in case of 2352-byte sectors) there are two DWORDs, first one is 1st TOC sector, and 2nd one is size of TOC, in bytes (2048-aligned).</p>
<p>TOC means Table Of Contents. It is the same as root directory.</p>
<p>But here is a little trouble. In case of MODE1, there can be 2nd TOC, which differs from 1st one in one thing: all file names in 2nd TOC are in 2-byte character format. Its called long file names.</p>
<p>Both TOC entries are parallel.</p>
<p>If 2nd TOC exists, then cd file system driver will use its filenames.</p>
<p>2nd TOC can be found same as 1st one, with only difference that you should look not to 16th, but to 17,18 or 19 (or maybe higher) sector, and signature of this sector should be CD001 (1st byte = 0x01 for 1st TOC, 0x02 for 2nd).</p>
<p>Also, there exists bootable disks. In this case somewhere within cd image there is image of bootable diskette (or kind of). Would be interesting to infect it too.</p>
<p>Now, about TOC format.</p>
<p>Lets we have one or two TOCs, each of them is specified by starting sector and size. TOC format is the following:</p>
<pre class="source">
	WORD n;			// entry size, in bytes
	BYTE entry[n];		// data, specifies single file or directory.
	...
	WORD 0;			// end of TOC sector
</pre>
<p>Here should be said that such structure is in each TOC sector, and number of TOC sectors may be calculated as toc_size/2048. I dont know, if one entry can be splitted into two parts, on the border of sectors; i think it cant, and each TOC sector ends with 0000.</p>
<p>Now, about single TOC entry.</p>
<pre class="source">
	00 WORD n;		// length of the entry, in bytes. 0000=last entry
	02 DWORD sector;	// 1st sector of file or directory
	06 DWORD sector2;	// the same in non-intel format
	0A DWORD size;		// length of file or directory
	0E DWORD size2;		// the same in non-intel format
	12 BYTE datetime[6];	// ?
	18 BYTE attr[2];	// if file: MODE1:000C, MODE2:0024
	1A BYTE xz[6];		// 00 00 01 00 00 01
	20 BYTE/WORD namelen;	// length of the following name, in _bytes_
	21 BYTE*namelen		// BYTE-elements for 1st TOC, WORD-elements for 2nd TOC
	&lt;optional data in case of MODE2>
</pre>
<p>Size of namelen field is BYTE in TOC1 and WORD in TOC2. File name characters are of the same size. In some cases entry sizes are 2 or 4-aligned, but, as it seems, its not required. File names may optionaly terminate with 00 (0000), mostly in case of alignment.</p>
<p>In case of MODE2, after filename follows padding with 0s to make WORD-alignment, then four (4) zero-bytes, then four (4) bytes 0D,55,58,41 and six (6) zero-bytes.</p>
<p>So, it is enough to infect iso image.</p>
<p>In theory, image infecting is divided into the following steps:</p>
<ol>
<li>Determine image format.</li>
<li>Setup sector read/write subprograms, to deal with image on the sector level.</li>
<li>By means of these subprograms determine if it is MODE1 or MODE2.</li>
<li>Process TOC and collect file information, including info about file location within image.</li>
<li>Depending on infectiion method:
<ol type="a">
<li>choose some executable file and replace or modify it.</li>
<li>
<ol>
<li>Find some free/unused/whatever place within image and insert own executable there.</li>
<li>Add TOC entry about inserted file.</li>
</ol></li>
</ol></li>
</ol>
<p>In the INFISO tool, cd images are infected in the following way: both TOCs are scanned for AUTORUN.EXE/AUTORUN.INF filenames, which are replaced with OUTARUN.*; then, to the end of the each TOC, new AUTORUN.EXE/.INF are added, if possible; then new files are inserted into the middle of the image.</p>
[<a style="" href="/lib/?lang=EN&amp;index=VT#vzo70">Back to index</a>] [<a href="/lib/vzo70.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vzo70">de</a><a href="/lib/index.php?lang=en&amp;id=vzo70">en</a><a href="/lib/index.php?lang=es&amp;id=vzo70">es</a><a href="/lib/index.php?lang=it&amp;id=vzo70">it</a><a href="/lib/index.php?lang=fr&amp;id=vzo70">fr</a><a href="/lib/index.php?lang=pl&amp;id=vzo70">pl</a><a href="/lib/index.php?lang=ru&amp;id=vzo70">ru</a><a href="/lib/index.php?lang=ua&amp;id=vzo70">ua</a></div>
</body>
</html>
