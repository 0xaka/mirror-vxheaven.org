<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Peter Ferrie 'Sleep-Inducing' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Peter Ferrie"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Ferrie, Peter,Sleep-Inducing, machine, file, port, benny, copy, files, plug, checks, time, returned, calls, windows, process, current, machines"/>
<meta name="Description" content="W32/Serot@mm is another creation from Benny the virus-writer. Its name is derived from the word ‘serotonin’, which is a chemical found in the brain that has been linked to the onset of sleep, among other things. If anyone is wondering whether, this time, Benny has released a bug-free virus... the answer is no. Serot is plagued by programming errors that almost disable it, however some of its capabilities are worth describing, in case another virus appears with these bugs fixed.Serot uses a ‘plug-in’ architecture – which was very successful in W95/Hybris. However, the plug-ins in Serot are almost completely self-contained, even carrying their own buffers if the buffers are ‘small’ enough, resulting in an enormous collection, and much redundancy in the code."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"84422c5453647947095ebba01d3f9e315643b209-1498757144-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/apf36.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Sleep-Inducing</h1><p><a href="/lib/?lang=en&amp;author=Ferrie%2C%20Peter">Peter Ferrie</a><br/> <em>Virus Bulletin, April 2003, pp. 5-6</em><br/> <em>ISSN 0956-9979</em><br/> <em>April 2003</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/apf36.html';</script><div class="ci"><a href="/lib/?ci=apf36">1</a></div><img src="/img/pdf.gif" alt="PDF"/><a href="/lib/pdf/Sleep-Inducing.pdf">Download</a> PDF (20.87Kb) (You need to be registered on <a href="/forum">forum</a>)<br/>[<a style="" href="/lib/?lang=EN&amp;index=AN#apf36">Back to index</a>] [<a href="/lib/apf36.html#disqus_thread">Comments</a>]<br/> <form method="post" action=""><input type="hidden" name="pages" value="1"/><input type="submit" value="Turn on page numbers"/></form>
<address>
Peter Ferrie<br/>
Symantec Security Response, Australia
</address>
<ul>
<li><a href="#c1">Buggy Benny</a></li>
<li><a href="#c2">Attack of the Clones</a></li>
<li><a href="#c3">The Cat that ate the Rat that...</a></li>
<li><a href="#c4">Let’s Swap</a></li>
<li><a href="#c5">A New Way to Express It</a></li>
<li><a href="#c6">Dot Dot Dot Net</a></li>
<li><a href="#c7">The Compiler at Your Service</a></li>
<li><a href="#c8">Conclusion</a></li>
</ul>
<p><a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="efb8dcddc0bc8a9d809baf8282">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script> is another creation from Benny the virus-writer. Its name is derived from the word ‘serotonin’, which is a chemical found in the brain that has been linked to the onset of sleep, among other things. If anyone is wondering whether, this time, Benny has released a bug-free virus... the answer is no. Serot is plagued by programming errors that almost disable it, however some of its capabilities are worth describing, in case another virus appears with these bugs fixed.</p>
<p>Serot uses a ‘plug-in’ architecture – which was very successful in W95/Hybris. However, the plug-ins in Serot are almost completely self-contained, even carrying their own buffers if the buffers are ‘small’ enough, resulting in an enormous collection, and much redundancy in the code.</p>
<h2><a name="c1"></a>Buggy Benny</h2>
<p>Serot is designed for <em>Windows NT</em> and later operating systems. The virus checks explicitly for <em>Windows 9x/Me</em>, and will exit if it is run on any of them. In addition, the virus checks whether NTDLL is accessible using the GetModuleHandleA() API (i.e. that it is resident in memory already), which could affect emulators.</p>
<p>The virus assumes that PSAPI.DLL is present on the system – which is not always the case – and the code will crash if the file does not exist. Serot contains some anti-debugging code which is supposed to cause the virus to exit gracefully if a debugger is detected – due to a bug, however, Serot will usually crash instead.</p>
<h2><a name="c2"></a>Attack of the Clones</h2>
<p>Next the virus checks whether Serot is running on the system already. It attempts to open a mutex called <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="43a1c3db673026312c372c2d2a2d03a1c3da">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script>, but there is no branch to exit if the open is successful. This results in multiple copies of the virus running at the same time.</p>
<p>Serot contains some variables whose contents are increased or decreased by small random values. However, since there are no bounds checks on the alterations, the contents can become negative values – with disastrous consequences. Serot also relies on the result of several APIs being a certain fixed value, even though they are defined as returning either zero or non-zero. If <em>Microsoft</em> should ever change this value, Serot will not work at all.</p>
<p>Serot enumerates processes, looking for the Explorer.exe process, which it uses to remain memory-resident. If the process is found, Serot injects some code into the process, and runs that code.</p>
<p>The injection technique has been used several times by viruses since the first time it was demonstrated, in the W32/Dengue virus, in the year 2000. Previous viruses hooked an API in order to gain control and run the code, for compatibility with <em>Windows 9x/Me</em>. Since Serot is specific to <em>Windows NT</em> and later operating systems, it has no need to hook an API, and can use the CreateRemoteThread() API to run the code.</p>
<h2><a name="c3"></a>The Cat that ate the Rat that...</h2>
<p>The injected code waits for 10 minutes before executing its main routines. This gives the launch process time to terminate, as well as providing an anti-heuristic device. After the time has elapsed, Serot will attempt to delete the file that was used to launch the code, and the registry key that might have been used to launch the file.</p>
<p>At this point, Serot calls a member of the first group of its plug-ins. The plug-ins are in groups based on type. For example, the first group terminates anti-virus and firewall software, based on the window title; the second group gathers email addresses from the ‘mailto:’ string in files, from the MAPI Address Lists if <em>Outlook</em> is running, or from the Windows Address Book; the fourth group sends the virus by email; the seventh group converts .NET files into droppers of the virus.</p>
<p>For groups that contain more than one member, the routine that calls the plug-ins will call a single random member from within that group.</p>
<p>After the first plug-in has returned, Serot generates a keypair for use in encrypted communication with other infected machines, then calls the plug-in that gathers email addresses. If that plug-in returns a failure, then a bug in the code results in the loss of the keypair, and a leakage of the cryptographic context.</p>
<h2><a name="c4"></a>Let’s Swap</h2>
<p>Serot carries a list of IP addresses of known infected machines, and looks for other infected machines by attempting to connect on port 194 to IP addresses found in the registry key ‘HKCU\Software\Microsoft\Ftp\Accounts’. There is another routine that attempts to connect to random IP addresses – however, as the result of a bug, this routine is never called.</p>
<p>Port 194 is a well-known port, reserved for the Internet Relay Chat (IRC) protocol, so traffic on this port is not unusual. If a machine is found to be listening on this port, Serot will verify that the machine is infected, by
 
attempting to establish a communication with it using a private protocol. This protocol contains data encrypted using public key cryptography, in order to avoid packet sniffing.</p>
<p>The protocol is established by Serot on the local machine by sending its public key to the server on the remote machine, and examining what is returned. If a valid public key is returned from the remote machine, then the copy of Serot on the local machine will send its current configuration to the remote machine, encrypted with the public key that was returned by the copy of the virus on the remote machine. In return, the copy of the virus on the remote machine will send its current configuration to the local machine, encrypted with the public key that was returned by the copy of Serot on the local machine. Thus, the two copies of the virus are able to exchange behavioural characteristics and their plug-ins.</p>
<p>Several bugs exist in this code, resulting in a number of allocated memory buffers that are never freed.</p>
<h2><a name="c5"></a>A New Way to Express It</h2>
<p>If no other infected machines are found, Serot will attempt to send itself by email. Yet another bug exists in this code, resulting in the occasional failure to send messages.</p>
<p>The email message uses a ‘feature’ of <em>Outlook Express</em> which involves the UTF-7 encoding of plain-text messages. Using UTF-7 encoding, it is possible to encode HTML message bodies that contain scripts, which are run without user interaction. If the <em>Internet Explorer</em> security settings allow Active scripting, and the scripting of ActiveX controls that are not marked as safe, then the script will run without prompts, regardless of the zone in which it is executing.</p>
<p>Additionally, the email message contains no attachments, because Serot creates a message body that contains the virus in an encoded text form.</p>
<p>The function of the script is to decode the virus body and drop it as a file called ‘c:\setup.exe’. After the file has been dropped, the registry value ‘HKCU\Software\Microsoft\Windows\CurrentVersion\Run\Serotonin’ is created so that Windows will execute the file whenever the current user logs on. This could also be considered a bug, since if there are multiple users, only the current user will spread the virus.</p>
<h2><a name="c6"></a>Dot Dot Dot Net</h2>
<p>Once all of the other actions have been performed, Serot begins listening on port 194, and runs the final plug-in. The current version of this plug-in will convert <em>.NET</em> executable files into droppers of Serot.</p>
<p>The plug-in begins by searching in every subdirectory on drive C: for files whose name ends in ‘exe’. Even the name matching is buggy – not checking for the ‘.’ to indicate a suffix results in the matching of names such as ‘SerotRexe’. For every file that is found, the virus checks whether it is a <em>.NET</em> file that does not contain resources or relocations, and is not protected by a Strong Name hash. If this check passes, then Serot will attempt to infect the file.</p>
<h2><a name="c7"></a>The Compiler at Your Service</h2>
<p>Serot infects files by using the Compiler Services methods that are exposed by the <em>.NET</em> framework. Using these methods, it is possible to decompile an existing file, add new methods and variables, and recompile the file, without requiring any understanding of the underlying structures.</p>
<p>The recompilation is achieved using just a few method calls in <em>.NET</em>, requiring far less effort than the manual reconstruction of standard Portable Executable files that was implemented in W95/ZMist (see <em>VB</em>, March 2001, p.6).</p>
<p>A virus using the manual reconstruction technique seems unlikely, since the underlying structures in <em>.NET</em> are extremely complex and contain many interdependencies. For example, an entry in the method table contains references to the #Strings stream and the #Blob stream. The entry in the #Blob stream contains references into the TypeRefs table. The TypeRefs table contains references into the #Strings stream, and also coded index references into the AssemblyRefs table. The AssemblyRefs table also contains references into the #Strings stream and the #Blob stream. It would take a long time for someone to find out what all of the links are, and work out how to update them manually.</p>
<p>After creating the new code that will drop and run a copy of the virus, Serot attempts to access the file that contains the data that will be dropped. However, errors in the control flow mean that the file the virus attempts to access might not have been created at all.</p>
<p>If the file does exist, Serot will reserve 64Mb of memory for itself, but never free it, resulting in the eventual exhaustion of system resources, since this allocation occurs for every <em>.NET</em> file on a machine.</p>
<p>More memory is not freed if a particular <em>.NET</em> DLL cannot be loaded, and because of another bug, that dll usually cannot be loaded. Serot also assumes that the infection will always succeed, and uses the MoveFile() API to replace the original file, resulting in deletion of the original file if an error occurred.</p>
<h2><a name="c8"></a>Conclusion</h2>
<p>Despite its potential, this very buggy creation of Benny’s snatches defeat from the jaws of victory. However, it demonstrates the Compiler Services, which seem likely to form the basis for future <em>.NET</em> file infectors. A recompiling virus like W95/Anxiety, but without needing the source code, combined with an inserting virus like W95/ZMist, but without rebuilding the file manually... The beast is unleashed, and its full power is unknown.</p>
 
[<a style="" href="/lib/?lang=EN&amp;index=AN#apf36">Back to index</a>] [<a href="/lib/apf36.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=apf36">de</a><a href="/lib/index.php?lang=en&amp;id=apf36">en</a><a href="/lib/index.php?lang=es&amp;id=apf36">es</a><a href="/lib/index.php?lang=it&amp;id=apf36">it</a><a href="/lib/index.php?lang=fr&amp;id=apf36">fr</a><a href="/lib/index.php?lang=pl&amp;id=apf36">pl</a><a href="/lib/index.php?lang=ru&amp;id=apf36">ru</a><a href="/lib/index.php?lang=ua&amp;id=apf36">ua</a></div>
</body>
</html>
