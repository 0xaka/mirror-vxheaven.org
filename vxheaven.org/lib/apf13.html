<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Peter Ferrie 'Criss-cross' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Peter Ferrie"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Ferrie, Peter,Criss-cross, infected, project, powerpoint, copy, screen, target, line, user, jscript, code, infect, executed, variants, appears, external"/>
<meta name="Description" content="Cross-infector viruses demonstrate the flexibility of certain file formats. While some of these viruses have clearly been written to maximise their replication potential (e.g. {W32/Linux}/Peelf, which infected 32-bit Windows and Linux files, or the member of the W32/Chiton family that infected both 32-bit and 64-bit Windows files), most seem to have been written simply to show that it can be done. With the release of issue 6 of the RRLF zine in July (published on http://www.rrlf-zine.de.vu/), we received three new cross-infectors, each for a different set of file formats."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"0237b07b295b30687bcffe443214c83f43e26f7f-1498757845-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/apf13.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Criss-cross</h1><p><a href="/lib/?lang=en&amp;author=Ferrie%2C%20Peter">Peter Ferrie</a><br/> <em>Virus Bulletin, 4 November 2005, pp.4-5</em><br/> <em>ISSN 0956-9979</em><br/> <em>November 2005</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/apf13.html';</script><img src="/img/pdf.gif" alt="PDF"/><a href="/lib/pdf/Criss-cross.pdf">Download</a> PDF (43.55Kb) (You need to be registered on <a href="/forum">forum</a>)<br/>[<a style="" href="/lib/?lang=EN&amp;index=AN#apf13">Back to index</a>] [<a href="/lib/apf13.html#disqus_thread">Comments</a>]<br/> <form method="post" action=""><input type="hidden" name="pages" value="1"/><input type="submit" value="Turn on page numbers"/></form>
<address>
Peter Ferrie<br/>
Symantec Security Response, USA
</address>
<p>Cross-infector viruses demonstrate the flexibility of certain file formats. While some of these viruses have clearly been written to maximise their replication potential (e.g. {W32/Linux}/Peelf, which infected 32-bit <em>Windows</em> and <em>Linux</em> files, or the member of the W32/Chiton family that infected both 32-bit and 64-bit <em>Windows</em> files), most seem to have been written simply to show that it can be done. With the release of issue 6 of the <em>RRLF</em> zine in July (published on http://www.rrlf-zine.de.vu/), we received three new cross-infectors, each for a different set of file formats.</p>
<h2>Monad... No mad</h2>
<p>The first of these viruses is one of a set that captured the media's attention. The virus (which we did not name) is part of a set of viruses for the forthcoming <em>Microsoft Shell</em>, or <em>MSH</em>, also known as `Monad'. (Interestingly, one use of the word monad is to signify `the One' - perhaps the developers at <em>Microsoft</em> thought they wouldn't be taken seriously if they called it `Neo'.)</p>
<p>Originally, <em>MSH</em> was expected to ship with the forthcoming <em>Windows Vista</em>, but it has since been dropped from the initial feature set - which makes rather a non-event of any viruses written for it.</p>
<p>The virus in question attempted to infect .BAT, .MSH and .CMD files. However, due to a bug which should have been obvious during testing, the .BAT and .CMD forms do not prepend the virus code to the target file, as the virus author would like. Instead, the virus code replaces the target file entirely.</p>
<p>The bug is caused by the virus using `copy &lt;a>+&lt;b> &lt;b>'. Since &lt;b> is not read before the copy begins, &lt;a> replaces it entirely. To prepend via a copy requires two operations: one to copy the combination to another file, the other to copy that file over the original.</p>
<p>The .MSH code does work as intended and correctly infects all three file types. However, none of the replication types will infect a file whose read-only attribute is set.</p>
<p>Since .BAT and .CMD files differ only in their extension, the virus is really only a two-platform cross-infector. The .BAT/.CMD form of the virus is able to work by relying on the fact that the <em>Windows</em> command interpreter will consider lines that are not valid batch commands to be references to external files. Since (presumably) those files do not exist, the <em>Windows</em> command interpreter will display error messages instead, but it will then continue to interpret the file.</p>
<h2>You have no new messages</h2>
<p>The virus attempts to hide its activities by switching off message printing, but some messages (such as those produced by the copy operations) cannot be suppressed, except on DOS, <em>Windows 9x</em> and <em>Windows ME</em>. It seems that the virus author tried to hide those too, by clearing the screen, but the command to clear the screen appears before the copy operations, so the messages remain on the screen after the replication has completed.</p>
<p>The .MSH part of the virus is able to work by relying on the fact that, as in JScript, an end of line character is not considered to be a delimiter if it appears between the tokens of a statement. Thus a statement can span several lines without causing an error. This is in contrast to VBScript, for example, where each statement must appear entirely on a single line (although multiple statements can appear on the same line, delimited by the `:' character). The several lines in this case form the .BAT/.CMD replication code, after which comes the .MSH replication code.</p>
<h2>Seek and ye shall find</h2>
<p>The replication from .BAT and .CMD files is achieved by extracting those lines that contain a keyword (the name that the virus author gave it), which appears in every line of the code. These lines are placed into another file, which is then supposed to be prepended to the target files, but as described above, that part simply overwrites the file instead.</p>
<p>In addition, a line of .BAT code that is never executed would have caused some unexpected behaviour if it had been executed. The most obvious effect would be that during subsequent replications, the screen would no longer be cleared at all.</p>
<p>The replication from .MSH files is achieved by searching for files whose extension matches any of the three target extensions, then finding the last of those files which begin with the keyword. Having found such a file, the virus searches again for files whose extension matches any of the three target extensions. The virus then prepends its code to any file that is not already infected, by copying a fixed number of lines of code.</p>
<h2>VBJScript</h2>
<p>The second and third new cross-infector viruses are written by a different author. The second, {VBS/JS}/Cada, infects
 
both VBScript and JScript files by appending the virus code to the target file. It is able to work by relying firstly on the fact that in VBScript the `rem' command causes the rest of the line to be ignored, while in JScript `rem' is considered to be an acceptable name for a variable, so the virus assigns a value to it. After that, the entire JScript virus appears on a single line.</p>
<p>Secondly, the virus relies on the fact that in JScript, the `/*' and `*/' symbols constitute a pair that bound a multi-line comment. Thus, at the end of the JScript code, the `/*' symbol appears to begin the comment, followed by the VBScript code on the next line.</p>
<p>Finally, the virus relies on the `rem' command to cause the rest of the line to be ignored by VBScript, followed immediately by the `*/' symbol to end the JScript comment.</p>
<p>In between, the code searches for all JS and VBS files that can be found in the current directory, and infects any files that are not infected already. The infection marker is the string `rem=1'. However, since the virus performs no tokenisation of its own, it will consider a file to be infected even if it contains that string as part of a longer string (e.g. `members_of_harem=1').</p>
<h2>Open Office</h2>
<p>The last of the viruses is a set of four variants that form the {O97M/VBS/JS}/Macar family. They infect the <em>Microsoft Office</em> applications <em>Word, Excel, PowerPoint, Access, Project</em> and <em>Visio</em>. The .B and .C variants also infect VBScript files. The .D variant infects JScript files instead of VBScript files. The most interesting thing about the .A and .B variants of this virus is that, unlike typical cross-infectors, which execute different code depending on the file type, this code is exactly the same for all of the <em>Office</em> applications and for VBScript.</p>
<p>Infected <em>Office</em> documents for <em>Word, Excel, Project</em> and <em>Visio</em> execute their macro code automatically, via an auto-macro. Infected <em>PowerPoint</em> and <em>Access</em> documents require some user interaction to execute: the <em>PowerPoint</em> macro runs when the user clicks on a slide during a slideshow (which is made possible by the presence of a transparent AutoShape, which covers the entire slide), and the <em>Access</em> macro runs whenever a user opens the first form in the database.</p>
<p>The replication method for .A and .B is unusual - the virus exports its code to a file, reads back that file, removes everything but the virus code (<em>Office</em> applications add additional text when exporting macros), then adds what remains to other files. However, this method avoids the blank-line insertion problem that some macro viruses encounter.</p>
<h2>Trust me</h2>
<p>The Visual Basic Object Model was extended in <em>Office 2000</em> to prevent macros from accessing themselves, which means that a virus can no longer export its code to a file, then import the file to other documents. The .C and .D variants of Macar work around this limitation by creating a macro that carries the whole virus code and writes it to disk. The dropped code is then executed by the macro. Since the external file performs the replication, no reference to the macro code itself is required. This is also an effective anti-heuristic device, at least from the perspective of the macro platform, since the macro does not replicate, although the external file that runs is highly suspicious.</p>
<p>The script begins by setting the VBA security settings for the chosen application to the lowest level. It knows how to adjust the settings for all <em>Microsoft Office</em> versions, from <em>Office 97</em> up to the as-yet-unreleased <em>Office `12'</em> (the virus author guessed the names of the registry values correctly). The virus works in all the pre-release version of the <em>Office `12'</em> applications, with the exception of <em>PowerPoint</em>.</p>
<h2>Get to the point</h2>
<p>One of the more surprising behaviours, from the user's point of view, is the occasional visible launching of <em>PowerPoint</em>. Macar uses <em>OLE Automation</em> to infect documents, which is done by running the application, and scripting the actions to take. Thus, whenever Macar decides to infect a <em>PowerPoint</em> document, <em>PowerPoint</em> is launched (if it was not running already). The reason the launching of the program is visible is because <em>PowerPoint</em> does not allow its main window to be hidden, unlike the other target <em>Office</em> applications. <em>Visio</em> also behaves in an unusual manner - the splash screen is visible, but the main window is not.</p>
<p>Another surprising behaviour is that of <em>Project</em> which, once it appears in the Task List, never goes away. This occurs when Macar decides to infect <em>Project</em> documents, because <em>Project</em>, along with <em>PowerPoint</em>, does not allow multiple copies of itself to be running at the same time.</p>
<h2>Conclusion</h2>
<p>Cross-infectors present some interesting technical hurdles for virus writers and, to a degree, for anti-virus writers too (since the target platforms must be identified and replication on those platforms is required for correct naming - the appearance of the sample can also differ there in significant ways, which can affect the detection).</p>
<p>While virus writers' time is best spent doing entirely non-viral things, whatever slows them down is the next best thing.</p>
 
[<a style="" href="/lib/?lang=EN&amp;index=AN#apf13">Back to index</a>] [<a href="/lib/apf13.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=apf13">de</a><a href="/lib/index.php?lang=en&amp;id=apf13">en</a><a href="/lib/index.php?lang=es&amp;id=apf13">es</a><a href="/lib/index.php?lang=it&amp;id=apf13">it</a><a href="/lib/index.php?lang=fr&amp;id=apf13">fr</a><a href="/lib/index.php?lang=pl&amp;id=apf13">pl</a><a href="/lib/index.php?lang=ru&amp;id=apf13">ru</a><a href="/lib/index.php?lang=ua&amp;id=apf13">ua</a></div>
</body>
</html>
