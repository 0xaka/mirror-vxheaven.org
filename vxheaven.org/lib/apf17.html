<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Peter Ferrie 'Look at that escargot' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Peter Ferrie"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Ferrie, Peter,Look at that escargot, platform, file, infected, files, cent, chance, method, code, author, viruses, exists, host, garbage, msil, gastropod"/>
<meta name="Description" content="In 2003 I wrote `A recompiling virus like W95/Anxiety, but without needing the source code, combined with an inserting virus like W95/ZMist, but without rebuilding the file manually ... The beast is unleashed' (see VB, April 2003, p.5). Now, hot on the heels of MSIL/Impanate (see VB, November 2004, p.6), which introduced inserting viruses for the .NET platform, comes MSIL/Gastropod, which brings the full set of techniques one step closer."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"5090fa6c89d135039ab2f5b0d03b2290650fd903-1498756707-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/apf17.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Look at that escargot</h1><p><a href="/lib/?lang=en&amp;author=Ferrie%2C%20Peter">Peter Ferrie</a><br/> <em>Virus Bulletin, December 2004, pp.4-5</em><br/> <em>ISSN 0956-9979</em><br/> <em>December 2004</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/apf17.html';</script><img src="/img/pdf.gif" alt="PDF"/><a href="/lib/pdf/Look%20at%20that%20escargot.pdf">Download</a> PDF (38.11Kb) (You need to be registered on <a href="/forum">forum</a>)<br/>[<a style="" href="/lib/?lang=EN&amp;index=AN#apf17">Back to index</a>] [<a href="/lib/apf17.html#disqus_thread">Comments</a>]<br/> <form method="post" action=""><input type="hidden" name="pages" value="1"/><input type="submit" value="Turn on page numbers"/></form>
<address>
Peter Ferrie<br/>
Symantec Security Response, USA
</address>
<p><img src="img/apf17_1.jpg" alt="Peter Ferrie, Symantec" align="left"/>In 2003 I wrote `A recompiling virus like W95/Anxiety, but without needing the source code, combined with an inserting virus like W95/ZMist, but without rebuilding the file manually ... The beast is unleashed' (see <em>VB</em>, April 2003, p.5). Now, hot on the heels of MSIL/Impanate (see <em>VB</em>, November 2004, p.6), which introduced inserting viruses for the <em>.NET</em> platform, comes MSIL/Gastropod, which brings the full set of techniques one step closer.</p>
<h2>Do not pass 'go'</h2>
<p>Gastropod begins by calling a method named `Go', which calls another method, which calls two other methods, which ... The virus appears to have been written by someone who has been introduced to classes in C#, and has embraced them with such enthusiasm that every few lines of code are candidates for a method. It is rather like the saying, `when all you have is a hammer, everything looks like a nail'.</p>
<p>This virus searches in the current directory and all parent directories for files whose suffix is `exe'. For each file it finds, Gastropod checks if a file exists with the same name, but preceded by an `_' (underscore). If such a file does not exist, then the virus attempts to rename the original file to this name. The renamed file will be used as a backup in case the infection fails for some reason, however the virus will delete the file if the infection is successful.</p>
<p>There are several bugs in the handling of files, often resulting in the virus exiting with errors such as that the `_[filename]' file cannot be found, or that a file cannot be created because it exists already.</p>
<h2>Due process</h2>
<p><img src="img/apf17_2.jpg" alt="Snail" align="right"/>Gastropod was named `Snail' by its author, because of the slow speed with which it executes. Of course, this is not helped by the poor coding style of the virus author, but an additional slowing factor is the way in which the virus detects if a file is infected already. The infection marker can be found by the virus only by opening each file, and examining each method corresponding to each type that is stored within each module. The file is considered to be infected if any type and length of a method matches that of the virus itself.</p>
<p>If the file is not infected already, then the virus will construct a list of types, marking which of those can be renamed safely. Fortunately, the virus will rename only its own classes and methods. If the current method being examined is the entrypoint method, then the virus will place its classes at the top of the list, before adding those of the host.</p>
<h2>Garbage man</h2>
<p>Once the list is complete, the virus disassembles itself and the host code, using the well-known ILReader.dll utility, which is carried by the virus. The virus appends this file to the host during replication, which accounts for nearly 60kb of the total infection size.</p>
<p>The disassembly is used by the virus to insert garbage instructions throughout the code of itself and the host. The garbage instructions are either a NOP (with 20 per cent chance), or a LDLOC and POP combination (with 10 per cent chance, and only if the current method contains local variables).</p>
<p>If the LDLOC instruction is used, then the virus will choose the index randomly from the local variables of the current method. The virus also removes these instructions if they are found during the disassembly process.</p>
<p>It is unclear why the virus detects and removes those instructions, but one possible explanation is that it is an artifact from the development of the metamorphic engine, prior to the addition of the virus body - since legitimate programs usually do not contain such instruction sequences. If that is the case, Gastropod shares similarities with W95/ZMist (see <em>VB</em>, March 2001, p.6), which contained a routine that inserted redundant JMP instructions into the host, without adding the virus body.</p>
<h2>Unexceptional</h2>
<p>The virus is aware of the exception handling mechanisms in MSIL, and handles them mostly correctly - however not everything goes according to plan.</p>
<p>There are a number of bugs in the parsing, resulting in always duplicating `endfinally' instructions, and producing unreachable (and, in some cases, incorrect) `leave' instructions. These are things that would have been obvious
 
to a tester, since they are visible in the sample that the virus author released.</p>
<p>This also makes it extremely difficult to restore a file to its state prior to infection. To complicate things further, the virus extracts the managed resources from the host, and stores them externally, in a file whose name is the same as the host, with `.resources' appended. Finally, if the host contained unmanaged resources, the virus will move the resources to the end of the file, and place them in a newly created section that is always named `.rsrc'.</p>
<p>If the entrypoint method ends with a `ret' instruction, then the virus inserts code to abort the thread. This prevents the process from hanging around in memory, instead of terminating, and waiting for the virus code to complete, which would be suspicious to some users. A similar problem exists for Win32 viruses that hook the ExitProcess() API of a host.</p>
<p>After disassembling the virus code and the host code, the virus renames its classes and methods. The renaming is done using 6-15 letters, with a 12.5 per cent chance of an upper case letter. The virus avoids renaming the `Go' method though, since the way in which the virus inserts the code into the host's Main method results in a hard-coded method name.</p>
<h2>Conclusion</h2>
<p>The acceptance of the <em>.NET</em> platform has been slow so far, but it is increasing, and the complexity of viruses for that platform has already progressed much further, in a much shorter time, than was the case for earlier <em>Windows</em> platforms.</p>
<p>The full potential of the <em>.NET</em> platform has not yet been realised by virus writers, but it is clear that they are working hard to reach that goal. We have received the warning, and our anti-virus engines must be prepared. For some companies, the <em>.NET</em> platform might be the next OLE2.</p>
<table summary="MSIL/Gastropod">
<tr><th colspan="2">MSIL/Gastropod</th></tr>
<tr><th>Size</th><td>77828 bytes.</td></tr>
<tr><th>Type</th><td>Direct action, parasitic inserter.</td></tr>
<tr><th>Infects</th><td>Microsoft .NET files.</td></tr>
<tr><th>Payload</th><td>None.</td></tr>
<tr><th>Removal</th><td>Delete infected files and restore them from backup.</td></tr>
</table>
 
<div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=apf17">de</a><a href="/lib/index.php?lang=en&amp;id=apf17">en</a><a href="/lib/index.php?lang=es&amp;id=apf17">es</a><a href="/lib/index.php?lang=it&amp;id=apf17">it</a><a href="/lib/index.php?lang=fr&amp;id=apf17">fr</a><a href="/lib/index.php?lang=pl&amp;id=apf17">pl</a><a href="/lib/index.php?lang=ru&amp;id=apf17">ru</a><a href="/lib/index.php?lang=ua&amp;id=apf17">ua</a></div>
</body>
</html>
