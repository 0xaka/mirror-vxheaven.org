<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Igor Daniloff 'Fighting Talk' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Igor Daniloff"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Daniloff, Igor,Fighting Talk, files, functions, command, disk, fighter, random, program, sector, file, infected, handler, flag, offset, single, fragment"/>
<meta name="Description" content="A while ago I was emailed a number of complex polymorphic viruses by a mathematics student at Moscow State University. The family was later named RDA.Fighter, after the virus writer's own phrase 'Random Decoding Algorithm'."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"69c419ffb5e9b69ab31824ff5d613ef3618a0952-1498756268-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/aid03.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Fighting Talk</h1><p><a href="/lib/?lang=en&amp;author=Daniloff%2C%20Igor">Igor Daniloff</a><br/> <em>VIRUS BULLETIN</em><br/> <em>December 1997</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/aid03.html';</script><div class="ci"><a href="/lib/?ci=aid03">1</a></div>[<a style="" href="/lib/?lang=EN&amp;index=AN#aid03">Back to index</a>] [<a href="/lib/aid03.html#disqus_thread">Comments</a>]<br/> 
<ul>
<li><a href="#p1">Initial Decryption - APE</a></li>
<li><a href="#p2">Secondary Decryption - RDA</a></li>
<li><a href="#p3">Installation</a></li>
<li><a href="#p4">Self-preservation and Stealth</a></li>
<li><a href="#p5">Infection</a></li>
</ul>
<p>A while ago I was emailed a number of complex polymorphic viruses by a mathematics student at Moscow State University. The family was later named RDA.Fighter, after the virus writer's own phrase 'Random Decoding Algorithm'. Although these viruses were zoo specimens, the 7408-byte variant has been distributed via a pirated copy of Dr. Web v2.12 on a BBS. In this way, the virus writer introduced his 'masterpiece' to the world. Leaving this point to his conscience, I will only say that the RDA.Fighters are indeed interesting to the specialists. They deploy new and unconventional techniques, showing the author's prime objective of making these viruses almost undetectable and thus incurable.</p>
<p>RDA.Fighter.5871, 5969, 7802, and 7868 are advanced, TSR, polymorphic parasites designed to infect COM and EXE files. RDA.Fighter.7408 is a multi-partite virus that infects COM and EXE files and hard disk MBRs. Along with versions 7802 and 7868, it hides the size increment of infected files. In addition to the random decoding algorithm, RDA.Fighter tends to use algorithms drawn from other viruses. For example, the polymorphic engine (APE) is taken from the Phantom1 virus, the self-restoring Hamming code from the Doodle family, and the MBR infection mechanism (for RDA.Fighter.7408) from both SVC and One_Half.</p>
<h2><a name="p1"></a>Initial Decryption - APE</h2>
<p>The outer layers of decryptors are more or less standard polymorphic decryptors, except for a few peculiarities. The decryptor is full of junk and register-twiddling commands. In most polymorphic viruses, such commands are often pure garbage - not so in this case, as the decryptor actually depends on the result of the operations.</p>
<p>The decryptor also contains lnt 21h calls to 'non-critical' functions (values returned in the AX register do not interfere with the decoding process). Functions used include AH=30h (get DOS version), AH=35h (get interrupt vector), AH=48h (allocate memory) and many others.</p>
<p>Special mention must be made of the polymorphism in the RDA.Fighter.7408, 7802, and 7868 variants, because they use up to sixteen levels of decryptors which decode each other in turn. This makes detection rather tedious and timeconsuming. Another factor which adds to the annoyance is that the decryptors are often backwards-decrypting. That is, you cannot set a breakpoint and are forced to single-step or run through the decryptor, unless you have one of the more powerful debuggers such as Soft-Ice.</p>
<h2><a name="p2"></a>Secondary Decryption - RDA</h2>
<p>The secondary decryption process is one of the most interesting features with these viruses, which I will describe in some detail. Following their initial decryption, RDA.Fighter.5871, 5969, and 7408 install their own Int 0lh handlers for single-step execution of instructions. After the virus sets the trap (trace) flag, the virus' Int 0lh handler is called for every instruction executed.</p>
<p>Then follow some nasty instructions, which will never be executed directly - in fact, they would probably cause a system lockup if they were. These instructions can be run and debugged only when the virus' Int 01h handler is active in memory. Needless to say, this makes debugging with a standard debugger difficult. It is particularly hazardous to debug RDA.Fighter.5969 and 7408 because in subsequent activities they continue switching the trap flag off and on for dynamic correction of their own CRCs.</p>
<p>These two variants also contain some code in the decryptor that overwrites two sectors - one in each of two randomly-selected cylinders of head zero. This code will be run if there is an attempt to set a breakpoint in the code - the Int 0lh lookahead will see the CCh and direct program flow to the payload. In RDA.Fighter.5871, the equivalent code is slightly different, and due to a bug it will never run when the trap flag is set.</p>
<p>When Int 01h is called (on each instruction when the trap flag is on), the virus' handler deletes the stack contents, then checks the computer type from the byte at the BIOS address FFFF:000E. If this value is FCh, the computer is an AT, and the virus takes the real time from the CMOS buffer. If not, it takes the time from the system clock via Int 21h AH=2Ch. This is the main time reference used to create a random 16-bit number for decrypting the next fragment of code. The first 'nicety' of these viruses is hidden in this decoding routine.</p>
<p>After a lot of multiplications, divisions, and subtractions of a 32-bit random number, a 16-bit random number is left in the AX register. Masking this number with 1Eh gives a random pointer into a table containing instructions to be used in the decryption. There are two tables, each containing sixteen decrypting commands, of which a few are repeated. We will call them the primary and mirror tables, and they are presented below.</p>
<table summary="tables containing decryption commands">
<tr><th>Primary table</th><th>Mirror table</th></tr>
<tr><td><pre>XOR [BX], DX
ROR [BX], CL
ROL [BX], CL
SUB [BX], DX
ADD [BX], DX
NEG [BX]
NOT [BX]
INC [BX]
DEC [BX]
ROR [BX], 1
ROL [BX], 1
XOR [BX], DX
SUB [BX], DX
ADD [BX], DX
MEG [BX]
NOT [BX]
</pre></td><td><pre>NOT [BX]
NEG [BX]
SUB [BX], DX
ADD [BX], DX
XOR [BX], DX
ROR [BX], 1
ROL [BX], 1
INC [BX]
DEC [BX]
NOT [BX]
NEG [BX]
SUB [BX], DX
ADD [BX], DX
ROR [BX], CL
ROL [BX], CL
XOR [BX], DX
</pre></td></tr></table>
<p>Decryption at this stage takes place in 16-iteration cycles. On the basis of the values stored in AX, a decrypting command is chosen from the primary table depending on the DI register contents. For example, if a bit is set at one particular bit position in AX, then the command residing in that position in the table is copied from the primary table to the decryptor. An initial constant, which in a decrypting cycle is dynamically varied according to a given law, is also copied there. This means that on each decrypt cycle AX will vary and so will the structure of the decryptor.</p>
<p>On termination of a decrypting cycle, the value of DI is set to the next command in the primary table. This operation is then carried out for all set bits in the 16-bit number. If no bit is set in any position, the decrypting cycle is skipped and the value of DI is increased to the next command. If the DI pointer overshoots the last command, its value is set to the first command in the table.</p>
<p>When this operation is completed, the virus begins to check whether all smart combinations have been deciphered, in an equally smart way. It computes the decrypted code fragment's CRC as a function of the fragment that was not encrypted. The CRC computation pattern is 'fan-shaped' from the decryption boundary and upwards, and a 48-bit number is computed downwards. CRCs are computed using all possible transfer commands ADD, XOR, etc.</p>
<p>RDA.Fighter.5969 and 7408 dynamically apply additional CRC corrections via Int 0lh. RDA.Fighter.7408 has four further forms of CRC check, which vary from copy to copy. The computed CRC is stored in the AX, BP and DX registers. BP is summed with the number stored in the virus body and corrected for finding the base point of the virus in memory. The offset of BP is compared with the value of DX. For correct decoding, the CRC storage offset must lie in the previously-encrypted fragment.</p>
<p>If the value of the CRC does not match that of DX, the decryption attempt is 'undone' using the complementary commands from the mirror table, thus reversing the procedure. This resets the incorrectly-decrypted fragment so the virus can repeat its attempt at 'correct' decryption, starting with the determination of a random number in AX using the primary table commands.</p>
<p>The last two modifications of RDA.Fighter.7802 and 7868 apply the same random decoding algorithm as before, but with vital changes. The virus writer named this improved mechanism the Random Decoding Algorithm Engine (RDAE). After a maximum of sixteen APE-generators, these viruses have a polymorphic random decoding mechanism. In other words, the commands that implement random decoding alternate with garbage commands which in no way affect the decoding process. All jumps, references, and offsets used in RDA decoding are corrected by the virus while this code is being generated. The primary table and its corresponding mirror table will be different in files infected by the 7802 and 7868 variants.</p>
<p>Detection of RDA.Fighter.7802 and 7868 is indeed a Herculean task. It is even more difficult to cure infected files, because full and correct decoding with a random key depends on the code implementation of the actual RDA decryptor created for that infection.</p>
<p>These viruses deciphered their own code within seven seconds on a test 386DX-33 MHz machine using 'RandomDecodingAlgoritm' (note the author's type). Surprisingly, on a Pentium 100 MHz machine, the tests took longer. I found the main determinant of decryption speed was not the random sequence of base values used in the encryptor, but a pseudo-random factor more dependent on processor speed (where randomness decreases as speed increases). I have RDA.Fighter replicants that refuse to decipher themselves on some processor types. My company's scanner, Dr. Web, does not use the system clock for determining random base values and thus deciphers the RDA viruses in 40-400 test cycles.</p>
<h2><a name="p3"></a>Installation</h2>
<p>Once fully decrypted, the virus checks the word at 0000:00C5h (the Int 31h handler address in the Interrupt Table). If it contains the characters 'SF', and the byte at 0000:00C7h corresponds with the virus' version number (10h for RDA.Fighter.5871, 0Bh for 5969, 14h for 7408, 1Fh for 7802, and 20h for 7868), the virus assumes that it is already resident, and hands control to the host application.</p>
<p>If not, the virus traces Int 13h to its original handler. The Int 21h handler is found by searching the DOS segment for 9090E8h (NOP; NOP; CALL) or FA80FC6Ch (CLI, CMP AH, 6Ch) - code commonly found at the start of Int 21h.</p>
<p>When the virus finds the Int 13h original handler, it reads the second sector of the first hard disk into memory, writes the word 'SF' at the buffer start, and writes this buffer back to the second sector via the original Int 13h. Finally, this sector is again read via Int 13h, compared with what should have been written, the original is restored and the sector written back to the disk in its original form. If the comparison reveals a mismatch, the virus assumes that the disk is cached and does not intercept Int 13h during infection.</p>
<p>To go resident, the virus reduces the memory allotted to the infected program (Int 21h AH=4Ah), intercepts Int 21h, starts the infected program (Int 21h AX=4B00h), and removes itself from memory (Int 21h AH=49h). It gets the return code (Int 21h AH=4Dh), fetches the memory block it had taken from DOS, and completes the process (Int 21h AX=4C00) by installing its resident copy in memory.</p>
<h2><a name="p4"></a>Self-preservation and Stealth</h2>
<p>The resident copy applies a powerful, noise-proof algorithm (Hamming code) for restoring its code, making debug breakpoints useless. Furthermore, as a 'trick' to mislead the researcher, the virus introduces an instruction for exiting from interrupt (IRET) in its Int 21h handlers. However, RDA.Fighter corrects the handler using its noise-proof restoration algorithm. In testing, the virus restored sixteen and more sequentially changed bytes in the virus body!</p>
<p>RDA.Fighter.7408, 7802, and 7868 control the find file functions (Int 21h AH=11h, 12h, 4Eh, 4Fh) to hide the size increment of infected files.</p>
<h2><a name="p5"></a>Infection</h2>
<p>The resident part of the virus controls the DOS File Open (AH=3Dh) and Load/Execute program (AX=4B00h) functions. RDA.Fighter.5969 controls the file rename function (AH=5611) as well. When these functions are called, RDA.Fighter tries to infect the files indicated by these functions.</p>
<p>RDA.Fighter infects COM and EXE files 014096 bytes or larger, but avoids files matching *ES?.* (AIDSTEST.EXE). *WE?.* (WEB.EXE), or *AN?.* (COMMAND.COM). Files with the system attribute are not infected, and a prospect's file format is checked by the file extension and the 'MZ' signature of EXE files. While infecting flies, the virus determines the drive letter from the filename (Int 2Fh AX=121Ah) and the free space on the disk (Int 21h AH=36h). The virus uses the seconds value in the host's time-stamp as an infection flag (RDA.Fighter.5871 - 32 seconds; 5969 - 22; 7408 - 40; and 5969 and 7868 - 2).</p>
<p>During infection, the virus installs its own Critical Error handler (Int 24h), and Disk I/O handler (Int 13h). If there is no disk cache program, it also installs handlers for Int 0lh (single step execution of commands), Int 03h (breakpoint) and Int 2Ah (Microsoft Network) - these handlers are all a single IRET (Return from Interrupt).</p>
<p>Initially, the virus code occupies about 600 bytes. In infected files, along with the garbage commands, it takes up about 1500 to 4000 bytes.</p>
<p>It should also be noted that the virus encrypts a piece of the host program at a random offset. When loading an infected program, the virus decodes and restores this encrypted fragment. The offset and code fragment to encrypt is randomly chosen, in much the same way as it determines the random AX in the decryptor. This procedure was probably designed to prevent anti-virus tools employing generic disinfection methods (AdinfExt, TbClean and others) from restoring infected files.</p>
<p>RDA.Fighter.7408 also infects the MBR of hard disks. Its infection algorithm closely resembles that of the viruses SVC.4641, 4644, and 4677. RDA.Fighter.7408 replaces the first three bytes of the boot-loader in the MBR with JUMP NEAR PTR and writes 33h virus bytes in the zero-byte region. The 'tail' of the virus is written in fifteen sectors, beginning from the second sector of track zero, head zero.</p>
<p>The different variants contain various internal texts, and the following are occasionally displayed:</p>
<pre>
    <em>RDA.Fighter.7408:</em>
    Stealth Fighter 2.0 : New Aggression.

    <em>RDA.Fighter.7802:</em>
    Stealth Fighter DEMO Part (3.1): Enemy Unknown.

    <em>RDA.Fighter.7868:</em>
    Stealth,Fighter DEMO Part (3.2); Next mutation 06/09/95.
</pre>
<p>Analysing RDA.Fighter was quite a challenge, but I succeeded in adding full detection and disinfection to Dr. Web.</p>
<h3>RDA.Fighter</h3>
<table border="1" cellspacing="0" cellpadding="0" summary="RDA.Fighter summary">
<tr><th>Aliases</th><td>APE.RDA</td></tr>
<tr><th>Variants</th><td>RDA.Fighter.5871, 5969, 7408, 7802 and 7868</td></tr>
<tr><th>Type</th><td>Memory resident, polymorphic file infector. RDA.Flghter.7408 is multi-partite.</td></tr>
<tr><th>Infection</th><td>COM and EXE files. RDA.Fighter.7408 MBR also.</td></tr>
<tr><th>Self-recognition in Files</th><td>Seconds field of file time-stamp. See text for details.</td></tr>
<tr><th>Self-recognition in Memory</th><td>The string 'SF' at address 0000:00C5.</td></tr>
<tr><th>Hex Pattern in Files</th><td>None possible.</td></tr>
<tr><th>Hex Pattern in Memory</th><td><pre>RDA.Fighter.5871:
50FE C43D 004C 740B 80FC 3E74
0658 2EFF 2EEF 17E8 E50F 2EC7

RDA.Fighter.5969:
50FE C43D 004C 7410 80FC 3E74
0B80 FC57 7406 582E FF2E 5118

RDA.Flghter.7408:
50FE C43D EEEF 7505 EBDE 0158
CF3D 004C 745B 80FC 3E74 5680

RDA.Fighter.7802:
50FE C43D EEEF 7505 E88B 0158
CF3D 004C 745B 80FC 3E74 5680

RDA.Fighter.7868:
50FE C43D EEEF 7505 E88E 0158
CF3D 004C 745B 80FC 3E74 5680</pre></td></tr>
<tr><th>Intercepts</th><td>lnt 21h for infection.</td></tr>
<tr><th>Payload</th><td>Displays messages (see text for details).</td></tr>
<tr><th>Removal</th><td>Using a clean system, identify and restore infected files.</td></tr>
</table>
[<a style="" href="/lib/?lang=EN&amp;index=AN#aid03">Back to index</a>] [<a href="/lib/aid03.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=aid03">de</a><a href="/lib/index.php?lang=en&amp;id=aid03">en</a><a href="/lib/index.php?lang=es&amp;id=aid03">es</a><a href="/lib/index.php?lang=it&amp;id=aid03">it</a><a href="/lib/index.php?lang=fr&amp;id=aid03">fr</a><a href="/lib/index.php?lang=pl&amp;id=aid03">pl</a><a href="/lib/index.php?lang=ru&amp;id=aid03">ru</a><a href="/lib/index.php?lang=ua&amp;id=aid03">ua</a></div>
</body>
</html>
