<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title> mdew 'Writing disassembler' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="mdew"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, mdew,Writing disassembler, opcode, prefixes, engine, operands, byte, nbsp, instr, size, pointer, bits, dasm, idata, prefix, files, label"/>
<meta name="Description" content="Disassembler engine it's some procedure that take some pointer to assembled code (for example it takes it from some exe file from .text (.code) section. Then it disassembles it to some user-friendly structures. Normally assembled instructions have different length and it's hard (or impossible) to manipulate them without disassembling."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"87105f07debbfc81a30af6264e46c8fe0a48ecbd-1498757625-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vmd05.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Writing disassembler</h1><p><a href="/lib/?lang=en&amp;author=mdew"> mdew</a><br/> <em>October 2009</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vmd05.html';</script><img src="/img/pdf.gif" alt="PDF"/><a href="/lib/pdf/Writing%20disassembler.pdf">Download</a> PDF (27.01Kb) (You need to be registered on <a href="/forum">forum</a>)<br/>[<a style="" href="/lib/?lang=EN&amp;index=VT#vmd05">Back to index</a>] [<a href="/lib/vmd05.html#disqus_thread">Comments</a>]<br/> 
<ul>
<li><a href="#p00">0.0 Introdution</a>
<ul>
<li><a href="#p01">0.1 What?</a></li>
<li><a href="#p02">0.2 Why?</a></li>
<li><a href="#p03">0.3 And how?</a></li>
</ul></li>
<li><a href="#p10">1.0 Planning the engine</a></li>
<li><a href="#p20">2.0 Structure of instruction</a>
<ul>
<li><a href="#p21">2.1 Opcodes</a></li>
<li><a href="#p22">2.2 Operands</a></li>
<li><a href="#p23">2.3 Prefixes</a></li>
<li><a href="#p24">2.4 Instruction data</a>
<ul>
<li><a href="#p241">2.4.1 Memory address structure</a></li>
</ul></li>
<li><a href="#p25">2.5 Pointer to code</a></li>
<li><a href="#p26">2.6 "Label mark"</a></li>
</ul></li>
<li><a href="#p30">3.0 Files organization</a></li>
<li><a href="#p40">4.0 What in next part?</a></li>
</ul>
<h2><a name="p00"></a>0.0 Introdution</h2>
<h3><a name="p01"></a>0.1 What?</h3>
<p>Disassembler engine it's some procedure that take some pointer to assembled code (for example it takes it from some exe file from .text (.code) section. Then it disassembles it to some user-friendly structures. Normally assembled instructions have different length and it's hard (or impossible) to manipulate them without disassembling.</p>
<h3><a name="p02"></a>0.2 Why?</h3>
<p>Disassembling is used for poli/meta-morphic viruses. For example metamorphic virus will disassemble his own body (even disassembler procedure) then shrink/change/expand instructions using disassembled structures and then it will reassemble it again and ofcourse put it to some exe it wants to infect :).</p>
<h3><a name="p03"></a>0.3 And how?</h3>
<p>I will write the engine in assembler - because we probably want to use it in some viri stuff :). I use masm - many people say that masm is crap and they use nasm. I realy don't know which assembler is better. I started to learn assembler with masm and I realy like it as it has very powerful macro engine (which we will use writing our engine). Nasm have macro support too - I even tried nasm few times but, well, I prefer masm.</p>
<h2><a name="p10"></a>1.0 Overview of disassembler engine</h2>
<p>I don't know how to write a good disassembler (dasm) engine yet :). But I have few sources and few ideas (more sources than ideas :) and I will try. The most important part of making such engine is planing - without planing we won't finish anything! So first few chapters of this "tutorial" will focus just on theoretical aspects of our dasm structure.</p>
<p>First of all we have to plan how we will store instructions disassembled by our engine - we need some structure which will be capable to hold any instruction we want. It must be also very comfortable to manipulate it. When we will make it, it will define our own pseudo-assembler language. So lets begin and jump to next chapter.</p>
<h2><a name="p20"></a>2.0 Structure of instruction</h2>
<p>Okay, we need instruction structure - lets create it in "_instr.inc". Here is body of our instruction (empty now):</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">; _instr.inc</span><br/>
_instr struct<br/>
<span style="color: #339933;">...</span><br/>
_instr ends<br/>
&nbsp;</div>
<p>Most important field in our structure will be opcode field. It will define the instruction that our structure holds. Let it be one byte - it will allow us to hold there 2^8 = 256 different values (instructions). It should be enough as we don't need every instruction in processor to be recognizable by our dasm engine (for example we don't need FPU or MMX instructions, probably only the basic ones). Now our structure will look like this:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">; _instr.inc</span><br/>
_instr struct<br/>
&nbsp; &nbsp; &nbsp; &nbsp; opcode <span style="color: #0000ff; font-weight: bold;">byte</span> ?<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">...</span><br/>
_instr ends<br/>
&nbsp;</div>
<h3><a name="p21"></a>2.1 Opcodes</h3>
<p>Now we have to define some opcodes that our engine will use - lets create file "opcodes.inc" (writing code in separate files will allow us to manage project easier). We can decide for each instruction what number (from 0 to 255) it will have. But at first lets construct some list of x86 instructions that we want to have in engine:</p>
<table summary="instructions">
<tr><th>name</th><th>operand1</th><th>operand2</th></tr>
<tr><th colspan="3">arithmetic instructions</th></tr>
<tr><td>add ; add</td><td>mem/reg</td><td>mem/reg/imm</td></tr>
<tr><td>sub ; sub</td><td>mem/reg</td><td>mem/reg/imm</td></tr>
<tr><td>inc ; inc</td><td>mem/reg</td><td>&nbsp;</td></tr>
<tr><td>dec ; dec</td><td>mem/reg</td><td>&nbsp;</td></tr>
<tr><td>neg ; neg</td><td>mem/reg</td><td>&nbsp;</td></tr>
<tr><td>mul ; mul</td><td>mem/reg</td><td>eax/edx</td></tr>
<tr><td>div ; div</td><td>mem/reg</td><td>eax/edx</td></tr>
<tr><th colspan="3">logic instructions</th></tr>
<tr><td>or ; or </td><td>mem/reg</td><td>mem/reg/imm</td></tr>
<tr><td>and ; and</td><td>mem/reg</td><td>mem/reg/imm</td></tr>
<tr><td>xor ; and</td><td>mem/reg</td><td>mem/reg/imm</td></tr>
<tr><td>not ; not</td><td>mem/reg</td><td>&nbsp;</td></tr>
<tr><th colspan="3">shift instructions</th></tr>
<tr><td>shl ; shl</td><td>mem/reg</td><td>imm/cl</td></tr>
<tr><td>shr ; shr</td><td>mem/reg</td><td>imm/cl</td></tr>
<tr><td>sal ; sal</td><td>mem/reg</td><td>imm/cl</td></tr>
<tr><td>sar ; sar</td><td>mem/reg</td><td>imm/cl</td></tr>
<tr><th colspan="3">rotation instructions</th></tr>
<tr><td>rol ; rol</td><td>mem/reg</td><td>imm/cl</td></tr>
<tr><td>ror ; ror</td><td>mem/reg</td><td>imm/cl</td></tr>
<tr><td>rcl ; rcl</td><td>mem/reg</td><td>imm/cl</td></tr>
<tr><td>rcr ; rcr</td><td>mem/reg</td><td>imm/cl</td></tr>
<tr><th colspan="3">data transfer instructions</th></tr>
<tr><td>mov ; mov</td><td>mem/reg</td><td>mem/reg/imm</td></tr>
<tr><td>xchg ; xchg</td><td>mem/reg</td><td>mem/reg</td></tr>
<tr><td>push ; push</td><td>mem/reg/imm</td><td>&nbsp;</td></tr>
<tr><td>pop ; pop</td><td>mem/reg</td><td>&nbsp;</td></tr>
<tr><td>pusha; pusha</td><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td>popa ; popa</td><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td>pushad;pushad</td><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td>popad; popad</td><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td>pushf; pushf</td><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td>pushfd;pushfd</td><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td>popf ; popf</td><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td>popfd; popfd</td><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td>stc ; stc</td><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td>clc ; stc</td><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td>cmc ; stc</td><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td>std ; stc</td><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td>cld ; stc</td><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td>sti ; stc</td><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td>cli ; stc</td><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td>cbw ; stc</td><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td>cwd ; stc</td><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td>cwde ; stc</td><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><th colspan="3">other instructions</th></tr>
<tr><td>lea ; lea</td><td>reg</td><td>mem</td></tr>
<tr><td>nop ; nop</td><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><th colspan="3">program control instructions</th></tr>
<tr><td>jxx ; jxx</td><td>mem/reg/imm</td><td>&nbsp;</td></tr>
<tr><td>jmp ; jmp</td><td>mem/reg/imm</td><td>&nbsp;</td></tr>
<tr><td>enter; enter</td><td>imm</td><td>imm</td></tr>
<tr><td>leave;leave</td><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td>call; call</td><td>mem/reg/imm</td><td>&nbsp;</td></tr>
<tr><td>ret ; ret</td><td>imm</td><td>&nbsp;</td></tr>
<tr><td>loopxx;loopxx</td><td>imm</td><td>&nbsp;</td></tr>
<tr><th colspan="3">string instructions</th></tr>
<tr><td>cmps; cmps</td><td>esi</td><td>edi</td></tr>
<tr><td>lods; lods</td><td>esi</td><td>eax</td></tr>
<tr><td>movs; movs</td><td>esi</td><td>edi</td></tr>
<tr><td>scas; scas</td><td>edi</td><td>eax</td></tr>
<tr><td>stos; stos</td><td>edi</td><td>eax</td></tr>
<tr><th colspan="3">compare in structions</th></tr>
<tr><td>cmp ; cmp</td><td>mem/reg</td><td>mem/reg/imm</td></tr>
<tr><td>test; test</td><td>mem/reg</td><td>mem/reg/imm</td></tr>
<tr><th colspan="3">virtual instructions</th></tr>
<tr><td>movm; movm</td><td>mem</td><td>mem</td></tr>
<tr><td>apistart;</td><td>imm</td><td>&nbsp;</td></tr>
<tr><td>apiend;</td><td>imm</td><td>imm</td></tr>
</table>
<p>Okay, this table needs some explanation. It includes all instructions that we need in our engine - ofcourse we can put here any instruction but we probably won't use most of them. Virtual instructions - what is it? In assembler for example there is no instruction mov mem,mem - it's forbidden. But we have to do this very often in our program. We do this by for example push mem/pop mem or mov reg,mem/mov mem,reg and so on. But in our pseudo assembler we can hold thos instructions like one instruction movm (move mem to mem). It will help us to manipulate the code later. We will just have to expand such instruction in 2 instructions during assembly process. Instructions apistart/apiend are just prologue of the procedure (push ebp/mov ebp,esp/sub esp,imm) and epilogue (add esp,imm/pop ebp).</p>
<p>I you don't know any instructions from the table just type "intel instruction set" in google and check first few links to get instructions and descriptions of them.</p>
<p>There is something important about operands - even if operand1 can be mem and operand can be mem too - don't forget that mem,mem is forbidden!</p>
<p>Okay what about operands size? Ofcourse the register operand can be 8 or 16 or 32 bit. And immidiate value can also be 8/16/32bit. But our pseudo assembler must be as comfortable for us as possible so we will hold information about operands sizes later in the structure.</p>
<p>Now when we have list of instruction lets construct "opcodes.inc", where we will declare some opcodes constants.</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">; opcodes.inc</span><br/>
<span style="color: #339933;">.</span>const<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; arithmetic instructions</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_ADD&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">000h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_SUB&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">001h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_INC&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">002h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_DEC&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">003h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_NEG&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">004h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_MUL&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">005h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_DIV&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">006h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; logic instructions</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_OR &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">007h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_AND&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">008h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_XOR&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">009h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_NOT&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">00ah</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; shift instructions</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_SHL&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">00bh</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_SHR&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">00ch</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_SAL&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">00dh</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_SAR&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">00eh</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; rotation instructions</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_ROL&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">00fh</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_ROR&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">010h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_RCL&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">011h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_RCR&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">012h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; data transfer instructions</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_MOV&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">013h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_XCHG &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">014h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_PUSH &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">015h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_POP&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">016h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_PUSHA&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">017h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_POPA &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">018h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_PUSHAD &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">019h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_POPAD&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">01ah</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_PUSHF&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">01bh</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_PUSHFD &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">01ch</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_POPF &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">01dh</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_POPFD&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">01eh</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_STC&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">01fh</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_CLC&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">020h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_CMC&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">021h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_STD&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">022h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_CLD&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">023h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_STI&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">024h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_CLI&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">025h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_CBW&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">026h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_CWD&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">027h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_CWDE &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">028h</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; other instructions</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_LEA&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">02ah</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_NOP&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">090h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; program control instructions</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_JXX&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">02ch</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_JMP&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">02dh</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_ENTER&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">02eh</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_LEAVE&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">02fh</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_CALL &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">030h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_RET&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">031h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_LOOPXX &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">032h</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; string instructions</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_CMPS &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">033h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_LODS &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">034h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_MOVS &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">035h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_SCAS &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">036h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_STOS &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">037h</span><br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; compare in structions</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_CMP&nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">03eh</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_TEST &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">03fh</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; virtual instructions</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_MOVM &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">040h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_APISTART <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">041h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPCODE_APIEND &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">042h</span><br/>
&nbsp;</div>
<h2><a name="p22"></a>2.2 Operands</h2>
<p>Now we need some variable in our _instr structure that will represent operands used by the instruction which is definied by the opcode field. First lets see what we will add in file "_instr.inc":</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">; _instr.inc</span><br/>
<br/>
include opcodes<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span><br/>
include operands<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span><br/>
<br/>
_instr struct<br/>
&nbsp; &nbsp; &nbsp; &nbsp; opcode&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">byte</span> ?<br/>
&nbsp; &nbsp; &nbsp; &nbsp; operands&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">byte</span> ?<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">...</span><br/>
_instr ends<br/>
&nbsp;</div>
<p>All we need is file operands.inc. But what types do we have in assembler? There are 3 types of operands: reg (register), mem (memory address), imm (immediate value - const number). Each isntruction can have 0,1 or 2 operands (well in fact there are instructions that take 3 arguments but we don't need them). So:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">; _operands.inc</span><br/>
<br/>
<span style="color: #339933;">.</span>const<br/>
<br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPERANDS_NONE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">000h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPERANDS_REG&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">001h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPERANDS_MEM&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">002h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPERANDS_IMM&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">003h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPERANDS_REG_REG&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">004h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPERANDS_REG_MEM&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">005h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPERANDS_REG_IMM&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">006h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPERANDS_MEM_MEM&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">007h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPERANDS_MEM_REG&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">008h</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; OPERANDS_MEM_IMM&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">009h</span><br/>
&nbsp;</div>
<h3><a name="p23"></a>2.3 Prefixes</h3>
<p>Prefixes are some bytes that we can put in front of instruction. Instruction may have 0,1 or more prefixes. Not evry instruction can have specific prefix. There are few groups of prefixes:</p>
<table summary="instruction prefixes">
<tr><th colspan="2">Lock and repeat prefixes (3 values):</th></tr>
<tr><td>LOCK</td><td>0f0h</td></tr>
<tr><td>REPNE/REPNZ</td><td>0f2h</td></tr>
<tr><td>REP</td><td>0f3h</td></tr>
<tr><td>REPE/REPZ</td><td>0f3h (same as REP)</td></tr>
<tr><td>SIMD</td><td>0f3h (same as REP)</td></tr>
<tr><th colspan="2">Segment override prefixes (6 values):</th></tr>
<tr><td>CS</td><td>02eh</td></tr>
<tr><td>SS</td><td>036h</td></tr>
<tr><td>DS</td><td>03eh</td></tr>
<tr><td>ES</td><td>026h</td></tr>
<tr><td>FS</td><td>064h</td></tr>
<tr><td>GS</td><td>065h</td></tr>
<tr><th colspan="2">Operand-size override prefix (1 value):</th></tr>
<tr><td>OP_SIZE</td><td>066h</td></tr>
<tr><th colspan="2">Address-size override prefix (1 value):</th></tr>
<tr><td>ADDR_SIZE</td><td>067h</td></tr>
</table>
<p>Each instruction can have only 1 prefix from each group - so one instruction can have up to 4 prefixes (we have 4 groups). There are few prefixes we wont use - SIMD and LOCK - we just don't need them. We will store all prefix data in one byte called prefixes:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">; _instr.inc</span><br/>
<br/>
include opcodes<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span><br/>
include operands<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span><br/>
include prefixes<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span><br/>
<br/>
_instr struct<br/>
&nbsp; &nbsp; &nbsp; &nbsp; opcode&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">byte</span> ?<br/>
&nbsp; &nbsp; &nbsp; &nbsp; operands&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">byte</span> ?<br/>
&nbsp; &nbsp; &nbsp; &nbsp; prefixes&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">byte</span> ?<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">...</span><br/>
_instr ends<br/>
&nbsp;</div>
<p>We have one byte so 8 bits to store those values. Lets do like that:</p>
<pre class="source">
[7] [6] [5] [4] [3] [2] [1] [0]
      \  |  / | | | |_ operand size (bit 0)
       \ | /  | | |_ address size (bit 1)
        \|/   | |_ REPNE/REPNZ (bit 2)
         |    |_ REP/REPE/REPZ (bit 3)
         |_ segment override (bit 4,5,6)
</pre>
<p>7th bit stays unused for now maybe we will use it later for some extra data. Okay lets look into "prefixes.inc":</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">; prefixes.inc</span><br/>
<br/>
<span style="color: #339933;">.</span>const<br/>
<br/>
<span style="color: black; font-style: italic;">; bit patterns</span><br/>
PREFIX_OP_SIZE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">01h</span> <span style="color: black; font-style: italic;">; bit 0</span><br/>
PREFIX_ADDR_SIZE&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">02h</span> <span style="color: black; font-style: italic;">; bit 1</span><br/>
PREFIX_REPNE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">04h</span> <span style="color: black; font-style: italic;">; bit 2</span><br/>
PREFIX_REPNZ&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> PREFIX_REPNE<br/>
PREFIX_REPE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">08h</span> <span style="color: black; font-style: italic;">; bit 3</span><br/>
PREFIX_REP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> PREFIX_REPE<br/>
PREFIX_REPZ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> PREFIX_REPE<br/>
PREFIX_SEG_NONE &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">0</span> <span style="color: #ff0000;">000</span> <span style="color: #ff0000;">0000b</span><br/>
PREFIX_CS &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">0</span> <span style="color: #ff0000;">001</span> <span style="color: #ff0000;">0000b</span><br/>
PREFIX_SS &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">0</span> <span style="color: #ff0000;">010</span> <span style="color: #ff0000;">0000b</span><br/>
PREFIX_DS &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">0</span> <span style="color: #ff0000;">011</span> <span style="color: #ff0000;">0000b</span><br/>
PREFIX_ES &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">0</span> <span style="color: #ff0000;">100</span> <span style="color: #ff0000;">0000b</span><br/>
PREFIX_FS &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">0</span> <span style="color: #ff0000;">101</span> <span style="color: #ff0000;">0000b</span><br/>
PREFIX_GS &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">0</span> <span style="color: #ff0000;">110</span> <span style="color: #ff0000;">0000b</span><br/>
<br/>
<span style="color: black; font-style: italic;">; bit indexes (only for 1 bit prefixes)</span><br/>
BI_OP_SIZE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">00h</span><br/>
BI_ADDR_SIZE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">01h</span><br/>
BI_REPNE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">02h</span><br/>
BI_REPNZ&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> BI_REPNE<br/>
BI_REPE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">03h</span><br/>
BI_REP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> BI_REPE<br/>
BI_REPZ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> BI_REPE<br/>
<br/>
<span style="color: black; font-style: italic;">; prefix real opcodes</span><br/>
OPCODE_OP_SIZE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">066h</span><br/>
OPCODE_ADDR_SIZE&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">067h</span><br/>
OPCODE_REPNE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">0f2h</span><br/>
OPCODE_REPNZ&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> OPCODE_REPNE<br/>
OPCODE_REPE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">0f3h</span><br/>
OPCODE_REP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> OPCODE_REPE<br/>
OPCODE_REPZ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> OPCODE_REPE<br/>
OPCODE_CS &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">02eh</span><br/>
OPCODE_SS &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">036h</span><br/>
OPCODE_DS &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">03eh</span><br/>
OPCODE_ES &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">026h</span><br/>
OPCODE_FS &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">064h</span><br/>
OPCODE_GS &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">065h</span><br/>
&nbsp;</div>
<h3><a name="p24"></a>2.4 Instruction data</h3>
<p>Now as we have defined our instruction by its opcode, operands and prefixes, we have to create some structure which will hold data for instruction - for example which register it uses, memory address, any immediate data and so on. The use of this structure will depend on which instruction it is and what operands it uses and what prefixes it has (operand and address prefixes especially). Lets look on this structure ("_idata.inc"):</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">; _idata.inc</span><br/>
<br/>
include registers<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span><br/>
include _mem<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span><br/>
<br/>
_idata struct<br/>
&nbsp; &nbsp; &nbsp; &nbsp; union<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; reg1&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">byte</span> ?<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; union<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; imm1_8&nbsp; <span style="color: #0000ff; font-weight: bold;">byte</span>&nbsp; &nbsp; ?<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; imm1_16 <span style="color: #0000ff; font-weight: bold;">word</span>&nbsp; &nbsp; ?<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; imm1_32 <span style="color: #0000ff; font-weight: bold;">dword</span> &nbsp; ?<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ends<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mem1 _mem &amp;lt<span style="color: black; font-style: italic;">;&amp;gt;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; ends<br/>
&nbsp; &nbsp; &nbsp; &nbsp; union<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; reg2&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">byte</span> ?<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; union<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; imm2_8&nbsp; <span style="color: #0000ff; font-weight: bold;">byte</span>&nbsp; &nbsp; ?<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; imm2_16 <span style="color: #0000ff; font-weight: bold;">word</span>&nbsp; &nbsp; ?<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; imm2_32 <span style="color: #0000ff; font-weight: bold;">dword</span> &nbsp; ?<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ends<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mem2 _mem &amp;lt<span style="color: black; font-style: italic;">;&amp;gt;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; ends<br/>
ends<br/>
&nbsp;</div>
<p>Okay, we have 2 unions inside - we can use each union as register/immediate/memory. It allow us to construct any option from our defined OPERANDS_XXX constants. The reg1 and reg2 fields will be used ofcourse to encode registers. We need some constants ("registers.inc"):</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">; registers.inc</span><br/>
<br/>
<span style="color: #339933;">.</span>const<br/>
<br/>
REG_EAX <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">00h</span><br/>
REG_EBX <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">03h</span><br/>
REG_ECX <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">01h</span><br/>
REG_EDX <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">02h</span><br/>
REG_ESI <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">06h</span><br/>
REG_EDI <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">07h</span><br/>
REG_EBP <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">05h</span><br/>
REG_ESP <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">04h</span><br/>
&nbsp;</div>
<h4><a name="p241"></a>2.4.1 Memory address structure</h4>
<p>We have few addressing modes on x86 processors. For example we have direct address [0x00112233] or by register [eax] and so on. The most complex will be addressing mode like this [reg1 + reg2 * multiply + displacement] (we will focus on specific addressing modes in later chapters). Multiply can be 1/2/4/8. It's 4 values so we need only 2 bits to encode it. Then we have displacement - it can be 1/2/4 byte long so we need 4 bytes to handle this. So our _mem struct will be like this ("_mem.inc"):</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">; _mem.inc</span><br/>
<br/>
include registers<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span><br/>
<br/>
<span style="color: #339933;">.</span>const<br/>
<span style="color: black; font-style: italic;">; multiplication values</span><br/>
MULTI_1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">00</span> <span style="color: #ff0000;">000000b</span><br/>
MULTI_2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">01</span> <span style="color: #ff0000;">000000b</span><br/>
MULTI_4 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">10</span> <span style="color: #ff0000;">000000b</span><br/>
MULTI_8 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">11</span> <span style="color: #ff0000;">000000b</span><br/>
MULTI_BITMASK &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">11</span> <span style="color: #ff0000;">000000b</span><br/>
<br/>
<span style="color: black; font-style: italic;">; addressing modes</span><br/>
MODE_DISP &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">100</span> <span style="color: #ff0000;">00000b</span><br/>
MODE_REG&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">011</span> <span style="color: #ff0000;">00000b</span><br/>
MODE_REG_REG&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">010</span> <span style="color: #ff0000;">00000b</span><br/>
MODE_REG_DISP &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">001</span> <span style="color: #ff0000;">00000b</span><br/>
MODE_REG_REG_DISP &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">000</span> <span style="color: #ff0000;">00000b</span><br/>
MODE_BITMASK&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">equ</span> <span style="color: #ff0000;">111</span> <span style="color: #ff0000;">00000b</span><br/>
<br/>
_mem struct<br/>
&nbsp; &nbsp; &nbsp; &nbsp; memreg1 <span style="color: #0000ff; font-weight: bold;">byte</span> ? <span style="color: black; font-style: italic;">; bits 5/6/7 = mode</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; memreg2 <span style="color: #0000ff; font-weight: bold;">byte</span> ? <span style="color: black; font-style: italic;">; bits 6/7 = multiplicator</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; union<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; disp8 &nbsp; <span style="color: #0000ff; font-weight: bold;">byte</span>&nbsp; &nbsp; ?<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; disp16&nbsp; <span style="color: #0000ff; font-weight: bold;">word</span>&nbsp; &nbsp; ?<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; disp32&nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> &nbsp; ?<br/>
&nbsp; &nbsp; &nbsp; &nbsp; ends<br/>
_mem ends<br/>
&nbsp;</div>
<p>So in memreg1 byte, bits number 0/1/2 contain info about register and bits 5/6/7 about the addressing mode.</p>
<p>In memreg2 byte bits 0/1/2 encode the second register and bits 6/7 define multiplicator. Disp is just displacement which can be 1/2/4 byte long.</p>
<h3><a name="p25"></a>2.5 Pointer to code</h3>
<p>The next member of _instr structure will be the pointer to the code - it will just point to the real code that we are disassembling - it is very important but I will explain it later.</p>
<p>So this pointer will be just a dword and we will call it "pointer" - look into 2.6 for the whole _instr structure definition.</p>
<h3><a name="p26"></a>2.6 "Label mark"</h3>
<p>Label mark is very handy thing which was "invented" by Mental Driller (I think so) in his metamorphic virus called "metamorpho" :). It's not really neccessery during disassembling but it will be important during morphing of the code. Label mark it's just a byte that can be 0 or 1. It's 1 if any jump/call point to this instruction (instruction has a label on it) or 0 if not. The whole _instr structure now looks:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">; _instr.inc</span><br/>
<br/>
include opcodes<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span><br/>
include operands<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span><br/>
include prefixes<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span><br/>
include _idata<span style="color: #339933;">.</span><span style="color: #00007f; font-weight: bold;">inc</span><br/>
<br/>
_instr struct<br/>
&nbsp; &nbsp; &nbsp; &nbsp; opcode&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">byte</span>&nbsp; &nbsp; ?<br/>
&nbsp; &nbsp; &nbsp; &nbsp; operands &nbsp; &nbsp; &nbsp; &nbsp;<span style="color: #0000ff; font-weight: bold;">byte</span>&nbsp; &nbsp; ?<br/>
&nbsp; &nbsp; &nbsp; &nbsp; prefixes&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">byte</span>&nbsp; &nbsp; ?<br/>
&nbsp; &nbsp; &nbsp; &nbsp; _idata&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; idata &amp;lt<span style="color: black; font-style: italic;">;&amp;gt;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; pointer &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> &nbsp; ?<br/>
&nbsp; &nbsp; &nbsp; &nbsp; labelmark &nbsp; &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">byte</span>&nbsp; &nbsp; ?<br/>
_instr ends<br/>
&nbsp;</div>
<h2><a name="p30"></a>3.0 Files organization</h2>
<p>Okay we created some files - now lets make a clear view of how we set up directories for our engine. First of all we need some root directory - lets call it "dasm_engine". Inside we should have 2 folders "source" and "include" or "src" and "inc" as you wish (I choose src/inc). We will put all *.inc files into the "inc" directory and all *.asm files into "src" directory. So till now we have:</p>
<ul>
<li>dasm_engine
<ul>
<li>src</li>
<li>inc
<ul>
<li>_instr.inc</li>
<li>opcodes.inc</li>
<li>operands.inc</li>
<li>prefixes.inc</li>
<li>registers.inc</li>
<li>_mem.inc</li>
<li>_idata.inc</li>
</ul></li>
</ul></li>
</ul>
<p>U can download those files from the link: <a href="files/vmd/dasm_engine.rar">dasm engine</a></p>
<h2><a name="p40"></a>4.0 What in next part?</h2>
<p>In next part we will discuss about the whole engine routine - how it will work, what parameters it will take and so on. Then we will write few (or many :) useful macros. And we will start to write the disassembling procedure :). If you have any questions or remarks or anything else just email me: <a class="__cf_email__" href="/cdn-cgi/l/email-protection" data-cfemail="fe9f929b95d09c9f8c8d849d849b898d9597be99939f9792d09d9193d0">[email&#160;protected]</a><script data-cfhash='f9e31' type="text/rocketscript">/* <![CDATA[ */!function(t,e,r,n,c,a,p){try{t=document.currentScript||function(){for(t=document.getElementsByTagName('script'),e=t.length;e--;)if(t[e].getAttribute('data-cfhash'))return t[e]}();if(t&&(c=t.previousSibling)){p=t.parentNode;if(a=c.getAttribute('data-cfemail')){for(e='',r='0x'+a.substr(0,2)|0,n=2;a.length-n;n+=2)e+='%'+('0'+('0x'+a.substr(n,2)^r).toString(16)).slice(-2);p.replaceChild(document.createTextNode(decodeURIComponent(e)),c)}p.removeChild(t)}}catch(u){}}()/* ]]> */</script></p>
[<a style="" href="/lib/?lang=EN&amp;index=VT#vmd05">Back to index</a>] [<a href="/lib/vmd05.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vmd05">de</a><a href="/lib/index.php?lang=en&amp;id=vmd05">en</a><a href="/lib/index.php?lang=es&amp;id=vmd05">es</a><a href="/lib/index.php?lang=it&amp;id=vmd05">it</a><a href="/lib/index.php?lang=fr&amp;id=vmd05">fr</a><a href="/lib/index.php?lang=pl&amp;id=vmd05">pl</a><a href="/lib/index.php?lang=ru&amp;id=vmd05">ru</a><a href="/lib/index.php?lang=ua&amp;id=vmd05">ua</a></div>
</body>
</html>
