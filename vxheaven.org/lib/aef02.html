<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Eric Filiol 'Strong Cryptography Armoured Computer Viruses Forbidding Code Analysis: the BRADLEY virus' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Eric Filiol"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Filiol, Eric,Strong Cryptography Armoured Computer Viruses Forbidding Code Analysis: the BRADLEY virus, malware, mbox, mathcal, security, obfuscation, attacker, program, denoted, cryptovirology, oplus, analysis, data, encryption, codes, cryptology"/>
<meta name="Description" content="Imagining what the nature of future viral attacks might look like is the key to successfully protecting against them. This paper discusses how cryptography and key management techniques may definitively checkmate antiviral analysis and mechanisms. We present a generic virus, denoted BRADLEY which protects its code with a very secure, ultra-fast symmetric encryption. Since the main drawback of using encryption in that case lies on the existence of the secret key or information about it within the viral code, we show how to bypass this limitation by using suitable key management techniques. Finally, we show that the complexity of the BRADLEY code analysis is at least as high as that of the cryptanalysis of its underlying encryption algorithm."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"1c70b634f32046211af35a37ce887430451504fe-1498757208-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/aef02.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Strong Cryptography Armoured Computer Viruses Forbidding Code Analysis: the BRADLEY virus</h1><p><a href="/lib/?lang=en&amp;author=Filiol%2C%20Eric">Eric Filiol</a><br/> <em>INSTITUT NATIONAL DE RECHERCHE EN INFORMATIQUE ET EN AUTOMATIQUE</em><br/> <em>ISSN 0249-6399</em><br/> <em>June 2004</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/aef02.html';</script><div class="ci"><a href="/lib/?ci=aef02">3</a></div>[<a style="" href="/lib/?lang=EN&amp;index=CR#aef02">Back to index</a>] [<a href="/lib/aef02.html#disqus_thread">Comments</a>]<br/> <form method="post" action="">
<img src="/img/cache/0b9fd596a90421f9f1f68a9760275737.gif" alt="\text{T_EX size}" valign="middle"/>
<select name="TeX_size"><option value="-2">-2</option><option value="-1">-1</option><option value="0" selected="selected">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option> </select>
<input type="submit" value="Scale"/>
</form>
<p>Rapport de recherche N&ordm; 5250 - Juin 2004 - 10 pages</p>
<h2>Abstract</h2>
<p>Imagining what the nature of future viral attacks might look like is the key to successfully protecting against them. This paper discusses how cryptography and key management techniques may definitively checkmate antiviral analysis and mechanisms. We present a generic virus, denoted BRADLEY which protects its code with a very secure, ultra-fast symmetric encryption. Since the main drawback of using encryption in that case lies on the existence of the secret key or information about it within the viral code, we show how to bypass this limitation by using suitable key management techniques. Finally, we show that the complexity of the BRADLEY code analysis is at least as high as that of the cryptanalysis of its underlying encryption algorithm.</p>
<h2>1 Introduction</h2>
<p>Antiviral detection is directly based on the capability to have malware codes at one's disposal and to study them by disassembly means. Thus, viral databases can be updated and antiviral engines can be upgraded.</p>
<p>A few malware writers try to make this task more difficult by implementing various techniques which aim at delaying the knowledge and the understanding of their codes: obfusctating, rewriting, encryption.... These codes are denoted <em>armoured codes</em>. The first and most famous one is probably the <em>Whale</em> virus appeared in the early nineties. More recently, the <em>MyDoom</em> virus very naively tries to complicate antiviral experts' work by implementing basic encryption techniques. Up to now, none of the known malware succeeded in preventing code analysis.</p>
<p>The main explanation for this failure lies on two facts:</p>
<ul>
<li>antiviral experts always manage to obtain a malware copy (infected file). As they are widely dissiminated, malware code samples (viruses, worms...) are always very easily available. This comes from the fact that limited virulence<sup><a name="b1" href="#n1">1</a></sup> is not a feature inherent to malicious codes.</li>
<li>When present, techniques aiming at making code analysis more difficult are bound to fail. The main reason is that the related problems (that is to say, problems to be solved in order to bypass code protection) belong to polynomial complexity class. As an example, encryption techniques are always relatively easy to break since the key space is too limited and allows an exhaustive search approach. Moreover, encryption algorithms that have been found in known malware codes are either very naive or do not offer high level of security.</li>
</ul>
<p>In this paper, we present a new concept about malicious codes combining efficient key management with high-level security encryption algorithm. Different analysis and experiments have confirmed the impossibility to study the code, under the assumption that we managed to get a copy of it. By limiting the code presence and virulence in the computer, we show also how to make this assumption very unlikely. We illustrate these concepts (proof-of-concept) by presenting from an algorithmic point of view the most simple example of a new virus family called the BRADLEY viruses. As a main result, we show that the general problem of BRADLEY code analysis is equivalent to the cryptanalysis of a secure encryption algorithm in the sense that it is exponentially complex.</p>
<p>This paper is organized as follows. In Section 2, we first define precisely the background and the known cases where attempts to use cryptography in viral codes have been made. We show why all this attempts were bound to fail. Section 3 recalls key management techniques presented in [11]. In Section 4, we present the generic viral concept<sup><a name="b2" href="#n2">2</a></sup> using strong encryption combined with optimal key generation and key management. At last, Section 5 prooves that BRADLEY viral code analysis is equivalent to encryption systems cryptanalysis and that it is, in fact, of exponential complexity. Conclusion will address the problem of fighting against such armoured malware.</p>
<p>The purpose of this paper is purely academic and draws our attention on the evolution of viral risks. It shows how the malware risk may evolve very quickly (if not already the case) and cause great concern among the antiviral community. This is the reason why we will not give any detailed code. The activity of our laboratory is dedicated to defensive aspects. Our mission consists in identifying new risks, in testing them in practice and assessing the level of potential threat precisely.</p>
<h2>2 Definition and Background</h2>
<h3>2.1 Computer virology</h3>
<p>The reader is supposed to be familiar with basic definitions about malware (virus, worms, trojan horses...) and antiviral techniques. We just recall the following starting definition of <em>armoured</em> codes.</p>
<p><strong>Definition 1</strong> <em>(Armoured codes)</em> <em>An armoured code is a program which contains instructions whose goal is to delay, complicate or forbid its own analysis during either its execution or through its disassembly.</em></p>
<p>The best known example is probably the <em>Whale</em> virus which appeared in September 1990. The virus did actually represent a very limited risk but it intended obviously to make its analysis very difficult. Its code contains roughly a dozen of program traps and tricks hampering trace, disassembling and code analysis: dynamic decryption/encryption, code obfuscation, code nesting...Once activated, the viral code tries to detect the potential use of a debugger and consequently freezes the keyboard. Using polymorphism techniques, about 30 different random variants were possible for an infected file.</p>
<p>What the <em>Whale</em> virus easily managed to cause is not a terrific epidemic but a waste of anti-virus experts' time and a nearly three-day delay to eradicate it. Nowadays, the main part of the viral action is completed during the first thirty minutes after the beginning of the infection (a good example could be the Slammer worm which appeared in January 2003); therefore, such a delay in code analysis cannot be acceptable. That is the reason why armouring code techniques must be seriously taken into account.</p>
<p>These techniques can be divided into different classes, as follows.</p>
<ul>
<li>code obfuscation: the aim is to transform a program into another which both is functionally identical to the original and more difficult to decompile and reverse engineer. In other words, the program is written in order to reduce readability and understandability. Three types of transformations are generally used: lexical transformations (variable name exchange), control flow transformations (making the program flow more complex by using code nesting or placebo code) and data flow transformations (action on data structures by changing storage, encoding, aggregation and order of data). More details can be found in [3, 5, 10, 14]. In a viral context, these techniques are of limited interest.
<p>Obfuscated codes are generally too slow and of too large a size to be efficiently used by undetectable malware. Moreover, the results presented in [2] show there is no transformation able to prevent the code of every program from revealing any other information except the program's input-output behaviour.</p></li>
<li>polymorphism: the aim is to make the code change as often as possible by using rewriting techniques (equivalent functionnality but different code). The code analyst has thus to face up not a single version of the malware code but several versions of it; hence the difficulty to efficiently fight against it. Fortunately, code analysis becomes always possible in the end and, consequently, all polymorphic techniques are overcome.</li>
<li>encryption: the purpose is both to provide polymorphism (encrypted code change with every different key) and to prevent code analysis. So far, known techniques suffer from a lack of efficient key management. The key must be securely available to the malware code only. Hardware solutions which are generally envisaged to prevent code analysis are not suitable for mobile codes like virus or worms. Mostly, the key elements are somehow or other contained in the code itself.</li>
</ul>
<p>As these first two techniques are concerned, code analysts fortunately will always get to the end of it since these techniques always produce deterministic results (even if some algorithms may be partly probabilistic). The only thing is that the analysts need time to study the code behaviour instruction by instruction. Therefore, this study is likely to be time-greedy and requires many human resources and much effort dedication.</p>
<p>Encryption is maybe less obviously easy to handle contrary to what experience tells us so far. Fortunately, only naive or very unsecure encryption methods have been used in known malware [4]: constant masking (like in earlier macro-viruses for example), rot13 encryption or other weak encryption systems (as an example, <em>DarkParanoid</em> virus used very simple arithmetic functions - ADD, SUB, XOR, NEG, NOT, ROL, ROR - as encryption functions).... Besides, weak key management always allows to recover the key and then to decipher the malware code when dealing with strong cryptosystems.</p>
<h3>2.2 Cryptology</h3>
<p>The reader is supposed to be familiar with basic concepts of cryptology as well. A detailed monography about cryptography will be found in [8]. We will just recall previous uses of cryptology inside malware and a few useful concepts we will use throughout this paper.</p>
<p>Cryptology has previously been envisaged to provide computer virology with very efficient tools. On the one hand, cryptographic techniques have recently be considered as a means for optimal worm propagation [1]. The use of cryptographic hash functions, for instance, is suitable for speeding up <em>Curious Yellow worm</em> propagation [15].</p>
<p>On the other hand, the combination of cryptographic techniques with viral technologies led in 1996 to the concept of <em>"Cryptovirology"</em> as presented in [6, 16, 17]. Cryptovirology consists in applying cryptography tools to malicious codes in order to strengthen, improve or develop such codes.</p>
<p>Particularly, cryptography appears to be very efficient in designing pay loads. Several convincing examples are presented in [16]. The main goal is to make a victim host dependent upon the virus - <em><abbr lang="la" title="id est">i.e.</abbr></em> a virus can survive in the host if it makes the host depend in a critical way on the very presence of the virus itself. These results are mainly obtained with public-key cryptographic techniques<sup><a name="b3" href="#n3">3</a></sup> combined with limited symmetric cryptography techniques.</p>
<p>Though very efficient, these approaches aim only at protecting the action of the virus (its payload) but not the virus itself. In other words, if a copy of a cryptovirus is somehow or other obtained and analyzed by reverse engineering, none of the cryptographic tools it contains will totally protect them against its code analysis. Thus, the exact knowledge of the code is likely to allow antiviral software update and limit/forbid the malware's action. The main limitation comes from the fact that cryptovirus as defined by Young and Yung, is not able to manage secret key part in a suitable and efficient way for that particular purpose.</p>
<p>The basic technique we discuss in this paper can effectively forbid such code analysis and thus, properly complement all the approaches developped in [6, 16, 17]. Other more sophisticated techniques are being tested in our laboratory.</p>
<h2>3 Environmental Key Generation</h2>
<p>Malware are mobile agents by nature. If they pass through an "insecure network" or environment (from the malware's point of view), they may be analyzed (disassembled) so that their code will be completely accessible to the attacker (the analyst). As previously explained , traditional encryption systems are dealing with static keys. Actually, the key is present somehow or other in the agent (hardware or software).</p>
<p>In 1998, B. Schneier and J. Riordan [11] introduced the notion of <em>environmental key generation</em> to address this problem. In other words, keying material is contructed from certain classes of environmental data. Environmental key generation can thus be useful when the sender wishes to communicate with the receiver such that the receiver could only receive the message if some environmental conditions are true. Environmental key generation can even be used in circumstances where the receiver is not aware of the specific environmental conditions that the sender wants his communication to depend on. This latter case corresponds exactly to our malware code analysis problem. The receiver here is the malware code present in a computer (the environment) and the sender is malware code author or the target system itself.</p>
<p>The difficulty with building an environmental key generation protocol is that the threat model assumes that any attacker (the malware code analyst) has total control over the environment. All information available to the malware program can be found by the attacker as well. All inputs to the program are supplied by the attacker and the program states themselves is completely determined by the attacker during the code analysis. As such, the constructions must resist direct analysis and dictionnary attacks in the form of Cartesian deception, that is to say, in which the attacker tells lies about the environment.</p>
<p>The authors of [11] discuss several construction for environmental key generation. To illustrate their approach, let us consider the following basic construction. Let <img src="/img/cache/8d9c307cb7f3c4a32822a51922d1ceaa.gif" alt="N" valign="middle"/> be an integer corresponding to an environmental observation, <img src="/img/cache/6799f18bc6e3025d6c3434cd6936735d.gif" alt="\mathcal{H}" valign="middle"/> a one-way function (typically a hash function), <img src="/img/cache/69691c7bdcc3ce6d5d8a1361f22d04ac.gif" alt="M" valign="middle"/> the hash of the observation <img src="/img/cache/e065ec354c65901f1089b8fb270eef11.gif" alt="N, \oplus" valign="middle"/> the bitwise exclusive-or operator, || the concatenation operator, <img src="/img/cache/e1e1d3d40573127e9ee0480caf1283d6.gif" alt="R" valign="middle"/> a nonce and <img src="/img/cache/a5f3c6a11b03839d46af9fb43c97c188.gif" alt="K" valign="middle"/> a key. The value <img src="/img/cache/69691c7bdcc3ce6d5d8a1361f22d04ac.gif" alt="M" valign="middle"/> is carried by the agent (the malware code in our case). Hash function can be used to conduct tests and construct the keys so that examination of the agent does not reveal the required environmental information. Then possible constructions, among many others, are:</p>
<ul>
<li><img src="/img/cache/2bd95768474f052be3a512d40aa4a6a1.gif" alt="\mbox{if }\mathcal{H}(N) = M\mbox{ then let }K = N." valign="middle"/></li>
<li><img src="/img/cache/7945d546997cf56089fa6d9c2cd21da6.gif" alt="\mbox{if }\mathcal{H}(\mathcal{H}(N)) = M\mbox{ then let }K = \mathcal{H}(N)." valign="middle"/></li>
<li><img src="/img/cache/99c0d44c9d9e53249b99a1e1cca7cfb2.gif" alt="\mbox{if }\mathcal{H}(N_i) = M_i\mbox{ then let }K = \mathcal{H}(N_1, N_2, \dots, N_i)." valign="middle"/></li>
<li><img src="/img/cache/cee05c7d5bf65958f5594303133630d2.gif" alt="\mbox{if }\mathcal{H}(N) = M\mbox{ then let }K = \mathcal{H}(R_1,N) \oplus R_2." valign="middle"/></li>
</ul>
<p>Let us note that the first construction is used in most of static encrypted password authentication schemes. The most important feature of each of these constructions is that knowledge of <img src="/img/cache/69691c7bdcc3ce6d5d8a1361f22d04ac.gif" alt="M" valign="middle"/> does not leak any information on <img src="/img/cache/a5f3c6a11b03839d46af9fb43c97c188.gif" alt="K" valign="middle"/>.</p>
<p>Riordan and Schneier proposed several efficient constructions which provide efficient environmental key generation protocols using various techniques: thresholding (protocol using the ideas of cryptographic secret sharing), nesting (action of the mobile agent is ruled by several environmental keys used in the sequential way), time indexation (part of the environmental date required to generate the key are based on time)...</p>
<p>Environmental key generation has only been proposed from a theoretical point of view by the authors. Some aspects still need to be thoroughly tested. Particularly, for most of the constructions they proposed, the attacker is likely to find the key by observing both the agent and the environment. The search space for the activation data may always be small enough to allow an exhaustive search approach. Moreover, by observing mobile agent actions, the attacker may easily determine where and which kind of data the agent is interested in. That implies that a patient analyst will obtain information about the agent at the same time this latter is activated by the suitable environmental data.</p>
<p>We now present a practical and efficient use of environmental key generation in the case of viral code armouring.</p>
<h2>4 A Generic Armoured Virus: the BRADLEY virus</h2>
<p>Let us discuss now the generic family virus named BRADLEY. Without loss of generality, we choose to describe only a basic but powerful example. Some More complex protocols have been developped or are currently under study (see Section 6). Two different codes have been developped and tested:</p>
<ul>
<li>a directed but generic virus which aims at specifically infecting a given group a machine/people (variant A),</li>
<li>a directed virus dedicated to specifically strike only any given user (variant B).</li>
</ul>
<p>Minor variants have been tested as well and will be listed later on. The codes have been designed both for Windows and Unix systems. They successfully managed to bypass antiviral software which all remained silent. Since BRADLEY viruses are only proof-of-concept viruses, we will focus only on the armoring protocol part. Complete source code is not available. The general structure of the codes is given in Figure (1) and summarized as follows:</p>
<div align="center">
<img src="/lib/img/aef02.gif" alt="Figure 1: Overall structure of BRADLEY codes"/>
<p><strong>Figure 1: Overall structure of BRADLEY codes</strong></p>
</div>
<ul>
<li>a decipherment procedure <img src="/img/cache/f623e75af30e62bbd73d6df5b50bb7b5.gif" alt="D" valign="middle"/> which purpose is to collect activation data, test and evaluate them and finally decipher the different encrypted parts of the code;</li>
<li>a first encrypted part <img src="/img/cache/8225d63f4a48d4b127de6c5fecdf260b.gif" alt="\mbox{EVP}_1" valign="middle"/> with encryption key <img src="/img/cache/cbb11f85182f81ceb8063f6c3e876fe3.gif" alt="K_1" valign="middle"/>. Once deciphered, this part installs all anti-antiviral functions (passive and active).</li>
<li>a second encrypted part <img src="/img/cache/5e393e4423be64ba287f98f0b88347dc.gif" alt="\mbox{EVP}_2" valign="middle"/> with encryption key <img src="/img/cache/0f35e0a32fc3940c857d8ec6615c5a94.gif" alt="K_2" valign="middle"/>. This part contains the infection functions and the polymorphism procedures. When replicating, the virus will always and completely change its form (including the decipherment procedure).</li>
<li>a third part <img src="/img/cache/bab216a06f780d9d24c171d771bb5b69.gif" alt="\mbox{EVP}_3" valign="middle"/> (optional) with encryption key <img src="/img/cache/5795717d3933552288acde3b37c4fcb6.gif" alt="K_3" valign="middle"/>. It contains the payload functions (in our case, a simple opening window issuing a infection warning in order to keep control over the virus).</li>
</ul>
<p>Note that these three encrypted parts are exactly of the same size in order to give the slightest information on the underlying code.</p>
<p>Let us now describe the key management protocol. The activation data - in other words the data required to construct the different keys - are (variant A):</p>
<ul>
<li>the local DNS address (e.g. @company.com), denoted <img src="/img/cache/7b7f9dbfea05c83784f8b85149852f08.gif" alt="\alpha" valign="middle"/>,</li>
<li>current system time (hours hh only) and date (mmdd) , denoted <img src="/img/cache/77a3b715842b45e440a5bee15357ad29.gif" alt="\delta" valign="middle"/>,</li>
<li>a particular data present in the target system(s) (in our case a particular file), denoted <img src="/img/cache/90a815c900df6091998138ff6a67483e.gif" alt="\iota" valign="middle"/>,</li>
<li>a particular information under viral code author control, located outside the system (public channel) but easily accessible to the virus (in our case, a given web page containing a particular value whose presence is limited in time and related to the value <img src="/img/cache/77a3b715842b45e440a5bee15357ad29.gif" alt="\delta" valign="middle"/>); it is denoted <img src="/img/cache/4f08e3dba63dc6d40b22952c7a9dac6d.gif" alt="\pi" valign="middle"/> and obtained from the hash of this information<sup><a name="b4" href="#n4">4</a></sup></li>
</ul>
<p>For the variant B, data <img src="/img/cache/90a815c900df6091998138ff6a67483e.gif" alt="\iota" valign="middle"/> is a given public key which is present in a <em>pubring.gpg</em> for example. Thus, the virus may target a particular user or users communicating through encrypted emails/data with any given user. The viral code uses the hash function SHA-1 [9] as one-way function (here denoted <img src="/img/cache/6799f18bc6e3025d6c3434cd6936735d.gif" alt="\mathcal{H}" valign="middle"/>). Then, the environmental key protocol is described as follows:</p>
<ol>
<li>the decipherment procedure <img src="/img/cache/f623e75af30e62bbd73d6df5b50bb7b5.gif" alt="D" valign="middle"/> collects the activation data either directly (<img src="/img/cache/7f494e48ba5a69fbbdd6bac30fe28b51.gif" alt="\alpha, \delta\mbox{ and }\pi" valign="middle"/>) or repeatedly<sup><a name="b5" href="#n5">5</a></sup> (<img src="/img/cache/90a815c900df6091998138ff6a67483e.gif" alt="\iota" valign="middle"/>) and compute a 160-bit value <img src="/img/cache/5206560a306a2e085a437fd258eb57ce.gif" alt="V" valign="middle"/> given by <img src="/img/cache/743d9d9606bcd0934e08adea8e07c482.gif" alt="\mathcal{H}(\mathcal{H}(\alpha \oplus \delta \oplus \iota \oplus \pi) \oplus \upsilon)" valign="middle"/> where <img src="/img/cache/5470b9993b5d776db89f25ac7cfff3a1.gif" alt="\upsilon" valign="middle"/> is the first 512 bits of <img src="/img/cache/3467f23e077b936a6f34ffd2db747251.gif" alt="\mbox{EVP_1}" valign="middle"/> (in its encrypted form).</li>
<li>if <img src="/img/cache/46599b7a16f626eb5428e0cef3609164.gif" alt="V = M" valign="middle"/> where <img src="/img/cache/69691c7bdcc3ce6d5d8a1361f22d04ac.gif" alt="M" valign="middle"/> is the <em>activation value</em> contained in the viral code, then <img src="/img/cache/cdfec9673a48b061582401e0ddc4e632.gif" alt="K_1 = \mathcal{H}(\alpha\oplus\delta\oplus\iota\oplus\pi)" valign="middle"/> otherwise the decipherment procedure stops and disinfects the present system from the whole viral code.</li>
<li><img src="/img/cache/f623e75af30e62bbd73d6df5b50bb7b5.gif" alt="D" valign="middle"/> deciphers <img src="/img/cache/3467f23e077b936a6f34ffd2db747251.gif" alt="\mbox{EVP_1}" valign="middle"/> producing <img src="/img/cache/7b46800b524f7d2fd6670666ee9cb532.gif" alt="\mbox{VP_1} = D_{K_1}(\mbox{EVP_1})" valign="middle"/> and launches it. Then <img src="/img/cache/f623e75af30e62bbd73d6df5b50bb7b5.gif" alt="D" valign="middle"/> is computing <img src="/img/cache/1e98ac494fdae7111241d39ea1f5cc9c.gif" alt="K_2 = \mathcal{H}(K_1 \oplus\upsilon_2)" valign="middle"/> where <img src="/img/cache/a6a9c811ed1325d186b2d45cbf9a2309.gif" alt="\upsilon_2" valign="middle"/> is the 512 last bits of <img src="/img/cache/dc28297353a5b406c4e198f0f1442246.gif" alt="\mbox{VP_1}" valign="middle"/>.</li>
<li><img src="/img/cache/f623e75af30e62bbd73d6df5b50bb7b5.gif" alt="D" valign="middle"/> deciphers <img src="/img/cache/2e334eb1b5db1f59efcaf0560cddba8f.gif" alt="\mbox{EVP_2}" valign="middle"/> producing <img src="/img/cache/fcfc4d952f84e0a7944bcac6df496df7.gif" alt="\mbox{VP_2} = D_{K_2}(\mbox{EVP_2})" valign="middle"/> and launches it. Then <img src="/img/cache/f623e75af30e62bbd73d6df5b50bb7b5.gif" alt="D" valign="middle"/> is computing <img src="/img/cache/d051bddba2c49f1e506544926f54af69.gif" alt="K_3 = \mathcal{H}(K_1\oplus K_2 \oplus \upsilon_3)" valign="middle"/> where <img src="/img/cache/276b0c1916d77cafba1d1a3a71288ba2.gif" alt="\upsilon_3" valign="middle"/> is the 512 last bits of <img src="/img/cache/250ca4671deb438ed4c77867dac9dab4.gif" alt="\mbox{VP_2}" valign="middle"/>.</li>
<li><img src="/img/cache/f623e75af30e62bbd73d6df5b50bb7b5.gif" alt="D" valign="middle"/> deciphers <img src="/img/cache/9cb38ce9730fa6ed4d740f9ace085b49.gif" alt="\mbox{EVP_3}" valign="middle"/> producing <img src="/img/cache/60b1db17cca997ffa65feb622549ec59.gif" alt="\mbox{VP_3} = D_{K_3}(\mbox{EVP_3})" valign="middle"/> and launches it.</li>
<li>After virus action is completed, the virus disinfects itself totally.</li>
</ol>
<p>Some remarks can be made about this protocol:</p>
<ul>
<li>from replication to replication, the whole code (including procedure <img src="/img/cache/f623e75af30e62bbd73d6df5b50bb7b5.gif" alt="D" valign="middle"/> and value <img src="/img/cache/69691c7bdcc3ce6d5d8a1361f22d04ac.gif" alt="M" valign="middle"/>) has completely changed every time. This implies a total control of the polymorphic procedure relatively to the key management protocol by the author of the viral code (<em><abbr lang="la" title="id est">i.e.</abbr></em> the evolution of the activation data - in practice only the values <img src="/img/cache/77a3b715842b45e440a5bee15357ad29.gif" alt="\delta" valign="middle"/> and/or <img src="/img/cache/4f08e3dba63dc6d40b22952c7a9dac6d.gif" alt="\pi" valign="middle"/>).</li>
<li>the purpose of values <img src="/img/cache/0ca9b50c4f630610a4851c789b270a9a.gif" alt="C_x" valign="middle"/> is to make the data span the whole input space (512 bits).</li>
<li>the different parts <img src="/img/cache/1b09e579492b6300bf77d9de83fea9b8.gif" alt="\mbox{VP_i}" valign="middle"/> may be compressed before encryption.</li>
<li>the keys <img src="/img/cache/2590c050c981bb33fabcc01c23b0d6d4.gif" alt="K_1,K_2" valign="middle"/> and <img src="/img/cache/5795717d3933552288acde3b37c4fcb6.gif" alt="K_3" valign="middle"/> can be made independant by using additional environmental data.</li>
<li>the auto-disinfection may be delayed in order to handle the time and date values in a less strictly way. In that case, the decipherment procedure <img src="/img/cache/f623e75af30e62bbd73d6df5b50bb7b5.gif" alt="D" valign="middle"/> remains active in system memory.</li>
</ul>
<p>Other variants have been tested as well, particularly to produce the most optimal code in terms of size and stealthiness. The most significative variant is the following:</p>
<ul>
<li>the underlying code is compressed,</li>
<li>instead of embedding compression and encryption functions within the virus code, this latter will borrow local resources if present,</li>
<li>that implies that one more activation data is required and repeatedly scanned for: existence or not of compression and encryption softwares.</li>
</ul>
<p>For all variants we developped, encryption algorithms that have been used are RC4 [12] and RC6 [13] while gzip compression has been chosen.</p>
<h2>5 Viral Code Analysis and Cryptanalysis</h2>
<p>To evaluate the code analysis complexity, two cases must be considered:</p>
<ul>
<li>the analyst has the viral binaries at one's disposal,</li>
<li>the analyst does not have them.</li>
</ul>
<p>The second case is more likely to happen if we consider that, in any case, the virus limits its presence inside the target system by disinfecting itself from it.</p>
<p>But let us suppose that the analyst, even if it is very unlikely, has managed to get one copy of the virus binaries. Let us show that the environmental key generation protocol presented in section 4 efficiently forbids code analysis unless a cryptanalysis problem of exponential complexity is solved.</p>
<p><strong>Proposition 1</strong> <em>The analysis of a code protected by the environmental key generation protocol defined in Section 4 is a problem which has exponential complexity.</em></p>
<p>Let us now prove this proposition.</p>
<p><em>Proof.</em></p>
<p>Firstly, let us remark that decipherment procedure D leaks only the following information:</p>
<ul>
<li>the activation value <img src="/img/cache/5206560a306a2e085a437fd258eb57ce.gif" alt="V" valign="middle"/>,</li>
<li>the fact that the virus looks for the system time and date,</li>
<li>the fact that the virus scans for specific data <img src="/img/cache/550a9e0f7804ea0316e453f1980c674f.gif" alt="\alpha, \iota\mbox{ and }\pi" valign="middle"/>.</li>
</ul>
<p>Moreover, the analyst is able to analyze the virus if and only if he knows the secret key <img src="/img/cache/cbb11f85182f81ceb8063f6c3e876fe3.gif" alt="K_1" valign="middle"/>. It can be obtained either by direct cryptanalysis or by guessing the exact values of the different activation data required to generate the good key. This guessing is equivalent to dictionary attacks.</p>
<p>The cryptanalysis approach aims at finding the value <img src="/img/cache/cbb11f85182f81ceb8063f6c3e876fe3.gif" alt="K_1" valign="middle"/> such that <img src="/img/cache/65f5b346c7fab0e8ec6cc3f580a3e3b8.gif" alt="\mathcal{H}(K_1\oplus C_1) = M" valign="middle"/> where <img src="/img/cache/69691c7bdcc3ce6d5d8a1361f22d04ac.gif" alt="M" valign="middle"/> and <img src="/img/cache/4fa71d007c094ac3c858919aec515277.gif" alt="C_1" valign="middle"/> are easy to identify in the decipherment procedure <img src="/img/cache/f623e75af30e62bbd73d6df5b50bb7b5.gif" alt="D" valign="middle"/>. A hash function is highly non injective by nature. Thus it cannot be computationaly inversed in any way (<em>preimage resistance</em>). Consequently, this problem must be reformulated as a collision search problem (for more details, refer to [8, Chapter 9]). In other words, find all pairs of input <img src="/img/cache/9dd4e461268c8034f5c8564e155c67a6.gif" alt="x" valign="middle"/> and <img src="/img/cache/30b94bbbad526eeb6dd345afdaeaccf8.gif" alt="x'" valign="middle"/> such that <img src="/img/cache/1abe4873f923548c2a465091dce97d62.gif" alt="\mathcal{H}(x) = \mathcal{H}(x')" valign="middle"/>. This problem itself is computationally infeasible. To be more precise finding such a pair requires <img src="/img/cache/d2e03a8090215a4e95037b346cc969d8.gif" alt="2^{\frac{n}{2}}" valign="middle"/> operations for <img src="/img/cache/7b8b965ad4bca0e41ab51de7b31363a1.gif" alt="n" valign="middle"/>-bit input values (<img src="/img/cache/7b8b965ad4bca0e41ab51de7b31363a1.gif" alt="n" valign="middle"/> = 512 for SHA-1). Since the analyst must absolutely find the exact key <img src="/img/cache/cbb11f85182f81ceb8063f6c3e876fe3.gif" alt="K_1" valign="middle"/> (secret key really used to encrypt the viral code), he must beforehand compute all the values <img src="/img/cache/9dd4e461268c8034f5c8564e155c67a6.gif" alt="x" valign="middle"/> such that <img src="/img/cache/bd2fb7c9812045ff05664f214adbf3bb.gif" alt="\mathcal{H}(x) = M" valign="middle"/>. For a <img src="/img/cache/7b8b965ad4bca0e41ab51de7b31363a1.gif" alt="n" valign="middle"/>-bit input, <img src="/img/cache/6f8f57715090da2632453988d9a1501b.gif" alt="m" valign="middle"/>-bit output hash function, there exists <img src="/img/cache/3902af36b65852f667197d46242453fe.gif" alt="2^{n-m}" valign="middle"/> such <img src="/img/cache/9dd4e461268c8034f5c8564e155c67a6.gif" alt="x" valign="middle"/> (<img src="/img/cache/9df79af13764ac41496ff44ffe4d50f4.gif" alt="2^{352}" valign="middle"/> for SHA-1). Then, to summarize, recovering the key requires <img src="/img/cache/e39c24eae03dd3dac6755da8fdbed40b.gif" alt="2^{\frac{n}{2}} \times 2^{n-m}" valign="middle"/> operations - that is to say <img src="/img/cache/e011a062979bde2b5dea10ed053693f9.gif" alt="2^{\frac{(n^2 - m)}{2}}" valign="middle"/> operations (<img src="/img/cache/2feb7dcbe6100d1db99be46866518237.gif" alt="\approx 2^{131,072}" valign="middle"/> for SHA-1).</p>
<p>Let us now consider the dictionary attack approach. It consists in enumerating all the possible values that might have been used as activation data. Note that, in that particular case, the analyst must simultaneously consider both the encrypted viral code and the system in which the code has been found. The analyst can try all the possible data relevant to the system (that is to say <img src="/img/cache/bf6edcd856606253df484e471ef2a003.gif" alt="\alpha, \iota\mbox{ and }\delta" valign="middle"/>) over which he has control during the analysis. Unfortunately, data <img src="/img/cache/4f08e3dba63dc6d40b22952c7a9dac6d.gif" alt="\pi" valign="middle"/> remains out of his control and thus he will not be able to determine its exact value. Thus there is no any other more efficient approach than searching exhaustively for the value <img src="/img/cache/52b41adc6b97fdc6441b93a6f11906f1.gif" alt="\alpha\oplus\delta\oplus\iota\oplus\pi" valign="middle"/>. Since at least <img src="/img/cache/72ab8af56bddab33b269c5964b26620a.gif" alt="pi" valign="middle"/> will be chosen randomly by the viral code author, this exhaustive search has complexity <img src="/img/cache/d1db0d9c696a8c056e7117dbbb4ef6db.gif" alt="2^n" valign="middle"/> if a <img src="/img/cache/7b8b965ad4bca0e41ab51de7b31363a1.gif" alt="n" valign="middle"/>-bit input hash function has been used (<img src="/img/cache/ebfbfee5f51fa677168127eae9d376ae.gif" alt="2^{512}" valign="middle"/> for SHA-1). All things considered, the overall complexity of the code analysis is <img src="/img/cache/ad38188a001f45107135cfe52ae80eb6.gif" alt="\mbox{min}(2^n,2^{\frac{(n^2-m)}{2}}) = 2^n" valign="middle"/>.</p>
<div align="right"><img src="/img/cache/09cfa2435552d2f8a90d85e99701606a.gif" alt="\boxempty" valign="middle"/></div>
<h2>6 Conclusion</h2>
<p>The proof-of-concept virus BRADLEY has been designed and discussed to illustrate the fact that efficient armouring is possible. BRADLEY and other efficient viruses of same kind pose the problem of a threat which so far, is impossible to deal with. The polymorphic nature of such codes, when optimally implemented, forbids any detection based only on the decipherment procedure <img src="/img/cache/f623e75af30e62bbd73d6df5b50bb7b5.gif" alt="D" valign="middle"/>. During the experiments, detection based on behaviour monitoring and analysis has been successfully bypassed as well.</p>
<p>Permament and direct memory monitoring might be a solution to deal with such efficient armoured codes. Besides, heavy system ressources are required and this approach implies to be aware of this particular threat (efficient code armouring). Current research carried out in our laboratory aims at proving that even memory management and monitoring can be bypassed. We particularly designed a far more complex variant directly drawn from the <em>DarkParanoid</em> virus: at any time, only a single instruction can be found in an unencrypted form in memory. But it requires a far more complex environmental key generation than that simple one presented in Section 4.</p>
<p>Unless a solution is rapidly found to fight against these virus, this study outlines that an isolation of critical networks and a strict computer security policy is absolutely essential. Moreover, this implies that the antiviral companies must develop cryptanalysis skills in the very near future, under the assumption that it is possible to obtain a viral code sample and that breakable cryptosystems have been used.</p>
<h2>References</h2>
<ol>
<li>Balepin I. (2003), <a href="/lib/aib01.html">Superworms and Cryptovirology: a Deadly Combination</a>, http://wwwcsif.cs.ucdavis.edu/~balepin/new_pubs/worms-cryptovirology.pdf</li>
<li>Barak B., Goldreich O., Impagliazzo R., Rudich S., Sahai A., Vadhan S, Yang K. (2001), On the (im)possibility of obfuscation programs, Advances in Cryptology, Crypto 2001, LNCS 2139, pp. 1-18, Springer Verlag.</li>
<li>Chow S., Eisen P. Johnson H., Zakharov V.A. (2001), An approach to the obfuscation of control-flow of sequential computer programs, Information Security, ISC 2001, LNCS 2200, pp. 144-155, Springer Verlag.</li>
<li>Ciubotariu M. (2003), <a href="/lib/amc00.html">Virus Cryptoanalysis</a>, Virus Bulletin, november. http://www.virusbtn.com/magazine/archives/200311/cryptoanalysis.xml</li>
<li>Collberg C.S., Thomborson C. (2002), Watermarking, tamper-proofing and obfuscation - Tools for software protection, IEEE Transactions on Software Engineering, Vol. 28, No. 8, August 2002, pp. 735-746.</li>
<li>http://www.cryptovirology.com/</li>
<li>Filiol E. (2003), Les virus informatiques : theorie, pratique et applications, Collection IRIS, Springer.</li>
<li>Menezes A., van Oorschot P., Vanstone S.A. (1997), Handbook of Applied Cryptography, CRC Press.</li>
<li>National Institue of Standards and Technology, NIST FIPS PUB 180, Secure Hash Standard, U.S. Department of Commerce, May 1993.</li>
<li>Project funded by the Fund for Scientific Research - Flanders (2003), Coordinated Research of Program Obfuscation, http://www.elis.regent.be/~banckaer/obfuscation/proposal.html</li>
<li>Riordan J., Schneier B. (1998) Environmental key generation towards clueless agents. In Mobile Agents and Security Conference'98, G. Vigna ed., Lecture Notes in Computer Science, pp 15-24, Springer-Verlag, 1998.</li>
<li>Rivest R.L. (1992), The RC4 Encryption Algorithm, RSA Data Security Inc.</li>
<li>Rivest R.L., Robshaw M.J.B. Robshaw, Sidney R. and Yin Y.L. (1998), The RC6 block cipher, Proc. of the 1st AES Candidate Conference, August 1998, Ventura.</li>
<li>Shah P. (2002), Code Obfuscation For Prevention of Malicious Reverse Engineering Attacks, http://islab.oregonstate.edu/koc/ece478/02Reports/S2.pdf</li>
<li>Wiley B. (2002), <a href="/lib/abw00.html">Curious Yellow: The First Coordinated Worm Design</a>, http://blanu.net/curious_yellow.html.</li>
<li>Young A, Yung M. (1996), Cryptovirology: Extorsion-Based Security Threats and Countermeasures, IEEE Symposium on Security and Privacy, Oakland, CA, 1996.</li>
<li>Young A, Yung M. (2004), Malicious Cryptography: Exposing Cryptovirology, Wiley &amp; Sons.</li>
</ol>
<hr/>
<p><small><a name="n1" href="#b1"><sup>1</sup></a> <em>Virulence</em> is an index measuring the level of risk for self-reproducing codes. This index, hence the risk itself, is related to the number of copies of the malware code. For details, see [7, chapter 4, pp. 89ff].</small></p>
<p><small><a name="n2" href="#b2"><sup>2</sup></a> Without loss of generality, we will use the general term <em>"virus"</em> but everything presented in this paper may apply to any other malware type: trojans, worms, logical bombs...</small></p>
<p><small><a name="n3" href="#b3"><sup>3</sup></a> A <em>cryptovirus</em> is defined as a computer virus that contains and uses a <em>public key</em>.</small></p>
<p><small><a name="n4" href="#b4"><sup>4</sup></a> One may object that the presence of the webpage url within the procedure <img src="/img/cache/f623e75af30e62bbd73d6df5b50bb7b5.gif" alt="D" valign="middle"/> could give a useful information to the analyst. Since the webpage is under malware author's control, it is a very dunious hypothesis that the attacker could successfully access to the suitable activation data, especially if the data availability is very limited in time. Nonetheless, we have developped a variant of the basic protocol which is discussed in this section. Instead of only one data <img src="/img/cache/4f08e3dba63dc6d40b22952c7a9dac6d.gif" alt="\pi" valign="middle"/>, we use two external activation data <img src="/img/cache/4f08e3dba63dc6d40b22952c7a9dac6d.gif" alt="\pi" valign="middle"/> and <img src="/img/cache/f81795f5cd2e69b9e65cb1adf15c681c.gif" alt="\pi'" valign="middle"/>. Each of them come from two different webpages. The second webpage's url is encrypted by means of the key contructed from data <img src="/img/cache/92ea643da51b371974fc522fce534f89.gif" alt="\alpha,\delta,\iota\mbox{ and }\pi" valign="middle"/>. Once decrypted, the virus gets the second activation data <img src="/img/cache/f81795f5cd2e69b9e65cb1adf15c681c.gif" alt="\pi'" valign="middle"/> and a secret permutation function <img src="/img/cache/44c29edb103a2872f519ad0c9a0fdaaa.gif" alt="P" valign="middle"/> (at the very beginning of <img src="/img/cache/3467f23e077b936a6f34ffd2db747251.gif" alt="\mbox{EVP_1}" valign="middle"/>). Finally, the key <img src="/img/cache/87bf764cad748d06a517b3a6af2f1ef1.gif" alt="K_1'" valign="middle"/> is build from data <img src="/img/cache/cd83a556653adba4b92e2fbd76f022c9.gif" alt="P(\alpha), P(\delta), P(\iota)" valign="middle"/> and <img src="/img/cache/f81795f5cd2e69b9e65cb1adf15c681c.gif" alt="\pi'" valign="middle"/> in the same way as key <img src="/img/cache/cbb11f85182f81ceb8063f6c3e876fe3.gif" alt="K_1" valign="middle"/> is. In this variant, <img src="/img/cache/cbb11f85182f81ceb8063f6c3e876fe3.gif" alt="K_1" valign="middle"/> is superseded by <img src="/img/cache/87bf764cad748d06a517b3a6af2f1ef1.gif" alt="K_1'" valign="middle"/>.</small></p>
<p><small><a name="n5" href="#b5"><sup>5</sup></a> "Repeatedly" means here that the virus scans any data contained in the system. In our case (a given file), the virus looks recursively for that data through the tree file system.</small></p>
[<a style="" href="/lib/?lang=EN&amp;index=CR#aef02">Back to index</a>] [<a href="/lib/aef02.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=aef02">de</a><a href="/lib/index.php?lang=en&amp;id=aef02">en</a><a href="/lib/index.php?lang=es&amp;id=aef02">es</a><a href="/lib/index.php?lang=it&amp;id=aef02">it</a><a href="/lib/index.php?lang=fr&amp;id=aef02">fr</a><a href="/lib/index.php?lang=pl&amp;id=aef02">pl</a><a href="/lib/index.php?lang=ru&amp;id=aef02">ru</a><a href="/lib/index.php?lang=ua&amp;id=aef02">ua</a></div>
</body>
</html>
