<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Peter Ferrie 'Flibi: Evolution' (VX heaven)</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<meta name="Author" content="Peter Ferrie"/>
<meta name="KeyWords" lang="en" content="computer virus, virus, virii,vx, компьютерные вирусы, вирус, вири, Ferrie, Peter,Flibi: Evolution, registers, amino, needed, acids, xffffffff, save, codons, call, push, rotate, relative, version, instructions, addsaved, time"/>
<meta name="Description" content="The Flibi virus demonstrated that a virus can carry its own ‘genetic code’ (see VB, March 2011, p.4), and if the codons (the p-code form of the virus), the tRNA (the translator function), or the corresponding amino acids (the native code) are mutated in some way, then interesting behaviours can arise."/>
<script type="text/javascript">
//<![CDATA[
try{if (!window.CloudFlare) {var CloudFlare=[{verbose:0,p:0,byc:0,owlid:"cf",bag2:1,mirage2:0,oracle:0,paths:{cloudflare:"/cdn-cgi/nexp/dok3v=1613a3a185/"},atok:"047a5bcbf67431883fc9ed25fba33612",petok:"dd9105000137e884a330eb49bbd6b8b553dc0d8f-1498757790-1800",zone:"vxheaven.org",rocket:"a",apps:{}}];document.write('<script type="text/javascript" src="//ajax.cloudflare.com/cdn-cgi/nexp/dok3v=85b614c0f6/cloudflare.min.js"><'+'\/script>');}}catch(e){};
//]]>
</script>
<link rel="icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" type="text/css" href="/style.css"/><link rel="canonical" href="http://vxheaven.org/lib/apf57.html"/>
<script type="text/rocketscript" data-rocketsrc="https://apis.google.com/js/plusone.js">{"parsetags": "explicit"}</script>
</head>
<body bgcolor="#dbc8a0" text="#302000" link="#225599" vlink="#113366">
<div class="s1">
<div style="float:right;"><a href="/lib/index.php?tbs=1"><img src="/img/max.gif" alt="Maximize"/></a></div> <form id="lf" style="margin: 0; float: right;" method="get" action="/index.php"><input type="hidden" name="action" value="set"/><select name="lang" onchange="javascript:document.getElementById('lf').submit();"><option value="ru">Русский</option><option selected="selected" value="en">English</option><option value="ua">Українська</option><option value="de">Deutsch</option><option value="es">Español</option><option value="fr">Fran&ccedil;ais</option><option value="it">Italiano</option><option value="pl">Polski</option></select></form>
<div style="float: right;"><div id="plusone"></div></div>
<script type="text/rocketscript">gapi.plusone.render("plusone", {"size":"small","count":"true"});</script>
<div style="float: right;" class="addthis_toolbox addthis_default_style">
<script type="text/rocketscript">var addthis_config = { ui_click: true }</script>
<a style="text-decoration: none; font-size: 10pt;" href="/?action=addthis" class="addthis_button_compact">Bookmark</a>
<script type="text/rocketscript" data-rocketsrc="http://s7.addthis.com/js/250/addthis_widget.js#username=herm1t"></script>
</div>
<div style="float: right;">
<script type="text/rocketscript" data-rocketsrc="http://www.google.com/cse/brand?form=cse-search-box&amp;lang=en"></script>
<form action="/search.php" id="cse-search-box">
<input type="hidden" name="cx" value="002577580816726040001:z9_irkorydo"/>
<input type="hidden" name="cof" value="FORID:10"/>
<input type="hidden" name="ie" value="UTF-8"/>
<input type="text" name="q" size="12" value=" "/>
<input type="submit" name="sa" value="Search"/>
</form>
</div><h1><a href="/" style="text-decoration: none; color: #000000;">VX Heaven</a></h1>
<span class="nav"><a href="/lib/">Library</a> <a href="/vl.php">Collection</a> <a href="/src.php">Sources</a> <a href="/vx.php?id=eidx">Engines</a> <a href="/vx.php?id=tidx">Constructors</a> <a href="/vx.php?id=sidx">Simulators</a> <a href="/vx.php?id=uidx">Utilities</a> <a href="/links.php">Links</a> <a href="/donate.php" style="color: #706020" id="donate">Donate</a> <a href="/forum" style="text-decoration: underline;">Forum</a> </span><br clear="all"/>
</div>
<div class="s2"><h1>Flibi: Evolution</h1><p><a href="/lib/?lang=en&amp;author=Ferrie%2C%20Peter">Peter Ferrie</a><br/> <em>Virus Bulletin, May 2011, page 6-15</em><br/> <em>ISSN 0956-9979</em><br/> <em>May 2011</em></p><script type="text/rocketscript">var disqus_url = 'http://vxheaven.org/lib/apf57.html';</script><div class="ci"><a href="/lib/?ci=apf57">3</a></div><img src="/img/pdf.gif" alt="PDF"/><a href="/lib/pdf/Flibi%3A%20Evolution.pdf">Download</a> PDF (92.83Kb) (You need to be registered on <a href="/forum">forum</a>)<br/>[<a style="" href="/lib/?lang=EN&amp;index=AN#apf57">Back to index</a>] [<a href="/lib/apf57.html#disqus_thread">Comments</a>]<br/> <form method="post" action=""><input type="hidden" name="pages" value="1"/><input type="submit" value="Turn on page numbers"/></form>
<p>The Flibi virus demonstrated that a virus can carry its own ‘genetic code’ (<a href="/lib/apf56.html">see VB, March 2011, p.4</a>), and if the codons<sup><a href="#f1" name="b1">1</a></sup> (the p-code form of the virus), the tRNA<sup><a href="#f2" name="b2">2</a></sup> (the translator function), or the corresponding amino acids<sup><a href="#f3" name="b3">3</a></sup> (the native code) are mutated in some way, then interesting behaviours can arise.</p>
<p>Each codon is used as a relative offset into a table of amino acids. There is a single pointer to the table. Mutation of a codon might cause a new amino acid to be produced, since it might now point to a different entry in the table. Mutation of the pointer would almost certainly be fatal since many codons would not be translated into the correct amino acids. Mutation of the amino acid itself might produce new behaviour, depending on the change. For example, a shift could become a rotate.</p>
<p>The virus has the ability to move a sequence of codons to a later position in the stream<sup><a href="#f4" name="b4">4</a></sup>, and then fill the gap with no-operation instructions. In most cases, this simply results in the replacement of the codons at the destination<sup><a href="#f5" name="b5">5</a></sup>. Of course, if the selected sequence appears at the end of the defined stream (there is a lot of slack space after the last meaningful codon), then the size of the defined stream will increase slightly each time that condition occurs. However, the size of the buffer remains fixed. Therefore, new sequences can only appear when the translator code is modified to increase the number of codons that are translated, thus ‘translating’ garbage beyond the original end of the stream. That garbage could potentially be modified over time to eventually produce meaningful functionality. Its location in the virus body would change over time as a result of the codon deletion, allowing the new amino acids to ‘migrate’ to a final position where they become truly useful. The human eye did not spring fully formed from the dust of the earth but was the result of gradual refinements in image accuracy. Something similar can occur here, where the sequence of amino acids does not need to work completely (or even at all) in order to be useful (or just retained). As unlikely as these things are, millions of computer years from now, we might see some of the following transformations.</p>
<p>The aim of this article is to demonstrate how some instructions from the original set might be removed by replacing them with functionally equivalent code sequences using the remaining instructions. One advantage of a smaller instruction set is that it allows an increase in the number of codons that can map to a single amino acid, thus making the body more resilient to corruption. Further, a sequence of instructions has a smaller risk of lethal mutation than a single instruction, because the risk is spread over a wider area.</p>
<p>We begin with a brief overview of the language itself. There are 45 commands in the release version (there were only 43 in the preview version). There are three general-purpose registers (‘A’, ‘B’ and ‘D’, which correspond to the ‘eax’, ‘ebp’ and ‘edx’ CPU registers); one temporary register, upon which all operations are performed (which corresponds to the ‘ebx’ CPU register); one ‘operator’ register, which holds the value for any operation that requires a parameter (which corresponds to the ‘ecx’ CPU register); and two buffer registers, one of which holds the destination for branching instructions (which corresponds to the ‘esi’ CPU register), and the other holds the destination for write instructions (which corresponds to the ‘edi’ CPU register).</p>
<p>The language supports the following commands:</p>
<ul>
<li>_nopsA, _nopsB, _nopsD, _nopdA, _nopdB, _nopdD</li>
<li>_saveWrtOff, _saveJmpOff</li>
<li>_writeByte, _writeDWord</li>
<li>_save, _addsaved, _subsaved</li>
<li>_getDO, _getdata, _getEIP</li>
<li>_push, _pop, _pushall, _popall</li>
<li>_zer0</li>
<li>_mul, _div, _shl, _shr, _and, _xor</li>
<li>_add0001, _add0004, _add0010, _add0040, _add0100, _add0400, _add1000, _add4000, _sub0001</li>
<li>_nopREAL</li>
<li>_JnzUp, _JzDown, _JnzDown</li>
<li>_CallAPILoadLibrary, _CallAPIMessageBox, _CallAPISleep (release version), _call</li>
<li>_null (release version, it has no actual name)</li>
</ul>
<p>This set can be reduced in several ways. The most obvious candidates for removal are the three API calls (two in the preview version<sup><a href="#f6" name="b6">6</a></sup>). The APIs can be called using the ‘_call’ command if the API addresses are placed in the data section in this way:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">_getDO &nbsp; &nbsp;<span style="color: black; font-style: italic;">;get data offset</span><br/>
_addnnnn &nbsp;<span style="color: black; font-style: italic;">;adjust ebx as appropriate to reach the</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;required offset</span><br/>
_call &nbsp; &nbsp; <span style="color: black; font-style: italic;">;call the API</span><br/>
&nbsp;</div>
<p>This leaves 42 commands remaining (41 in the preview version).</p>
<p>The ‘_zer0’ command can be removed by using this code:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = ebx</span><br/>
_xor &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 0</span><br/>
&nbsp;</div>
<p>41 (40) commands now remain.</p>
<p>The ‘_subsaved’ command (which performs the action ‘ebx = ebx – ecx’) can be removed, and the ‘_addsaved’ command (which performs the action ‘ebx = ebx + ecx’) can be used instead, with a slight change. Specifically, the new value of the ‘ecx’ register is ‘-ecx’ (such that ‘ebx = ebx + -ecx’). However, there is no negate command, so an equivalent result must be achieved using the combination of operations that perform a ‘not’ and an ‘add 1’. The problem is that a ‘not’ operation uses the value ‘0xffffffff’, which requires many steps to construct. Given the existing instruction set, it would be simplest to place the value ‘0xffffffff’ in the data section<sup><a href="#f7" name="b7">7</a></sup>. It must be placed at the start of the data section, because the ‘_addnnnn’ commands can be removed, leaving no way to select another offset. This algorithm can then be used:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #00007f; font-weight: bold;">xor</span> <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">0xffffffff</span><br/>
<span style="color: #00007f; font-weight: bold;">inc</span> <span style="color: #46aa03; font-weight: bold;">ebx</span><br/>
&nbsp;</div>
<p>which we translate into this code:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">_push<br/>
_getDO &nbsp; &nbsp;<span style="color: black; font-style: italic;">;get data offset</span><br/>
_getdata &nbsp;<span style="color: black; font-style: italic;">;ebx = 0xffffffff</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 0xffffffff</span><br/>
_pop<br/>
_addsaved <span style="color: black; font-style: italic;">;ebx = ebx - 1</span><br/>
&nbsp;</div>
<p>39 (38) commands remain.</p>
<p>The ‘_addnnnn’ commands exist for convenience, but all of the commands apart from ‘_add0001’ can be constructed using the ‘_add0001’ command. Thus, the ‘_add0004’, ‘_ add0010’, ‘_add0040’, ‘_add0100’, ‘_add0400’, ‘_add1000’ and ‘_add4000’ commands can be removed.</p>
<p>32 (31) commands remain.</p>
<p>The ‘_add0001’ command can also be removed, because the number ‘1’ can be recovered from the value ‘0xffffffff’ by using this code:</p>
 
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">_getDO &nbsp; &nbsp;<span style="color: black; font-style: italic;">;get data offset</span><br/>
_getdata &nbsp;<span style="color: black; font-style: italic;">;ebx = 0xffffffff</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 0xffffffff</span><br/>
<br/>
<span style="color: black; font-style: italic;">;here is a horrible trick:</span><br/>
<span style="color: black; font-style: italic;">;modern CPUs limit the shift-count to 0x1f by taking</span><br/>
<span style="color: black; font-style: italic;">;the low five bits for the count and simply discarding</span><br/>
<span style="color: black; font-style: italic;">;the rest of the value internally, this performs a</span><br/>
<span style="color: black; font-style: italic;">;cl &amp; 0x1f and it’s exactly what we need</span><br/>
<br/>
_shr &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = ebx &gt;&gt; cl</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 1</span><br/>
&nbsp;</div>
<p>From then on, the ‘_addsaved’ command can be used to increment the ‘ebx’ register as needed.</p>
<p>31 (30) commands remain.</p>
<p>Of course, it would require very many uses of the ‘_addsaved’ command in order to construct large values, but value construction can be accelerated by using the ‘_shl’ and ‘_xor’ commands.</p>
<p>For example, constructing the value ‘2’ is a matter of the following:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">_shl &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = ebx &lt;&lt; cl (ebx and ecx are ‘1’</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;from above)</span><br/>
&nbsp;</div>
<p>Constructing the value ‘3’, beginning with the ‘ebx’ and ‘ecx’ registers holding the value ‘1’, as above, is a matter of the following:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">_shl &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = ebx &lt;&lt; cl</span><br/>
_xor &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = ebx ^ ecx</span><br/>
&nbsp;</div>
<p>Constructing the value ‘4’, beginning with the ‘ebx’ and ‘ecx’ registers holding the value ‘1’, as above, is a matter of the following:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">_shl &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = ebx &lt;&lt; cl</span><br/>
_shl &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = ebx &lt;&lt; cl</span><br/>
&nbsp;</div>
<p>And so on. Given this algorithm, we can see that the value ‘0xffffffff’ is not the only possible ‘base constant’. The value ‘1’ could be used instead, since the value ‘0xffffffff’ could be produced from it in the following way:</p>
 
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">_getDO &nbsp; &nbsp;<span style="color: black; font-style: italic;">;get data offset</span><br/>
_getdata &nbsp;<span style="color: black; font-style: italic;">;ebx = 1</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 1</span><br/>
_shl &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 2</span><br/>
_xor &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 3</span><br/>
_shl &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 6</span><br/>
_xor &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 7</span><br/>
_shl &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 0x0e</span><br/>
_xor &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 0x0f</span><br/>
<span style="color: #339933;">...</span> <span style="color: black;">&#91;</span><span style="color: #ff0000;">54</span> steps<span style="color: black;">&#93;</span><br/>
_shl &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 0xfffffffe</span><br/>
_xor &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 0xffffffff</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 0xffffffff</span><br/>
&nbsp;</div>
<p>Clearly, it is far simpler to go from ‘0xffffffff’ to ‘1’ than the other way around. Note that values can also be constructed using the ‘reverse’ of this technique, to reduce the number of shifts required. For example, constructing the value ‘0x80000000’ is a matter of the following:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">_getDO &nbsp; &nbsp;<span style="color: black; font-style: italic;">;get data offset</span><br/>
_getdata &nbsp;<span style="color: black; font-style: italic;">;ebx = 0xffffffff</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 0xffffffff</span><br/>
_shl &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 0x80000000</span><br/>
&nbsp;</div>
<p>Constructing the value ‘0x40000000’ is a matter of the following:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">_push<br/>
_shr &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = ebx &gt;&gt; cl (ebx = 0x80000000,</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 0xffffffff from above)</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 1</span><br/>
_pop<br/>
_shr &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 0x40000000</span><br/>
&nbsp;</div>
<p>However, setting additional bits in the upper region requires more than just the ‘_xor’ command. Here are two examples that set the same value, one using the ‘_shl’ command and one using the ‘_shr’ command. To construct a value such as ‘0xf0000000’, beginning with the ‘ebx’ register holding the value ‘0x80000000’ and the ‘ecx’ register holding the value ‘0xffffffff’, as above, the following can be used:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">_push<br/>
_shr &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = ebx &gt;&gt; cl</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 1</span><br/>
_pop &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 0x80000000 again</span><br/>
_push<br/>
_shr &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 0x40000000</span><br/>
_push<br/>
_shr &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 0x20000000</span><br/>
_push<br/>
_shr &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 0x10000000</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 0x10000000</span><br/>
_pop<br/>
_xor &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 0x30000000</span><br/>
_pop<br/>
_xor &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 0x70000000</span><br/>
_pop<br/>
_xor &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 0xf0000000</span><br/>
&nbsp;</div>
<p>Whereas, to construct the value ‘0xf0000000’, beginning with the ‘ebx’ and ‘ecx’ registers holding the value ‘0xffffffff’, as above, the following can be used:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">_push<br/>
_shr &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = ebx &gt;&gt; cl</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 1</span><br/>
_shl &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 2</span><br/>
_xor &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 3</span><br/>
_shl &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 6</span><br/>
_xor &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 7</span><br/>
_shl &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 0x0e</span><br/>
_shl &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 0x1c</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 0x1c</span><br/>
_pop<br/>
_shl &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 0xf0000000</span><br/>
&nbsp;</div>
<p>Thus, depending on the value, the ‘_shl’ method is the simplest.</p>
<p>Astute readers will have noticed that none of the value constructions above use the ‘_addsaved’ command. This shows that constants can be constructed without using any form of ‘add’. However, it is also possible to perform the addition of arbitrary values without using any form of ‘add’, resulting in the removal of the ‘_addsaved’ command by using this algorithm (edx and ebp holding the values to add together):</p>
<div class="c" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">eax <span style="color: #339933;">=</span> edx <span style="color: #339933;">^</span> ebp<br/>
<span style="color: #b1b100;">do</span><br/>
<span style="color: black;">&#123;</span><br/>
&nbsp; &nbsp; ebp <span style="color: #339933;">=</span> <span style="color: black;">&#40;</span>ebp <span style="color: #339933;">&amp;</span> edx<span style="color: black;">&#41;</span> <span style="color: #339933;">&lt;&lt;</span> <span style="color: #0000dd;">1</span><br/>
&nbsp; &nbsp; edx <span style="color: #339933;">=</span> eax<br/>
&nbsp; &nbsp; eax <span style="color: #339933;">=</span> edx <span style="color: #339933;">^</span> ebp<br/>
<span style="color: black;">&#125;</span><br/>
<span style="color: #b1b100;">while</span> <span style="color: black;">&#40;</span>edx <span style="color: #339933;">&amp;</span> ebp<span style="color: black;">&#41;</span><br/>
ebx <span style="color: #339933;">=</span> eax<br/>
&nbsp;</div>
<p>which we translate into this code:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black;">&#91;</span>construct here the first value to <span style="color: #00007f; font-weight: bold;">add</span><span style="color: #339933;">,</span> <span style="color: #00007f; font-weight: bold;">not</span> shown<span style="color: black;">&#93;</span><br/>
_nopdD &nbsp; &nbsp;<span style="color: black; font-style: italic;">;edx = ebx</span><br/>
<span style="color: black;">&#91;</span>construct here the second value to <span style="color: #00007f; font-weight: bold;">add</span><span style="color: #339933;">,</span> <span style="color: #00007f; font-weight: bold;">not</span> shown<span style="color: black;">&#93;</span><br/>
_nopdB &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebp = ebx</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = ebx</span><br/>
_nopsD &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = edx</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;optional, depending on the order of the</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;constructions above</span><br/>
_xor &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = edx ^ ebp</span><br/>
_nopdA &nbsp; &nbsp;<span style="color: black; font-style: italic;">;eax = edx ^ ebp</span><br/>
_getEIP<br/>
_push &nbsp; &nbsp; <span style="color: black; font-style: italic;">;top of do-while loop</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ebx points to a hidden ‘pop ebx’</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;instruction as part of _getEIP so there</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;is no explicit ‘pop’ instruction inside</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;the loop that corresponds to this ‘push’</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;instruction</span><br/>
_saveJmpOff <span style="color: black; font-style: italic;">;esi = ebx</span><br/>
_nopsD &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = edx</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = edx</span><br/>
_nopsB &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = ebp</span><br/>
_and &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = ebp &amp; edx</span><br/>
_push<br/>
_getDO &nbsp; &nbsp;<span style="color: black; font-style: italic;">;get data offset</span><br/>
_getdata &nbsp;<span style="color: black; font-style: italic;">;ebx = 0xffffffff</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 0xffffffff</span><br/>
_shr &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 1</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 1</span><br/>
_pop<br/>
_shl &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = (edx &amp; ebp) &lt;&lt; 1</span><br/>
_nopdB &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebp = (edx &amp; ebp) &lt;&lt; 1</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = ebx</span><br/>
_nopsA &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = eax</span><br/>
_nopdD &nbsp; &nbsp;<span style="color: black; font-style: italic;">;edx = eax</span><br/>
_push<br/>
_xor &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = edx ^ ebp</span><br/>
_nopdA &nbsp; &nbsp;<span style="color: black; font-style: italic;">;eax = edx ^ ebp</span><br/>
_pop<br/>
_and &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = edx &amp; ebp</span><br/>
_JnzUp &nbsp; &nbsp;<span style="color: black; font-style: italic;">;loop while ((edx &amp; ebp) != 0)</span><br/>
_pop &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;discard loop address</span><br/>
_nopsA &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = eax</span><br/>
&nbsp;</div>
 
<p>30 (29) commands remain.</p>
<p>The replacement code for the ‘_addsaved’ command requires the use of the base constant from the data section (and here, the value ‘1’ would result in shorter code).</p>
<p>The value ‘1’ can be constructed dynamically instead, in the following way:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">_getEIP<br/>
_getdata &nbsp;<span style="color: black; font-style: italic;">;ebx=0xxxxxxx5b</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx=0xxxxxxx5b</span><br/>
_shl<br/>
_shr &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx=0x1b</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx=0x1b</span><br/>
_addsaved <span style="color: black; font-style: italic;">;ebx=0x36</span><br/>
_addsaved <span style="color: black; font-style: italic;">;ebx=0x51</span><br/>
_addsaved <span style="color: black; font-style: italic;">;ebx=0x6c</span><br/>
_addsaved <span style="color: black; font-style: italic;">;ebx=0x87</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx=0x87</span><br/>
_shr &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx=1</span><br/>
&nbsp;</div>
<p>However, that algorithm prevents the removal of the ‘_addsaved’ command. The two concepts seem to be mutually exclusive.</p>
<p>It is unclear whether the ‘_nopREAL’ command could be removed, since there is no other single-byte command that might take its place in the event that a true ‘no-operation’ command were required. Its current purposes are to pad the unused slots following codon deletion and to fill the unused slot(s) that follow the ‘_JnzDown’ command (since the ‘_JnzDown’ command skips three slots). Note that the current implementation of the ‘_JnzDown’ command contains a bug, which is that the destination of the branch is not the start of a slot. Instead, the command branches to two bytes past the start of the slot. The result is that the ‘_nopREAL’ command must be used to fill that destination slot, otherwise a crash could occur because the branch might land in the middle of a command.However, the ‘_JnzDown’ command can be removed by using alternative code, and any non-stack and non-memory instruction can be used for tail padding. Thus it appears that, given its current uses, the ‘_nopREAL’ command can be removed.</p>
<p>29 (28) commands remain.</p>
<p>In the release version a ‘_null’ command exists, which emits a single zero into the stream, followed by the ‘nop’ padding. Its existence is the result of a bug. The execution of such an instruction is likely to cause an exception. It is possible on <i>Windows XP</i> and later to register a vectored exception handle using the existing language, and that could intercept the exception, but this is quite outside the ‘style’ of the language. The command can be removed without any problem.</p>
<p>28 commands remain.</p>
<p>The ‘_JnzDown’ command could be removed by using a careful implementation of ‘_JnzUp’ (given that the meaning is reversed), but perhaps not without the loss of some functionality. It requires knowledge of the location of a forward branch destination. This interferes with command reordering if the buffer size is fixed, because there might not be enough slots available to construct the required ‘add’ value (unless the maximum number of slots was reserved each time in order to construct any possible number). It does, however, extend the functionality in a different way, since the ‘_JnzDown’ command can skip only three commands at a time, requiring its use multiple times in order to execute larger conditional blocks. The ‘_JnzDown’ command also places severe restrictions on what can appear in those conditional blocks, since an arithmetic operation might clear the Z flag, causing the branch to be taken instead of skipped. In contrast, the use of the ‘_JnzUp’ command can skip an arbitrary number of commands without restriction. The difference can be demonstrated easily. We begin with some code that calls the GetTickCount() API to fetch a ‘random’ number (for ease of demonstration, the offset of the GetTickCount() API is set arbitrarily to the value ‘0x0c’), using the ‘_JnzDown’ command:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;construct pointer to GetTickCount()</span><br/>
<span style="color: black; font-style: italic;">;construct the value “0x0c”</span><br/>
<br/>
_getDO &nbsp; &nbsp;<span style="color: black; font-style: italic;">;get data offset</span><br/>
_getdata &nbsp;<span style="color: black; font-style: italic;">;ebx = 0xffffffff</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 0xffffffff</span><br/>
_shr &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 1</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 1</span><br/>
_shl &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 2</span><br/>
_xor &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 3</span><br/>
_shl &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 6</span><br/>
_shl &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 0x0c</span><br/>
_nopdB &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebp = 0x0c</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 0x0c</span><br/>
<br/>
<span style="color: black; font-style: italic;">;add to data offset</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br/>
_getDO &nbsp; &nbsp;<span style="color: black; font-style: italic;">;get data offset</span><br/>
_nopdD &nbsp; &nbsp;<span style="color: black; font-style: italic;">;edx = data offset</span><br/>
_xor &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = edx ^ ebp</span><br/>
_nopdA &nbsp; &nbsp;<span style="color: black; font-style: italic;">;eax = edx ^ ebp</span><br/>
_getEIP<br/>
_push &nbsp; &nbsp; <span style="color: black; font-style: italic;">;top of do-while loop</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ebx points to a hidden ‘pop ebx’</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;instruction as part of _getEIP</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;so there is no explicit ‘pop’</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;instruction inside the loop</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;that corresponds to this ‘push’</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;instruction</span><br/>
_saveJmpOff <span style="color: black; font-style: italic;">;esi = ebx</span><br/>
_nopsD &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = edx</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = edx</span><br/>
_nopsB &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = ebp</span><br/>
_and &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = ebp &amp; edx</span><br/>
_push<br/>
_getDO &nbsp; &nbsp;<span style="color: black; font-style: italic;">;get data offset</span><br/>
_getdata &nbsp;<span style="color: black; font-style: italic;">;ebx = 0xffffffff</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 0xffffffff</span><br/>
_shr &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 1</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 1</span><br/>
_pop<br/>
_shl &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = (edx &amp; ebp) &lt;&lt; 1</span><br/>
_nopdB &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebp = (edx &amp; ebp) &lt;&lt; 1</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = ebx</span><br/>
_nopsA &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = eax</span><br/>
_nopdD &nbsp; &nbsp;<span style="color: black; font-style: italic;">;edx = eax</span><br/>
_push<br/>
_xor &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = edx ^ ebp</span><br/>
_nopdA &nbsp; &nbsp;<span style="color: black; font-style: italic;">;eax = edx ^ ebp</span><br/>
_pop<br/>
_and &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = edx &amp; ebp</span><br/>
_JnzUp &nbsp; &nbsp;<span style="color: black; font-style: italic;">;loop while ((edx &amp; ebp) != 0)</span><br/>
_pop &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;discard loop address</span><br/>
_nopsA &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = eax</span><br/>
<br/>
<span style="color: black; font-style: italic;">;call GetTickCount()</span><br/>
<br/>
_call<br/>
&nbsp;</div>
 
<p>Then the choice is made, and the branch might be taken (seven in eight chances to take it):</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;construct the value ‘7’</span><br/>
<br/>
_getDO &nbsp; &nbsp;<span style="color: black; font-style: italic;">;get data offset</span><br/>
_getdata &nbsp;<span style="color: black; font-style: italic;">;ebx = 0xffffffff</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 0xffffffff</span><br/>
_shr &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 1</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 1</span><br/>
_shl &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 2</span><br/>
_xor &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 3</span><br/>
_shl &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 6</span><br/>
_xor &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 7</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 7</span><br/>
<span style="color: black; font-style: italic;">;’and’ with result from GetTickCount()</span><br/>
_nopsA<br/>
_and &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = ebx &amp; 7</span><br/>
_JnzDown<br/>
<span style="color: black;">&#91;</span>conditional command <span style="color: #ff0000;">1</span><span style="color: black;">&#93;</span><br/>
<span style="color: black;">&#91;</span>conditional command <span style="color: #ff0000;">2</span><span style="color: black;">&#93;</span><br/>
<span style="color: black;">&#91;</span>conditional command <span style="color: #ff0000;">3</span><span style="color: black;">&#93;</span><br/>
_nopREAL &nbsp;<span style="color: black; font-style: italic;">;work around ‘_JnzDown’ bug</span><br/>
&nbsp;</div>
<p>The replacement code might look something like this, beginning immediately after the call to the GetTickCount() API:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;save result from GetTickCount()</span><br/>
<br/>
_nopsA<br/>
_push<br/>
<br/>
<span style="color: black; font-style: italic;">;construct pointer to l2</span><br/>
<br/>
_getDO &nbsp; &nbsp; <span style="color: black; font-style: italic;">;get data offset</span><br/>
_getdata &nbsp; <span style="color: black; font-style: italic;">;ebx = 0xffffffff</span><br/>
_save &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ecx = 0xffffffff</span><br/>
_shr &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ebx = 1</span><br/>
_save &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ecx = 1</span><br/>
<span style="color: #339933;">...</span> <span style="color: black;">&#91;</span>‘_shl’ <span style="color: #00007f; font-weight: bold;">and</span> ‘_xor’ as needed to produce the value <span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>lines<span style="color: black;">&#40;</span>l1<span style="color: #339933;">...</span>l2<span style="color: black;">&#41;</span> <span style="color: #339933;">*</span> <span style="color: #ff0000;">8</span><span style="color: black;">&#41;</span> <span style="color: #339933;">+</span> <span style="color: #ff0000;">3</span><span style="color: black;">&#41;</span><span style="color: black;">&#93;</span><br/>
_nopdB &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ebp = offset of l2</span><br/>
_save &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ecx = offset of l2</span><br/>
_getEIP<br/>
<br/>
l1<span style="color: #339933;">:</span> <br/>
_nopdD &nbsp; &nbsp;<span style="color: black; font-style: italic;">;edx = eip</span><br/>
_xor &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = edx ^ ebp</span><br/>
_nopdA &nbsp; &nbsp;<span style="color: black; font-style: italic;">;eax = edx ^ ebp</span><br/>
_getEIP<br/>
_push &nbsp; &nbsp; <span style="color: black; font-style: italic;">;top of do-while loop</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ebx points to a hidden ‘pop ebx’</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;instruction as part of _getEIP</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;so there is no explicit ‘pop’</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;instruction inside the loop</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;that corresponds to this ‘push’</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;instruction</span><br/>
_saveJmpOff <span style="color: black; font-style: italic;">;esi = ebx</span><br/>
_nopsD &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = edx</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = edx</span><br/>
_nopsB &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = ebp</span><br/>
_and &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = ebp &amp; edx</span><br/>
_push<br/>
_getDO &nbsp; &nbsp;<span style="color: black; font-style: italic;">;get data offset</span><br/>
_getdata &nbsp;<span style="color: black; font-style: italic;">;ebx = 0xffffffff</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 0xffffffff</span><br/>
_shr &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 1</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 1</span><br/>
_pop<br/>
_shl &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = (edx &amp; ebp) &lt;&lt; 1</span><br/>
_nopdB &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebp = (edx &amp; ebp) &lt;&lt; 1</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = ebx</span><br/>
_nopsA &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = eax</span><br/>
_nopdD &nbsp; &nbsp;<span style="color: black; font-style: italic;">;edx = eax</span><br/>
_push<br/>
_xor &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = edx ^ ebp</span><br/>
_nopdA &nbsp; &nbsp;<span style="color: black; font-style: italic;">;eax = edx ^ ebp</span><br/>
_pop<br/>
_and &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = edx &amp; ebp</span><br/>
_JnzUp &nbsp; &nbsp;<span style="color: black; font-style: italic;">;loop while ((edx &amp; ebp) != 0)</span><br/>
_pop &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;discard loop address</span><br/>
_nopsA &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = eax</span><br/>
_saveJmpOff<br/>
<br/>
<span style="color: black; font-style: italic;">;restore result from GetTickCount()</span><br/>
<br/>
_pop<br/>
_nopdA &nbsp; &nbsp;<span style="color: black; font-style: italic;">;eax = GetTickCount()</span><br/>
<br/>
<span style="color: black; font-style: italic;">;construct the value ‘7’</span><br/>
<br/>
_getDO <span style="color: black; font-style: italic;">;get data offset</span><br/>
_getdata &nbsp;<span style="color: black; font-style: italic;">;ebx = 0xffffffff</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 0xffffffff</span><br/>
_shr &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 1</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 1</span><br/>
_shl &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 2</span><br/>
_xor &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 3</span><br/>
_shl &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 6</span><br/>
_xor &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 7</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 7</span><br/>
<br/>
<span style="color: black; font-style: italic;">;’and’ with result from GetTickCount()</span><br/>
<br/>
_nopsA &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = GetTickCount()</span><br/>
_and &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = ebx &amp; 7</span><br/>
_JnzUp<br/>
<span style="color: black;">&#91;</span>conditional command <span style="color: #ff0000;">1</span><span style="color: black;">&#93;</span><br/>
<span style="color: black;">&#91;</span>conditional command <span style="color: #ff0000;">2</span><span style="color: black;">&#93;</span><br/>
<span style="color: black;">&#91;</span>conditional command <span style="color: #ff0000;">3</span><span style="color: black;">&#93;</span><br/>
<span style="color: #339933;">...</span><br/>
<span style="color: black;">&#91;</span>conditional command n<span style="color: black;">&#93;</span><br/>
l2<span style="color: #339933;">:</span> &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;branch destination is here</span><br/>
&nbsp;</div>
 
<p>27 commands remain.</p>
<p>In the same way as for the ‘_JnzDown’ command, the
‘_JzDown’ command can be removed.</p>
<p>26 commands remain.</p>
<p>Normally, the ‘ecx’, ‘esi’ and ‘edi’ registers are write-only (technically, the ‘ecx’ register only becomes write-only after the ‘_addsaved’ command is removed), leaving the ‘eax’, ‘ebx’, ‘edx’ and ‘ebp’ registers as general-purpose registers. However, there is a way to read these registers again after they have been written. The ‘_pushall’ command pushes the registers onto the stack in this order: eax, ecx, edx, ebx, esp, ebp, esi, edi. The registers can then be popped individually from the stack, by using the ‘_pop’ command, in the following way:</p>
<div class="src" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">_pushall ;save all registers<br/>
_pop &nbsp; &nbsp; &nbsp;;edi<br/>
_pop &nbsp; &nbsp; &nbsp;;esi<br/>
_pop &nbsp; &nbsp; &nbsp;;ebp<br/>
_pop &nbsp; &nbsp; &nbsp;;esp (useful for reading stack parameters,<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;using the ‘_getdata’ command, see below)<br/>
_pop &nbsp; &nbsp; &nbsp;;ebx<br/>
_pop &nbsp; &nbsp; &nbsp;;edx<br/>
_pop &nbsp; &nbsp; &nbsp;;ecx<br/>
_pop &nbsp; &nbsp; &nbsp;;eax<br/>
&nbsp;</div>
<p>A smaller set of ‘_pop’ commands can be used to access particular registers, leaving the others for removal later, if necessary. The popped registers can also be modified and pushed back onto the stack, allowing the ‘_popall’ command to be used to pop all of them. This allows multiple values to be assigned simultaneously. By combining several of these tricks, it becomes possible to remove the ‘_mul’ command (edx:eax = eax * ebx). A working solution can be downloaded from http://pferrie.tripod.com/misc/flibi_mul.zip.</p>
<p>25 commands remain.</p>
<p>Interestingly, by reordering the register initialization code for the first addition block to remove one instruction, the code actually increases in size because the branch to l4 requires more instructions to construct it as a result. This brings us to a special-case problem of dynamic pointer construction. There is a particular problem when the code at l2 branches to l4 and the code at l3 branches to l1, but where l1 &lt; l2 and l4 > l3, as shown here:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">l1<span style="color: #339933;">:</span> <span style="color: black;">&#91;</span><span style="color: #0000ff; font-weight: bold;">code</span><span style="color: black;">&#93;</span><br/>
l2<span style="color: #339933;">:</span> <span style="color: #00007f; font-weight: bold;">jz</span> l4<br/>
l3<span style="color: #339933;">:</span> <span style="color: #00007f; font-weight: bold;">jnz</span> l1<br/>
l4<span style="color: #339933;">:</span> <span style="color: black;">&#91;</span><span style="color: #0000ff; font-weight: bold;">code</span><span style="color: black;">&#93;</span><br/>
&nbsp;</div>
<p>First, construct the branch from l2 to l4:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">l1<span style="color: #339933;">:</span> <span style="color: black;">&#91;</span><span style="color: #0000ff; font-weight: bold;">code</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; <span style="color: black; font-style: italic;">;construct relative to l2 (two instructions)</span><br/>
&nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">mov</span> reg<span style="color: #339933;">,</span> <span style="color: #ff0000;">1</span><br/>
&nbsp; &nbsp; <span style="color: #00007f; font-weight: bold;">shl</span> reg<span style="color: #339933;">,</span> <span style="color: #ff0000;">1</span><br/>
l2<span style="color: #339933;">:</span> <span style="color: #00007f; font-weight: bold;">jz</span> l2<span style="color: #339933;">+</span>reg<br/>
l3<span style="color: #339933;">:</span> <span style="color: #00007f; font-weight: bold;">jnz</span> l1<br/>
l4<span style="color: #339933;">:</span><br/>
<span style="color: black;">&#91;</span><span style="color: #0000ff; font-weight: bold;">code</span><span style="color: black;">&#93;</span><br/>
&nbsp;</div>
<p>Then construct the branch from l3 to l1:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">l1<span style="color: #339933;">:</span> &nbsp;<span style="color: black;">&#91;</span><span style="color: #0000ff; font-weight: bold;">code</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">mov</span> reg<span style="color: #339933;">,</span> <span style="color: #ff0000;">1</span><br/>
&nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">shl</span> reg<span style="color: #339933;">,</span> <span style="color: #ff0000;">1</span><br/>
l2<span style="color: #339933;">:</span> &nbsp;<span style="color: #00007f; font-weight: bold;">jz</span> l2<span style="color: #339933;">+</span>reg<br/>
&nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;construct relative to l3 (four lines)</span><br/>
&nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;[code] at l1 is a single instruction to keep</span><br/>
&nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;the example simple</span><br/>
l3<span style="color: #339933;">:</span> &nbsp;<span style="color: #00007f; font-weight: bold;">mov</span> reg<span style="color: #339933;">,</span> <span style="color: #ff0000;">1</span><br/>
&nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">shl</span> reg<span style="color: #339933;">,</span> <span style="color: #ff0000;">1</span><br/>
&nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">shl</span> reg<span style="color: #339933;">,</span> <span style="color: #ff0000;">1</span><br/>
&nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">jnz</span> l3<span style="color: #339933;">-</span>reg<br/>
l4<span style="color: #339933;">:</span> &nbsp;<span style="color: black;">&#91;</span><span style="color: #0000ff; font-weight: bold;">code</span><span style="color: black;">&#93;</span><br/>
&nbsp;</div>
 
<p>Now the branch at l2 is affected, and no longer points to l4, so reconstruct it:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">l1<span style="color: #339933;">:</span> &nbsp;<span style="color: black;">&#91;</span><span style="color: #0000ff; font-weight: bold;">code</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;construct relative to l2 (five instructions)</span><br/>
&nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">mov</span> reg<span style="color: #339933;">,</span> <span style="color: #ff0000;">1</span><br/>
&nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">shl</span> reg<span style="color: #339933;">,</span> <span style="color: #ff0000;">1</span><br/>
&nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">shl</span> reg<span style="color: #339933;">,</span> <span style="color: #ff0000;">1</span><br/>
&nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">add</span> reg<span style="color: #339933;">,</span> <span style="color: #ff0000;">1</span><br/>
l2<span style="color: #339933;">:</span> &nbsp;<span style="color: #00007f; font-weight: bold;">jz</span> l2<span style="color: #339933;">+</span>reg<br/>
l3<span style="color: #339933;">:</span> &nbsp;<span style="color: #00007f; font-weight: bold;">mov</span> reg<span style="color: #339933;">,</span> <span style="color: #ff0000;">1</span><br/>
&nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">shl</span> reg<span style="color: #339933;">,</span> <span style="color: #ff0000;">1</span><br/>
&nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">shl</span> reg<span style="color: #339933;">,</span> <span style="color: #ff0000;">1</span><br/>
&nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">jnz</span> l3<span style="color: #339933;">-</span>reg<br/>
l4<span style="color: #339933;">:</span> &nbsp;<span style="color: black;">&#91;</span><span style="color: #0000ff; font-weight: bold;">code</span><span style="color: black;">&#93;</span><br/>
&nbsp;</div>
<p>But now the branch at l3 is affected, and no longer points to l1, so reconstruct it:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">l1<span style="color: #339933;">:</span> &nbsp;<span style="color: black;">&#91;</span><span style="color: #0000ff; font-weight: bold;">code</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">mov</span> reg<span style="color: #339933;">,</span> <span style="color: #ff0000;">1</span><br/>
&nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">shl</span> reg<span style="color: #339933;">,</span> <span style="color: #ff0000;">1</span><br/>
&nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">shl</span> reg<span style="color: #339933;">,</span> <span style="color: #ff0000;">1</span><br/>
&nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">add</span> reg<span style="color: #339933;">,</span> <span style="color: #ff0000;">1</span><br/>
l2<span style="color: #339933;">:</span> &nbsp;<span style="color: #00007f; font-weight: bold;">jz</span> l2<span style="color: #339933;">+</span>reg<br/>
&nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;construct relative to l3 (six instructions)</span><br/>
l3<span style="color: #339933;">:</span> &nbsp;<span style="color: #00007f; font-weight: bold;">mov</span> reg<span style="color: #339933;">,</span> <span style="color: #ff0000;">1</span><br/>
&nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">shl</span> reg<span style="color: #339933;">,</span> <span style="color: #ff0000;">1</span><br/>
&nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">add</span> reg<span style="color: #339933;">,</span> <span style="color: #ff0000;">1</span><br/>
&nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">shl</span> reg<span style="color: #339933;">,</span> <span style="color: #ff0000;">1</span><br/>
&nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">jnz</span> l3<span style="color: #339933;">-</span>reg<br/>
l4<span style="color: #339933;">:</span> &nbsp;<span style="color: black;">&#91;</span><span style="color: #0000ff; font-weight: bold;">code</span><span style="color: black;">&#93;</span><br/>
&nbsp;</div>
<p>Again, the branch at l2 is affected and no longer points to l4, so reconstruct it:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">l1<span style="color: #339933;">:</span> &nbsp;<span style="color: black;">&#91;</span><span style="color: #0000ff; font-weight: bold;">code</span><span style="color: black;">&#93;</span><br/>
&nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;construct relative to l3 (six instructions)</span><br/>
&nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">mov</span> reg<span style="color: #339933;">,</span> <span style="color: #ff0000;">1</span><br/>
&nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">shl</span> reg<span style="color: #339933;">,</span> <span style="color: #ff0000;">1</span><br/>
&nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">add</span> reg<span style="color: #339933;">,</span> <span style="color: #ff0000;">1</span><br/>
&nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">add</span> reg<span style="color: #339933;">,</span> <span style="color: #ff0000;">1</span><br/>
l2<span style="color: #339933;">:</span> &nbsp;<span style="color: #00007f; font-weight: bold;">jz</span> l2<span style="color: #339933;">+</span>reg<br/>
l3<span style="color: #339933;">:</span> &nbsp;<span style="color: #00007f; font-weight: bold;">mov</span> reg<span style="color: #339933;">,</span> <span style="color: #ff0000;">1</span><br/>
&nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">shl</span> reg<span style="color: #339933;">,</span> <span style="color: #ff0000;">1</span><br/>
&nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">add</span> reg<span style="color: #339933;">,</span> <span style="color: #ff0000;">1</span><br/>
&nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">shl</span> reg<span style="color: #339933;">,</span> <span style="color: #ff0000;">1</span><br/>
&nbsp; &nbsp; &nbsp;<span style="color: #00007f; font-weight: bold;">jnz</span> l3<span style="color: #339933;">-</span>reg<br/>
l4<span style="color: #339933;">:</span> &nbsp;<span style="color: black;">&#91;</span><span style="color: #0000ff; font-weight: bold;">code</span><span style="color: black;">&#93;</span><br/>
&nbsp;</div>
<p>Finally, the instructions are reordered but not inserted, and the combination works. The limitation is that the lines in the construction must converge on a multiple of each other. Such a value might not exist without the explicit insertion of ‘alignment’ lines. The ‘_nop’ command could be used for this purpose, but any ‘harmless’ instruction can be used, such as moving to/from the same register from/to which a value was just moved (more specifically, if the previous move instruction was from ebx to eax, then it is harmless to move from eax back into ebx). By combining several of these tricks, it becomes possible to remove the ‘_div’ command (eax, edx = edx:eax / ebx) as well. A working solution can be downloaded from http://pferrie.tripod.com/misc/flibi_div.zip.</p>
<p>24 commands remain.</p>
<p>The ‘_writeDWord’ command can be removed by using this algorithm:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">bl</span><br/>
<span style="color: #00007f; font-weight: bold;">inc</span> <span style="color: #46aa03; font-weight: bold;">edi</span><br/>
<span style="color: #00007f; font-weight: bold;">shr</span> <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">8</span><br/>
<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">bl</span><br/>
<span style="color: #00007f; font-weight: bold;">inc</span> <span style="color: #46aa03; font-weight: bold;">edi</span><br/>
<span style="color: #00007f; font-weight: bold;">shr</span> <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">8</span><br/>
<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">bl</span><br/>
<span style="color: #00007f; font-weight: bold;">inc</span> <span style="color: #46aa03; font-weight: bold;">edi</span><br/>
<span style="color: #00007f; font-weight: bold;">shr</span> <span style="color: #46aa03; font-weight: bold;">ebx</span><span style="color: #339933;">,</span> <span style="color: #ff0000;">8</span><br/>
<span style="color: #00007f; font-weight: bold;">mov</span> <span style="color: black;">&#91;</span><span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: black;">&#93;</span><span style="color: #339933;">,</span> <span style="color: #46aa03; font-weight: bold;">bl</span><br/>
&nbsp;</div>
<p>which we translate into this code:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;construct the value ‘8’</span><br/>
_push<br/>
_getDO &nbsp; &nbsp;<span style="color: black; font-style: italic;">;get data offset</span><br/>
_getdata &nbsp;<span style="color: black; font-style: italic;">;ebx = 0xffffffff</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 0xffffffff</span><br/>
_shr &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 1</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 1</span><br/>
_shl &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 2</span><br/>
_shl &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 4</span><br/>
_shl &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 8</span><br/>
<br/>
<span style="color: black; font-style: italic;">;save in ecx for later</span><br/>
<br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 8</span><br/>
_pop<br/>
<br/>
<span style="color: black; font-style: italic;">;write byte 0</span><br/>
<br/>
_writeByte<br/>
<br/>
<span style="color: black; font-style: italic;">;increment edi</span><br/>
<br/>
_pushall<br/>
_getDO &nbsp; &nbsp;<span style="color: black; font-style: italic;">;get data offset</span><br/>
_getdata &nbsp;<span style="color: black; font-style: italic;">;ebx = 0xffffffff</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 0xffffffff</span><br/>
_shr &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 1</span><br/>
_nopdB &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebp = 1</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 1</span><br/>
_pop &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = edi</span><br/>
_nopdD &nbsp; &nbsp;<span style="color: black; font-style: italic;">;edx = edi</span><br/>
_xor &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = edx ^ ebp</span><br/>
_nopdA &nbsp; &nbsp;<span style="color: black; font-style: italic;">;eax = edx ^ ebp</span><br/>
_getEIP<br/>
_push &nbsp; &nbsp; <span style="color: black; font-style: italic;">;top of do-while loop</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ebx points to a hidden ‘pop ebx’ instruction</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;as part of _getEIP so there is no explicit</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;‘pop’ instruction inside the loop that</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;corresponds to this ’push’ instruction</span><br/>
_saveJmpOff <span style="color: black; font-style: italic;">;esi = ebx</span><br/>
_nopsD &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = edx</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = edx</span><br/>
_nopsB &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = ebp</span><br/>
_and &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = ebp &amp; edx</span><br/>
_push<br/>
_getDO &nbsp; &nbsp;<span style="color: black; font-style: italic;">;get data offset</span><br/>
_getdata &nbsp;<span style="color: black; font-style: italic;">;ebx = 0xffffffff</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 0xffffffff</span><br/>
_shr &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 1</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 1</span><br/>
_pop<br/>
_shl &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = (edx &amp; ebp) &lt;&lt; 1</span><br/>
_nopdB &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebp = (edx &amp; ebp) &lt;&lt; 1</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = ebx</span><br/>
_nopsA &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = eax</span><br/>
_nopdD &nbsp; &nbsp;<span style="color: black; font-style: italic;">;edx = eax</span><br/>
_push<br/>
_xor &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = edx ^ ebp</span><br/>
_nopdA &nbsp; &nbsp;<span style="color: black; font-style: italic;">;eax = edx ^ ebp</span><br/>
_pop<br/>
_and &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = edx &amp; ebp</span><br/>
_JnzUp &nbsp; &nbsp;<span style="color: black; font-style: italic;">;loop while ((edx &amp; ebp) != 0)</span><br/>
_pop &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;discard loop address</span><br/>
_nopsA &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = eax</span><br/>
<br/>
<span style="color: black; font-style: italic;">;update edi</span><br/>
<br/>
_push<br/>
_popall <span style="color: black; font-style: italic;">;edi = eax and rebalance stack</span><br/>
<br/>
<span style="color: black; font-style: italic;">;shift ebx right by 8</span><br/>
<br/>
_shr <span style="color: black; font-style: italic;">;ebx = ebx &gt;&gt; 8</span><br/>
<br/>
<span style="color: black; font-style: italic;">;write byte 1</span><br/>
<br/>
_writeByte<br/>
<br/>
<span style="color: black;">&#91;</span>repeat twice more<span style="color: #339933;">,</span> beginning with ‘increment <span style="color: #46aa03; font-weight: bold;">edi</span>’<br/>
from above<span style="color: #339933;">,</span> to <span style="color: #0000ff; font-weight: bold;">write</span> the remaining bytes<span style="color: black;">&#93;</span><br/>
&nbsp;</div>
 
<p>Of course, if there were a command to write a new value for the stack pointer, then the stack could be moved to the destination address, and a ‘_push’ command could be used to write the value. However, there would need to be a corresponding command to read the previous value for the stack pointer in order to restore it afterwards. This is quite outside the ‘style’ of the language.</p>
<p>23 commands remain.</p>
<p>Another instruction that can be removed is the ‘_call’ command. A subroutine call is equivalent to pushing the return address onto the stack, and then jumping to the location of the subroutine. It can be replaced by the ‘_JnzUp’ command in the following way (again, calling the GetTickCount() API, as above):</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;construct pointer to l2</span><br/>
_getDO &nbsp; &nbsp;<span style="color: black; font-style: italic;">;get data offset</span><br/>
_getdata &nbsp;<span style="color: black; font-style: italic;">;ebx = 0xffffffff</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 0xffffffff</span><br/>
_shr &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 1</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 1</span><br/>
<span style="color: #339933;">...</span> <span style="color: black;">&#91;</span>‘_shl’ <span style="color: #00007f; font-weight: bold;">and</span> ‘_xor’ as needed to produce the value <span style="color: black;">&#40;</span><span style="color: black;">&#40;</span>lines<span style="color: black;">&#40;</span>l1<span style="color: #339933;">...</span>l2<span style="color: black;">&#41;</span> <span style="color: #339933;">*</span> <span style="color: #ff0000;">8</span><span style="color: black;">&#41;</span> <span style="color: #339933;">+</span> <span style="color: #ff0000;">3</span><span style="color: black;">&#41;</span><span style="color: black;">&#93;</span><br/>
_nopdB &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebp = offset of l2</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = offset of l2</span><br/>
_getEIP<br/>
<br/>
l1<span style="color: #339933;">:</span> <br/>
_nopdD &nbsp; &nbsp;<span style="color: black; font-style: italic;">;edx = eip</span><br/>
_xor &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = edx ^ ebp</span><br/>
_nopdA &nbsp; &nbsp;<span style="color: black; font-style: italic;">;eax = edx ^ ebp</span><br/>
_getEIP<br/>
_push &nbsp; &nbsp; <span style="color: black; font-style: italic;">;top of do-while loop</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ebx points to a hidden ‘pop ebx’ instruction</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;as part of _getEIP so there is no explicit</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;’pop’ instruction inside the loop that</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;corresponds to this ‘push’ instruction</span><br/>
_saveJmpOff <span style="color: black; font-style: italic;">;esi = ebx</span><br/>
_nopsD &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = edx</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = edx</span><br/>
_nopsB &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = ebp</span><br/>
_and &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = ebp &amp; edx</span><br/>
_push<br/>
_getDO &nbsp; &nbsp;<span style="color: black; font-style: italic;">;get data offset</span><br/>
_getdata &nbsp;<span style="color: black; font-style: italic;">;ebx = 0xffffffff</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 0xffffffff</span><br/>
_shr &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 1</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 1</span><br/>
_pop<br/>
_shl &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = (edx &amp; ebp) &lt;&lt; 1</span><br/>
_nopdB &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebp = (edx &amp; ebp) &lt;&lt; 1</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = ebx</span><br/>
_nopsA &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = eax</span><br/>
_nopdD &nbsp; &nbsp;<span style="color: black; font-style: italic;">;edx = eax</span><br/>
_push<br/>
_xor &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = edx ^ ebp</span><br/>
_nopdA &nbsp; &nbsp;<span style="color: black; font-style: italic;">;eax = edx ^ ebp</span><br/>
_pop<br/>
_and &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = edx &amp; ebp</span><br/>
_JnzUp &nbsp; &nbsp;<span style="color: black; font-style: italic;">;loop while ((edx &amp; ebp) != 0)</span><br/>
_pop &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;discard loop address</span><br/>
_nopsA &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = eax</span><br/>
<br/>
<span style="color: black; font-style: italic;">;save return address on stack</span><br/>
<br/>
_push<br/>
<br/>
<span style="color: black; font-style: italic;">;construct pointer to GetTickCount()</span><br/>
<br/>
_getDO &nbsp; &nbsp;<span style="color: black; font-style: italic;">;get data offset</span><br/>
_getdata &nbsp;<span style="color: black; font-style: italic;">;ebx = 0xffffffff</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 0xffffffff</span><br/>
_shr &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 1</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 1</span><br/>
_shl &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 2</span><br/>
_xor &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 3</span><br/>
_shl &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 6</span><br/>
_shl &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 0x0c</span><br/>
_nopdB &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebp = 0x0c</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 0x0c</span><br/>
_getDO &nbsp; &nbsp;<span style="color: black; font-style: italic;">;get data offset</span><br/>
_nopdD &nbsp; &nbsp;<span style="color: black; font-style: italic;">;edx = data offset</span><br/>
_xor &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = edx ^ ebp</span><br/>
_nopdA &nbsp; &nbsp;<span style="color: black; font-style: italic;">;eax = edx ^ ebp</span><br/>
_getEIP<br/>
_push &nbsp; &nbsp; <span style="color: black; font-style: italic;">;top of do-while loop</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ebx points to a hidden ‘pop ebx’</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;instruction as part of _getEIP so</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;there is no explicit ‘pop’</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;instruction inside the loop that</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;corresponds to this ‘push’ instruction</span><br/>
_saveJmpOff <span style="color: black; font-style: italic;">;esi = ebx</span><br/>
_nopsD &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = edx</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = edx</span><br/>
_nopsB &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = ebp</span><br/>
_and &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = ebp &amp; edx</span><br/>
_push<br/>
_getDO &nbsp; &nbsp;<span style="color: black; font-style: italic;">;get data offset</span><br/>
_getdata &nbsp;<span style="color: black; font-style: italic;">;ebx = 0xffffffff</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 0xffffffff</span><br/>
_shr &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 1</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 1</span><br/>
_pop<br/>
_shl &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = (edx &amp; ebp) &lt;&lt; 1</span><br/>
_nopdB &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebp = (edx &amp; ebp) &lt;&lt; 1</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = ebx</span><br/>
_nopsA &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = eax</span><br/>
_nopdD &nbsp; &nbsp;<span style="color: black; font-style: italic;">;edx = eax</span><br/>
_push<br/>
_xor &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = edx ^ ebp</span><br/>
_nopdA &nbsp; &nbsp;<span style="color: black; font-style: italic;">;eax = edx ^ ebp</span><br/>
_pop<br/>
_and &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = edx &amp; ebp</span><br/>
_JnzUp &nbsp; &nbsp;<span style="color: black; font-style: italic;">;loop while ((edx &amp; ebp) != 0)</span><br/>
_pop &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;discard loop address</span><br/>
_nopsA &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = eax</span><br/>
_getdata &nbsp;<span style="color: black; font-style: italic;">;ebx = offset of GetTickCount()</span><br/>
_saveJmpOff <span style="color: black; font-style: italic;">;esi = offset of GetTickCount()</span><br/>
<br/>
<span style="color: black; font-style: italic;">;clear Z flag</span><br/>
<br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = ebx</span><br/>
_and &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = ebx &amp; ebx (known non-zero from</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;above)</span><br/>
<br/>
<span style="color: black; font-style: italic;">;jump to GetTickCount()</span><br/>
<br/>
_JnzUp<br/>
l2<span style="color: #339933;">:</span> <span style="color: black; font-style: italic;">;execution resumes here</span><br/>
&nbsp;</div>
 
<p>Local subroutines can be called in the same way; however there is no ‘return’ command. The equivalent for a ‘return’ command is the following:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;retrieve return address from stack</span><br/>
<br/>
_pop<br/>
_saveJmpOff <span style="color: black; font-style: italic;">;esi = return address</span><br/>
<br/>
<span style="color: black; font-style: italic;">;clear Z flag, if required</span><br/>
<br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = ebx</span><br/>
_and &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = ebx &amp; ebx (known non-zero from above)</span><br/>
<br/>
<span style="color: black; font-style: italic;">;return to caller</span><br/>
<br/>
_JnzUp<br/>
&nbsp;</div>
<p>22 commands remain.</p>
<p>The following are two useful tricks just for the sake of interest. The first one demonstrates how to read parameters directly from the stack:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black;">&#91;</span><span style="color: #00007f; font-weight: bold;">push</span> parameters here<span style="color: #339933;">,</span> <span style="color: #00007f; font-weight: bold;">not</span> shown<span style="color: black;">&#93;</span><br/>
_pushall<br/>
_pop &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;edi</span><br/>
<span style="color: black;">&#91;</span>_nopdA &nbsp; <span style="color: black; font-style: italic;">;eax = edi, if needed]</span><br/>
_pop &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;esi</span><br/>
<span style="color: black;">&#91;</span>_nopdD &nbsp; <span style="color: black; font-style: italic;">;edx = esi, if needed]</span><br/>
_pop &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebp (discard)</span><br/>
_pop &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;esp</span><br/>
_push &nbsp; &nbsp; <span style="color: black; font-style: italic;">;esp</span><br/>
_push &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ebp</span><br/>
<span style="color: black;">&#91;</span>_nopsD &nbsp; <span style="color: black; font-style: italic;">;ebx = original esi, if needed]</span><br/>
_push<br/>
<span style="color: black;">&#91;</span>_nopsA &nbsp; <span style="color: black; font-style: italic;">;ebx = original edi, if needed]</span><br/>
_push<br/>
_popall &nbsp; <span style="color: black; font-style: italic;">;ebp = esp</span><br/>
<span style="color: black;">&#91;</span><span style="color: #00007f; font-weight: bold;">add</span> to <span style="color: #46aa03; font-weight: bold;">ebp</span> as needed to reach required variable<span style="color: black;">&#93;</span><br/>
_nopsB &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = ebp</span><br/>
_getdata &nbsp;<span style="color: black; font-style: italic;">;read from stack</span><br/>
&nbsp;</div>
<p>Then, simply by replacing the ‘_getdata’ command with the ‘_call’ command, function pointers on the stack can be called.</p>
<p>The ‘_push’ command can be removed, but the replacement code is ugly. It would look like this:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">_nopdA &nbsp; &nbsp;<span style="color: black; font-style: italic;">;place into eax in order to appear at the</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;top of the stack</span><br/>
_pushall<br/>
_pop &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;discard edi</span><br/>
_pop &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;discard esi</span><br/>
_pop &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;discard ebp</span><br/>
_pop &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;discard esp</span><br/>
_pop &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;discard ebx</span><br/>
_pop &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;discard edx</span><br/>
_pop &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;discard ecx</span><br/>
<span style="color: black; font-style: italic;">;eax remains as the only register on the stack</span><br/>
&nbsp;</div>
<p>21 commands remain.</p>
<p>The ‘_popall’ command can be removed. The ‘_popall’ command pops the registers from the stack in the following order: edi, esi, ebp, esp, ebx, edx, ecx, eax. The command can be replaced by popping and assigning the registers individually, in the following way:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">_pop &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;edi</span><br/>
_saveWrtOff<br/>
_pop &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;esi</span><br/>
_saveJmpOff<br/>
_pop &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebp</span><br/>
_nopdB<br/>
_pop &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;esp (discard)</span><br/>
_pop &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx</span><br/>
_pop &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;edx</span><br/>
_nopdD<br/>
_pop &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ecx</span><br/>
_save<br/>
_pop &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;eax</span><br/>
_nopdA<br/>
&nbsp;</div>
 
<p>20 commands remain.</p>
<p>The ‘_nopdB’, ‘_saveWrtOff’ and ‘_saveJmpOff’ commands can be removed if the ‘_push’ and ‘_popall’ commands are retained. Replacement of the ‘_saveWrtOff’ command would look like this:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">_pushall<br/>
_pop &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;discard existing edi</span><br/>
<span style="color: black;">&#91;</span>construct value to place <span style="color: #00007f; font-weight: bold;">into</span> <span style="color: #46aa03; font-weight: bold;">edi</span><span style="color: #339933;">,</span> <span style="color: #00007f; font-weight: bold;">not</span> shown<span style="color: black;">&#93;</span><br/>
_push<br/>
_popall<br/>
&nbsp;</div>
<p>Replacement of the ‘_saveJmpOff’ command would look like this:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">_pushall<br/>
_pop &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;edi</span><br/>
<span style="color: black;">&#91;</span>_nopdD &nbsp; <span style="color: black; font-style: italic;">;preserve edi if needed]</span><br/>
_pop &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;discard existing esi</span><br/>
<span style="color: black;">&#91;</span>construct value to place <span style="color: #00007f; font-weight: bold;">into</span> <span style="color: #46aa03; font-weight: bold;">esi</span><span style="color: #339933;">,</span> <span style="color: #00007f; font-weight: bold;">not</span> shown<span style="color: black;">&#93;</span><br/>
_push<br/>
<span style="color: black;">&#91;</span>_nopsD &nbsp; <span style="color: black; font-style: italic;">;restore edi if needed]</span><br/>
_push<br/>
_popall<br/>
&nbsp;</div>
<p>Replacement of the ‘_nopdB’ command would look like this:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;">_pushall<br/>
_pop &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;edi</span><br/>
<span style="color: black;">&#91;</span>_nopdD &nbsp; <span style="color: black; font-style: italic;">;preserve edi if needed]</span><br/>
_pop &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;esi</span><br/>
<span style="color: black;">&#91;</span>_nopdA &nbsp; <span style="color: black; font-style: italic;">;preserve esi if needed]</span><br/>
_pop &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;discard existing ebp</span><br/>
<span style="color: black;">&#91;</span>construct value to place <span style="color: #00007f; font-weight: bold;">into</span> <span style="color: #46aa03; font-weight: bold;">ebp</span><span style="color: #339933;">,</span> <span style="color: #00007f; font-weight: bold;">not</span> shown<span style="color: black;">&#93;</span><br/>
_push<br/>
<span style="color: black;">&#91;</span>_nopsA &nbsp; <span style="color: black; font-style: italic;">;restore esi if needed]</span><br/>
_push<br/>
<span style="color: black;">&#91;</span>_nopsD &nbsp; <span style="color: black; font-style: italic;">;restore edi if needed]</span><br/>
_push<br/>
_popall<br/>
&nbsp;</div>
<p>19 commands remain.</p>
<p>Two other commands can be removed, but they cannot be replaced using existing instructions. Instead, the replacement code requires the introduction of another instruction. The two commands are ‘_shl’ and ‘_shr’. The replacement instruction is ‘_rot’ (‘rotate’). The direction of the rotate is not important, as long as it is known, since all values can be constructed by using it in conjunction with the ‘_and’ instruction. However, it requires the use of the value ‘1’ as the ‘base constant’. The value ‘1’ would be used to construct the values ‘0x7fffffff’ (if rotating shifts to the right) or ‘0xfffffffe’ (if rotating shifts to the left). This is the mask value that is used by the ‘_and’ command to zero the appropriate bit in order to simulate a shift. This is the simplest implementation that would rotate a value only once per use without reference to the value in the ‘ecx’ register. Multi-bit rotates could be supported, too, but then the ‘and’ mask would no longer be a constant. Instead, it would be specific to the number of bits that are being rotated. So, shifting the value in the ‘eax’ register left by ‘3’ times, using the single-bit rotate command, would look like this:</p>
<div class="asm" style="font-family:monospace;color: #000066;  border: solid thin #c2c1b1; background: #d6d5c5;"><span style="color: black; font-style: italic;">;construct the value ‘0xfffffffe’</span><br/>
<br/>
_getDO &nbsp; &nbsp;<span style="color: black; font-style: italic;">;get data offset</span><br/>
_getdata &nbsp;<span style="color: black; font-style: italic;">;ebx = 1</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 1</span><br/>
_rot &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 2</span><br/>
_xor &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 3</span><br/>
_rot &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 6</span><br/>
_xor &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 7</span><br/>
_rot &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 0x0e</span><br/>
_xor &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = 0x0f</span><br/>
<span style="color: black;">&#91;</span>repeat seven more <span style="color: #0000ff; font-weight: bold;">times</span><span style="color: #339933;">,</span> but omit the final <span style="color: #00007f; font-weight: bold;">xor</span><span style="color: black;">&#93;</span><br/>
_save &nbsp; &nbsp; <span style="color: black; font-style: italic;">;ecx = 0xfffffffe</span><br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span style="color: black; font-style: italic;">;rotate left and zero the overflow bits</span><br/>
_nopsA &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = eax</span><br/>
_rot &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = rol(ebx, 1)</span><br/>
_and &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = ebx &amp; 0xfffffffe</span><br/>
_rot &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = rol(ebx, 1)</span><br/>
_and &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = ebx &amp; 0xfffffffe</span><br/>
_rot &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = rol(ebx, 1)</span><br/>
_and &nbsp; &nbsp; &nbsp;<span style="color: black; font-style: italic;">;ebx = ebx &amp; 0xfffffffe</span><br/>
_nopdA &nbsp; &nbsp;<span style="color: black; font-style: italic;">;eax = shl(eax, 3)</span><br/>
&nbsp;</div>
<p>18 commands remain:</p>
<ul>
<li>_nopsA, _nopsB, _nopsD, _nopdA, _nopdD</li>
<li>_writeByte</li>
<li>_save</li>
<li>_getDO, _getdata, _getEIP</li>
<li>_push _pop, _pushall, _popall</li>
<li>_rot, _and, _xor</li>
<li>JnzUp</li>
</ul>
<p>Many years from now, our distant descendants might stumble upon a codon stream that describes only 18 amino acids – and we might be looking at its origin. Imagine that.</p>
<hr size="1"/>
<p><a name="f1" href="#b1">1</a> A codon is a trinucleotide sequence of DNA or RNA (the nucleic acids that contain the genetic instructions used in the development and functioning of living organisms) that corresponds to a specific amino acid. See http://www.genome.gov/Glossary/index.cfm?id=36.</p>
<p><a name="f2" href="#b2">2</a> Transfer RNA, or tRNA, is a small RNA molecule that is involved in protein synthesis. See http://www.wiley.com/college/boyer/0470003790/structure/tRNA/trna_intro.htm.</p>
<p><a name="f3" href="#b3">3</a> Amino acids are the building blocks of proteins. See http://en.wikipedia.org/w/index.php?title=Amino_acid&amp;oldid=412676887.</p>
<p><a name="f4" href="#b4">4</a> There is a bug in this code, which can result in attempting to copy more bytes than exist in the source.</p>
<p><a name="f5" href="#b5">5</a> There is an additional case where the destination is the same as the source, in which case the codons are deleted.</p>
<p><a name="f6" href="#b6">6</a> The ‘_CallAPISleep’ command was added to the release version because the API resolver code could not resolve the Sleep() API on certain platforms. The reason is described in detail in the previous article (VB, March 2011, p.4).</p>
<p><a name="f7" href="#b7">7</a> It would be even simpler to introduce an instruction which performs a ‘mov ebx, 0xffffffff’.</p>
[<a style="" href="/lib/?lang=EN&amp;index=AN#apf57">Back to index</a>] [<a href="/lib/apf57.html#disqus_thread">Comments</a>]<br/> <div id="disqus_thread"></div>
<script type="text/rocketscript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'vxheaven'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
<div><small>By accessing, viewing, downloading or otherwise using this content you agree to be bound by the <a href="/agreement.php">Terms of Use</a>!</small> <small>vxheaven.org aka vx.netlux.org</small></div>
<div style="margin-top: 2px; float: left;" class="adsapeu">
<script type="text/rocketscript">
<!--
var _acic={dataProvider:10};(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="//www.acint.net/aci.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
//-->
</script>
</div>
<script data-rocketsrc="http://www.google-analytics.com/urchin.js" type="text/rocketscript"></script><script type="text/rocketscript">try { _uacct = "UA-590608-1"; urchinTracker(); } catch(err) {}</script>
<div style="display: none;"><a href="/lib/index.php?lang=de&amp;id=apf57">de</a><a href="/lib/index.php?lang=en&amp;id=apf57">en</a><a href="/lib/index.php?lang=es&amp;id=apf57">es</a><a href="/lib/index.php?lang=it&amp;id=apf57">it</a><a href="/lib/index.php?lang=fr&amp;id=apf57">fr</a><a href="/lib/index.php?lang=pl&amp;id=apf57">pl</a><a href="/lib/index.php?lang=ru&amp;id=apf57">ru</a><a href="/lib/index.php?lang=ua&amp;id=apf57">ua</a></div>
</body>
</html>
